<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>張老師易經卜卦</title>
  <style>
    body { font-family: 'Noto Sans TC', sans-serif; background:#f7f7f7; padding:20px; }
    .container { max-width:980px; margin:0 auto; background:#fff; padding:20px; border-radius:12px; box-shadow:0 3px 12px rgba(0,0,0,.15); }
    h1,h2,h3{ color:#333; }
    h1 { margin-bottom:0; }
    h2.subtitle { font-weight:normal; font-size:16px; color:#666; margin-top:4px; margin-bottom:20px; }
    .tab-buttons{ display:flex; flex-wrap:wrap; gap:8px; margin-bottom:14px; }
    .tab-button{ padding:8px 16px; border:0; border-radius:6px; cursor:pointer; background:#eee; }
    .tab-button.active{ background:#333; color:#fff; }
    .tab-content{ display:none; }
    .tab-content.active{ display:block; }
    .row{ display:flex; flex-wrap:wrap; gap:10px; align-items:center; }
    .hint{ font-size:12px; color:#666; }
    .gua-box{ border:1px solid #ddd; border-radius:8px; padding:12px; margin-bottom:10px; }
    .moving-line{ color:#c00; font-weight:bold; }
    .hidden{ display:none; }
    button.primary{ padding:10px 20px; background:#333; color:#fff; border:0; border-radius:6px; cursor:pointer; }
    #line-explanation{ margin-top:20px; }
    #judgeBox{ margin-top:20px; border:2px solid #666; padding:12px; border-radius:10px; }
    .score-card { display:flex; justify-content:space-between; align-items:center; margin-bottom:6px; }
    .score-bar-wrap{ flex:1; margin:0 10px; height:10px; background:#eee; border-radius:6px; overflow:hidden; }
    .score-bar{ height:100%; background:linear-gradient(90deg,#f44336,#ff9800,#4caf50); width:0; transition:width .4s; }
    .score-val{ font-weight:bold; }
    select, input[type="number"], input[type="text"], input[type="datetime-local"]{ padding:8px; border:1px solid #ccc; border-radius:6px; }
    .pill{ display:inline-block; padding:2px 8px; border-radius:999px; background:#f0f0f0; margin-left:6px; font-size:12px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>張老師易經卜卦</h1>
    <h2 class="subtitle" id="subtitle"></h2>

    <div class="tab-buttons">
      <button class="tab-button active" onclick="showTab('manual-upper-first')">數字取卦</button>
      <button class="tab-button" onclick="showTab('manual-dropdown')">手動取卦</button>
      <button class="tab-button" onclick="showTab('time-meihua')">時間取卦（梅花易）</button>
      <button class="tab-button" onclick="showTab('image-method')">以象取卦</button>
    </div>

    <!-- 數字取卦（加提示與預設隨機） -->
    <div id="manual-upper-first" class="tab-content active">
      <h2>數字取卦</h2>
      <div class="row">
        <input type="number" id="num4" placeholder="上卦數字 (100-999)" min="100" max="999"> 
        <input type="number" id="num5" placeholder="下卦數字 (100-999)" min="100" max="999"> 
        <input type="number" id="num6" placeholder="動爻數字 (100-999)" min="100" max="999"> 
        <button id="manualUpperBtn" class="primary">生成卦象</button>
      </div>
      <span class="hint">提示：輸入範圍 100-999，頁面刷新將隨機預設三個數字。</span>
    </div>

    <!-- 手動取卦（原） -->
    <div id="manual-dropdown" class="tab-content">
      <h2>手動取卦</h2>
      <div class="row">
        <select id="upperGuaSelect">
          <option value="1">乾</option>
          <option value="2">兌</option>
          <option value="3">離</option>
          <option value="4">震</option>
          <option value="5">巽</option>
          <option value="6">坎</option>
          <option value="7">艮</option>
          <option value="8">坤</option>
        </select>
        <select id="lowerGuaSelect">
          <option value="1">乾</option>
          <option value="2">兌</option>
          <option value="3">離</option>
          <option value="4">震</option>
          <option value="5">巽</option>
          <option value="6">坎</option>
          <option value="7">艮</option>
          <option value="8">坤</option>
        </select>
        <input type="text" id="movingLinesInput" placeholder="變爻 (例:1,3)">
        <button id="manualDropdownBtn" class="primary">生成卦象</button>
      </div>
    </div>

    <!-- 時間取卦（梅花易） -->
    <div id="time-meihua" class="tab-content">
      <h2>時間取卦（梅花易數）</h2>
      <div class="row">
        <input type="datetime-local" id="dtInput">
        <span class="hint">演算法：上卦 = (年+月+日) % 8；下卦 = (年+月+日+時) % 8；動爻 = (年+月+日+時+分) % 6；餘數為0時分別記為8或6。</span>
      </div>
      <div class="row" style="margin-top:8px;">
        <button id="timeBtn" class="primary">以時間生成卦象</button>
        <span class="pill" id="nowQuick">使用現在時間</span>
      </div>
    </div>

    <!-- 以象取卦 -->
    <div id="image-method" class="tab-content">
      <h2>以象取卦</h2>
      <div class="row">
        <label for="upperImageSelect">上卦：</label>
        <select id="upperImageSelect" style="min-width:260px">
          <option value="1">乾（金）—天、圓、馬、父</option>
          <option value="2">兌（金）—澤、口、悅、羊</option>
          <option value="3">離（火）—日、電、目、中女</option>
          <option value="4">震（木）—雷、動、竹、長男</option>
          <option value="5">巽（木）—風、入、雞、長女</option>
          <option value="6">坎（水）—水、陷、耳、中男</option>
          <option value="7">艮（土）—山、止、手、少男</option>
          <option value="8">坤（土）—地、母、牛、腹</option>
        </select>
        <span class="hint">（提示：列出常見事物象與五行）</span>
      </div>
      <div class="row">
        <label for="lowerDirectionSelect">下卦（後天八卦方位）：</label>
        <select id="lowerDirectionSelect">
          <option value="6">北（坎）</option>
          <option value="3">南（離）</option>
          <option value="4">東（震）</option>
          <option value="2">西（兌）</option>
          <option value="7">東北（艮）</option>
          <option value="1">西北（乾）</option>
          <option value="5">東南（巽）</option>
          <option value="8">西南（坤）</option>
        </select>
      </div>
      <div class="row">
        <label for="imageMovingInput">動爻：</label>
        <input type="number" id="imageMovingInput" placeholder="1~6" min="1" max="6" style="width:90px">
        <label><input type="checkbox" id="imageUseMinute"> 用當前分鐘取動爻</label>
      </div>
      <div class="row" style="margin-top:8px;">
        <button id="imageBtn" class="primary">生成卦象</button>
      </div>
    </div>

    <div id="result" class="hidden">
      <h2>卦象結果</h2>
      <div class="gua-box">
        <h3>本卦</h3>
        <h2 id="guaName"></h2>
        <div id="guaImage"></div>
      </div>
      <div class="gua-box">
        <h3>變卦</h3>
        <h2 id="changeGuaName"></h2>
        <div id="changeGuaImage"></div>
      </div>
      <div class="gua-box">
        <h3>互卦</h3>
        <h2 id="huGuaName"></h2>
        <div id="huGuaImage"></div>
      </div>
      <div id="line-explanation" class="gua-box hidden">
        <h3>動爻解釋</h3>
        <h3 id="line-text-display"></h3>
        <p id="line-meaning-display"></p>
      </div>
      <div id="judgeBox" class="hidden">
        <h3>綜合判斷</h3>
        <div id="scoreWrap"></div>
      </div>
      <button id="judgeBtn" class="primary">綜合判斷</button>
    </div>
  </div>

  <script>
    // ===== 副標題：隨機經典文句 =====
    fetch('quotes.json').then(r=>r.json()).then(list=>{
      if(Array.isArray(list)&&list.length>0){
        const rnd=Math.floor(Math.random()*list.length);
        document.getElementById('subtitle').textContent=list[rnd];
      }
    }).catch(()=>{
      document.getElementById('subtitle').textContent='易有太極，是生兩儀，兩儀生四象，四象生八卦。';
    });

    // ===== 既有資料結構 =====
    const guaTable={1:[1,1,1],2:[0,1,1],3:[1,0,1],4:[0,0,1],5:[1,1,0],6:[0,1,0],7:[1,0,0],8:[0,0,0]};
    const all64Gua=[{id:1,name:'乾為天',lines:[1,1,1,1,1,1]},{id:2,name:'坤為地',lines:[0,0,0,0,0,0]}];
    let hexagramsData={};
    fetch('hexagrams.json').then(r=>r.json()).then(j=>hexagramsData=j);

    let currentResult={};

    const resultDiv=document.getElementById('result');
    const guaNameH2=document.getElementById('
