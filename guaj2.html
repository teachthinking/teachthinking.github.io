<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>張老師易經卜卦</title>
  <style>
    body{font-family:"Noto Sans TC",sans-serif;background:#f7f7f7;color:#222;padding:20px}
    .container{max-width:980px;margin:0 auto;background:#fff;padding:22px;border-radius:12px;box-shadow:0 6px 24px rgba(0,0,0,.06)}
    h1{margin:0 0 6px 0;font-size:26px}
    h2.subtitle{margin:0 0 16px 0;color:#666;font-weight:400;font-size:15px}
    .tab-buttons{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:14px}
    .tab-button{padding:8px 14px;border-radius:8px;border:0;background:#efefef;cursor:pointer}
    .tab-button.active{background:#222;color:#fff}
    .tab-content{display:none;padding-top:8px}
    .tab-content.active{display:block}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin:8px 0}
    .hint{font-size:13px;color:#666}
    .gua-box{border:1px solid #e6e6e6;border-radius:10px;padding:12px;background:#fafafa;margin-bottom:12px}
    .moving-line{color:#b71c1c;font-weight:600}
    .hidden{display:none}
    button.primary{padding:9px 16px;background:#222;color:#fff;border-radius:8px;border:0;cursor:pointer}
    input,select,textarea{padding:8px;border-radius:8px;border:1px solid #d0d0d0;font-size:14px}
    .pill{display:inline-block;padding:4px 8px;border-radius:999px;background:#f0f0f0;font-size:12px}
    #line-explanation > div{margin-bottom:10px;padding-bottom:8px;border-bottom:1px dashed #eee}
    .score-card{display:flex;align-items:center;gap:10px;margin-bottom:8px}
    .score-bar-wrap{flex:1;height:10px;background:#eee;border-radius:6px;overflow:hidden}
    .score-bar{height:100%;width:0;transition:width .4s;background:linear-gradient(90deg,#f44336,#ff9800,#4caf50)}
    .score-val{min-width:36px;text-align:right;font-weight:600}
    pre{background:#fafafa;padding:8px;border-radius:6px;overflow:auto}
  </style>
</head>
<body>
  <div class="container">
    <h1>張老師易經卜卦</h1>
    <h2 id="subtitle" class="subtitle">載入中…（若無 quotes.json 顯示預設句）</h2>

    <!-- 分頁按鈕 -->
    <div class="tab-buttons">
      <button class="tab-button active" data-target="tab-number">數字取卦</button>
      <button class="tab-button" data-target="tab-manual">手動取卦</button>
      <button class="tab-button" data-target="tab-time">時間取卦（梅花易）</button>
      <button class="tab-button" data-target="tab-image">以象取卦</button>
    </div>

    <!-- 數字取卦 -->
    <div id="tab-number" class="tab-content active">
      <h3>數字取卦</h3>
      <div class="row">
        <input id="numUpper" type="number" placeholder="上卦數字 (100-999)" min="100" max="999" />
        <input id="numLower" type="number" placeholder="下卦數字 (100-999)" min="100" max="999" />
        <input id="numMoving" type="number" placeholder="動爻數字 (100-999)" min="100" max="999" />
        <button id="btnNumber" class="primary">生成卦象</button>
      </div>
      <div class="row"><span class="hint">提示：輸入 100–999。上/下卦 = 數字 % 8（0 視為 8），動爻 = 數字 % 6（0 視為 6）。頁面載入會隨機預設三個數字。</span></div>
    </div>

    <!-- 手動取卦 -->
    <div id="tab-manual" class="tab-content">
      <h3>手動取卦</h3>
      <div class="row">
        <select id="selUpper">
          <option value="1">乾</option><option value="2">兌</option><option value="3">離</option><option value="4">震</option>
          <option value="5">巽</option><option value="6">坎</option><option value="7">艮</option><option value="8">坤</option>
        </select>
        <select id="selLower">
          <option value="1">乾</option><option value="2">兌</option><option value="3">離</option><option value="4">震</option>
          <option value="5">巽</option><option value="6">坎</option><option value="7">艮</option><option value="8">坤</option>
        </select>
        <input id="inputMoving" type="text" placeholder="變爻 (例: 1,3 或 2)" />
        <button id="btnManual" class="primary">生成卦象</button>
      </div>
    </div>

    <!-- 時間取卦（梅花易） -->
    <div id="tab-time" class="tab-content">
      <h3>時間取卦（梅花易）</h3>
      <div class="row">
        <input id="dtInput" type="datetime-local" />
        <button id="btnTime" class="primary">以時間生成卦象</button>
        <span id="nowQuick" class="pill">使用現在時間</span>
      </div>
      <div class="row"><span class="hint">算法：上卦 = (年+月+日) % 8；下卦 = (年+月+日+時) % 8；動爻 = (年+月+日+時+分) % 6；餘數為 0 則視為 8 或 6。</span></div>
    </div>

    <!-- 以象取卦 -->
    <div id="tab-image" class="tab-content">
      <h3>以象取卦</h3>
      <div class="row">
        <label>上卦：</label>
        <select id="upperImageSelect" style="min-width:260px">
          <option value="1">乾（金）—天、圓、馬、父</option>
          <option value="2">兌（金）—澤、口、悅、羊</option>
          <option value="3">離（火）—日、電、目、中女</option>
          <option value="4">震（木）—雷、動、竹、長男</option>
          <option value="5">巽（木）—風、入、雞、長女</option>
          <option value="6">坎（水）—水、陷、耳、中男</option>
          <option value="7">艮（土）—山、止、手、少男</option>
          <option value="8">坤（土）—地、母、牛、腹</option>
        </select>
      </div>
      <div class="row">
        <label>下卦（後天方位）：</label>
        <select id="lowerDirectionSelect">
          <option value="6">北（坎）</option><option value="3">南（離）</option><option value="4">東（震）</option><option value="2">西（兌）</option>
          <option value="7">東北（艮）</option><option value="1">西北（乾）</option><option value="5">東南（巽）</option><option value="8">西南（坤）</option>
        </select>
      </div>
      <div class="row">
        <input id="imageMovingInput" type="number" placeholder="動爻 1~6" min="1" max="6" style="width:110px" />
        <label><input id="imageUseMinute" type="checkbox" /> 用當前分鐘取動爻</label>
      </div>
      <div class="row">
        <button id="btnImage" class="primary">生成卦象</button>
      </div>
    </div>

    <!-- 結果區 -->
    <div id="result" class="hidden">
      <h2>卦象結果</h2>

      <div class="gua-box">
        <h3>本卦</h3>
        <h2 id="guaName"></h2>
        <div id="guaImage"></div>
        <div id="guaNote" class="hint" style="margin-top:8px"></div>
      </div>

      <div class="gua-box">
        <h3>變卦</h3>
        <h2 id="changeGuaName"></h2>
        <div id="changeGuaImage"></div>
      </div>

      <div class="gua-box">
        <h3>互卦</h3>
        <h2 id="huGuaName"></h2>
        <div id="huGuaImage"></div>
      </div>

      <div id="line-explanation" class="gua-box hidden">
        <h3>動爻解釋（多變爻逐條列出）</h3>
        <div id="lineTextDisplay"></div>
      </div>

      <div id="judgeBox" class="gua-box hidden">
        <h3>綜合判斷（示例）</h3>
        <div id="scoreWrap"></div>
      </div>

      <div style="margin-top:8px"><button id="judgeBtn" class="primary">綜合判斷</button></div>
    </div>
  </div>

  <script>
  /* ===========================
     資料：三爻（1..8）對應與工具
     lines 的約定：陣列為 bottom->top（index0 = 下爻 = 爻1，index5 = 上爻 = 爻6）
     =========================== */
  const guaTable = {
    1:[1,1,1], 2:[0,1,1], 3:[1,0,1], 4:[0,0,1],
    5:[1,1,0], 6:[0,1,0], 7:[1,0,0], 8:[0,0,0]
  };
  const trigramName = {1:'乾',2:'兌',3:'離',4:'震',5:'巽',6:'坎',7:'艮',8:'坤'};
  const triIndexByLines = new Map(Object.entries(guaTable).map(([i,arr])=>[JSON.stringify(arr), +i]));

  // hexagrams.json 支援彈性讀取（array 或 object）：
  let hexList = [];             // 原始陣列
  const hexByLines = new Map(); // JSON(lines) -> entry
  const hexByName = new Map();  // name/title -> entry

  // 載入 hexagrams.json（若存在）
  fetch('hexagrams.json')
    .then(r => r.json())
    .then(data => {
      // 正規化為陣列
      if (Array.isArray(data)) hexList = data;
      else if (data && typeof data === 'object') {
        hexList = Object.keys(data).map(k => {
          const e = data[k] || {};
          if (!e.name && !e.title) e.name = k;
          return e;
        });
      }

      // 建立快速對照
      hexList.forEach(entry => {
        if (!entry) return;
        // name/title
        if (entry.name) hexByName.set(entry.name, entry);
        if (entry.title) hexByName.set(entry.title, entry);
        // lines：若 entry.lines 為長度 6 的陣列，建立正反序 key
        if (Array.isArray(entry.lines) && entry.lines.length === 6) {
          const k1 = JSON.stringify(entry.lines); // 假設 bottom->top 或 top->bottom，不確定
          const k2 = JSON.stringify([...entry.lines].reverse());
          // 優先保留已存在的（避免覆寫），但儲存兩種 orientation 都指向 entry
          if (!hexByLines.has(k1)) hexByLines.set(k1, entry);
          if (!hexByLines.has(k2)) hexByLines.set(k2, entry);
        }
      });
    })
    .catch(()=> { /* 允許沒有 hexagrams.json */ });

  // 載入 quotes.json 作為副標題（若沒有則使用預設）
  fetch('quotes.json')
    .then(r => r.json())
    .then(list => {
      if (Array.isArray(list) && list.length > 0) {
        document.getElementById('subtitle').textContent = list[Math.floor(Math.random()*list.length)];
      } else {
        document.getElementById('subtitle').textContent = '易有太極，是生兩儀，兩儀生四象，四象生八卦。';
      }
    })
    .catch(()=> {
      document.getElementById('subtitle').textContent = '易有太極，是生兩儀，兩儀生四象，四象生八卦。';
    });

  /* ---------------------------
     工具函數
     --------------------------- */
  function showTabById(id){
    document.querySelectorAll('.tab-button').forEach(b=>b.classList.remove('active'));
    document.querySelectorAll('.tab-button').forEach(b=>{ if(b.dataset.target===id) b.classList.add('active'); });
    document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));
    const el=document.getElementById(id); if(el) el.classList.add('active');
  }
  document.querySelectorAll('.tab-button').forEach(btn=>{
    btn.addEventListener('click', ()=> showTabById(btn.dataset.target));
  });

  function formatName(uIdx, lIdx){
    return `${trigramName[uIdx] || uIdx}上・${trigramName[lIdx] || lIdx}下`;
  }

  // 找 hex entry：先以 6 爻陣列（bottom->top）匹配，找不到再以名稱匹配
  function findHexEntryByLines(lines){
    const key = JSON.stringify(lines);
    if (hexByLines.has(key)) return hexByLines.get(key);
    const revKey = JSON.stringify([...lines].reverse());
    if (hexByLines.has(revKey)) return hexByLines.get(revKey);
    return null;
  }
  function findHexEntryByName(name){
    if (hexByName.has(name)) return hexByName.get(name);
    return null;
  }

  // 顯示卦象的文字線條（由上到下顯示）
  function getGuaHtml(lines, moving=[]){
    // lines: bottom->top (index0 = 爻1 下爻)
    let html = '';
    // 顯示順序：從 index5 (上爻) 到 index0 (下爻)
    for (let i = 5; i >= 0; i--) {
      const val = lines[i];
      const yaoNo = i + 1; // 爻號：1..6 (bottom->top)
      const lineText = val === 1 ? '———————' : '———   ———';
      if ((moving || []).includes(yaoNo)) {
        html += `<div class="moving-line">${lineText} （第 ${yaoNo} 爻 變）</div>`;
      } else {
        html += `<div>${lineText}</div>`;
      }
    }
    return html;
  }

  // 由 hexEntry 取出單一爻資料（yaoIndex 為 1..6，代表 bottom->top）
  function getLineEntryFor(hexEntry, yaoIndex){
    if (!hexEntry || !Array.isArray(hexEntry.lines)) return null;
    const arr = hexEntry.lines;
    // 若 arr 中元素有 index 屬性，優先找 index 相符
    for (const el of arr) {
      if (el && (el.index === yaoIndex || el.index === String(yaoIndex))) return (typeof el === 'string') ? { text: el } : el;
    }
    // 若純陣列，先假設 order = bottom->top
    if (arr.length === 6) {
      const maybe = arr[yaoIndex - 1];
      if (maybe) return (typeof maybe === 'string') ? { text: maybe } : maybe;
      // 再嘗試 top->bottom
      const maybeRev = arr[arr.length - yaoIndex];
      if (maybeRev) return (typeof maybeRev === 'string') ? { text: maybeRev } : maybeRev;
    }
    return null;
  }

  // XSS 逃逸（顯示來自 JSON 的自由文本）
  function escapeHtml(s){
    if (s === null || s === undefined) return '';
    return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;');
  }

  /* ---------------------------
     生成並顯示卦象（主流程）
     --------------------------- */
 
    const hexagramNameMap = {
  "乾乾": "乾為天",
  "坤坤": "坤為地",
  "坎震": "水雷屯",
  "艮坎": "山水蒙",
  "坎乾": "水天需",
  "乾坎": "天水訟",
  "地水": "地水師",
  "水地": "水地比",
  "風天": "風天小畜",
  "天澤": "天澤履",
  "地天": "地天泰",
  "天地": "天地否",
  "天火": "天火同人",
  "火天": "火天大有",
  "地山": "地山謙",
  "雷地": "雷地豫",
  "澤雷": "澤雷隨",
  "山風": "山風蠱",
  "地澤": "地澤臨",
  "風地": "風地觀",
  "火雷": "火雷噬嗑",
  "山火": "山火賁",
  "山地": "山地剝",
  "地雷": "地雷復",
  "天雷": "天雷無妄",
  "山天": "山天大畜",
  "山澤": "山澤損",
  "風雷": "風雷益",
  "澤天": "澤天夬",
  "天風": "天風姤",
  "澤地": "澤地萃",
  "地風": "地風升",
  "澤水": "澤水困",
  "水風": "水風井",
  "澤火": "澤火革",
  "火風": "火風鼎",
  "震澤": "震澤歸妹",  
  "澤山": "澤山咸",
  "雷火": "雷火豐",
  "火山": "火山旅",
  "巽澤": "巽澤中孚",
  "雷風": "雷風恆",
  "天山": "天山遯",
  "雷天": "雷天大壯",
  "火地": "火地晉",
  "地火": "地火明夷",
  "風火": "風火家人",
  "火澤": "火澤睽",
  "水山": "水山蹇",
  "雷水": "雷水解",
  "山澤": "山澤損",
  "風水": "風水渙",
  "水澤": "水澤節",
  "風澤": "風澤中孚",
  "雷山": "雷山小過",
  "山雷": "山雷頤",
  "澤風": "澤風大過",
  "坎離": "坎為水",
  "離坎": "離為火",
  "艮兌": "艮為山",
  "兌艮": "兌為澤"
};
    
    
    
    
    let currentResult = null;

  function makeFromUpperLower(uIdx, lIdx){
    const upper = guaTable[uIdx] || guaTable[1];
    const lower = guaTable[lIdx] || guaTable[1];
    // lines: bottom->top
    return [...lower, ...upper];
  }

  function generateGua(uIdx, lIdx, movingArr){
    const moving = Array.isArray(movingArr) ? movingArr.filter(x=>Number.isFinite(x) && x>=1 && x<=6) : [];
    const lines = makeFromUpperLower(uIdx, lIdx); // bottom->top
    // main hex entry
    const hexMain = findHexEntryByLines(lines) || findHexEntryByName(formatName(uIdx,lIdx));
   // const mainName = hexMain && (hexMain.name || hexMain.title) ? (hexMain.name || hexMain.title) : formatName(uIdx,lIdx);
    const upName = trigramName[uIdx];
const lowName = trigramName[lIdx];
const key = upName + lowName;
const mapped = hexagramNameMap[key];
const mainName = mapped || formatName(uIdx,lIdx);
const hexMain = findHexEntryByName(mainName);
    // 變卦：複製並翻轉指定爻
    const changeLines = lines.slice();
    moving.forEach(n => { const idx = n - 1; if (idx>=0 && idx<6) changeLines[idx] = 1 - changeLines[idx]; });
    const hexChange = findHexEntryByLines(changeLines) || null;
    const changeName = hexChange && (hexChange.name || hexChange.title) ? (hexChange.name || hexChange.title) : `${formatName(uIdx,lIdx)}（變卦）`;

    // 互卦（常用計法）
    const huLines = [ lines[1], lines[2], lines[3], lines[2], lines[3], lines[4] ];
    const hexHu = findHexEntryByLines(huLines) || null;
    const huName = hexHu && (hexHu.name || hexHu.title) ? (hexHu.name || hexHu.title) : '互卦';

    // Render 主卦、變卦、互卦
    document.getElementById('guaName').textContent = mainName;
    document.getElementById('guaImage').innerHTML = getGuaHtml(lines, moving);
    document.getElementById('guaNote').textContent = (hexMain && (hexMain.judgment || hexMain.note || hexMain.description)) ? (hexMain.judgment || hexMain.note || hexMain.description) : '';

    document.getElementById('changeGuaName').textContent = changeName;
    document.getElementById('changeGuaImage').innerHTML = getGuaHtml(changeLines, []); // 變卦顯示翻轉後的線條

    document.getElementById('huGuaName').textContent = huName;
    document.getElementById('huGuaImage').innerHTML = getGuaHtml(huLines, []);

    // 動爻解釋：多變爻全部顯示（若 hexMain 有 lines 資料）
    const lineBox = document.getElementById('lineTextDisplay');
    lineBox.innerHTML = '';
    if (moving.length > 0) {
      if (hexMain && Array.isArray(hexMain.lines)) {
        moving.forEach(mv => {
          const le = getLineEntryFor(hexMain, mv);
          if (le) {
            const text = escapeHtml(le.text || le.name || le.desc || le.description || '');
            const meaning = escapeHtml(le.meaning || le.note || '');
            lineBox.innerHTML += `<div><strong>${mv} 爻：</strong>${text}<div class="hint">${meaning}</div></div>`;
          } else {
            lineBox.innerHTML += `<div><strong>${mv} 爻：</strong><em>（hexagrams.json 中找不到該爻的爻辭）</em></div>`;
          }
        });
      } else {
        // hexMain 不存在或無 lines，顯示 fallback 訊息
        moving.forEach(mv => {
          lineBox.innerHTML += `<div><strong>${mv} 爻：</strong><em>（未載入或找不到 hexagrams.json，無法顯示爻辭）</em></div>`;
        });
      }
      document.getElementById('line-explanation').classList.remove('hidden');
    } else {
      document.getElementById('line-explanation').classList.add('hidden');
    }

    document.getElementById('result').classList.remove('hidden');
    document.getElementById('judgeBox').classList.add('hidden');

    currentResult = { uIdx, lIdx, lines, hexMain, changeLines, hexChange, huLines, hexHu, moving };
  }

  /* ---------------------------
     綁定：數字取卦（含隨機預設）
     --------------------------- */
  function rand100to999(){ return Math.floor(Math.random()*900) + 100; }
  document.getElementById('numUpper').value = rand100to999();
  document.getElementById('numLower').value = rand100to999();
  document.getElementById('numMoving').value = rand100to999();

  document.getElementById('btnNumber').addEventListener('click', ()=>{
    const a = Number(document.getElementById('numUpper').value);
    const b = Number(document.getElementById('numLower').value);
    const c = Number(document.getElementById('numMoving').value);
    if (![a,b,c].every(x => Number.isInteger(x) && x >= 100 && x <= 999)) {
      alert('請輸入 100 到 999 的整數（或重新整理頁面取得隨機值）。');
      return;
    }
    const u = (a % 8) || 8;
    const l = (b % 8) || 8;
    const m = (c % 6) || 6;
    generateGua(u, l, [m]);
  });

  /* ---------------------------
     綁定：手動取卦
     --------------------------- */
  document.getElementById('btnManual').addEventListener('click', ()=>{
    const u = Number(document.getElementById('selUpper').value);
    const l = Number(document.getElementById('selLower').value);
    const raw = (document.getElementById('inputMoving').value || '').trim();
    const ms = raw === '' ? [] : raw.split(',').map(s => parseInt(s.trim(),10)).filter(x => Number.isInteger(x) && x>=1 && x<=6);
    generateGua(u, l, ms);
  });

  /* ---------------------------
     綁定：時間取卦（梅花易）初始化與處理
     --------------------------- */
  function pad(n){ return String(n).padStart(2,'0'); }
  function localDatetimeForInput(d){
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
  }
  // 預設現在時間
  document.getElementById('dtInput').value = localDatetimeForInput(new Date());
  document.getElementById('nowQuick').addEventListener('click', ()=> {
    document.getElementById('dtInput').value = localDatetimeForInput(new Date());
  });
  document.getElementById('btnTime').addEventListener('click', ()=>{
    const val = document.getElementById('dtInput').value;
    if (!val) { alert('請先選擇日期時間'); return; }
    const d = new Date(val);
    const y = d.getFullYear(), mo = d.getMonth()+1, da = d.getDate(), h = d.getHours(), mi = d.getMinutes();
    const ymd = y + mo + da;
    const u = (ymd % 8) || 8;
    const l = ((ymd + h) % 8) || 8;
    const m = ((ymd + h + mi) % 6) || 6;
    generateGua(u, l, [m]);
  });

  /* ---------------------------
     綁定：以象取卦
     --------------------------- */
  document.getElementById('btnImage').addEventListener('click', ()=>{
    const u = Number(document.getElementById('upperImageSelect').value);
    const l = Number(document.getElementById('lowerDirectionSelect').value);
    let m;
    if (document.getElementById('imageUseMinute').checked) {
      const d = new Date();
      const ymd = d.getFullYear() + (d.getMonth()+1) + d.getDate();
      m = ((ymd + d.getHours() + d.getMinutes()) % 6) || 6;
    } else {
      const raw = Number(document.getElementById('imageMovingInput').value) || 1;
      m = (raw % 6) || 6;
    }
    generateGua(u, l, [m]);
  });

  /* ---------------------------
     綜合判斷（示例，可用 hex 資料擴充）
     --------------------------- */
  const ASPECTS = [{k:'people',label:'人'},{k:'affairs',label:'事'},{k:'time',label:'時'},{k:'place',label:'地'},{k:'object',label:'物'}];
  function clamp(x){ return Math.max(0, Math.min(10, Number(x) || 0)); }

  function getAspectScoresFor(entry){
    if (!entry || !entry.judgment) return {people:5,affairs:5,time:5,place:5,object:5};
    const j = entry.judgment;
    return {
      people: clamp(j.people ?? j.overall ?? 5),
      affairs: clamp(j.affairs ?? j.overall ?? 5),
      time: clamp(j.time ?? j.overall ?? 5),
      place: clamp(j.place ?? j.overall ?? 5),
      object: clamp(j.object ?? j.overall ?? 5)
    };
  }

  function computeScores(result){
    const mainScores = getAspectScoresFor(result.hexMain);
    const changeScores = result.hexChange ? getAspectScoresFor(result.hexChange) : {people:5,affairs:5,time:5,place:5,object:5};
    const huScores = result.hexHu ? getAspectScoresFor(result.hexHu) : {people:5,affairs:5,time:5,place:5,object:5};
    // moving lines average (若 hexMain 有 lines[].score/aspect)
    let movingScores = {people:5,affairs:5,time:5,place:5,object:5};
    if (result.moving && result.moving.length>0 && result.hexMain && Array.isArray(result.hexMain.lines)){
      let sum = {people:0,affairs:0,time:0,place:0,object:0}; let c=0;
      result.moving.forEach(mv => {
        const le = getLineEntryFor(result.hexMain, mv);
        if (le) {
          const a = le.aspect || {};
          const s = Number(le.score ?? 5);
          sum.people += clamp(a.people ?? s);
          sum.affairs += clamp(a.affairs ?? s);
          sum.time += clamp(a.time ?? s);
          sum.place += clamp(a.place ?? s);
          sum.object += clamp(a.object ?? s);
        } else {
          sum.people += 5; sum.affairs += 5; sum.time += 5; sum.place += 5; sum.object += 5;
        }
        c++;
      });
      if (c>0) movingScores = {people: sum.people/c, affairs: sum.affairs/c, time: sum.time/c, place: sum.place/c, object: sum.object/c};
    }

    const WEIGHTS = {moving:0.4, main:0.25, change:0.2, hu:0.15};
    const out = {};
    ASPECTS.forEach(a => {
      out[a.k] = WEIGHTS.moving * movingScores[a.k] + WEIGHTS.main * mainScores[a.k] + WEIGHTS.change * changeScores[a.k] + WEIGHTS.hu * huScores[a.k];
    });
    return out;
  }

  function renderScores(scores){
    const wrap = document.getElementById('scoreWrap');
    wrap.innerHTML = '';
    ASPECTS.forEach(a => {
      const v = clamp(scores[a.k]);
      const card = document.createElement('div'); card.className = 'score-card';
      const lbl = document.createElement('div'); lbl.textContent = `【${a.label}】`;
      const barWrap = document.createElement('div'); barWrap.className = 'score-bar-wrap';
      const bar = document.createElement('div'); bar.className = 'score-bar'; bar.style.width = (v*10) + '%';
      barWrap.appendChild(bar);
      const val = document.createElement('div'); val.className = 'score-val'; val.textContent = v.toFixed(1);
      card.appendChild(lbl); card.appendChild(barWrap); card.appendChild(val);
      wrap.appendChild(card);
    });
  }

  document.getElementById('judgeBtn').addEventListener('click', ()=>{
    if (!currentResult) { alert('請先生成卦象'); return; }
    const scores = computeScores(currentResult);
    renderScores(scores);
    document.getElementById('judgeBox').classList.remove('hidden');
  });

  </script>
</body>
</html>
