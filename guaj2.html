<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>張老師易經卜卦</title>
  <style>
    body { font-family: 'Noto Sans TC', sans-serif; background:#f7f7f7; padding:20px; color:#222; }
    .container { max-width:980px; margin:0 auto; background:#fff; padding:22px; border-radius:12px; box-shadow:0 6px 24px rgba(0,0,0,.08); }
    h1 { margin:0 0 4px 0; font-size:26px; }
    h2.subtitle { margin:0 0 18px 0; color:#666; font-weight:400; font-size:15px; }
    .tab-buttons{ display:flex; gap:8px; flex-wrap:wrap; margin-bottom:14px; }
    .tab-button{ padding:8px 14px; border:0; border-radius:8px; cursor:pointer; background:#efefef; color:#333; }
    .tab-button.active{ background:#333; color:#fff; }
    .tab-content{ display:none; padding:6px 0 18px 0; }
    .tab-content.active{ display:block; }
    .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin:8px 0; }
    .hint{ font-size:13px; color:#666; }
    .gua-box{ border:1px solid #e3e3e3; border-radius:10px; padding:12px; margin-bottom:12px; background:#fafafa; }
    .moving-line{ color:#b71c1c; font-weight:600; }
    .hidden{ display:none; }
    button.primary{ padding:9px 16px; background:#222; color:#fff; border:0; border-radius:8px; cursor:pointer; }
    select, input[type="number"], input[type="text"], input[type="datetime-local"] {
      padding:8px; border-radius:8px; border:1px solid #d0d0d0; font-size:14px;
    }
    .pill{ display:inline-block; padding:4px 8px; border-radius:999px; background:#f0f0f0; font-size:12px; color:#444; }
    #line-explanation > div { margin-bottom:10px; padding-bottom:8px; border-bottom:1px dashed #eee; }
    .score-card { display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; gap:10px; }
    .score-bar-wrap{ flex:1; margin:0 10px; height:10px; background:#eee; border-radius:6px; overflow:hidden; }
    .score-bar{ height:100%; width:0; transition:width .4s; background:linear-gradient(90deg,#f44336,#ff9800,#4caf50); }
    .score-val{ font-weight:600; min-width:36px; text-align:right; }
  </style>
</head>
<body>
  <div class="container">
    <h1>張老師易經卜卦</h1>
    <h2 class="subtitle" id="subtitle">載入中…</h2>

    <!-- 分頁切換 -->
    <div class="tab-buttons">
      <button class="tab-button active" onclick="showTab('tab-number')">數字取卦</button>
      <button class="tab-button" onclick="showTab('tab-manual')">手動取卦</button>
      <button class="tab-button" onclick="showTab('tab-time')">時間取卦（梅花易）</button>
      <button class="tab-button" onclick="showTab('tab-image')">以象取卦</button>
    </div>

    <!-- 數字取卦 -->
    <div id="tab-number" class="tab-content active">
      <h3>數字取卦</h3>
      <div class="row">
        <input type="number" id="num-upper" placeholder="上卦數字 (100-999)" min="100" max="999" />
        <input type="number" id="num-lower" placeholder="下卦數字 (100-999)" min="100" max="999" />
        <input type="number" id="num-moving" placeholder="動爻數字 (100-999)" min="100" max="999" />
        <button id="btn-number" class="primary">生成卦象</button>
      </div>
      <div class="row"><span class="hint">頁面刷新會隨機預設三個數字</span></div>
    </div>

    <!-- 手動取卦 -->
    <div id="tab-manual" class="tab-content">
      <h3>手動取卦</h3>
      <div class="row">
        <select id="sel-upper">
          <option value="1">乾</option><option value="2">兌</option><option value="3">離</option><option value="4">震</option>
          <option value="5">巽</option><option value="6">坎</option><option value="7">艮</option><option value="8">坤</option>
        </select>
        <select id="sel-lower">
          <option value="1">乾</option><option value="2">兌</option><option value="3">離</option><option value="4">震</option>
          <option value="5">巽</option><option value="6">坎</option><option value="7">艮</option><option value="8">坤</option>
        </select>
        <input type="text" id="input-moving" placeholder="變爻 (例: 1,3)" />
        <button id="btn-manual" class="primary">生成卦象</button>
      </div>
    </div>

    <!-- 時間取卦 -->
    <div id="tab-time" class="tab-content">
      <h3>時間取卦（梅花易）</h3>
      <div class="row">
        <input type="datetime-local" id="input-dt" />
        <button id="btn-time" class="primary">以時間生成卦象</button>
        <span class="pill" id="btn-now">使用現在時間</span>
      </div>
      <span class="hint">演算法：上卦 = (年+月+日) % 8；下卦 = (年+月+日+時) % 8；動爻 = (年+月+日+時+分) % 6；餘數為 0 時分別記為 8/6。</span>
    </div>

    <!-- 以象取卦 -->
    <div id="tab-image" class="tab-content">
      <h3>以象取卦</h3>
      <div class="row">
        <label>上卦：</label>
        <select id="sel-upper-image">
          <option value="1">乾（金）—天、圓、馬、父</option>
          <option value="2">兌（金）—澤、口、悅、羊</option>
          <option value="3">離（火）—日、電、目、中女</option>
          <option value="4">震（木）—雷、動、竹、長男</option>
          <option value="5">巽（木）—風、入、雞、長女</option>
          <option value="6">坎（水）—水、陷、耳、中男</option>
          <option value="7">艮（土）—山、止、手、少男</option>
          <option value="8">坤（土）—地、母、牛、腹</option>
        </select>
      </div>
      <div class="row">
        <label>下卦（後天方位）：</label>
        <select id="sel-lower-image">
          <option value="6">北（坎）</option><option value="3">南（離）</option><option value="4">東（震）</option><option value="2">西（兌）</option>
          <option value="7">東北（艮）</option><option value="1">西北（乾）</option><option value="5">東南（巽）</option><option value="8">西南（坤）</option>
        </select>
      </div>
      <div class="row">
        <input type="number" id="input-moving-image" placeholder="動爻 1~6" min="1" max="6" />
        <label><input type="checkbox" id="chk-minute"> 用當前分鐘取動爻</label>
      </div>
      <button id="btn-image" class="primary">生成卦象</button>
    </div>

    <!-- 結果顯示 -->
    <div id="result" class="hidden">
      <h2>卦象結果</h2>

      <div class="gua-box"><h3>本卦</h3><h2 id="gua-name"></h2><div id="gua-img"></div></div>
      <div class="gua-box"><h3>變卦</h3><h2 id="gua-change-name"></h2><div id="gua-change-img"></div></div>
      <div class="gua-box"><h3>互卦</h3><h2 id="gua-hu-name"></h2><div id="gua-hu-img"></div></div>

      <div id="line-explanation" class="gua-box hidden"><h3>動爻解釋</h3><div id="line-text"></div></div>
      <div id="judgeBox" class="gua-box hidden"><h3>綜合判斷</h3><div id="scoreWrap"></div></div>

      <button id="btn-judge" class="primary">綜合判斷</button>
    </div>
  </div>

  <script>
    /* 副標題 quotes.json */
    fetch('quotes.json').then(r=>r.json()).then(list=>{
      if(Array.isArray(list)&&list.length>0){
        document.getElementById('subtitle').textContent=list[Math.floor(Math.random()*list.length)];
      }
    }).catch(()=>{document.getElementById('subtitle').textContent='易有太極，是生兩儀，兩儀生四象，四象生八卦。';});

    /* 八卦 */
    const guaTable={1:[1,1,1],2:[0,1,1],3:[1,0,1],4:[0,0,1],5:[1,1,0],6:[0,1,0],7:[1,0,0],8:[0,0,0]};
    const trigramName={1:'乾',2:'兌',3:'離',4:'震',5:'巽',6:'坎',7:'艮',8:'坤'};
    const triIndexByLines=new Map(Object.entries(guaTable).map(([i,arr])=>[JSON.stringify(arr),+i]));

    let hexagramsData={};
    fetch('hexagrams.json').then(r=>r.json()).then(j=>hexagramsData=j).catch(()=>{});

    /* 切換分頁 */
    function showTab(id){
      document.querySelectorAll('.tab-button').forEach(b=>b.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));
      document.querySelector(`.tab-button[onclick="showTab('${id}')"]`).classList.add('active');
      document.getElementById(id).classList.add('active');
    }

    function formatName(u,l){return `${trigramName[u]}上・${trigramName[l]}下`;}
    function makeFromLines(lines){const l=triIndexByLines.get(JSON.stringify(lines.slice(0,3)));const u=triIndexByLines.get(JSON.stringify(lines.slice(3)));return{name:formatName(u,l),lines:[...lines],uIdx:u,lIdx:l};}
    function getGuaHtml(lines,moving=[]){let h='';[...lines].reverse().forEach((l,i)=>{const n=6-i;const txt=l===1?'———————':'———   ———';h+=moving.includes(n)?`<div class="moving-line">${txt} （${n}爻）</div>`:`<div>${txt}</div>`;});return h;}

    let currentResult={};
    function generate(u,l,moving){
      const lines=[...guaTable[l],...guaTable[u]];
      const main={name:formatName(u,l),lines};
      const change=[...lines];(moving||[]).forEach(n=>{const i=n-1;if(i>=0&&i<6)change[i]=1-change[i];});
      const changeG=makeFromLines(change);
      const hu=makeFromLines([lines[1],lines[2],lines[3],lines[2],lines[3],lines[4]]);
      document.getElementById('gua-name').textContent=main.name;
      document.getElementById('gua-img').innerHTML=getGuaHtml(lines,moving);
      document.getElementById('gua-change-name').textContent=changeG.name;
      document.getElementById('gua-change-img').innerHTML=getGuaHtml(change);
      document.getElementById('gua-hu-name').textContent=hu.name;
      document.getElementById('gua-hu-img').innerHTML=getGuaHtml(hu.lines);
      const disp=document.getElementById('line-text');disp.innerHTML='';
      if(moving.length>0&&hexagramsData[main.name]){const linesData=hexagramsData[main.name].lines||[];moving.forEach(mv=>{const ld=linesData.find(lx=>lx.index===mv);disp.innerHTML+=`<div><b>${mv}爻：</b>${ld?ld.text:''} <small>${ld?ld.meaning:''}</small></div>`;});document.getElementById('line-explanation').classList.remove('hidden');}
      else document.getElementById('line-explanation').classList.add('hidden');
      document.getElementById('result').classList.remove('hidden');document.getElementById('judgeBox').classList.add('hidden');
      currentResult={main,change:changeG,hu,moving};
    }

    /* 數字取卦 */
    function rand(){return Math.floor(Math.random()*900)+100;}
    document.getElementById('num-upper').value=rand();document.getElementById('num-lower').value=rand();document.getElementById('num-moving').value=rand();
    document.getElementById('btn-number').onclick=()=>{const a=+num-upper.value,b=+num-lower.value,c=+num-moving.value;generate((a%8)||8,(b%8)||8,[(c%6)||6]);};

    /* 手動取卦 */
    document.getElementById('btn-manual').onclick=()=>{const u=+sel-upper.value,l=+sel-lower.value;const ms=input-moving.value.split(',').map(x=>+x.trim()).filter(x=>x>=1&&x<=6);generate(u,l,ms);};

    /* 時間取卦 */
    function meihua(d){const ymd=d.getFullYear()+d.getMonth()+1+d.getDate();return{u:(ymd%8)||8,l:((ymd+d.getHours())%8)||8,m:((ymd+d.getHours()+d.getMinutes())%6)||6};}
    document.getElementById('btn-now').onclick=()=>{const d=new Date();input-dt.value=d.toISOString().slice(0,16);};
    document.getElementById('btn-time').onclick=()=>{if(!input-dt.value)return;const d=new Date(input-dt.value);const {u,l,m}=meihua(d);generate(u,l,[m]);};

    /* 以象取卦 */
    document.getElementById('btn-image').onclick=()=>{const u=+sel-upper-image.value,l=+sel-lower-image.value;let m;if(chk-minute.checked){const d=new Date();const ymd=d.getFullYear()+d.getMonth()+1+d.getDate();m=((ymd+d.getHours()+d.getMinutes())%6)||6;}else{m=(+input-moving-image.value%6)||6;}generate(u,l,[m]);};

    /* 綜合判斷（簡化版） */
    const ASPECTS=['人','事','時','地','物'];
    document.getElementById('btn-judge').onclick=()=>{if(!currentResult.main)return;const wrap=document.getElementById('scoreWrap');wrap.innerHTML='';ASPECTS.forEach(a=>{const val=(Math.random()*10).toFixed(1);wrap.innerHTML+=`<div class="score-card"><div>【${a}】</div><div class="score-bar-wrap"><div class="score-bar" style="width:${val*10}%;"></div></div><div class="score-val">${val}</div></div>`;});document.getElementById('judgeBox').classList.remove('hidden');};
  </script>
</body>
</html>
