<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>è¥¿å‹¢åœ‹å°æ™ºæ…§å›æ”¶ç®±ç®¡ç†ç³»çµ±</title>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background-color: #f4f7f9; color: #333; }
    .container { max-width: 1200px; margin: auto; background: white; padding: 25px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
    h2, h3 { color: #2c3e50; }
    button { padding: 10px 15px; margin: 5px; border: none; border-radius: 4px; color: white; cursor: pointer; transition: background-color 0.3s; }
    #status { font-weight: bold; }
    #messages { border: 1px solid #ddd; padding: 15px; height: 120px; overflow: auto; background: #fafafa; margin-top: 10px; border-radius: 4px; }
    #chart-container { background: #fff; padding: 10px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    #map { height: 500px; width: 100%; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }

    .status-box { padding: 10px; background: #f0f2f5; border-radius: 4px; text-align: center; }
    #status-overview { display: flex; justify-content: space-around; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; }

    /* Button Colors */
    #connect-btn { background-color: #007bff; }
    #pub-btn { background-color: #28a745; }
    #start-btn { background-color: #17a2b8; }
    #stop-btn { background-color: #dc3545; }
    button:hover { filter: brightness(1.1); }
  </style>
</head>
<body>
  <div class="container">
    <h2>è¥¿å‹¢åœ‹å°æ™ºæ…§å›æ”¶ç®±ç®¡ç†ç³»çµ±</h2>
    
    <div>
      <label>Broker URL:</label>
      <input id="brokerUrl" value="wss://broker.mqttgo.io:8084/mqtt" size="45">
      <button id="connect-btn" onclick="connect()">é€£ç·š</button>
      <span style="margin-left: 20px;"><strong>é€£ç·šç‹€æ…‹:</strong> <span id="status" style="color:red;">ğŸ”´ æœªé€£ç·š</span></span>
    </div>
    
    <div style="margin-top: 10px;">
      <label>æ»¿ç®±è­¦å‘Šé–¾å€¼:</label>
      <input id="fullThreshold" type="number" value="3" min="1">
      <label style="margin-left: 20px;">ç•°å¸¸è­¦å‘Šé–¾å€¼:</label>
      <input id="errorThreshold" type="number" value="1" min="1">
    </div>

    <hr style="margin: 20px 0;">

    <h3>å›æ”¶ç®±ç‹€æ…‹ç¸½è¦½</h3>
    <div id="status-overview">
      <div class="status-box">ç©ºç®± (0): <span id="count-0">0</span></div>
      <div class="status-box">ä¸‰åˆ†æ»¿ (1): <span id="count-1">0</span></div>
      <div class="status-box">ä¸ƒåˆ†æ»¿ (2): <span id="count-2">0</span></div>
      <div class="status-box">å·²æ»¿ç®± (3): <span id="count-3">0</span></div>
      <div class="status-box">ç•°å¸¸ (4): <span id="count-4">0</span></div>
    </div>
    
    <div class="grid">
      <div>
        <h3>å³æ™‚æ»¿ç®±ç‹€æ…‹</h3>
        <div id="chart-container">
          <canvas id="myChart" width="500" height="350"></canvas>
        </div>
      </div>
      
      <div>
        <h3>åœ°åœ–ä½ç½®èˆ‡ç‹€æ…‹</h3>
        <div id="map"></div>
      </div>
    </div>
    
    <hr style="margin: 20px 0;">

    <h3>æ¨¡æ“¬èˆ‡æ¸¬è©¦</h3>
    <div>
      <label>ç™¼ä½ˆä¸»é¡Œ:</label>
      <input id="pubTopic" value="SSSES/BOX1/S">
      <label>æ»¿ç®±ç‹€æ…‹ (0-4):</label>
      <input id="pubMsg" type="number" value="3" min="0" max="4">
      <button id="pub-btn" onclick="publish()">ç™¼ä½ˆ</button>
      <button id="start-btn" onclick="startSimulation()">â–¶ é–‹å§‹æ¨¡æ“¬</button>
      <button id="stop-btn" onclick="stopSimulation()">â¹ åœæ­¢æ¨¡æ“¬</button>
    </div>

    <div style="margin-top: 20px;">
      <h3>è¨Šæ¯ç´€éŒ„</h3>
      <div id="messages"></div>
    </div>
  </div>

  <script>
    let client;
    let chart;
    let simInterval = null;
    let map;
    const markers = [];

    const colors = ["#4CAF50", "#FFC107", "#FF9800", "#F44336", "#9C27B0"]; // ç¶ , é»ƒ, æ©™, ç´…, ç´«
    const topicCount = 10;
    const boxLabels = Array.from({ length: topicCount }, (_, i) => `å›æ”¶ç®± ${i + 1}`);
    const topics = Array.from({ length: topicCount }, (_, i) => `SSSES/BOX${i + 1}/S`);
    
    const chartData = {
      labels: boxLabels,
      datasets: [{
        label: 'æ»¿ç®±ç‹€æ…‹',
        data: Array(topicCount).fill(0), // åˆå§‹å€¼
        backgroundColor: Array(topicCount).fill(colors[0])
      }]
    };
    
    // å½°åŒ–ç¸£ç¦èˆˆé„‰çš„ç¶“ç·¯åº¦ä¸­å¿ƒé»
    const fuxingLocation = { lat: 24.0326, lng: 120.4042 };
    const boxLocations = [
        { lat: 24.035, lng: 120.400, label: 'å›æ”¶ç®± 1' },
        { lat: 24.030, lng: 120.408, label: 'å›æ”¶ç®± 2' },
        { lat: 24.025, lng: 120.405, label: 'å›æ”¶ç®± 3' },
        { lat: 24.028, lng: 120.412, label: 'å›æ”¶ç®± 4' },
        { lat: 24.033, lng: 120.415, label: 'å›æ”¶ç®± 5' },
        { lat: 24.038, lng: 120.409, label: 'å›æ”¶ç®± 6' },
        { lat: 24.036, lng: 120.404, label: 'å›æ”¶ç®± 7' },
        { lat: 24.031, lng: 120.401, label: 'å›æ”¶ç®± 8' },
        { lat: 24.029, lng: 120.407, label: 'å›æ”¶ç®± 9' },
        { lat: 24.034, lng: 120.411, label: 'å›æ”¶ç®± 10' }
    ];

    function setStatus(text, color) {
      const el = document.getElementById("status");
      el.textContent = text;
      el.style.color = color;
    }

    function log(message) {
      const messagesDiv = document.getElementById("messages");
      const p = document.createElement("p");
      p.textContent = message;
      messagesDiv.prepend(p);
      if (messagesDiv.children.length > 5) {
        messagesDiv.removeChild(messagesDiv.lastChild);
      }
    }
    
    // åˆå§‹åŒ–åœ–è¡¨
    function initChart() {
      if (chart) chart.destroy();
      const ctx = document.getElementById("myChart").getContext("2d");
      chart = new Chart(ctx, {
        type: 'bar',
        data: chartData,
        options: {
          responsive: true,
          scales: {
            y: { beginAtZero: true, max: 4, ticks: { stepSize: 1, callback: function(value) { return ["ç©ºç®±", "ä¸‰åˆ†æ»¿", "ä¸ƒåˆ†æ»¿", "æ»¿ç®±", "ç•°å¸¸"][value] || value; } } },
            x: { stacked: true }
          },
          plugins: { legend: { display: false } }
        }
      });
    }

    // åˆå§‹åŒ–åœ°åœ–
    function initMap() {
        const mapOptions = {
            zoom: 13,
            center: fuxingLocation,
            mapId: 'DEMO_MAP_ID' // å¦‚æœæœ‰ï¼Œè«‹æ›¿æ›
        };
        map = new google.maps.Map(document.getElementById("map"), mapOptions);
        
        boxLocations.forEach((location, index) => {
            const marker = new google.maps.Marker({
                position: location,
                map: map,
                title: location.label
            });
            markers.push(marker);

            const infowindow = new google.maps.InfoWindow({
                content: `<h3>${location.label}</h3><p>ç‹€æ…‹: æœªçŸ¥</p>`
            });

            marker.addListener("click", () => {
                infowindow.open(map, marker);
            });
        });
    }

    // æ›´æ–°åœ°åœ–æ¨™è¨˜è³‡è¨Š
    function updateMapMarker(index, value) {
        const marker = markers[index];
        const statusText = ["ç©ºç®±", "ä¸‰åˆ†æ»¿", "ä¸ƒåˆ†æ»¿", "æ»¿ç®±", "ç•°å¸¸"][value];
        const infowindow = new google.maps.InfoWindow({
            content: `<h3>${marker.getTitle()}</h3><p>ç‹€æ…‹: ${statusText}</p>`
        });
        marker.addListener("click", () => {
            infowindow.open(map, marker);
        });
    }

    // é€£ç·šåˆ° MQTT Broker
    function connect() {
      if (client && client.connected) { log("âš ï¸ å·²é€£ç·šï¼Œè«‹å‹¿é‡è¤‡é€£ç·šã€‚"); return; }
      const url = document.getElementById("brokerUrl").value.trim();
      if (!url) { alert("è«‹è¼¸å…¥ Broker URL"); return; }
      setStatus("ğŸŸ¡ é€£ç·šä¸­...", "orange");
      const clientId = `web-client-${Math.random().toString(16).substr(2, 8)}`;
      client = mqtt.connect(url, { clientId: clientId });

      client.on("connect", () => {
        setStatus("ğŸŸ¢ å·²é€£ç·š", "green");
        log(`âœ… å·²é€£ç·šåˆ° ${url}`);
        topics.forEach(topic => { client.subscribe(topic, (err) => { if (!err) { log(`ğŸ“¡ å·²è¨‚é–±ä¸»é¡Œ: ${topic}`); } }); });
      });

      client.on("close", () => setStatus("ğŸ”´ å·²æ–·ç·š", "red"));
      client.on("error", (err) => {
        setStatus("ğŸ”´ éŒ¯èª¤", "red");
        log("âŒ é€£ç·šéŒ¯èª¤: " + err.message);
        client.end();
      });

      client.on("message", (topic, message) => {
        const msg = message.toString();
        log(`ğŸ“© æ”¶åˆ°ä¾†è‡ª [${topic}] çš„è¨Šæ¯: ${msg}`);
        updateData(topic, msg);
      });
    }

    // ç™¼ä½ˆè¨Šæ¯
    function publish() {
      if (!client || !client.connected) { alert("å°šæœªé€£ç·š"); return; }
      const topic = document.getElementById("pubTopic").value.trim();
      const msg = document.getElementById("pubMsg").value.trim();
      if (!topic || msg === "") { alert("è«‹è¼¸å…¥ä¸»é¡Œå’Œè¨Šæ¯"); return; }
      client.publish(topic, msg);
      log(`ğŸš€ å·²ç™¼ä½ˆåˆ° [${topic}]: ${msg}`);
    }

    // æ›´æ–°åœ–è¡¨èˆ‡ç¸½è¦½
    function updateData(topic, msg) {
      const value = parseInt(msg);
      if (isNaN(value) || value < 0 || value > 4) { log(`âš  ç„¡æ•ˆçš„æ•¸å€¼: ${msg}ï¼Œå¿½ç•¥æ›´æ–°ã€‚`); return; }
      
      const index = topics.indexOf(topic);
      if (index > -1) {
        chartData.datasets[0].data[index] = value;
        chartData.datasets[0].backgroundColor[index] = colors[value];
        chart.update();
        updateMapMarker(index, value);
        updateStatusOverview();
      }
    }

    // æ›´æ–°ç‹€æ…‹ç¸½è¦½ä¸¦æª¢æŸ¥è­¦å‘Š
    function updateStatusOverview() {
        const counts = { 0: 0, 1: 0, 2: 0, 3: 0, 4: 0 };
        chartData.datasets[0].data.forEach(value => {
            counts[value]++;
        });

        document.getElementById("count-0").textContent = counts[0];
        document.getElementById("count-1").textContent = counts[1];
        document.getElementById("count-2").textContent = counts[2];
        document.getElementById("count-3").textContent = counts[3];
        document.getElementById("count-4").textContent = counts[4];

        checkWarnings(counts);
    }
    
    // æª¢æŸ¥è­¦å‘Šä¸¦ç™¼å¸ƒé€šçŸ¥
    function checkWarnings(counts) {
        const fullThreshold = parseInt(document.getElementById("fullThreshold").value);
        const errorThreshold = parseInt(document.getElementById("errorThreshold").value);

        if (counts[3] >= fullThreshold) {
            log(`ğŸ”” è­¦å‘Š: å·²æ»¿ç®±æ•¸é‡ (${counts[3]}) è¶…éé–¾å€¼ (${fullThreshold})ï¼`);
            client.publish("SSSES/BOX/F", counts[3].toString());
        }

        if (counts[4] >= errorThreshold) {
            log(`ğŸš¨ è­¦å‘Š: ç•°å¸¸æ•¸é‡ (${counts[4]}) è¶…éé–¾å€¼ (${errorThreshold})ï¼`);
            client.publish("SSSES/BOX/E", counts[4].toString());
        }
    }

    // å•Ÿå‹•æ¨¡æ“¬
    function startSimulation() {
      if (simInterval) return;
      log("â–¶ é–‹å§‹æ¨¡æ“¬æ•¸æ“šç™¼ä½ˆ...");
      simInterval = setInterval(() => {
        const randomTopic = topics[Math.floor(Math.random() * topics.length)];
        const randomValue = Math.floor(Math.random() * 5); // 0, 1, 2, 3, 4
        client.publish(randomTopic, randomValue.toString());
      }, 1500); // æ¯ 1.5 ç§’ç™¼å¸ƒä¸€æ¬¡
    }

    // åœæ­¢æ¨¡æ“¬
    function stopSimulation() {
      if (simInterval) {
        clearInterval(simInterval);
        simInterval = null;
        log("â¹ åœæ­¢æ¨¡æ“¬ã€‚");
      }
    }
    
    // ç¶²é è¼‰å…¥å¾Œè‡ªå‹•åˆå§‹åŒ–åœ–è¡¨èˆ‡åœ°åœ–
    window.onload = function() {
        initChart();
        // è¼‰å…¥ Google Maps APIï¼Œä¸¦åœ¨è¼‰å…¥å¾Œåˆå§‹åŒ–åœ°åœ–
        const script = document.createElement('script');
        script.src = `https://maps.googleapis.com/maps/api/js?key=YOUR_GOOGLE_MAPS_API_KEY&callback=initMap`;
        script.async = true;
        document.head.appendChild(script);
    };

  </script>
</body>
</html>
