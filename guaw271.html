<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>易經占卜</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background: #f5f5f5; }
    h1 { text-align: center; color: #333; }
    .tabs { display: flex; justify-content: center; margin-bottom: 20px; }
    .tab-button { padding: 10px 20px; margin: 0 5px; cursor: pointer; background: #ddd; border-radius: 5px; }
    .tab-button.active { background: #007bff; color: white; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .input-group { margin: 10px 0; }
    .input-group label { margin-right: 10px; }
    .gua-container { display: flex; justify-content: space-around; margin: 20px 0; }
    .gua-box { text-align: center; }
    .gua-image div { width: 60px; height: 10px; margin: 5px auto; }
    .gua-yang { background: #000; }
    .gua-yin { background: #fff; border: 1px solid #000; position: relative; }
    .gua-yin::before, .gua-yin::after { content: ''; width: 25px; height: 10px; background: #fff; border: 1px solid #000; position: absolute; }
    .gua-yin::before { left: -27px; }
    .gua-yin::after { right: -27px; }
    .gua-moving span { position: absolute; top: -5px; left: 50%; transform: translateX(-50%); color: red; }
    .score-card { display: flex; align-items: center; margin: 5px 0; }
    .score-label { width: 60px; }
    .score-bar-wrap { width: 100px; height: 10px; background: #eee; border: 1px solid #ccc; }
    .score-bar { height: 100%; background: #007bff; }
    .score-val { width: 40px; text-align: right; }
    .wuxing-box { margin: 10px 0; }
    .wuxing-status { font-weight: bold; }
    .wuxing-status.大吉 { color: #28a745; }
    .wuxing-status.吉 { color: #17a2b8; }
    .wuxing-status.平 { color: #6c757d; }
    .wuxing-status.凶 { color: #ffc107; }
    .wuxing-status.大凶 { color: #dc3545; }
    .analysis-item { margin: 10px 0; }
    .analysis-status { display: block; margin-top: 5px; }
    .analysis-status.大吉 { color: #28a745; }
    .analysis-status.吉 { color: #17a2b8; }
    .analysis-status.平 { color: #6c757d; }
    .analysis-status.凶 { color: #ffc107; }
    .analysis-status.大凶 { color: #dc3545; }
    .trigram-details { margin-left: 20px; }
    .symbolism-section { margin-left: 20px; }
    .hint { color: #666; font-size: 0.9em; }
    .hidden { display: none; }
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; }
    .modal-content { background: #fff; padding: 20px; border-radius: 5px; width: 80%; max-width: 600px; }
    .modal-content textarea { width: 100%; height: 150px; margin-bottom: 10px; }
    .modal-content button { margin: 5px; padding: 8px 16px; cursor: pointer; }
    .history-list { max-height: 200px; overflow-y: auto; margin-top: 10px; }
    .history-item { padding: 5px; border-bottom: 1px solid #eee; cursor: pointer; }
    .history-item:hover { background: #f0f0f0; }
  </style>
</head>
<body>
  <h1>易經占卜</h1>
  <h3 id="subtitle">請選擇取卦方式以開始占卜</h3>
  
  <div class="tabs">
    <button class="tab-button active" data-target="number">數字取卦</button>
    <button class="tab-button" data-target="manual">手動取卦</button>
    <button class="tab-button" data-target="time">時間取卦</button>
    <button class="tab-button" data-target="image">以象取卦</button>
  </div>

  <div id="number" class="tab-content active">
    <div class="input-group">
      <label>上卦數字 (100–999):</label>
      <input type="number" id="numUpper" min="100" max="999">
    </div>
    <div class="input-group">
      <label>下卦數字 (100–999):</label>
      <input type="number" id="numLower" min="100" max="999">
    </div>
    <div class="input-group">
      <label>動爻數字 (100–999):</label>
      <input type="number" id="numMoving" min="100" max="999">
    </div>
    <button id="btnNumber">確定</button>
  </div>

  <div id="manual" class="tab-content">
    <div class="input-group">
      <label>上卦：</label>
      <select id="selUpper">
        <option value="1">乾</option>
        <option value="2">兌</option>
        <option value="3">離</option>
        <option value="4">震</option>
        <option value="5">巽</option>
        <option value="6">坎</option>
        <option value="7">艮</option>
        <option value="8">坤</option>
      </select>
    </div>
    <div class="input-group">
      <label>下卦：</label>
      <select id="selLower">
        <option value="1">乾</option>
        <option value="2">兌</option>
        <option value="3">離</option>
        <option value="4">震</option>
        <option value="5">巽</option>
        <option value="6">坎</option>
        <option value="7">艮</option>
        <option value="8">坤</option>
      </select>
    </div>
    <div class="input-group">
      <label>動爻 (1–6, 用逗號分隔):</label>
      <input type="text" id="inputMoving" placeholder="例如：1 或 1,3">
    </div>
    <button id="btnManual">確定</button>
  </div>

  <div id="time" class="tab-content">
    <div class="input-group">
      <label><input type="radio" name="time-method" value="modern" checked> 現代時間</label>
      <label><input type="radio" name="time-method" value="traditional"> 傳統時辰</label>
    </div>
    <div id="time-modern">
      <div class="input-group">
        <label>選擇日期時間：</label>
        <input type="datetime-local" id="dtInput">
        <button id="nowQuick">使用現在時間</button>
      </div>
    </div>
    <div id="time-traditional" class="hidden">
      <div class="input-group">
        <label>日期：</label>
        <input type="date" id="dateInput">
      </div>
      <div class="input-group">
        <label>時辰：</label>
        <select id="shichenInput">
          <option value="1">子時 (23:00–01:00)</option>
          <option value="2">丑時 (01:00–03:00)</option>
          <option value="3">寅時 (03:00–05:00)</option>
          <option value="4">卯時 (05:00–07:00)</option>
          <option value="5">辰時 (07:00–09:00)</option>
          <option value="6">巳時 (09:00–11:00)</option>
          <option value="7">午時 (11:00–13:00)</option>
          <option value="8">未時 (13:00–15:00)</option>
          <option value="9">申時 (15:00–17:00)</option>
          <option value="10">酉時 (17:00–19:00)</option>
          <option value="11">戌時 (19:00–21:00)</option>
          <option value="12">亥時 (21:00–23:00)</option>
        </select>
      </div>
      <div class="input-group">
        <label>分鐘 (0–59):</label>
        <input type="number" id="minuteInput" min="0" max="59">
      </div>
    </div>
    <button id="btnTime">確定</button>
  </div>

  <div id="image" class="tab-content">
    <div class="input-group">
      <label>上卦（自然現象）：</label>
      <select id="upperImageSelect">
        <option value="1">天（乾）</option>
        <option value="2">澤（兌）</option>
        <option value="3">火（離）</option>
        <option value="4">雷（震）</option>
        <option value="5">風（巽）</option>
        <option value="6">水（坎）</option>
        <option value="7">山（艮）</option>
        <option value="8">地（坤）</option>
      </select>
    </div>
    <div class="input-group">
      <label>下卦（方向）：</label>
      <select id="lowerDirectionSelect">
        <option value="1">西北（乾）</option>
        <option value="2">西（兌）</option>
        <option value="3">南（離）</option>
        <option value="4">東北（震）</option>
        <option value="5">東南（巽）</option>
        <option value="6">北（坎）</option>
        <option value="7">東北（艮）</option>
        <option value="8">西南（坤）</option>
      </select>
    </div>
    <div class="input-group">
      <label><input type="checkbox" id="imageUseMinute"> 使用當前分鐘作為動爻</label>
    </div>
    <div class="input-group">
      <label>動爻 (1–6):</label>
      <input type="number" id="imageMovingInput" min="1" max="6">
    </div>
    <button id="btnImage">確定</button>
  </div>

  <div id="result" class="hidden">
    <div class="gua-container">
      <div class="gua-box">
        <h3>本卦：<span id="guaName">未知</span></h3>
        <div id="guaImage" class="gua-image"></div>
      </div>
      <div class="gua-box">
        <h3>變卦：<span id="changeGuaName">未知</span></h3>
        <div id="changeGuaImage" class="gua-image"></div>
      </div>
      <div class="gua-box">
        <h3>互卦：<span id="huGuaName">未知</span></h3>
        <div id="huGuaImage" class="gua-image"></div>
      </div>
    </div>
    <p id="guaNote"></p>
    <div id="lineTextBox" class="hidden">
      <h4>動爻爻辭</h4>
      <div id="lineTextDisplay"></div>
    </div>
    <div class="input-group">
      <label>問事類別：</label>
      <select id="questionSelector">
        <option value="1">請選擇</option>
        <option value="love">感情</option>
        <option value="career">工作/學業</option>
        <option value="wealth">財運</option>
        <option value="health">健康</option>
        <option value="relationship">人際關係</option>
        <option value="life">生活/運勢</option>
        <option value="guidance">尋找指引</option>
      </select>
      <button id="analyzeBtn">分析</button>
      <button id="judgeBtn">綜合判斷</button>
      <button id="recordBtn">記錄</button>
      <button id="historyBtn">歷史記錄</button>
    </div>
    <div id="questionAnalysisResult" class="hidden"></div>
    <div id="judgeBox" class="hidden">
      <h3>五行分析</h3>
      <div id="wuxingAnalysis" class="hidden">
        <div id="wuxingContent"></div>
      </div>
      <h3>詳細象徵分析（僅單爻適用）</h3>
      <div id="detailedAnalysis" class="hidden">
        <div id="detailedContent"></div>
      </div>
    </div>
  </div>

  <div id="recordModal" class="modal">
    <div class="modal-content">
      <h3>卦象記錄</h3>
      <textarea id="recordText" readonly></textarea>
      <button id="copyRecordBtn">複製記錄</button>
      <button id="closeRecordBtn">關閉</button>
      <h4>歷史記錄</h4>
      <div id="historyList" class="history-list"></div>
    </div>
  </div>

<script>
/* ===========================
   資料：三爻（1..8）對應與標準卦名映射
   =========================== */
const guaTable = {
  1: [1,1,1,'金'], 2: [1,1,0,'金'], 3: [1,0,1,'火'], 4: [1,0,0,'木'],
  5: [0,1,1,'木'], 6: [0,1,0,'水'], 7: [0,0,1,'土'], 8: [0,0,0,'土']
};
const trigramName = {1:'乾',2:'兌',3:'離',4:'震',5:'巽',6:'坎',7:'艮',8:'坤'};
const triIndexByLines = new Map(Object.entries(guaTable).map(([i,arr])=>[JSON.stringify(arr.slice(0,3)), +i]));
const palaceMap = {
  '乾': ['乾為天', '天風姤', '天山遁', '天地否', '風地觀', '山地剝', '火地晉', '火天大有'],
  '坤': ['坤為地', '地雷復', '地澤臨', '地天泰', '雷天大壯', '澤天夬', '水天需', '水地比'],
  '震': ['震為雷', '雷地豫', '雷水解', '雷風恆', '地風升', '水風井', '澤風大過', '澤雷隨'],
  '巽': ['巽為風', '風天小畜', '風火家人', '風雷益', '天雷無妄', '火雷噬嗑', '山雷頤', '山風蠱'],
  '坎': ['坎為水', '水澤節', '水雷屯', '水火既濟', '澤火革', '雷火豐', '地火明夷', '地水師'],
  '離': ['離為火', '火山旅', '火風鼎', '火水未濟', '山水蒙', '風水渙', '天水訟', '天火同人'],
  '艮': ['艮為山', '山火賁', '山天大畜', '山澤損', '火澤睽', '天澤履', '風澤中孚', '風山漸'],
  '兌': ['兌為澤', '澤水困', '澤地萃', '澤山咸', '水山蹇', '地山謙', '雷山小過', '雷澤歸妹']
};

// 標準卦名映射表，確保與 hexagrams.json 鍵一致
const hexagramNameMap = {
  '1,1': '乾為天', '1,2': '天澤履', '1,3': '天火同人', '1,4': '天雷無妄', '1,5': '天風姤', '1,6': '天水訟', '1,7': '天山遁', '1,8': '天地否',
  '2,1': '澤天夬', '2,2': '兌為澤', '2,3': '澤火革', '2,4': '澤雷隨', '2,5': '澤風大過', '2,6': '澤水困', '2,7': '澤山咸', '2,8': '澤地萃',
  '3,1': '火天大有', '3,2': '火澤睽', '3,3': '離為火', '3,4': '火雷噬嗑', '3,5': '火風鼎', '3,6': '火水未濟', '3,7': '火山旅', '3,8': '火地晉',
  '4,1': '雷天大壯', '4,2': '雷澤歸妹', '4,3': '雷火豐', '4,4': '震為雷', '4,5': '雷風恆', '4,6': '雷水解', '4,7': '雷山小過', '4,8': '雷地豫',
  '5,1': '風天小畜', '5,2': '風澤中孚', '5,3': '風火家人', '5,4': '風雷益', '5,5': '巽為風', '5,6': '風水渙', '5,7': '風山漸', '5,8': '風地觀',
  '6,1': '水天需', '6,2': '水澤節', '6,3': '水火既濟', '6,4': '水雷屯', '6,5': '水風井', '6,6': '坎為水', '6,7': '水山蹇', '6,8': '水地比',
  '7,1': '山天大畜', '7,2': '山澤損', '7,3': '山火賁', '7,4': '山雷頤', '7,5': '山風蠱', '7,6': '山水蒙', '7,7': '艮為山', '7,8': '山地剝',
  '8,1': '地天泰', '8,2': '地澤臨', '8,3': '地火明夷', '8,4': '地雷復', '8,5': '地風升', '8,6': '地水師', '8,7': '地山謙', '8,8': '坤為地'
};

// 載入 JSON 檔案
let hexagrams = {};
let wuxingExplanations = {};
let trigramExplanations = {};
let quotes = [];
let currentResult = null;

// 正規化鍵名（去除空格、轉換編碼）
function normalizeKey(key) {
  return key.replace(/\s+/g, '').trim();
}

// 獲取卦象資訊
function getTrigramInfo(id) {
  return {
    name: trigramName[id] || '未知',
    wuxing: { 1: '金', 2: '金', 3: '火', 4: '木', 5: '木', 6: '水', 7: '土', 8: '土' }[id] || '未知',
    explanations: trigramExplanations[trigramName[id]] || {}
  };
}

// 獲取爻辭
function getLineEntryFor(hexagram, lineIndex) {
  return hexagram?.lines?.find(line => line.index === lineIndex) || {};
}

// 根據上卦和下卦查找卦名
function getHexagramName(upperIdx, lowerIdx) {
  const key = `${upperIdx},${lowerIdx}`;
  const hexName = hexagramNameMap[key] || '未知';
  return normalizeKey(hexName);
}

// 異步載入所有 JSON 檔案
async function loadResources() {
  try {
    const [hexResponse, wuxingResponse, trigramResponse, quotesResponse] = await Promise.all([
      fetch('hexagrams.json'),
      fetch('wuxing_explanations.json'),
      fetch('trigram_explanations.json'),
      fetch('quotes.json')
    ]);
    if (!hexResponse.ok || !wuxingResponse.ok || !trigramResponse.ok || !quotesResponse.ok) {
      throw new Error(`檔案載入失敗，狀態碼：hex=${hexResponse.status}, wuxing=${wuxingResponse.status}, trigram=${trigramResponse.status}, quotes=${quotesResponse.status}`);
    }
    hexagrams = await hexResponse.json();
    wuxingExplanations = await wuxingResponse.json();
    trigramExplanations = await trigramResponse.json();
    quotes = await quotesResponse.json();
    // 正規化 hexagrams 的鍵名
    hexagrams = Object.fromEntries(
      Object.entries(hexagrams).map(([key, value]) => [normalizeKey(key), value])
    );
    console.log('JSON 檔案載入成功', { hexagramsKeys: Object.keys(hexagrams), quotesLength: quotes.length });
    const randomQuote = quotes[Math.floor(Math.random() * quotes.length)] || '請選擇取卦方式以開始占卜';
    document.getElementById('subtitle').textContent = randomQuote;
  } catch (error) {
    console.error('載入 JSON 檔案失敗:', error);
    alert('無法載入卦象資料或名言，請檢查檔案路徑或格式！');
    document.getElementById('subtitle').textContent = '資料載入失敗，請檢查網路或檔案';
  }
}

// 繪製卦象
function renderGuaImage(lines, elementId, moving = []) {
  const element = document.getElementById(elementId);
  element.innerHTML = '';
  for (let i = 5; i >= 0; i--) {
    const isMoving = moving.includes(i + 1);
    const lineClass = isMoving ? `gua-moving ${lines[i] ? 'yang' : 'yin'}` : lines[i] ? 'gua-yang' : 'gua-yin';
    element.innerHTML += `<div class="${lineClass}">${isMoving && !lines[i] ? '<span>◎</span>' : ''}</div>`;
  }
}

// 顯示動爻解釋（包含爻辭和評分）
function renderLineExplanation(moving, hexMain) {
  const lineTextDisplay = document.getElementById('lineTextDisplay');
  lineTextDisplay.innerHTML = '';
  if (moving.length === 0) {
    lineTextDisplay.parentElement.classList.add('hidden');
    return;
  }
  lineTextDisplay.parentElement.classList.remove('hidden');
  moving.forEach(mv => {
    const yaoEntry = getLineEntryFor(hexMain, mv);
    const scorePercent = Math.max(0, Math.min(10, yaoEntry.score || 0)) / 10 * 100;
    lineTextDisplay.innerHTML += `
      <div>
        <strong>第 ${mv} 爻：</strong> ${yaoEntry.text || '無爻辭'}<br>
        <span class="hint">${yaoEntry.meaning || '無解釋'}</span><br>
        <strong>評分：</strong>
        <div class="score-card">
          <div class="score-bar-wrap">
            <div class="score-bar" style="width:${scorePercent}%;"></div>
          </div>
          <div class="score-val">${yaoEntry.score || 0}/10</div>
        </div>
      </div>`;
  });
}

// 生成卦象
function generateGua(upperIdx, lowerIdx, moving) {
  const upperLines = guaTable[upperIdx].slice(0, 3);
  const lowerLines = guaTable[lowerIdx].slice(0, 3);
  const lines = [...lowerLines, ...upperLines];
  console.log('本卦線:', lines, '上卦:', upperLines, '下卦:', lowerLines);

  const changeLines = [...lines];
  moving.forEach(idx => {
    changeLines[idx - 1] = changeLines[idx - 1] === 1 ? 0 : 1;
  });
  console.log('變卦線:', changeLines, '動爻:', moving);

  const huLines = [lines[1], lines[2], lines[3], lines[2], lines[3], lines[4]];
  console.log('互卦線:', huLines);

  const mainHexName = getHexagramName(upperIdx, lowerIdx);
  const changeUpperIdx = triIndexByLines.get(JSON.stringify(changeLines.slice(3, 6))) || 8;
  const changeLowerIdx = triIndexByLines.get(JSON.stringify(changeLines.slice(0, 3))) || 8;
  const changeHexName = getHexagramName(changeUpperIdx, changeLowerIdx);
  const huUpperIdx = triIndexByLines.get(JSON.stringify(huLines.slice(3, 6))) || 8;
  const huLowerIdx = triIndexByLines.get(JSON.stringify(huLines.slice(0, 3))) || 8;
  const huHexName = getHexagramName(huUpperIdx, huLowerIdx);

  console.log('卦名:', { main: mainHexName, change: changeHexName, hu: huHexName });

  const mainHex = hexagrams[mainHexName] || { name: mainHexName, judgment: {}, symbolism: {}, lines: [] };
  const changeHex = hexagrams[changeHexName] || { name: changeHexName, judgment: {}, symbolism: {} };
  const huHex = hexagrams[huHexName] || { name: huHexName, judgment: {}, symbolism: {} };

  if (!hexagrams[mainHexName]) console.warn(`本卦 ${mainHexName} 在 hexagrams.json 中未找到`);
  if (!hexagrams[changeHexName]) console.warn(`變卦 ${changeHexName} 在 hexagrams.json 中未找到`);

  currentResult = {
    lines,
    changeLines,
    huLines,
    moving,
    hexMain: mainHex,
    hexChange: changeHex,
    hexHu: huHex,
    uIdx: upperIdx,
    lIdx: lowerIdx,
    timestamp: new Date().toISOString().slice(0, 16).replace('T', ' ')
  };
  
  document.getElementById('result').classList.remove('hidden');
  document.getElementById('guaName').textContent = mainHex.name || mainHexName || '未知';
  document.getElementById('changeGuaName').textContent = changeHex.name || changeHexName || '未知';
  document.getElementById('huGuaName').textContent = huHex.name || huHexName || '未知';
  document.getElementById('guaNote').textContent = `本卦：${trigramName[lowerIdx]}為下，${trigramName[upperIdx]}為上，動爻：${moving.join('、') || '無'}`;
  renderGuaImage(lines, 'guaImage', moving);
  renderGuaImage(changeLines, 'changeGuaImage', moving);
  renderGuaImage(huLines, 'huGuaImage');
  renderLineExplanation(moving, mainHex);
}

// 初始化應用程式
document.addEventListener('DOMContentLoaded', async () => {
  await loadResources();

  // Tab 切換
  document.querySelectorAll('.tab-button').forEach(button => {
    button.addEventListener('click', () => {
      document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      button.classList.add('active');
      document.getElementById(button.dataset.target).classList.add('active');
    });
  });

  // 數字取卦
  document.getElementById('btnNumber').addEventListener('click', () => {
    const numUpper = parseInt(document.getElementById('numUpper').value);
    const numLower = parseInt(document.getElementById('numLower').value);
    const numMoving = parseInt(document.getElementById('numMoving').value);
    
    if (isNaN(numUpper) || isNaN(numLower) || isNaN(numMoving) || numUpper < 100 || numUpper > 999 || numLower < 100 || numLower > 999 || numMoving < 100 || numMoving > 999) {
      alert('請輸入 100–999 的有效數字！');
      return;
    }
    
    const upperIdx = numUpper % 8 || 8;
    const lowerIdx = numLower % 8 || 8;
    const moving = [numMoving % 6 || 6];
    generateGua(upperIdx, lowerIdx, moving);
  });

  // 手動取卦
  document.getElementById('btnManual').addEventListener('click', () => {
    const upperIdx = parseInt(document.getElementById('selUpper').value);
    const lowerIdx = parseInt(document.getElementById('selLower').value);
    const movingInput = document.getElementById('inputMoving').value.trim();
    
    if (!upperIdx || !lowerIdx || !movingInput) {
      alert('請輸入完整的卦象資訊！');
      return;
    }
    
    const moving = movingInput.split(',').map(Number).filter(n => n >= 1 && n <= 6);
    if (moving.length === 0 || moving.some(n => isNaN(n))) {
      alert('動爻格式錯誤，請輸入 1–6 的數字，例如 "1" 或 "1,3"');
      return;
    }
    
    generateGua(upperIdx, lowerIdx, moving);
  });

  // 時間取卦
  document.getElementById('btnTime').addEventListener('click', () => {
    const method = document.querySelector('input[name="time-method"]:checked').value;
    let year, month, day, hour, minute;
    
    if (method === 'modern') {
      const dt = new Date(document.getElementById('dtInput').value);
      if (isNaN(dt)) {
        alert('請選擇有效的日期時間！');
        return;
      }
      year = dt.getFullYear();
      month = dt.getMonth() + 1;
      day = dt.getDate();
      hour = dt.getHours();
      minute = dt.getMinutes();
    } else {
      const date = new Date(document.getElementById('dateInput').value);
      const shichen = parseInt(document.getElementById('shichenInput').value);
      minute = parseInt(document.getElementById('minuteInput').value);
      if (isNaN(date) || isNaN(shichen) || isNaN(minute) || minute < 0 || minute > 59) {
        alert('請輸入有效的日期、時辰或分鐘！');
        return;
      }
      year = date.getFullYear();
      month = date.getMonth() + 1;
      day = date.getDate();
      hour = shichen * 2 - 1;
    }
    
    const upperIdx = (year + month + day) % 8 || 8;
    const lowerIdx = (year + month + day + hour) % 8 || 8;
    const moving = [(year + month + day + hour + minute) % 6 || 6];
    generateGua(upperIdx, lowerIdx, moving);
  });

  // 使用現在時間
  document.getElementById('nowQuick').addEventListener('click', () => {
    const now = new Date();
    document.getElementById('dtInput').value = now.toISOString().slice(0, 16);
  });

  // 以象取卦
  document.getElementById('btnImage').addEventListener('click', () => {
    const upperIdx = parseInt(document.getElementById('upperImageSelect').value);
    const lowerIdx = parseInt(document.getElementById('lowerDirectionSelect').value);
    let moving = [];
    
    if (document.getElementById('imageUseMinute').checked) {
      moving = [(new Date().getMinutes() % 6) || 6];
    } else {
      const movingInput = parseInt(document.getElementById('imageMovingInput').value);
      if (isNaN(movingInput) || movingInput < 1 || movingInput > 6) {
        alert('請輸入 1–6 的有效動爻，或勾選使用當前分鐘！');
        return;
      }
      moving = [movingInput];
    }
    
    generateGua(upperIdx, lowerIdx, moving);
  });

  // 時間方式切換
  document.querySelectorAll('input[name="time-method"]').forEach(radio => {
    radio.addEventListener('change', () => {
      document.getElementById('time-modern').classList.toggle('hidden', radio.value !== 'modern');
      document.getElementById('time-traditional').classList.toggle('hidden', radio.value !== 'traditional');
    });
  });

  // 隨機預設數字
  document.getElementById('numUpper').value = Math.floor(Math.random() * 900) + 100;
  document.getElementById('numLower').value = Math.floor(Math.random() * 900) + 100;
  document.getElementById('numMoving').value = Math.floor(Math.random() * 900) + 100;

  // 記錄功能
  document.getElementById('recordBtn').addEventListener('click', () => {
    if (!currentResult) {
      alert('請先生成卦象！');
      return;
    }
    const recordText = `日期時間: ${currentResult.timestamp}\n本卦: ${currentResult.hexMain.name || getHexagramName(currentResult.uIdx, currentResult.lIdx)}\n變卦: ${currentResult.hexChange.name || getHexagramName(triIndexByLines.get(JSON.stringify(currentResult.changeLines.slice(3, 6))), triIndexByLines.get(JSON.stringify(currentResult.changeLines.slice(0, 3)))}\n動爻: ${currentResult.moving.join('、') || '無'}`;
    document.getElementById('recordText').value = recordText;
    document.getElementById('recordModal').style.display = 'flex';
    
    // 儲存到 localStorage
    const records = JSON.parse(localStorage.getItem('hexagramRecords') || '[]');
    records.push({ timestamp: currentResult.timestamp, text: recordText });
    localStorage.setItem('hexagramRecords', JSON.stringify(records));
    renderHistory();
  });

  // 複製記錄
  document.getElementById('copyRecordBtn').addEventListener('click', () => {
    const recordText = document.getElementById('recordText').value;
    navigator.clipboard.writeText(recordText).then(() => {
      alert('記錄已複製到剪貼簿！');
    }).catch(err => {
      console.error('複製失敗:', err);
      alert('複製失敗，請手動選取並複製！');
    });
  });

  // 關閉記錄視窗
  document.getElementById('closeRecordBtn').addEventListener('click', () => {
    document.getElementById('recordModal').style.display = 'none';
  });

  // 顯示歷史記錄
  document.getElementById('historyBtn').addEventListener('click', () => {
    document.getElementById('recordModal').style.display = 'flex';
    document.getElementById('recordText').value = currentResult ? `日期時間: ${currentResult.timestamp}\n本卦: ${currentResult.hexMain.name || getHexagramName(currentResult.uIdx, currentResult.lIdx)}\n變卦: ${currentResult.hexChange.name || getHexagramName(triIndexByLines.get(JSON.stringify(currentResult.changeLines.slice(3, 6))), triIndexByLines.get(JSON.stringify(currentResult.changeLines.slice(0, 3)))}\n動爻: ${currentResult.moving.join('、') || '無'}` : '請先生成卦象！';
    renderHistory();
  });

  // 渲染歷史記錄
  function renderHistory() {
    const historyList = document.getElementById('historyList');
    historyList.innerHTML = '';
    const records = JSON.parse(localStorage.getItem('hexagramRecords') || '[]');
    records.forEach((record, index) => {
      const historyItem = document.createElement('div');
      historyItem.className = 'history-item';
      historyItem.textContent = `${record.timestamp}: 本卦 ${record.text.split('\n')[1].split(': ')[1]}, 變卦 ${record.text.split('\n')[2].split(': ')[1]}`;
      historyItem.addEventListener('click', () => {
        document.getElementById('recordText').value = record.text;
      });
      historyList.appendChild(historyItem);
    });
  }
});

// 輔助函數：根據五行關係判斷吉凶
function getWuxingOutcome(tiGua, yongGua, mainHexName, changeHexName) {
  if (!tiGua || !yongGua) return { relation: '未知', status: '平', explanation: '五行資料不完整。', subkey: '', details: {} };

  const relations = {
    '金': { '生': '水', '剋': '木', '被生': '土', '被剋': '火', '比和': '金' },
    '木': { '生': '火', '剋': '土', '被生': '水', '被剋': '金', '比和': '木' },
    '水': { '生': '木', '剋': '火', '被生': '金', '被剋': '土', '比和': '水' },
    '火': { '生': '土', '剋': '金', '被生': '木', '被剋': '水', '比和': '火' },
    '土': { '生': '金', '剋': '水', '被生': '火', '被剋': '木', '比和': '土' }
  };

  let palace = null;
  for (const [palaceName, guaList] of Object.entries(palaceMap)) {
    if (guaList.includes(mainHexName) && guaList.includes(changeHexName)) {
      palace = palaceName;
      break;
    }
  }

  if (palace) {
    const subkey = `${palace}卦同宮`;
    const details = wuxingExplanations['體用同宮']?.details?.[subkey] || {};
    const explanation = details.description || wuxingExplanations['體用同宮']?.overall || '同宮卦象，無詳細解釋。';
    return { relation: '體用同宮', status: '平', explanation, subkey, details };
  }

  let relationType, status, subkey;
  if (relations[yongGua.wuxing]['生'] === tiGua.wuxing) {
    relationType = '用生體';
    status = '大吉';
    subkey = `${yongGua.name}卦生體`;
  } else if (relations[tiGua.wuxing]['剋'] === yongGua.wuxing) {
    relationType = '體剋用';
    status = '吉';
    subkey = `${tiGua.name}卦剋用`;
  } else if (tiGua.wuxing === yongGua.wuxing) {
    relationType = '比和';
    status = '平';
    subkey = `${tiGua.name}卦比和`;
  } else if (relations[tiGua.wuxing]['生'] === yongGua.wuxing) {
    relationType = '體生用';
    status = '凶';
    subkey = `${tiGua.name}卦生用`;
  } else if (relations[yongGua.wuxing]['剋'] === tiGua.wuxing) {
    relationType = '用剋體';
    status = '大凶';
    subkey = `${yongGua.name}卦剋體`;
  } else {
    relationType = '未知';
    status = '平';
    subkey = '';
  }

  const details = wuxingExplanations[relationType]?.details?.[subkey] || {};
  const explanation = details.description || wuxingExplanations[relationType]?.overall || '（此類別無詳細解釋）';
  return { relation: relationType, status, explanation, subkey, details };
}

// 修改 getTiYong 函數：體卦為本卦下卦，用卦為變卦上卦
function getTiYong(result) {
  const mainUpperId = triIndexByLines.get(JSON.stringify(result.lines.slice(3, 6)));
  const mainLowerId = triIndexByLines.get(JSON.stringify(result.lines.slice(0, 3)));
  const changeUpperId = triIndexByLines.get(JSON.stringify(result.changeLines.slice(3, 6)));
  const changeLowerId = triIndexByLines.get(JSON.stringify(result.changeLines.slice(0, 3)));

  const tiGua = getTrigramInfo(mainLowerId);
  const yongGua = getTrigramInfo(changeUpperId);
  return { tiGua, yongGua };
}

// 渲染五行分析
function renderWuxingAnalysis(result) {
  const analysisDiv = document.getElementById('wuxingAnalysis');
  const contentDiv = document.getElementById('wuxingContent');
  contentDiv.innerHTML = '';
  analysisDiv.classList.remove('hidden');

  const { tiGua, yongGua } = getTiYong(result);
  const mainOutcome = getWuxingOutcome(tiGua, yongGua, result.hexMain?.name, result.hexChange?.name);
  const mainDesc = `**體卦**（本卦，代表您）為 **${tiGua.name}** 屬 **${tiGua.wuxing}**，**用卦**（變卦，代表趨勢）為 **${yongGua.name}** 屬 **${yongGua.wuxing}**。`;
  contentDiv.innerHTML += `
    <div class="wuxing-box">
      <strong>本卦五行關係：</strong> <span class="wuxing-status ${mainOutcome.status}">${mainOutcome.relation}</span>
      <div class="wuxing-desc">${mainDesc}<br>${mainOutcome.explanation}${mainOutcome.details.title ? `<br><strong>相關卦象：</strong> ${mainOutcome.details.title}` : ''}</div>
    </div>`;

  const huLines = result.huLines;
  const huLowerId = triIndexByLines.get(JSON.stringify(huLines.slice(0, 3)));
  const huUpperId = triIndexByLines.get(JSON.stringify(huLines.slice(3, 6)));
  const huLGua = getTrigramInfo(huLowerId);
  const huOutcome = getWuxingOutcome(tiGua, huLGua, result.hexMain?.name, result.hexHu?.name);
  let guaAnalysisHtml = `
    <div class="analysis-item">
      <h4>互卦（過程分析）</h4>
      <p>體卦屬 **${tiGua.wuxing}**，互卦（代表過程）屬 **${huLGua.wuxing}**。<br>五行關係為：**${huOutcome.relation}**。這顯示事情在過程中將會：<br><span class="analysis-status ${huOutcome.status}">${huOutcome.explanation}${huOutcome.details.title ? `<br><strong>相關卦象：</strong> ${huOutcome.details.title}` : ''}</span></p>`;
  if (trigramExplanations[huLGua.name] || trigramExplanations[trigramName[huUpperId]]) {
    guaAnalysisHtml += `<div class="trigram-details"><strong>互卦取象：</strong><br>`;
    if (trigramExplanations[huLGua.name]?.life) {
      guaAnalysisHtml += `**下互卦**（${huLGua.name}）：${trigramExplanations[huLGua.name].life}<br>`;
    }
    if (trigramExplanations[trigramName[huUpperId]]?.life) {
      guaAnalysisHtml += `**上互卦**（${trigramName[huUpperId]}）：${trigramExplanations[trigramName[huUpperId]].life}`;
    }
    guaAnalysisHtml += `</div>`;
  }
  guaAnalysisHtml += `</div>`;
  contentDiv.innerHTML += guaAnalysisHtml;

  const changeLines = result.changeLines;
  const changeUpperId = triIndexByLines.get(JSON.stringify(changeLines.slice(3, 6)));
  const changeUGua = getTrigramInfo(changeUpperId);
  const changeOutcome = getWuxingOutcome(tiGua, changeUGua, result.hexMain?.name, result.hexChange?.name);
  guaAnalysisHtml = `
    <div class="analysis-item">
      <h4>變卦（結果分析）</h4>
      <p>體卦屬 **${tiGua.wuxing}**，變卦（代表結果）屬 **${changeUGua.wuxing}**。<br>五行關係為：**${changeOutcome.relation}**。這代表最終的結果將會是：<br><span class="analysis-status ${changeOutcome.status}">${changeOutcome.explanation}${changeOutcome.details.title ? `<br><strong>相關卦象：</strong> ${changeOutcome.details.title}` : ''}</span></p>`;
  if (trigramExplanations[changeUGua.name]?.life) {
    guaAnalysisHtml += `<div class="trigram-details"><strong>變卦取象：</strong><br>`;
    guaAnalysisHtml += `**上變卦**（${changeUGua.name}）：${trigramExplanations[changeUGua.name].life}`;
    guaAnalysisHtml += `</div>`;
  }
  guaAnalysisHtml += `</div>`;
  contentDiv.innerHTML += guaAnalysisHtml;
}

// 渲染問題分析（針對特定問事類別）
function renderQuestionAnalysis(result, questionType) {
  const analysisDiv = document.getElementById('questionAnalysisResult');
  analysisDiv.innerHTML = '';
  analysisDiv.classList.remove('hidden');

  const analysisMap = {
    'love': '感情問題', 'career': '工作/學業', 'wealth': '財運問題', 'health': '健康問題',
    'relationship': '人際關係', 'life': '生活/運勢', 'guidance': '尋找指引'
  };
  
  const questionTitle = analysisMap[questionType];
  if (!questionTitle) {
    analysisDiv.classList.add('hidden');
    return;
  }
  
  if (result.moving.length !== 1) {
    analysisDiv.innerHTML = `<div class="analysis-message">此「主題分析」功能主要針對單一動爻，多爻變請參考動爻爻辭與變卦象徵分析。</div>`;
    return;
  }
  
  const { tiGua, yongGua } = getTiYong(result);
  if (!tiGua || !yongGua) {
    analysisDiv.innerHTML = `<div class="analysis-item"><h4>${questionTitle}：總體解讀</h4><p>無法判斷體用關係，請檢查卦象資料。</p></div>`;
    return;
  }

  let judgmentText = result.hexMain?.judgment?.overall || '（卦辭未提供詳細判斷）';
  const yaoCi = getLineEntryFor(result.hexMain, result.moving[0]);
  analysisDiv.innerHTML += `
    <div class="analysis-item">
      <h4>${questionTitle}：總體解讀</h4>
      <p>卦辭：${judgmentText} (評分: ${result.hexMain?.judgment?.overall || 0}/10)</p>
      <p>動爻爻辭：${(yaoCi?.text || '無')} (評分: ${yaoCi?.score || 0}/10)</p>
    </div>`;

  const mainOutcome = getWuxingOutcome(tiGua, yongGua, result.hexMain?.name, result.hexChange?.name);
  const mainExplanation = mainOutcome.details[questionType] || mainOutcome.explanation || '（此類別無詳細解釋）';
  let guaAnalysisHtml = `
    <div class="analysis-item">
      <h4>第一層：本卦（現況分析）</h4>
      <p>您的問事面向為 **${questionTitle}**。<br>體卦（本卦）為 **${tiGua.name}** 屬 **${tiGua.wuxing}**，用卦（變卦）為 **${yongGua.name}** 屬 **${yongGua.wuxing}**。<br>五行關係為：**${mainOutcome.relation}**。此卦象代表：<br><span class="analysis-status ${mainOutcome.status}">${mainExplanation}${mainOutcome.details.title ? `<br><strong>相關卦象：</strong> ${mainOutcome.details.title}` : ''}</span></p>`;
  if (trigramExplanations[tiGua.name]?.[questionType] || trigramExplanations[yongGua.name]?.[questionType]) {
    guaAnalysisHtml += `<div class="trigram-details"><strong>本卦取象：</strong><br>`;
    if (trigramExplanations[tiGua.name]?.[questionType]) {
      guaAnalysisHtml += `**體卦**（${tiGua.name}）：${trigramExplanations[tiGua.name][questionType]}<br>`;
    }
    if (trigramExplanations[yongGua.name]?.[questionType]) {
      guaAnalysisHtml += `**用卦**（${yongGua.name}）：${trigramExplanations[yongGua.name][questionType]}`;
    }
    guaAnalysisHtml += `</div>`;
  }
  guaAnalysisHtml += `</div>`;
  analysisDiv.innerHTML += guaAnalysisHtml;

  const huLines = result.huLines;
  const huLowerId = triIndexByLines.get(JSON.stringify(huLines.slice(0, 3)));
  const huUpperId = triIndexByLines.get(JSON.stringify(huLines.slice(3, 6)));
  const huLGua = getTrigramInfo(huLowerId);
  const huOutcome = getWuxingOutcome(tiGua, huLGua, result.hexMain?.name, result.hexHu?.name);
  const huExplanation = huOutcome.details[questionType] || huOutcome.explanation || '（此類別無詳細解釋）';
  guaAnalysisHtml = `
    <div class="analysis-item">
      <h4>第二層：互卦（過程分析）</h4>
      <p>體卦屬 **${tiGua.wuxing}**，互卦（代表過程）屬 **${huLGua.wuxing}**。<br>五行關係為：**${huOutcome.relation}**。這顯示事情在過程中將會：<br><span class="analysis-status ${huOutcome.status}">${huOutcome.explanation}${huOutcome.details.title ? `<br><strong>相關卦象：</strong> ${huOutcome.details.title}` : ''}</span></p>`;
  if (trigramExplanations[huLGua.name]?.[questionType] || trigramExplanations[trigramName[huUpperId]]?.[questionType]) {
    guaAnalysisHtml += `<div class="trigram-details"><strong>互卦取象：</strong><br>`;
    if (trigramExplanations[huLGua.name]?.[questionType]) {
      guaAnalysisHtml += `**下互卦**（${huLGua.name}）：${trigramExplanations[huLGua.name][questionType]}<br>`;
    }
    if (trigramExplanations[trigramName[huUpperId]]?.[questionType]) {
      guaAnalysisHtml += `**上互卦**（${trigramName[huUpperId]}）：${trigramExplanations[trigramName[huUpperId]][questionType]}`;
    }
    guaAnalysisHtml += `</div>`;
  }
  guaAnalysisHtml += `</div>`;
  analysisDiv.innerHTML += guaAnalysisHtml;

  const changeLines = result.changeLines;
  const changeUpperId = triIndexByLines.get(JSON.stringify(changeLines.slice(3, 6)));
  const changeUGua = getTrigramInfo(changeUpperId);
  const changeOutcome = getWuxingOutcome(tiGua, changeUGua, result.hexMain?.name, result.hexChange?.name);
  const changeExplanation = changeOutcome.details[questionType] || changeOutcome.explanation || '（無詳細解釋）';
  guaAnalysisHtml = `
    <div class="analysis-item">
      <h4>第三層：變卦（結果分析）</h4>
      <p>體卦屬 **${tiGua.wuxing}**，變卦（代表結果）屬 **${changeUGua.wuxing}**。<br>五行關係為：**${changeOutcome.relation}**。這代表最終的結果將會是：<br><span class="analysis-status ${changeOutcome.status}">${changeExplanation}${changeOutcome.details.title ? `<br><strong>相關卦象：</strong> ${changeOutcome.details.title}` : ''}</span></p>`;
  if (trigramExplanations[changeUGua.name]?.[questionType]) {
    guaAnalysisHtml += `<div class="trigram-details"><strong>變卦取象：</strong><br>`;
    guaAnalysisHtml += `**上變卦**（${changeUGua.name}）：${trigramExplanations[changeUGua.name][questionType]}`;
    guaAnalysisHtml += `</div>`;
  }
  guaAnalysisHtml += `</div>`;
  analysisDiv.innerHTML += guaAnalysisHtml;

  const suggestion = mainOutcome.details.guidance || '（無針對性建議）';
  if (suggestion) {
    analysisDiv.innerHTML += `
      <div class="analysis-item suggestion">
        <h5>◎ 針對性建議</h5>
        <p>${suggestion}</p>
      </div>`;
  }
}

// 渲染詳細象徵分析（僅單爻）
function renderDetailedAnalysis(result) {
  const detailedDiv = document.getElementById('detailedAnalysis');
  const contentDiv = document.getElementById('detailedContent');
  contentDiv.innerHTML = '';
  detailedDiv.classList.remove('hidden');

  if (result.moving.length !== 1) {
    contentDiv.innerHTML = '<div class="analysis-message">此「詳細象徵分析」功能僅適用於單一動爻。若為多爻變，請參考動爻與變卦分析。</div>';
    return;
  }

  const categories = ['overall', 'people', 'affairs', 'time', 'place', 'object'];
  const categoryLabels = {
    'overall': '總體', 'people': '人', 'affairs': '事', 'time': '時', 'place': '地', 'object': '物'
  };
  
  function renderScoreBar(label, score) {
    const scorePercent = Math.max(0, Math.min(10, score)) / 10 * 100;
    return `
      <div class="score-card">
        <div class="score-label">${label}</div>
        <div class="score-bar-wrap">
          <div class="score-bar" style="width:${scorePercent}%;"></div>
        </div>
        <div class="score-val">${score}/10</div>
      </div>`;
  }
  
  function renderSymbolismList(symbolism) {
    if (!symbolism || Object.keys(symbolism).length === 0) return '';
    let html = '<div class="symbolism-section"><h6>象徵意義</h6><ul>';
    categories.forEach(cat => {
      if (symbolism[cat]) {
        html += `<li><strong>${categoryLabels[cat]}：</strong>${symbolism[cat]}</li>`;
      }
    });
    html += '</ul></div>';
    return html;
  }

  // 本卦評分與象徵
  const mainJudgment = result.hexMain?.judgment || {};
  const mainSymbolism = result.hexMain?.symbolism || {};
  let mainHtml = `<h5>本卦（現況分析）</h5><div class="score-container">`;
  categories.forEach(cat => {
    if (mainJudgment[cat] !== undefined) {
      mainHtml += renderScoreBar(categoryLabels[cat], mainJudgment[cat]);
    }
  });
  mainHtml += `</div>${renderSymbolismList(mainSymbolism)}`;
  contentDiv.innerHTML += `<div class="detailed-section">${mainHtml}</div>`;

  // 變卦評分與象徵
  const changeJudgment = result.hexChange?.judgment || {};
  const changeSymbolism = result.hexChange?.symbolism || {};
  let changeHtml = `<h5>變卦（結果分析）</h5><div class="score-container">`;
  categories.forEach(cat => {
    if (changeJudgment[cat] !== undefined) {
      changeHtml += renderScoreBar(categoryLabels[cat], changeJudgment[cat]);
    }
  });
  changeHtml += `</div>${renderSymbolismList(changeSymbolism)}`;
  contentDiv.innerHTML += `<div class="detailed-section">${changeHtml}</div>`;
  
  // 動爻象徵意義
  const movingYao = result.moving[0];
  const yaoEntry = result.hexMain?.lines.find(line => line.index === movingYao);
  const yaoSymbolism = yaoEntry?.symbolism || {};
  if (Object.keys(yaoSymbolism).length > 0) {
    let yaoHtml = `<h5>動爻：第 ${movingYao} 爻象徵意義</h5>`;
    yaoHtml += renderScoreBar('爻辭評分', yaoEntry?.score || 0);
    yaoHtml += renderSymbolismList(yaoSymbolism);
    contentDiv.innerHTML += `<div class="detailed-section">${yaoHtml}</div>`;
  }
  
  // 卦象取象
  let trigramHtml = `<h5>卦象取象</h5>`;
  const uGua = getTrigramInfo(triIndexByLines.get(JSON.stringify(result.lines.slice(3, 6))));
  const lGua = getTrigramInfo(triIndexByLines.get(JSON.stringify(result.lines.slice(0, 3))));
  const cUgua = getTrigramInfo(triIndexByLines.get(JSON.stringify(result.changeLines.slice(3, 6))));
  const cLgua = getTrigramInfo(triIndexByLines.get(JSON.stringify(result.changeLines.slice(0, 3))));

  trigramHtml += `<div class="trigram-details"><strong>本卦取象：</strong><br>`;
  trigramHtml += `**上卦**（${uGua.name}）：${uGua.explanations?.life || '無'}<br>`;
  trigramHtml += `**下卦**（${lGua.name}）：${lGua.explanations?.life || '無'}`;
  trigramHtml += `</div>`;
  
  trigramHtml += `<div class="trigram-details" style="margin-top:10px;"><strong>變卦取象：</strong><br>`;
  trigramHtml += `**上變卦**（${cUgua.name}）：${cUgua.explanations?.life || '無'}<br>`;
  trigramHtml += `**下變卦**（${cLgua.name}）：${cLgua.explanations?.life || '無'}`;
  trigramHtml += `</div>`;
  
  contentDiv.innerHTML += `<div class="detailed-section">${trigramHtml}</div>`;
}

// 多爻變分析
function renderMultiMovingAnalysis(result) {
  const analysisDiv = document.getElementById('questionAnalysisResult');
  analysisDiv.innerHTML = '';
  analysisDiv.classList.remove('hidden');

  const categories = ['overall', 'people', 'affairs', 'time', 'place', 'object'];
  const categoryLabels = {
    'overall': '總體', 'people': '人', 'affairs': '事', 'time': '時', 'place': '地', 'object': '物'
  };
  
  function renderScoreBar(label, score) {
    const scorePercent = Math.max(0, Math.min(10, score)) / 10 * 100;
    return `
      <div class="score-card">
        <div class="score-label">${label}</div>
        <div class="score-bar-wrap">
          <div class="score-bar" style="width:${scorePercent}%;"></div>
        </div>
        <div class="score-val">${score}/10</div>
      </div>`;
  }
  
  function renderSymbolismList(symbolism) {
    if (!symbolism || Object.keys(symbolism).length === 0) return '';
    let html = '<div class="symbolism-section"><h6>象徵意義</h6><ul>';
    categories.forEach(cat => {
      if (symbolism[cat]) {
        html += `<li><strong>${categoryLabels[cat]}：</strong>${symbolism[cat]}</li>`;
      }
    });
    html += '</ul></div>';
    return html;
  }

  let multiMovingHtml = `
    <div class="analysis-item">
      <h4>多爻變動分析</h4>
      <p>因有多個動爻（${result.moving.join('、')}），以下逐條分析各動爻的意義與五行關係：</p>`;

  result.moving.forEach(mv => {
    const yaoEntry = result.hexMain?.lines.find(line => line.index === mv);
    const yaoText = yaoEntry?.text || '（無爻辭）';
    const yaoMeaning = yaoEntry?.meaning || '（無解釋）';
    const yaoScore = yaoEntry?.score || 0;
    const yaoSymbolism = yaoEntry?.symbolism || {};

    multiMovingHtml += `
      <div class="trigram-details">
        <strong>第 ${mv} 爻：</strong> ${yaoText}<br>
        <strong>解釋：</strong> ${yaoMeaning}<br>
        <strong>評分：</strong> ${renderScoreBar('爻辭評分', yaoScore)}
        ${renderSymbolismList(yaoSymbolism)}
      </div>`;
  });

  const { tiGua, yongGua } = getTiYong(result);
  const mainOutcome = getWuxingOutcome(tiGua, yongGua, result.hexMain?.name, result.hexChange?.name);
  multiMovingHtml += `
    <div class="trigram-details" style="margin-top:15px;">
      <strong>本卦五行關係：</strong> 體卦（本卦，${tiGua.name}，${tiGua.wuxing}）與用卦（變卦，${yongGua.name}，${yongGua.wuxing}）為 <span class="analysis-status ${mainOutcome.status}">${mainOutcome.relation}</span>。<br>
      <strong>解釋：</strong> ${mainOutcome.explanation}${mainOutcome.details.title ? `<br><strong>相關卦象：</strong> ${mainOutcome.details.title}` : ''}
    </div>`;

  const changeLines = result.changeLines;
  const changeUpperId = triIndexByLines.get(JSON.stringify(changeLines.slice(3, 6)));
  const changeUGua = getTrigramInfo(changeUpperId);
  const changeOutcome = getWuxingOutcome(tiGua, changeUGua, result.hexMain?.name, result.hexChange?.name);
  multiMovingHtml += `
    <div class="trigram-details" style="margin-top:15px;">
      <strong>變卦五行關係：</strong> 體卦（本卦，${tiGua.name}，${tiGua.wuxing}）與變卦（${changeUGua.name}，${changeUGua.wuxing}）為 <span class="analysis-status ${changeOutcome.status}">${changeOutcome.relation}</span>。<br>
      <strong>解釋：</strong> ${changeOutcome.explanation}${changeOutcome.details.title ? `<br><strong>相關卦象：</strong> ${changeOutcome.details.title}` : ''}
    </div>`;

  multiMovingHtml += `</div>`;
  analysisDiv.innerHTML += multiMovingHtml;

  const mainJudgment = result.hexMain?.judgment || {};
  const mainSymbolism = result.hexMain?.symbolism || {};
  let mainHtml = `<div class="analysis-item"><h5>本卦總體分析</h5><div class="score-container">`;
  categories.forEach(cat => {
    if (mainJudgment[cat] !== undefined) {
      mainHtml += renderScoreBar(categoryLabels[cat], mainJudgment[cat]);
    }
  });
  mainHtml += `</div>${renderSymbolismList(mainSymbolism)}`;
  analysisDiv.innerHTML += mainHtml;

  const changeJudgment = result.hexChange?.judgment || {};
  const changeSymbolism = result.hexChange?.symbolism || {};
  let changeHtml = `<div class="analysis-item"><h5>變卦總體分析</h5><div class="score-container">`;
  categories.forEach(cat => {
    if (changeJudgment[cat] !== undefined) {
      changeHtml += renderScoreBar(categoryLabels[cat], changeJudgment[cat]);
    }
  });
  changeHtml += `</div>${renderSymbolismList(changeSymbolism)}`;
  analysisDiv.innerHTML += changeHtml;
}

// 綁定：分析按鈕
document.getElementById('analyzeBtn')?.addEventListener('click', () => {
  if (!currentResult) {
    alert('請先生成卦象！');
    return;
  }
  const questionType = document.getElementById('questionSelector')?.value;
  if (questionType === '1') {
    alert('請選擇一個問事類別！');
    return;
  }
  if (!hexagrams || !wuxingExplanations || !trigramExplanations) {
    alert('資料尚未載入，請稍後再試！');
    return;
  }
  if (currentResult.moving.length > 1) {
    renderMultiMovingAnalysis(currentResult);
  } else {
    renderQuestionAnalysis(currentResult, questionType);
  }
});

// 綁定：綜合判斷按鈕
document.getElementById('judgeBtn')?.addEventListener('click', () => {
  if (!currentResult) {
    alert('請先生成卦象！');
    return;
  }
  if (!hexagrams || !wuxingExplanations || !trigramExplanations) {
    alert('資料尚未載入，請稍後再試！');
    return;
  }
  document.getElementById('judgeBox')?.classList.remove('hidden');
  renderWuxingAnalysis(currentResult);
  if (currentResult.moving.length === 1) {
    renderDetailedAnalysis(currentResult);
  } else {
    document.getElementById('detailedAnalysis')?.classList.remove('hidden');
    document.getElementById('detailedContent').innerHTML = '<div class="analysis-message">多爻變不適用詳細象徵分析，請參考動爻與變卦分析。</div>';
  }
});
</script>
</body>
</html>
