<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>梅花心易解卦系統 - 通用版</title>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <style>
        :root {
            --primary-color: #9b59b6;
            --secondary-color: #8e44ad;
            --background-color: #1a1a2e;
            --card-color: #16213e;
            --text-color: #e6e6e6;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --info-color: #3498db;
            --mystic-purple: #6c5ce7;
            --mystic-blue: #0984e3;
            --mystic-dark: #0c2461;
            --mystic-light: #a29bfe;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Microsoft JhengHei', '微軟正黑體', sans-serif;
            line-height: 1.6;
            color: var(--text-color);
            background: linear-gradient(135deg, var(--mystic-dark) 0%, var(--background-color) 100%);
            padding: 20px;
            min-height: 100vh;
            background-attachment: fixed;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background-color: rgba(22, 33, 62, 0.9);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            border: 1px solid var(--mystic-purple);
        }
        
        h1, h2, h3 {
            color: var(--mystic-light);
            text-align: center;
            margin-bottom: 20px;
            text-shadow: 0 0 10px rgba(166, 155, 254, 0.5);
        }
        
        h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        h2 {
            font-size: 1.8em;
            color: var(--mystic-purple);
            margin-bottom: 30px;
        }
        
        .input-section {
            margin-bottom: 30px;
            padding: 25px;
            border: 2px solid var(--mystic-purple);
            border-radius: 12px;
            background: rgba(26, 26, 46, 0.7);
            box-shadow: 0 0 15px rgba(107, 92, 231, 0.3);
        }
        
        .input-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 10px;
            font-weight: bold;
            color: var(--mystic-light);
            font-size: 1.1em;
        }
        
        input[type="number"], textarea, select {
            width: 100%;
            padding: 25px;
            border: 2px solid var(--mystic-purple);
            border-radius: 10px;
            font-size: 20px;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-color);
        }
        
        input[type="number"]:focus, textarea:focus, select:focus {
            border-color: var(--mystic-light);
            outline: none;
            box-shadow: 0 0 0 3px rgba(166, 155, 254, 0.3);
            background: rgba(255, 255, 255, 0.15);
        }
        
        textarea {
            height: 100px;
            resize: vertical;
            line-height: 1.5;
        }
        
        .number-inputs {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }
        
        button {
            background: linear-gradient(135deg, var(--mystic-purple) 0%, var(--mystic-blue) 100%);
            color: white;
            border: none;
            padding: 18px 30px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            width: auto;
            margin-top: 15px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            position: relative;
            overflow: hidden;
        }
        
        button:before {
            content: '';
            position: absolute;
            top: -10px;
            left: -10px;
            right: -10px;
            bottom: -10px;
            background: linear-gradient(45deg, #ff0000, #ff7300, #fffb00, #48ff00, #00ffd5, #002bff, #7a00ff, #ff00c8, #ff0000);
            background-size: 400%;
            z-index: -1;
            filter: blur(15px);
            opacity: 0;
            transition: opacity 0.3s ease;
            animation: glowing 20s linear infinite;
        }
        
        button:hover:before {
            opacity: 0.3;
        }
        
        button:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
        }
        
        button:active {
            transform: translateY(-1px);
        }
        
        @keyframes glowing {
            0% { background-position: 0 0; }
            50% { background-position: 400% 0; }
            100% { background-position: 0 0; }
        }
        
        .random-btn {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            width: auto;
            margin-left: 10px;
            display: inline-block;
        }
        
        .download-btn {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            margin-top: 20px;
            display: none;
        }
        
        .import-export-btn {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
            margin-top: 10px;
        }
        
        .result-section {
            display: none;
            margin-top: 30px;
        }
        
        .time-info {
            background: rgba(26, 26, 46, 0.7);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 25px;
            text-align: center;
            border-left: 5px solid var(--mystic-purple);
            font-size: 1.1em;
            box-shadow: 0 0 10px rgba(107, 92, 231, 0.2);
        }
        
        /* 修正：讓卦象並列 */
        .traditional-gua {
            display: flex;
            justify-content: space-around;
            align-items: flex-start;
            flex-wrap: wrap;
            gap: 20px;
            margin: 30px 0;
        }
        
        .gua-group {
            text-align: center;
            padding: 6px;
            border-radius: 7px;
            background: rgba(26, 26, 46, 0.7);
            box-shadow: 0 4px 5px rgba(0, 0, 0, 0.2);
            border: 1px solid var(--mystic-purple);
            transition: transform 0.3s ease;
           // width: calc(33.33% - 30px); /* 讓三個組件平分空間 */
             width: auto
          //  min-width: 50px;
        }
        
        .gua-group:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(107, 92, 231, 0.3);
        }
        
        .gua-group-title {
            font-weight: bold;
            color: var(--mystic-light);
            margin-bottom: 12px;
            font-size: 1.2em;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--mystic-purple);
        }
        
        .gua-item {
            margin: 12px 0;
            padding: 12px;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
            border: 1px solid rgba(166, 155, 254, 0.3);
        }
        
        .gua-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(107, 92, 231, 0.3);
        }
        
        .gua-full-name {
            font-weight: bold;
            font-size: 1.1em;
            margin: 8px 0;
            color: var(--mystic-light);
            padding: 5px;
            background: rgba(0,0,0,0.2);
            border-radius: 5px;
        }
        
        .shengke-container {
            width: 100%;
         //   width: auto;
            margin: 40px 0;
            padding: 25px;
            background: rgba(26, 26, 46, 0.7);
            border-radius: 15px;
            box-shadow: 0 6px 25px rgba(0,0,0,0.2);
            border: 1px solid var(--mystic-purple);
            position: relative;
            overflow: visible;
        }
        
        .shengke-diagram {
            width: 100%;
         //    width: auto;
            height: 400px;
            position: relative;
            margin: 0 auto;
        }
        
        .gua-node {
            position: absolute;
            width: 5px;
            height: 10px;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            z-index: 20;
            text-align: center;
            border: 3px solid transparent;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
        }
        
        .gua-node:hover {
            transform: scale(1.15);
            z-index: 100;
            box-shadow: 0 8px 25px rgba(0,0,0,0.5), 0 0 15px rgba(166, 155, 254, 0.5);
        }
        
        .gua-node.ti {
            border-color: gold;
            box-shadow: 0 0 0 4px gold, 0 6px 20px rgba(0,0,0,0.3);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 4px gold, 0 6px 20px rgba(0,0,0,0.3); }
            50% { box-shadow: 0 0 0 6px gold, 0 8px 25px rgba(0,0,0,0.4); }
            100% { box-shadow: 0 0 0 4px gold, 0 6px 20px rgba(0,0,0,0.3); }
        }
        
        .gua-symbol {
            font-size: 24px;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .gua-name {
            font-size: 14px;
            line-height: 1.3;
            margin-bottom: 3px;
        }
        
        .gua-status {
            font-size: 14px;
            margin-top: 5px;
            opacity: 0.95;
            font-weight: bold;
            padding: 2px 6px;
            border-radius: 8px;
            background: rgba(0,0,0,0.3);
        }
        
        .shengke-line {
            position: absolute;
            z-index: 10;
            pointer-events: none;
        }
        
        .line-sheng {
            stroke: var(--success-color);
            marker-end: url(#arrowhead-sheng);
        }
        
        .line-ke {
            stroke: var(--danger-color);
            marker-end: url(#arrowhead-ke);
        }
        
        .line-bihe {
            stroke: var(--warning-color);
            stroke-dasharray: 6,6;
        }
        
        .analysis-section {
            margin-top: 40px;
            display: none;
        }
        
        .analysis-card {
            margin-bottom: 25px;
            padding: 25px;
            border-radius: 12px;
            background: rgba(26, 26, 46, 0.7);
            border-left: 5px solid var(--mystic-purple);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }
        
        .analysis-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(107, 92, 231, 0.2);
        }
        
        .analysis-card h3 {
            color: var(--mystic-light);
            margin-bottom: 15px;
            font-size: 1.4em;
            border-bottom: 2px solid rgba(166, 155, 254, 0.3);
            padding-bottom: 10px;
        }
        
        .luck-badge {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 25px;
            color: white;
            font-weight: bold;
            margin-right: 12px;
            margin-bottom: 8px;
            font-size: 0.95em;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        
        .luck-good { 
            background: linear-gradient(135deg, var(--success-color) 0%, #2ecc71 100%);
        }
        .luck-normal { 
            background: linear-gradient(135deg, var(--info-color) 0%, #3498db 100%);
        }
        .luck-warning { 
            background: linear-gradient(135deg, var(--warning-color) 0%, #f39c12 100%);
        }
        .luck-bad { 
            background: linear-gradient(135deg, var(--danger-color) 0%, #e74c3c 100%);
        }
        
        .diagram-title {
            text-align: center;
            margin: 25px 0;
            color: var(--mystic-light);
            font-size: 28px;
            font-weight: bold;
            text-shadow: 0 0 10px rgba(166, 155, 254, 0.5);
        }
        
        .diagram-header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(26, 26, 46, 0.7);
            border-radius: 12px;
            border-left: 5px solid var(--mystic-purple);
            box-shadow: 0 0 10px rgba(107, 92, 231, 0.2);
        }
        
        .diagram-question {
            font-size: 24px;
            font-weight: bold;
            color: var(--mystic-light);
            margin-bottom: 8px;
        }
        
        .diagram-subtitle {
            font-size: 18px;
            color: var(--mystic-purple);
            font-weight: 600;
        }
        
        .method-selector {
            margin-bottom: 20px;
        }
        
        .method-inputs {
            display: none;
            margin-bottom: 20px;
        }
        
        .wangxiang-label {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 0.85em;
            margin-left: 5px;
            color: white;
        }
        
        .wang { background-color: #e74c3c; }
        .xiang { background-color: #f39c12; }
        .xiu { background-color: #3498db; }
        .qiu { background-color: #9b59b6; }
        .si { background-color: #7f8c8d; }
        
        .button-group {
            display: flex;
            gap: 10px;
        }
        
        .import-export-section {
            margin-top: 20px;
            padding: 20px;
            border: 2px solid var(--mystic-purple);
            border-radius: 12px;
            background: rgba(26, 26, 46, 0.7);
            box-shadow: 0 0 15px rgba(107, 92, 231, 0.2);
        }
        
        .import-export-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        @media (max-width: 300px) {
            .container {
                padding: 10px;
            }
            
            .traditional-gua {
                flex-direction: column;
                align-items: center;
            }
            
            .gua-group {
                width: auto;
            }
            
            .number-inputs {
                grid-template-columns: 1fr;
            }
            
            .shengke-diagram {
                width: 100%;
           //     width: auto;
                height: 400px;
            }
        }
        
        @media (max-width: 600px) {
            h1 {
                font-size: 2em;
            }
            
            h2 {
                font-size: 1.5em;
            }
            
            .input-section {
                padding: 20px;
            }
            
            .gua-node {
                width: 120px;
                height: 120px;
            }
            
            .gua-symbol {
                font-size: 30px;
            }
            
            .gua-name {
                font-size: 20px;
            }
            
            .gua-status {
                font-size: 20px;
            }
            
            .button-group {
                flex-direction: column;
            }
            
            .random-btn {
                width: 100%;
                margin-left: 0;
            }
            
            .import-export-buttons {
                flex-direction: column;
            }
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            font-size: 1.2em;
            color: var(--mystic-light);
        }
        
        .stars {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
        }
        
        .star {
            position: absolute;
            background-color: white;
            border-radius: 50%;
            animation: twinkle 5s infinite;
        }
        
        @keyframes twinkle {
            0%, 100% { opacity: 0.2; }
            50% { opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="stars" id="stars"></div>
    
    <div class="container">
        <h1>梅花心易解卦系統</h1>
        <h2>五行生克分析版</h2>
        
        <div class="input-section">
            <div class="input-group">
                <label for="question">問題描述：</label>
                <textarea id="question" placeholder="請輸入您要問的問題...">事業發展如何？</textarea>
            </div>
            
            <!-- 新增JSON檔案上傳區域 -->
            <div class="input-group">
                <label for="explanations-file">解卦資料檔案（JSON）：</label>
                <input type="file" id="explanations-file" accept=".json" style="display: none;">
                <div class="button-group">
                    <button id="load-json-btn">載入解卦資料</button>
                    <span id="json-status" style="margin-left: 10px; color: #f39c12;">尚未載入解卦資料</span>
                </div>
            </div>
            
            <div class="input-group method-selector">
                <label for="method">取卦方式：</label>
                <select id="method">
                    <option value="number">數字取卦</option>
                    <option value="time">時間取卦</option>
                    <option value="character">以字取卦</option>
                </select>
            </div>
            
            <div id="number-method" class="method-inputs">
                <div class="number-inputs">
                    <div class="input-group">
                        <label for="number1">上卦：</label>
                        <input type="number" id="number1" min="100" max="999" value="256">
                    </div>
                    <div class="input-group">
                        <label for="number2">下卦：</label>
                        <input type="number" id="number2" min="100" max="999" value="378">
                    </div>
                    <div class="input-group">
                        <label for="number3">變爻：</label>
                        <input type="number" id="number3" min="100" max="999" value="491">
                    </div>
                </div>
            </div>
            
            <div id="time-method" class="method-inputs" style="display: none;">
                <div class="input-group">
                    <label for="time-input">時間：</label>
                    <input type="datetime-local" id="time-input">
                </div>
            </div>
            
            <div id="character-method" class="method-inputs" style="display: none;">
                <div class="input-group">
                    <label for="character-input">輸入漢字：</label>
                   <H1></H1> <input type="text" id="character-input" placeholder="輸入1-3個漢字"></H1>
                </div>
            </div>
            
            <div class="button-group">
                <button id="calculate-btn">開始解卦</button>
                <button id="random-btn" class="random-btn" style="display: none;">隨機取卦</button>
            </div>
            
            <div class="import-export-section">
                <label>數據管理：</label>
                <div class="import-export-buttons">
                    <button id="export-btn" class="import-export-btn">匯出數據</button>
                    <button id="import-btn" class="import-export-btn">匯入數據</button>
                    <input type="file" id="import-file" accept=".json" style="display: none;">
                </div>
            </div>
            
            <div class="loading" id="loading">計算中...</div>
        </div>
        
        <div class="result-section" id="result-section">
            <div id="time-info" class="time-info"></div>
            
            <div class="traditional-gua" id="traditional-gua"></div>
            
            <div class="analysis-section" id="analysis-section"></div>
            
            <div class="diagram-title" id="diagram-title"></div>
            <div class="shengke-container" id="shengke-container">
                <div class="diagram-header" id="diagram-header">
                    <div class="diagram-question" id="diagram-question"></div>
                    <div class="diagram-subtitle">五行生克圖</div>
                </div>
                <div class="shengke-diagram" id="shengke-diagram">
                    <svg id="lines-svg" width="800" height="500" style="position:absolute; top:0; left:0; pointer-events:none;">
                        <defs>
                            <marker id="arrowhead-sheng" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                                <polygon points="0 0, 10 3.5, 0 7" fill="#27ae60"/>
                            </marker>
                            <marker id="arrowhead-ke" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                                <polygon points="0 0, 10 3.5, 0 7" fill="#e74c3c"/>
                            </marker>
                        </defs>
                    </svg>
                </div>
            </div>
            <button id="download-btn" class="download-btn">下載五行生克圖</button>
        </div>
    </div>


    <script>
        // 八卦數據定義
        const eightTrigrams = {
            1: { name: "乾", wuXing: "金", symbol: "☰", color: "#e67e22", yaos: [1, 1, 1] },
            2: { name: "兑", wuXing: "金", symbol: "☱", color: "#f39c12", yaos: [1, 1, 0] },
            3: { name: "离", wuXing: "火", symbol: "☲", color: "#e74c3c", yaos: [1, 0, 1] },
            4: { name: "震", wuXing: "木", symbol: "☳", color: "#27ae60", yaos: [1, 0, 0] },
            5: { name: "巽", wuXing: "木", symbol: "☴", color: "#2ecc71", yaos: [0, 1, 1] },
            6: { name: "坎", wuXing: "水", symbol: "☵", color: "#3498db", yaos: [0, 1, 0] },
            7: { name: "艮", wuXing: "土", symbol: "☶", color: "#9b59b6", yaos: [0, 0, 1] },
            8: { name: "坤", wuXing: "土", symbol: "☷", color: "#8e44ad", yaos: [0, 0, 0] }
        };


        // 64卦數據
        const sixtyFourHexagrams = {
            "11": "乾為天", "12": "天澤履", "13": "天火同人", "14": "天雷無妄", 
            "15": "天風姤", "16": "天水訟", "17": "天山遯", "18": "天地否",
            "21": "澤天夬", "22": "兌為澤", "23": "澤火革", "24": "澤雷隨", 
            "25": "澤風大過", "26": "澤水困", "27": "澤山咸", "28": "澤地萃",
            "31": "火天大有", "32": "火澤睽", "33": "離為火", "34": "火雷噬嗑", 
            "35": "火風鼎", "36": "火水未濟", "37": "火山旅", "38": "火地晉",
            "41": "雷天大壯", "42": "雷澤歸妹", "43": "雷火豐", "44": "震為雷", 
            "45": "雷風恆", "46": "雷水解", "47": "雷山小過", "48": "雷地豫",
            "51": "風天小畜", "52": "風澤中孚", "53": "風火家人", "54": "風雷益", 
            "55": "巽為風", "56": "風水渙", "57": "風山漸", "58": "風地觀",
            "61": "水天需", "62": "水澤節", "63": "水火既濟", "64": "水雷屯", 
            "65": "水風井", "66": "坎為水", "67": "水山蹇", "68": "水地比",
            "71": "山天大畜", "72": "山澤損", "73": "山火賁", "74": "山雷頤", 
            "75": "山風蠱", "76": "山水蒙", "77": "艮為山", "78": "山地剝",
            "81": "地天泰", "82": "地澤臨", "83": "地火明夷", "84": "地雷復", 
            "85": "地風升", "86": "地水師", "87": "地山謙", "88": "坤為地"
        };


        // 五行生克關係 - 修正版
        const shengKeRelations = {
            "金": { ke: "木", sheng: "水", beiKe: "火", beiSheng: "土" },
            "木": { ke: "土", sheng: "火", beiKe: "金", beiSheng: "水" },
            "水": { ke: "火", sheng: "木", beiKe: "土", beiSheng: "金" },
            "火": { ke: "金", sheng: "土", beiKe: "水", beiSheng: "木" },
            "土": { ke: "水", sheng: "金", beiKe: "木", beiSheng: "火" }
        };


        // 旺相休囚死規則
        const wangXiangRules = {
            "spring": { "木": "旺", "火": "相", "水": "休", "金": "囚", "土": "死" },
            "summer": { "火": "旺", "土": "相", "木": "休", "水": "囚", "金": "死" },
            "autumn": { "金": "旺", "水": "相", "土": "休", "火": "囚", "木": "死" },
            "winter": { "水": "旺", "木": "相", "金": "休", "土": "囚", "火": "死" },
            "earth": { "土": "旺", "金": "相", "火": "休", "木": "囚", "水": "死" }
        };


        // 旺相休囚死力量係數
        const wangXiangPower = {
            "旺": 5, "相": 4, "休": 3, "囚": 2, "死": 1
        };


        // 旺相休囚死標籤類別
        const wangXiangLabels = {
            "旺": "wang", "相": "xiang", "休": "xiu", "囚": "qiu", "死": "si"
        };


        let currentData = null;
        let currentSeason = "spring";
        let currentTiYongInfo = null;
        let currentQuestion = "";
        let explanationsData = null; // 儲存載入的解卦資料


        // 創建星空背景
        function createStars() {
            const starsContainer = document.getElementById('stars');
            starsContainer.innerHTML = '';
            
            for (let i = 0; i < 100; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                
                const size = Math.random() * 3;
                star.style.width = `${size}px`;
                star.style.height = `${size}px`;
                
                star.style.left = `${Math.random() * 100}%`;
                star.style.top = `${Math.random() * 100}%`;
                
                star.style.animationDelay = `${Math.random() * 5}s`;
                
                starsContainer.appendChild(star);
            }
        }


        // 獲取當前時間信息
        function getLunarInfo() {
            const now = new Date();
            const month = now.getMonth() + 1;
            currentSeason = month <= 3 ? "spring" : month <= 6 ? "summer" : month <= 9 ? "autumn" : "winter";
            
            const seasonNames = {
                "spring": "春季（木旺）", "summer": "夏季（火旺）", 
                "autumn": "秋季（金旺）", "winter": "冬季（水旺）"
            };
            
            return {
                year: now.getFullYear(),
                month: month,
                day: now.getDate(),
                hour: now.getHours(),
                season: currentSeason,
                seasonName: seasonNames[currentSeason]
            };
        }


        // 根據五行獲取旺相狀態
        function getWangXiangStatus(wuXing) {
            return wangXiangRules[currentSeason][wuXing] || "休";
        }


        // 計算卦象
        function calculateGua(number) {
            let remainder = number % 8;
            return remainder === 0 ? 8 : remainder;
        }


        // 計算动爻
        function calculateDongYao(number) {
            let remainder = number % 6;
            return remainder === 0 ? 6 : remainder;
        }


        // 確定體用關係
        function determineTiYong(benGua, dongYao) {
            if (dongYao <= 3) {
                return { 
                    tiGua: benGua.shangGua, 
                    yongGua: benGua.xiaGua, 
                    yongPosition: "下卦",
                    tiPosition: "上卦",
                    dongYaoInXia: true,
                    dongYaoPosition: dongYao - 1
                };
            } else {
                return { 
                    tiGua: benGua.xiaGua, 
                    yongGua: benGua.shangGua, 
                    yongPosition: "上卦",
                    tiPosition: "下卦",
                    dongYaoInXia: false,
                    dongYaoPosition: dongYao - 4
                };
            }
        }


        // 正確計算互卦
        function calculateHuGua(benShangGua, benXiaGua) {
            const shangYaos = eightTrigrams[benShangGua].yaos;
            const xiaYaos = eightTrigrams[benXiaGua].yaos;
            
            // 互卦：取二三四爻為下卦，三四五爻為上卦
            const huXiaYaos = [xiaYaos[1], xiaYaos[2], shangYaos[0]];
            const huShangYaos = [xiaYaos[2], shangYaos[0], shangYaos[1]];
            
            return {
                shangGua: getGuaFromYaos(huShangYaos),
                xiaGua: getGuaFromYaos(huXiaYaos)
            };
        }


        // 正確計算變卦
        function calculateBianGua(benShangGua, benXiaGua, dongYaoInXia, dongYaoPosition) {
            let shangYaos = [...eightTrigrams[benShangGua].yaos];
            let xiaYaos = [...eightTrigrams[benXiaGua].yaos];
            
            if (dongYaoInXia) {
                xiaYaos[dongYaoPosition] = xiaYaos[dongYaoPosition] === 1 ? 0 : 1;
            } else {
                shangYaos[dongYaoPosition] = shangYaos[dongYaoPosition] === 1 ? 0 : 1;
            }
            
            return {
                shangGua: getGuaFromYaos(shangYaos),
                xiaGua: getGuaFromYaos(xiaYaos)
            };
        }


        // 根據爻数组獲取卦象
        function getGuaFromYaos(yaos) {
            for (const [key, value] of Object.entries(eightTrigrams)) {
                if (JSON.stringify(value.yaos) === JSON.stringify(yaos)) {
                    return parseInt(key);
                }
            }
            return 1;
        }


        // 獲取64卦名 - 修正：參數順序應為上卦、下卦
        function getHexagramName(shangGua, xiaGua) {
            const key = `${shangGua}${xiaGua}`;
            return sixtyFourHexagrams[key] || "未知卦";
        }


        // 分析生克關係 - 修正版，確保正確判斷五行關係
        function analyzeShengKe(tiWuXing, targetWuXing) {
            if (tiWuXing === targetWuXing) return "biHe";
            if (shengKeRelations[tiWuXing].ke === targetWuXing) return "ke";
            if (shengKeRelations[tiWuXing].sheng === targetWuXing) return "sheng";
            if (shengKeRelations[tiWuXing].beiKe === targetWuXing) return "beiKe";
            if (shengKeRelations[tiWuXing].beiSheng === targetWuXing) return "beiSheng";
            return "biHe";
        }


        // 創建傳統卦象顯示
        function createTraditionalGuaDisplay(data, tiYongInfo) {
            const benGuaName = getHexagramName(data.benShang.id, data.benXia.id);
            const huGuaName = getHexagramName(data.huShang.id, data.huXia.id);
            const bianGuaName = getHexagramName(data.bianShang.id, data.bianXia.id);
            
            const container = document.getElementById('traditional-gua');
            container.innerHTML = `
                <div class="gua-group">
                    <div class="gua-group-title">本卦</div>
                    <div class="gua-full-name">${benGuaName}</div>
                    <div class="gua-item" style="background: ${data.benShang.color}; color: white;">
                        <div class="gua-symbol">${data.benShang.symbol}</div>
                        <div>${data.benShang.name}卦</div>
                        <div>${data.benShang.wuXing}</div>
                        <div>${tiYongInfo.tiPosition === "上卦" ? "體卦" : tiYongInfo.yongPosition === "上卦" ? "用卦" : ""}</div>
                        <div class="wangxiang-label ${wangXiangLabels[data.benShang.status]}">${data.benShang.status}</div>
                    </div>
                    <div class="gua-item" style="background: ${data.benXia.color}; color: white;">
                        <div class="gua-symbol">${data.benXia.symbol}</div>
                        <div>${data.benXia.name}卦</div>
                        <div>${data.benXia.wuXing}</div>
                        <div>${tiYongInfo.tiPosition === "下卦" ? "體卦" : tiYongInfo.yongPosition === "下卦" ? "用卦" : ""}</div>
                        <div class="wangxiang-label ${wangXiangLabels[data.benXia.status]}">${data.benXia.status}</div>
                    </div>
                </div>
                
                <div class="gua-group">
                    <div class="gua-group-title">互卦</div>
                    <div class="gua-full-name">${huGuaName}</div>
                    <div class="gua-item" style="background: ${data.huShang.color}; color: white;">
                        <div class="gua-symbol">${data.huShang.symbol}</div>
                        <div>${data.huShang.name}卦</div>
                        <div>${data.huShang.wuXing}</div>
                        <div>互用卦</div>
                        <div class="wangxiang-label ${wangXiangLabels[data.huShang.status]}">${data.huShang.status}</div>
                    </div>
                    <div class="gua-item" style="background: ${data.huXia.color}; color: white;">
                        <div class="gua-symbol">${data.huXia.symbol}</div>
                        <div>${data.huXia.name}卦</div>
                        <div>${data.huXia.wuXing}</div>
                        <div>互用卦</div>
                        <div class="wangxiang-label ${wangXiangLabels[data.huXia.status]}">${data.huXia.status}</div>
                    </div>
                </div>
                
                <div class="gua-group">
                    <div class="gua-group-title">變卦</div>
                    <div class="gua-full-name">${bianGuaName}</div>
                    <div class="gua-item" style="background: ${data.bianShang.color}; color: white;">
                        <div class="gua-symbol">${data.bianShang.symbol}</div>
                        <div>${data.bianShang.name}卦</div>
                        <div>${data.bianShang.wuXing}</div>
                        <div>變用卦</div>
                        <div class="wangxiang-label ${wangXiangLabels[data.bianShang.status]}">${data.bianShang.status}</div>
                    </div>
                    <div class="gua-item" style="background: ${data.bianXia.color}; color: white;">
                        <div class="gua-symbol">${data.bianXia.symbol}</div>
                        <div>${data.bianXia.name}卦</div>
                        <div>${data.bianXia.wuXing}</div>
                        <div>變用卦</div>
                        <div class="wangxiang-label ${wangXiangLabels[data.bianXia.status]}">${data.bianXia.status}</div>
                    </div>
                </div>
            `;
        }


        // 繪製生克線條 - 修正：根據旺相休囚死狀態調整線條粗細
        function drawShengkeLine(fromId, toId, relation, status) {
            const fromElem = document.getElementById(fromId);
            const toElem = document.getElementById(toId);
            
            if (!fromElem || !toElem) return;
            
            const fromRect = fromElem.getBoundingClientRect();
            const toRect = toElem.getBoundingClientRect();
            const diagramRect = document.getElementById('shengke-diagram').getBoundingClientRect();
            
            const fromX = fromRect.left + fromRect.width/2 - diagramRect.left;
            const fromY = fromRect.top + fromRect.height/2 - diagramRect.top;
            const toX = toRect.left + toRect.width/2 - diagramRect.left;
            const toY = toRect.top + toRect.height/2 - diagramRect.top;
            
            const dx = toX - fromX;
            const dy = toY - fromY;
            const distance = Math.sqrt(dx * dx + dy * dy);
            const radius = 50;
            
            const adjustedToX = fromX + dx * (distance - radius) / distance;
            const adjustedToY = fromY + dy * (distance - radius) / distance;
            const adjustedFromX = fromX + dx * radius / distance;
            const adjustedFromY = fromY + dy * radius / distance;
            
            const svg = document.getElementById('lines-svg');
            const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            
            // 根據旺相休囚死狀態設置線條粗細
            const strokeWidth = wangXiangPower[status] || 3;
            line.setAttribute('stroke-width', strokeWidth);
            
            if (relation === 'sheng') {
                line.setAttribute('x1', adjustedFromX);
                line.setAttribute('y1', adjustedFromY);
                line.setAttribute('x2', adjustedToX);
                line.setAttribute('y2', adjustedToY);
                line.setAttribute('class', 'line-sheng');
                line.setAttribute('marker-end', 'url(#arrowhead-sheng)');
            } else if (relation === 'ke') {
                line.setAttribute('x1', adjustedFromX);
                line.setAttribute('y1', adjustedFromY);
                line.setAttribute('x2', adjustedToX);
                line.setAttribute('y2', adjustedToY);
                line.setAttribute('class', 'line-ke');
                line.setAttribute('marker-end', 'url(#arrowhead-ke)');
            } else if (relation === 'beiSheng') {
                line.setAttribute('x1', adjustedToX);
                line.setAttribute('y1', adjustedToY);
                line.setAttribute('x2', adjustedFromX);
                line.setAttribute('y2', adjustedFromY);
                line.setAttribute('class', 'line-sheng');
                line.setAttribute('marker-end', 'url(#arrowhead-sheng)');
            } else if (relation === 'beiKe') {
                line.setAttribute('x1', adjustedToX);
                line.setAttribute('y1', adjustedToY);
                line.setAttribute('x2', adjustedFromX);
                line.setAttribute('y2', adjustedFromY);
                line.setAttribute('class', 'line-ke');
                line.setAttribute('marker-end', 'url(#arrowhead-ke)');
            } else {
                line.setAttribute('x1', adjustedFromX);
                line.setAttribute('y1', adjustedFromY);
                line.setAttribute('x2', adjustedToX);
                line.setAttribute('y2', adjustedToY);
                line.setAttribute('class', 'line-bihe');
            }
            
            svg.appendChild(line);
        }


        // 生成五行生克圖
        function createShengkeDiagram(data) {
            const diagram = document.getElementById('shengke-diagram');
            const svg = document.getElementById('lines-svg');
            svg.innerHTML = `
                <defs>
                    <marker id="arrowhead-sheng" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                        <polygon points="0 0, 10 3.5, 0 7" fill="#27ae60"/>
                    </marker>
                    <marker id="arrowhead-ke" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                        <polygon points="0 0, 10 3.5, 0 7" fill="#e74c3c"/>
                    </marker>
                </defs>
            `;
            
            const positions = [
                { id: 'benShang', x: 100, y: 100 },
                { id: 'benXia', x: 100, y: 250 },
                { id: 'ti', x: 300, y: 175 },
                { id: 'huShang', x: 500, y: 100 },
                { id: 'huXia', x: 500, y: 250 },
                { id: 'bianShang', x: 700, y: 100 },
                { id: 'bianXia', x: 700, y: 250 }
            ];
            
            positions.forEach(pos => {
                const guaData = data[pos.id];
                const node = document.createElement('div');
                node.className = `gua-node ${pos.id === 'ti' ? 'ti' : ''}`;
                node.id = pos.id;
                node.style.left = pos.x + 'px';
                node.style.top = pos.y + 'px';
                node.style.background = guaData.color;
                node.innerHTML = `
                    <div class="gua-symbol">${guaData.symbol}</div>
                    <div class="gua-name">${guaData.name}卦</div>
                    <div class="gua-name">${guaData.wuXing}</div>
                    <div class="gua-status">${guaData.status}</div>
                `;
                node.onclick = () => swapWithTiGua(pos.id);
                diagram.appendChild(node);
            });
            
            Object.keys(data).forEach(key => {
                if (key !== 'ti') {
                    const relation = analyzeShengKe(data.ti.wuXing, data[key].wuXing);
                    drawShengkeLine('ti', key, relation, data[key].status);
                }
            });
        }


        // 卦象交換功能
        function swapWithTiGua(guaId) {
            if (guaId === 'ti') return;
            
            const temp = currentData[guaId];
            currentData[guaId] = currentData.ti;
            currentData.ti = temp;
            
            updateDiagram();
        }


        // 更新生克圖
        function updateDiagram() {
            const diagram = document.getElementById('shengke-diagram');
            diagram.querySelectorAll('.gua-node').forEach(node => node.remove());
            createShengkeDiagram(currentData);
        }


        // 載入JSON解卦資料
        function loadExplanationsData() {
            const fileInput = document.getElementById('explanations-file');
            fileInput.click();
            
            fileInput.onchange = function(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        explanationsData = JSON.parse(e.target.result);
                        document.getElementById('json-status').textContent = '已載入解卦資料';
                        document.getElementById('json-status').style.color = '#27ae60';
                        console.log('解卦資料載入成功');
                    } catch (error) {
                        console.error('載入解卦資料錯誤:', error);
                        alert('載入解卦資料失敗，請檢查文件格式！');
                        document.getElementById('json-status').textContent = '載入失敗';
                        document.getElementById('json-status').style.color = '#e74c3c';
                    }
                };
                
                reader.readAsText(file);
            };
        }


        // 匯出數據功能
        function exportData() {
            if (!currentData) {
                alert('請先進行卜卦計算！');
                return;
            }
            
            const exportData = {
                question: currentQuestion,
                data: currentData,
                tiYongInfo: currentTiYongInfo,
                time: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(exportData, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `梅花心易解卦_${new Date().toLocaleDateString()}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
        }


        // 匯入數據功能
        function importData() {
            const fileInput = document.getElementById('import-file');
            fileInput.click();
            
            fileInput.onchange = function(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        
                        // 設置問題
                        document.getElementById('question').value = importedData.question;
                        currentQuestion = importedData.question;
                        
                        // 設置數據
                        currentData = importedData.data;
                        currentTiYongInfo = importedData.tiYongInfo;
                        
                        // 顯示結果
                        document.getElementById('result-section').style.display = 'block';
                        document.getElementById('download-btn').style.display = 'block';
                        
                        const lunarInfo = getLunarInfo();
                        document.getElementById('time-info').innerHTML = `
                            起卦時間：${lunarInfo.year}年${lunarInfo.month}月${lunarInfo.day}日 ${lunarInfo.hour}時 | 
                            季節：${lunarInfo.seasonName} | 
                            數據來源：匯入數據 (${new Date(importedData.time).toLocaleString()})
                        `;
                        
                        document.getElementById('diagram-title').textContent = `${currentQuestion}的五行生克圖`;
                        document.getElementById('diagram-question').textContent = currentQuestion;
                        
                        createTraditionalGuaDisplay(currentData, currentTiYongInfo);
                        createAnalysisContent(currentData, currentTiYongInfo);
                        createShengkeDiagram(currentData);
                        
                    } catch (error) {
                        console.error('匯入數據錯誤:', error);
                        alert('匯入數據失敗，請檢查文件格式！');
                    }
                };
                
                reader.readAsText(file);
            };
        }


        // 下載生克圖
        function downloadDiagram() {
            const container = document.getElementById('shengke-container');
            
            if (typeof html2canvas === 'undefined') {
                alert('圖片生成庫尚未載入，請稍後再試！');
                console.error('html2canvas 未載入');
                return;
            }
            
            container.style.overflow = 'visible';
            html2canvas(container, {
                scale: 2,
                logging: false,
                useCORS: true,
                backgroundColor: '#16213e',
                width: container.scrollWidth,
                height: container.scrollHeight,
                scrollX: 0,
                scrollY: 0,
                onclone: (clonedDoc) => {
                    const clonedContainer = clonedDoc.getElementById('shengke-container');
                    clonedContainer.style.overflow = 'visible';
                    clonedContainer.style.position = 'relative';
                }
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = `${currentQuestion}-五行生克圖.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
            }).catch(error => {
                console.error('圖片生成失敗:', error);
                alert('圖片下載失敗，請重試！');
            });
        }


        // 創建分析內容 - 修正生克關係描述
        function createAnalysisContent(data, tiYongInfo) {
            const analysisSection = document.getElementById('analysis-section');
            
            const yongGuaKey = tiYongInfo.yongPosition === "上卦" ? "benShang" : "benXia";
            const benGuaRelation = analyzeShengKe(data.ti.wuXing, data[yongGuaKey].wuXing);
            
            const huShangRelation = analyzeShengKe(data.ti.wuXing, data.huShang.wuXing);
            const huXiaRelation = analyzeShengKe(data.ti.wuXing, data.huXia.wuXing);
            
            const bianShangRelation = analyzeShengKe(data.ti.wuXing, data.bianShang.wuXing);
            const bianXiaRelation = analyzeShengKe(data.ti.wuXing, data.bianXia.wuXing);
            
            // 檢查是否已載入解卦資料
            if (!explanationsData) {
                analysisSection.innerHTML = `
                    <div class="analysis-card">
                        <h3>錯誤：未載入解卦資料</h3>
                        <p>請先點擊"載入解卦資料"按鈕，上傳正確的JSON解卦資料檔案。</p>
                    </div>
                `;
                return;
            }
            
            // 獲取本卦解釋
            const benGuaName = getHexagramName(data.benShang.id, data.benXia.id);
            const benGuaExplanation = explanationsData.hexagramExplanations[benGuaName] || "無相關解釋資料";
            
            // 獲取動爻解釋
            const dongYao = calculateDongYao(parseInt(document.getElementById('number3').value));
            const dongYaoGua = tiYongInfo.dongYaoInXia ? data.benXia.name : data.benShang.name;
            const dongYaoKey = `${dongYaoGua}${dongYao}爻`;
            const dongYaoExplanation = explanationsData.dongYaoExplanations[dongYaoKey] || "無相關動爻解釋資料";
            
            // 獲取變卦解釋
            const bianGuaName = getHexagramName(data.bianShang.id, data.bianXia.id);
            const bianGuaExplanation = explanationsData.hexagramExplanations[bianGuaName] || "無相關變卦解釋資料";
            
            analysisSection.innerHTML = `
                <div class="analysis-card">
                    <h3>第一步：起卦與定體用</h3>
                    <p>體卦為<b>${data.ti.name}卦 (${data.ti.wuXing})</b>，代表問卦者自身；用卦為<b>${data[yongGuaKey].name}卦 (${data[yongGuaKey].wuXing})</b>，代表所問之事。</p>
                    <p>體卦狀態：<span class="wangxiang-label ${wangXiangLabels[data.ti.status]}">${data.ti.status}</span>，${getWangXiangExplanation(data.ti.wuXing, data.ti.status)}</p>
                </div>
                
                <div class="analysis-card">
                    <h3>第二步：定五行生克大框架</h3>
                    <p><span class="luck-badge ${getLuckClass(benGuaRelation)}">${getRelationText(benGuaRelation)}</span>
                    ${getRelationExplanationCorrected(benGuaRelation, data.ti.name, data.ti.wuXing, data[yongGuaKey].name, data[yongGuaKey].wuXing)}</p>
                    <p>${getDetailedAnalysis(benGuaRelation, '本卦', data.ti.name, data[yongGuaKey].name)}</p>
                </div>
                
                <div class="analysis-card">
                    <h3>第三步：析卦象明事類</h3>
                    <p>體卦${data.ti.name}卦象徵：${explanationsData.guaExplanations[data.ti.name] || "無相關解釋資料"}</p>
                    <p>用卦${data[yongGuaKey].name}卦象徵：${explanationsData.guaExplanations[data[yongGuaKey].name] || "無相關解釋資料"}</p>
                    <p>本卦${benGuaName}整體解釋：${benGuaExplanation}</p>
                    <p>${getEventAnalysis(data.ti.name, data[yongGuaKey].name, benGuaRelation)}</p>
                </div>
                
                <div class="analysis-card">
                    <h3>第四步：斷過程（互卦分析）</h3>
                    <p><span class="luck-badge ${getLuckClass(huShangRelation)}">上互卦</span>
                    ${data.huShang.name}卦(${data.huShang.wuXing}) ${getRelationExplanationCorrected(huShangRelation, data.ti.name, data.ti.wuXing, data.huShang.name, data.huShang.wuXing)}，${getProcessAnalysis(huShangRelation, '上互卦', '外在環境')}</p>
                    <p><span class="luck-badge ${getLuckClass(huXiaRelation)}">下互卦</span>
                    ${data.huXia.name}卦(${data.huXia.wuXing}) ${getRelationExplanationCorrected(huXiaRelation, data.ti.name, data.ti.wuXing, data.huXia.name, data.huXia.wuXing)}，${getProcessAnalysis(huXiaRelation, '下互卦', '內在因素')}</p>
                    <p>互卦象徵過程中可能出現：${explanationsData.guaExplanations[data.huShang.name] || "無相關解釋資料"}與${explanationsData.guaExplanations[data.huXia.name] || "無相關解釋資料"}的交互影響。</p>
                    <p>動爻（第${dongYao}爻）解釋：${dongYaoExplanation}</p>
                </div>
                
                <div class="analysis-card">
                    <h3>第五步：斷結果（變卦分析）</h3>
                    <p>變卦${bianGuaName}整體解釋：${bianGuaExplanation}</p>
                    ${data.bianShang.id !== data.benShang.id ? `
                    <p><span class="luck-badge ${getLuckClass(bianShangRelation)}">變上卦（用變卦）</span>
                    ${data.bianShang.name}卦(${data.bianShang.wuXing}) ${getRelationExplanationCorrected(bianShangRelation, data.ti.name, data.ti.wuXing, data.bianShang.name, data.bianShang.wuXing)}，${getResultAnalysis(bianShangRelation, '變上卦', '外部結果')}</p>
                    ` : ''}
                    ${data.bianXia.id !== data.benXia.id ? `
                    <p><span class="luck-badge ${getLuckClass(bianXiaRelation)}">變下卦（用變卦）</span>
                    ${data.bianXia.name}卦(${data.bianXia.wuXing}) ${getRelationExplanationCorrected(bianXiaRelation, data.ti.name, data.ti.wuXing, data.bianXia.name, data.bianXia.wuXing)}，${getResultAnalysis(bianXiaRelation, '變下卦', '內部結果')}</p>
                    ` : ''}
                </div>
                
                <div class="analysis-card">
                    <h3>第六步：綜合解讀</h3>
                    <p>體卦${data.ti.name}(${data.ti.wuXing})狀態<span class="wangxiang-label ${wangXiangLabels[data.ti.status]}">${data.ti.status}</span>，${getComprehensiveAnalysis(benGuaRelation, huShangRelation, huXiaRelation, bianShangRelation, bianXiaRelation)}</p>
                    <p>${getFinalAdvice(benGuaRelation, bianShangRelation, bianXiaRelation)}</p>
                </div>
            `;
            
            // 顯示分析區域
            analysisSection.style.display = 'block';
        }


        // 修正生克關係描述函數
        function getRelationExplanationCorrected(relation, tiName, tiWuXing, yongName, yongWuXing) {
            switch(relation) {
                case 'sheng': return `體卦${tiName}(${tiWuXing})生用卦${yongName}(${yongWuXing})`;
                case 'ke': return `體卦${tiName}(${tiWuXing})克用卦${yongName}(${yongWuXing})`;
                case 'beiSheng': return `用卦${yongName}(${yongWuXing})生體卦${tiName}(${tiWuXing})`;
                case 'beiKe': return `用卦${yongName}(${yongWuXing})克體卦${tiName}(${tiWuXing})`;
                case 'biHe': return `體用比和，${tiName}(${tiWuXing})與${yongName}(${yongWuXing})五行相同`;
                default: return '';
            }
        }


        function getWangXiangExplanation(wuXing, status) {
            const explanations = {
                "旺": "能量最強，生克力最大",
                "相": "能量次強，得到時令助力",
                "休": "能量平穩，需要休息蓄力",
                "囚": "能量受限，受時令制約",
                "死": "能量最弱，難以發揮作用"
            };
            return `${wuXing}行在當前時令處於${status}狀態，${explanations[status]}`;
        }


        function getEventAnalysis(tiGua, yongGua, relation) {
            if (relation === 'sheng') {
                return `體卦${tiGua}生用卦${yongGua}，象徵您需要付出精力來應對${getGuaDomain(yongGua)}領域的事務。`;
            } else if (relation === 'ke') {
                return `體卦${tiGua}克用卦${yongGua}，象徵您有能力主導和掌控${getGuaDomain(yongGua)}領域的事務。`;
            } else if (relation === 'beiSheng') {
                return `用卦${yongGua}生體卦${tiGua}，象徵外在環境或事件對您有幫助作用，在${getGuaDomain(yongGua)}領域會得到支持。`;
            } else if (relation === 'beiKe') {
                return `用卦${yongGua}克體卦${tiGua}，象徵需要克服在${getGuaDomain(yongGua)}領域的挑戰和阻礙。`;
            } else {
                return `體用比和，象徵內外環境協調一致，在${getGuaDomain(yongGua)}領域事務順利。`;
            }
        }


        function getGuaDomain(guaName) {
            const domains = {
                "乾": "事業/權威", "兑": "口才/溝通", "离": "文采/名聲", "震": "行動/開創",
                "巽": "人際/滲透", "坎": "智慧/風險", "艮": "阻礙/靜止", "坤": "大眾/包容"
            };
            return domains[guaName] || "相關";
        }


        function getLuckClass(relation) {
            switch(relation) {
                case 'sheng': return 'luck-warning';
                case 'beiSheng': return 'luck-good';
                case 'ke': return 'luck-normal';
                case 'beiKe': return 'luck-bad';
                case 'biHe': return 'luck-good';
                default: return 'luck-normal';
            }
        }


        function getRelationText(relation) {
            switch(relation) {
                case 'sheng': return '平';
                case 'beiSheng': return '吉';
                case 'ke': return '中';
                case 'beiKe': return '凶';
                case 'biHe': return '吉';
                default: return '中';
            }
        }


        function getDetailedAnalysis(relation, guaType, tiName, yongName) {
            switch(relation) {
                case 'sheng': return `體卦${tiName}生用卦${yongName}，${guaType}關係需要付出，代表您需要投入精力來應對外在環境。`;
                case 'ke': return `體卦${tiName}克用卦${yongName}，${guaType}關係主動，代表您有能力主導和掌控外在環境。`;
                case 'beiSheng': return `用卦${yongName}生體卦${tiName}，${guaType}關係吉利，代表外在環境或事件對您有幫助作用。`;
                case 'beiKe': return `用卦${yongName}克體卦${tiName}，${guaType}關係不利，代表外在環境對您構成挑戰和壓力。`;
                case 'biHe': return `體用比和，${guaType}關係和諧，代表內外環境協調一致。`;
                default: return '';
            }
        }


        function getProcessAnalysis(relation, huGuaName, influenceType) {
            switch(relation) {
                case 'sheng': return `過程中的${influenceType}會消耗您的能量，需要合理分配精力。`;
                case 'ke': return `過程中的${influenceType}需要您主動去管理和控制。`;
                case 'beiSheng': return `對過程中的${influenceType}有積極的促進作用，會帶來幫助和支持。`;
                case 'beiKe': return `對過程中的${influenceType}產生阻礙影響，需要特別注意和克服。`;
                case 'biHe': return `過程中的${influenceType}與您和諧相處，相對平穩。`;
                default: return '';
            }
        }


        function getResultAnalysis(relation, bianGuaName, resultType) {
            switch(relation) {
                case 'sheng': return `${resultType}需要您付出相當的努力才能達成。`;
                case 'ke': return `${resultType}需要您積極爭取和主導。`;
                case 'beiSheng': return `對${resultType}有正面的影響，會帶來良好的結局。`;
                case 'beiKe': return `對${resultType}產生不利影響，需要努力改善。`;
                case 'biHe': return `${resultType}相對平穩和諧，沒有太大波動。`;
                default: return '';
            }
        }


        function getComprehensiveAnalysis(ben, huS, huX, bianS, bianX) {
            const positiveCount = [ben, huS, huX, bianS, bianX].filter(r => 
                r === 'beiSheng' || r === 'biHe').length;
            
            if (positiveCount >= 4) return '整體趨勢非常吉利，多方助力，事情容易成功。';
            if (positiveCount >= 3) return '整體平順，雖有挑戰但仍可成功，需要適當努力。';
            if (positiveCount >= 2) return '需要付出較多努力，結果尚可，要有耐心和毅力。';
            return '面臨較多困難，需要謹慎應對，建議多做準備。';
        }


        function getFinalAdvice(benRelation, bianSRelation, bianXRelation) {
            if (benRelation === 'beiKe' && (bianSRelation === 'beiSheng' || bianXRelation === 'beiSheng')) {
                return '建議：雖然開始會有困難，但只要堅持下去，最終會有好結果。';
            } else if (benRelation === 'beiSheng' && (bianSRelation === 'beiKe' || bianXRelation === 'beiKe')) {
                return '建議：開始順利但結局可能有變數，需要保持謹慎。';
            } else if (benRelation === 'beiSheng' && (bianSRelation === 'beiSheng' || bianXRelation === 'beiSheng')) {
                return '建議：從頭到尾都很順利，可以積極推進。';
            } else {
                return '建議：保持平常心，一步一腳印，穩紮穩打。';
            }
        }


        // 時間取卦
        function getGuaFromTime(dateTime) {
            let date = dateTime ? new Date(dateTime) : new Date();
            if (isNaN(date.getTime())) {
                console.error('無效的時間輸入，使用當前時間');
                date = new Date();
            }
            const year = date.getFullYear();
            const month = date.getMonth() + 1;
            const day = date.getDate();
            const hour = date.getHours();
            
            const num1 = (year + month) % 8 || 8;
            const num2 = (month + day) % 8 || 8;
            const num3 = (day + hour) % 6 || 6;
            
            return { num1, num2, num3 };
        }


        // 字取卦
        function getGuaFromCharacters(characters) {
            if (!characters || characters.trim().length === 0 || !/[\u4E00-\u9FFF]/.test(characters)) {
                alert('請輸入1-3個有效漢字！');
                throw new Error('無效的文字輸入');
            }
            
            let total1 = 0, total2 = 0, total3 = 0;
            
            for (let i = 0; i < characters.length; i++) {
                const code = characters.charCodeAt(i);
                if (i % 3 === 0) total1 += code;
                else if (i % 3 === 1) total2 += code;
                else total3 += code;
            }
            
            const num1 = total1 % 8 || 8;
            const num2 = total2 % 8 || 8;
            const num3 = total3 % 6 || 6;
            
            return { num1, num2, num3 };
        }


        // 隨機取卦
        function randomDivination() {
            const num1 = Math.floor(Math.random() * 900) + 100;
            const num2 = Math.floor(Math.random() * 900) + 100;
            const num3 = Math.floor(Math.random() * 900) + 100;
            
            document.getElementById('number1').value = num1;
            document.getElementById('number2').value = num2;
            document.getElementById('number3').value = num3;
            
            calculate();
        }


        // 切換取卦方式
        function switchMethod() {
            const method = document.getElementById('method').value;
            document.getElementById('number-method').style.display = method === 'number' ? 'block' : 'none';
            document.getElementById('time-method').style.display = method === 'time' ? 'block' : 'none';
            document.getElementById('character-method').style.display = method === 'character' ? 'block' : 'none';
            document.getElementById('random-btn').style.display = method === 'number' ? 'inline-block' : 'none';
        }


        // 主計算函數
        function calculate() {
            // 檢查是否已載入解卦資料
            if (!explanationsData) {
                alert('請先載入解卦資料檔案！');
                document.getElementById('load-json-btn').focus();
                return;
            }
            
            const loadingElement = document.getElementById('loading');
            loadingElement.style.display = 'block';
            
            try {
                currentQuestion = document.getElementById('question').value || "問題分析";
                const method = document.getElementById('method').value;
                
                let num1, num2, num3;
                
                if (method === 'number') {
                    num1 = parseInt(document.getElementById('number1').value);
                    num2 = parseInt(document.getElementById('number2').value);
                    num3 = parseInt(document.getElementById('number3').value);
                    
                    if (isNaN(num1) || isNaN(num2) || isNaN(num3) || 
                        num1 < 100 || num1 > 999 || num2 < 100 || num2 > 999 || num3 < 100 || num3 > 999) {
                        alert('請輸入有效的三位數（100-999）！');
                        throw new Error('無效的數字輸入');
                    }
                } else if (method === 'time') {
                    const timeInput = document.getElementById('time-input').value;
                    if (!timeInput) {
                        alert('請選擇有效的時間！');
                        throw new Error('無效的時間輸入');
                    }
                    const guaNumbers = getGuaFromTime(timeInput);
                    num1 = guaNumbers.num1;
                    num2 = guaNumbers.num2;
                    num3 = guaNumbers.num3;
                } else if (method === 'character') {
                    const characters = document.getElementById('character-input').value;
                    const guaNumbers = getGuaFromCharacters(characters);
                    num1 = guaNumbers.num1;
                    num2 = guaNumbers.num2;
                    num3 = guaNumbers.num3;
                }
                
                // 計算卦象
                const shangGua = calculateGua(num1);
                const xiaGua = calculateGua(num2);
                const dongYao = calculateDongYao(num3);
                const benGua = { shangGua, xiaGua };
                
                currentTiYongInfo = determineTiYong(benGua, dongYao);
                const huGua = calculateHuGua(benGua.shangGua, benGua.xiaGua);
                const bianGua = calculateBianGua(benGua.shangGua, benGua.xiaGua, 
                    currentTiYongInfo.dongYaoInXia, currentTiYongInfo.dongYaoPosition);
                
                const lunarInfo = getLunarInfo();
                
                currentData = {
                    ti: { 
                        ...eightTrigrams[currentTiYongInfo.tiGua], 
                        status: getWangXiangStatus(eightTrigrams[currentTiYongInfo.tiGua].wuXing),
                        id: currentTiYongInfo.tiGua
                    },
                    benShang: { 
                        ...eightTrigrams[benGua.shangGua], 
                        status: getWangXiangStatus(eightTrigrams[benGua.shangGua].wuXing),
                        id: benGua.shangGua
                    },
                    benXia: { 
                        ...eightTrigrams[benGua.xiaGua], 
                        status: getWangXiangStatus(eightTrigrams[benGua.xiaGua].wuXing),
                        id: benGua.xiaGua
                    },
                    huShang: { 
                        ...eightTrigrams[huGua.shangGua], 
                        status: getWangXiangStatus(eightTrigrams[huGua.shangGua].wuXing),
                        id: huGua.shangGua
                    },
                    huXia: { 
                        ...eightTrigrams[huGua.xiaGua], 
                        status: getWangXiangStatus(eightTrigrams[huGua.xiaGua].wuXing),
                        id: huGua.xiaGua
                    },
                    bianShang: { 
                        ...eightTrigrams[bianGua.shangGua], 
                        status: getWangXiangStatus(eightTrigrams[bianGua.shangGua].wuXing),
                        id: bianGua.shangGua
                    },
                    bianXia: { 
                        ...eightTrigrams[bianGua.xiaGua], 
                        status: getWangXiangStatus(eightTrigrams[bianGua.xiaGua].wuXing),
                        id: bianGua.xiaGua
                    }
                };
                
                document.getElementById('result-section').style.display = 'block';
document.getElementById('download-btn').style.display = 'block';
document.getElementById('time-info').innerHTML = `
    起卦時間：${lunarInfo.year}年${lunarInfo.month}月${lunarInfo.day}日 ${lunarInfo.hour}時 | 
    季節：${lunarInfo.seasonName} | 
    取卦方式：${method === 'number' ? '數字取卦' : method === 'time' ? '時間取卦' : '以字取卦'}
`;
document.getElementById('diagram-title').textContent = `${currentQuestion}的五行生克圖`;
document.getElementById('diagram-question').textContent = currentQuestion;


createTraditionalGuaDisplay(currentData, currentTiYongInfo);
createAnalysisContent(currentData, currentTiYongInfo);
createShengkeDiagram(currentData);


} catch (error) {
    console.error('解卦錯誤:', error);
    alert('解卦失敗：' + error.message);
} finally {
    loadingElement.style.display = 'none';
}
}


// 綁定事件
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('calculate-btn').addEventListener('click', calculate);
    document.getElementById('random-btn').addEventListener('click', randomDivination);
    document.getElementById('download-btn').addEventListener('click', downloadDiagram);
    document.getElementById('method').addEventListener('change', switchMethod);
    document.getElementById('export-btn').addEventListener('click', exportData);
    document.getElementById('import-btn').addEventListener('click', importData);
    document.getElementById('load-json-btn').addEventListener('click', loadExplanationsData);
    
    // 初始化方法選擇
    switchMethod();
    
    // 設置當前時間為時間取卦的默認值
    const now = new Date();
    const localDateTime = new Date(now.getTime() - now.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
    document.getElementById('time-input').value = localDateTime;
    
    // 創建星空背景
    createStars();
});
</script>
</body>

</html>


































