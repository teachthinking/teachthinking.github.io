<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>張老師易經卜卦</title>
  <style>
    body{font-family:"Noto Sans TC",sans-serif;background:#f7f7f7;color:#222;padding:20px}
    .container{max-width:980px;margin:0 auto;background:#fff;padding:22px;border-radius:12px;box-shadow:0 6px 24px rgba(0,0,0,.06)}
    h1{margin:0 0 6px 0;font-size:26px}
    h2.subtitle{margin:0 0 16px 0;color:#666;font-weight:400;font-size:15px}
    .tab-buttons{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:14px}
    .tab-button{padding:8px 14px;border-radius:8px;border:0;background:#efefef;cursor:pointer}
    .tab-button.active{background:#222;color:#fff}
    .tab-content{display:none;padding-top:8px}
    .tab-content.active{display:block}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin:8px 0}
    .hint{font-size:13px;color:#666}
    .gua-box{border:1px solid #e6e6e6;border-radius:10px;padding:12px;background:#fafafa;margin-bottom:12px}
    .hidden{display:none}
    button.primary{padding:9px 16px;background:#222;color:#fff;border-radius:8px;border:0;cursor:pointer}
    input,select,textarea{padding:8px;border-radius:8px;border:1px solid #d0d0d0;font-size:14px}
    .pill{display:inline-block;padding:4px 8px;border-radius:999px;background:#f0f0f0;font-size:12px}
    #line-explanation > div{margin-bottom:10px;padding-bottom:8px;border-bottom:1px dashed #eee}
    .score-card{display:flex;align-items:center;gap:10px;margin-bottom:8px}
    .score-bar-wrap{flex:1;height:10px;background:#eee;border-radius:6px;overflow:hidden}
    .score-bar{height:100%;width:0;transition:width .4s;background:linear-gradient(90deg,#f44336,#ff9800,#4caf50)}
    .score-val{min-width:36px;text-align:right;font-weight:600}
    pre{background:#fafafa;padding:8px;border-radius:6px;overflow:auto}
    
    /* 卦象視覺優化 */
    .gua-line { font-family: 'Courier New', monospace;
 font-size: 20px; line-height: 1.2; }
    .gua-line div { padding: 2px 0;
 }
    .gua-yang { display: flex; align-items: center; justify-content: center; height: 1.2em;
 }
    .gua-yang::before { content: ''; width: 100%; height: 6px; background: #222;
 }
    .gua-yin { display: flex; align-items: center; justify-content: space-between; height: 1.2em;
 }
    .gua-yin::before, .gua-yin::after { content: ''; width: 45%; height: 6px; background: #222;
 }
    .gua-moving { font-weight: bold; color: #b71c1c; display: flex; align-items: center; justify-content: center; height: 1.2em;
 }
    .gua-moving.yang::before { content: ''; width: 100%; height: 6px; background: #b71c1c;
 }
    .gua-moving.yang::after { content: '◎'; margin-left: 8px; font-size: 0.8em;
 }
    .gua-moving.yin::before, .gua-moving.yin::after { content: '×'; margin-right: 8px; font-size: 0.8em;
 }
    
    /* 五行分析區 */
    .wuxing-analysis { margin-top: 20px;
 border-top: 1px dashed #e6e6e6; padding-top: 15px; }
    .wuxing-box { padding: 8px 12px; background: #f0f0f0; border-radius: 8px;
 margin-bottom: 10px; }
    .wuxing-result { font-weight: bold; }
    .wuxing-desc { font-size: 14px; margin-top: 4px;
 color: #555; }
    .wuxing-status { font-weight: bold; }
    .wuxing-status.吉 { color: #4caf50;
 }
    .wuxing-status.凶 { color: #d32f2f; }
    .wuxing-status.平 { color: #1e88e5;
 }
    .wuxing-status.大凶 { color: #d32f2f; }
    .wuxing-status.大吉 { color: #4caf50;
 }

    /* 解卦區 */
    .question-analysis { margin-top: 20px; border-top: 1px solid #222; padding-top: 20px;
 }
    .analysis-item { margin-bottom: 20px; }
    .analysis-item h4 { margin-top: 0; color: #222;
 }
    .analysis-item p { margin-top: 5px; line-height: 1.6; }
    .analysis-status { font-weight: bold;
 }
    .analysis-status.吉 { color: #4caf50; }
    .analysis-status.凶 { color: #d32f2f;
 }
    .analysis-status.平 { color: #1e88e5; }
    .analysis-status.大凶 { color: #d32f2f;
 }
    .analysis-status.大吉 { color: #4caf50; }
    .analysis-item .suggestion { background: #e8f5e9; padding: 12px;
 border-radius: 8px; border-left: 4px solid #4caf50; margin-top: 15px; }
    .analysis-item .suggestion h5 { margin: 0 0 8px 0;
 font-size: 16px; color: #4caf50; }
    .analysis-item .suggestion ul, .analysis-item .suggestion p { margin: 0; padding-left: 20px;
 }
    .analysis-item .suggestion li { margin-bottom: 5px; }
    .wuxing-explanation { font-size: 14px; color: #555;
 }
    .trigram-details { font-size: 14px; background: #f0f4f8; padding: 10px; border-radius: 6px; border-left: 3px solid #64b5f6; margin-top: 10px;
 }

    .detailed-analysis { margin-top: 20px; border-top: 1px dashed #e6e6e6; padding-top: 15px;
 }
    .detailed-section { margin-bottom: 15px; }
    .detailed-section h5 { margin-top: 0; margin-bottom: 5px;
 }
    .analysis-message { padding: 15px; background: #fff3e0; border-left: 4px solid #ff9800; border-radius: 6px; font-size: 15px; line-height: 1.5;
 color: #333; }
  </style>
</head>
<body>
  <div class="container">
    <h1>張老師易經卜卦</h1>
    <h2 id="subtitle" class="subtitle">載入中…（若無 quotes.json 顯示預設句）</h2>

    <div class="tab-buttons">
      <button class="tab-button active" data-target="tab-number">數字取卦</button>
      <button class="tab-button" data-target="tab-manual">手動取卦</button>
      <button class="tab-button" data-target="tab-time">時間取卦（梅花易）</button>
      <button class="tab-button" data-target="tab-image">以象取卦</button>
    </div>

    <div id="tab-number" class="tab-content active">
      <h3>數字取卦</h3>
      <div class="row">
        <input id="numUpper" type="number" placeholder="上卦數字 (100-999)" min="100" max="999" />
    
     <input id="numLower" type="number" placeholder="下卦數字 (100-999)" min="100" max="999" />
        <input id="numMoving" type="number" placeholder="動爻數字 (100-999)" min="100" max="999" />
        <button id="btnNumber" class="primary">生成卦象</button>
      </div>
      <div class="row"><span class="hint">提示：輸入 100–999。上/下卦 = 數字 % 8（0 視為 8），動爻 = 數字 % 6（0 視為 6）。頁面載入會隨機預設三個數字。</span></div>
    </div>

    <div id="tab-manual" class="tab-content">
      <h3>手動取卦</h3>
      <div class="row">
        <select id="selUpper">
     
       <option value="1">乾</option><option value="2">兌</option><option value="3">離</option><option value="4">震</option>
          <option value="5">巽</option><option value="6">坎</option><option value="7">艮</option><option value="8">坤</option>
        </select>
        <select id="selLower">
          <option value="1">乾</option><option value="2">兌</option><option value="3">離</option><option value="4">震</option>
          <option value="5">巽</option><option value="6">坎</option><option value="7">艮</option><option value="8">坤</option>
        </select>
        <input id="inputMoving" type="text" placeholder="變爻 (例: 1,3 或 2)" />
        
 <button id="btnManual" class="primary">生成卦象</button>
      </div>
    </div>

    <div id="tab-time" class="tab-content">
      <h3>時間取卦（梅花易）</h3>
      <div class="row" style="align-items: center;
 gap: 15px;">
        <label>
          <input type="radio" name="time-method" value="modern" checked> 現代時間
        </label>
        <label>
          <input type="radio" name="time-method" value="traditional"> 傳統時辰
        </label>
      </div>

      <div id="time-modern" class="time-input-group">
        <div class="row">
          <input id="dtInput" type="datetime-local" />
  
          <span id="nowQuick" class="pill">使用現在時間</span>
        </div>
      </div>
      
      <div id="time-traditional" class="time-input-group hidden">
        <div class="row">
          <input id="dateInput" type="date" />
          <select id="shichenInput">
            <option value="1">子時 (23-1)</option>
            <option value="2">丑時 
 (1-3)</option>
            <option value="3">寅時 (3-5)</option>
            <option value="4">卯時 (5-7)</option>
            <option value="5">辰時 (7-9)</option>
            <option value="6">巳時 (9-11)</option>
            <option value="7">午時 (11-13)</option>
            <option value="8">未時 (13-15)</option>
            <option value="9">申時 (15-17)</option>
  
            <option value="10">酉時 (17-19)</option>
            <option value="11">戌時 (19-21)</option>
            <option value="12">亥時 (21-23)</option>
          </select>
          <input id="minuteInput" type="number" placeholder="分 (0-59)" min="0" max="59" value="0" style="width: 100px;"/>
        </div>
      </div>

      <div class="row">
        <button id="btnTime" 
 class="primary">生成卦象</button>
      </div>
      <div id="timeHint" class="row"><span class="hint">算法：上卦 = (年+月+日) % 8；下卦 = (年+月+日+時) % 8；動爻 = (年+月+日+時+分) % 6；餘數為 0 則視為 8 或 6。</span></div>
    </div>

    <div id="tab-image" class="tab-content">
      <h3>以象取卦</h3>
      <div class="row">
        <label>上卦：</label>
        <select id="upperImageSelect" style="min-width:260px">
          <option value="1">乾（金）—天、圓、馬、父</option>
          <option value="2">兌（金）—澤、口、悅、羊</option>
     
       <option value="3">離（火）—日、電、目、中女</option>
          <option value="4">震（木）—雷、動、竹、長男</option>
          <option value="5">巽（木）—風、入、雞、長女</option>
          <option value="6">坎（水）—水、陷、耳、中男</option>
          <option value="7">艮（土）—山、止、手、少男</option>
          <option value="8">坤（土）—地、母、牛、腹</option>
        </select>
      </div>
      <div class="row">
        <label>下卦（後天方位）：</label>
        <select id="lowerDirectionSelect">
 
          <option value="6">北（坎）</option><option value="3">南（離）</option><option value="4">東（震）</option><option value="2">西（兌）</option>
          <option value="7">東北（艮）</option><option value="1">西北（乾）</option><option value="5">東南（巽）</option><option value="8">西南（坤）</option>
        </select>
      </div>
      <div class="row">
        <input id="imageMovingInput" type="number" placeholder="動爻 1~6" min="1" max="6" style="width:110px" />
        <label><input id="imageUseMinute" type="checkbox" /> 用當前分鐘取動爻</label>
      </div>
      <div class="row">
        <button id="btnImage" class="primary">生成卦象</button>
 
      </div>
    </div>

    <div id="result" class="hidden">
      <h2>卦象結果</h2>

      <div class="gua-box">
        <h3 id="guaName"></h3>
        <div id="guaImage" class="gua-line"></div>
        <div id="guaNote" class="hint" style="margin-top:8px"></div>
      </div>

      <div class="gua-box">
        <h3 id="changeGuaName"></h3>
        <div id="changeGuaImage" class="gua-line"></div>
      </div>

    
      <div class="gua-box">
        <h3 id="huGuaName"></h3>
        <div id="huGuaImage" class="gua-line"></div>
      </div>

      <div id="line-explanation" class="gua-box hidden">
        <h3>動爻解釋（多變爻逐條列出）</h3>
        <div id="lineTextDisplay"></div>
      </div>

      <div id="judgeBox" class="gua-box hidden">
        <div class="row">
            <select id="questionSelector" style="flex-grow:1;">
        
         <option value="1">請選擇問事類別：</option>
                <option value="love">1.
 感情問題</option>
                <option value="career">2.
 工作/學業</option>
                <option value="wealth">3.
 財運問題</option>
                <option value="health">4.
 健康問題</option>
                <option value="relationship">5.
 人際關係</option>
                <option value="life">6.
 生活/運勢</option>
                <option value="guidance">7.
 尋找指引</option>
            </select>
            <button id="analyzeBtn" class="primary">分析</button>
        </div>

        <div id="questionAnalysisResult" class="question-analysis hidden"></div>

        <div id="wuxingAnalysis" class="wuxing-analysis hidden">
          <h4>梅花心易五行解卦（整體判斷）</h4>
          <div id="wuxingContent"></div>
        </div>
        
       
       <div id="detailedAnalysis" class="detailed-analysis hidden">
            <h4>詳細象徵分析（僅適用於單一動爻）</h4>
            <div id="detailedContent"></div>
        </div>
      </div>

      <div style="margin-top:8px"><button id="judgeBtn" class="primary">顯示綜合判斷</button></div>
    </div>
  </div>

  <script>
  /* ===========================
     資料：三爻（1..8）對應與工具
     =========================== */
  const guaTable = {
    // 數字 : [初爻, 二爻, 三爻, 五行]
    1:[1,1,1,'金'], 2:[1,1,0,'金'], 3:[1,0,1,'火'], 4:[1,0,0,'木'],
    
 5:[0,1,1,'木'], 6:[0,1,0,'水'], 7:[0,0,1,'土'], 8:[0,0,0,'土']
  };
  const trigramName = {1:'乾',2:'兌',3:'離',4:'震',5:'巽',6:'坎',7:'艮',8:'坤'};
  const triIndexByLines = new Map(Object.entries(guaTable).map(([i,arr])=>[JSON.stringify(arr.slice(0,3)), +i]));
  
  const trigramHealth = {
    '乾': '頭部、肺、大腸、骨骼',
    '兌': '口腔、舌、牙齒、咽喉、肺',
    '離': '心臟、眼睛、血液、小腸',
    '震': '肝、足、神經、筋脈',
    '巽': '膽、股、風疾、毛髮',
    '坎': '腎臟、膀胱、泌尿系統、耳',
    '艮': '脾、胃、鼻、背、手',
    '坤': '腹部、脾胃、肌肉'
  };

  let hexList = {};
  const hexByLines = new Map();
  const hexNameByCombinedName = new Map();
  let wuxingExplanations = {};
  let trigramExplanations = {};
  let dataReady = false;
  
  // 輔助函數：根據五行關係判斷吉凶
  function getWuxingOutcome(tiWuxing, yongWuxing) {
      const relations = {
          '金': { '生': '水', '剋': '木', '被生': '土', '被剋': '火', '比和': '金' },
          '木': { '生': '火', '剋': '土', '被生': '水', '被剋': '金', '比和': '木' },
          '水': { '生': '木', '剋': '火', '被生': '金', '被剋': '土', '比和': '水' },
          '火': { '生': '土', '剋': 
 '金', '被生': '木', '被剋': '水', '比和': '火' },
          '土': { '生': '金', '剋': '水', '被生': '火', '被剋': '木', '比和': '土' }
      };
 if (!tiWuxing || !yongWuxing) return { relation: '未知', status: '平', explanation: '五行資料不完整。' };

      let relationType, status;
 if (relations[yongWuxing]['生'] === tiWuxing) {
          relationType = '用生體';
          status = '大吉';
 } else if (relations[tiWuxing]['剋'] === yongWuxing) {
          relationType = '體克用';
 status = '吉';
      } else if (tiWuxing === yongWuxing) {
          relationType = '比和';
 status = '平';
      } else if (relations[tiWuxing]['生'] === yongWuxing) {
          relationType = '體生用';
 status = '凶';
      } else if (relations[yongWuxing]['剋'] === tiWuxing) {
          relationType = '用克體';
 status = '大凶';
      } else {
          relationType = '未知';
 status = '平';
      }

      return { relation: relationType, status: status };
 }
  
  // 異步載入所有 JSON 資料
  Promise.allSettled([
    fetch('hexagrams.json').then(r => r.ok ? r.json() : Promise.reject('無法載入 hexagrams.json')),
    fetch('quotes.json').then(r => r.ok ? r.json() : Promise.reject('無法載入 quotes.json')),
    fetch('wuxing_explanations.json').then(r => r.ok ? r.json() : Promise.reject('無法載入 wuxing_explanations.json')),
    fetch('trigram_explanations.json').then(r => r.ok ? r.json() : Promise.reject('無法載入 trigram_explanations.json'))
  ]).then(results => {
    results.forEach(res => {
      if (res.status === 'fulfilled') {
        if (res.value && typeof res.value === 'object' && res.value['乾為天'] && !Array.isArray(res.value)) {
        
          hexList = res.value;
            for (const hexName in hexList) {
                const entry = hexList[hexName];
                const entryWithNames = { ...entry, name: hexName, title: entry.title || hexName };
                const linesBinary = entryWithNames.lines.map(line => {
          
                  const text = line.text;
                    if (text.includes('九') || text.includes('七')) return 1;
 if (text.includes('六') || text.includes('八')) return 0;
                    return null;
                });
                if (linesBinary.every(val => val !== null)) {
                    hexByLines.set(JSON.stringify(linesBinary), entryWithNames);
 const uIdx = triIndexByLines.get(JSON.stringify(linesBinary.slice(3, 6)));
                    const lIdx = triIndexByLines.get(JSON.stringify(linesBinary.slice(0, 3)));
 if (uIdx && lIdx) {
                        const combinedName = `${trigramName[uIdx]}為${trigramName[lIdx]}`;
 hexNameByCombinedName.set(combinedName, hexName);
                    }
                }
            }
        } else if (res.value && Array.isArray(res.value) && typeof res.value[0] === 'string') {
          document.getElementById('subtitle').textContent = res.value[Math.floor(Math.random() * res.value.length)] ||
 '易有太極，是生兩儀，兩儀生四象，四象生八卦。';
        } else if (res.value && typeof res.value === 'object' && res.value['體克用']) {
          wuxingExplanations = res.value;
 } else if (res.value && typeof res.value === 'object' && res.value['乾']) {
          trigramExplanations = res.value;
 } else {
            console.warn('無法識別的 JSON 資料格式:', res.value);
 }
      } else {
          console.error(`檔案載入失敗：${res.reason}`);
 }
    });

    dataReady = true;
    console.log("所有資料載入完成！");
  }).catch(error => {
    console.error('檔案載入失敗，可能原因：檔案路徑錯誤或網路問題。', error);
    document.getElementById('subtitle').textContent = '資料載入失敗。請檢查檔案路徑。';
  });
 /* ---------------------------
     工具函數
     --------------------------- */
  function showTabById(id){
    document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
 document.querySelectorAll(`[data-target="${id}"]`).forEach(b => b.classList.add('active'));
    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
    document.getElementById(id)?.classList.add('active');
  }
  document.querySelectorAll('.tab-button').forEach(btn => btn.addEventListener('click', () => showTabById(btn.dataset.target)));
 function formatGuaNameByLines(lines){
    if (!lines || lines.length !== 6) return '卦象錯誤';
    const uIdx = triIndexByLines.get(JSON.stringify(lines.slice(3, 6)));
 const lIdx = triIndexByLines.get(JSON.stringify(lines.slice(0, 3)));
    const combinedName = `${trigramName[uIdx]}為${trigramName[lIdx]}`;
    return hexNameByCombinedName.get(combinedName) || combinedName;
 }

  function findHexEntryByLines(lines){
    return hexByLines.get(JSON.stringify(lines));
  }
  
  function getGuaHtml(lines, moving=[]){
    let html = '';
 for (let i = 5; i >= 0; i--) {
      const val = lines[i];
 const yaoNo = i + 1;
      const isMoving = (moving || []).includes(yaoNo);
 if (isMoving) {
          html += `<div class="gua-moving ${val === 1 ? 'yang' : 'yin'}"></div>`;
 } else {
          html += `<div class="${val === 1 ? 'gua-yang' : 'gua-yin'}"></div>`;
 }
    }
    return html;
 }

  function getLineEntryFor(hexEntry, yaoIndex){
    return hexEntry?.lines.find(line => line && line.index === yaoIndex) || null;
 }

  function escapeHtml(s){
    if (s === null || s === undefined) return '';
 return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;');
  }
  
  function getTrigramInfo(guaIdx) {
      const name = trigramName[guaIdx];
      return {
          id: guaIdx,
          name: name,
          wuxing: guaTable[guaIdx][3],
          explanations: trigramExplanations[name] || {}
      };
  }
  
  function getTiYong(result) {
      if (result.moving.length !== 1) return { tiGua: null, yongGua: 
 null };
      const uGua = getTrigramInfo(result.uIdx);
      const lGua = getTrigramInfo(result.lIdx);
      const movingYao = result.moving[0];
      
      if (movingYao >= 4 && movingYao <= 6) {
          return { tiGua: lGua, yongGua: uGua };
      } else {
          return { tiGua: uGua, yongGua: lGua };
      }
  }


  /* ---------------------------
 
     生成並顯示卦象（主流程）
     --------------------------- */
  let currentResult = null;

  function makeFromUpperLower(uIdx, lIdx){
    const upper = guaTable[uIdx] ||
 guaTable[1];
    const lower = guaTable[lIdx] || guaTable[1];
    return [...lower.slice(0,3), ...upper.slice(0,3)];
 }

  function generateGua(uIdx, lIdx, movingArr){
    const moving = Array.isArray(movingArr) ?
 movingArr.filter(x=>Number.isFinite(x) && x>=1 && x<=6) : [];
    const lines = makeFromUpperLower(uIdx, lIdx);
    
    const hexMain = findHexEntryByLines(lines);
 const mainName = hexMain ? hexMain.name : formatGuaNameByLines(lines);
    
    const changeLines = lines.slice();
 moving.forEach(n => { const idx = n - 1; if (idx>=0 && idx<6) changeLines[idx] = 1 - changeLines[idx]; });
 const hexChange = findHexEntryByLines(changeLines);
    const changeName = hexChange ? hexChange.name : formatGuaNameByLines(changeLines);

    const huLinesBase = [ lines[1], lines[2], lines[3] ];
 const huLinesTop = [ lines[2], lines[3], lines[4] ];
    const huLines = [...huLinesBase, ...huLinesTop];
    const hexHu = findHexEntryByLines(huLines);
 const huName = hexHu ? hexHu.name : formatGuaNameByLines(huLines);

    document.getElementById('guaName').textContent = mainName;
    document.getElementById('guaImage').innerHTML = getGuaHtml(lines, moving);
 document.getElementById('guaNote').textContent = (hexMain && hexMain.judgment && hexMain.judgment.overall) ? hexMain.judgment.overall : '（未找到綜合判斷）';

    document.getElementById('changeGuaName').textContent = `變卦：${changeName}`;
    document.getElementById('changeGuaImage').innerHTML = getGuaHtml(changeLines, []);
 document.getElementById('huGuaName').textContent = `互卦：${huName}`;
    document.getElementById('huGuaImage').innerHTML = getGuaHtml(huLines, []);

    const lineBox = document.getElementById('lineTextDisplay');
    lineBox.innerHTML = '';
 if (moving.length > 0) {
      if (hexMain && Array.isArray(hexMain.lines)) {
        moving.forEach(mv => {
          const le = getLineEntryFor(hexMain, mv);
          const text = escapeHtml(le?.text || '爻辭未找到');
          const meaning = escapeHtml(le?.meaning || '（無解釋）');
          lineBox.innerHTML += `<div><strong>第 ${mv} 爻：</strong>${text}<div class="hint">${meaning}</div></div>`;
        });
 } else {
        moving.forEach(mv => {
          lineBox.innerHTML += `<div><strong>第 ${mv} 爻：</strong><em>（無法載入爻辭，請檢查 hexagrams.json）</em></div>`;
        });
 }
      document.getElementById('line-explanation').classList.remove('hidden');
    } else {
      document.getElementById('line-explanation').classList.add('hidden');
 }

    document.getElementById('result').classList.remove('hidden');
    document.getElementById('judgeBox').classList.add('hidden');
    document.getElementById('questionAnalysisResult').classList.add('hidden');
    document.getElementById('questionSelector').value = '1';
 currentResult = { uIdx, lIdx, moving, lines, hexMain, hexChange, huLines, hexHu };
 }

  /* ---------------------------
     綁定：數字取卦（含隨機預設）
     --------------------------- */
  function rand100to999(){ return Math.floor(Math.random()*900) + 100;
 }
  document.getElementById('numUpper').value = rand100to999();
  document.getElementById('numLower').value = rand100to999();
  document.getElementById('numMoving').value = rand100to999();
 document.getElementById('btnNumber').addEventListener('click', ()=>{
    const a = Number(document.getElementById('numUpper').value);
    const b = Number(document.getElementById('numLower').value);
    const c = Number(document.getElementById('numMoving').value);
    if (![a,b,c].every(x => Number.isInteger(x) && x >= 100 && x <= 999)) {
      alert('請輸入 100 到 999 的整數（或重新整理頁面取得隨機值）。');
      return;
    }
    const u = (a % 8) || 8;
    const l = (b % 8) || 8;
    const m = (c % 6) || 6;
    generateGua(u, l, [m]);
  });
 /* ---------------------------
     綁定：手動取卦
     --------------------------- */
  document.getElementById('btnManual').addEventListener('click', ()=>{
    const u = Number(document.getElementById('selUpper').value);
    const l = Number(document.getElementById('selLower').value);
    const raw = (document.getElementById('inputMoving').value || '').trim();
    const ms = raw === '' ? [] : raw.split(',').map(s => parseInt(s.trim(),10)).filter(x => Number.isInteger(x) && x>=1 && x<=6);
    generateGua(u, l, ms);
  });
 /* ---------------------------
     綁定：時間取卦（梅花易）初始化與處理
     --------------------------- */
  function pad(n){ return String(n).padStart(2,'0');
 }
  function localDatetimeForInput(d){ return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`; }

  // 新增：處理時間取卦的UI切換
  document.querySelectorAll('input[name="time-method"]').forEach(radio => {
    radio.addEventListener('change', (e) => {
      const method = e.target.value;
      const modernDiv = document.getElementById('time-modern');
      const traditionalDiv = document.getElementById('time-traditional');
      if (method === 'modern') {
        modernDiv.classList.remove('hidden');
        traditionalDiv.classList.add('hidden');
        document.getElementById('timeHint').textContent = '算法：上卦 = (年+月+日) % 8；下卦 = (年+月+日+時) % 8；動爻 = (年+月+日+時+分) % 6；餘數為 0 則視為 8 或 6。';
      } else {
        modernDiv.classList.add('hidden');
        traditionalDiv.classList.remove('hidden');
        document.getElementById('timeHint').textContent = '算法：上卦 = (年+月+日) % 8；下卦 = (年+月+日+時辰) % 8；動爻 = (年+月+日+時辰+分) % 6；餘數為 0 則視為 8 或 6。';
      }
    });
  });
 document.getElementById('dtInput').value = localDatetimeForInput(new Date());
  document.getElementById('nowQuick').addEventListener('click', () => document.getElementById('dtInput').value = localDatetimeForInput(new Date()));
 document.getElementById('btnTime').addEventListener('click', ()=>{
    const method = document.querySelector('input[name="time-method"]:checked').value;
    let y, mo, da, h, mi;

    if (method === 'modern') {
      const val = document.getElementById('dtInput').value;
      if (!val) { alert('請先選擇日期時間'); return; }
      const d = new Date(val);
      y = d.getFullYear(), mo = d.getMonth()+1, da = d.getDate(), h = d.getHours(), mi = d.getMinutes();
    } else { // Traditional method
      const dateVal = document.getElementById('dateInput').value;
      const 
 shichenVal = Number(document.getElementById('shichenInput').value);
      const minuteVal = Number(document.getElementById('minuteInput').value);
      if (!dateVal || !shichenVal || !Number.isInteger(minuteVal) || minuteVal < 0 || minuteVal > 59) {
        alert('請輸入有效的日期、時辰和分。');
        return;
      }
      const d = new Date(dateVal);
      y = d.getFullYear(), mo = d.getMonth()+1, da = d.getDate();
      h = shichenVal; // 使用時辰的數字值
      mi = minuteVal;
 }

    const ymd = y + mo + da;
    const u = (ymd % 8) || 8;
 const l = ((ymd + h) % 8) || 8;
 const m = ((ymd + h + mi) % 6) || 6;
    generateGua(u, l, [m]);
  });
 /* ---------------------------
     綁定：以象取卦
     --------------------------- */
  document.getElementById('btnImage').addEventListener('click', ()=>{
    const u = Number(document.getElementById('upperImageSelect').value);
    const l = Number(document.getElementById('lowerDirectionSelect').value);
    let m;
    if (document.getElementById('imageUseMinute').checked) {
      const d = new Date();
      const ymd = d.getFullYear() + (d.getMonth()+1) + d.getDate();
      m = ((ymd + d.getHours() + d.getMinutes()) % 6) || 6;
    } else {
      const raw = Number(document.getElementById('imageMovingInput').value) || 1;
    
   m = (raw % 6) || 6;
    }
    generateGua(u, l, [m]);
  });
 /* ---------------------------
     梅花心易五行解卦
     --------------------------- */
  function renderWuxingAnalysis(result) {
      const analysisDiv = document.getElementById('wuxingAnalysis');
 const contentDiv = document.getElementById('wuxingContent');
      contentDiv.innerHTML = '';
      
      if (result.moving.length !== 1) {
          analysisDiv.classList.remove('hidden');
 contentDiv.innerHTML = '<div class="analysis-message">此「五行解卦」功能僅適用於單一動爻的梅花心易斷卦法。若為多爻變，則應以爻辭和變卦卦辭來綜合判斷。</div>';
          return;
      }
      
      analysisDiv.classList.remove('hidden');
 const { tiGua, yongGua } = getTiYong(result);
      if (!tiGua || !yongGua) {
          analysisDiv.classList.add('hidden');
 return;
      }

      // 本卦分析
      const mainEffect = getWuxingOutcome(tiGua.wuxing, yongGua.wuxing);
 const mainExplanation = wuxingExplanations[mainEffect.relation]?.['overall'] || '（此類別無詳細解釋）';
      const mainDesc = `**體卦**（您）為 **${tiGua.name}** 屬 **${tiGua.wuxing}**，**用卦**（外在事物）為 **${yongGua.name}** 屬 **${yongGua.wuxing}**。`;
 contentDiv.innerHTML += `<div class="wuxing-box">**本卦：**<span class="wuxing-status ${mainEffect.status}">${mainEffect.relation}</span><div class="wuxing-desc">${mainDesc}<br>${mainExplanation}</div></div>`;
 // 互卦分析
      const huLines = result.huLines;
      const huLowerId = triIndexByLines.get(JSON.stringify(huLines.slice(0,3)));
      const huUpperId = triIndexByLines.get(JSON.stringify(huLines.slice(3,6)));
      const huLGua = getTrigramInfo(huLowerId);
 const huUGua = getTrigramInfo(huUpperId);
      const huOutcome = getWuxingOutcome(tiGua.wuxing, huLGua.wuxing);
      const huExplanation = wuxingExplanations[huOutcome.relation]?.['overall'] || '（此類別無詳細解釋）';
 let guaAnalysisHtml = `<div class="analysis-item"><h4>第二層：互卦（過程分析）</h4><p>體卦屬 **${tiGua.wuxing}**，互卦（代表過程）屬 **${huLGua.wuxing}** 與 **${huUGua.wuxing}**。<br>五行關係為：**${huOutcome.relation}**。這顯示事情在過程中將會：<br><span class="analysis-status ${huOutcome.status}">${huExplanation}</span></p>`;
      if (trigramExplanations[huLGua.name] || trigramExplanations[huUGua.name]) {
          guaAnalysisHtml += `<div class="trigram-details"><strong>互卦取象：</strong><br>`;
 if (trigramExplanations[huLGua.name]?.life) {
              guaAnalysisHtml += `**下互卦**（${huLGua.name}）：${trigramExplanations[huLGua.name].life}<br>`;
          }
          if (trigramExplanations[huUGua.name]?.life) {
              guaAnalysisHtml += `**上互卦**（${huUGua.name}）：${trigramExplanations[huUGua.name].life}`;
          }
          guaAnalysisHtml += `</div>`;
 }
      guaAnalysisHtml += `</div>`;
      contentDiv.innerHTML += guaAnalysisHtml;
 // 變卦：最終結果
      const changeLines = result.changeLines;
      const changeLowerId = triIndexByLines.get(JSON.stringify(changeLines.slice(0,3)));
 const changeUpperId = triIndexByLines.get(JSON.stringify(changeLines.slice(3,6)));
      const changeGua = (result.moving[0] <= 3) ? getTrigramInfo(changeLowerId) : getTrigramInfo(changeUpperId);
      const changeOutcome = getWuxingOutcome(tiGua.wuxing, changeGua.wuxing);
 const changeExplanation = wuxingExplanations[changeOutcome.relation]?.['overall'] || '（此類別無詳細解釋）';
      guaAnalysisHtml = `<div class="analysis-item"><h4>第三層：變卦（結果分析）</h4><p>體卦屬 **${tiGua.wuxing}**，變卦（代表結果）屬 **${changeGua.wuxing}**。<br>五行關係為：**${changeOutcome.relation}**。這代表最終的結果將會是：<br><span class="analysis-status ${changeOutcome.status}">${changeExplanation}</span></p>`;
 if (trigramExplanations[changeGua.name]?.life) {
          guaAnalysisHtml += `<div class="trigram-details"><strong>變卦取象：</strong><br>`;
          guaAnalysisHtml += `**變卦**（${changeGua.name}）：${trigramExplanations[changeGua.name].life}`;
          guaAnalysisHtml += `</div>`;
      }
      guaAnalysisHtml += `</div>`;
      contentDiv.innerHTML += guaAnalysisHtml;
 }

  function renderQuestionAnalysis(result, questionType) {
      const analysisDiv = document.getElementById('questionAnalysisResult');
      analysisDiv.innerHTML = '';
      
      const analysisMap = {
          'love': '感情問題', 'career': '工作/學業', 'wealth': '財運問題', 'health': '健康問題', 'relationship': '人際關係', 'life': '生活/運勢', 'guidance': '尋找指引'
      };
      
      const questionTitle = analysisMap[questionType];
      if (!questionTitle) {
          analysisDiv.classList.add('hidden');
          return;
      }
      analysisDiv.classList.remove('hidden');

      if (questionType === 'health') {
          // 健康分析邏輯
          const mainUName = trigramName[result.uIdx];
          const mainLName = trigramName[result.lIdx];
          const mainHealthU = trigramHealth[mainUName];
          const mainHealthL = trigramHealth[mainLName];

          const changeUName = trigramName[triIndexByLines.get(JSON.stringify(result.changeLines.slice(3, 6)))];
          const changeLName = trigramName[triIndexByLines.get(JSON.stringify(result.changeLines.slice(0, 3)))];
          const changeHealthU = trigramHealth[changeUName];
          const changeHealthL = trigramHealth[changeLName];

          let healthHtml = `<div class="analysis-item"><h4>卦象健康推論</h4>`;
          healthHtml += `<p><strong>主卦（當前狀況）:</strong></p>`;
          healthHtml += `<div class="trigram-details">`;
          healthHtml += `上卦：<strong>${mainUName}</strong>，對應身體部位：${mainHealthU}。`;
          healthHtml += `下卦：<strong>${mainLName}</strong>，對應身體部位：${mainHealthL}。`;
          healthHtml += `</div>`;

          healthHtml += `<p><strong>變卦（未來趨勢）:</strong></p>`;
          healthHtml += `<div class="trigram-details">`;
          healthHtml += `上卦：<strong>${changeUName}</strong>，可能影響的身體部位：${changeHealthU}。`;
          healthHtml += `下卦：<strong>${changeLName}</strong>，可能影響的身體部位：${changeHealthL}。`;
          healthHtml += `</div></div>`;

          healthHtml += `<div class="analysis-item"><h4>綜合歸納與建議</h4>`;
          healthHtml += `<div class="analysis-message">此卦象暗示您應特別留意<strong>${mainHealthL}</strong>與<strong>${mainHealthU}</strong>相關的健康狀況。同時，變卦提醒您，若不加以注意，問題可能會演變並影響到<strong>${changeHealthL}</strong>與<strong>${changeHealthU}</strong>。</div>`;
          healthHtml += `<div class="suggestion"><h5>建議您：</h5>`;
          healthHtml += `<ul><li>注重飲食與作息調整，以保養相關器官。</li>`;
          healthHtml += `<li>若有不適，建議諮詢專業醫療人員，此推論僅供參考。</li></ul></div></div>`;

          analysisDiv.innerHTML += healthHtml;
          return;
      }
      
      // 其他問事類別的原始分析邏輯
      if (result.moving.length !== 1) {
          analysisDiv.innerHTML = `<div class="analysis-message">此「五行解卦」功能僅適用於單一動爻的梅花心易斷卦法。若為多爻變，則應以爻辭和變卦卦辭來綜合判斷。</div>`;
          return;
      }
      const { tiGua, yongGua } = getTiYong(result);
      if (!tiGua || !yongGua) {
          analysisDiv.innerHTML = `<div class="analysis-item"><h4>${questionTitle}：總體解讀</h4><p>無法判斷體用關係，請檢查動爻數量。</p></div>`;
          return;
      }
      // 1. 卦辭與爻辭總結
      let judgmentText = result.hexMain?.judgment?.overall || '（卦辭未提供詳細判斷）';
      const yaoCi = getLineEntryFor(result.hexMain, result.moving[0]);
      analysisDiv.innerHTML += `<div class="analysis-item"><h4>${questionTitle}：總體解讀</h4><p>卦辭：${judgmentText}</p><p>動爻爻辭：${(yaoCi?.text || '無')}</p></div>`;
      // 2. 五行生剋分層次分析
      // 本卦：現況分析
      const mainOutcome = getWuxingOutcome(tiGua.wuxing, yongGua.wuxing);
      const mainExplanation = wuxingExplanations[mainOutcome.relation]?.[questionType] || wuxingExplanations[mainOutcome.relation]?.['overall'] || '（此類別無詳細解釋）';
      let mainAnalysisHtml = `<div class="analysis-item"><h4>第一層：本卦（現況分析）</h4><p>此問事對應的五行關係為：體卦 **${tiGua.wuxing}**，用卦 **${yongGua.wuxing}**。<br>五行關係為：**${mainOutcome.relation}**，這代表目前的狀況：<br><span class="analysis-status ${mainOutcome.status}">${mainExplanation}</span></p>`;
      if (trigramExplanations[tiGua.name] || trigramExplanations[yongGua.name]) {
          mainAnalysisHtml += `<div class="trigram-details"><strong>體用取象：</strong><br>`;
          if (trigramExplanations[tiGua.name]?.[questionType]) {
              mainAnalysisHtml += `**體卦**（您）為 ${tiGua.name}：${trigramExplanations[tiGua.name][questionType]}<br>`;
          }
          if (trigramExplanations[yongGua.name]?.[questionType]) {
              mainAnalysisHtml += `**用卦**（事）為 ${yongGua.name}：${trigramExplanations[yongGua.name][questionType]}`;
          }
          mainAnalysisHtml += `</div>`;
      }
      mainAnalysisHtml += `</div>`;
      analysisDiv.innerHTML += mainAnalysisHtml;

      // 互卦：過程分析
      const huLines = result.huLines;
      const huLowerId = triIndexByLines.get(JSON.stringify(huLines.slice(0,3)));
      const huUpperId = triIndexByLines.get(JSON.stringify(huLines.slice(3,6)));
      const huLGua = getTrigramInfo(huLowerId);
      const huUGua = getTrigramInfo(huUpperId);
      const huOutcome = getWuxingOutcome(tiGua.wuxing, huUGua.wuxing);
      const huExplanation = wuxingExplanations[huOutcome.relation]?.[questionType] || wuxingExplanations[huOutcome.relation]?.['overall'] || '（此類別無詳細解釋）';
      let huAnalysisHtml = `<div class="analysis-item"><h4>第二層：互卦（過程分析）</h4><p>互卦代表事情的發展過程，五行關係為：**${huOutcome.relation}**。<br>這顯示過程中將會：<br><span class="analysis-status ${huOutcome.status}">${huExplanation}</span></p>`;
      if (trigramExplanations[huLGua.name] || trigramExplanations[huUGua.name]) {
          huAnalysisHtml += `<div class="trigram-details"><strong>互卦取象：</strong><br>`;
          if (trigramExplanations[huLGua.name]?.[questionType]) {
              huAnalysisHtml += `**下互卦**（${huLGua.name}）：${trigramExplanations[huLGua.name][questionType]}<br>`;
          }
          if (trigramExplanations[huUGua.name]?.[questionType]) {
              huAnalysisHtml += `**上互卦**（${huUGua.name}）：${trigramExplanations[huUGua.name][questionType]}`;
          }
          huAnalysisHtml += `</div>`;
      }
      huAnalysisHtml += `</div>`;
      analysisDiv.innerHTML += huAnalysisHtml;

      // 變卦：結果分析
      const changeLines = result.changeLines;
      const changeLowerId = triIndexByLines.get(JSON.stringify(changeLines.slice(0,3)));
      const changeUpperId = triIndexByLines.get(JSON.stringify(changeLines.slice(3,6)));
      const changeGua = (result.moving[0] <= 3) ? getTrigramInfo(changeLowerId) : getTrigramInfo(changeUpperId);
      const changeOutcome = getWuxingOutcome(tiGua.wuxing, changeGua.wuxing);
      const changeExplanation = wuxingExplanations[changeOutcome.relation]?.[questionType] || wuxingExplanations[changeOutcome.relation]?.['overall'] || '（此類別無詳細解釋）';
      let changeAnalysisHtml = `<div class="analysis-item"><h4>第三層：變卦（結果分析）</h4><p>變卦代表最終的結果，五行關係為：**${changeOutcome.relation}**。<br>這顯示最終的結果將會是：<br><span class="analysis-status ${changeOutcome.status}">${changeExplanation}</span></p>`;
      if (trigramExplanations[changeGua.name]?.[questionType]) {
          changeAnalysisHtml += `<div class="trigram-details"><strong>變卦取象：</strong><br>`;
          changeAnalysisHtml += `**變卦**（${changeGua.name}）：${trigramExplanations[changeGua.name][questionType]}`;
          changeAnalysisHtml += `</div>`;
      }
      changeAnalysisHtml += `</div>`;
      analysisDiv.innerHTML += changeAnalysisHtml;
  }

  function renderDetailedAnalysis(result) {
      if (result.moving.length !== 1) {
          document.getElementById('detailedAnalysis').classList.add('hidden');
          return;
      }
      document.getElementById('detailedAnalysis').classList.remove('hidden');
      const analysisDiv = document.getElementById('detailedContent');
      analysisDiv.innerHTML = '';
      const { hexMain, hexChange } = result;
      const yao = getLineEntryFor(hexMain, result.moving[0]);
      if (!yao) {
          analysisDiv.innerHTML = `<div class="analysis-message">無法載入爻辭資料，請檢查 hexagrams.json 檔案。</div>`;
          return;
      }
      
      const detailedSymbolism = yao.detailed_symbolism;
      if (!detailedSymbolism || Object.keys(detailedSymbolism).length === 0) {
          analysisDiv.innerHTML = `<div class="analysis-message">此爻辭沒有提供詳細的象徵分析資料。</div>`;
          return;
      }

      let detailedContent = `
        <div class="detailed-section">
            <h5>動爻象徵分析：</h5>
            <ul>
      `;
      const categories = ['people', 'affairs', 'time', 'place', 'object'];
      const categoryLabels = {
          'people': '人', 'affairs': '事', 'time': '時', 'place': '地', 'object': '物'
      };
      
      categories.forEach(key => {
          if (detailedSymbolism[key]) {
              detailedContent += `<li><strong>${categoryLabels[key]}</strong>：${detailedSymbolism[key]}</li>`;
          }
      });
      
      detailedContent += `
                </ul>
            </div>
      `;
      analysisDiv.innerHTML += detailedContent;

      const changeSymbolism = hexChange?.detailed_symbolism;
      if (!changeSymbolism || Object.keys(changeSymbolism).length === 0) {
          analysisDiv.innerHTML += `<div class="analysis-message">無法載入變卦的詳細象徵資料。</div>`;
          return;
      }

      let changeContent = `
        <div class="detailed-section">
            <h5>變卦象徵分析：</h5>
            <div class="trigram-details">
                <ul>
      `;
      const changeCategories = ['people', 'affairs', 'time', 'place', 'object'];
      const changeCategoryLabels = {
          'people': '人', 'affairs': '事', 'time': '時', 'place': '地', 'object': '物'
      };
      
      changeCategories.forEach(key => {
          if (changeSymbolism[key]) {
              changeContent += `<li><strong>${changeCategoryLabels[key]}</strong>：${changeSymbolism[key]}</li>`;
          }
      });
      
      changeContent += `
                </ul>
            </div>
        </div>
      `;
      analysisDiv.innerHTML += changeContent;

    } else {
        analysisDiv.innerHTML += `<div class="analysis-message">無法載入爻辭資料，請檢查 hexagrams.json 檔案。</div>`;
    }
  }


  document.getElementById('judgeBtn').addEventListener('click', ()=>{
    if (!currentResult) { alert('請先生成卦象'); return; }
    document.getElementById('judgeBox').classList.remove('hidden');
    renderWuxingAnalysis(currentResult);
    renderDetailedAnalysis(currentResult);
  });
  
  document.getElementById('analyzeBtn').addEventListener('click', ()=>{
      if (!dataReady) {
          alert('資料仍在載入中，請稍候再試。');
          return;
      }
      const questionType = document.getElementById('questionSelector').value;
      if (questionType === '1') {
          alert('請先選擇一個問事類別！');
          return;
      }

      // 根據動爻數量，決定呼叫哪個函式
      if (currentResult.moving.length === 1) {
          renderQuestionAnalysis(currentResult, questionType);
      } else if (currentResult.moving.length > 1) {
          // 對多爻變，只顯示爻辭和卦辭
          const analysisDiv = document.getElementById('questionAnalysisResult');
          analysisDiv.innerHTML = '';
          analysisDiv.classList.remove('hidden');
          analysisDiv.innerHTML += `<div class="analysis-message">多爻變的解讀以爻辭和卦辭為主，不適用於五行生剋與體用分析。請參考卦象的綜合判斷和各動爻的解釋。</div>`;
      } else {
          // 無動爻，只顯示卦辭
          const analysisDiv = document.getElementById('questionAnalysisResult');
          analysisDiv.innerHTML = '';
          analysisDiv.classList.remove('hidden');
          analysisDiv.innerHTML += `<div class="analysis-message">此卦為靜卦，沒有動爻。請參考本卦的卦辭與象徵來解讀。</div>`;
      }
  });

  </script>
</body>
</html>
