<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>張老師易經卜卦</title>
  <style>
    /* 新的整體佈局與美化 */
    :root {
      --main-bg-color: #f0f2f5;
      --card-bg-color: #ffffff;
      --border-color: #e0e0e0;
      --primary-color: #3b5998; /* Facebook blue */
      --text-color: #1c1e21;
      --secondary-text-color: #65676b;
      --hover-color: #f0f2f5;
    }

    body {
      font-family: "Noto Sans TC", sans-serif;
      background-color: var(--main-bg-color);
      color: var(--text-color);
      padding: 24px;
      line-height: 1.6;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      background-color: var(--card-bg-color);
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      padding: 24px;
    }

    h1 {
      font-size: 28px;
      margin-bottom: 8px;
    }

    h2.subtitle {
      font-size: 16px;
      font-weight: 400;
      color: var(--secondary-text-color);
      margin-top: 0;
      margin-bottom: 24px;
    }

    /* Tab 按鈕區塊 */
    .tab-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 20px;
    }

    .tab-button {
      padding: 10px 18px;
      border: none;
      border-radius: 8px;
      background-color: var(--main-bg-color);
      color: var(--text-color);
      cursor: pointer;
      font-size: 15px;
      transition: background-color 0.3s, transform 0.2s;
    }

    .tab-button.active {
      background-color: var(--primary-color);
      color: #fff;
    }

    .tab-button:hover:not(.active) {
      background-color: var(--border-color);
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* 通用元件 */
    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
      margin-bottom: 12px;
    }
    
    .row-justify {
      justify-content: space-between;
    }

    .hint {
      font-size: 13px;
      color: var(--secondary-text-color);
    }

    .pill {
      display: inline-block;
      padding: 6px 12px;
      border-radius: 20px;
      background-color: var(--main-bg-color);
      font-size: 14px;
      color: var(--secondary-text-color);
      cursor: pointer;
      transition: background-color 0.3s;
    }

    .pill:hover {
      background-color: #e4e6eb;
    }

    button.primary {
      padding: 10px 20px;
      background-color: var(--primary-color);
      color: #fff;
      border-radius: 8px;
      border: none;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.3s, transform 0.2s;
    }

    button.primary:hover {
      background-color: #2e4474;
      transform: translateY(-1px);
    }

    input[type="number"],
    input[type="text"],
    input[type="datetime-local"],
    input[type="date"],
    select {
      flex: 1;
      min-width: 150px;
      padding: 10px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      font-size: 15px;
      color: var(--text-color);
      background-color: #fbfbfb;
    }

    .hidden {
      display: none !important;
    }

    /* 卦象顯示區 */
    .gua-section {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .gua-box {
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 16px;
      background-color: var(--main-bg-color);
      transition: box-shadow 0.3s;
    }

    .gua-box:hover {
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .gua-box h3 {
      margin-top: 0;
      font-size: 18px;
    }

    .gua-line {
      font-family: 'Courier New', monospace;
      font-size: 20px;
      line-height: 1.2;
    }
    .gua-line div {
      padding: 2px 0;
    }
    .gua-yang {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 1.2em;
    }
    .gua-yang::before {
      content: '';
      width: 100%;
      height: 6px;
      background: #222;
      border-radius: 3px;
    }
    .gua-yin {
      display: flex;
      align-items: center;
      justify-content: space-between;
      height: 1.2em;
    }
    .gua-yin::before, .gua-yin::after {
      content: '';
      width: 45%;
      height: 6px;
      background: #222;
      border-radius: 3px;
    }
    .gua-moving {
      font-weight: bold;
      color: #b71c1c;
      display: flex;
      align-items: center;
      justify-content: center;
      height: 1.2em;
    }
    .gua-moving.yang::before {
      content: '';
      width: 100%;
      height: 6px;
      background: #b71c1c;
      border-radius: 3px;
    }
    .gua-moving.yang::after {
      content: '◎';
      margin-left: 8px;
      font-size: 0.8em;
      color: #b71c1c;
    }
    .gua-moving.yin::before, .gua-moving.yin::after {
      content: '×';
      margin-right: 8px;
      font-size: 0.8em;
      color: #b71c1c;
    }

    /* 動爻解釋區 */
    .line-explanation-container {
      margin-top: 20px;
    }
    .line-explanation-item {
      margin-bottom: 15px;
      padding-bottom: 15px;
      border-bottom: 1px dashed var(--border-color);
    }
    .line-explanation-item strong {
      display: block;
      font-size: 16px;
      margin-bottom: 4px;
    }
    
    /* 綜合分析區塊 */
    .analysis-section {
      margin-top: 24px;
      padding-top: 24px;
      border-top: 2px solid var(--border-color);
    }
    
    .analysis-container {
      display: flex;
      flex-direction: column;
      gap: 20px;
      margin-top: 20px;
    }
    
    .analysis-card {
      background-color: #f9f9f9;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
    }

    .analysis-card h4 {
      margin-top: 0;
      margin-bottom: 12px;
      font-size: 18px;
      color: var(--primary-color);
    }

    .analysis-card p,
    .analysis-card ul {
      font-size: 15px;
      margin-top: 0;
      margin-bottom: 8px;
      line-height: 1.6;
    }

    .analysis-card li {
      margin-bottom: 4px;
    }

    .wuxing-item {
      padding: 12px;
      background-color: #fff;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      margin-bottom: 10px;
    }

    .wuxing-status {
      font-weight: bold;
    }
    .wuxing-status.大吉 { color: #4CAF50; }
    .wuxing-status.吉 { color: #8BC34A; }
    .wuxing-status.平 { color: #FFC107; }
    .wuxing-status.凶 { color: #FF5722; }
    .wuxing-status.大凶 { color: #F44336; }

    .detailed-section h5 {
      margin-top: 0;
      margin-bottom: 8px;
      color: #65676b;
      font-size: 16px;
    }
    
    .analysis-message {
      padding: 15px;
      background-color: #fff3e0;
      border-left: 4px solid #ff9800;
      border-radius: 6px;
      font-size: 15px;
      color: #333;
    }

  </style>
</head>
<body>
  <div class="container">
    <h1>張老師易經卜卦</h1>
    <h2 id="subtitle" class="subtitle">載入中…（若無 quotes.json 顯示預設句）</h2>

    <div class="tab-buttons">
      <button class="tab-button active" data-target="tab-number">數字取卦</button>
      <button class="tab-button" data-target="tab-manual">手動取卦</button>
      <button class="tab-button" data-target="tab-time">時間取卦（梅花易）</button>
      <button class="tab-button" data-target="tab-image">以象取卦</button>
    </div>

    <div id="tab-number" class="tab-content active">
      <h3>數字取卦</h3>
      <div class="row">
        <input id="numUpper" type="number" placeholder="上卦數字 (100-999)" min="100" max="999" />
        <input id="numLower" type="number" placeholder="下卦數字 (100-999)" min="100" max="999" />
        <input id="numMoving" type="number" placeholder="動爻數字 (100-999)" min="100" max="999" />
        <button id="btnNumber" class="primary">生成卦象</button>
      </div>
      <div class="row"><span class="hint">提示：輸入 100–999。上/下卦 = 數字 % 8（0 視為 8），動爻 = 數字 % 6（0 視為 6）。頁面載入會隨機預設三個數字。</span></div>
    </div>

    <div id="tab-manual" class="tab-content">
      <h3>手動取卦</h3>
      <div class="row">
        <select id="selUpper">
          <option value="1">乾</option><option value="2">兌</option><option value="3">離</option><option value="4">震</option>
          <option value="5">巽</option><option value="6">坎</option><option value="7">艮</option><option value="8">坤</option>
        </select>
        <select id="selLower">
          <option value="1">乾</option><option value="2">兌</option><option value="3">離</option><option value="4">震</option>
          <option value="5">巽</option><option value="6">坎</option><option value="7">艮</option><option value="8">坤</option>
        </select>
        <input id="inputMoving" type="text" placeholder="變爻 (例: 1,3 或 2)" />
        <button id="btnManual" class="primary">生成卦象</button>
      </div>
    </div>

    <div id="tab-time" class="tab-content">
      <h3>時間取卦（梅花易）</h3>
      <div class="row" style="align-items: center; gap: 15px;">
        <label><input type="radio" name="time-method" value="modern" checked> 現代時間</label>
        <label><input type="radio" name="time-method" value="traditional"> 傳統時辰</label>
      </div>

      <div id="time-modern" class="time-input-group">
        <div class="row">
          <input id="dtInput" type="datetime-local" />
          <span id="nowQuick" class="pill">使用現在時間</span>
        </div>
      </div>
      
      <div id="time-traditional" class="time-input-group hidden">
        <div class="row">
          <input id="dateInput" type="date" />
          <select id="shichenInput">
            <option value="1">子時 (23-1)</option>
            <option value="2">丑時 (1-3)</option>
            <option value="3">寅時 (3-5)</option>
            <option value="4">卯時 (5-7)</option>
            <option value="5">辰時 (7-9)</option>
            <option value="6">巳時 (9-11)</option>
            <option value="7">午時 (11-13)</option>
            <option value="8">未時 (13-15)</option>
            <option value="9">申時 (15-17)</option>
            <option value="10">酉時 (17-19)</option>
            <option value="11">戌時 (19-21)</option>
            <option value="12">亥時 (21-23)</option>
          </select>
          <input id="minuteInput" type="number" placeholder="分 (0-59)" min="0" max="59" value="0" style="width: 100px;"/>
        </div>
      </div>

      <div class="row">
        <button id="btnTime" class="primary">生成卦象</button>
      </div>
      <div id="timeHint" class="row"><span class="hint">算法：上卦 = (年+月+日) % 8；下卦 = (年+月+日+時) % 8；動爻 = (年+月+日+時+分) % 6；餘數為 0 則視為 8 或 6。</span></div>
    </div>

    <div id="tab-image" class="tab-content">
      <h3>以象取卦</h3>
      <div class="row">
        <label>上卦：</label>
        <select id="upperImageSelect" style="min-width:260px">
          <option value="1">乾（金）—天、圓、馬、父</option>
          <option value="2">兌（金）—澤、口、悅、羊</option>
          <option value="3">離（火）—日、電、目、中女</option>
          <option value="4">震（木）—雷、動、竹、長男</option>
          <option value="5">巽（木）—風、入、雞、長女</option>
          <option value="6">坎（水）—水、陷、耳、中男</option>
          <option value="7">艮（土）—山、止、手、少男</option>
          <option value="8">坤（土）—地、母、牛、腹</option>
        </select>
      </div>
      <div class="row">
        <label>下卦（後天方位）：</label>
        <select id="lowerDirectionSelect">
          <option value="6">北（坎）</option><option value="3">南（離）</option><option value="4">東（震）</option><option value="2">西（兌）</option>
          <option value="7">東北（艮）</option><option value="1">西北（乾）</option><option value="5">東南（巽）</option><option value="8">西南（坤）</option>
        </select>
      </div>
      <div class="row">
        <input id="imageMovingInput" type="number" placeholder="動爻 1~6" min="1" max="6" style="width:110px" />
        <label><input id="imageUseMinute" type="checkbox" /> 用當前分鐘取動爻</label>
      </div>
      <div class="row">
        <button id="btnImage" class="primary">生成卦象</button>
      </div>
    </div>

    <div id="result" class="hidden">
      <h2>卦象結果</h2>

      <div class="gua-section">
        <div class="gua-box">
          <h3 id="guaName"></h3>
          <div id="guaImage" class="gua-line"></div>
          <div id="guaNote" class="hint" style="margin-top:8px"></div>
        </div>

        <div class="gua-box">
          <h3 id="changeGuaName"></h3>
          <div id="changeGuaImage" class="gua-line"></div>
        </div>

        <div class="gua-box">
          <h3 id="huGuaName"></h3>
          <div id="huGuaImage" class="gua-line"></div>
        </div>
      </div>

      <div id="line-explanation" class="line-explanation-container hidden">
        <h3>動爻解釋（多變爻逐條列出）</h3>
        <div id="lineTextDisplay"></div>
      </div>

      <div id="judgeBox" class="analysis-section hidden">
        <h2>綜合分析</h2>
        <div class="row row-justify">
            <select id="questionSelector" style="flex-grow:1;">
                <option value="1">請選擇問事類別：</option>
                <option value="love">1. 感情問題</option>
                <option value="career">2. 工作/學業</option>
                <option value="wealth">3. 財運問題</option>
                <option value="health">4. 健康問題</option>
                <option value="relationship">5. 人際關係</option>
                <option value="life">6. 生活/運勢</option>
                <option value="guidance">7. 尋找指引</option>
            </select>
            <button id="analyzeBtn" class="primary">分析</button>
        </div>

        <div id="questionAnalysisResult" class="analysis-container hidden"></div>

        <div id="wuxingAnalysis" class="analysis-card hidden">
          <h4>梅花心易五行解卦（整體判斷）</h4>
          <div id="wuxingContent"></div>
        </div>
        
        <div id="detailedAnalysis" class="analysis-card hidden">
            <h4>詳細象徵分析（僅適用於單一動爻）</h4>
            <div id="detailedContent"></div>
        </div>
      </div>

      <div style="margin-top:24px"><button id="judgeBtn" class="primary">顯示綜合判斷</button></div>
    </div>
  </div>

  <script>
    /* ===========================
       資料：三爻（1..8）對應與工具
       =========================== */
    const guaTable = {
      // 數字 : [初爻, 二爻, 三爻, 五行]
      1:[1,1,1,'金'], 2:[1,1,0,'金'], 3:[1,0,1,'火'], 4:[1,0,0,'木'],
      5:[0,1,1,'木'], 6:[0,1,0,'水'], 7:[0,0,1,'土'], 8:[0,0,0,'土']
    };
    const trigramName = {1:'乾',2:'兌',3:'離',4:'震',5:'巽',6:'坎',7:'艮',8:'坤'};
    const triIndexByLines = new Map(Object.entries(guaTable).map(([i,arr])=>[JSON.stringify(arr.slice(0,3)), +i]));
    
    let hexList = {};
    const hexByLines = new Map();
    const hexNameByCombinedName = new Map();
    let wuxingExplanations = {};
    let trigramExplanations = {};
    let dataReady = false;
    
    // 輔助函數：根據五行關係判斷吉凶
    function getWuxingOutcome(tiWuxing, yongWuxing) {
        const relations = {
            '金': { '生': '水', '剋': '木', '被生': '土', '被剋': '火', '比和': '金' },
            '木': { '生': '火', '剋': '土', '被生': '水', '被剋': '金', '比和': '木' },
            '水': { '生': '木', '剋': '火', '被生': '金', '被剋': '土', '比和': '水' },
            '火': { '生': '土', '剋': '金', '被生': '木', '被剋': '水', '比和': '火' },
            '土': { '生': '金', '剋': '水', '被生': '火', '被剋': '木', '比和': '土' }
        };
        if (!tiWuxing || !yongWuxing) return { relation: '未知', status: '平', explanation: '五行資料不完整。' };

        let relationType, status;
        if (relations[yongWuxing]['生'] === tiWuxing) {
            relationType = '用生體';
            status = '大吉';
        } else if (relations[tiWuxing]['剋'] === yongWuxing) {
            relationType = '體克用';
            status = '吉';
        } else if (tiWuxing === yongWuxing) {
            relationType = '比和';
            status = '平';
        } else if (relations[tiWuxing]['生'] === yongWuxing) {
            relationType = '體生用';
            status = '凶';
        } else if (relations[yongWuxing]['剋'] === tiWuxing) {
            relationType = '用克體';
            status = '大凶';
        } else {
            relationType = '未知';
            status = '平';
        }

        return { relation: relationType, status: status };
    }
    
    // 異步載入所有 JSON 資料
    Promise.allSettled([
      fetch('hexagrams.json').then(r => r.ok ? r.json() : Promise.reject('無法載入 hexagrams.json')),
      fetch('quotes.json').then(r => r.ok ? r.json() : Promise.reject('無法載入 quotes.json')),
      fetch('wuxing_explanations.json').then(r => r.ok ? r.json() : Promise.reject('無法載入 wuxing_explanations.json')),
      fetch('trigram_explanations.json').then(r => r.ok ? r.json() : Promise.reject('無法載入 trigram_explanations.json'))
    ]).then(results => {
      results.forEach(res => {
        if (res.status === 'fulfilled') {
          if (res.value && typeof res.value === 'object' && res.value['乾為天'] && !Array.isArray(res.value)) {
            hexList = res.value;
            for (const hexName in hexList) {
                const entry = hexList[hexName];
                const entryWithNames = { ...entry, name: hexName, title: entry.title || hexName };
                const linesBinary = entryWithNames.lines.map(line => {
                    const text = line.text;
                    if (text.includes('九') || text.includes('七')) return 1;
                    if (text.includes('六') || text.includes('八')) return 0;
                    return null;
                });
                if (linesBinary.every(val => val !== null)) {
                    hexByLines.set(JSON.stringify(linesBinary), entryWithNames);
                    const uIdx = triIndexByLines.get(JSON.stringify(linesBinary.slice(3, 6)));
                    const lIdx = triIndexByLines.get(JSON.stringify(linesBinary.slice(0, 3)));
                    if (uIdx && lIdx) {
                        const combinedName = `${trigramName[uIdx]}為${trigramName[lIdx]}`;
                        hexNameByCombinedName.set(combinedName, hexName);
                    }
                }
            }
          } else if (res.value && Array.isArray(res.value) && typeof res.value[0] === 'string') {
            document.getElementById('subtitle').textContent = res.value[Math.floor(Math.random() * res.value.length)] ||
            '易有太極，是生兩儀，兩儀生四象，四象生八卦。';
          } else if (res.value && typeof res.value === 'object' && res.value['體克用']) {
            wuxingExplanations = res.value;
          } else if (res.value && typeof res.value === 'object' && res.value['乾']) {
            trigramExplanations = res.value;
          } else {
            console.warn('無法識別的 JSON 資料格式:', res.value);
          }
        } else {
            console.error(`檔案載入失敗：${res.reason}`);
        }
      });

      dataReady = true;
      console.log("所有資料載入完成！");
    }).catch(error => {
      console.error('檔案載入失敗，可能原因：檔案路徑錯誤或網路問題。', error);
      document.getElementById('subtitle').textContent = '資料載入失敗。請檢查檔案路徑。';
    });
    
    /* ---------------------------
       工具函數
       --------------------------- */
    function showTabById(id){
      document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
      document.querySelectorAll(`[data-target="${id}"]`).forEach(b => b.classList.add('active'));
      document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
      document.getElementById(id)?.classList.add('active');
    }
    document.querySelectorAll('.tab-button').forEach(btn => btn.addEventListener('click', () => showTabById(btn.dataset.target)));
    
    function formatGuaNameByLines(lines){
      if (!lines || lines.length !== 6) return '卦象錯誤';
      const uIdx = triIndexByLines.get(JSON.stringify(lines.slice(3, 6)));
      const lIdx = triIndexByLines.get(JSON.stringify(lines.slice(0, 3)));
      const combinedName = `${trigramName[uIdx]}為${trigramName[lIdx]}`;
      return hexNameByCombinedName.get(combinedName) || combinedName;
    }

    function findHexEntryByLines(lines){
      return hexByLines.get(JSON.stringify(lines));
    }
    
    function getGuaHtml(lines, moving=[]){
      let html = '';
      for (let i = 5; i >= 0; i--) {
        const val = lines[i];
        const yaoNo = i + 1;
        const isMoving = (moving || []).includes(yaoNo);
        if (isMoving) {
            html += `<div class="gua-moving ${val === 1 ? 'yang' : 'yin'}"></div>`;
        } else {
            html += `<div class="${val === 1 ? 'gua-yang' : 'gua-yin'}"></div>`;
        }
      }
      return html;
    }

    function getLineEntryFor(hexEntry, yaoIndex){
      return hexEntry?.lines.find(line => line && line.index === yaoIndex) || null;
    }

    function escapeHtml(s){
      if (s === null || s === undefined) return '';
      return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;');
    }
    
    function getTrigramInfo(guaIdx) {
        const name = trigramName[guaIdx];
        return {
            id: guaIdx,
            name: name,
            wuxing: guaTable[guaIdx][3],
            explanations: trigramExplanations[name] || {}
        };
    }
    
    function getTiYong(result) {
      if (result.moving.length !== 1) return { tiGua: null, yongGua: null };
      
      const uGua = getTrigramInfo(result.uIdx);
      const lGua = getTrigramInfo(result.lIdx);
      const movingYao = result.moving[0];

      // 梅花易數體用之分
      if (movingYao >= 4 && movingYao <= 6) {
        return { tiGua: lGua, yongGua: uGua };
      } else {
        return { tiGua: uGua, yongGua: lGua };
      }
    }

    /* ---------------------------
       生成並顯示卦象（主流程）
       --------------------------- */
    let currentResult = null;

    function makeFromUpperLower(uIdx, lIdx){
      const upper = guaTable[uIdx] || guaTable[1];
      const lower = guaTable[lIdx] || guaTable[1];
      return [...lower.slice(0,3), ...upper.slice(0,3)];
    }

    function generateGua(uIdx, lIdx, movingArr){
      const moving = Array.isArray(movingArr) ?
          movingArr.filter(x=>Number.isFinite(x) && x>=1 && x<=6) : [];
      
      const lines = makeFromUpperLower(uIdx, lIdx);
      const hexMain = findHexEntryByLines(lines);
      const mainName = hexMain ? hexMain.name : formatGuaNameByLines(lines);
      
      const changeLines = lines.slice();
      moving.forEach(n => {
        const idx = n - 1;
        if (idx>=0 && idx<6) changeLines[idx] = 1 - changeLines[idx];
      });
      const hexChange = findHexEntryByLines(changeLines);
      const changeName = hexChange ? hexChange.name : formatGuaNameByLines(changeLines);
      
      const huLinesBase = [ lines[1], lines[2], lines[3] ];
      const huLinesTop = [ lines[2], lines[3], lines[4] ];
      const huLines = [...huLinesBase, ...huLinesTop];
      const hexHu = findHexEntryByLines(huLines);
      const huName = hexHu ? hexHu.name : formatGuaNameByLines(huLines);
      
      document.getElementById('guaName').textContent = mainName;
      document.getElementById('guaImage').innerHTML = getGuaHtml(lines, moving);
      document.getElementById('guaNote').textContent = (hexMain && hexMain.judgment && hexMain.judgment.overall) ? hexMain.judgment.overall : '（未找到綜合判斷）';
      
      document.getElementById('changeGuaName').textContent = `變卦：${changeName}`;
      document.getElementById('changeGuaImage').innerHTML = getGuaHtml(changeLines, []);
      
      document.getElementById('huGuaName').textContent = `互卦：${huName}`;
      document.getElementById('huGuaImage').innerHTML = getGuaHtml(huLines, []);

      const lineBox = document.getElementById('lineTextDisplay');
      lineBox.innerHTML = '';
      if (moving.length > 0) {
        if (hexMain && Array.isArray(hexMain.lines)) {
          moving.forEach(mv => {
            const le = getLineEntryFor(hexMain, mv);
            const text = escapeHtml(le?.text || '爻辭未找到');
            const meaning = escapeHtml(le?.meaning || '（無解釋）');
            lineBox.innerHTML += `<div class="line-explanation-item"><strong>第 ${mv} 爻：</strong>${text}<div class="hint">${meaning}</div></div>`;
          });
        } else {
          moving.forEach(mv => {
            lineBox.innerHTML += `<div class="line-explanation-item"><strong>第 ${mv} 爻：</strong><em>（無法載入爻辭，請檢查 hexagrams.json）</em></div>`;
          });
        }
        document.getElementById('line-explanation').classList.remove('hidden');
      } else {
        document.getElementById('line-explanation').classList.add('hidden');
      }

      document.getElementById('result').classList.remove('hidden');
      document.getElementById('judgeBox').classList.add('hidden');
      document.getElementById('questionAnalysisResult').classList.add('hidden');
      document.getElementById('questionSelector').value = '1';
      currentResult = { uIdx, lIdx, moving, lines, hexMain, hexChange, huLines, hexHu };
    }

    /* ---------------------------
       綁定：數字、手動、時間、以象取卦
       --------------------------- */
    // 數字取卦
    document.getElementById('btnNumber').addEventListener('click', () => {
      const uNum = parseInt(document.getElementById('numUpper').value);
      const lNum = parseInt(document.getElementById('numLower').value);
      const mNum = parseInt(document.getElementById('numMoving').value);
      if (!uNum || !lNum || !mNum) {
        alert("請輸入所有三個數字。");
        return;
      }
      const uIdx = (uNum - 1) % 8 + 1;
      const lIdx = (lNum - 1) % 8 + 1;
      const mYao = (mNum - 1) % 6 + 1;
      generateGua(uIdx, lIdx, [mYao]);
    });

    // 手動取卦
    document.getElementById('btnManual').addEventListener('click', () => {
      const uIdx = parseInt(document.getElementById('selUpper').value);
      const lIdx = parseInt(document.getElementById('selLower').value);
      const mYaoStr = document.getElementById('inputMoving').value;
      const mYao = mYaoStr.split(',').map(s => parseInt(s.trim())).filter(n => Number.isFinite(n) && n>=1 && n<=6);
      generateGua(uIdx, lIdx, mYao);
    });

    // 時間取卦
    document.getElementById('btnTime').addEventListener('click', () => {
      const method = document.querySelector('input[name="time-method"]:checked').value;
      let date, hour, minute;
      if (method === 'modern') {
        const dt = new Date(document.getElementById('dtInput').value || Date.now());
        date = dt;
        hour = dt.getHours();
        minute = dt.getMinutes();
      } else {
        const d = new Date(document.getElementById('dateInput').value || Date.now());
        const shichenIdx = parseInt(document.getElementById('shichenInput').value);
        date = d;
        hour = (shichenIdx - 1) * 2 + 23;
        if (hour >= 24) hour -= 24;
        minute = parseInt(document.getElementById('minuteInput').value) || 0;
      }

      const year = date.getFullYear();
      const month = date.getMonth() + 1;
      const day = date.getDate();

      const uIdx = (year + month + day - 1) % 8 + 1;
      const lIdx = (year + month + day + hour - 1) % 8 + 1;
      const mYao = (year + month + day + hour + minute - 1) % 6 + 1;

      generateGua(uIdx, lIdx, [mYao]);
    });
    
    // 以象取卦
    document.getElementById('btnImage').addEventListener('click', () => {
      const uIdx = parseInt(document.getElementById('upperImageSelect').value);
      const lIdx = parseInt(document.getElementById('lowerDirectionSelect').value);
      const useMinute = document.getElementById('imageUseMinute').checked;
      let mYao;
      if (useMinute) {
        mYao = (new Date().getMinutes() - 1) % 6 + 1;
      } else {
        mYao = parseInt(document.getElementById('imageMovingInput').value);
        if (!mYao || mYao < 1 || mYao > 6) {
          alert('請輸入有效的動爻數字 (1-6)。');
          return;
        }
      }
      generateGua(uIdx, lIdx, [mYao]);
    });

    // 隨機數字預設
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('numUpper').value = Math.floor(Math.random() * 900) + 100;
      document.getElementById('numLower').value = Math.floor(Math.random() * 900) + 100;
      document.getElementById('numMoving').value = Math.floor(Math.random() * 900) + 100;
      const now = new Date();
      now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
      document.getElementById('dtInput').value = now.toISOString().slice(0, 16);
      document.getElementById('dateInput').valueAsDate = now;
      document.getElementById('nowQuick').addEventListener('click', () => {
        const now = new Date();
        now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
        document.getElementById('dtInput').value = now.toISOString().slice(0, 16);
      });
    });

    document.querySelectorAll('input[name="time-method"]').forEach(radio => {
      radio.addEventListener('change', (e) => {
        document.getElementById('time-modern').classList.toggle('hidden', e.target.value !== 'modern');
        document.getElementById('time-traditional').classList.toggle('hidden', e.target.value !== 'traditional');
      });
    });
    
    /* ---------------------------
       綜合分析功能
       --------------------------- */
    
    // 渲染五行分析
    function renderWuxingAnalysis(result) {
        const wuxingDiv = document.getElementById('wuxingContent');
        wuxingDiv.innerHTML = '';
        if (result.moving.length !== 1) {
            wuxingDiv.innerHTML += `<div class="analysis-message">五行分析僅適用於單一動爻。</div>`;
            return;
        }

        const { tiGua, yongGua } = getTiYong(result);
        if (!tiGua || !yongGua) {
            wuxingDiv.innerHTML += `<div class="analysis-message">無法確定體卦與用卦，無法進行五行分析。</div>`;
            return;
        }

        const outcome = getWuxingOutcome(tiGua.wuxing, yongGua.wuxing);
        const explanation = wuxingExplanations[outcome.relation] || {};
        
        let wuxingHtml = `
            <div class="wuxing-item">
                <p>體卦：${tiGua.name}（${tiGua.wuxing}），用卦：${yongGua.name}（${yongGua.wuxing}）</p>
                <p>關係：<strong>${outcome.relation}</strong>，吉凶：<span class="wuxing-status ${outcome.status}">${outcome.status}</span></p>
                <p class="wuxing-explanation">${explanation.overall || '無相關解釋。'}</p>
            </div>
        `;
        wuxingDiv.innerHTML = wuxingHtml;
        document.getElementById('wuxingAnalysis').classList.remove('hidden');
    }

    // 渲染詳細象徵分析
    function renderDetailedAnalysis(result) {
        const detailedDiv = document.getElementById('detailedContent');
        detailedDiv.innerHTML = '';
        if (result.moving.length !== 1) {
            detailedDiv.innerHTML += `<div class="analysis-message">詳細象徵分析僅適用於單一動爻。</div>`;
            return;
        }

        const movingYao = result.moving[0];
        const { tiGua, yongGua } = getTiYong(result);
        const changeYaoText = getLineEntryFor(result.hexChange, movingYao)?.text || '無變爻爻辭';
        const mainYaoSymbolism = getLineEntryFor(result.hexMain, movingYao)?.symbolism;

        let detailedHtml = ``;

        // 本卦分析
        if (result.hexMain && result.hexMain.symbolism) {
            const symbolism = result.hexMain.symbolism;
            const categories = ['overall', 'people', 'affairs', 'time', 'place', 'object'];
            const labels = {'overall': '整體', 'people': '人事', 'affairs': '事', 'time': '時', 'place': '地', 'object': '物'};
            
            let mainContent = `<div class="detailed-section"><h5>本卦分析</h5><ul>`;
            categories.forEach(key => {
                if (symbolism[key]) {
                    mainContent += `<li><strong>${labels[key]}</strong>：${symbolism[key]}</li>`;
                }
            });
            mainContent += `</ul></div>`;
            detailedHtml += mainContent;
        }
        
        // 動爻分析
        if (mainYaoSymbolism) {
            const yaoCategories = ['people', 'affairs', 'time', 'place', 'object'];
            const yaoLabels = {'people': '人事', 'affairs': '事', 'time': '時', 'place': '地', 'object': '物'};
            
            let yaoContent = `<div class="detailed-section"><h5>動爻象徵分析</h5><ul>`;
            yaoCategories.forEach(key => {
                if (mainYaoSymbolism[key]) {
                    yaoContent += `<li><strong>${yaoLabels[key]}</strong>：${mainYaoSymbolism[key]}</li>`;
                }
            });
            yaoContent += `</ul></div>`;
            detailedHtml += yaoContent;
        }

        // 變卦分析
        if (result.hexChange && result.hexChange.symbolism && changeYaoText) {
          const changeSymbolism = result.hexChange.symbolism;
          const changeCategories = ['people', 'affairs', 'time', 'place', 'object'];
          const changeCategoryLabels = {'people': '人事', 'affairs': '事', 'time': '時', 'place': '地', 'object': '物'};
          
          let changeContent = `<div class="detailed-section"><h5>變卦象徵分析</h5><p>變卦爻辭：${changeYaoText}</p><ul>`;
          changeCategories.forEach(key => {
              if (changeSymbolism[key]) {
                  changeContent += `<li><strong>${changeCategoryLabels[key]}</strong>：${changeSymbolism[key]}</li>`;
              }
          });
          changeContent += `</ul></div>`;
          detailedHtml += changeContent;
        }

        detailedDiv.innerHTML = detailedHtml || `<div class="analysis-message">無法載入詳細象徵資料，請檢查 hexagrams.json 檔案。</div>`;
        document.getElementById('detailedAnalysis').classList.remove('hidden');
    }

    // 渲染綜合分析
    function renderQuestionAnalysis(result, questionType) {
        const analysisDiv = document.getElementById('questionAnalysisResult');
        analysisDiv.innerHTML = '';
        analysisDiv.classList.add('hidden');
        
        const { tiGua, yongGua } = getTiYong(result);
        const wuxingOutcome = getWuxingOutcome(tiGua.wuxing, yongGua.wuxing);
        const wuxingExplanation = wuxingExplanations[wuxingOutcome.relation] || {};
        
        let analysisHtml = '';

        // 體用關係分析
        if (wuxingExplanation[questionType]) {
            const questionDetail = wuxingExplanation[questionType];
            analysisHtml += `
                <div class="analysis-card">
                    <h4>體用關係分析（梅花心易）</h4>
                    <p>根據您提出的問題類型「${document.querySelector(`#questionSelector option[value="${questionType}"]`).textContent}」：</p>
                    <ul>
                        <li><strong>本卦：</strong>${questionDetail.本卦}</li>
                        <li><strong>互卦：</strong>${questionDetail.互卦}</li>
                        <li><strong>變卦：</strong>${questionDetail.變卦}</li>
                    </ul>
                </div>
            `;
        }

        // 體卦、用卦象徵
        if (tiGua.explanations[questionType] || yongGua.explanations[questionType]) {
            analysisHtml += `
                <div class="analysis-card">
                    <h4>卦象象徵分析</h4>
                    <ul>
                        <li><strong>體卦 ${tiGua.name}：</strong>${tiGua.explanations[questionType] || '無相關解釋。'}</li>
                        <li><strong>用卦 ${yongGua.name}：</strong>${yongGua.explanations[questionType] || '無相關解釋。'}</li>
                    </ul>
                </div>
            `;
        }

        // 總結與建議
        if (wuxingExplanation.建議) {
            analysisHtml += `
                <div class="analysis-card">
                    <h4>綜合建議</h4>
                    <p>${wuxingExplanation.建議.general || '無相關建議。'}</p>
                </div>
            `;
        }

        if (analysisHtml) {
            analysisDiv.innerHTML = analysisHtml;
            analysisDiv.classList.remove('hidden');
        } else {
            analysisDiv.innerHTML = `<div class="analysis-message">目前資料庫中無法針對此問題類型提供詳細分析。</div>`;
            analysisDiv.classList.remove('hidden');
        }
    }

    document.getElementById('judgeBtn').addEventListener('click', ()=> {
      if (!currentResult) { alert('請先生成卦象'); return; }
      document.getElementById('judgeBox').classList.remove('hidden');
      renderWuxingAnalysis(currentResult);
      if (currentResult.moving.length === 1) {
        renderDetailedAnalysis(currentResult);
      } else {
        document.getElementById('detailedAnalysis').classList.add('hidden');
      }
    });
    
    document.getElementById('analyzeBtn').addEventListener('click', ()=> {
        if (!dataReady) {
            alert('資料仍在載入中，請稍候再試。');
            return;
        }
        const questionType = document.getElementById('questionSelector').value;
        if (questionType === '1') {
            alert('請先選擇一個問事類別！');
            return;
        }
        
        if (currentResult.moving.length === 1) {
            renderQuestionAnalysis(currentResult, questionType);
        } else if (currentResult.moving.length > 1) {
            document.getElementById('questionAnalysisResult').innerHTML = `<div class="analysis-message">多動爻卦象較為複雜，不適用於梅花心易的體用分析。請參考卦辭與爻辭來自行判斷。</div>`;
            document.getElementById('questionAnalysisResult').classList.remove('hidden');
        } else {
            document.getElementById('questionAnalysisResult').innerHTML = `<div class="analysis-message">無動爻卦象為靜卦，建議參考本卦卦辭與彖傳內容即可。</div>`;
            document.getElementById('questionAnalysisResult').classList.remove('hidden');
        }
    });

  </script>
</body>
</html>
