<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>易經卜卦 | 占卜工具</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Oxygen", "Ubuntu", "Cantarell", "Fira Sans", "Droid Sans", "Helvetica Neue", sans-serif;
            background-color: #f7f3e9;
            color: #333;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .container {
            width: 100%;
            max-width: 800px;
            background-color: #fff;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            border: 1px solid #e0e0e0;
        }

        header {
            text-align: center;
            margin-bottom: 25px;
        }

        h1 {
            color: #5d4a3e;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        h2, h3, h4 {
            color: #4b3e34;
            border-bottom: 1px solid #e0e0e0;
            padding-bottom: 5px;
            margin-top: 25px;
            margin-bottom: 15px;
        }

        .tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
            border-bottom: 2px solid #ddd;
        }

        .tab-button {
            background: none;
            border: none;
            padding: 12px 20px;
            cursor: pointer;
            font-size: 1.1em;
            color: #888;
            transition: all 0.3s ease;
            position: relative;
            top: 2px;
        }

        .tab-button.active {
            color: #5d4a3e;
            border-bottom: 2px solid #5d4a3e;
            font-weight: bold;
        }
        
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .input-group {
            margin-bottom: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .input-group label {
            font-weight: bold;
            color: #555;
        }
        
        .input-group input, .input-group select {
            width: calc(100% - 20px);
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 6px;
        }
        
        .input-group button {
            background-color: #7b5f49;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.3s;
            font-size: 1em;
            width: 100%;
        }

        .input-group button:hover {
            background-color: #5d4a3e;
        }

        #result {
            margin-top: 30px;
            text-align: center;
            display: none;
        }

        .hidden {
            display: none;
        }

        .gua-display {
            display: flex;
            justify-content: center;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .gua-image {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .gua-yang, .gua-yin, .gua-moving {
            height: 8px;
            margin: 4px 0;
            border-radius: 4px;
        }

        .gua-yang {
            width: 60px;
            background-color: #2c3e50;
        }

        .gua-yin {
            width: 60px;
            display: flex;
            justify-content: space-between;
        }

        .gua-yin::before, .gua-yin::after {
            content: '';
            width: 28px;
            height: 8px;
            background-color: #2c3e50;
            border-radius: 4px;
        }

        .gua-moving {
            width: 60px;
            border: 2px dashed #9b59b6;
        }

        .gua-moving.yang {
            background-color: #e74c3c;
        }
        .gua-moving.yin {
            background-color: #3498db;
        }

        .gua-text {
            font-size: 1.5em;
            font-weight: bold;
            margin-top: 10px;
            color: #5d4a3e;
        }
        .gua-note {
            font-style: italic;
            color: #666;
            margin-top: 5px;
        }
        
        .line-explanation, .wuxing-analysis {
            margin-top: 20px;
            padding: 15px;
            background-color: #f0f0f0;
            border-radius: 8px;
        }
        .line-explanation strong { color: #5d4a3e; }

        .line-explanation .hint {
            font-size: 0.9em;
            color: #888;
            margin-top: 5px;
            padding-left: 20px;
        }

        .analysis-container {
            margin-top: 20px;
            background-color: #fcf8f3;
            border: 1px solid #e8e0d5;
            padding: 20px;
            border-radius: 10px;
        }

        .wuxing-box {
            margin-bottom: 20px;
        }

        .wuxing-box .wuxing-status {
            font-weight: bold;
            font-size: 1.1em;
            display: inline-block;
            margin-left: 10px;
        }

        .wuxing-status.大吉 { color: #2ecc71; }
        .wuxing-status.吉 { color: #3498db; }
        .wuxing-status.平 { color: #f39c12; }
        .wuxing-status.凶 { color: #e67e22; }
        .wuxing-status.大凶 { color: #e74c3c; }

        .wuxing-desc {
            font-size: 0.9em;
            color: #555;
            margin-top: 5px;
            line-height: 1.6;
        }
        .analysis-item {
            margin-top: 20px;
            padding: 15px;
            background-color: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
        }
        .analysis-item h4 {
            margin-top: 0;
            border-bottom: 1px solid #ddd;
            padding-bottom: 5px;
        }
        .analysis-item p {
            line-height: 1.6;
            margin: 0;
        }
        .analysis-item .analysis-status {
            font-weight: bold;
            font-size: 1.1em;
            color: #333;
        }
        .analysis-item .analysis-status.大吉 { color: #2ecc71; }
        .analysis-item .analysis-status.吉 { color: #3498db; }
        .analysis-item .analysis-status.平 { color: #f39c12; }
        .analysis-item .analysis-status.凶 { color: #e67e22; }
        .analysis-item .analysis-status.大凶 { color: #e74c3c; }

        .analysis-item.suggestion {
            background-color: #f7f3e9;
            border-color: #e0d0c0;
        }

        .trigram-details {
            font-size: 0.9em;
            color: #666;
            margin-top: 10px;
            border-left: 3px solid #ccc;
            padding-left: 10px;
        }

        .small-gua-container {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
        }

        .small-gua {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .small-gua-image {
            transform: scale(0.6);
            transform-origin: top;
        }

        @media (max-width: 600px) {
            body { padding: 10px; }
            .container { padding: 15px; }
            h1 { font-size: 2em; }
            .tab-button { font-size: 1em; padding: 10px 15px; }
            .input-group input, .input-group button { font-size: 0.9em; }
            .small-gua-container { flex-direction: column; gap: 10px; }
            .small-gua-image { transform: scale(0.8); }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>易經卜卦 | 占卜工具</h1>
            <p id="subtitle">易有太極，是生兩儀，兩儀生四象，四象生八卦。</p>
        </header>

        <div class="tabs">
            <button class="tab-button active" data-target="tab1">數字起卦</button>
            <button class="tab-button" data-target="tab2">時間起卦</button>
            <button class="tab-button" data-target="tab3">手動起卦</button>
            <button class="tab-button" data-target="tab4">取象起卦</button>
        </div>

        <div id="tab1" class="tab-content active">
            <h2>數字起卦 (梅花易數)</h2>
            <div class="input-group">
                <label>請輸入三個介於 100 到 999 的數字：</label>
                <input type="number" id="numUpper" placeholder="上卦數" min="100" max="999">
                <input type="number" id="numLower" placeholder="下卦數" min="100" max="999">
                <input type="number" id="numMoving" placeholder="動爻數" min="100" max="999">
                <button id="btnNumber">生成卦象</button>
            </div>
        </div>

        <div id="tab2" class="tab-content">
            <h2>時間起卦 (梅花心易)</h2>
            <div class="input-group">
                <label for="dtInput">選擇日期與時間：</label>
                <input type="datetime-local" id="dtInput" name="dtInput">
                <button id="nowQuick">快速選取現在時間</button>
                <button id="btnTime">生成卦象</button>
            </div>
        </div>

        <div id="tab3" class="tab-content">
            <h2>手動起卦 (自訂)</h2>
            <div class="input-group">
                <label for="selUpper">上卦：</label>
                <select id="selUpper">
                    <option value="1">乾(天)</option><option value="2">兌(澤)</option><option value="3">離(火)</option><option value="4">震(雷)</option>
                    <option value="5">巽(風)</option><option value="6">坎(水)</option><option value="7">艮(山)</option><option value="8">坤(地)</option>
                </select>
                <label for="selLower">下卦：</label>
                <select id="selLower">
                    <option value="1">乾(天)</option><option value="2">兌(澤)</option><option value="3">離(火)</option><option value="4">震(雷)</option>
                    <option value="5">巽(風)</option><option value="6">坎(水)</option><option value="7">艮(山)</option><option value="8">坤(地)</option>
                </select>
                <label for="inputMoving">動爻（可多個，以逗號分隔，1-6）：</label>
                <input type="text" id="inputMoving" placeholder="例如: 3,5">
                <button id="btnManual">生成卦象</button>
            </div>
        </div>

        <div id="tab4" class="tab-content">
            <h2>取象起卦</h2>
            <div class="input-group">
                <label for="upperImageSelect">上卦象徵：</label>
                <select id="upperImageSelect">
                    <option value="1">天、圓、金玉、寒冰</option>
                    <option value="2">澤、口、石、刀</option>
                    <option value="3">火、日、電、盔甲</option>
                    <option value="4">雷、足、馬、大路</option>
                    <option value="5">風、繩、雞、草木</option>
                    <option value="6">水、月、耳、車</option>
                    <option value="7">山、石、手、犬</option>
                    <option value="8">地、方、布、牛</option>
                </select>
                <label for="lowerDirectionSelect">下卦方位：</label>
                <select id="lowerDirectionSelect">
                    <option value="1">西北 (乾)</option>
                    <option value="2">西 (兌)</option>
                    <option value="3">南 (離)</option>
                    <option value="4">東 (震)</option>
                    <option value="5">東南 (巽)</option>
                    <option value="6">北 (坎)</option>
                    <option value="7">東北 (艮)</option>
                    <option value="8">西南 (坤)</option>
                </select>
                <label>
                    <input type="checkbox" id="imageUseMinute"> 使用當前分鐘數作為動爻
                </label>
                <input type="number" id="imageMovingInput" placeholder="或手動輸入動爻數 (1-6)">
                <button id="btnImage">生成卦象</button>
            </div>
        </div>

        <div id="result" class="hidden">
            <h2 id="guaName"></h2>
            <div class="gua-display">
                <div id="guaImage" class="gua-image"></div>
            </div>
            <p id="guaNote"></p>
            
            <div class="small-gua-container">
                <div class="small-gua">
                    <p id="changeGuaName"></p>
                    <div id="changeGuaImage" class="gua-image small-gua-image"></div>
                </div>
                <div class="small-gua">
                    <p id="huGuaName"></p>
                    <div id="huGuaImage" class="gua-image small-gua-image"></div>
                </div>
            </div>
            
            <div id="line-explanation" class="line-explanation hidden">
                <h3>爻辭解析</h3>
                <div id="lineTextDisplay"></div>
            </div>
            
            <div style="margin-top: 25px;">
                <button id="judgeBtn">五行解卦</button>
                <button id="analyzeBtn" style="margin-left: 10px;">問題分析</button>
                <select id="questionSelector" style="margin-left: 10px; padding: 8px;">
                    <option value="1">請選擇問題類別...</option>
                    <option value="love">感情問題</option>
                    <option value="career">工作/學業</option>
                    <option value="wealth">財運問題</option>
                    <option value="health">健康問題</option>
                    <option value="relationship">人際關係</option>
                    <option value="life">生活/運勢</option>
                    <option value="guidance">尋找指引</option>
                </select>
            </div>

            <div id="judgeBox" class="analysis-container hidden">
                <div id="wuxingAnalysis">
                    <h3>梅花心易：五行生剋解析</h3>
                    <div id="wuxingContent"></div>
                </div>
                <div id="questionAnalysisResult"></div>
            </div>
        </div>
    </div>
    
    <script>
      /* ===========================
         資料：三爻（1..8）對應與工具
         =========================== */
      const guaTable = {
        1:[1,1,1,'金'], 2:[1,1,0,'金'], 3:[1,0,1,'火'], 4:[1,0,0,'木'],
        5:[0,1,1,'木'], 6:[0,1,0,'水'], 7:[0,0,1,'土'], 8:[0,0,0,'土']
      };
      const trigramName = {1:'乾',2:'兌',3:'離',4:'震',5:'巽',6:'坎',7:'艮',8:'坤'};
      const triIndexByLines = new Map(Object.entries(guaTable).map(([i,arr])=>[JSON.stringify(arr.slice(0,3)), +i]));

      let hexList = [];
      const hexByLines = new Map();
      const hexByCombinedName = new Map();
      let wuxingExplanations = {};
      let trigramExplanations = {};
      let dataReady = false;

      // 輔助函數：根據五行關係判斷吉凶
      function getWuxingOutcome(tiWuxing, yongWuxing) {
          const relations = {
              '金': { '生': '水', '剋': '木', '被生': '土', '被剋': '火', '比和': '金' },
              '木': { '生': '火', '剋': '土', '被生': '水', '被剋': '金', '比和': '木' },
              '水': { '生': '木', '剋': '火', '被生': '金', '被剋': '土', '比和': '水' },
              '火': { '生': '土', '剋': '金', '被生': '木', '被剋': '水', '比和': '火' },
              '土': { '生': '金', '剋': '水', '被生': '火', '被剋': '木', '比和': '土' }
          };

          if (!tiWuxing || !yongWuxing) return { relation: '未知', status: '平', explanation: '五行資料不完整。' };

          let relationType, status;

          // 用生體 (用卦的五行生體卦的五行)
          if (relations[yongWuxing]['生'] === tiWuxing) {
              relationType = '用生體';
              status = '大吉';
          }
          // 體克用 (體卦的五行克用卦的五行)
          else if (relations[tiWuxing]['剋'] === yongWuxing) {
              relationType = '體克用';
              status = '吉';
          }
          // 比和 (體用五行相同)
          else if (tiWuxing === yongWuxing) {
              relationType = '比和';
              status = '平';
          }
          // 體生用 (體卦的五行生用卦的五行)
          else if (relations[tiWuxing]['生'] === yongWuxing) {
              relationType = '體生用';
              status = '凶';
          }
          // 用克體 (用卦的五行克用卦的五行)
          else if (relations[yongWuxing]['剋'] === tiWuxing) {
              relationType = '用克體';
              status = '大凶';
          }
          // 未知關係
          else {
              relationType = '未知';
              status = '平';
          }

          return { relation: relationType, status: status };
      }

      // 異步載入所有 JSON 資料
      Promise.allSettled([
        fetch('hexagrams.json').then(r => r.ok ? r.json() : Promise.reject('hexagrams.json')),
        fetch('quotes.json').then(r => r.ok ? r.json() : Promise.reject('quotes.json')),
        fetch('wuxing_explanations.json').then(r => r.ok ? r.json() : Promise.reject('wuxing_explanations.json')),
        fetch('trigram_explanations.json').then(r => r.ok ? r.json() : Promise.reject('trigram_explanations.json'))
      ]).then(results => {
        results.forEach(res => {
          if (res.status === 'fulfilled') {
            const data = res.value;
            // 根據資料內容判斷是哪個檔案，然後處理
            if (Array.isArray(data) && data.length > 0) {
              if ('lines' in data[0] && data[0].lines.length === 6) {
                // hexagrams.json
                hexList = data.filter(entry => entry && Array.isArray(entry.lines) && entry.lines.length === 6);
                hexList.forEach(entry => {
                  const linesBinary = entry.lines.map(line => line.text.includes('九') ? 1 : line.text.includes('六') ? 0 : null);
                  if (linesBinary.every(val => val !== null) && linesBinary.length === 6) {
                    hexByLines.set(JSON.stringify(linesBinary), entry);
                    const uIdx = triIndexByLines.get(JSON.stringify(linesBinary.slice(3, 6)));
                    const lIdx = triIndexByLines.get(JSON.stringify(linesBinary.slice(0, 3)));
                    if (uIdx && lIdx) {
                      hexByCombinedName.set(`${trigramName[uIdx]}為${trigramName[lIdx]}`, entry);
                    }
                  }
                });
              } else {
                // quotes.json
                document.getElementById('subtitle').textContent = data[Math.floor(Math.random() * data.length)] || '易有太極，是生兩儀，兩儀生四象，四象生八卦。';
              }
            } else if (typeof data === 'object' && data !== null) {
              // wuxing_explanations.json 或 trigram_explanations.json
              if (data['體克用'] || data['用生體']) {
                wuxingExplanations = data;
              } else if (data['乾'] || data['坤']) {
                trigramExplanations = data;
              }
            }
          } else {
              console.error(`無法載入 ${res.reason}，將使用預設內容。`);
              if (res.reason === 'quotes.json') {
                document.getElementById('subtitle').textContent = '易有太極，是生兩儀，兩儀生四象，四象生八卦。';
              }
          }
        });

        dataReady = true;
        console.log("所有資料載入完成！");
      }).catch(error => {
        console.error('檔案載入失敗，可能原因：檔案路徑錯誤或網路問題。', error);
        document.getElementById('subtitle').textContent = '資料載入失敗。請檢查檔案路徑。';
      });


      /* ---------------------------
         工具函數
         --------------------------- */
      function showTabById(id){
        document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
        document.querySelectorAll(`[data-target="${id}"]`).forEach(b => b.classList.add('active'));
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
        document.getElementById(id)?.classList.add('active');
      }
      document.querySelectorAll('.tab-button').forEach(btn => btn.addEventListener('click', () => showTabById(btn.dataset.target)));

      function formatGuaNameByLines(lines){
        if (!lines || lines.length !== 6) return '卦象錯誤';
        const uIdx = triIndexByLines.get(JSON.stringify(lines.slice(3, 6)));
        const lIdx = triIndexByLines.get(JSON.stringify(lines.slice(0, 3)));
        const combinedName = `${trigramName[uIdx]}為${trigramName[lIdx]}`;
        return hexByCombinedName.get(combinedName)?.name || combinedName;
      }

      function findHexEntryByLines(lines){
        return hexByLines.get(JSON.stringify(lines));
      }

      function getGuaHtml(lines, moving=[]){
        let html = '';
        for (let i = 5; i >= 0; i--) {
          const val = lines[i];
          const yaoNo = i + 1;
          const isMoving = (moving || []).includes(yaoNo);

          if (isMoving) {
              html += `<div class="gua-moving ${val === 1 ? 'yang' : 'yin'}"></div>`;
          } else {
              html += `<div class="${val === 1 ? 'gua-yang' : 'gua-yin'}"></div>`;
          }
        }
        return html;
      }

      function getLineEntryFor(hexEntry, yaoIndex){
        return hexEntry?.lines.find(line => line && line.index === yaoIndex) || null;
      }

      function escapeHtml(s){
        if (s === null || s === undefined) return '';
        return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;');
      }

      function getTrigramInfo(guaIdx) {
          const name = trigramName[guaIdx];
          return {
              id: guaIdx,
              name: name,
              wuxing: guaTable[guaIdx][3],
              explanations: trigramExplanations[name] || {}
          };
      }

      function getTiYong(result) {
          if (result.moving.length === 0) return { tiGua: null, yongGua: null };
          const uGua = getTrigramInfo(result.uIdx);
          const lGua = getTrigramInfo(result.lIdx);
          const movingYao = result.moving[0];

          if (movingYao >= 4 && movingYao <= 6) {
              return { tiGua: lGua, yongGua: uGua };
          } else {
              return { tiGua: uGua, yongGua: lGua };
          }
      }


      /* ---------------------------
         生成並顯示卦象（主流程）
         --------------------------- */
      let currentResult = null;

      function makeFromUpperLower(uIdx, lIdx){
        const upper = guaTable[uIdx] || guaTable[1];
        const lower = guaTable[lIdx] || guaTable[1];
        return [...lower.slice(0,3), ...upper.slice(0,3)];
      }

      function generateGua(uIdx, lIdx, movingArr){
        const moving = Array.isArray(movingArr) ? movingArr.filter(x=>Number.isFinite(x) && x>=1 && x<=6) : [];
        const lines = makeFromUpperLower(uIdx, lIdx);

        const hexMain = findHexEntryByLines(lines);
        const mainName = hexMain ? (hexMain.name || hexMain.title) : formatGuaNameByLines(lines);

        const changeLines = lines.slice();
        moving.forEach(n => { const idx = n - 1; if (idx>=0 && idx<6) changeLines[idx] = 1 - changeLines[idx]; });
        const hexChange = findHexEntryByLines(changeLines);
        const changeName = hexChange ? (hexChange.name || hexChange.title) : formatGuaNameByLines(changeLines);

        const huLinesBase = [ lines[1], lines[2], lines[3] ];
        const huLinesTop = [ lines[2], lines[3], lines[4] ];
        const huLines = [...huLinesBase, ...huLinesTop];
        const hexHu = findHexEntryByLines(huLines);
        const huName = hexHu ? (hexHu.name || hexHu.title) : formatGuaNameByLines(huLines);

        document.getElementById('guaName').textContent = mainName;
        document.getElementById('guaImage').innerHTML = getGuaHtml(lines, moving);
        document.getElementById('guaNote').textContent = (hexMain && hexMain.judgment && hexMain.judgment.overall) ? hexMain.judgment.overall : '（未找到綜合判斷）';

        document.getElementById('changeGuaName').textContent = `變卦：${changeName}`;
        document.getElementById('changeGuaImage').innerHTML = getGuaHtml(changeLines, []);

        document.getElementById('huGuaName').textContent = `互卦：${huName}`;
        document.getElementById('huGuaImage').innerHTML = getGuaHtml(huLines, []);

        const lineBox = document.getElementById('lineTextDisplay');
        lineBox.innerHTML = '';
        if (moving.length > 0) {
          if (hexMain && Array.isArray(hexMain.lines)) {
            moving.forEach(mv => {
              const le = getLineEntryFor(hexMain, mv);
              const text = escapeHtml(le?.text || '');
              const meaning = escapeHtml(le?.meaning || '');
              lineBox.innerHTML += `<div><strong>第 ${mv} 爻：</strong>${text}<div class="hint">${meaning}</div></div>`;
            });
          } else {
            moving.forEach(mv => {
              lineBox.innerHTML += `<div><strong>第 ${mv} 爻：</strong><em>（未載入或找不到 hexagrams.json，無法顯示爻辭）</em></div>`;
            });
          }
          document.getElementById('line-explanation').classList.remove('hidden');
        } else {
          document.getElementById('line-explanation').classList.add('hidden');
        }

        document.getElementById('result').classList.remove('hidden');
        document.getElementById('judgeBox').classList.add('hidden');
        document.getElementById('questionAnalysisResult').classList.add('hidden');
        document.getElementById('questionSelector').value = '1';

        currentResult = { uIdx, lIdx, moving, lines, hexMain, changeLines, hexChange, huLines, hexHu };
      }

      /* ---------------------------
         綁定：數字取卦（含隨機預設）
         --------------------------- */
      function rand100to999(){ return Math.floor(Math.random()*900) + 100; }
      document.getElementById('numUpper').value = rand100to999();
      document.getElementById('numLower').value = rand100to999();
      document.getElementById('numMoving').value = rand100to999();
      document.getElementById('btnNumber').addEventListener('click', ()=>{
        const a = Number(document.getElementById('numUpper').value);
        const b = Number(document.getElementById('numLower').value);
        const c = Number(document.getElementById('numMoving').value);
        if (![a,b,c].every(x => Number.isInteger(x) && x >= 100 && x <= 999)) {
          alert('請輸入 100 到 999 的整數（或重新整理頁面取得隨機值）。');
          return;
        }
        const u = (a % 8) || 8;
        const l = (b % 8) || 8;
        const m = (c % 6) || 6;
        generateGua(u, l, [m]);
      });

      /* ---------------------------
         綁定：手動取卦
         --------------------------- */
      document.getElementById('btnManual').addEventListener('click', ()=>{
        const u = Number(document.getElementById('selUpper').value);
        const l = Number(document.getElementById('selLower').value);
        const raw = (document.getElementById('inputMoving').value || '').trim();
        const ms = raw === '' ? [] : raw.split(',').map(s => parseInt(s.trim(),10)).filter(x => Number.isInteger(x) && x>=1 && x<=6);
        generateGua(u, l, ms);
      });

      /* ---------------------------
         綁定：時間取卦（梅花易）初始化與處理
         --------------------------- */
      function pad(n){ return String(n).padStart(2,'0'); }
      function localDatetimeForInput(d){ return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`; }
      document.getElementById('dtInput').value = localDatetimeForInput(new Date());
      document.getElementById('nowQuick').addEventListener('click', () => document.getElementById('dtInput').value = localDatetimeForInput(new Date()));
      document.getElementById('btnTime').addEventListener('click', ()=>{
        const val = document.getElementById('dtInput').value;
        if (!val) { alert('請先選擇日期時間'); return; }
        const d = new Date(val);
        const y = d.getFullYear(), mo = d.getMonth()+1, da = d.getDate(), h = d.getHours(), mi = d.getMinutes();
        const ymd = y + mo + da;
        const u = (ymd % 8) || 8;
        const l = ((ymd + h) % 8) || 8;
        const m = ((ymd + h + mi) % 6) || 6;
        generateGua(u, l, [m]);
      });

      /* ---------------------------
         綁定：以象取卦
         --------------------------- */
      document.getElementById('btnImage').addEventListener('click', ()=>{
        const u = Number(document.getElementById('upperImageSelect').value);
        const l = Number(document.getElementById('lowerDirectionSelect').value);
        let m;
        if (document.getElementById('imageUseMinute').checked) {
          const d = new Date();
          const ymd = d.getFullYear() + (d.getMonth()+1) + d.getDate();
          m = ((ymd + d.getHours() + d.getMinutes()) % 6) || 6;
        } else {
          const raw = Number(document.getElementById('imageMovingInput').value) || 1;
          m = (raw % 6) || 6;
        }
        generateGua(u, l, [m]);
      });

      /* ---------------------------
         梅花心易五行解卦
         --------------------------- */
      function renderWuxingAnalysis(result) {
          const analysisDiv = document.getElementById('wuxingAnalysis');
          const contentDiv = document.getElementById('wuxingContent');
          contentDiv.innerHTML = '';

          if (result.moving.length !== 1) {
              analysisDiv.classList.add('hidden');
              return;
          }

          analysisDiv.classList.remove('hidden');

          const { tiGua, yongGua } = getTiYong(result);
          if (!tiGua || !yongGua) {
              analysisDiv.classList.add('hidden');
              return;
          }

          // 本卦分析
          const mainEffect = getWuxingOutcome(tiGua.wuxing, yongGua.wuxing);
          const mainExplanation = wuxingExplanations[mainEffect.relation]?.['general']?.本卦 || '（此類別無詳細解釋）';
          const mainDesc = `**體卦**（您）為 **${tiGua.name}** 屬 **${tiGua.wuxing}**，**用卦**（外在事物）為 **${yongGua.name}** 屬 **${yongGua.wuxing}**。`;
          contentDiv.innerHTML += `<div class="wuxing-box">**本卦：**<span class="wuxing-status ${mainEffect.status}">${mainEffect.relation}</span><div class="wuxing-desc">${mainDesc}<br>${mainExplanation}</div></div>`;

          // 互卦分析
          const huLines = result.huLines;
          const huLowerId = triIndexByLines.get(JSON.stringify(huLines.slice(0,3)));
          const huUpperId = triIndexByLines.get(JSON.stringify(huLines.slice(3,6)));
          const huLGua = getTrigramInfo(huLowerId);
          const huUGua = getTrigramInfo(huUpperId);

          const huOutcome = getWuxingOutcome(tiGua.wuxing, huLGua.wuxing);
          const huExplanation = wuxingExplanations[huOutcome.relation]?.['general']?.互卦 || '（此類別無詳細解釋）';

          let guaAnalysisHtml = `<div class="analysis-item"><h4>第二層：互卦（過程分析）</h4><p>體卦屬 **${tiGua.wuxing}**，互卦（代表過程）屬 **${huLGua.wuxing}** 與 **${huUGua.wuxing}**。<br>五行關係為：**${huOutcome.relation}**。這顯示事情在過程中將會：<br><span class="analysis-status ${huOutcome.status}">${huExplanation}</span></p>`;

          if (trigramExplanations[huLGua.name] || trigramExplanations[huUGua.name]) {
              guaAnalysisHtml += `<div class="trigram-details"><strong>互卦取象：</strong><br>`;
              if (trigramExplanations[huLGua.name]?.life) {
                  guaAnalysisHtml += `**下互卦**（${huLGua.name}）：${trigramExplanations[huLGua.name].life}<br>`;
              }
              if (trigramExplanations[huUGua.name]?.life) {
                  guaAnalysisHtml += `**上互卦**（${huUGua.name}）：${trigramExplanations[huUGua.name].life}`;
              }
              guaAnalysisHtml += `</div>`;
          }
          guaAnalysisHtml += `</div>`;
          contentDiv.innerHTML += guaAnalysisHtml;


          // 變卦：最終結果
          const changeLines = result.changeLines;
          const changeLowerId = triIndexByLines.get(JSON.stringify(changeLines.slice(0,3)));
          const changeUpperId = triIndexByLines.get(JSON.stringify(changeLines.slice(3,6)));
          const changeGua = (result.moving[0] <= 3) ? getTrigramInfo(changeLowerId) : getTrigramInfo(changeUpperId);
          const changeOutcome = getWuxingOutcome(tiGua.wuxing, changeGua.wuxing);
          const changeExplanation = wuxingExplanations[changeOutcome.relation]?.['general']?.變卦 || '（此類別無詳細解釋）';

          guaAnalysisHtml = `<div class="analysis-item"><h4>第三層：變卦（結果分析）</h4><p>體卦屬 **${tiGua.wuxing}**，變卦（代表結果）屬 **${changeGua.wuxing}**。<br>五行關係為：**${changeOutcome.relation}**。這代表最終的結果將會是：<br><span class="analysis-status ${changeOutcome.status}">${changeExplanation}</span></p>`;

          if (trigramExplanations[changeGua.name]?.life) {
              guaAnalysisHtml += `<div class="trigram-details"><strong>變卦取象：</strong><br>`;
              guaAnalysisHtml += `**變卦**（${changeGua.name}）：${trigramExplanations[changeGua.name].life}`;
              guaAnalysisHtml += `</div>`;
          }
          guaAnalysisHtml += `</div>`;
          contentDiv.innerHTML += guaAnalysisHtml;
      }

      function renderQuestionAnalysis(result, questionType) {
          const analysisDiv = document.getElementById('questionAnalysisResult');
          analysisDiv.innerHTML = '';

          const analysisMap = {
              'love': '感情問題', 'career': '工作/學業', 'wealth': '財運問題', 'health': '健康問題', 'relationship': '人際關係', 'life': '生活/運勢', 'guidance': '尋找指引'
          };

          const questionTitle = analysisMap[questionType];
          if (!questionTitle || result.moving.length !== 1) {
              analysisDiv.classList.add('hidden');
              return;
          }

          analysisDiv.classList.remove('hidden');

          const { tiGua, yongGua } = getTiYong(result);
          if (!tiGua || !yongGua) {
              analysisDiv.innerHTML = `<div class="analysis-item"><h4>${questionTitle}：總體解讀</h4><p>無法判斷體用關係，請檢查動爻數量。</p></div>`;
              return;
          }

          // 1. 卦辭與爻辭總結
          let judgmentText = result.hexMain?.judgment?.overall || '（卦辭未提供詳細判斷）';
          const yaoCi = getLineEntryFor(result.hexMain, result.moving[0]);
          analysisDiv.innerHTML += `<div class="analysis-item"><h4>${questionTitle}：總體解讀</h4><p>卦辭：${judgmentText}</p><p>動爻爻辭：${(yaoCi?.text || '無')}</p></div>`;

          // 2. 五行生剋分層次分析
          // 本卦：現況分析
          const mainOutcome = getWuxingOutcome(tiGua.wuxing, yongGua.wuxing);
          const mainExplanation = wuxingExplanations[mainOutcome.relation]?.[questionType]?.本卦 || '（此類別無詳細解釋）';

          let guaAnalysisHtml = `<div class="analysis-item"><h4>第一層：本卦（現況分析）</h4><p>您的問事面向為 **${questionTitle}**。<br>體卦（您）為 **${tiGua.name}** 屬 **${tiGua.wuxing}**，用卦（外在事物）為 **${yongGua.name}** 屬 **${yongGua.wuxing}**。<br>五行關係為：**${mainOutcome.relation}**。此卦象代表：<br><span class="analysis-status ${mainOutcome.status}">${mainExplanation}</span></p>`;

          if (trigramExplanations[tiGua.name]?.[questionType] || trigramExplanations[yongGua.name]?.[questionType]) {
              guaAnalysisHtml += `<div class="trigram-details"><strong>本卦取象：</strong><br>`;
              if (trigramExplanations[tiGua.name]?.[questionType]) {
                  guaAnalysisHtml += `**體卦**（${tiGua.name}）：${trigramExplanations[tiGua.name][questionType]}<br>`;
              }
              if (trigramExplanations[yongGua.name]?.[questionType]) {
                  guaAnalysisHtml += `**用卦**（${yongGua.name}）：${trigramExplanations[yongGua.name][questionType]}`;
              }
              guaAnalysisHtml += `</div>`;
          }
          guaAnalysisHtml += `</div>`;
          analysisDiv.innerHTML += guaAnalysisHtml;

          // 互卦：過程分析
          const huLines = result.huLines;
          const huLowerId = triIndexByLines.get(JSON.stringify(huLines.slice(0,3)));
          const huUpperId = triIndexByLines.get(JSON.stringify(huLines.slice(3,6)));
          const huLGua = getTrigramInfo(huLowerId);
          const huUGua = getTrigramInfo(huUpperId);

          const huOutcome = getWuxingOutcome(tiGua.wuxing, huLGua.wuxing);
          const huExplanation = wuxingExplanations[huOutcome.relation]?.[questionType]?.互卦 || '（此類別無詳細解釋）';

          guaAnalysisHtml = `<div class="analysis-item"><h4>第二層：互卦（過程分析）</h4><p>體卦屬 **${tiGua.wuxing}**，互卦（代表過程）屬 **${huLGua.wuxing}** 與 **${huUGua.wuxing}**。<br>五行關係為：**${huOutcome.relation}**。這顯示事情在過程中將會：<br><span class="analysis-status ${huOutcome.status}">${huExplanation}</span></p>`;

          if (trigramExplanations[huLGua.name]?.[questionType] || trigramExplanations[huUGua.name]?.[questionType]) {
              guaAnalysisHtml += `<div class="trigram-details"><strong>互卦取象：</strong><br>`;
              if (trigramExplanations[huLGua.name]?.[questionType]) {
                  guaAnalysisHtml += `**下互卦**（${huLGua.name}）：${trigramExplanations[huLGua.name][questionType]}<br>`;
              }
              if (trigramExplanations[huUGua.name]?.[questionType]) {
                  guaAnalysisHtml += `**上互卦**（${huUGua.name}）：${trigramExplanations[huUGua.name][questionType]}`;
              }
              guaAnalysisHtml += `</div>`;
          }
          guaAnalysisHtml += `</div>`;
          analysisDiv.innerHTML += guaAnalysisHtml;


          // 變卦：最終結果
          const changeLines = result.changeLines;
          const changeLowerId = triIndexByLines.get(JSON.stringify(changeLines.slice(0,3)));
          const changeUpperId = triIndexByLines.get(JSON.stringify(changeLines.slice(3,6)));
          const changeGua = (result.moving[0] <= 3) ? getTrigramInfo(changeLowerId) : getTrigramInfo(changeUpperId);
          const changeOutcome = getWuxingOutcome(tiGua.wuxing, changeGua.wuxing);
          const changeExplanation = wuxingExplanations[changeOutcome.relation]?.[questionType]?.變卦 || '（此類別無詳細解釋）';

          guaAnalysisHtml = `<div class="analysis-item"><h4>第三層：變卦（結果分析）</h4><p>體卦屬 **${tiGua.wuxing}**，變卦（代表結果）屬 **${changeGua.wuxing}**。<br>五行關係為：**${changeOutcome.relation}**。這代表最終的結果將會是：<br><span class="analysis-status ${changeOutcome.status}">${changeExplanation}</span></p>`;

          if (trigramExplanations[changeGua.name]?.[questionType]) {
              guaAnalysisHtml += `<div class="trigram-details"><strong>變卦取象：</strong><br>`;
              guaAnalysisHtml += `**變卦**（${changeGua.name}）：${trigramExplanations[changeGua.name][questionType]}`;
              guaAnalysisHtml += `</div>`;
          }
          guaAnalysisHtml += `</div>`;
          analysisDiv.innerHTML += guaAnalysisHtml;


          // 針對性建議
          const suggestionObj = wuxingExplanations[mainOutcome.relation]?.[questionType]?.建議;
          if (suggestionObj) {
              let suggestionHtml = `<h5>◎ 針對性建議</h5><p>${suggestionObj.general
                  .replace(/\${tiGua.wuxing}/g, tiGua.wuxing)
                  .replace(/\${yongGua.wuxing}/g, yongGua.wuxing)}</p>`;

              if (suggestionObj.specific && suggestionObj.specific[questionType]) {
                const specificContent = suggestionObj.specific[questionType];
                if (Object.keys(specificContent).length > 0) {
                  suggestionHtml += '<ul>';
                  for (const wuxing in specificContent) {
                    const content = specificContent[wuxing];
                    if (content) {
                      suggestionHtml += `<li>**${wuxing}**：${content}</li>`;
                    }
                  }
                  suggestionHtml += '</ul>';
                }
              }
              analysisDiv.innerHTML += `<div class="analysis-item suggestion">${suggestionHtml}</div>`;
          }
      }

      document.getElementById('judgeBtn').addEventListener('click', ()=>{
        if (!currentResult) { alert('請先生成卦象'); return; }
        document.getElementById('judgeBox').classList.remove('hidden');
        renderWuxingAnalysis(currentResult);
      });

      document.getElementById('analyzeBtn').addEventListener('click', ()=>{
          if (!dataReady) {
              alert('資料仍在載入中，請稍候再試。');
              return;
          }
          const questionType = document.getElementById('questionSelector').value;
          if (questionType === '1') {
              alert('請先選擇一個問事類別！');
              return;
          }
          if (currentResult.moving.length !== 1) {
              alert('五行解卦僅適用於單一動爻的情況。');
              return;
          }
          renderQuestionAnalysis(currentResult, questionType);
      });
    </script>
</body>
</html>
