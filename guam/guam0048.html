<html lang="zh-TW">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>張老師易經(梅花心易)</title>
  <style>
   :root {
    --primary-color: #2c3e50;
    --secondary-color: #3498db;
    --negative-color: #e74c3c;
    --positive-color: #4caf50;
    --yellow-color: #f1c40f;
    --background-color: #f4f7f9;
    --card-bg: #ffffff;
    --border-color: #e0e6ed;
    --text-color: #333333;
    --sub-text-color: #7f8c8d;
    --shadow-light: 0 4px 12px rgba(0, 0, 0, 0.05);
    --border-radius: 12px;
    --font-family: 'Noto Sans TC', sans-serif;
    --wood-color: #27ae60;
    --fire-color: #e74c3c;
    --earth-color: #f1c40f;
    --metal-color: #bdc3c7;
    --water-color: #3498db;
  }

    body {
      font-family: var(--font-family);
      background: var(--background-color);
      color: var(--text-color);
      padding: 20px;
      line-height: 1.6;
      margin: 0;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: var(--card-bg);
      padding: 25px;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow-light);
    }

    h1 {
      margin: 0 0 8px 0;
      font-size: 28px;
      color: var(--primary-color);
    }

    h2.subtitle {
      margin: 0 0 20px 0;
      color: var(--sub-text-color);
      font-weight: 400;
      font-size: 16px;
      border-bottom: 1px solid var(--border-color);
      padding-bottom: 15px;
    }

    .tab-buttons {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }

    .tab-button {
      padding: 10px 18px;
      border-radius: var(--border-radius);
      border: 1px solid var(--border-color);
      background: transparent;
      cursor: pointer;
      color: var(--sub-text-color);
      transition: all 0.3s ease;
      font-size: 15px;
    }

    .tab-button.active {
      background: var(--primary-color);
      color: #fff;
      border-color: var(--primary-color);
    }

    .tab-content {
      display: none;
      padding-top: 10px;
    }

    .tab-content.active {
      display: block;
    }

    .row {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
      margin: 12px 0;
    }

    .hint {
      font-size: 13px;
      color: var(--sub-text-color);
      line-height: 1.5;
    }

    .gua-box {
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius);
      padding: 20px;
      background: var(--background-color);
      margin-bottom: 20px;
    }

    .hidden {
      display: none;
    }

    button.primary {
      background: var(--primary-color);
      color: #fff;
      border: none;
      padding: 10px 20px;
      border-radius: var(--border-radius);
      cursor: pointer;
      transition: background 0.3s ease;
    }

    button.primary:hover {
      background: var(--secondary-color);
    }

    input, select {
      padding: 8px;
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius);
      font-size: 14px;
    }

    .gua-display-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin: 10px 0;
    }

    .gua-line {
      width: 60px;
      height: 10px;
      margin: 5px 0;
      background: var(--text-color);
      position: relative;
    }

    .gua-line.yin::after {
      content: '';
      position: absolute;
      width: 20px;
      height: 10px;
      background: var(--card-bg);
      left: 20px;
    }

    .gua-line.moving::before {
      content: '×';
      position: absolute;
      color: var(--negative-color);
      font-size: 16px;
      left: -20px;
      top: -3px;
    }

    .gua-name {
      margin-top: 10px;
      font-weight: bold;
      font-size: 16px;
      color: var(--primary-color);
      text-align: center;
    }

    .wuxing-box {
      margin: 15px 0;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      max-width: 600px;
    }

    .wuxing-box ul {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .wuxing-box li {
      flex: 1 1 calc(50% - 10px);
      min-width: 280px;
      padding: 10px;
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius);
      background: var(--card-bg);
    }

    .wuxing-status {
      font-weight: bold;
    }

    .wuxing-status.positive { color: var(--positive-color); }
    .wuxing-status.neutral { color: var(--secondary-color); }
    .wuxing-status.negative { color: var(--negative-color); }

    .wuxing-node {
      stroke: var(--primary-color);
      stroke-width: 2;
    }

    .wuxing-node.木 {
      fill: var(--wood-color);
    }
    .wuxing-node.火 {
      fill: var(--fire-color);
    }
    .wuxing-node.土 {
      fill: var(--earth-color);
    }
    .wuxing-node.金 {
      fill: var(--metal-color);
    }
    .wuxing-node.水 {
      fill: var(--water-color);
    }

    .wuxing-node:hover {
      opacity: 0.8;
      cursor: pointer;
    }

    .wuxing-node-text {
      text-anchor: middle;
      font-size: 12px;
      fill: var(--text-color);
    }

    .wuxing-edge-generate {
      stroke: var(--positive-color);
    }

    .wuxing-edge-overcome {
      stroke: var(--negative-color);
    }

    .wuxing-edge-harmony {
      stroke: var(--secondary-color);
    }

    .wuxing-edge-label {
      font-size: 10px;
      fill: var(--text-color);
      text-anchor: middle;
    }

    .score-card {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 10px 0;
      padding: 10px;
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius);
      font-size: 14px;
    }

    .score-bar-wrap {
      flex: 1;
      height: 20px;
      background: #e0e6ed;
      border-radius: 10px;
      overflow: hidden;
    }

    .score-bar {
      height: 100%;
      transition: width 0.3s ease;
    }

    .auspiciousness-index {
      font-size: 18px;
      font-weight: bold;
      margin: 15px 0;
      padding: 10px;
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius);
      text-align: center;
    }

    .auspiciousness-bar {
      height: 20px;
      width: 100%;
      max-width: 400px;
      margin: 10px auto;
      border-radius: var(--border-radius);
      overflow: hidden;
    }

    .line-explanation {
      margin: 15px 0;
      padding: 10px;
      background: var(--background-color);
      border-radius: var(--border-radius);
    }

    .wuxing-controls {
      display: flex;
      gap: 10px;
      margin: 10px 0;
    }
    .wuxing-box p {
      margin: 8px 0;
      font-size: 14px;
      line-height: 1.6;
    }
    .wuxing-box h4 {
      margin: 15px 0 10px;
      font-size: 16px;
      color: var(--primary-color);
    }
    .wuxing-box strong {
      color: var(--text-color);
      font-weight: 600;
    }

#wuxingSvg {
  display: block;
  margin: 20px auto;
  background-color: #f9f9f9;
}

.wuxing-node {
  transition: opacity 0.3s;
}

.wuxing-node:hover {
  opacity: 0.7;
}

.wuxing-node-text {
  font-size: 12px;
  font-family: Arial, sans-serif;
  text-anchor: middle;
}

.wuxing-edge-generate {
  stroke: var(--positive-color);
  stroke-width: 2;
}

.wuxing-edge-overcome {
  stroke: var(--negative-color);
  stroke-width: 2;
}

.wuxing-edge-harmony {
  stroke: var(--secondary-color);
  stroke-width: 2;
}

.wuxing-edge-label {
  font-size: 10px;
  fill: #333;
  text-anchor: middle;
}

.wuxing-edge-generate:hover,
.wuxing-edge-overcome:hover,
.wuxing-edge-harmony:hover {
  stroke-width: 3;
}
    :root {
  --positive-color: #00FF00; /* 綠色，生 */
  --negative-color: #FF0000; /* 紅色，剋 */
  --secondary-color: #0000FF; /* 藍色，比和 */
}
.wuxing-node {
  cursor: pointer;
}
.wuxing-edge-generate { stroke: var(--positive-color); }
.wuxing-edge-overcome { stroke: var(--negative-color); }
.wuxing-edge-harmony { stroke: var(--secondary-color); }
.wuxing-edge-label {
  font-size: 12px;
  text-anchor: middle;
  fill: #333;
}
  </style>
</head>
<body>
  <div class="container">
    <h1>張老師易經(梅花心易)</h1>
    <h2 id="subtitle" class="subtitle">請選擇取卦方式以開始占卜</h2>
    <div class="tab-buttons">
      <button class="tab-button active" data-target="number">數字取卦</button>
      <button class="tab-button" data-target="manual">手動取卦</button>
      <button class="tab-button" data-target="time">時間取卦</button>
      <button class="tab-button" data-target="image">以象取卦</button>
      <button class="tab-button" data-target="history">歷史記錄</button>
    </div>
    <div id="number" class="tab-content active">
      <div class="row">
        <label>上卦數字(100-999)：</label>
        <input id="numUpper" type="number" min="100" max="999" />
      </div>
      <div class="row">
        <label>下卦數字(100-999)：</label>
        <input id="numLower" type="number" min="100" max="999" />
      </div>
      <div class="row">
        <label>動爻數字(100-999)：</label>
        <input id="numMoving" type="number" min="100" max="999" />
      </div>
      <div class="row">
        <label>問題（可選）：</label>
        <input id="questionNumber" type="text" placeholder="請輸入您的問題" />
      </div>
      <div class="row">
        <button id="btnNumber" class="primary">數字取卦</button>
        <button id="btnRandomNumber" class="primary">亂數取卦</button>
      </div>
      <div class="hint">說明：輸入三組100-999的數字，分別用於計算上卦、下卦與動爻，或點擊「亂數取卦」自動生成數字。數字經模數運算轉換為卦象。</div>
    </div>
    <div id="manual" class="tab-content">
      <div class="row">
        <label>上卦：</label>
        <select id="selUpper">
          <option value="">請選擇</option>
          <option value="1">乾</option>
          <option value="2">兌</option>
          <option value="3">離</option>
          <option value="4">震</option>
          <option value="5">巽</option>
          <option value="6">坎</option>
          <option value="7">艮</option>
          <option value="8">坤</option>
        </select>
      </div>
      <div class="row">
        <label>下卦：</label>
        <select id="selLower">
          <option value="">請選擇</option>
          <option value="1">乾</option>
          <option value="2">兌</option>
          <option value="3">離</option>
          <option value="4">震</option>
          <option value="5">巽</option>
          <option value="6">坎</option>
          <option value="7">艮</option>
          <option value="8">坤</option>
        </select>
      </div>
      <div class="row">
        <label>動爻（1-6，可多選以逗號分隔）：</label>
        <input id="inputMoving" type="text" placeholder="例如：1,3,5" />
      </div>
      <div class="row">
        <label>問題（可選）：</label>
        <input id="questionManual" type="text" placeholder="請輸入您的問題" />
      </div>
      <button id="btnManual" class="primary">手動取卦</button>
      <div class="hint">說明：直接選擇上卦與下卦，並指定動爻（若有）。動爻以逗號分隔輸入，例如“1,3,5”。</div>
    </div>
    <div id="time" class="tab-content">
      <div class="row">
        <label><input type="radio" name="time-method" value="modern" checked /> 現代時間</label>
        <label><input type="radio" name="time-method" value="traditional" /> 傳統時辰</label>
      </div>
      <div id="modern-time-inputs">
        <div class="row">
          <label>日期時間：</label>
          <input id="dtInput" type="datetime-local" />
          <button id="nowQuick" class="primary">現在</button>
        </div>
        <div class="row">
          <label>問題（可選）：</label>
          <input id="questionTime" type="text" placeholder="請輸入您的問題" />
        </div>
      </div>
      <div id="traditional-time-inputs" class="hidden">
        <div class="row">
          <label>日期：</label>
          <input id="dateInput" type="date" />
        </div>
        <div class="row">
          <label>時辰：</label>
          <select id="shichenInput">
            <option value="23">子時 (23:00-01:00)</option>
            <option value="1">丑時 (01:00-03:00)</option>
            <option value="3">寅時 (03:00-05:00)</option>
            <option value="5">卯時 (05:00-07:00)</option>
            <option value="7">辰時 (07:00-09:00)</option>
            <option value="9">巳時 (09:00-11:00)</option>
            <option value="11">午時 (11:00-13:00)</option>
            <option value="13">未時 (13:00-15:00)</option>
            <option value="15">申時 (15:00-17:00)</option>
            <option value="17">酉時 (17:00-19:00)</option>
            <option value="19">戌時 (19:00-21:00)</option>
            <option value="21">亥時 (21:00-23:00)</option>
        </select>
        </div>
        <div class="row">
          <label>分鐘（可選）：</label>
          <input id="minuteInput" type="number" min="0" max="59" />
        </div>
        <div class="row">
          <label>問題（可選）：</label>
          <input id="questionTime" type="text" placeholder="請輸入您的問題" />
        </div>
      </div>
      <button id="btnTime" class="primary">時間取卦</button>
      <div class="hint">說明：現代時間使用年月日時分計算卦象；傳統時辰使用日期與時辰（可選分鐘）。動爻由時間總和決定。</div>
    </div>
    <div id="image" class="tab-content">
      <div class="row">
        <label>上卦（物象）：</label>
        <select id="upperImageSelect">
          <option value="">請選擇</option>
          <option value="1">天、父、金屬</option>
          <option value="2">澤、少女、金屬</option>
          <option value="3">火、中女、電光</option>
          <option value="4">雷、長男、動態</option>
          <option value="5">風、長女、木</option>
          <option value="6">水、中男、液體</option>
          <option value="7">山、少男、石頭</option>
          <option value="8">地、母、土壤</option>
        </select>
      </div>
      <div class="row">
        <label>下卦（方位）：</label>
        <select id="lowerDirectionSelect">
          <option value="">請選擇</option>
          <option value="1">西北</option>
          <option value="2">西</option>
          <option value="3">南</option>
          <option value="4">東</option>
          <option value="5">東南</option>
          <option value="6">北</option>
          <option value="7">東北</option>
          <option value="8">中</option>
        </select>
      </div>
      <div class="row">
        <label><input id="imageUseMinute" type="checkbox" checked /> 使用當前分鐘作為動爻</label>
      </div>
      <div class="row">
        <label>動爻（1-6，若不勾選分鐘）：</label>
        <input id="imageMovingInput" type="number" min="1" max="6" />
      </div>
      <div class="row">
        <label>問題（可選）：</label>
        <input id="questionImage" type="text" placeholder="請輸入您的問題" />
      </div>
      <button id="btnImage" class="primary">以象取卦</button>
      <div class="hint">說明：根據物象選擇上卦，根據方位選擇下卦，動爻可由當前分鐘自動生成或手動輸入。</div>
    </div>
    <div id="history" class="tab-content">
      <div class="row">
        <button id="clearHistoryBtn" class="primary">清除記錄</button>
        <button id="exportHistoryBtn" class="primary">匯出記錄</button>
        <input type="file" id="importHistoryInput" accept=".json" style="padding: 10px;" />
        <button id="importHistoryBtn" class="primary">匯入記錄</button>
      </div>
      <div id="historyList"></div>
      <div class="hint">說明：顯示過去的占卜記錄，點擊可重新載入卦象進行分析。可匯出或匯入記錄（JSON格式）。</div>
    </div>
    <div id="result" class="gua-box hidden">
      <h3 id="resultTitle">占卜結果</h3>
      <p id="questionDisplay" class="hidden"></p>
      <div class="row">
        <div>
          <h4>本卦</h4>
          <div id="guaImage" class="gua-display-container"></div>
          <div id="guaName" class="gua-name">未知</div>
        </div>
        <div>
          <h4>互卦</h4>
          <div id="huGuaImage" class="gua-display-container"></div>
          <div id="huGuaName" class="gua-name">未知</div>
        </div>
        <div>
          <h4>變卦</h4>
          <div id="changeGuaImage" class="gua-display-container"></div>
          <div id="changeGuaName" class="gua-name">未知</div>
        </div>
      </div>
      <p id="guaNote"></p>
      <div id="lineExplanation" class="line-explanation"></div>
      <div id="movingLineScores" class="moving-line-scores"></div>
      <div class="row">
        <button id="judgeBtn" class="primary">五行與象徵</button>
      </div>
      <div id="judgeBox" class="gua-box hidden">
        <h3 id="judgeTitle">五行與象徵</h3>
        <div class="auspiciousness-index">
          <span id="auspiciousnessIndex">吉凶指數：未計算</span>
          <div id="auspiciousnessBar" class="auspiciousness-bar"></div>
        </div>
        <div class="wuxing-controls">
          <button id="downloadSvgBtn" class="primary">下載圖表</button>
          <button id="openSvgWindowBtn" class="primary">在新視窗查看</button>
        </div>
        <div id="wuxingAnalysis">
          <svg id="wuxingSvg" width="600" height="400"></svg>
          <div class="wuxing-box">
            <h4>本卦五行分析</h4>
            <ul>
              <li><strong>本卦上卦（外在環境）：</strong> <span id="mainUpperWuxing"></span> → 體卦（<span id="tiGuaWuxing"></span>）：<span id="mainUpperRelation" class="wuxing-status"></span></li>
              <li><strong>本卦下卦（內在基礎）：</strong> <span id="mainLowerWuxing"></span> → 體卦（<span id="tiGuaWuxing2"></span>）：<span id="mainLowerRelation" class="wuxing-status"></span></li>
            </ul>
          </div>
          <div class="wuxing-box">
            <h4>互卦五行分析</h4>
            <ul>
              <li><strong>互卦上卦（潛在發展）：</strong> <span id="huUpperWuxing"></span> → 體卦（<span id="tiGuaWuxing3"></span>）：<span id="huUpperRelation" class="wuxing-status"></span></li>
              <li><strong>互卦下卦（內在潛力）：</strong> <span id="huLowerWuxing"></span> → 體卦（<span id="tiGuaWuxing4"></span>）：<span id="huLowerRelation" class="wuxing-status"></span></li>
            </ul>
          </div>
          <div class="wuxing-box">
            <h4>變卦五行分析</h4>
            <ul>
              <li><strong>變卦上卦（未來趨勢）：</strong> <span id="changeUpperWuxing"></span> → 體卦（<span id="tiGuaWuxing5"></span>）：<span id="changeUpperRelation" class="wuxing-status"></span></li>
              <li><strong>變卦下卦（變化基礎）：</strong> <span id="changeLowerWuxing"></span> → 體卦（<span id="tiGuaWuxing6"></span>）：<span id="changeLowerRelation" class="wuxing-status"></span></li>
            </ul>
          </div>
        </div>
        <div id="detailedAnalysis" class="hidden">
        </div>
      </div>
    </div>
  </div>
  <script>
    let hexagrams = {}, quotes = [], history = [], currentResult = null, wuxingExplanations = {};

    const trigramName = {
      1: '乾', 2: '兌', 3: '離', 4: '震', 5: '巽', 6: '坎', 7: '艮', 8: '坤'
    };

    const guaTable = {
      1: [1, 1, 1, '金', '乾'],
      2: [1, 1, 0, '金', '兌'],
      3: [1, 0, 1, '火', '離'],
      4: [1, 0, 0, '木', '震'],
      5: [0, 1, 1, '木', '巽'],
      6: [0, 1, 0, '水', '坎'],
      7: [0, 0, 1, '土', '艮'],
      8: [0, 0, 0, '土', '坤']
    };

    const triIndexByLines = new Map(Object.entries({
      '[1,1,1]': 1, '[1,1,0]': 2, '[1,0,1]': 3, '[1,0,0]': 4,
      '[0,1,1]': 5, '[0,1,0]': 6, '[0,0,1]': 7, '[0,0,0]': 8
    }).map(([k, v]) => [k, parseInt(v)]));

    const hexagramNameMap = new Map([
      ['[1,1,1,1,1,1]', '乾為天'],
      ['[0,1,1,1,1,1]', '天風姤'],
      ['[0,1,0,1,1,1]', '天水訟'],
      ['[0,0,1,1,1,1]', '天山遯'],
      ['[0,0,0,1,1,1]', '天地否'],
      ['[1,0,0,1,1,1]', '天雷無妄'],
      ['[0,1,1,0,1,1]', '天澤履'],
      ['[1,0,1,1,1,1]', '天火同人'],
      ['[1,1,0,1,1,0]', '兌為澤'],
      ['[0,1,0,1,1,0]', '澤水困'],
      ['[1,0,1,1,1,0]', '澤火革'],
      ['[0,0,1,1,1,0]', '澤山咸'],
      ['[0,0,0,1,1,0]', '澤地萃'],
      ['[1,0,0,1,1,0]', '澤雷隨'],
      ['[0,1,1,1,1,0]', '澤風大過'],
      ['[1,1,1,1,1,0]', '澤天夬'],
      ['[1,0,1,1,0,1]', '離為火'],
      ['[0,1,0,1,0,1]', '火水未濟'],
      ['[1,1,0,1,0,1]', '火風鼎'],
      ['[0,0,1,1,0,1]', '火山旅'],
      ['[0,0,0,1,0,1]', '火地晉'],
      ['[1,0,0,1,0,1]', '火雷噬嗑'],
      ['[0,1,1,1,0,1]', '火澤睽'],
      ['[1,1,1,1,0,1]', '火天大有'],
      ['[1,0,0,1,0,0]', '震為雷'],
      ['[0,1,0,1,0,0]', '雷水解'],
      ['[1,1,0,1,0,0]', '雷澤歸妹'],
      ['[0,0,1,1,0,0]', '雷山小過'],
      ['[0,0,0,1,0,0]', '雷地豫'],
      ['[1,0,1,1,0,0]', '雷火豐'],
      ['[0,1,1,1,0,0]', '雷風恆'],
      ['[1,1,1,1,0,0]', '雷天大壯'],
      ['[0,1,1,0,1,1]', '巽為風'],
      ['[0,1,0,0,1,1]', '風水渙'],
      ['[1,1,0,0,1,1]', '風澤中孚'],
      ['[0,0,1,0,1,1]', '風山漸'],
      ['[0,0,0,0,1,1]', '風地觀'],
      ['[1,0,0,0,1,1]', '風雷益'],
      ['[1,0,1,0,1,1]', '風火家人'],
      ['[0,1,1,0,1,1]', '風天小畜'],
      ['[0,1,0,0,1,0]', '坎為水'],
      ['[1,1,0,0,1,0]', '水澤節'],
      ['[0,0,1,0,1,0]', '水山蹇'],
      ['[0,0,0,0,1,0]', '水地比'],
      ['[1,0,0,0,1,0]', '水雷屯'],
      ['[1,0,1,0,1,0]', '水火既濟'],
      ['[0,1,1,0,1,0]', '水風井'],
      ['[1,1,1,0,1,0]', '水天需'],
      ['[0,0,1,0,0,1]', '艮為山'],
      ['[0,1,0,0,0,1]', '山水蒙'],
      ['[1,1,0,0,0,1]', '山澤損'],
      ['[1,0,1,0,0,1]', '山火賁'],
      ['[1,0,0,0,0,1]', '山雷頤'],
      ['[0,1,1,0,0,1]', '山風蠱'],
      ['[0,0,0,0,0,1]', '山地剝'],
      ['[1,1,1,0,0,1]', '山天大畜'],
      ['[0,0,0,0,0,0]', '坤為地'],
      ['[0,1,0,0,0,0]', '地水師'],
      ['[1,1,0,0,0,0]', '地澤臨'],
      ['[0,0,1,0,0,0]', '地山謙'],
      ['[1,0,0,0,0,0]', '地雷復'],
      ['[1,0,1,0,0,0]', '地火明夷'],
      ['[0,1,1,0,0,0]', '地風升'],
      ['[1,1,1,0,0,0]', '地天泰']
    ]);

    const palaceMap = {
      '乾為天': ['乾為天','天澤履','天火同人','天雷無妄','天風姤','天水訟','天山遯','天地否'],
      '兌為澤': ['澤天夬','兌為澤','澤火革','澤雷隨','澤風大過','澤水困','澤山咸','澤地萃'],
      '離為火': ['火天大有','火澤睽','離為火','火雷噬嗑','火風鼎','火水未濟','火山旅','火地晉'],
      '震為雷': ['雷天大壯','雷澤歸妹','雷火豐','震為雷','雷風恆','雷水解','雷山小過','雷地豫'],
      '巽為風': ['風天小畜','風澤中孚','風火家人','風雷益','巽為風','風水渙','風山漸','風地觀'],
      '坎為水': ['水天需','水澤節','水火既濟','水雷屯','水風井','坎為水','水山蹇','水地比'],
      '艮為山': ['山天大畜','山澤損','山火賁','山雷頤','山風蠱','山水蒙','艮為山','山地剝'],
      '坤為地': ['地天泰','地澤臨','地火明夷','地雷復','地風升','地水師','地山謙','坤為地']
    };

    const lunarCalendar = {
      gregorianToLunar: (date) => {
        const month = date.getMonth() + 1;
        const day = date.getDate();
        const lunarMonths = [
          { gregorian: [1, 1, 2, 15], lunarMonth: '臘月', season: '冬', lunarMonthNumber: 12 },
          { gregorian: [2, 16, 3, 15], lunarMonth: '正月', season: '春', lunarMonthNumber: 1 },
          { gregorian: [3, 16, 4, 15], lunarMonth: '二月', season: '春', lunarMonthNumber: 2 },
          { gregorian: [4, 16, 5, 15], lunarMonth: '三月', season: '春', lunarMonthNumber: 3 },
          { gregorian: [5, 16, 6, 15], lunarMonth: '四月', season: '夏', lunarMonthNumber: 4 },
          { gregorian: [6, 16, 7, 15], lunarMonth: '五月', season: '夏', lunarMonthNumber: 5 },
          { gregorian: [7, 16, 8, 15], lunarMonth: '六月', season: '夏', lunarMonthNumber: 6 },
          { gregorian: [8, 16, 9, 15], lunarMonth: '七月', season: '秋', lunarMonthNumber: 7 },
          { gregorian: [9, 16, 10, 15], lunarMonth: '八月', season: '秋', lunarMonthNumber: 8 },
          { gregorian: [10, 16, 11, 15], lunarMonth: '九月', season: '秋', lunarMonthNumber: 9 },
          { gregorian: [11, 16, 12, 15], lunarMonth: '十月', season: '冬', lunarMonthNumber: 10 },
          { gregorian: [12, 16, 12, 31], lunarMonth: '十一月', season: '冬', lunarMonthNumber: 11 }
        ];
        for (const period of lunarMonths) {
          const [startMonth, startDay, endMonth, endDay] = period.gregorian;
          if (
            (month > startMonth || (month === startMonth && day >= startDay)) &&
            (month < endMonth || (month === endMonth && day <= endDay))
          ) {
            return {
              lunarMonth: period.lunarMonth,
              season: period.season,
              lunarMonthNumber: period.lunarMonthNumber
            };
          }
        }
        return { lunarMonth: '七月', season: '秋', lunarMonthNumber: 7 }; // 預設 2025/8/25
      }
    };

    const trigramSymbol = {
      '乾': '☰',
      '兌': '☱',
      '離': '☲',
      '震': '☳',
      '巽': '☴',
      '坎': '☵',
      '艮': '☶',
      '坤': '☷'
    };

    const wuxingToTrigrams = {
      '金': ['乾', '兌'],
      '木': ['震', '巽'],
      '火': ['離'],
      '水': ['坎'],
      '土': ['艮', '坤']
    };

    const trigramEnglish = {
      '乾': 'qian',
      '兌': 'dui',
      '離': 'li',
      '震': 'zhen',
      '巽': 'xun',
      '坎': 'kan',
      '艮': 'gen',
      '坤': 'kun'
    };

    const relationMap = {
      '用生體': 'generate_ti',
      '體生用': 'generate_yong',
      '用剋體': 'overcome_ti',
      '體剋用': 'overcome_yong',
      '比和': 'harmony'
    };

    function normalizeKey(str) {
      return str ? str.replace(/[\s-]/g, '').toLowerCase() : '';
    }

    function getHexagramName(upperIdx, lowerIdx) {
      const upperLines = guaTable[upperIdx]?.slice(0, 3) || [0, 0, 0];
      const lowerLines = guaTable[lowerIdx]?.slice(0, 3) || [0, 0, 0];
      const lines = [...lowerLines, ...upperLines];
      const key = JSON.stringify(lines);
      return hexagramNameMap.get(key) || `${trigramName[upperIdx] || '未知'}${trigramName[lowerIdx] || '未知'}`;
    }

    function getSamePalaceHexagrams(hexName) {
      for (const [palace, hexagrams] of Object.entries(palaceMap)) {
        if (hexagrams.includes(hexName)) {
          return { palace, hexagrams };
        }
      }
      return { palace: '未知', hexagrams: [hexName] };
    }

    function getTrigramInfo(idx) {
      const info = guaTable[idx] || [0, 0, 0, '未知', '未知'];
      const [lines1, lines2, lines3, wuxing, name] = info;
      return { name, wuxing, lines: [lines1, lines2, lines3] };
    }

    const generate = { '木': '火', '火': '土', '土': '金', '金': '水', '水': '木' };
    const overcome = { '木': '土', '土': '水', '水': '火', '火': '金', '金': '木' };

    function getRelation(tiWuxing, yongWuxing) {
      if (!tiWuxing || !yongWuxing) return '未知';
      if (tiWuxing === yongWuxing) return '比和';
      if (generate[yongWuxing] === tiWuxing) return '用生體';
      if (generate[tiWuxing] === yongWuxing) return '體生用';
      if (overcome[yongWuxing] === tiWuxing) return '用剋體';
      if (overcome[tiWuxing] === yongWuxing) return '體剋用';
      return '未知';
    }

    function getRelationScore(relation) {
      switch (relation) {
        case '用生體': return 2;
        case '體剋用': return 1;
        case '比和': return 0;
        case '體用同宮': return 0;
        case '體生用': return -1;
        case '用剋體': return -2;
        default: return 0;
      }
    }

    function getWuxingStatus(wuxing, lunarMonthNumber) {
      const statusMap = {
        1: { 木: '旺', 火: '相', 水: '休', 金: '囚', 土: '死' }, // 春季
        2: { 木: '旺', 火: '相', 水: '休', 金: '囚', 土: '死' },
        3: { 木: '旺', 火: '相', 水: '休', 金: '囚', 土: '死' },
        4: { 火: '旺', 土: '相', 木: '休', 水: '囚', 金: '死' }, // 夏季
        5: { 火: '旺', 土: '相', 木: '休', 水: '囚', 金: '死' },
        6: { 火: '旺', 土: '相', 木: '休', 水: '囚', 金: '死' },
        7: { 金: '旺', 水: '相', 土: '休', 火: '囚', 木: '死' }, // 秋季
        8: { 金: '旺', 水: '相', 土: '休', 火: '囚', 木: '死' },
        9: { 金: '旺', 水: '相', 土: '休', 火: '囚', 木: '死' },
        10: { 水: '旺', 木: '相', 金: '休', 土: '囚', 火: '死' }, // 冬季
        11: { 水: '旺', 木: '相', 金: '休', 土: '囚', 火: '死' },
        12: { 水: '旺', 木: '相', 金: '休', 土: '囚', 火: '死' }
      };
      return statusMap[lunarMonthNumber]?.[wuxing] || '休';
    }

    function getWuxingStrength(status) {
      switch (status) {
        case '旺': return 5;
        case '相': return 4;
        case '休': return 3;
        case '囚': return 2;
        case '死': return 1;
        default: return 1;
      }
    }

    function getTiYong(result) {
      const moving = result.moving || [];
      const upperIdx = result.uIdx;
      const lowerIdx = result.lIdx;

      let tiGua, yongGua;

      if (moving.length === 0) {
        tiGua = getTrigramInfo(lowerIdx);
        yongGua = getTrigramInfo(upperIdx);
      } else {
        const maxMoving = Math.max(...moving);
        console.log('最高動爻:', maxMoving);
        if (maxMoving < 4) {
          yongGua = getTrigramInfo(upperIdx);
          tiGua = getTrigramInfo(lowerIdx);
        } else {
          yongGua = getTrigramInfo(lowerIdx);
          tiGua = getTrigramInfo(upperIdx);
        }
      }

      console.log('體卦:', tiGua.name, '用卦:', yongGua.name);
      return { tiGua, yongGua };
    }

    function getLineEntryFor(hex, lineIdx) {
      return hex.lines?.find(line => line.index === lineIdx) || { text: '無爻辭', meaning: '無解釋', score: 5 };
    }

    function clamp(value) {
      return Math.max(0, Math.min(10, value));
    }

async function loadResources() {
  try {
    const [hexResponse, quotesResponse, wuxingResponse] = await Promise.all([
      fetch('hexagrams.json').then(res => res.ok ? res.json() : Promise.reject(`hexagrams.json 載入失敗: ${res.status}`)),
      fetch('quotes.json').then(res => res.ok ? res.json() : Promise.reject(`quotes.json 載入失敗: ${res.status}`)),
      fetch('wuxing_explanations.json').then(res => res.ok ? res.json() : Promise.reject(`wuxing_explanations.json 載入失敗: ${res.status}`))
    ]);
    hexagrams = Object.fromEntries(
      Object.entries(hexResponse).map(([key, value]) => [normalizeKey(key), {
        name: value.name || key,
        judgment: value.judgment || { text: '無卦辭', meaning: '無解釋', people: 5, affairs: 5, time: 5, place: 5, object: 5 },
        symbolism: value.symbolism || { people: 5, affairs: 5, time: 5, place: 5, object: 5 },
        lines: value.lines || []
      }])
    );
    quotes = Array.isArray(quotesResponse) ? quotesResponse : [];
    wuxingExplanations = wuxingResponse.relations || {};
    console.log('載入的 wuxingExplanations:', wuxingExplanations);
    document.getElementById('subtitle').textContent = quotes[Math.floor(Math.random() * quotes.length)] || '請選擇取卦方式以開始占卜';
  } catch (error) {
    console.error('載入 JSON 檔案失敗:', error);
    alert('無法載入資料，請檢查檔案路徑或格式！');
    document.getElementById('subtitle').textContent = '資料載入失敗，請檢查網路或檔案';
  }
}

    function saveHistory() {
      try {
        localStorage.setItem('guaHistory', JSON.stringify(history));
      } catch (error) {
        console.error('儲存歷史記錄失敗:', error);
      }
    }

    function loadHistory() {
      try {
        const stored = localStorage.getItem('guaHistory');
        history = stored ? JSON.parse(stored) : [];
        renderHistory();
      } catch (error) {
        console.error('載入歷史記錄失敗:', error);
      }
    }

    function exportHistory() {
      try {
        const dataStr = JSON.stringify(history, null, 2);
        const blob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = 'gua_history.json';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
      } catch (error) {
        console.error('匯出歷史記錄失敗:', error);
        alert('無法匯出歷史記錄，請稍後再試！');
      }
    }

    function importHistory(file) {
      try {
        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const imported = JSON.parse(e.target.result);
            if (!Array.isArray(imported)) {
              throw new Error('匯入檔案格式錯誤，必須為陣列');
            }
            const validEntries = imported.filter(item => 
              item.lines && Array.isArray(item.lines) && item.lines.length === 6 &&
              item.changeLines && Array.isArray(item.changeLines) && item.changeLines.length === 6 &&
              item.huLines && Array.isArray(item.huLines) && item.huLines.length === 6 &&
              item.moving && Array.isArray(item.moving) &&
              item.hexMain && item.hexChange && item.hexHu &&
              item.uIdx && item.lIdx && item.method && item.timestamp
            );
            history = [...history, ...validEntries];
            saveHistory();
            renderHistory();
            alert('歷史記錄匯入成功！');
          } catch (error) {
            console.error('解析匯入檔案失敗:', error);
            alert('匯入歷史記錄失敗，請檢查檔案格式！');
          }
        };
        reader.readAsText(file);
      } catch (error) {
        console.error('匯入歷史記錄失敗:', error);
        alert('無法匯入歷史記錄，請稍後再試！');
      }
    }

    function renderHistory() {
      const historyList = document.getElementById('historyList');
      historyList.innerHTML = history.length === 0 ? '<p>無歷史記錄</p>' : '';
      history.forEach((item, index) => {
        const div = document.createElement('div');
        div.className = 'history-item';
        div.innerHTML = `
          <p><strong>時間：</strong> ${item.timestamp}</p>
          <p><strong>本卦：</strong> ${item.hexMain?.name || '未知'}</p>
          <p><strong>問題：</strong> ${item.question || '無'}</p>
        `;
        div.addEventListener('click', () => {
          currentResult = item;
          generateGua(item.uIdx, item.lIdx, item.moving, item.method, item.timestamp);
          renderWuxingAnalysis(item);
          renderDetailedAnalysis(item);
        });
        historyList.appendChild(div);
      });
    }

    function renderGuaImage(lines, elementId, moving = []) {
      const container = document.getElementById(elementId);
      if (!container) {
        console.error(`找不到元素 ID: ${elementId}`);
        return;
      }
      container.innerHTML = '';
      if (!lines || lines.length !== 6) {
        container.innerHTML = '<p>無法顯示卦象</p>';
        console.warn(`無效的卦象線條數據: ${lines}`);
        return;
      }
      [...lines].reverse().forEach((line, idx) => {
        const lineDiv = document.createElement('div');
        lineDiv.className = `gua-line ${line === 0 ? 'yin' : ''} ${moving.includes(6 - idx) ? 'moving' : ''}`;
        container.appendChild(lineDiv);
      });
    }

    function renderLineExplanation(moving, mainHex, changeHex) {
      const explanationDiv = document.getElementById('lineExplanation');
      if (!explanationDiv) {
        console.error('找不到 lineExplanation 元素');
        return;
      }
      explanationDiv.innerHTML = '';
      if (!mainHex || !mainHex.judgment || !changeHex || !changeHex.judgment) {
        explanationDiv.innerHTML = '<p>無卦辭或爻辭數據</p>';
        console.warn('缺少卦辭或爻辭數據');
        return;
      }

      explanationDiv.innerHTML += `
        <div class="line-explanation">
          <p><strong>本卦：${mainHex.name || '未知'}</strong></p>
          <p><strong>卦辭：</strong> ${mainHex.judgment.text || '無卦辭'}</p>
          <p><strong>解釋：</strong> ${mainHex.judgment.meaning || '無解釋'}</p>
        </div>
      `;

      if (moving.length === 0) {
        // 如果無動爻，已經在卦辭顯示
      } else {
        moving.forEach(lineIdx => {
          const lineEntry = getLineEntryFor(mainHex, lineIdx);
          explanationDiv.innerHTML += `
            <div class="line-explanation">
              <p><strong>第 ${lineIdx} 爻：</strong> ${lineEntry.text || '無爻辭'}</p>
              <p><strong>解釋：</strong> ${lineEntry.meaning || '無解釋'}</p>
              <p><strong>評分：</strong> ${lineEntry.score || 5}</p>
            </div>
          `;
        });
      }

      explanationDiv.innerHTML += `
        <div class="line-explanation">
          <p><strong>變卦：${changeHex.name || '未知'}</strong></p>
          <p><strong>卦辭：</strong> ${changeHex.judgment.text || '無卦辭'}</p>
          <p><strong>解釋：</strong> ${changeHex.judgment.meaning || '無解釋'}</p>
        </div>
      `;
    }

    function generateGua(upperIdx, lowerIdx, moving, method = '未知', timestamp = new Date().toLocaleString('zh-TW')) {
      if (!trigramName[upperIdx] || !trigramName[lowerIdx]) {
        alert('無效的卦象輸入，請檢查上卦或下卦！');
        console.error(`無效的卦象索引: 上卦 ${upperIdx}, 下卦 ${lowerIdx}`);
        return;
      }

      const upperLines = guaTable[upperIdx].slice(0, 3);
      const lowerLines = guaTable[lowerIdx].slice(0, 3);
      const lines = [...lowerLines, ...upperLines];

      const changeLines = [...lines];
      moving.forEach(idx => {
        if (idx >= 1 && idx <= 6) {
          changeLines[idx - 1] = changeLines[idx - 1] === 1 ? 0 : 1;
        }
      });

      const huLines = [lines[1], lines[2], lines[3], lines[2], lines[3], lines[4]];

      const mainHexName = getHexagramName(upperIdx, lowerIdx);
      const changeUpperIdx = triIndexByLines.get(JSON.stringify(changeLines.slice(3, 6))) || 8;
      const changeLowerIdx = triIndexByLines.get(JSON.stringify(changeLines.slice(0, 3))) || 8;
      const changeHexName = getHexagramName(changeUpperIdx, changeLowerIdx);
      const huUpperIdx = triIndexByLines.get(JSON.stringify(huLines.slice(3, 6))) || 8;
      const huLowerIdx = triIndexByLines.get(JSON.stringify(huLines.slice(0, 3))) || 8;
      const huHexName = getHexagramName(huUpperIdx, huLowerIdx);

      const mainHex = hexagrams[normalizeKey(mainHexName)] || { name: mainHexName, judgment: { text: '無卦辭', meaning: '無解釋', people: 5, affairs: 5, time: 5, place: 5, object: 5 }, symbolism: { people: 5, affairs: 5, time: 5, place: 5, object: 5 }, lines: [] };
      const changeHex = hexagrams[normalizeKey(changeHexName)] || { name: changeHexName, judgment: { text: '無卦辭', meaning: '無解釋', people: 5, affairs: 5, time: 5, place: 5, object: 5 }, symbolism: { people: 5, affairs: 5, time: 5, place: 5, object: 5 }, lines: [] };
      const huHex = hexagrams[normalizeKey(huHexName)] || { name: huHexName, judgment: { text: '無卦辭', meaning: '無解釋', people: 5, affairs: 5, time: 5, place: 5, object: 5 }, symbolism: { people: 5, affairs: 5, time: 5, place: 5, object: 5 }, lines: [] };

      const mainPalace = getSamePalaceHexagrams(mainHexName);
      console.log(`本卦 ${mainHexName} 屬於 ${mainPalace.palace} 宮，同宮卦：${mainPalace.hexagrams.join(', ')}`);

      let question = '';
      const questionInputs = {
        '數字取卦': 'questionNumber',
        '數字亂數取卦': 'questionNumber',
        '手動取卦': 'questionManual',
        '現代時間取卦': 'questionTime',
        '傳統時辰取卦': 'questionTime',
        '以象取卦': 'questionImage'
      };
      const questionInputId = questionInputs[method];
      if (questionInputId) {
        const input = document.getElementById(questionInputId);
        question = input?.value.trim() || '';
      }

      currentResult = {
        lines,
        changeLines,
        huLines,
        moving,
        hexMain: mainHex,
        hexChange: changeHex,
        hexHu: huHex,
        uIdx: upperIdx,
        lIdx: lowerIdx,
        method,
        timestamp,
        question
      };

      history.push(currentResult);
      saveHistory();
      renderHistory();

      const resultDiv = document.getElementById('result');
      const guaName = document.getElementById('guaName');
      const changeGuaName = document.getElementById('changeGuaName');
      const huGuaName = document.getElementById('huGuaName');
      const guaNote = document.getElementById('guaNote');
      const resultTitle = document.getElementById('resultTitle');
      const questionDisplay = document.getElementById('questionDisplay');

      if (!resultDiv || !guaName || !changeGuaName || !huGuaName || !guaNote || !resultTitle || !questionDisplay) {
        console.error('找不到結果顯示相關元素');
        alert('頁面元素載入錯誤，請檢查 HTML 結構！');
        return;
      }

      resultDiv.classList.remove('hidden');
      guaName.textContent = mainHex.name || mainHexName;
      changeGuaName.textContent = changeHex.name || changeHexName;
      huGuaName.textContent = huHex.name || huHexName;
      guaNote.textContent = `本卦：${trigramName[lowerIdx]}為下，${trigramName[upperIdx]}為上，動爻：${moving.join('、') || '無'}，取卦方式：${method}`;
      resultTitle.textContent = '占卜結果';
      questionDisplay.textContent = question ? `問題：${question}` : '';
      questionDisplay.classList.toggle('hidden', !question);

      renderGuaImage(lines, 'guaImage', moving);
      renderGuaImage(changeLines, 'changeGuaImage', moving);
      renderGuaImage(huLines, 'huGuaImage');
      renderLineExplanation(moving, mainHex, changeHex);
    }

    function downloadSvg() {
      const svg = document.getElementById('wuxingSvg');
      if (!svg) {
        alert('無法找到圖表！');
        return;
      }
      const serializer = new XMLSerializer();
      const source = '<?xml version="1.0" standalone="no"?>\r\n' + serializer.serializeToString(svg);
      const blob = new Blob([source], { type: 'image/svg+xml;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      const filename = currentResult.question ? `wuxing_${currentResult.question.slice(0, 20)}.svg` : `wuxing_${new Date().toISOString().replace(/[:.]/g, '-')}.svg`;
      link.href = url;
      link.download = filename;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
    }

    function openSvgInNewWindow() {
      const svg = document.getElementById('wuxingSvg');
      if (!svg) {
        alert('無法找到圖表！');
        return;
      }
      const serializer = new XMLSerializer();
      const svgContent = serializer.serializeToString(svg);
      const styleContent = document.querySelector('style').textContent;
      const newWindow = window.open('', '_blank');
      newWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
          <title>五行生克圖</title>
          <style>
            ${styleContent}
            body { margin: 0; padding: 20px; background: #f4f7f9; font-family: 'Noto Sans TC', sans-serif; }
            svg { display: block; margin: 0 auto; }
          </style>
        </head>
        <body>
          ${svgContent}
        </body>
        </html>
      `);
      newWindow.document.close();
    }

function renderWuxingDiagram(tiGua, mainUpperGua, mainLowerGua, huUpperGua, huLowerGua, changeUpperGua, changeLowerGua, lunarMonth, season, lunarMonthNumber) {
  const svg = document.getElementById('wuxingSvg');
  if (!svg) {
    console.error('找不到 wuxingSvg 元素');
    alert('無法渲染五行圖：SVG元素缺失');
    return;
  }

  // 驗證輸入數據
  const guas = [tiGua, mainUpperGua, mainLowerGua, huUpperGua, huLowerGua, changeUpperGua, changeLowerGua];
  for (const gua of guas) {
    if (!gua || !gua.name || !gua.wuxing) {
      console.error('無效的卦象數據', gua);
      alert('五行圖渲染失敗：卦象數據不完整');
      return;
    }
  }

  // 清空 SVG 並設置屬性
  svg.innerHTML = '';
  svg.setAttribute('width', '600');
  svg.setAttribute('height', '400');
  svg.style.border = '1px solid #ccc';

  // 定義箭頭標記
  svg.innerHTML += `
    <defs>
      <marker id="arrow-generate" viewBox="0 0 10 10" refX="5" refY="5" markerWidth="6" markerHeight="6" orient="auto">
        <path d="M 0 0 L 10 5 L 0 10 z" fill="var(--positive-color)" />
      </marker>
      <marker id="arrow-overcome" viewBox="0 0 10 10" refX="5" refY="5" markerWidth="6" markerHeight="6" orient="auto">
        <path d="M 0 0 L 10 5 L 0 10 z" fill="var(--negative-color)" />
      </marker>
      <marker id="arrow-harmony" viewBox="0 0 10 10" refX="5" refY="5" markerWidth="6" markerHeight="6" orient="auto">
        <path d="M 0 0 L 10 5 L 0 10 z" fill="var(--secondary-color)" />
      </marker>
      <marker id="arrow-harmony-reverse" viewBox="0 0 10 10" refX="5" refY="5" markerWidth="6" markerHeight="6" orient="auto-start-reverse">
        <path d="M 0 0 L 10 5 L 0 10 z" fill="var(--secondary-color)" />
      </marker>
    </defs>
  `;

  // 添加標題和五行狀態文字
  const question = currentResult?.question ? `問題：${currentResult.question.slice(0, 30)}${currentResult.question.length > 30 ? '...' : ''}` : '五行生克圖';
  svg.innerHTML += `<text x="300" y="30" text-anchor="middle" font-size="16" font-weight="bold">${question}</text>`;

  const wuxingStatus = {
    '木': getWuxingStatus('木', lunarMonthNumber) || '未知',
    '火': getWuxingStatus('火', lunarMonthNumber) || '未知',
    '土': getWuxingStatus('土', lunarMonthNumber) || '未知',
    '金': getWuxingStatus('金', lunarMonthNumber) || '未知',
    '水': getWuxingStatus('水', lunarMonthNumber) || '未知'
  };
  const statusText = `農曆：${lunarMonth}（${season}），五行狀態：旺：${Object.keys(wuxingStatus).find(k => wuxingStatus[k] === '旺') || '無'}，` +
                    `相：${Object.keys(wuxingStatus).find(k => wuxingStatus[k] === '相') || '無'}，` +
                    `休：${Object.keys(wuxingStatus).find(k => wuxingStatus[k] === '休') || '無'}，` +
                    `囚：${Object.keys(wuxingStatus).find(k => wuxingStatus[k] === '囚') || '無'}，` +
                    `死：${Object.keys(wuxingStatus).find(k => wuxingStatus[k] === '死') || '無'}`;
  svg.innerHTML += `<text x="300" y="50" text-anchor="middle" font-size="14">${statusText}</text>`;

  // 五行狀態顏色
  const statusColors = {
    '旺': '#FF0000', // 紅色
    '相': '#FFA500', // 橙色
    '休': '#FFFF00', // 黃色
    '囚': '#00FF00', // 綠色
    '死': '#808080', // 灰色
    '未知': '#FFFFFF' // 白色
  };

  // 定義節點
  const nodes = [
    { id: 'ti', name: tiGua.name, wuxing: tiGua.wuxing, x: 300, y: 200, label: '體卦', status: getWuxingStatus(tiGua.wuxing, lunarMonthNumber) || '未知' },
    { id: 'mainUpper', name: mainUpperGua.name, wuxing: mainUpperGua.wuxing, x: 150, y: 100, label: '本卦上卦', status: getWuxingStatus(mainUpperGua.wuxing, lunarMonthNumber) || '未知' },
    { id: 'mainLower', name: mainLowerGua.name, wuxing: mainLowerGua.wuxing, x: 150, y: 300, label: '本卦下卦', status: getWuxingStatus(mainLowerGua.wuxing, lunarMonthNumber) || '未知' },
    { id: 'huUpper', name: huUpperGua.name, wuxing: huUpperGua.wuxing, x: 250, y: 100, label: '互卦上卦', status: getWuxingStatus(huUpperGua.wuxing, lunarMonthNumber) || '未知' },
    { id: 'huLower', name: huLowerGua.name, wuxing: huLowerGua.wuxing, x: 250, y: 300, label: '互卦下卦', status: getWuxingStatus(huLowerGua.wuxing, lunarMonthNumber) || '未知' },
    { id: 'changeUpper', name: changeUpperGua.name, wuxing: changeUpperGua.wuxing, x: 450, y: 100, label: '變卦上卦', status: getWuxingStatus(changeUpperGua.wuxing, lunarMonthNumber) || '未知' },
    { id: 'changeLower', name: changeLowerGua.name, wuxing: changeLowerGua.wuxing, x: 450, y: 300, label: '變卦下卦', status: getWuxingStatus(changeLowerGua.wuxing, lunarMonthNumber) || '未知' }
  ];

  // 預設說明，適應新 JSON 結構
  const defaultExplanations = {
    wuxing_status: {
      '木': { description: '木代表生機、靈活、成長', suggestions: { '旺': '宜拓展創新', '相': '穩健發展', '休': '調整策略', '囚': '謹慎行事', '死': '等待時機', '未知': '狀態未知，建議謹慎觀察' } },
      '火': { description: '火代表熱情、光明、變革', suggestions: { '旺': '宜積極進取', '相': '穩健發展', '休': '保持穩定', '囚': '避免衝突', '死': '低調行事', '未知': '狀態未知，建議謹慎觀察' } },
      '土': { description: '土代表穩重、包容、信任', suggestions: { '旺': '宜穩固基礎', '相': '適宜合作', '休': '注重內在', '囚': '避免變動', '死': '耐心等待', '未知': '狀態未知，建議謹慎觀察' } },
      '金': { description: '金代表剛毅、果斷、正義', suggestions: { '旺': '宜果斷行動', '相': '穩中求進', '休': '儲備力量', '囚': '謹慎決策', '死': '避免爭鬥', '未知': '狀態未知，建議謹慎觀察' } },
      '水': { description: '水代表智慧、流動、謀略', suggestions: { '旺': '宜靈活謀略', '相': '順勢而為', '休': '靜觀其變', '囚': '小心行事', '死': '韜光養晦', '未知': '狀態未知，建議謹慎觀察' } }
    },
    '用生體': { overall: '用卦生體卦，吉利，助力強大。', details: {} },
    '體生用': { overall: '體卦生用卦，耗力，需謹慎。', details: {} },
    '用剋體': { overall: '用卦剋體卦，凶，阻力較大。', details: {} },
    '體剋用': { overall: '體卦剋用卦，吉，主導力強。', details: {} },
    '比和': { overall: '體用比和，平，穩定無大變。', details: {} }
  };

  const explanations = wuxingExplanations || defaultExplanations;

  // 更新 relationMap 以匹配 JSON 鍵名
  const relationMap = {
    '用生體': '用生體',
    '體生用': '體生用',
    '用剋體': '用剋體',
    '體剋用': '體剋用',
    '比和': '比和'
  };

  // 渲染節點
  nodes.forEach(node => {
    const strokeWidth = getWuxingStrength(node.status) || 1;
    const symbol = trigramSymbol[node.name] || node.name;
    const wuxingStatusData = explanations.wuxing_status[node.wuxing] || { description: '無詳細說明', suggestions: { [node.status]: '無建議' } };
    const suggestion = wuxingStatusData.suggestions[node.status] || '無建議';
    const relation = node.id === 'ti' ? '' : getRelation(tiGua.wuxing, node.wuxing) || '未知';
    const relationData = relation && relation !== '未知' ? explanations[relationMap[relation]] || { overall: '無解釋', details: {} } : { overall: '體卦自身，無生剋關係', details: {} };
    const detailKey = relation && relation !== '未知' ? `${node.name}生體` : '';
    const detailData = relation && relation !== '未知' ? relationData.details[detailKey] || { description: '無具體解釋', guidance: '無建議' } : { description: '無具體解釋', guidance: '無建議' };
    const popupText = `${node.label} (${node.name}, ${node.wuxing}, ${node.status})\n描述: ${wuxingStatusData.description}\n與體卦關係: ${relation || '無'}\n關係解釋: ${relationData.overall}\n具體解釋: ${detailData.description}\n建議: ${suggestion}\n指導: ${detailData.guidance}`;
    svg.innerHTML += `
      <circle class="wuxing-node ${node.wuxing.toLowerCase()}" cx="${node.x}" cy="${node.y}" r="40" stroke="black" stroke-width="${strokeWidth}" fill="${statusColors[node.status]}" opacity="0.5" data-id="${node.id}" data-popup="${encodeURIComponent(popupText)}" />
      <text class="wuxing-node-text" x="${node.x}" y="${node.y - 15}" fill="${node.id === 'ti' ? '#0000FF' : '#333'}">${node.name} (${node.wuxing}, ${node.status})</text>
      <text class="wuxing-node-text" x="${node.x}" y="${node.y}" font-size="20">${symbol}</text>
      <text class="wuxing-node-text" x="${node.x}" y="${node.y + 20}">${node.label}</text>
    `;
  });

  // 定義邊（以體卦為核心）
  const edges = [];
  nodes.forEach(node => {
    if (node.id !== 'ti') {
      const relation = getRelation(tiGua.wuxing, node.wuxing) || '未知';
      if (relation === '未知') {
        console.warn(`未知關係: ${tiGua.wuxing} -> ${node.wuxing}`);
        return;
      }
      const relationData = explanations[relationMap[relation]] || { overall: '無解釋', details: {} };
      const detailKey = `${node.name}${relation.replace('體', '').replace('用', '')}體`;
      const detailData = relationData.details[detailKey] || { description: '無具體解釋', guidance: '無建議' };
      let className, source, target, markers, strokeWidth;
      strokeWidth = ((getWuxingStrength(tiGua.status) || 1) + (getWuxingStrength(node.status) || 1)) / 2;
      if (relation === '用生體') {
        className = 'wuxing-edge-generate';
        source = node.id;
        target = 'ti';
        markers = { end: 'url(#arrow-generate)' };
      } else if (relation === '用剋體') {
        className = 'wuxing-edge-overcome';
        source = node.id;
        target = 'ti';
        markers = { end: 'url(#arrow-overcome)' };
      } else if (relation === '比和') {
        className = 'wuxing-edge-harmony';
        source = node.id;
        target = 'ti';
        markers = { start: 'url(#arrow-harmony-reverse)', end: 'url(#arrow-harmony)' };
      } else if (relation === '體生用') {
        className = 'wuxing-edge-generate';
        source = 'ti';
        target = node.id;
        markers = { end: 'url(#arrow-generate)' };
      } else if (relation === '體剋用') {
        className = 'wuxing-edge-overcome';
        source = 'ti';
        target = node.id;
        markers = { end: 'url(#arrow-overcome)' };
      }
      edges.push({ 
        source, 
        target, 
        className, 
        label: relation, 
        markers, 
        strokeWidth,
        title: `${node.label} → 體卦: ${relationData.overall}\n${detailData.description}`
      });
    }
  });

  // 添加互卦和變卦的上下卦關係
  const huRelation = getRelation(huUpperGua.wuxing, huLowerGua.wuxing) || '未知';
  if (huRelation !== '未知') {
    let huClassName, huSource, huTarget, huMarkers;
    const huStrokeWidth = getWuxingStrength(getWuxingStatus(huUpperGua.wuxing, lunarMonthNumber)) || 1;
    const huRelationData = explanations[relationMap[huRelation]] || { overall: '無解釋', details: {} };
    const huDetailKey = `${huLowerGua.name}${huRelation.replace('體', '').replace('用', '')}體`;
    const huDetailData = huRelationData.details[huDetailKey] || { description: '無具體解釋', guidance: '無建議' };
    if (huRelation === '用生體') {
      huClassName = 'wuxing-edge-generate';
      huSource = 'huLower';
      huTarget = 'huUpper';
      huMarkers = { end: 'url(#arrow-generate)' };
    } else if (huRelation === '用剋體') {
      huClassName = 'wuxing-edge-overcome';
      huSource = 'huLower';
      huTarget = 'huUpper';
      huMarkers = { end: 'url(#arrow-overcome)' };
    } else if (huRelation === '比和') {
      huClassName = 'wuxing-edge-harmony';
      huSource = 'huLower';
      huTarget = 'huUpper';
      huMarkers = { start: 'url(#arrow-harmony-reverse)', end: 'url(#arrow-harmony)' };
    } else if (huRelation === '體生用') {
      huClassName = 'wuxing-edge-generate';
      huSource = 'huUpper';
      huTarget = 'huLower';
      huMarkers = { end: 'url(#arrow-generate)' };
    } else if (huRelation === '體剋用') {
      huClassName = 'wuxing-edge-overcome';
      huSource = 'huUpper';
      huTarget = 'huLower';
      huMarkers = { end: 'url(#arrow-overcome)' };
    }
    edges.push({ 
      source: huSource, 
      target: huTarget, 
      className: huClassName, 
      label: huRelation, 
      markers: huMarkers, 
      strokeWidth: huStrokeWidth,
      title: `互卦關係: ${huRelationData.overall}\n${huDetailData.description}`
    });
  }

  const changeRelation = getRelation(changeUpperGua.wuxing, changeLowerGua.wuxing) || '未知';
  if (changeRelation !== '未知') {
    let changeClassName, changeSource, changeTarget, changeMarkers;
    const changeStrokeWidth = getWuxingStrength(getWuxingStatus(changeUpperGua.wuxing, lunarMonthNumber)) || 1;
    const changeRelationData = explanations[relationMap[changeRelation]] || { overall: '無解釋', details: {} };
    const changeDetailKey = `${changeLowerGua.name}${changeRelation.replace('體', '').replace('用', '')}體`;
    const changeDetailData = changeRelationData.details[changeDetailKey] || { description: '無具體解釋', guidance: '無建議' };
    if (changeRelation === '用生體') {
      changeClassName = 'wuxing-edge-generate';
      changeSource = 'changeLower';
      changeTarget = 'changeUpper';
      changeMarkers = { end: 'url(#arrow-generate)' };
    } else if (changeRelation === '用剋體') {
      changeClassName = 'wuxing-edge-overcome';
      changeSource = 'changeLower';
      changeTarget = 'changeUpper';
      changeMarkers = { end: 'url(#arrow-overcome)' };
    } else if (changeRelation === '比和') {
      changeClassName = 'wuxing-edge-harmony';
      changeSource = 'changeLower';
      changeTarget = 'changeUpper';
      changeMarkers = { start: 'url(#arrow-harmony-reverse)', end: 'url(#arrow-harmony)' };
    } else if (changeRelation === '體生用') {
      changeClassName = 'wuxing-edge-generate';
      changeSource = 'changeUpper';
      changeTarget = 'changeLower';
      changeMarkers = { end: 'url(#arrow-generate)' };
    } else if (changeRelation === '體剋用') {
      changeClassName = 'wuxing-edge-overcome';
      changeSource = 'changeUpper';
      changeTarget = 'changeLower';
      changeMarkers = { end: 'url(#arrow-overcome)' };
    }
    edges.push({ 
      source: changeSource, 
      target: changeTarget, 
      className: changeClassName, 
      label: changeRelation, 
      markers: changeMarkers, 
      strokeWidth: changeStrokeWidth,
      title: `變卦關係: ${changeRelationData.overall}\n${changeDetailData.description}`
    });
  }

  // 渲染邊
  edges.forEach(edge => {
    const sourceNode = nodes.find(n => n.id === edge.source);
    const targetNode = nodes.find(n => n.id === edge.target);
    if (!sourceNode || !targetNode) {
      console.warn(`找不到邊的節點: ${edge.source} -> ${edge.target}`);
      return;
    }

    const dx = targetNode.x - sourceNode.x;
    const dy = targetNode.y - sourceNode.y;
    const length = Math.sqrt(dx * dx + dy * dy);
    const offset = 40;
    const sx = sourceNode.x + (dx / length) * offset;
    const sy = sourceNode.y + (dy / length) * offset;
    const tx = targetNode.x - (dx / length) * offset;
    const ty = targetNode.y - (dy / length) * offset;
    const midX = (sx + tx) / 2;
    const midY = (sy + ty) / 2;

    svg.innerHTML += `
      <line class="${edge.className}" x1="${sx}" y1="${sy}" x2="${tx}" y2="${ty}" stroke-width="${edge.strokeWidth}" marker-start="${edge.markers.start || ''}" marker-end="${edge.markers.end || ''}" title="${edge.title}" />
      <text class="wuxing-edge-label" x="${midX}" y="${midY - 10}">${edge.label}</text>
    `;
  });

  // 添加節點交互
  svg.querySelectorAll('.wuxing-node').forEach(node => {
    node.addEventListener('click', () => {
      const nodeId = node.getAttribute('data-id');
      const guaNode = nodes.find(n => n.id === nodeId);
      if (!guaNode) return;
      const popupText = decodeURIComponent(node.getAttribute('data-popup'));
      if (nodeId !== 'ti' && confirm(`${popupText}\n是否將此卦設為體卦重新分析？`)) {
        setNewTiGua(guaNode);
      } else {
        alert(popupText);
      }
    });
  });
}

function setNewTiGua(newTiGua) {
  if (!currentResult) {
    alert('無當前卦象數據，無法重新設置體卦！');
    return;
  }
  const mainUpperGua = getTrigramInfo(currentResult.uIdx);
  const mainLowerGua = getTrigramInfo(currentResult.lIdx);
  const huUpperIdx = triIndexByLines.get(JSON.stringify(currentResult.huLines.slice(3, 6))) || 8;
  const huLowerIdx = triIndexByLines.get(JSON.stringify(currentResult.huLines.slice(0, 3))) || 8;
  const changeUpperIdx = triIndexByLines.get(JSON.stringify(currentResult.changeLines.slice(3, 6))) || 8;
  const changeLowerIdx = triIndexByLines.get(JSON.stringify(currentResult.changeLines.slice(0, 3))) || 8;
  const huUpperGua = getTrigramInfo(huUpperIdx);
  const huLowerGua = getTrigramInfo(huLowerIdx);
  const changeUpperGua = getTrigramInfo(changeUpperIdx);
  const changeLowerGua = getTrigramInfo(changeLowerIdx);
  const date = new Date(currentResult.timestamp);
  const lunar = lunarCalendar.gregorianToLunar(date);
  const { lunarMonth, season, lunarMonthNumber } = lunar;

  // 更新體卦並重新渲染
  renderWuxingDiagram(
    newTiGua,
    mainUpperGua,
    mainLowerGua,
    huUpperGua,
    huLowerGua,
    changeUpperGua,
    changeLowerGua,
    lunarMonth,
    season,
    lunarMonthNumber
  );
  renderWuxingAnalysis(currentResult);
  renderDetailedAnalysis(currentResult);
}

function renderDetailedAnalysis(result) {
  const detailedAnalysis = document.getElementById('detailedAnalysis');
  if (!detailedAnalysis) {
    console.error('找不到 detailedAnalysis 元素');
    return;
  }
  detailedAnalysis.classList.remove('hidden');
  detailedAnalysis.innerHTML = '<h3>詳細解釋</h3>';

  const { tiGua, yongGua } = getTiYong(result);
  const mainUpperGua = getTrigramInfo(result.uIdx);
  const mainLowerGua = getTrigramInfo(result.lIdx);
  const huUpperIdx = triIndexByLines.get(JSON.stringify(result.huLines.slice(3, 6))) || 8;
  const huLowerIdx = triIndexByLines.get(JSON.stringify(result.huLines.slice(0, 3))) || 8;
  const changeUpperIdx = triIndexByLines.get(JSON.stringify(result.changeLines.slice(3, 6))) || 8;
  const changeLowerIdx = triIndexByLines.get(JSON.stringify(result.changeLines.slice(0, 3))) || 8;
  const huUpperGua = getTrigramInfo(huUpperIdx);
  const huLowerGua = getTrigramInfo(huLowerIdx);
  const changeUpperGua = getTrigramInfo(changeUpperIdx);
  const changeLowerGua = getTrigramInfo(changeLowerIdx);

  const date = new Date(result.timestamp);
  const lunar = lunarCalendar.gregorianToLunar(date);
  const { lunarMonth, season, lunarMonthNumber } = lunar;

  const relations = {
    mainUpper: getRelation(tiGua.wuxing, mainUpperGua.wuxing) || '未知',
    mainLower: getRelation(tiGua.wuxing, mainLowerGua.wuxing) || '未知',
    huUpper: getRelation(tiGua.wuxing, huUpperGua.wuxing) || '未知',
    huLower: getRelation(tiGua.wuxing, huLowerGua.wuxing) || '未知',
    changeUpper: getRelation(tiGua.wuxing, changeUpperGua.wuxing) || '未知',
    changeLower: getRelation(tiGua.wuxing, changeLowerGua.wuxing) || '未知'
  };

  const wuxingStatus = {
    ti: getWuxingStatus(tiGua.wuxing, lunarMonthNumber) || '未知',
    mainUpper: getWuxingStatus(mainUpperGua.wuxing, lunarMonthNumber) || '未知',
    mainLower: getWuxingStatus(mainLowerGua.wuxing, lunarMonthNumber) || '未知',
    huUpper: getWuxingStatus(huUpperGua.wuxing, lunarMonthNumber) || '未知',
    huLower: getWuxingStatus(huLowerGua.wuxing, lunarMonthNumber) || '未知',
    changeUpper: getWuxingStatus(changeUpperGua.wuxing, lunarMonthNumber) || '未知',
    changeLower: getWuxingStatus(changeLowerGua.wuxing, lunarMonthNumber) || '未知'
  };

  // 預設說明
  const defaultExplanations = {
    wuxing_status: {
      '木': { description: '木代表生機、靈活、成長', suggestions: { '旺': '宜拓展創新', '相': '穩健發展', '休': '調整策略', '囚': '謹慎行事', '死': '等待時機', '未知': '狀態未知，建議謹慎觀察' } },
      '火': { description: '火代表熱情、光明、變革', suggestions: { '旺': '宜積極進取', '相': '穩健發展', '休': '保持穩定', '囚': '避免衝突', '死': '低調行事', '未知': '狀態未知，建議謹慎觀察' } },
      '土': { description: '土代表穩重、包容、信任', suggestions: { '旺': '宜穩固基礎', '相': '適宜合作', '休': '注重內在', '囚': '避免變動', '死': '耐心等待', '未知': '狀態未知，建議謹慎觀察' } },
      '金': { description: '金代表剛毅、果斷、正義', suggestions: { '旺': '宜果斷行動', '相': '穩中求進', '休': '儲備力量', '囚': '謹慎決策', '死': '避免爭鬥', '未知': '狀態未知，建議謹慎觀察' } },
      '水': { description: '水代表智慧、流動、謀略', suggestions: { '旺': '宜靈活謀略', '相': '順勢而為', '休': '靜觀其變', '囚': '小心行事', '死': '韜光養晦', '未知': '狀態未知，建議謹慎觀察' } }
    },
    '用生體': { overall: '用卦生體卦，吉利，助力強大。', details: {} },
    '體生用': { overall: '體卦生用卦，耗力，需謹慎。', details: {} },
    '用剋體': { overall: '用卦剋體卦，凶，阻力較大。', details: {} },
    '體剋用': { overall: '體卦剋用卦，吉，主導力強。', details: {} },
    '比和': { overall: '體用比和，平，穩定無大變。', details: {} }
  };

  const explanations = wuxingExplanations || defaultExplanations;

  // 更新 relationMap 以匹配 JSON 鍵名
  const relationMap = {
    '用生體': '用生體',
    '體生用': '體生用',
    '用剋體': '用剋體',
    '體剋用': '體剋用',
    '比和': '比和'
  };

  detailedAnalysis.innerHTML += `
    <div class="wuxing-box">
      <h4>五行狀態與建議</h4>
      <p><strong>農曆：</strong> ${lunarMonth}（${season}）</p>
      <p><strong>體卦五行（${tiGua.name}）：</strong> ${tiGua.wuxing} (${wuxingStatus.ti})</p>
      <p><strong>描述：</strong> ${explanations.wuxing_status[tiGua.wuxing]?.description || '無詳細說明'}</p>
      <p><strong>建議：</strong> ${explanations.wuxing_status[tiGua.wuxing]?.suggestions?.[wuxingStatus.ti] || '無建議'}</p>
    </div>
  `;

  const guaMap = {
    mainUpper: { gua: mainUpperGua, label: '本卦上卦' },
    mainLower: { gua: mainLowerGua, label: '本卦下卦' },
    huUpper: { gua: huUpperGua, label: '互卦上卦' },
    huLower: { gua: huLowerGua, label: '互卦下卦' },
    changeUpper: { gua: changeUpperGua, label: '變卦上卦' },
    changeLower: { gua: changeLowerGua, label: '變卦下卦' }
  };

  Object.entries(relations).forEach(([key, relation]) => {
    const { gua, label } = guaMap[key];
    const status = wuxingStatus[key];
    const relationData = relation !== '未知' ? explanations[relationMap[relation]] || { overall: '無解釋', details: {} } : { overall: '無解釋', details: {} };
    const detailKey = relation !== '未知' ? `${gua.name}${relation.replace('體', '').replace('用', '')}體` : '';
    const detailData = relation !== '未知' ? relationData.details[detailKey] || { description: '無具體解釋', guidance: '無建議' } : { description: '無具體解釋', guidance: '無建議' };
    const suggestionKey = result.question?.toLowerCase().includes('事業') ? 'career' : 
                         result.question?.toLowerCase().includes('感情') ? 'love' : 'guidance';
    const suggestion = detailData[suggestionKey] || detailData.guidance || '無建議';
    detailedAnalysis.innerHTML += `
      <div class="wuxing-box">
        <h4>${label}</h4>
        <p><strong>五行：</strong> ${gua.wuxing} (${gua.name})</p>
        <p><strong>狀態：</strong> ${status}</p>
        <p><strong>與體卦關係：</strong> ${relation}</p>
        <p><strong>解釋：</strong> ${relationData.overall}</p>
        <p><strong>具體解釋：</strong> ${detailData.description}</p>
        <p><strong>建議：</strong> ${suggestion}</p>
      </div>
    `;
  });

  if (result.question) {
    const suggestionKey = result.question.toLowerCase().includes('事業') ? 'career' : 
                         result.question.toLowerCase().includes('感情') ? 'love' : 'guidance';
    const relation = relations.mainUpper; // 示例：使用本卦上卦的關係
    const relationData = relation !== '未知' ? explanations[relationMap[relation]] || { details: {} } : { details: {} };
    const detailKey = relation !== '未知' ? `${mainUpperGua.name}${relation.replace('體', '').replace('用', '')}體` : '';
    const detailData = relation !== '未知' ? relationData.details[detailKey] || { [suggestionKey]: '無建議' } : { [suggestionKey]: '無建議' };
    detailedAnalysis.innerHTML += `
      <div class="wuxing-box">
        <h4>問題分析</h4>
        <p><strong>問題：</strong> ${result.question}</p>
        <p><strong>建議：</strong> ${detailData[suggestionKey] || '無建議'}</p>
      </div>
    `;
  }
}

function setNewTiGua(newTiGua) {
  if (!currentResult) {
    alert('無當前卦象數據，無法重新設置體卦！');
    return;
  }
  const mainUpperGua = getTrigramInfo(currentResult.uIdx);
  const mainLowerGua = getTrigramInfo(currentResult.lIdx);
  const huUpperIdx = triIndexByLines.get(JSON.stringify(currentResult.huLines.slice(3, 6))) || 8;
  const huLowerIdx = triIndexByLines.get(JSON.stringify(currentResult.huLines.slice(0, 3))) || 8;
  const changeUpperIdx = triIndexByLines.get(JSON.stringify(currentResult.changeLines.slice(3, 6))) || 8;
  const changeLowerIdx = triIndexByLines.get(JSON.stringify(currentResult.changeLines.slice(0, 3))) || 8;
  const huUpperGua = getTrigramInfo(huUpperIdx);
  const huLowerGua = getTrigramInfo(huLowerIdx);
  const changeUpperGua = getTrigramInfo(changeUpperIdx);
  const changeLowerGua = getTrigramInfo(changeLowerIdx);
  const date = new Date(currentResult.timestamp);
  const lunar = lunarCalendar.gregorianToLunar(date);
  const { lunarMonth, season, lunarMonthNumber } = lunar;

  // 更新體卦並重新渲染
  renderWuxingDiagram(
    newTiGua,
    mainUpperGua,
    mainLowerGua,
    huUpperGua,
    huLowerGua,
    changeUpperGua,
    changeLowerGua,
    lunarMonth,
    season,
    lunarMonthNumber
  );
  renderWuxingAnalysis(currentResult);
  renderDetailedAnalysis(currentResult);
}

function renderDetailedAnalysis(result) {
  const detailedAnalysis = document.getElementById('detailedAnalysis');
  if (!detailedAnalysis) {
    console.error('找不到 detailedAnalysis 元素');
    return;
  }
  detailedAnalysis.classList.remove('hidden');
  detailedAnalysis.innerHTML = '<h3>詳細解釋</h3>';

  const { tiGua, yongGua } = getTiYong(result);
  const mainUpperGua = getTrigramInfo(result.uIdx);
  const mainLowerGua = getTrigramInfo(result.lIdx);
  const huUpperIdx = triIndexByLines.get(JSON.stringify(result.huLines.slice(3, 6))) || 8;
  const huLowerIdx = triIndexByLines.get(JSON.stringify(result.huLines.slice(0, 3))) || 8;
  const changeUpperIdx = triIndexByLines.get(JSON.stringify(result.changeLines.slice(3, 6))) || 8;
  const changeLowerIdx = triIndexByLines.get(JSON.stringify(result.changeLines.slice(0, 3))) || 8;
  const huUpperGua = getTrigramInfo(huUpperIdx);
  const huLowerGua = getTrigramInfo(huLowerIdx);
  const changeUpperGua = getTrigramInfo(changeUpperIdx);
  const changeLowerGua = getTrigramInfo(changeLowerIdx);

  const date = new Date(result.timestamp);
  const lunar = lunarCalendar.gregorianToLunar(date);
  const { lunarMonth, season, lunarMonthNumber } = lunar;

  const relations = {
    mainUpper: getRelation(tiGua.wuxing, mainUpperGua.wuxing) || '未知',
    mainLower: getRelation(tiGua.wuxing, mainLowerGua.wuxing) || '未知',
    huUpper: getRelation(tiGua.wuxing, huUpperGua.wuxing) || '未知',
    huLower: getRelation(tiGua.wuxing, huLowerGua.wuxing) || '未知',
    changeUpper: getRelation(tiGua.wuxing, changeUpperGua.wuxing) || '未知',
    changeLower: getRelation(tiGua.wuxing, changeLowerGua.wuxing) || '未知'
  };

  const wuxingStatus = {
    ti: getWuxingStatus(tiGua.wuxing, lunarMonthNumber) || '未知',
    mainUpper: getWuxingStatus(mainUpperGua.wuxing, lunarMonthNumber) || '未知',
    mainLower: getWuxingStatus(mainLowerGua.wuxing, lunarMonthNumber) || '未知',
    huUpper: getWuxingStatus(huUpperGua.wuxing, lunarMonthNumber) || '未知',
    huLower: getWuxingStatus(huLowerGua.wuxing, lunarMonthNumber) || '未知',
    changeUpper: getWuxingStatus(changeUpperGua.wuxing, lunarMonthNumber) || '未知',
    changeLower: getWuxingStatus(changeLowerGua.wuxing, lunarMonthNumber) || '未知'
  };

  // 預設說明
  const defaultExplanations = {
    wuxing_status: {
      '木': { description: '木代表生長與創意', suggestions: { '旺': '宜積極進取', '相': '穩健發展', '休': '休養生息', '囚': '謹慎行事', '死': '等待時機', '未知': '狀態未知，建議謹慎觀察' } },
      '火': { description: '火代表熱情與變革', suggestions: { '旺': '宜大膽行動', '相': '適度進取', '休': '保持穩定', '囚': '避免衝突', '死': '低調行事', '未知': '狀態未知，建議謹慎觀察' } },
      '土': { description: '土代表穩定與包容', suggestions: { '旺': '宜穩固基礎', '相': '適宜合作', '休': '注重內在', '囚': '避免變動', '死': '耐心等待', '未知': '狀態未知，建議謹慎觀察' } },
      '金': { description: '金代表堅定與收斂', suggestions: { '旺': '宜果斷行動', '相': '穩中求進', '休': '儲備力量', '囚': '謹慎決策', '死': '避免爭鬥', '未知': '狀態未知，建議謹慎觀察' } },
      '水': { description: '水代表智慧與流動', suggestions: { '旺': '宜靈活應變', '相': '順勢而為', '休': '靜觀其變', '囚': '小心行事', '死': '韜光養晦', '未知': '狀態未知，建議謹慎觀察' } }
    },
    generate_ti: { overall: '用卦生體卦，吉利，助力強大。', suggestions: { general: '宜借助外力達成目標。', specific: '尋求合作與資源。' } },
    generate_yong: { overall: '體卦生用卦，耗力，需謹慎。', suggestions: { general: '宜節制行動，避免過度付出。', specific: '注意資源分配。' } },
    overcome_ti: { overall: '用卦剋體卦，凶，阻力較大。', suggestions: { general: '宜低調行事，避免正面衝突。', specific: '尋求緩解壓力的方法。' } },
    overcome_yong: { overall: '體卦剋用卦，吉，主導力強。', suggestions: { general: '宜積極行動，掌控局面。', specific: '抓住主導機會。' } },
    harmony: { overall: '體用比和，平，穩定無大變。', suggestions: { general: '宜保持現狀，穩中求進。', specific: '注重平衡與合作。' } },
    suggestions: {
      career: '事業宜穩中求進，注重團隊合作。',
      relationship: '感情宜坦誠溝通，增進互信。',
      general: '保持平衡，靈活應對變化。'
    }
  };

  const explanations = wuxingExplanations || defaultExplanations;

  detailedAnalysis.innerHTML += `
    <div class="wuxing-box">
      <h4>五行狀態與建議</h4>
      <p><strong>農曆：</strong> ${lunarMonth}（${season}）</p>
      <p><strong>體卦五行（${tiGua.name}）：</strong> ${tiGua.wuxing} (${wuxingStatus.ti})</p>
      <p><strong>描述：</strong> ${explanations.wuxing_status[tiGua.wuxing]?.description || '無詳細說明'}</p>
      <p><strong>建議：</strong> ${explanations.wuxing_status[tiGua.wuxing]?.suggestions?.[wuxingStatus.ti] || '無建議'}</p>
    </div>
  `;

  Object.entries(relations).forEach(([key, relation]) => {
    const guaMap = {
      mainUpper: mainUpperGua,
      mainLower: mainLowerGua,
      huUpper: huUpperGua,
      huLower: huLowerGua,
      changeUpper: changeUpperGua,
      changeLower: changeLowerGua
    };
    const gua = guaMap[key];
    const status = wuxingStatus[key];
    const relationData = relation !== '未知' ? explanations[relationMap[relation]] || { overall: '無解釋', suggestions: { general: '無建議', specific: '無建議' } } : { overall: '無解釋', suggestions: { general: '無建議', specific: '無建議' } };
    detailedAnalysis.innerHTML += `
      <div class="wuxing-box">
        <h4>${key === 'mainUpper' ? '本卦上卦' : key === 'mainLower' ? '本卦下卦' : key === 'huUpper' ? '互卦上卦' : key === 'huLower' ? '互卦下卦' : key === 'changeUpper' ? '變卦上卦' : '變卦下卦'}</h4>
        <p><strong>五行：</strong> ${gua.wuxing} (${gua.name})</p>
        <p><strong>狀態：</strong> ${status}</p>
        <p><strong>與體卦關係：</strong> ${relation}</p>
        <p><strong>解釋：</strong> ${relationData.overall}</p>
        <p><strong>建議：</strong> ${relationData.suggestions[result.question ? 'specific' : 'general']}</p>
      </div>
    `;
  });

  if (result.question) {
    const suggestionKey = result.question.toLowerCase().includes('事業') ? 'career' : 
                         result.question.toLowerCase().includes('感情') ? 'relationship' : 'general';
    detailedAnalysis.innerHTML += `
      <div class="wuxing-box">
        <h4>問題分析</h4>
        <p><strong>問題：</strong> ${result.question}</p>
        <p><strong>建議：</strong> ${explanations.suggestions[suggestionKey]}</p>
      </div>
    `;
  }
}

function setNewTiGua(newTiGua) {
  if (!currentResult) {
    alert('無當前卦象數據，無法重新設置體卦！');
    return;
  }
  const mainUpperGua = getTrigramInfo(currentResult.uIdx);
  const mainLowerGua = getTrigramInfo(currentResult.lIdx);
  const huUpperIdx = triIndexByLines.get(JSON.stringify(currentResult.huLines.slice(3, 6))) || 8;
  const huLowerIdx = triIndexByLines.get(JSON.stringify(currentResult.huLines.slice(0, 3))) || 8;
  const changeUpperIdx = triIndexByLines.get(JSON.stringify(currentResult.changeLines.slice(3, 6))) || 8;
  const changeLowerIdx = triIndexByLines.get(JSON.stringify(currentResult.changeLines.slice(0, 3))) || 8;
  const huUpperGua = getTrigramInfo(huUpperIdx);
  const huLowerGua = getTrigramInfo(huLowerIdx);
  const changeUpperGua = getTrigramInfo(changeUpperIdx);
  const changeLowerGua = getTrigramInfo(changeLowerIdx);
  const date = new Date(currentResult.timestamp);
  const lunar = lunarCalendar.gregorianToLunar(date);
  const { lunarMonth, season, lunarMonthNumber } = lunar;

  // 更新體卦並重新渲染
  renderWuxingDiagram(
    newTiGua,
    mainUpperGua,
    mainLowerGua,
    huUpperGua,
    huLowerGua,
    changeUpperGua,
    changeLowerGua,
    lunarMonth,
    season,
    lunarMonthNumber
  );
  renderWuxingAnalysis(currentResult);
  renderDetailedAnalysis(currentResult);
}

function renderDetailedAnalysis(result) {
  const detailedAnalysis = document.getElementById('detailedAnalysis');
  if (!detailedAnalysis) {
    console.error('找不到 detailedAnalysis 元素');
    return;
  }
  detailedAnalysis.classList.remove('hidden');
  detailedAnalysis.innerHTML = '<h3>詳細解釋</h3>';

  const { tiGua, yongGua } = getTiYong(result);
  const mainUpperGua = getTrigramInfo(result.uIdx);
  const mainLowerGua = getTrigramInfo(result.lIdx);
  const huUpperIdx = triIndexByLines.get(JSON.stringify(result.huLines.slice(3, 6))) || 8;
  const huLowerIdx = triIndexByLines.get(JSON.stringify(result.huLines.slice(0, 3))) || 8;
  const changeUpperIdx = triIndexByLines.get(JSON.stringify(result.changeLines.slice(3, 6))) || 8;
  const changeLowerIdx = triIndexByLines.get(JSON.stringify(result.changeLines.slice(0, 3))) || 8;
  const huUpperGua = getTrigramInfo(huUpperIdx);
  const huLowerGua = getTrigramInfo(huLowerIdx);
  const changeUpperGua = getTrigramInfo(changeUpperIdx);
  const changeLowerGua = getTrigramInfo(changeLowerIdx);

  const date = new Date(result.timestamp);
  const lunar = lunarCalendar.gregorianToLunar(date);
  const { lunarMonth, season, lunarMonthNumber } = lunar;

  const relations = {
    mainUpper: getRelation(tiGua.wuxing, mainUpperGua.wuxing),
    mainLower: getRelation(tiGua.wuxing, mainLowerGua.wuxing),
    huUpper: getRelation(tiGua.wuxing, huUpperGua.wuxing),
    huLower: getRelation(tiGua.wuxing, huLowerGua.wuxing),
    changeUpper: getRelation(tiGua.wuxing, changeUpperGua.wuxing),
    changeLower: getRelation(tiGua.wuxing, changeLowerGua.wuxing)
  };

  const wuxingStatus = {
    ti: getWuxingStatus(tiGua.wuxing, lunarMonthNumber),
    mainUpper: getWuxingStatus(mainUpperGua.wuxing, lunarMonthNumber),
    mainLower: getWuxingStatus(mainLowerGua.wuxing, lunarMonthNumber),
    huUpper: getWuxingStatus(huUpperGua.wuxing, lunarMonthNumber),
    huLower: getWuxingStatus(huLowerGua.wuxing, lunarMonthNumber),
    changeUpper: getWuxingStatus(changeUpperGua.wuxing, lunarMonthNumber),
    changeLower: getWuxingStatus(changeLowerGua.wuxing, lunarMonthNumber)
  };

  // 預設說明
  const defaultExplanations = {
    wuxing_status: {
      '木': { description: '木代表生長與創意', suggestions: { '旺': '宜積極進取', '相': '穩健發展', '休': '休養生息', '囚': '謹慎行事', '死': '等待時機' } },
      '火': { description: '火代表熱情與變革', suggestions: { '旺': '宜大膽行動', '相': '適度進取', '休': '保持穩定', '囚': '避免衝突', '死': '低調行事' } },
      '土': { description: '土代表穩定與包容', suggestions: { '旺': '宜穩固基礎', '相': '適宜合作', '休': '注重內在', '囚': '避免變動', '死': '耐心等待' } },
      '金': { description: '金代表堅定與收斂', suggestions: { '旺': '宜果斷行動', '相': '穩中求進', '休': '儲備力量', '囚': '謹慎決策', '死': '避免爭鬥' } },
      '水': { description: '水代表智慧與流動', suggestions: { '旺': '宜靈活應變', '相': '順勢而為', '休': '靜觀其變', '囚': '小心行事', '死': '韜光養晦' } }
    },
    generate_ti: { overall: '用卦生體卦，吉利，助力強大。', suggestions: { general: '宜借助外力達成目標。', specific: '尋求合作與資源。' } },
    generate_yong: { overall: '體卦生用卦，耗力，需謹慎。', suggestions: { general: '宜節制行動，避免過度付出。', specific: '注意資源分配。' } },
    overcome_ti: { overall: '用卦剋體卦，凶，阻力較大。', suggestions: { general: '宜低調行事，避免正面衝突。', specific: '尋求緩解壓力的方法。' } },
    overcome_yong: { overall: '體卦剋用卦，吉，主導力強。', suggestions: { general: '宜積極行動，掌控局面。', specific: '抓住主導機會。' } },
    harmony: { overall: '體用比和，平，穩定無大變。', suggestions: { general: '宜保持現狀，穩中求進。', specific: '注重平衡與合作。' } },
    suggestions: {
      career: '事業宜穩中求進，注重團隊合作。',
      relationship: '感情宜坦誠溝通，增進互信。',
      general: '保持平衡，靈活應對變化。'
    }
  };

  const explanations = wuxingExplanations || defaultExplanations;

  detailedAnalysis.innerHTML += `
    <div class="wuxing-box">
      <h4>五行狀態與建議</h4>
      <p><strong>農曆：</strong> ${lunarMonth}（${season}）</p>
      <p><strong>體卦五行（${tiGua.name}）：</strong> ${tiGua.wuxing} (${wuxingStatus.ti})</p>
      <p><strong>描述：</strong> ${explanations.wuxing_status[tiGua.wuxing]?.description || '無詳細說明'}</p>
      <p><strong>建議：</strong> ${explanations.wuxing_status[tiGua.wuxing]?.suggestions?.[wuxingStatus.ti] || '無建議'}</p>
    </div>
  `;

  Object.entries(relations).forEach(([key, relation]) => {
    const guaMap = {
      mainUpper: mainUpperGua,
      mainLower: mainLowerGua,
      huUpper: huUpperGua,
      huLower: huLowerGua,
      changeUpper: changeUpperGua,
      changeLower: changeLowerGua
    };
    const gua = guaMap[key];
    const status = wuxingStatus[key];
    const relationData = explanations[relationMap[relation]] || { overall: '無解釋', suggestions: { general: '無建議', specific: '無建議' } };
    detailedAnalysis.innerHTML += `
      <div class="wuxing-box">
        <h4>${key === 'mainUpper' ? '本卦上卦' : key === 'mainLower' ? '本卦下卦' : key === 'huUpper' ? '互卦上卦' : key === 'huLower' ? '互卦下卦' : key === 'changeUpper' ? '變卦上卦' : '變卦下卦'}</h4>
        <p><strong>五行：</strong> ${gua.wuxing} (${gua.name})</p>
        <p><strong>狀態：</strong> ${status}</p>
        <p><strong>與體卦關係：</strong> ${relation}</p>
        <p><strong>解釋：</strong> ${relationData.overall}</p>
        <p><strong>建議：</strong> ${relationData.suggestions[result.question ? 'specific' : 'general']}</p>
      </div>
    `;
  });

  if (result.question) {
    const suggestionKey = result.question.toLowerCase().includes('事業') ? 'career' : 
                         result.question.toLowerCase().includes('感情') ? 'relationship' : 'general';
    detailedAnalysis.innerHTML += `
      <div class="wuxing-box">
        <h4>問題分析</h4>
        <p><strong>問題：</strong> ${result.question}</p>
        <p><strong>建議：</strong> ${explanations.suggestions[suggestionKey]}</p>
      </div>
    `;
  }
}

function setNewTiGua(newTiGua) {
  if (!currentResult) {
    alert('無當前卦象數據，無法重新設置體卦！');
    return;
  }
  const mainUpperGua = getTrigramInfo(currentResult.uIdx);
  const mainLowerGua = getTrigramInfo(currentResult.lIdx);
  const huUpperIdx = triIndexByLines.get(JSON.stringify(currentResult.huLines.slice(3, 6))) || 8;
  const huLowerIdx = triIndexByLines.get(JSON.stringify(currentResult.huLines.slice(0, 3))) || 8;
  const changeUpperIdx = triIndexByLines.get(JSON.stringify(currentResult.changeLines.slice(3, 6))) || 8;
  const changeLowerIdx = triIndexByLines.get(JSON.stringify(currentResult.changeLines.slice(0, 3))) || 8;
  const huUpperGua = getTrigramInfo(huUpperIdx);
  const huLowerGua = getTrigramInfo(huLowerIdx);
  const changeUpperGua = getTrigramInfo(changeUpperIdx);
  const changeLowerGua = getTrigramInfo(changeLowerIdx);
  const date = new Date(currentResult.timestamp);
  const lunar = lunarCalendar.gregorianToLunar(date);
  const { lunarMonth, season, lunarMonthNumber } = lunar;

  // Update tiGua and re-render
  renderWuxingDiagram(
    newTiGua,
    mainUpperGua,
    mainLowerGua,
    huUpperGua,
    huLowerGua,
    changeUpperGua,
    changeLowerGua,
    lunarMonth,
    season,
    lunarMonthNumber
  );
  renderWuxingAnalysis(currentResult);
  renderDetailedAnalysis(currentResult);
}

function renderDetailedAnalysis(result) {
  const detailedAnalysis = document.getElementById('detailedAnalysis');
  if (!detailedAnalysis) {
    console.error('找不到 detailedAnalysis 元素');
    return;
  }
  detailedAnalysis.classList.remove('hidden');
  detailedAnalysis.innerHTML = '<h3>詳細解釋</h3>';

  const { tiGua, yongGua } = getTiYong(result);
  const mainUpperGua = getTrigramInfo(result.uIdx);
  const mainLowerGua = getTrigramInfo(result.lIdx);
  const huUpperIdx = triIndexByLines.get(JSON.stringify(result.huLines.slice(3, 6))) || 8;
  const huLowerIdx = triIndexByLines.get(JSON.stringify(result.huLines.slice(0, 3))) || 8;
  const changeUpperIdx = triIndexByLines.get(JSON.stringify(result.changeLines.slice(3, 6))) || 8;
  const changeLowerIdx = triIndexByLines.get(JSON.stringify(result.changeLines.slice(0, 3))) || 8;
  const huUpperGua = getTrigramInfo(huUpperIdx);
  const huLowerGua = getTrigramInfo(huLowerIdx);
  const changeUpperGua = getTrigramInfo(changeUpperIdx);
  const changeLowerGua = getTrigramInfo(changeLowerIdx);

  const date = new Date(result.timestamp);
  const lunar = lunarCalendar.gregorianToLunar(date);
  const { lunarMonth, season, lunarMonthNumber } = lunar;

  const relations = {
    mainUpper: getRelation(tiGua.wuxing, mainUpperGua.wuxing),
    mainLower: getRelation(tiGua.wuxing, mainLowerGua.wuxing),
    huUpper: getRelation(tiGua.wuxing, huUpperGua.wuxing),
    huLower: getRelation(tiGua.wuxing, huLowerGua.wuxing),
    changeUpper: getRelation(tiGua.wuxing, changeUpperGua.wuxing),
    changeLower: getRelation(tiGua.wuxing, changeLowerGua.wuxing)
  };

  const wuxingStatus = {
    ti: getWuxingStatus(tiGua.wuxing, lunarMonthNumber),
    mainUpper: getWuxingStatus(mainUpperGua.wuxing, lunarMonthNumber),
    mainLower: getWuxingStatus(mainLowerGua.wuxing, lunarMonthNumber),
    huUpper: getWuxingStatus(huUpperGua.wuxing, lunarMonthNumber),
    huLower: getWuxingStatus(huLowerGua.wuxing, lunarMonthNumber),
    changeUpper: getWuxingStatus(changeUpperGua.wuxing, lunarMonthNumber),
    changeLower: getWuxingStatus(changeLowerGua.wuxing, lunarMonthNumber)
  };

  // Default explanations
  const defaultExplanations = {
    wuxing_status: {
      '木': { description: '木代表生長與創意', suggestions: { '旺': '宜積極進取', '相': '穩健發展', '休': '休養生息', '囚': '謹慎行事', '死': '等待時機' } },
      '火': { description: '火代表熱情與變革', suggestions: { '旺': '宜大膽行動', '相': '適度進取', '休': '保持穩定', '囚': '避免衝突', '死': '低調行事' } },
      '土': { description: '土代表穩定與包容', suggestions: { '旺': '宜穩固基礎', '相': '適宜合作', '休': '注重內在', '囚': '避免變動', '死': '耐心等待' } },
      '金': { description: '金代表堅定與收斂', suggestions: { '旺': '宜果斷行動', '相': '穩中求進', '休': '儲備力量', '囚': '謹慎決策', '死': '避免爭鬥' } },
      '水': { description: '水代表智慧與流動', suggestions: { '旺': '宜靈活應變', '相': '順勢而為', '休': '靜觀其變', '囚': '小心行事', '死': '韜光養晦' } }
    },
    generate_ti: { overall: '用卦生體卦，吉利，助力強大。', suggestions: { general: '宜借助外力達成目標。', specific: '尋求合作與資源。' } },
    generate_yong: { overall: '體卦生用卦，耗力，需謹慎。', suggestions: { general: '宜節制行動，避免過度付出。', specific: '注意資源分配。' } },
    overcome_ti: { overall: '用卦剋體卦，凶，阻力較大。', suggestions: { general: '宜低調行事，避免正面衝突。', specific: '尋求緩解壓力的方法。' } },
    overcome_yong: { overall: '體卦剋用卦，吉，主導力強。', suggestions: { general: '宜積極行動，掌控局面。', specific: '抓住主導機會。' } },
    harmony: { overall: '體用比和，平，穩定無大變。', suggestions: { general: '宜保持現狀，穩中求進。', specific: '注重平衡與合作。' } },
    suggestions: {
      career: '事業宜穩中求進，注重團隊合作。',
      relationship: '感情宜坦誠溝通，增進互信。',
      general: '保持平衡，靈活應對變化。'
    }
  };

  const explanations = wuxingExplanations || defaultExplanations;

  detailedAnalysis.innerHTML += `
    <div class="wuxing-box">
      <h4>五行狀態與建議</h4>
      <p><strong>農曆：</strong> ${lunarMonth}（${season}）</p>
      <p><strong>體卦五行（${tiGua.name}）：</strong> ${tiGua.wuxing} (${wuxingStatus.ti})</p>
      <p><strong>描述：</strong> ${explanations.wuxing_status[tiGua.wuxing]?.description || '無詳細說明'}</p>
      <p><strong>建議：</strong> ${explanations.wuxing_status[tiGua.wuxing]?.suggestions?.[wuxingStatus.ti] || '無建議'}</p>
    </div>
  `;

  Object.entries(relations).forEach(([key, relation]) => {
    const guaMap = {
      mainUpper: mainUpperGua,
      mainLower: mainLowerGua,
      huUpper: huUpperGua,
      huLower: huLowerGua,
      changeUpper: changeUpperGua,
      changeLower: changeLowerGua
    };
    const gua = guaMap[key];
    const status = wuxingStatus[key];
    const relationData = explanations[relationMap[relation]] || { overall: '無解釋', suggestions: { general: '無建議', specific: '無建議' } };
    detailedAnalysis.innerHTML += `
      <div class="wuxing-box">
        <h4>${key === 'mainUpper' ? '本卦上卦' : key === 'mainLower' ? '本卦下卦' : key === 'huUpper' ? '互卦上卦' : key === 'huLower' ? '互卦下卦' : key === 'changeUpper' ? '變卦上卦' : '變卦下卦'}</h4>
        <p><strong>五行：</strong> ${gua.wuxing} (${gua.name})</p>
        <p><strong>狀態：</strong> ${status}</p>
        <p><strong>與體卦關係：</strong> ${relation}</p>
        <p><strong>解釋：</strong> ${relationData.overall}</p>
        <p><strong>建議：</strong> ${relationData.suggestions[result.question ? 'specific' : 'general']}</p>
      </div>
    `;
  });

  if (result.question) {
    const suggestionKey = result.question.toLowerCase().includes('事業') ? 'career' : 
                         result.question.toLowerCase().includes('感情') ? 'relationship' : 'general';
    detailedAnalysis.innerHTML += `
      <div class="wuxing-box">
        <h4>問題分析</h4>
        <p><strong>問題：</strong> ${result.question}</p>
        <p><strong>建議：</strong> ${explanations.suggestions[suggestionKey]}</p>
      </div>
    `;
  }
}

// Update event listener in DOMContentLoaded
document.addEventListener('DOMContentLoaded', () => {
  // Existing code...
  document.getElementById('judgeBtn').addEventListener('click', () => {
    if (!currentResult) {
      alert('請先進行取卦！');
      return;
    }
    const judgeBox = document.getElementById('judgeBox');
    if (judgeBox) {
      judgeBox.classList.remove('hidden');
      renderWuxingAnalysis(currentResult);
      renderDetailedAnalysis(currentResult);
    }
  });
  // Existing code...
});

function setNewTiGua(newTiGua) {
  if (!currentResult) {
    alert('無當前卦象數據，無法重新設置體卦！');
    return;
  }
  const mainUpperGua = getTrigramInfo(currentResult.uIdx);
  const mainLowerGua = getTrigramInfo(currentResult.lIdx);
  const huUpperIdx = triIndexByLines.get(JSON.stringify(currentResult.huLines.slice(3, 6))) || 8;
  const huLowerIdx = triIndexByLines.get(JSON.stringify(currentResult.huLines.slice(0, 3))) || 8;
  const changeUpperIdx = triIndexByLines.get(JSON.stringify(currentResult.changeLines.slice(3, 6))) || 8;
  const changeLowerIdx = triIndexByLines.get(JSON.stringify(currentResult.changeLines.slice(0, 3))) || 8;
  const huUpperGua = getTrigramInfo(huUpperIdx);
  const huLowerGua = getTrigramInfo(huLowerIdx);
  const changeUpperGua = getTrigramInfo(changeUpperIdx);
  const changeLowerGua = getTrigramInfo(changeLowerIdx);
  const date = new Date(currentResult.timestamp);
  const lunar = lunarCalendar.gregorianToLunar(date);
  const { lunarMonth, season, lunarMonthNumber } = lunar;

  // Update tiGua and re-render
  renderWuxingDiagram(
    newTiGua,
    mainUpperGua,
    mainLowerGua,
    huUpperGua,
    huLowerGua,
    changeUpperGua,
    changeLowerGua,
    lunarMonth,
    season,
    lunarMonthNumber
  );
  renderWuxingAnalysis(currentResult);
  renderDetailedAnalysis(currentResult);
}

function renderDetailedAnalysis(result) {
  const detailedAnalysis = document.getElementById('detailedAnalysis');
  if (!detailedAnalysis) {
    console.error('找不到 detailedAnalysis 元素');
    return;
  }
  detailedAnalysis.classList.remove('hidden');
  detailedAnalysis.innerHTML = '<h3>詳細解釋</h3>';

  const { tiGua, yongGua } = getTiYong(result);
  const mainUpperGua = getTrigramInfo(result.uIdx);
  const mainLowerGua = getTrigramInfo(result.lIdx);
  const huUpperIdx = triIndexByLines.get(JSON.stringify(result.huLines.slice(3, 6))) || 8;
  const huLowerIdx = triIndexByLines.get(JSON.stringify(result.huLines.slice(0, 3))) || 8;
  const changeUpperIdx = triIndexByLines.get(JSON.stringify(result.changeLines.slice(3, 6))) || 8;
  const changeLowerIdx = triIndexByLines.get(JSON.stringify(result.changeLines.slice(0, 3))) || 8;
  const huUpperGua = getTrigramInfo(huUpperIdx);
  const huLowerGua = getTrigramInfo(huLowerIdx);
  const changeUpperGua = getTrigramInfo(changeUpperIdx);
  const changeLowerGua = getTrigramInfo(changeLowerIdx);

  const date = new Date(result.timestamp);
  const lunar = lunarCalendar.gregorianToLunar(date);
  const { lunarMonth, season, lunarMonthNumber } = lunar;

  const relations = {
    mainUpper: getRelation(tiGua.wuxing, mainUpperGua.wuxing),
    mainLower: getRelation(tiGua.wuxing, mainLowerGua.wuxing),
    huUpper: getRelation(tiGua.wuxing, huUpperGua.wuxing),
    huLower: getRelation(tiGua.wuxing, huLowerGua.wuxing),
    changeUpper: getRelation(tiGua.wuxing, changeUpperGua.wuxing),
    changeLower: getRelation(tiGua.wuxing, changeLowerGua.wuxing)
  };

  const wuxingStatus = {
    ti: getWuxingStatus(tiGua.wuxing, lunarMonthNumber),
    mainUpper: getWuxingStatus(mainUpperGua.wuxing, lunarMonthNumber),
    mainLower: getWuxingStatus(mainLowerGua.wuxing, lunarMonthNumber),
    huUpper: getWuxingStatus(huUpperGua.wuxing, lunarMonthNumber),
    huLower: getWuxingStatus(huLowerGua.wuxing, lunarMonthNumber),
    changeUpper: getWuxingStatus(changeUpperGua.wuxing, lunarMonthNumber),
    changeLower: getWuxingStatus(changeLowerGua.wuxing, lunarMonthNumber)
  };

  // Default explanations if wuxingExplanations is missing
  const defaultExplanations = {
    wuxing_status: {
      '木': { description: '木代表生長與創意', suggestions: { '旺': '宜積極進取', '相': '穩健發展', '休': '休養生息', '囚': '謹慎行事', '死': '等待時機' } },
      '火': { description: '火代表熱情與變革', suggestions: { '旺': '宜大膽行動', '相': '適度進取', '休': '保持穩定', '囚': '避免衝突', '死': '低調行事' } },
      '土': { description: '土代表穩定與包容', suggestions: { '旺': '宜穩固基礎', '相': '適宜合作', '休': '注重內在', '囚': '避免變動', '死': '耐心等待' } },
      '金': { description: '金代表堅定與收斂', suggestions: { '旺': '宜果斷行動', '相': '穩中求進', '休': '儲備力量', '囚': '謹慎決策', '死': '避免爭鬥' } },
      '水': { description: '水代表智慧與流動', suggestions: { '旺': '宜靈活應變', '相': '順勢而為', '休': '靜觀其變', '囚': '小心行事', '死': '韜光養晦' } }
    },
    generate_ti: { overall: '用卦生體卦，吉利，助力強大。', suggestions: { general: '宜借助外力達成目標。', specific: '尋求合作與資源。' } },
    generate_yong: { overall: '體卦生用卦，耗力，需謹慎。', suggestions: { general: '宜節制行動，避免過度付出。', specific: '注意資源分配。' } },
    overcome_ti: { overall: '用卦剋體卦，凶，阻力較大。', suggestions: { general: '宜低調行事，避免正面衝突。', specific: '尋求緩解壓力的方法。' } },
    overcome_yong: { overall: '體卦剋用卦，吉，主導力強。', suggestions: { general: '宜積極行動，掌控局面。', specific: '抓住主導機會。' } },
    harmony: { overall: '體用比和，平，穩定無大變。', suggestions: { general: '宜保持現狀，穩中求進。', specific: '注重平衡與合作。' } },
    suggestions: {
      career: '事業宜穩中求進，注重團隊合作。',
      relationship: '感情宜坦誠溝通，增進互信。',
      general: '保持平衡，靈活應對變化。'
    }
  };

  const explanations = wuxingExplanations || defaultExplanations;

  detailedAnalysis.innerHTML += `
    <div class="wuxing-box">
      <h4>五行狀態與建議</h4>
      <p><strong>農曆：</strong> ${lunarMonth}（${season}）</p>
      <p><strong>體卦五行（${tiGua.name}）：</strong> ${tiGua.wuxing} (${wuxingStatus.ti})</p>
      <p><strong>描述：</strong> ${explanations.wuxing_status[tiGua.wuxing]?.description || '無詳細說明'}</p>
      <p><strong>建議：</strong> ${explanations.wuxing_status[tiGua.wuxing]?.suggestions?.[wuxingStatus.ti] || '無建議'}</p>
    </div>
  `;

  Object.entries(relations).forEach(([key, relation]) => {
    const guaMap = {
      mainUpper: mainUpperGua,
      mainLower: mainLowerGua,
      huUpper: huUpperGua,
      huLower: huLowerGua,
      changeUpper: changeUpperGua,
      changeLower: changeLowerGua
    };
    const gua = guaMap[key];
    const status = wuxingStatus[key];
    const relationData = explanations[relationMap[relation]] || { overall: '無解釋', suggestions: { general: '無建議', specific: '無建議' } };
    detailedAnalysis.innerHTML += `
      <div class="wuxing-box">
        <h4>${key === 'mainUpper' ? '本卦上卦' : key === 'mainLower' ? '本卦下卦' : key === 'huUpper' ? '互卦上卦' : key === 'huLower' ? '互卦下卦' : key === 'changeUpper' ? '變卦上卦' : '變卦下卦'}</h4>
        <p><strong>五行：</strong> ${gua.wuxing} (${gua.name})</p>
        <p><strong>狀態：</strong> ${status}</p>
        <p><strong>與體卦關係：</strong> ${relation}</p>
        <p><strong>解釋：</strong> ${relationData.overall}</p>
        <p><strong>建議：</strong> ${relationData.suggestions[result.question ? 'specific' : 'general']}</p>
      </div>
    `;
  });

  if (result.question) {
    const suggestionKey = result.question.toLowerCase().includes('事業') ? 'career' : 
                         result.question.toLowerCase().includes('感情') ? 'relationship' : 'general';
    detailedAnalysis.innerHTML += `
      <div class="wuxing-box">
        <h4>問題分析</h4>
        <p><strong>問題：</strong> ${result.question}</p>
        <p><strong>建議：</strong> ${explanations.suggestions[suggestionKey]}</p>
      </div>
    `;
  }
}

// Update event listener in DOMContentLoaded
document.addEventListener('DOMContentLoaded', () => {
  // Existing code...
  document.getElementById('judgeBtn').addEventListener('click', () => {
    if (!currentResult) {
      alert('請先進行取卦！');
      return;
    }
    const judgeBox = document.getElementById('judgeBox');
    if (judgeBox) {
      judgeBox.classList.remove('hidden');
      renderWuxingAnalysis(currentResult);
      renderDetailedAnalysis(currentResult);
    }
  });
  // Existing code...
});

function renderWuxingAnalysis(result) {
  if (!result || !result.uIdx || !result.lIdx) {
    console.error('無效的結果數據', result);
    alert('無法分析五行：結果數據不完整');
    return;
  }

  const { tiGua, yongGua } = getTiYong(result);
  const mainUpperGua = getTrigramInfo(result.uIdx);
  const mainLowerGua = getTrigramInfo(result.lIdx);
  const huUpperIdx = triIndexByLines.get(JSON.stringify(result.huLines.slice(3, 6))) || 8;
  const huLowerIdx = triIndexByLines.get(JSON.stringify(result.huLines.slice(0, 3))) || 8;
  const changeUpperIdx = triIndexByLines.get(JSON.stringify(result.changeLines.slice(3, 6))) || 8;
  const changeLowerIdx = triIndexByLines.get(JSON.stringify(result.changeLines.slice(0, 3))) || 8;
  const huUpperGua = getTrigramInfo(huUpperIdx);
  const huLowerGua = getTrigramInfo(huLowerIdx);
  const changeUpperGua = getTrigramInfo(changeUpperIdx);
  const changeLowerGua = getTrigramInfo(changeLowerIdx);

  const date = new Date(result.timestamp);
  const lunar = lunarCalendar.gregorianToLunar(date);
  const { lunarMonth, season, lunarMonthNumber } = lunar;

  // Update DOM elements
  document.getElementById('mainUpperWuxing').textContent = `${mainUpperGua.wuxing} (${mainUpperGua.name})`;
  document.getElementById('mainLowerWuxing').textContent = `${mainLowerGua.wuxing} (${mainLowerGua.name})`;
  document.getElementById('huUpperWuxing').textContent = `${huUpperGua.wuxing} (${huUpperGua.name})`;
  document.getElementById('huLowerWuxing').textContent = `${huLowerGua.wuxing} (${huLowerGua.name})`;
  document.getElementById('changeUpperWuxing').textContent = `${changeUpperGua.wuxing} (${changeUpperGua.name})`;
  document.getElementById('changeLowerWuxing').textContent = `${changeLowerGua.wuxing} (${changeLowerGua.name})`;
  document.getElementById('tiGuaWuxing').textContent = tiGua.wuxing;
  document.getElementById('tiGuaWuxing2').textContent = tiGua.wuxing;
  document.getElementById('tiGuaWuxing3').textContent = tiGua.wuxing;
  document.getElementById('tiGuaWuxing4').textContent = tiGua.wuxing;
  document.getElementById('tiGuaWuxing5').textContent = tiGua.wuxing;
  document.getElementById('tiGuaWuxing6').textContent = tiGua.wuxing;

  const relations = {
    mainUpperRelation: getRelation(tiGua.wuxing, mainUpperGua.wuxing),
    mainLowerRelation: getRelation(tiGua.wuxing, mainLowerGua.wuxing),
    huUpperRelation: getRelation(tiGua.wuxing, huUpperGua.wuxing),
    huLowerRelation: getRelation(tiGua.wuxing, huLowerGua.wuxing),
    changeUpperRelation: getRelation(tiGua.wuxing, changeUpperGua.wuxing),
    changeLowerRelation: getRelation(tiGua.wuxing, changeLowerGua.wuxing)
  };

  // Update relation statuses
  Object.keys(relations).forEach(id => {
    const element = document.getElementById(id);
    if (element) {
      element.textContent = relations[id];
      element.classList.remove('positive', 'neutral', 'negative');
      if (['用生體', '體剋用'].includes(relations[id])) {
        element.classList.add('positive');
      } else if (relations[id] === '比和') {
        element.classList.add('neutral');
      } else if (['體生用', '用剋體'].includes(relations[id])) {
        element.classList.add('negative');
      }
    }
  });

  // Calculate auspiciousness index
  const scores = [
    getRelationScore(relations.mainUpperRelation),
    getRelationScore(relations.mainLowerRelation),
    getRelationScore(relations.huUpperRelation),
    getRelationScore(relations.huLowerRelation),
    getRelationScore(relations.changeUpperRelation),
    getRelationScore(relations.changeLowerRelation)
  ];
  const wuxingScores = [
    getWuxingStrength(getWuxingStatus(tiGua.wuxing, lunarMonthNumber)),
    getWuxingStrength(getWuxingStatus(mainUpperGua.wuxing, lunarMonthNumber)),
    getWuxingStrength(getWuxingStatus(mainLowerGua.wuxing, lunarMonthNumber)),
    getWuxingStrength(getWuxingStatus(huUpperGua.wuxing, lunarMonthNumber)),
    getWuxingStrength(getWuxingStatus(huLowerGua.wuxing, lunarMonthNumber)),
    getWuxingStrength(getWuxingStatus(changeUpperGua.wuxing, lunarMonthNumber)),
    getWuxingStrength(getWuxingStatus(changeLowerGua.wuxing, lunarMonthNumber))
  ];
  const lineScores = result.moving.map(lineIdx => getLineEntryFor(result.hexMain, lineIdx).score || 5);
  const avgLineScore = lineScores.length > 0 ? lineScores.reduce((a, b) => a + b, 0) / lineScores.length : 5;
  const totalScore = (
    scores.reduce((a, b) => a + b, 0) * 0.4 +
    wuxingScores.reduce((a, b) => a + b, 0) / wuxingScores.length * 0.4 +
    avgLineScore * 0.2
  );
  const auspiciousnessIndex = clamp(Math.round(totalScore * 2));

  // Update auspiciousness bar
  const auspiciousnessBar = document.getElementById('auspiciousnessBar');
  const auspiciousnessIndexText = document.getElementById('auspiciousnessIndex');
  if (auspiciousnessBar && auspiciousnessIndexText) {
    const percentage = (auspiciousnessIndex / 10) * 100;
    const color = percentage >= 70 ? 'var(--positive-color)' : percentage >= 40 ? 'var(--secondary-color)' : 'var(--negative-color)';
    auspiciousnessBar.innerHTML = `<div class="score-bar" style="width: ${percentage}%; background: ${color};"></div>`;
    auspiciousnessIndexText.textContent = `吉凶指數：${auspiciousnessIndex}/10`;
  }

  // Render moving line scores
  const movingLineScores = document.getElementById('movingLineScores');
  if (movingLineScores) {
    movingLineScores.innerHTML = '';
    result.moving.forEach(lineIdx => {
      const lineEntry = getLineEntryFor(result.hexMain, lineIdx);
      const percentage = (lineEntry.score / 10) * 100;
      const color = percentage >= 70 ? 'var(--positive-color)' : percentage >= 40 ? 'var(--secondary-color)' : 'var(--negative-color)';
      movingLineScores.innerHTML += `
        <div class="score-card">
          <span>第 ${lineIdx} 爻評分：${lineEntry.score}/10</span>
          <div class="score-bar-wrap">
            <div class="score-bar" style="width: ${percentage}%; background: ${color};"></div>
          </div>
        </div>
      `;
    });
  }

  // Render the Wuxing diagram
  renderWuxingDiagram(
    tiGua,
    mainUpperGua,
    mainLowerGua,
    huUpperGua,
    huLowerGua,
    changeUpperGua,
    changeLowerGua,
    lunarMonth,
    season,
    lunarMonthNumber
  );
}

function renderDetailedAnalysis(result) {
  const detailedAnalysis = document.getElementById('detailedAnalysis');
  if (!detailedAnalysis) {
    console.error('找不到 detailedAnalysis 元素');
    return;
  }
  detailedAnalysis.classList.remove('hidden');
  detailedAnalysis.innerHTML = '<h3>詳細解釋</h3>';

  const { tiGua, yongGua } = getTiYong(result);
  const mainUpperGua = getTrigramInfo(result.uIdx);
  const mainLowerGua = getTrigramInfo(result.lIdx);
  const huUpperIdx = triIndexByLines.get(JSON.stringify(result.huLines.slice(3, 6))) || 8;
  const huLowerIdx = triIndexByLines.get(JSON.stringify(result.huLines.slice(0, 3))) || 8;
  const changeUpperIdx = triIndexByLines.get(JSON.stringify(result.changeLines.slice(3, 6))) || 8;
  const changeLowerIdx = triIndexByLines.get(JSON.stringify(result.changeLines.slice(0, 3))) || 8;
  const huUpperGua = getTrigramInfo(huUpperIdx);
  const huLowerGua = getTrigramInfo(huLowerIdx);
  const changeUpperGua = getTrigramInfo(changeUpperIdx);
  const changeLowerGua = getTrigramInfo(changeLowerIdx);

  const date = new Date(result.timestamp);
  const lunar = lunarCalendar.gregorianToLunar(date);
  const { lunarMonth, season, lunarMonthNumber } = lunar;

  const relations = {
    mainUpper: getRelation(tiGua.wuxing, mainUpperGua.wuxing),
    mainLower: getRelation(tiGua.wuxing, mainLowerGua.wuxing),
    huUpper: getRelation(tiGua.wuxing, huUpperGua.wuxing),
    huLower: getRelation(tiGua.wuxing, huLowerGua.wuxing),
    changeUpper: getRelation(tiGua.wuxing, changeUpperGua.wuxing),
    changeLower: getRelation(tiGua.wuxing, changeLowerGua.wuxing)
  };

  const wuxingStatus = {
    ti: getWuxingStatus(tiGua.wuxing, lunarMonthNumber),
    mainUpper: getWuxingStatus(mainUpperGua.wuxing, lunarMonthNumber),
    mainLower: getWuxingStatus(mainLowerGua.wuxing, lunarMonthNumber),
    huUpper: getWuxingStatus(huUpperGua.wuxing, lunarMonthNumber),
    huLower: getWuxingStatus(huLowerGua.wuxing, lunarMonthNumber),
    changeUpper: getWuxingStatus(changeUpperGua.wuxing, lunarMonthNumber),
    changeLower: getWuxingStatus(changeLowerGua.wuxing, lunarMonthNumber)
  };

  detailedAnalysis.innerHTML += `
    <div class="wuxing-box">
      <h4>五行狀態與建議</h4>
      <p><strong>農曆：</strong> ${lunarMonth}（${season}）</p>
      <p><strong>體卦五行（${tiGua.name}）：</strong> ${tiGua.wuxing} (${wuxingStatus.ti})</p>
      <p><strong>建議：</strong> ${wuxingExplanations.wuxing_status?.[tiGua.wuxing]?.suggestions?.[wuxingStatus.ti] || '無建議'}</p>
    </div>
  `;

  Object.entries(relations).forEach(([key, relation]) => {
    const guaMap = {
      mainUpper: mainUpperGua,
      mainLower: mainLowerGua,
      huUpper: huUpperGua,
      huLower: huLowerGua,
      changeUpper: changeUpperGua,
      changeLower: changeLowerGua
    };
    const gua = guaMap[key];
    const status = wuxingStatus[key];
    const relationData = wuxingExplanations?.[relationMap[relation]] || { overall: '未知', suggestions: {} };
    detailedAnalysis.innerHTML += `
      <div class="wuxing-box">
        <h4>${key === 'mainUpper' ? '本卦上卦' : key === 'mainLower' ? '本卦下卦' : key === 'huUpper' ? '互卦上卦' : key === 'huLower' ? '互卦下卦' : key === 'changeUpper' ? '變卦上卦' : '變卦下卦'}</h4>
        <p><strong>五行：</strong> ${gua.wuxing} (${gua.name})</p>
        <p><strong>狀態：</strong> ${status}</p>
        <p><strong>與體卦關係：</strong> ${relation}</p>
        <p><strong>解釋：</strong> ${relationData.overall || '無解釋'}</p>
        <p><strong>建議：</strong> ${relationData.suggestions?.[result.question ? 'specific' : 'general'] || '無建議'}</p>
      </div>
    `;
  });

  if (result.question) {
    detailedAnalysis.innerHTML += `
      <div class="wuxing-box">
        <h4>問題分析</h4>
        <p><strong>問題：</strong> ${result.question}</p>
        <p><strong>建議：</strong> ${wuxingExplanations.suggestions?.[result.question.toLowerCase().includes('事業') ? 'career' : result.question.toLowerCase().includes('感情') ? 'relationship' : 'general'] || '根據卦象，建議謹慎行事，靜觀其變。'}</p>
      </div>
    `;
  }
}

// Initialize event listeners
document.addEventListener('DOMContentLoaded', () => {
  loadResources();
  loadHistory();

  // Tab switching
  document.querySelectorAll('.tab-button').forEach(button => {
    button.addEventListener('click', () => {
      document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      button.classList.add('active');
      document.getElementById(button.dataset.target).classList.add('active');
    });
  });

  // Number divination
  document.getElementById('btnNumber').addEventListener('click', () => {
    const numUpper = parseInt(document.getElementById('numUpper').value);
    const numLower = parseInt(document.getElementById('numLower').value);
    const numMoving = parseInt(document.getElementById('numMoving').value);
    if (isNaN(numUpper) || isNaN(numLower) || isNaN(numMoving) || 
        numUpper < 100 || numUpper > 999 || 
        numLower < 100 || numLower > 999 || 
        numMoving < 100 || numMoving > 999) {
      alert('請輸入有效的三位數（100-999）！');
      return;
    }
    const upperIdx = (numUpper % 8) || 8;
    const lowerIdx = (numLower % 8) || 8;
    const moving = [(numMoving % 6) || 6];
    generateGua(upperIdx, lowerIdx, moving, '數字取卦');
  });

  document.getElementById('btnRandomNumber').addEventListener('click', () => {
    const upperIdx = Math.floor(Math.random() * 8) + 1;
    const lowerIdx = Math.floor(Math.random() * 8) + 1;
    const moving = [Math.floor(Math.random() * 6) + 1];
    generateGua(upperIdx, lowerIdx, moving, '數字亂數取卦');
  });

  // Manual divination
  document.getElementById('btnManual').addEventListener('click', () => {
    const upperIdx = parseInt(document.getElementById('selUpper').value);
    const lowerIdx = parseInt(document.getElementById('selLower').value);
    const movingInput = document.getElementById('inputMoving').value;
    if (!upperIdx || !lowerIdx) {
      alert('請選擇上卦和下卦！');
      return;
    }
    const moving = movingInput.split(',').map(Number).filter(n => n >= 1 && n <= 6);
    generateGua(upperIdx, lowerIdx, moving, '手動取卦');
  });

  // Time-based divination
  document.getElementById('btnTime').addEventListener('click', () => {
    const method = document.querySelector('input[name="time-method"]:checked').value;
    let upperIdx, lowerIdx, moving, timestamp;
    if (method === 'modern') {
      const dtInput = document.getElementById('dtInput').value;
      if (!dtInput) {
        alert('請選擇日期時間！');
        return;
      }
      const date = new Date(dtInput);
      timestamp = date.toLocaleString('zh-TW');
      const year = date.getFullYear();
      const month = date.getMonth() + 1;
      const day = date.getDate();
      const hour = date.getHours();
      const minute = date.getMinutes();
      const total = year + month + day + hour + minute;
      upperIdx = (total % 8) || 8;
      lowerIdx = ((month + day + hour) % 8) || 8;
      moving = [(minute % 6) || 6];
    } else {
      const dateInput = document.getElementById('dateInput').value;
      const shichen = parseInt(document.getElementById('shichenInput').value);
      const minute = parseInt(document.getElementById('minuteInput').value) || 0;
      if (!dateInput || isNaN(shichen)) {
        alert('請選擇日期和時辰！');
        return;
      }
      const date = new Date(dateInput);
      timestamp = `${date.toLocaleDateString('zh-TW')} ${shichen}:00`;
      const year = date.getFullYear();
      const month = date.getMonth() + 1;
      const day = date.getDate();
      const total = year + month + day + shichen + minute;
      upperIdx = (total % 8) || 8;
      lowerIdx = ((month + day + shichen) % 8) || 8;
      moving = [(minute % 6) || 6];
    }
    generateGua(upperIdx, lowerIdx, moving, method === 'modern' ? '現代時間取卦' : '傳統時辰取卦', timestamp);
  });

  document.getElementById('nowQuick').addEventListener('click', () => {
    const now = new Date();
    document.getElementById('dtInput').value = now.toISOString().slice(0, 16);
  });

  // Image-based divination
  document.getElementById('btnImage').addEventListener('click', () => {
    const upperIdx = parseInt(document.getElementById('upperImageSelect').value);
    const lowerIdx = parseInt(document.getElementById('lowerDirectionSelect').value);
    const useMinute = document.getElementById('imageUseMinute').checked;
    let moving;
    if (!upperIdx || !lowerIdx) {
      alert('請選擇上卦和下卦！');
      return;
    }
    if (useMinute) {
      const minute = new Date().getMinutes();
      moving = [(minute % 6) || 6];
    } else {
      const movingInput = parseInt(document.getElementById('imageMovingInput').value);
      if (isNaN(movingInput) || movingInput < 1 || movingInput > 6) {
        alert('請輸入有效的動爻（1-6）！');
        return;
      }
      moving = [movingInput];
    }
    generateGua(upperIdx, lowerIdx, moving, '以象取卦');
  });

  // History management
  document.getElementById('clearHistoryBtn').addEventListener('click', () => {
    if (confirm('確定要清除所有歷史記錄嗎？')) {
      history = [];
      saveHistory();
      renderHistory();
    }
  });

  document.getElementById('exportHistoryBtn').addEventListener('click', exportHistory);

  document.getElementById('importHistoryBtn').addEventListener('click', () => {
    const input = document.getElementById('importHistoryInput');
    if (input.files.length > 0) {
      importHistory(input.files[0]);
    } else {
      alert('請選擇一個 JSON 檔案！');
    }
  });

  // Wuxing analysis
  document.getElementById('judgeBtn').addEventListener('click', () => {
    if (!currentResult) {
      alert('請先進行取卦！');
      return;
    }
    const judgeBox = document.getElementById('judgeBox');
    if (judgeBox) {
      judgeBox.classList.remove('hidden');
      renderWuxingAnalysis(currentResult);
      renderDetailedAnalysis(currentResult);
    }
  });

  document.getElementById('downloadSvgBtn').addEventListener('click', downloadSvg);
  document.getElementById('openSvgWindowBtn').addEventListener('click', openSvgInNewWindow);

  // Time method toggle
  document.querySelectorAll('input[name="time-method"]').forEach(radio => {
    radio.addEventListener('change', () => {
      document.getElementById('modern-time-inputs').classList.toggle('hidden', radio.value !== 'modern');
      document.getElementById('traditional-time-inputs').classList.toggle('hidden', radio.value !== 'traditional');
    });
  });
});
  </script>
</body>
</html>
