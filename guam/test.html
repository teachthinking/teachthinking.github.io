```html
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>五行生克圖</title>
  <style>
    :root {
      --positive-color: #00FF00; /* 綠色，生 */
      --negative-color: #FF0000; /* 紅色，剋 */
      --secondary-color: #0000FF; /* 藍色，比和 */
    }
    #wuxingSvg {
      border: 1px solid #ccc;
      margin: 20px auto;
      display: block;
    }
    .wuxing-node {
      cursor: pointer;
    }
    .wuxing-edge-generate {
      stroke: var(--positive-color);
    }
    .wuxing-edge-overcome {
      stroke: var(--negative-color);
    }
    .wuxing-edge-harmony {
      stroke: var(--secondary-color);
    }
    .wuxing-edge-label {
      font-size: 12px;
      text-anchor: middle;
      fill: #333;
    }
    .wuxing-box {
      margin: 10px 0;
      padding: 10px;
      border: 1px solid #ccc;
    }
    .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <div>
    <input type="text" id="questionInput" placeholder="輸入問題">
    <button onclick="triggerAnalysis()">判斷</button>
  </div>
  <svg id="wuxingSvg" width="600" height="400"></svg>
  <div id="detailedAnalysis" class="hidden"></div>

  <script>
    // 模擬依賴函數（需替換為實際實現）
    const trigramSymbol = {
      '乾': '☰', '坤': '☷', '震': '☳', '巽': '☴',
      '坎': '☵', '離': '☲', '艮': '☶', '兌': '☱'
    };

    function getWuxingStatus(wuxing, lunarMonthNumber) {
      const statusMap = {
        '木': { 1: '旺', 2: '相', 3: '休', 4: '囚', 5: '死', 6: '死', 7: '囚', 8: '休', 9: '相', 10: '旺', 11: '旺', 12: '相' },
        '火': { 1: '囚', 2: '死', 3: '旺', 4: '相', 5: '休', 6: '休', 7: '死', 8: '囚', 9: '旺', 10: '相', 11: '囚', 12: '死' },
        '土': { 1: '相', 2: '旺', 3: '死', 4: '死', 5: '囚', 6: '囚', 7: '旺', 8: '相', 9: '死', 10: '死', 11: '相', 12: '旺' },
        '金': { 1: '休', 2: '囚', 3: '囚', 4: '死', 5: '旺', 6: '相', 7: '相', 8: '旺', 9: '休', 10: '囚', 11: '休', 12: '囚' },
        '水': { 1: '死', 2: '休', 3: '相', 4: '旺', 5: '相', 6: '死', 7: '休', 8: '死', 9: '囚', 10: '休', 11: '死', 12: '旺' }
      };
      return statusMap[wuxing]?.[lunarMonthNumber] || '未知';
    }

    function getWuxingStrength(status) {
      const strengthMap = { '旺': 4, '相': 3, '休': 2, '囚': 1, '死': 0, '未知': 1 };
      return strengthMap[status] || 1;
    }

    function getRelation(wuxing1, wuxing2) {
      const generate = { '木': '火', '火': '土', '土': '金', '金': '水', '水': '木' };
      const overcome = { '木': '土', '火': '金', '土': '水', '金': '木', '水': '火' };
      if (wuxing1 === wuxing2) return '比和';
      if (generate[wuxing1] === wuxing2) return '體生用';
      if (generate[wuxing2] === wuxing1) return '用生體';
      if (overcome[wuxing1] === wuxing2) return '體剋用';
      if (overcome[wuxing2] === wuxing1) return '用剋體';
      return '未知';
    }

    const triIndexByLines = new Map([
      ['[1,1,1]', 0], // 乾
      ['[0,0,0]', 1], // 坤
      ['[0,1,1]', 2], // 震
      ['[1,0,0]', 3], // 巽
      ['[1,0,1]', 4], // 坎
      ['[0,1,0]', 5], // 離
      ['[1,1,0]', 6], // 艮
      ['[0,0,1]', 7]  // 兌
    ]);

    function getTrigramInfo(index) {
      const trigrams = [
        { name: '乾', wuxing: '金' },
        { name: '坤', wuxing: '土' },
        { name: '震', wuxing: '木' },
        { name: '巽', wuxing: '木' },
        { name: '坎', wuxing: '水' },
        { name: '離', wuxing: '火' },
        { name: '艮', wuxing: '土' },
        { name: '兌', wuxing: '金' }
      ];
      return trigrams[index] || { name: '未知', wuxing: '未知' };
    }

    const lunarCalendar = {
      gregorianToLunar: (date) => {
        // 模擬農曆計算，實際需替換
        const month = date.getMonth() + 1;
        const lunarMonth = `農曆${month}月`;
        const season = Math.floor((month - 1) / 3) % 4 === 0 ? '春' : 
                       Math.floor((month - 1) / 3) % 4 === 1 ? '夏' : 
                       Math.floor((month - 1) / 3) % 4 === 2 ? '秋' : '冬';
        return { lunarMonth, season, lunarMonthNumber: month };
      }
    };

    // 模擬當前卦象數據
    let currentResult = {
      question: '事業運勢如何？',
      uIdx: 0, // 乾
      lIdx: 1, // 坤
      huLines: [0, 1, 1, 1, 0, 0], // 震、巽
      changeLines: [1, 0, 1, 0, 1, 0], // 坎、離
      timestamp: new Date('2025-08-27T21:35:00')
    };

    // wuxingExplanations 應從 JSON 文件加載，確保全局可用
    const wuxingExplanations = {
      // 這裡應為您提供的 wuxing_explanations.json 內容
      // 為了演示，嵌入部分數據
      "用生體": {
        "overall": "這是一個大吉的卦象，代表外在環境或貴人對您主動付出，使您無須費力就能心想事成。",
        "details": {
          "乾卦生體": {
            "title": "乾金生體卦",
            "description": "主有官方、公職、長輩或尊貴人士相助。事情能得到官方認可，或因名聲、地位而獲利。有意外之財，或長輩饋贈。",
            "love": "感情上得到長輩支持，或對方地位顯赫，能為您帶來幫助。",
            "career": "事業上得貴人提拔，或有升職加薪、名聲遠播的機會。",
            "wealth": "財運來自長輩、官方或高層人士，或有投資黃金、珠寶獲利之喜。",
            "guidance": "請多向長輩或有經驗的人請教，他們將是您的貴人。"
          }
          // ... 其他卦象
        }
      },
      // ... 其他關係（體生用、用剋體、體剋用、比和、體用同宮）
      "wuxing_status": {
        "金": {
          "description": "代表剛毅、果斷、正義，宜在秋季行動。",
          "suggestions": {
            "旺": "金旺，宜果斷行動，展現領導力。",
            "相": "金相，宜穩中求進，借助權威。",
            "休": "金休，宜謹慎，尋求水屬性助力。",
            "囚": "金囚，宜低調，借助土屬性支持。",
            "死": "金死，宜暫緩，尋求水或土助力。"
          }
        },
        "木": { /* ... */ },
        "火": { /* ... */ },
        "土": { /* ... */ },
        "水": { /* ... */ }
      }
    };

    function renderWuxingDiagram(tiGua, mainUpperGua, mainLowerGua, huUpperGua, huLowerGua, changeUpperGua, changeLowerGua, lunarMonth, season, lunarMonthNumber) {
      const svg = document.getElementById('wuxingSvg');
      if (!svg) {
        console.error('找不到 wuxingSvg 元素');
        alert('無法渲染五行圖：SVG元素缺失');
        return;
      }

      // 驗證輸入數據
      const guas = [tiGua, mainUpperGua, mainLowerGua, huUpperGua, huLowerGua, changeUpperGua, changeLowerGua];
      for (const gua of guas) {
        if (!gua || !gua.name || !gua.wuxing) {
          console.error('無效的卦象數據', gua);
          alert('五行圖渲染失敗：卦象數據不完整');
          return;
        }
      }

      // 清空 SVG 並設置屬性
      svg.innerHTML = '';
      svg.setAttribute('width', '600');
      svg.setAttribute('height', '400');
      svg.style.border = '1px solid #ccc';

      // 定義箭頭標記
      svg.innerHTML += `
        <defs>
          <marker id="arrow-generate" viewBox="0 0 10 10" refX="5" refY="5" markerWidth="6" markerHeight="6" orient="auto">
            <path d="M 0 0 L 10 5 L 0 10 z" fill="var(--positive-color)" />
          </marker>
          <marker id="arrow-overcome" viewBox="0 0 10 10" refX="5" refY="5" markerWidth="6" markerHeight="6" orient="auto">
            <path d="M 0 0 L 10 5 L 0 10 z" fill="var(--negative-color)" />
          </marker>
          <marker id="arrow-harmony" viewBox="0 0 10 10" refX="5" refY="5" markerWidth="6" markerHeight="6" orient="auto">
            <path d="M 0 0 L 10 5 L 0 10 z" fill="var(--secondary-color)" />
          </marker>
          <marker id="arrow-harmony-reverse" viewBox="0 0 10 10" refX="5" refY="5" markerWidth="6" markerHeight="6" orient="auto-start-reverse">
            <path d="M 0 0 L 10 5 L 0 10 z" fill="var(--secondary-color)" />
          </marker>
        </defs>
      `;

      // 添加標題和五行狀態文字
      const question = currentResult?.question ? `問題：${currentResult.question.slice(0, 30)}${currentResult.question.length > 30 ? '...' : ''}` : '五行生克圖';
      svg.innerHTML += `<text x="300" y="30" text-anchor="middle" font-size="16" font-weight="bold">${question}</text>`;

      const wuxingStatus = {
        '木': getWuxingStatus('木', lunarMonthNumber) || '未知',
        '火': getWuxingStatus('火', lunarMonthNumber) || '未知',
        '土': getWuxingStatus('土', lunarMonthNumber) || '未知',
        '金': getWuxingStatus('金', lunarMonthNumber) || '未知',
        '水': getWuxingStatus('水', lunarMonthNumber) || '未知'
      };
      const statusText = `農曆：${lunarMonth}（${season}），五行狀態：旺：${Object.keys(wuxingStatus).find(k => wuxingStatus[k] === '旺') || '無'}，` +
                        `相：${Object.keys(wuxingStatus).find(k => wuxingStatus[k] === '相') || '無'}，` +
                        `休：${Object.keys(wuxingStatus).find(k => wuxingStatus[k] === '休') || '無'}，` +
                        `囚：${Object.keys(wuxingStatus).find(k => wuxingStatus[k] === '囚') || '無'}，` +
                        `死：${Object.keys(wuxingStatus).find(k => wuxingStatus[k] === '死') || '無'}`;
      svg.innerHTML += `<text x="300" y="50" text-anchor="middle" font-size="14">${statusText}</text>`;

      // 五行狀態顏色
      const statusColors = {
        '旺': '#FF0000',
        '相': '#FFA500',
        '休': '#FFFF00',
        '囚': '#00FF00',
        '死': '#808080',
        '未知': '#FFFFFF'
      };

      // 定義節點
      const nodes = [
        { id: 'ti', name: tiGua.name, wuxing: tiGua.wuxing, x: 300, y: 200, label: '體卦', status: getWuxingStatus(tiGua.wuxing, lunarMonthNumber) || '未知' },
        { id: 'mainUpper', name: mainUpperGua.name, wuxing: mainUpperGua.wuxing, x: 150, y: 100, label: '本卦上卦', status: getWuxingStatus(mainUpperGua.wuxing, lunarMonthNumber) || '未知' },
        { id: 'mainLower', name: mainLowerGua.name, wuxing: mainLowerGua.wuxing, x: 150, y: 300, label: '本卦下卦', status: getWuxingStatus(mainLowerGua.wuxing, lunarMonthNumber) || '未知' },
        { id: 'huUpper', name: huUpperGua.name, wuxing: huUpperGua.wuxing, x: 250, y: 100, label: '互卦上卦', status: getWuxingStatus(huUpperGua.wuxing, lunarMonthNumber) || '未知' },
        { id: 'huLower', name: huLowerGua.name, wuxing: huLowerGua.wuxing, x: 250, y: 300, label: '互卦下卦', status: getWuxingStatus(huLowerGua.wuxing, lunarMonthNumber) || '未知' },
        { id: 'changeUpper', name: changeUpperGua.name, wuxing: changeUpperGua.wuxing, x: 450, y: 100, label: '變卦上卦', status: getWuxingStatus(changeUpperGua.wuxing, lunarMonthNumber) || '未知' },
        { id: 'changeLower', name: changeLowerGua.name, wuxing: changeLowerGua.wuxing, x: 450, y: 300, label: '變卦下卦', status: getWuxingStatus(changeLowerGua.wuxing, lunarMonthNumber) || '未知' }
      ];

      // 預設說明
      const defaultExplanations = {
        wuxing_status: {
          '木': { description: '木代表生機、靈活、成長', suggestions: { '旺': '宜拓展創新', '相': '穩健發展', '休': '調整策略', '囚': '謹慎行事', '死': '等待時機', '未知': '狀態未知，建議謹慎觀察' } },
          '火': { description: '火代表熱情、光明、變革', suggestions: { '旺': '宜積極進取', '相': '穩健發展', '休': '保持穩定', '囚': '避免衝突', '死': '低調行事', '未知': '狀態未知，建議謹慎觀察' } },
          '土': { description: '土代表穩重、包容、信任', suggestions: { '旺': '宜穩固基礎', '相': '適宜合作', '休': '注重內在', '囚': '避免變動', '死': '耐心等待', '未知': '狀態未知，建議謹慎觀察' } },
          '金': { description: '金代表剛毅、果斷、正義', suggestions: { '旺': '宜果斷行動', '相': '穩中求進', '休': '儲備力量', '囚': '謹慎決策', '死': '避免爭鬥', '未知': '狀態未知，建議謹慎觀察' } },
          '水': { description: '水代表智慧、流動、謀略', suggestions: { '旺': '宜靈活謀略', '相': '順勢而為', '休': '靜觀其變', '囚': '小心行事', '死': '韜光養晦', '未知': '狀態未知，建議謹慎觀察' } }
        },
        '用生體': { overall: '用卦生體卦，吉利，助力強大。', details: {} },
        '體生用': { overall: '體卦生用卦，耗力，需謹慎。', details: {} },
        '用剋體': { overall: '用卦剋體卦，凶，阻力較大。', details: {} },
        '體剋用': { overall: '體卦剋用卦，吉，主導力強。', details: {} },
        '比和': { overall: '體用比和，平，穩定無大變。', details: {} }
      };

      // 確保 explanations 有值
      const explanations = wuxingExplanations || defaultExplanations;
      if (!explanations.wuxing_status) {
        console.error('wuxing_status 未定義，使用預設值');
        explanations.wuxing_status = defaultExplanations.wuxing_status;
      }

      // 更新 relationMap
      const relationMap = {
        '用生體': '用生體',
        '體生用': '體生用',
        '用剋體': '用剋體',
        '體�克用': '體剋用',
        '比和': '比和'
      };

      // 渲染節點
      nodes.forEach(node => {
        const strokeWidth = getWuxingStrength(node.status) || 1;
        const symbol = trigramSymbol[node.name] || node.name;
        const wuxingStatusData = explanations.wuxing_status[node.wuxing] || { description: '無詳細說明', suggestions: { [node.status]: '無建議' } };
        const suggestion = wuxingStatusData.suggestions?.[node.status] || '無建議';
        const relation = node.id === 'ti' ? '' : getRelation(tiGua.wuxing, node.wuxing) || '未知';
        const relationData = relation && relation !== '未知' ? explanations[relationMap[relation]] || { overall: '無解釋', details: {} } : { overall: '體卦自身，無生剋關係', details: {} };
        const detailKey = relation && relation !== '未知' ? `${node.name}${relation.replace('體', '').replace('用', '')}體` : '';
        const detailData = relation && relation !== '未知' ? relationData.details[detailKey] || { description: '無具體解釋', guidance: '無建議' } : { description: '無具體解釋', guidance: '無建議' };
        const popupText = `${node.label} (${node.name}, ${node.wuxing}, ${node.status})\n描述: ${wuxingStatusData.description}\n與體卦關係: ${relation || '無'}\n關係解釋: ${relationData.overall}\n具體解釋: ${detailData.description}\n建議: ${suggestion}\n指導: ${detailData.guidance}`;
        svg.innerHTML += `
          <circle class="wuxing-node ${node.wuxing.toLowerCase()}" cx="${node.x}" cy="${node.y}" r="40" stroke="black" stroke-width="${strokeWidth}" fill="${statusColors[node.status]}" opacity="0.5" data-id="${node.id}" data-popup="${encodeURIComponent(popupText)}" />
          <text class="wuxing-node-text" x="${node.x}" y="${node.y - 15}" fill="${node.id === 'ti' ? '#0000FF' : '#333'}">${node.name} (${node.wuxing}, ${node.status})</text>
          <text class="wuxing-node-text" x="${node.x}" y="${node.y}" font-size="20">${symbol}</text>
          <text class="wuxing-node-text" x="${node.x}" y="${node.y + 20}">${node.label}</text>
        `;
      });

      // 定義邊
      const edges = [];
      nodes.forEach(node => {
        if (node.id !== 'ti') {
          const relation = getRelation(tiGua.wuxing, node.wuxing) || '未知';
          if (relation === '未知') {
            console.warn(`未知關係: ${tiGua.wuxing} -> ${node.wuxing}`);
            return;
          }
          const relationData = explanations[relationMap[relation]] || { overall: '無解釋', details: {} };
          const detailKey = `${node.name}${relation.replace('體', '').replace('用', '')}體`;
          const detailData = relationData.details[detailKey] || { description: '無具體解釋', guidance: '無建議' };
          let className, source, target, markers, strokeWidth;
          strokeWidth = ((getWuxingStrength(tiGua.status) || 1) + (getWuxingStrength(node.status) || 1)) / 2;
          if (relation === '用生體') {
            className = 'wuxing-edge-generate';
            source = node.id;
            target = 'ti';
            markers = { end: 'url(#arrow-generate)' };
          } else if (relation === '用剋體') {
            className = 'wuxing-edge-overcome';
            source = node.id;
            target = 'ti';
            markers = { end: 'url(#arrow-overcome)' };
          } else if (relation === '比和') {
            className = 'wuxing-edge-harmony';
            source = node.id;
            target = 'ti';
            markers = { start: 'url(#arrow-harmony-reverse)', end: 'url(#arrow-harmony)' };
          } else if (relation === '體生用') {
            className = 'wuxing-edge-generate';
            source = 'ti';
            target = node.id;
            markers = { end: 'url(#arrow-generate)' };
          } else if (relation === '體剋用') {
            className = 'wuxing-edge-overcome';
            source = 'ti';
            target = node.id;
            markers = { end: 'url(#arrow-overcome)' };
          }
          edges.push({ 
            source, 
            target, 
            className, 
            label: relation, 
            markers, 
            strokeWidth,
            title: `${node.label} → 體卦: ${relationData.overall}\n${detailData.description}`
          });
        }
      });

      // 添加互卦和變卦的上下卦關係
      const huRelation = getRelation(huUpperGua.wuxing, huLowerGua.wuxing) || '未知';
      if (huRelation !== '未知') {
        let huClassName, huSource, huTarget, huMarkers;
        const huStrokeWidth = getWuxingStrength(getWuxingStatus(huUpperGua.wuxing, lunarMonthNumber)) || 1;
        const huRelationData = explanations[relationMap[huRelation]] || { overall: '無解釋', details: {} };
        const huDetailKey = `${huLowerGua.name}${huRelation.replace('體', '').replace('用', '')}體`;
        const huDetailData = huRelationData.details[huDetailKey] || { description: '無具體解釋', guidance: '無建議' };
        if (huRelation === '用生體') {
          huClassName = 'wuxing-edge-generate';
          huSource = 'huLower';
          huTarget = 'huUpper';
          huMarkers = { end: 'url(#arrow-generate)' };
        } else if (huRelation === '用剋體') {
          huClassName = 'wuxing-edge-overcome';
          huSource = 'huLower';
          huTarget = 'huUpper';
          huMarkers = { end: 'url(#arrow-overcome)' };
        } else if (huRelation === '比和') {
          huClassName = 'wuxing-edge-harmony';
          huSource = 'huLower';
          huTarget = 'huUpper';
          huMarkers = { start: 'url(#arrow-harmony-reverse)', end: 'url(#arrow-harmony)' };
        } else if (huRelation === '體生用') {
          huClassName = 'wuxing-edge-generate';
          huSource = 'huUpper';
          huTarget = 'huLower';
          huMarkers = { end: 'url(#arrow-generate)' };
        } else if (huRelation === '體剋用') {
          huClassName = 'wuxing-edge-overcome';
          huSource = 'huUpper';
          huTarget = 'huLower';
          huMarkers = { end: 'url(#arrow-overcome)' };
        }
        edges.push({ 
          source: huSource, 
          target: huTarget, 
          className: huClassName, 
          label: huRelation, 
          markers: huMarkers, 
          strokeWidth: huStrokeWidth,
          title: `互卦關係: ${huRelationData.overall}\n${huDetailData.description}`
        });
      }

      const changeRelation = getRelation(changeUpperGua.wuxing, changeLowerGua.wuxing) || '未知';
      if (changeRelation !== '未知') {
        let changeClassName, changeSource, changeTarget, changeMarkers;
        const changeStrokeWidth = getWuxingStrength(getWuxingStatus(changeUpperGua.wuxing, lunarMonthNumber)) || 1;
        const changeRelationData = explanations[relationMap[changeRelation]] || { overall: '無解釋', details: {} };
        const changeDetailKey = `${changeLowerGua.name}${changeRelation.replace('體', '').replace('用', '')}體`;
        const changeDetailData = changeRelationData.details[changeDetailKey] || { description: '無具體解釋', guidance: '無建議' };
        if (changeRelation === '用生體') {
          changeClassName = 'wuxing-edge-generate';
          changeSource = 'changeLower';
          changeTarget = 'changeUpper';
          changeMarkers = { end: 'url(#arrow-generate)' };
        } else if (changeRelation === '用剋體') {
          changeClassName = 'wuxing-edge-overcome';
          changeSource = 'changeLower';
          changeTarget = 'changeUpper';
          changeMarkers = { end: 'url(#arrow-overcome)' };
        } else if (changeRelation === '比和') {
          changeClassName = 'wuxing-edge-harmony';
          changeSource = 'changeLower';
          changeTarget = 'changeUpper';
          changeMarkers = { start: 'url(#arrow-harmony-reverse)', end: 'url(#arrow-harmony)' };
        } else if (changeRelation === '體生用') {
          changeClassName = 'wuxing-edge-generate';
          changeSource = 'changeUpper';
          changeTarget = 'changeLower';
          changeMarkers = { end: 'url(#arrow-generate)' };
        } else if (changeRelation === '體剋用') {
          changeClassName = 'wuxing-edge-overcome';
          changeSource = 'changeUpper';
          changeTarget = 'changeLower';
          changeMarkers = { end: 'url(#arrow-overcome)' };
        }
        edges.push({ 
          source: changeSource, 
          target: changeTarget, 
          className: changeClassName, 
          label: changeRelation, 
          markers: changeMarkers, 
          strokeWidth: changeStrokeWidth,
          title: `變卦關係: ${changeRelationData.overall}\n${changeDetailData.description}`
        });
      }

      // 渲染邊
      edges.forEach(edge => {
        const sourceNode = nodes.find(n => n.id === edge.source);
        const targetNode = nodes.find(n => n.id === edge.target);
        if (!sourceNode || !targetNode) {
          console.warn(`找不到邊的節點: ${edge.source} -> ${edge.target}`);
          return;
        }

        const dx = targetNode.x - sourceNode.x;
        const dy = targetNode.y - sourceNode.y;
        const length = Math.sqrt(dx * dx + dy * dy);
        const offset = 40;
        const sx = sourceNode.x + (dx / length) * offset;
        const sy = sourceNode.y + (dy / length) * offset;
        const tx = targetNode.x - (dx / length) * offset;
        const ty = targetNode.y - (dy / length) * offset;
        const midX = (sx + tx) / 2;
        const midY = (sy + ty) / 2;

        svg.innerHTML += `
          <line class="${edge.className}" x1="${sx}" y1="${sy}" x2="${tx}" y2="${ty}" stroke-width="${edge.strokeWidth}" marker-start="${edge.markers.start || ''}" marker-end="${edge.markers.end || ''}" title="${edge.title}" />
          <text class="wuxing-edge-label" x="${midX}" y="${midY - 10}">${edge.label}</text>
        `;
      });

      // 添加節點交互
      svg.querySelectorAll('.wuxing-node').forEach(node => {
        node.addEventListener('click', () => {
          const nodeId = node.getAttribute('data-id');
          const guaNode = nodes.find(n => n.id === nodeId);
          if (!guaNode) return;
          const popupText = decodeURIComponent(node.getAttribute('data-popup'));
          if (nodeId !== 'ti' && confirm(`${popupText}\n是否將此卦設為體卦重新分析？`)) {
            setNewTiGua(guaNode);
          } else {
            alert(popupText);
          }
        });
      });
    }

    function setNewTiGua(newTiGua) {
      if (!currentResult) {
        alert('無當前卦象數據，無法重新設置體卦！');
        return;
      }
      const mainUpperGua = getTrigramInfo(currentResult.uIdx);
      const mainLowerGua = getTrigramInfo(currentResult.lIdx);
      const huUpperIdx = triIndexByLines.get(JSON.stringify(currentResult.huLines.slice(3, 6))) || 8;
      const huLowerIdx = triIndexByLines.get(JSON.stringify(currentResult.huLines.slice(0, 3))) || 8;
      const changeUpperIdx = triIndexByLines.get(JSON.stringify(currentResult.changeLines.slice(3, 6))) || 8;
      const changeLowerIdx = triIndexByLines.get(JSON.stringify(currentResult.changeLines.slice(0, 3))) || 8;
      const huUpperGua = getTrigramInfo(huUpperIdx);
      const huLowerGua = getTrigramInfo(huLowerIdx);
      const changeUpperGua = getTrigramInfo(changeUpperIdx);
      const changeLowerGua = getTrigramInfo(changeLowerIdx);
      const date = new Date(currentResult.timestamp);
      const lunar = lunarCalendar.gregorianToLunar(date);
      const { lunarMonth, season, lunarMonthNumber } = lunar;

      renderWuxingDiagram(
        newTiGua,
        mainUpperGua,
        mainLowerGua,
        huUpperGua,
        huLowerGua,
        changeUpperGua,
        changeLowerGua,
        lunarMonth,
        season,
        lunarMonthNumber
      );
      renderWuxingAnalysis(currentResult);
      renderDetailedAnalysis(currentResult);
    }

    function getTiYong(result) {
      // 模擬體用卦選擇，實際需根據規則實現
      return { tiGua: getTrigramInfo(result.uIdx), yongGua: getTrigramInfo(result.lIdx) };
    }

    function renderWuxingAnalysis(result) {
      const date = new Date(result.timestamp);
      const lunar = lunarCalendar.gregorianToLunar(date);
      const { lunarMonth, season, lunarMonthNumber } = lunar;
      const mainUpperGua = getTrigramInfo(result.uIdx);
      const mainLowerGua = getTrigramInfo(result.lIdx);
      const huUpperIdx = triIndexByLines.get(JSON.stringify(result.huLines.slice(3, 6))) || 8;
      const huLowerIdx = triIndexByLines.get(JSON.stringify(result.huLines.slice(0, 3))) || 8;
      const changeUpperIdx = triIndexByLines.get(JSON.stringify(result.changeLines.slice(3, 6))) || 8;
      const changeLowerIdx = triIndexByLines.get(JSON.stringify(result.changeLines.slice(0, 3))) || 8;
      const huUpperGua = getTrigramInfo(huUpperIdx);
      const huLowerGua = getTrigramInfo(huLowerIdx);
      const changeUpperGua = getTrigramInfo(changeUpperIdx);
      const changeLowerGua = getTrigramInfo(changeLowerIdx);

      renderWuxingDiagram(
        getTrigramInfo(result.uIdx), // 假設上卦為體卦
        mainUpperGua,
        mainLowerGua,
        huUpperGua,
        huLowerGua,
        changeUpperGua,
        changeLowerGua,
        lunarMonth,
        season,
        lunarMonthNumber
      );
      renderDetailedAnalysis(result);
    }

    function renderDetailedAnalysis(result) {
      const detailedAnalysis = document.getElementById('detailedAnalysis');
      if (!detailedAnalysis) {
        console.error('找不到 detailedAnalysis 元素');
        return;
      }
      detailedAnalysis.classList.remove('hidden');
      detailedAnalysis.innerHTML = '<h3>詳細解釋</h3>';

      const { tiGua, yongGua } = getTiYong(result);
      const mainUpperGua = getTrigramInfo(result.uIdx);
      const mainLowerGua = getTrigramInfo(result.lIdx);
      const huUpperIdx = triIndexByLines.get(JSON.stringify(result.huLines.slice(3, 6))) || 8;
      const huLowerIdx = triIndexByLines.get(JSON.stringify(result.huLines.slice(0, 3))) || 8;
      const changeUpperIdx = triIndexByLines.get(JSON.stringify(result.changeLines.slice(3, 6))) || 8;
      const changeLowerIdx = triIndexByLines.get(JSON.stringify(result.changeLines.slice(0, 3))) || 8;
      const huUpperGua = getTrigramInfo(huUpperIdx);
      const huLowerGua = getTrigramInfo(huLowerIdx);
      const changeUpperGua = getTrigramInfo(changeUpperIdx);
      const changeLowerGua = getTrigramInfo(changeLowerIdx);

      const date = new Date(result.timestamp);
      const lunar = lunarCalendar.gregorianToLunar(date);
      const { lunarMonth, season, lunarMonthNumber } = lunar;

      const relations = {
        mainUpper: getRelation(tiGua.wuxing, mainUpperGua.wuxing) || '未知',
        mainLower: getRelation(tiGua.wuxing, mainLowerGua.wuxing) || '未知',
        huUpper: getRelation(tiGua.wuxing, huUpperGua.wuxing) || '未知',
        huLower: getRelation(tiGua.wuxing, huLowerGua.wuxing) || '未知',
        changeUpper: getRelation(tiGua.wuxing, changeUpperGua.wuxing) || '未知',
        changeLower: getRelation(tiGua.wuxing, changeLowerGua.wuxing) || '未知'
      };

      const wuxingStatus = {
        ti: getWuxingStatus(tiGua.wuxing, lunarMonthNumber) || '未知',
        mainUpper: getWuxingStatus(mainUpperGua.wuxing, lunarMonthNumber) || '未知',
        mainLower: getWuxingStatus(mainLowerGua.wuxing, lunarMonthNumber) || '未知',
        huUpper: getWuxingStatus(huUpperGua.wuxing, lunarMonthNumber) || '未知',
        huLower: getWuxingStatus(huLowerGua.wuxing, lunarMonthNumber) || '未知',
        changeUpper: getWuxingStatus(changeUpperGua.wuxing, lunarMonthNumber) || '未知',
        changeLower: getWuxingStatus(changeLowerGua.wuxing, lunarMonthNumber) || '未知'
      };

      const defaultExplanations = {
        wuxing_status: {
          '木': { description: '木代表生機、靈活、成長', suggestions: { '旺': '宜拓展創新', '相': '穩健發展', '休': '調整策略', '囚': '謹慎行事', '死': '等待時機', '未知': '狀態未知，建議謹慎觀察' } },
          '火': { description: '火代表熱情、光明、變革', suggestions: { '旺': '宜積極進取', '相': '穩健發展', '休': '保持穩定', '囚': '避免衝突', '死': '低調行事', '未知': '狀態未知，建議謹慎觀察' } },
          '土': { description: '土代表穩重、包容、信任', suggestions: { '旺': '宜穩固基礎', '相': '適宜合作', '休': '注重內在', '囚': '避免變動', '死': '耐心等待', '未知': '狀態未知，建議謹慎觀察' } },
          '金': { description: '金代表剛毅、果斷、正義', suggestions: { '旺': '宜果斷行動', '相': '穩中求進', '休': '儲備力量', '囚': '謹慎決策', '死': '避免爭鬥', '未知': '狀態未知，建議謹慎觀察' } },
          '水': { description: '水代表智慧、流動、謀略', suggestions: { '旺': '宜靈活謀略', '相': '順勢而為', '休': '靜觀其變', '囚': '小心行事', '死': '韜光養晦', '未知': '狀態未知，建議謹慎觀察' } }
        },
        '用生體': { overall: '用卦生體卦，吉利，助力強大。', details: {} },
        '體生用': { overall: '體卦生用卦，耗力，需謹慎。', details: {} },
        '用剋體': { overall: '用卦剋體卦，凶，阻力較大。', details: {} },
        '體剋用': { overall: '體卦剋用卦，吉，主導力強。', details: {} },
        '比和': { overall: '體用比和，平，穩定無大變。', details: {} }
      };

      const explanations = wuxingExplanations || defaultExplanations;
      if (!explanations.wuxing_status) {
        console.error('wuxing_status 未定義，使用預設值');
        explanations.wuxing_status = defaultExplanations.wuxing_status;
      }

      const relationMap = {
        '用生體': '用生體',
        '體生用': '體生用',
        '用剋體': '用剋體',
        '體剋用': '體剋用',
        '比和': '比和'
      };

      detailedAnalysis.innerHTML += `
        <div class="wuxing-box">
          <h4>五行狀態與建議</h4>
          <p><strong>農曆：</strong> ${lunarMonth}（${season}）</p>
          <p><strong>體卦五行（${tiGua.name}）：</strong> ${tiGua.wuxing} (${wuxingStatus.ti})</p>
          <p><strong>描述：</strong> ${explanations.wuxing_status[tiGua.wuxing]?.description || '無詳細說明'}</p>
          <p><strong>建議：</strong> ${explanations.wuxing_status[tiGua.wuxing]?.suggestions?.[wuxingStatus.ti] || '無建議'}</p>
        </div>
      `;

      const guaMap = {
        mainUpper: { gua: mainUpperGua, label: '本卦上卦' },
        mainLower: { gua: mainLowerGua, label: '本卦下卦' },
        huUpper: { gua: huUpperGua, label: '互卦上卦' },
        huLower: { gua: huLowerGua, label: '互卦下卦' },
        changeUpper: { gua: changeUpperGua, label: '變卦上卦' },
        changeLower: { gua: changeLowerGua, label: '變卦下卦' }
      };

      Object.entries(relations).forEach(([key, relation]) => {
        const { gua, label } = guaMap[key];
        const status = wuxingStatus[key];
        const relationData = relation !== '未知' ? explanations[relationMap[relation]] || { overall: '無解釋', details: {} } : { overall: '無解釋', details: {} };
        const detailKey = relation !== '未知' ? `${gua.name}${relation.replace('體', '').replace('用', '')}體` : '';
        const detailData = relation !== '未知' ? relationData.details[detailKey] || { description: '無具體解釋', guidance: '無建議' } : { description: '無具體解釋', guidance: '無建議' };
        const suggestionKey = result.question?.toLowerCase().includes('事業') ? 'career' : 
                             result.question?.toLowerCase().includes('感情') ? 'love' : 'guidance';
        const suggestion = detailData[suggestionKey] || detailData.guidance || '無建議';
        detailedAnalysis.innerHTML += `
          <div class="wuxing-box">
            <h4>${label}</h4>
            <p><strong>五行：</strong> ${gua.wuxing} (${gua.name})</p>
            <p><strong>狀態：</strong> ${status}</p>
            <p><strong>與體卦關係：</strong> ${relation}</p>
            <p><strong>解釋：</strong> ${relationData.overall}</p>
            <p><strong>具體解釋：</strong> ${detailData.description}</p>
            <p><strong>建議：</strong> ${suggestion}</p>
          </div>
        `;
      });

      if (result.question) {
        const suggestionKey = result.question.toLowerCase().includes('事業') ? 'career' : 
                             result.question.toLowerCase().includes('感情') ? 'love' : 'guidance';
        const relation = relations.mainUpper;
        const relationData = relation !== '未知' ? explanations[relationMap[relation]] || { details: {} } : { details: {} };
        const detailKey = relation !== '未知' ? `${mainUpperGua.name}${relation.replace('體', '').replace('用', '')}體` : '';
        const detailData = relation !== '未知' ? relationData.details[detailKey] || { [suggestionKey]: '無建議' } : { [suggestionKey]: '無建議' };
        detailedAnalysis.innerHTML += `
          <div class="wuxing-box">
            <h4>問題分析</h4>
            <p><strong>問題：</strong> ${result.question}</p>
            <p><strong>建議：</strong> ${detailData[suggestionKey] || '無建議'}</p>
          </div>
        `;
      }
    }

    function triggerAnalysis() {
      // 模擬觸發分析
      renderWuxingAnalysis(currentResult);
    }
  </script>
</body>
</html>
```
