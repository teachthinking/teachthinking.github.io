<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<title>梅花心意卜卦工具</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; }
  pre { font-family: monospace; font-size: 16px; line-height: 1.5; }
  .advice { margin-top: 10px; padding: 10px; border: 1px solid #ccc; background: #f9f9f9; }
</style>
</head>
<body>
<h2>梅花心意卜卦工具</h2>
<p>點擊按鈕使用當前時間起卦，並獲得專業吉凶解析與建議。</p>
<button onclick="generateDivination()">開始卜卦</button>
<div id="result"></div>

<script>
// 八卦對應五行與三爻組合(由下爻至上爻)
const trigramFiveElement = {
  "乾": "金", "兑": "金", "离": "火",
  "震": "木", "巽": "木", "坎": "水",
  "艮": "土", "坤": "土"
};
const fiveElementRelations = {
  "金": { "生": "水", "剋": "木" },
  "木": { "生": "火", "剋": "土" },
  "水": { "生": "木", "剋": "火" },
  "火": { "生": "土", "剋": "金" },
  "土": { "生": "金", "剋": "水" }
};
const trigrams = ["乾", "兑", "离", "震", "巽", "坎", "艮", "坤"];
const baguaLines = {
  0: ["—","—","—"],   // 乾    三陽爻
  1: ["—","—","--"],   // 兑    兩陽一陰
  2: ["—","--","—"],   // 离    陰陽陰
  3: ["—","--","--"],   // 震    一陽兩陰
  4: ["--","—","—"],   // 巽    陰陽陽
  5: ["--","—","--"],   // 坎    陽陰陽
  6: ["--","--","—"],   // 艮    兩陰一陽
  7: ["--","--","--"]   // 坤    三陰爻
};
// 六十四卦對照表 (key為 "下卦索引+上卦索引")
const sixtyFourHexagrams = {
  "00":"乾為天", "01":"天澤履", "02":"天火同人", "03":"天雷無妄",
  "04":"天風姤", "05":"天水訟", "06":"天山遯", "07":"天地否",
  "10":"澤天夬", "11":"兌為澤", "12":"澤火革", "13":"澤雷隨",
  "14":"澤風大過", "15":"澤水困", "16":"澤山咸", "17":"澤地萃",
  "20":"火天大有", "21":"火澤睽", "22":"離為火", "23":"火雷噬嗑",
  "24":"火風鼎", "25":"火水未濟", "26":"火山旅", "27":"火地晉",
  "30":"雷天大壯", "31":"雷澤歸妹", "32":"雷火豐", "33":"震為雷",
  "34":"雷風恆", "35":"雷水解", "36":"雷山小過", "37":"雷地豫",
  "40":"風天小畜", "41":"風澤中孚", "42":"風火家人", "43":"風雷益",
  "44":"巽為風", "45":"風水渙", "46":"風山漸", "47":"風地觀",
  "50":"水天需", "51":"水澤節", "52":"水火既濟", "53":"水雷屯",
  "54":"水風井", "55":"坎為水", "56":"水山蹇", "57":"水地比",
  "60":"山天大畜", "61":"山澤損", "62":"山火賁", "63":"山雷頤",
  "64":"山風蠱", "65":"山水蒙", "66":"艮為山", "67":"山地剝",
  "70":"地天泰", "71":"地澤臨", "72":"地火明夷", "73":"地雷復",
  "74":"地風升", "75":"地水師", "76":"地山謙", "77":"坤為地"
};

// 起卦函式
function calculateMeihuaDivination(year, month, day, hour) {
  const upper = (year + month + day) % 8;
  const lower = (year + month + day + hour) % 8;
  const movingLine = ((year + month + day + hour) % 6) + 1;
  return {
    upperTrigram: upper,
    lowerTrigram: lower,
    movingLine: movingLine
  };
}

// 生成六爻卦象陣列(由下往上排列)
function generateHexagram(upperIndex, lowerIndex) {
  return [...baguaLines[lowerIndex], ...baguaLines[upperIndex]];
}
// 文字顯示六爻卦象
function displayHexagram(hexagram) {
  let result = "";
  for(let i = 5; i >= 0; i--) { // 從頂部往下列印
    result += hexagram[i] + "\n";
  }
  return result;
}

// 吉凶分析與建議
function analyzeDivination(bodyTrigram, useTrigram) {
  const bodyElement = trigramFiveElement[bodyTrigram];
  const useElement = trigramFiveElement[useTrigram];
  let resultText = "";
  let adviceText = "";

  if (useElement === bodyElement) {
    resultText = "用卦與體卦五行相同，表示和諧，吉利。";
    adviceText = "可積極推進計畫，把握良機。";
  } else if (fiveElementRelations[useElement]?.生 === bodyElement) {
    resultText = "用卦生體卦，代表有助力，吉利。";
    adviceText = "遇到障礙時會有外來扶助，適合抓住機會。";
  } else if (fiveElementRelations[useElement]?.剋 === bodyElement) {
    resultText = "用卦剋體卦，代表有壓制，可能有阻礙。";
    adviceText = "應謹慎行事，避免冒進，宜穩健應對。";
  } else if (fiveElementRelations[bodyElement]?.生 === useElement) {
    resultText = "體卦生用卦，主體無力，存在洩氣情形。";
    adviceText = "需加強自身實力，避免急躁和輕忽風險。";
  } else {
    resultText = "吉凶關係不明，需要綜合判斷。";
    adviceText = "保持平和心態，密切關注形勢變化。";
  }

  return { resultText, adviceText };
}

// 取得六十四卦卦名
function getHexagramName(upperIndex, lowerIndex) {
  const key = `${lowerIndex}${upperIndex}`;
  return sixtyFourHexagrams[key] || "未知卦";
}

// 產生卜卦並顯示
function generateDivination() {
  const now = new Date();
  const year = now.getFullYear();
  const month = now.getMonth() + 1;
  const day = now.getDate();
  const hour = now.getHours();

  const { upperTrigram, lowerTrigram, movingLine } = calculateMeihuaDivination(year, month, day, hour);
  const upperTrigName = trigrams[upperTrigram];
  const lowerTrigName = trigrams[lowerTrigram];
  const hexagram = generateHexagram(upperTrigram, lowerTrigram);

  // 動爻 <=3 動用下卦，否則用上卦
  let bodyTrigram, useTrigram;
  if (movingLine <= 3) {
    bodyTrigram = upperTrigName;
    useTrigram = lowerTrigName;
  } else {
    bodyTrigram = lowerTrigName;
    useTrigram = upperTrigName;
  }

  const analysis = analyzeDivination(bodyTrigram, useTrigram);
  const hexagramName = getHexagramName(upperTrigram, lowerTrigram);

  let html = `<p>起卦時間：${year}年${month}月${day}日 ${hour}時</p>`;
  html += `<p>本卦：${upperTrigName}（上卦）＋${lowerTrigName}（下卦）</p>`;
  html += `<pre>${displayHexagram(hexagram)}</pre>`;
  html += `<p>動爻：第${movingLine}爻</p>`;
  html += `<p>體卦：${bodyTrigram}，用卦：${useTrigram}</p>`;
  html += `<p>六十四卦名稱：${hexagramName}</p>`;
  html += `<p>吉凶分析：${analysis.resultText}</p>`;
  html += `<div class="advice"><strong>建議：</strong>${analysis.adviceText}</div>`;

  document.getElementById('result').innerHTML = html;
}
</script>
</body>
</html>

