<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<title>專業梅花心意卜卦系統</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; }
  pre { font-family: monospace; font-size: 18px; line-height: 1.6; }
  .advice { background-color: #f4f8f6; border-left: 6px solid #2c6f4e; margin: 10px 0; padding: 10px; }
  #result { margin-top: 25px; }
  #relationGraphContainer {
    width: 600px; height: 600px; border: 1px solid #ccc; margin-top: 20px;
  }
  svg { width: 100%; height: 100%; }
  text { font-size: 14px; font-weight: bold; }
</style>
</head>
<body>
<h2>專業梅花心意卜卦系統</h2>
<p>點擊以下按鈕，以當前時間起卦，並顯示專業吉凶分析、旺相休囚死動態及五行生剋關係圖示。</p>
<button id="btnStart">開始卜卦</button>

<div id="result"></div>
<div id="relationGraphContainer">
  <svg id="relationGraph"></svg>
</div>

<script>
console.log("JS載入成功");

const trigrams = [
  {name:"乾", element:"金", x:150, y:50},
  {name:"兑", element:"金", x:250, y:110},
  {name:"离", element:"火", x:350, y:180},
  {name:"震", element:"木", x:420, y:280},
  {name:"巽", element:"木", x:360, y:380},
  {name:"坎", element:"水", x:260, y:450},
  {name:"艮", element:"土", x:150, y:400},
  {name:"坤", element:"土", x:90, y:280}
];

const fiveRelations = [
  {from:"木", to:"火", type:"生"},
  {from:"火", to:"土", type:"生"},
  {from:"土", to:"金", type:"生"},
  {from:"金", to:"水", type:"生"},
  {from:"水", to:"木", type:"生"},
  {from:"木", to:"土", type:"剋"},
  {from:"土", to:"水", type:"剋"},
  {from:"水", to:"火", type:"剋"},
  {from:"火", to:"金", type:"剋"},
  {from:"金", to:"木", type:"剋"}
];

const wuxingStatus = {
  "旺": {strokeWidth: 6, opacity:1},
  "相": {strokeWidth: 4, opacity:0.8},
  "休": {strokeWidth: 2, opacity:0.6},
  "囚": {strokeWidth: 1, opacity:0.4},
  "死": {strokeWidth: 1, opacity:0.3}
};

const colors = { "生": "green", "剋": "red", "比和": "orange", "洩": "blue", "無": "gray" };
const wuxingColors = { "旺": "#176f3d", "相": "#4daf75", "休": "#a9d1a5", "囚": "#ffb085", "死": "#ff6f61" };

const baguaLines = {
  0: ["—", "—", "—"],
  1: ["—", "—", "--"],
  2: ["—", "--", "—"],
  3: ["—", "--", "--"],
  4: ["--", "—", "—"],
  5: ["--", "—", "--"],
  6: ["--", "--", "—"],
  7: ["--", "--", "--"]
};

const trigramsName = ["乾","兑","离","震","巽","坎","艮","坤"];
const trigramFiveElement = {
  "乾": "金", "兑": "金", "离": "火",
  "震": "木", "巽": "木", "坎": "水",
  "艮": "土", "坤": "土"
};

const sixtyFourHexagrams = {
  "00":"乾為天", "01":"天澤履", "02":"天火同人", "03":"天雷無妄",
  "04":"天風姤", "05":"天水訟", "06":"天山遯", "07":"天地否",
  "10":"澤天夬", "11":"兌為澤", "12":"澤火革", "13":"澤雷隨",
  "14":"澤風大過", "15":"澤水困", "16":"澤山咸", "17":"澤地萃",
  "20":"火天大有", "21":"火澤睽", "22":"離為火", "23":"火雷噬嗑",
  "24":"火風鼎", "25":"火水未濟", "26":"火山旅", "27":"火地晉",
  "30":"雷天大壯", "31":"雷澤歸妹", "32":"雷火豐", "33":"震為雷",
  "34":"雷風恆", "35":"雷水解", "36":"雷山小過", "37":"雷地豫",
  "40":"風天小畜", "41":"風澤中孚", "42":"風火家人", "43":"風雷益",
  "44":"巽為風", "45":"風水渙", "46":"風山漸", "47":"風地觀",
  "50":"水天需", "51":"水澤節", "52":"水火既濟", "53":"水雷屯",
  "54":"水風井", "55":"坎為水", "56":"水山蹇", "57":"水地比",
  "60":"山天大畜", "61":"山澤損", "62":"山火賁", "63":"山雷頤",
  "64":"山風蠱", "65":"山水蒙", "66":"艮為山", "67":"山地剝",
  "70":"地天泰", "71":"地澤臨", "72":"地火明夷", "73":"地雷復",
  "74":"地風升", "75":"地水師", "76":"地山謙", "77":"坤為地"
};

function calculateHexagram(year, month, day, hour) {
  if (!year || !month || !day || !hour) {
    console.error("Invalid input for calculateHexagram:", { year, month, day, hour });
    return { upper: 0, lower: 0, movingLine: 1 };
  }
  const upper = (year + month + day + hour) % 8;
  const lower = (year + month + day + hour + 1) % 8;
  const movingLine = ((year + month + day + hour + 2) % 6) + 1;
  console.log("calculateHexagram", year, month, day, hour, upper, lower, movingLine);
  return { upper, lower, movingLine };
}

function generateHexagram(upper, lower) {
  return [...baguaLines[upper], ...baguaLines[lower]]; // 上卦在上三爻，下卦在下三爻
}

function generateMutualHexagram(hexagram) {
  // 互卦：二三四爻為下卦，三四五爻為上卦
  const lowerLines = [hexagram[1], hexagram[2], hexagram[3]];
  const upperLines = [hexagram[2], hexagram[3], hexagram[4]];
  const lower = Object.keys(baguaLines).find(key => baguaLines[key].join('') === lowerLines.join('')) || 0;
  const upper = Object.keys(baguaLines).find(key => baguaLines[key].join('') === upperLines.join('')) || 0;
  return { upper, lower };
}

function generateChangedHexagram(hexagram, movingLine) {
  // 變卦：將動爻反轉（陰變陽，陽變陰）
  const changedHexagram = [...hexagram];
  const index = 6 - movingLine; // 動爻索引（從下到上，1->5, 2->4, ..., 6->0）
  changedHexagram[index] = changedHexagram[index] === "—" ? "--" : "—";
  const lowerLines = changedHexagram.slice(3, 6);
  const upperLines = changedHexagram.slice(0, 3);
  const lower = Object.keys(baguaLines).find(key => baguaLines[key].join('') === lowerLines.join('')) || 0;
  const upper = Object.keys(baguaLines).find(key => baguaLines[key].join('') === upperLines.join('')) || 0;
  return { upper, lower, hexagram: changedHexagram };
}

function displayHexagram(hexagram) {
  return hexagram.slice().reverse().join('\n'); // 從下到上顯示
}

function determineWuxingStatus(element, timeElement) {
  if (!element || !timeElement) return "死";
  if (element === timeElement) return "旺";
  if (fiveRelations.find(r => r.from === element && r.to === timeElement && r.type === "生")) return "相";
  if (fiveRelations.find(r => r.from === timeElement && r.to === element && r.type === "生")) return "休";
  if (fiveRelations.find(r => r.from === element && r.to === timeElement && r.type === "剋")) return "囚";
  return "死";
}

function analyzeFiveElementRelations(bodyElement, useElement, timeElement) {
  const statusBody = determineWuxingStatus(bodyElement, timeElement);
  const statusUse = determineWuxingStatus(useElement, timeElement);

  let relationType = null;
  if (useElement === bodyElement) relationType = "比和";
  else if (fiveRelations.find(r => r.from === useElement && r.to === bodyElement && r.type === "生")) relationType = "生";
  else if (fiveRelations.find(r => r.from === useElement && r.to === bodyElement && r.type === "剋")) relationType = "剋";
  else if (fiveRelations.find(r => r.from === bodyElement && r.to === useElement && r.type === "生")) relationType = "洩";
  else relationType = "無";

  return {
    statusBody,
    statusUse,
    relationType,
    description: `體卦五行：${bodyElement || "未知"}（${statusBody}），用卦五行：${useElement || "未知"}（${statusUse}），關係：${relationType}`
  };
}

function drawRelationGraph(statusObj) {
  const svgNS = "http://www.w3.org/2000/svg";
  const svg = document.getElementById("relationGraph");
  if (!svg) {
    console.error("SVG element not found");
    return;
  }
  svg.innerHTML = '';

  const defs = document.createElementNS(svgNS, "defs");
  const marker = document.createElementNS(svgNS, "marker");
  marker.setAttribute("id", "arrow");
  marker.setAttribute("markerWidth", "10");
  marker.setAttribute("markerHeight", "7");
  marker.setAttribute("refX", "10");
  marker.setAttribute("refY", "3.5");
  marker.setAttribute("orient", "auto");
  const path = document.createElementNS(svgNS, "path");
  path.setAttribute("d", "M 0 0 L 10 3.5 L 0 7 Z");
  path.setAttribute("fill", "currentColor");
  marker.appendChild(path);
  defs.appendChild(marker);
  svg.appendChild(defs);

  trigrams.forEach(tri => {
    const circle = document.createElementNS(svgNS, "circle");
    circle.setAttribute("cx", tri.x);
    circle.setAttribute("cy", tri.y);
    circle.setAttribute("r", 30);
    circle.setAttribute("stroke", "#444");
    circle.setAttribute("stroke-width", "2");
    circle.setAttribute("fill", wuxingColors[determineWuxingStatus(tri.element, statusObj.timeElement)] || "#eee");
    svg.appendChild(circle);

    const text = document.createElementNS(svgNS, "text");
    text.setAttribute("x", tri.x);
    text.setAttribute("y", tri.y + 6);
    text.setAttribute("text-anchor", "middle");
    text.setAttribute("fill", "#000");
    text.textContent = `${tri.name} (${tri.element})`;
    svg.appendChild(text);
  });

  fiveRelations.forEach(rel => {
    const from = trigrams.find(t => t.element === rel.from);
    const to = trigrams.find(t => t.element === rel.to);
    if (!from || !to) return;

    const line = document.createElementNS(svgNS, "line");
    line.setAttribute("x1", from.x);
    line.setAttribute("y1", from.y);
    line.setAttribute("x2", to.x);
    line.setAttribute("y2", to.y);
    line.setAttribute("stroke", colors[rel.type]);
    line.setAttribute("stroke-width", 4);
    line.setAttribute("marker-end", "url(#arrow)");
    svg.appendChild(line);
  });

  const bodyNode = trigrams.find(t => t.element === statusObj.bodyElement);
  const useNode = trigrams.find(t => t.element === statusObj.useElement);
  if (bodyNode && useNode && statusObj.relationType !== "無") {
    const line = document.createElementNS(svgNS, "line");
    line.setAttribute("x1", bodyNode.x);
    line.setAttribute("y1", bodyNode.y);
    line.setAttribute("x2", useNode.x);
    line.setAttribute("y2", useNode.y);
    line.setAttribute("stroke", colors[statusObj.relationType] || "gray");
    line.setAttribute("stroke-width", wuxingStatus[statusObj.statusBody].strokeWidth);
    line.setAttribute("opacity", wuxingStatus[statusObj.statusBody].opacity);
    line.setAttribute("marker-end", "url(#arrow)");
    svg.appendChild(line);
  }
}

function startDivination() {
  console.log("Button clicked, starting divination");
  try {
    const now = new Date();
    const y = now.getFullYear();
    const m = now.getMonth() + 1;
    const d = now.getDate();
    const h = now.getHours();

    const { upper, lower, movingLine } = calculateHexagram(y, m, d, h);

    const upperName = trigramsName[upper] || "未知";
    const lowerName = trigramsName[lower] || "未知";
    const hexagramArr = generateHexagram(upper, lower);
    const hexagramStr = displayHexagram(hexagramArr);

    // 計算互卦
    const mutual = generateMutualHexagram(hexagramArr);
    const mutualUpperName = trigramsName[mutual.upper] || "未知";
    const mutualLowerName = trigramsName[mutual.lower] || "未知";
    const mutualHexagramArr = generateHexagram(mutual.upper, mutual.lower);
    const mutualHexagramStr = displayHexagram(mutualHexagramArr);
    const mutualHexagramName = sixtyFourHexagrams[`${mutual.lower}${mutual.upper}`] || "未知卦";

    // 計算變卦
    const changed = generateChangedHexagram(hexagramArr, movingLine);
    const changedUpperName = trigramsName[changed.upper] || "未知";
    const changedLowerName = trigramsName[changed.lower] || "未知";
    const changedHexagramStr = displayHexagram(changed.hexagram);
    const changedHexagramName = sixtyFourHexagrams[`${changed.lower}${changed.upper}`] || "未知卦";

    // 體用卦：動爻在上卦（4-6）則上卦為用卦，下卦為體卦；動爻在下卦（1-3）則下卦為用卦，上卦為體卦
    let bodyTrigram, useTrigram;
    if (movingLine >= 4) {
      bodyTrigram = lowerName; // 下卦為體卦
      useTrigram = upperName;  // 上卦（動爻所在）為用卦
    } else {
      bodyTrigram = upperName; // 上卦為體卦
      useTrigram = lowerName;  // 下卦（動爻所在）為用卦
    }

    const timeElement = "木"; // 示例，實際可用天干地支判定
    const fiveRelAnalysis = analyzeFiveElementRelations(
      trigramFiveElement[bodyTrigram] || "未知",
      trigramFiveElement[useTrigram] || "未知",
      timeElement
    );

    // 互卦五行分析
    const mutualFiveRelAnalysis = analyzeFiveElementRelations(
      trigramFiveElement[mutualLowerName] || "未知",
      trigramFiveElement[mutualUpperName] || "未知",
      timeElement
    );

    // 變卦五行分析
    const changedFiveRelAnalysis = analyzeFiveElementRelations(
      trigramFiveElement[movingLine >= 4 ? changedLowerName : changedUpperName] || "未知",
      trigramFiveElement[movingLine >= 4 ? changedUpperName : changedLowerName] || "未知",
      timeElement
    );

    const resultDiv = document.getElementById("result");
    if (!resultDiv) {
      console.error("Result div not found");
      return;
    }
    resultDiv.innerHTML = `
      <h3>起卦時間</h3>
      <p>${y}年${m}月${d}日${h}時</p>
      <h3>本卦</h3>
      <p>${upperName}(上卦) + ${lowerName}(下卦)</p>
      <pre>${hexagramStr}</pre>
      <h3>本卦名稱</h3>
      <p>${sixtyFourHexagrams[`${lower}${upper}`] || "未知卦"}</p>
      <h3>動爻</h3>
      <p>第${movingLine}爻</p>
      <h3>本卦體用</h3>
      <p>體卦:${bodyTrigram} (${trigramFiveElement[bodyTrigram] || "未知"}), 用卦:${useTrigram} (${trigramFiveElement[useTrigram] || "未知"})</p>
      <h3>本卦五行生剋分析</h3>
      <p>${fiveRelAnalysis.description}</p>
      <h3>互卦</h3>
      <p>${mutualUpperName}(上卦) + ${mutualLowerName}(下卦)</p>
      <pre>${mutualHexagramStr}</pre>
      <h3>互卦名稱</h3>
      <p>${mutualHexagramName}</p>
      <h3>互卦五行分析</h3>
      <p>${mutualFiveRelAnalysis.description}</p>
      <h3>變卦</h3>
      <p>${changedUpperName}(上卦) + ${changedLowerName}(下卦)</p>
      <pre>${changedHexagramStr}</pre>
      <h3>變卦名稱</h3>
      <p>${changedHexagramName}</p>
      <h3>變卦五行分析</h3>
      <p>${changedFiveRelAnalysis.description}</p>
      <div class="advice">
        <strong>趨吉避凶建議：</strong>
        <p>${
          fiveRelAnalysis.relationType === "剋" || changedFiveRelAnalysis.relationType === "�克"
            ? "建議小心應對，避免衝突與風險，謹慎行事。"
            : "可把握有利機會，積極行動，注意後續變化。"
        }</p>
      </div>
    `;

    drawRelationGraph({
      bodyElement: trigramFiveElement[bodyTrigram] || "未知",
      useElement: trigramFiveElement[useTrigram] || "未知",
      timeElement: timeElement,
      statusBody: fiveRelAnalysis.statusBody,
      statusUse: fiveRelAnalysis.statusUse,
      relationType: fiveRelAnalysis.relationType
    });
  } catch (error) {
    console.error("Error in startDivination:", error);
    document.getElementById("result").innerHTML = `<p style="color: red;">錯誤：無法完成卜卦，請檢查控制台以獲取詳細信息。</p>`;
  }
}

document.addEventListener("DOMContentLoaded", () => {
  const btnStart = document.getElementById("btnStart");
  if (btnStart) {
    btnStart.addEventListener("click", () => {
      console.log("Button click event triggered");
      startDivination();
    });
  } else {
    console.error("Button with ID 'btnStart' not found");
  }
});
</script>
</body>
</html>
