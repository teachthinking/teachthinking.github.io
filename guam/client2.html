<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>專業梅花心易 - 取卦介面</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center p-4 font-sans">
  <header class="w-full max-w-3xl bg-white shadow-md rounded-lg p-6 mb-6">
    <h2 class="text-2xl font-bold text-center text-gray-800">專業梅花心易 - 取卦介面</h2>
    <p class="text-center text-gray-600 mt-2">選擇起卦模式，輸入資料後點擊開始解卦</p>
  </header>

  <main class="w-full max-w-3xl bg-white shadow-md rounded-lg p-6">
    <div class="mb-4">
      <label for="questionInput" class="block text-sm font-medium text-gray-700 mb-2">
        <i class="fas fa-question-circle mr-2"></i>卜卦問題
      </label>
      <input type="text" id="questionInput" placeholder="例如：明天適合出遊嗎？" class="w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
    </div>

    <div id="divinationControls">
      <div class="mb-4">
        <label for="divinationMode" class="block text-sm font-medium text-gray-700 mb-2">
          <i class="fas fa-list-ul mr-2"></i>起卦模式
        </label>
        <select id="divinationMode" class="w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
          <option value="time">時間起卦（自動取當前時間）</option>
          <option value="threeDigits">三位數起卦（輸入三個三位數）</option>
          <option value="manual">手動指定（上卦1-8、下卦1-8、動爻1-6）</option>
        </select>
      </div>
      <div id="inputFields" class="space-y-4"></div>
      
      <p id="mqttStatus" class="mt-4 text-center font-bold"></p>
      
      <button id="btnStartDivination" class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 transition duration-200">
        <i class="fas fa-hands-praying mr-2"></i>開始解卦
      </button>
    </div>

    <div id="result" class="mt-6"></div>
  </main>
  
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <script>
    const trigramsName = ["乾", "兑", "離", "震", "巽", "坎", "艮", "坤"];

    function generateRandomId() {
      const letters = 'abcdefghijklmnopqrstuvwxyz';
      let result = '';
      for (let i = 0; i < 3; i++) {
        result += letters.charAt(Math.floor(Math.random() * letters.length));
      }
      for (let i = 0; i < 4; i++) {
        result += Math.floor(Math.random() * 10);
      }
      return result;
    }

    function getDivinationInputs() {
      const mode = document.getElementById("divinationMode").value;
      let upper, lower, moving;
      
      try {
        if (mode === "time") {
          const date = new Date();
          const year = date.getFullYear();
          const month = date.getMonth() + 1;
          const day = date.getDate();
          const hour = date.getHours();
          const minute = date.getMinutes();
          upper = (year + month + day) % 8;
          lower = (year + month + day + hour) % 8;
          moving = (year + month + day + hour + minute) % 6;
        } else if (mode === "threeDigits") {
          const num1 = parseInt(document.getElementById("num1").value);
          const num2 = parseInt(document.getElementById("num2").value);
          const num3 = parseInt(document.getElementById("num3").value);
          upper = num1 % 8;
          lower = num2 % 8;
          moving = num3 % 6;
        } else if (mode === "manual") {
          upper = parseInt(document.getElementById("upperTrigram").value) - 1;
          lower = parseInt(document.getElementById("lowerTrigram").value) - 1;
          moving = parseInt(document.getElementById("movingLine").value) - 1;
        }
        return { upper, lower, moving };
      } catch (e) {
        console.error("Failed to get divination inputs:", e);
        return { upper: -1, lower: -1, moving: -1 };
      }
    }

    function updateInputFields() {
      const mode = document.getElementById("divinationMode").value;
      const inputFields = document.getElementById("inputFields");
      inputFields.innerHTML = "";

      if (mode === "threeDigits") {
        inputFields.innerHTML = `
          <input type="number" id="num1" placeholder="上卦三位數" class="w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
          <input type="number" id="num2" placeholder="下卦三位數" class="w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
          <input type="number" id="num3" placeholder="動爻三位數" class="w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
        `;
      } else if (mode === "manual") {
        inputFields.innerHTML = `
          <input type="number" id="upperTrigram" placeholder="上卦 (1-8)" min="1" max="8" class="w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
          <input type="number" id="lowerTrigram" placeholder="下卦 (1-8)" min="1" max="8" class="w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
          <input type="number" id="movingLine" placeholder="動爻 (1-6)" min="1" max="6" class="w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
        `;
      }
    }

    document.getElementById("divinationMode").addEventListener("change", updateInputFields);
    document.addEventListener("DOMContentLoaded", updateInputFields);

    document.getElementById("btnStartDivination").addEventListener("click", () => {
      const question = document.getElementById("questionInput").value.trim();
      if (!question) {
        alert("請先填寫卜卦問題！");
        return;
      }

      const { upper, lower, moving } = getDivinationInputs();
      if (upper < 0 || lower < 0 || moving < 0) {
        alert("請輸入有效的卦象數值！");
        return;
      }
      
      const uniqueId = generateRandomId();
      const topic = `mhxingyi/${uniqueId}/${upper}${lower}${moving}`;
      const payload = JSON.stringify({
        question: question,
        upper: upper,
        lower: lower,
        moving: moving
      });
      
      const broker = "wss://broker.mqttgo.io:8084/mqtt";
      const mqttStatus = document.getElementById("mqttStatus");
      
      // 清空舊結果和狀態
      document.getElementById('result').innerHTML = '';
      mqttStatus.textContent = "連線中...";
      
      const client = mqtt.connect(broker);

      client.on('connect', () => {
        mqttStatus.textContent = "已連線，正在傳送卦象...";
        console.log("MQTT 已連線！");
        
        client.publish(topic, payload, () => {
          console.log(`已發佈到主題: ${topic}`);
          console.log(`內容: ${payload}`);
          mqttStatus.textContent = "卦象已傳送，等待解卦結果...";
          
          const resultTopic = `mhxingyi/${uniqueId}/result`;
          client.subscribe(resultTopic, (err) => {
            if (!err) {
              console.log(`已訂閱結果主題: ${resultTopic}`);
            } else {
              console.error("訂閱失敗:", err);
            }
          });
        });
      });

      client.on('message', (topic, message) => {
        try {
          console.log(`接收到訊息，主題: ${topic}`);
          console.log(`訊息內容: ${message.toString()}`);
          
          const result = JSON.parse(message.toString());
          document.getElementById('result').innerHTML = `
            <div class="p-4 bg-gray-200 rounded-lg shadow-inner">
              <h3 class="text-xl font-bold mb-2">解卦結果</h3>
              <p><strong>辨識碼:</strong> ${uniqueId}</p>
              <p><strong>卜卦問題:</strong> ${result.question}</p>
              <p><strong>本卦名:</strong> ${result.hexagramName} (${result.upperName}${result.lowerName})</p>
              <p><strong>最終判斷:</strong> ${result.finalVerdict}</p>
              <div class="mt-4">
                <h4 class="font-bold">五行生克圖:</h4>
                ${result.graphHtml || result.svg}
              </div>
              <div class="mt-4 advice p-3 bg-white border-l-4 border-blue-500">
                <h4 class="font-bold">參考建議:</h4>
                <p>${result.adviceText}</p>
              </div>
            </div>
          `;
          mqttStatus.textContent = "解卦完成！";
          client.end(); // 接收到結果後關閉連線
        } catch (e) {
          console.error("解析訊息失敗:", e);
          mqttStatus.textContent = "接收到錯誤格式的解卦訊息。";
        }
      });

      client.on('error', (err) => {
        console.error("MQTT 連線錯誤:", err);
        mqttStatus.textContent = "連線失敗，請檢查網路或代理程式設定。";
      });
    });
  </script>
</body>
</html>
