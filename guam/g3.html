
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<title>專業梅花心意卜卦系統</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; }
  .advice { background-color: #f4f8f6; border-left: 6px solid #2c6f4e; margin: 10px 0; padding: 10px; }
  #result { margin-top: 25px; }
  #relationGraphContainer {
    width: 100%; max-width: 600px; height: 600px; border: 1px solid #ccc; margin-top: 20px;
  }
  #hexagramContainer {
    display: flex; flex-wrap: wrap; justify-content: space-around; margin-top: 20px;
  }
  .hexagram-box { 
    text-align: center; margin: 10px; width: 100px; 
  }
  .hexagram-box svg { width: 80px; height: 120px; }
  .hexagram-box p { margin: 5px 0; font-size: 14px; }
  svg { width: 100%; height: 100%; }
  text { font-size: 12px; font-weight: bold; }
  label { margin-right: 10px; }
  @media (max-width: 600px) {
    .hexagram-box { width: 80px; }
    .hexagram-box svg { width: 60px; height: 100px; }
    .hexagram-box p { font-size: 12px; }
  }
</style>
</head>
<body>
<h2>專業梅花心意卜卦系統</h2>
<p>選擇起卦模式，並輸入相關資料，點擊按鈕起卦。</p>
<label for="divinationMode">起卦模式：</label>
<select id="divinationMode">
  <option value="time">時間起卦（自動取當前時間）</option>
  <option value="threeDigits">三位數起卦（輸入三個三位數，如123, 456, 789）</option>
  <option value="manual">手動指定（上卦1-8、下卦1-8、動爻1-6）</option>
</select><br><br>
<div id="inputFields"></div>
<button id="btnStart">開始卜卦</button>

<div id="result"></div>
<div id="hexagramContainer"></div>
<div id="relationGraphContainer">
  <svg id="relationGraph"></svg>
</div>

<script>
console.log("JS載入成功");

const trigrams = [
  {name:"乾", element:"金"},
  {name:"兑", element:"金"},
  {name:"离", element:"火"},
  {name:"震", element:"木"},
  {name:"巽", element:"木"},
  {name:"坎", element:"水"},
  {name:"艮", element:"土"},
  {name:"坤", element:"土"}
];

const fiveElementsOrder = ["火", "土", "金", "水", "木"];
const fiveRelations = [
  {from:"木", to:"火", type:"生"},
  {from:"火", to:"土", type:"生"},
  {from:"土", to:"金", type:"生"},
  {from:"金", to:"水", type:"生"},
  {from:"水", to:"木", type:"生"},
  {from:"木", to:"土", type:"剋"},
  {from:"土", to:"水", type:"剋"},
  {from:"水", to:"火", type:"剋"},
  {from:"火", to:"金", type:"剋"},
  {from:"金", to:"木", type:"剋"}
];

const wuxingStatus = {
  "旺": {strokeWidth: 6, opacity:1},
  "相": {strokeWidth: 4, opacity:0.8},
  "休": {strokeWidth: 2, opacity:0.6},
  "囚": {strokeWidth: 1, opacity:0.4},
  "死": {strokeWidth: 1, opacity:0.3}
};

const colors = { "生": "green", "剋": "red", "比和": "orange", "洩": "blue", "無": "gray" };
const wuxingColors = { "旺": "#176f3d", "相": "#4daf75", "休": "#a9d1a5", "囚": "#ffb085", "死": "#ff6f61" };

const baguaLines = {
  0: ["—", "—", "—"],
  1: ["—", "—", "--"],
  2: ["—", "--", "—"],
  3: ["—", "--", "--"],
  4: ["--", "—", "—"],
  5: ["--", "—", "--"],
  6: ["--", "--", "—"],
  7: ["--", "--", "--"]
};

const trigramsName = ["乾","兑","离","震","巽","坎","艮","坤"];
const trigramFiveElement = {
  "乾": "金", "兑": "金", "离": "火",
  "震": "木", "巽": "木", "坎": "水",
  "艮": "土", "坤": "土"
};

const sixtyFourHexagrams = {
  "00":"乾為天", "01":"天澤履", "02":"天火同人", "03":"天雷無妄",
  "04":"天風姤", "05":"天水訟", "06":"天山遯", "07":"天地否",
  "10":"澤天夬", "11":"兌為澤", "12":"澤火革", "13":"澤雷隨",
  "14":"澤風大過", "15":"澤水困", "16":"澤山咸", "17":"澤地萃",
  "20":"火天大有", "21":"火澤睽", "22":"離為火", "23":"火雷噬嗑",
  "24":"火風鼎", "25":"火水未濟", "26":"火山旅", "27":"火地晉",
  "30":"雷天大壯", "31":"雷澤歸妹", "32":"雷火豐", "33":"震為雷",
  "34":"雷風恆", "35":"雷水解", "36":"雷山小過", "37":"雷地豫",
  "40":"風天小畜", "41":"風澤中孚", "42":"風火家人", "43":"風雷益",
  "44":"巽為風", "45":"風水渙", "46":"風山漸", "47":"風地觀",
  "50":"水天需", "51":"水澤節", "52":"水火既濟", "53":"水雷屯",
  "54":"水風井", "55":"坎為水", "56":"水山蹇", "57":"水地比",
  "60":"山天大畜", "61":"山澤損", "62":"山火賁", "63":"山雷頤",
  "64":"山風蠱", "65":"山水蒙", "66":"艮為山", "67":"山地剝",
  "70":"地天泰", "71":"地澤臨", "72":"地火明夷", "73":"地雷復",
  "74":"地風升", "75":"地水師", "76":"地山謙", "77":"坤為地"
};

function calculateHexagramFromTime(year, month, day, hour) {
  const sum = year + month + day + hour;
  const upper = sum % 8;
  const lower = (sum + 1) % 8;
  const movingLine = ((sum + 2) % 6) + 1;
  return { upper, lower, movingLine };
}

function calculateHexagramFromThreeDigits(num1, num2, num3) {
  if (num1 < 100 || num1 > 999 || num2 < 100 || num2 > 999 || num3 < 100 || num3 > 999) return null;
  const upper = num1 % 8;
  const lower = num2 % 8;
  const movingLine = (num3 % 6) || 6;
  return { upper, lower, movingLine };
}

function calculateHexagramFromManual(upper, lower, movingLine) {
  upper = (parseInt(upper) - 1 + 8) % 8;
  lower = (parseInt(lower) - 1 + 8) % 8;
  movingLine = parseInt(movingLine);
  if (movingLine < 1 || movingLine > 6) return null;
  return { upper, lower, movingLine };
}

function generateHexagram(upper, lower) {
  return [...baguaLines[lower], ...baguaLines[upper]];
}

function generateMutualHexagram(hexagram) {
  const lowerLines = [hexagram[1], hexagram[2], hexagram[3]];
  const upperLines = [hexagram[2], hexagram[3], hexagram[4]];
  const lower = Object.keys(baguaLines).find(key => baguaLines[key].join('') === lowerLines.join('')) || 0;
  const upper = Object.keys(baguaLines).find(key => baguaLines[key].join('') === upperLines.join('')) || 0;
  return { upper, lower, hexagram: [...lowerLines, ...upperLines] };
}

function generateChangedHexagram(hexagram, movingLine) {
  const changedHexagram = [...hexagram];
  const index = movingLine - 1;
  changedHexagram[index] = changedHexagram[index] === "—" ? "--" : "—";
  const lowerLines = changedHexagram.slice(0, 3);
  const upperLines = changedHexagram.slice(3, 6);
  const lower = Object.keys(baguaLines).find(key => baguaLines[key].join('') === lowerLines.join('')) || 0;
  const upper = Object.keys(baguaLines).find(key => baguaLines[key].join('') === upperLines.join('')) || 0;
  return { upper, lower, hexagram: changedHexagram };
}

function drawHexagram(hexagram, movingLine, containerId, title) {
  const container = document.getElementById(containerId);
  const svgNS = "http://www.w3.org/2000/svg";
  const svg = document.createElementNS(svgNS, "svg");
  svg.setAttribute("width", "80");
  svg.setAttribute("height", "120");
  const yPositions = [20, 40, 60, 80, 100, 120].slice(0, 6); // 從下到上

  hexagram.forEach((line, index) => {
    const y = yPositions[5 - index]; // 從下到上：index=0 -> y=120
    if (line === "—") {
      const path = document.createElementNS(svgNS, "path");
      path.setAttribute("d", `M 10 ${y} H 70`);
      path.setAttribute("stroke", index + 1 === movingLine ? "red" : "black");
      path.setAttribute("stroke-width", "4");
      svg.appendChild(path);
    } else {
      const path1 = document.createElementNS(svgNS, "path");
      path1.setAttribute("d", `M 10 ${y} H 35`);
      path1.setAttribute("stroke", index + 1 === movingLine ? "red" : "black");
      path1.setAttribute("stroke-width", "4");
      svg.appendChild(path1);
      const path2 = document.createElementNS(svgNS, "path");
      path2.setAttribute("d", `M 45 ${y} H 70`);
      path2.setAttribute("stroke", index + 1 === movingLine ? "red" : "black");
      path2.setAttribute("stroke-width", "4");
      svg.appendChild(path2);
    }
  });

  const box = document.createElement("div");
  box.className = "hexagram-box";
  box.innerHTML = `<p>${title}</p>`;
  box.appendChild(svg);
  container.appendChild(box);
}

function displayHexagrams(mainHexagram, mutualHexagram, changedHexagram, movingLine, mainUpper, mainLower, mutualUpper, mutualLower, changedUpper, changedLower, bodyTrigram) {
  const container = document.getElementById("hexagramContainer");
  container.innerHTML = "";
  
  drawHexagram(mainHexagram, movingLine, "hexagramContainer", 
    `本卦：${sixtyFourHexagrams[`${mainUpper}${mainLower}`] || "未知"}<br>` +
    `上卦：${trigramsName[mainUpper]} (${trigramFiveElement[trigramsName[mainUpper]]})<br>` +
    `下卦：${trigramsName[mainLower]} (${trigramFiveElement[trigramsName[mainLower]]})<br>` +
    `體卦：${bodyTrigram} (${trigramFiveElement[bodyTrigram]})`
  );
  drawHexagram(mutualHexagram, 0, "hexagramContainer", 
    `互卦：${sixtyFourHexagrams[`${mutualUpper}${mutualLower}`] || "未知"}<br>` +
    `上卦：${trigramsName[mutualUpper]} (${trigramFiveElement[trigramsName[mutualUpper]]})<br>` +
    `下卦：${trigramsName[mutualLower]} (${trigramFiveElement[trigramsName[mutualLower]]})`
  );
  drawHexagram(changedHexagram, 0, "hexagramContainer", 
    `變卦：${sixtyFourHexagrams[`${changedUpper}${changedLower}`] || "未知"}<br>` +
    `上卦：${trigramsName[changedUpper]} (${trigramFiveElement[trigramsName[changedUpper]]})<br>` +
    `下卦：${trigramsName[changedLower]} (${trigramFiveElement[trigramsName[changedLower]]})`
  );
}

function getPointOnCircle(cx, cy, radius, angle) {
  const rad = angle * Math.PI / 180;
  return {
    x: cx + radius * Math.cos(rad),
    y: cy + radius * Math.sin(rad)
  };
}

function drawRelationGraph(statusObj, allTrigrams) {
  const svgNS = "http://www.w3.org/2000/svg";
  const svg = document.getElementById("relationGraph");
  if (!svg) return;
  svg.innerHTML = '';

  const defs = document.createElementNS(svgNS, "defs");
  const marker = document.createElementNS(svgNS, "marker");
  marker.setAttribute("id", "arrow");
  marker.setAttribute("markerWidth", "10");
  marker.setAttribute("markerHeight", "7");
  marker.setAttribute("refX", "10");
  marker.setAttribute("refY", "3.5");
  marker.setAttribute("orient", "auto");
  const path = document.createElementNS(svgNS, "path");
  path.setAttribute("d", "M 0 0 L 10 3.5 L 0 7 Z");
  path.setAttribute("fill", "currentColor");
  marker.appendChild(path);
  defs.appendChild(marker);
  svg.appendChild(defs);

  const centerX = 300, centerY = 300, radius = 200, circleRadius = 30;
  const positions = [];
  for (let i = 0; i < 5; i++) {
    const angle = (i * 72 - 90);
    positions.push({x: centerX, y: centerY, radius, angle, element: fiveElementsOrder[i]});
  }

  // 畫五行生線（綠色）
  for (let i = 0; i < 5; i++) {
    const from = positions[i];
    const to = positions[(i + 1) % 5];
    const fromPoint = getPointOnCircle(from.x, from.y, from.radius - circleRadius, from.angle);
    const toPoint = getPointOnCircle(to.x, to.y, to.radius - circleRadius, to.angle);
    const line = document.createElementNS(svgNS, "line");
    line.setAttribute("x1", fromPoint.x);
    line.setAttribute("y1", fromPoint.y);
    line.setAttribute("x2", toPoint.x);
    line.setAttribute("y2", toPoint.y);
    line.setAttribute("stroke", "green");
    line.setAttribute("stroke-width", 4);
    line.setAttribute("marker-end", "url(#arrow)");
    svg.appendChild(line);
  }

  // 畫五行剋線（紅色）
  for (let i = 0; i < 5; i++) {
    const from = positions[i];
    const to = positions[(i + 2) % 5];
    const fromPoint = getPointOnCircle(from.x, from.y, from.radius - circleRadius, from.angle);
    const toPoint = getPointOnCircle(to.x, to.y, to.radius - circleRadius, to.angle);
    const line = document.createElementNS(svgNS, "line");
    line.setAttribute("x1", fromPoint.x);
    line.setAttribute("y1", fromPoint.y);
    line.setAttribute("x2", toPoint.x);
    line.setAttribute("y2", toPoint.y);
    line.setAttribute("stroke", "red");
    line.setAttribute("stroke-width", 4);
    line.setAttribute("marker-end", "url(#arrow)");
    svg.appendChild(line);
  }

  // 畫五行節點
  positions.forEach(pos => {
    const point = getPointOnCircle(pos.x, pos.y, pos.radius, pos.angle);
    const circle = document.createElementNS(svgNS, "circle");
    circle.setAttribute("cx", point.x);
    circle.setAttribute("cy", point.y);
    circle.setAttribute("r", circleRadius);
    circle.setAttribute("stroke", "#444");
    circle.setAttribute("stroke-width", "2");
    circle.setAttribute("fill", wuxingColors[determineWuxingStatus(pos.element, statusObj.timeElement)] || "#eee");
    svg.appendChild(circle);

    const elementText = document.createElementNS(svgNS, "text");
    elementText.setAttribute("x", point
