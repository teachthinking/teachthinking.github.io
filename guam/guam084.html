<html lang="zh-TW">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <title>張老師易經(梅花心易)</title>
  <style>
   :root {
    --primary-color: #2c3e50;
    --secondary-color: #3498db;
    --negative-color: #e74c3c;
    --positive-color: #4caf50;
    --yellow-color: #f1c40f;
    --background-color: #f4f7f9;
    --card-bg: #ffffff;
    --border-color: #e0e6ed;
    --text-color: #333333;
    --sub-text-color: #7f8c8d;
    --shadow-light: 0 4px 12px rgba(0, 0, 0, 0.05);
    --border-radius: 12px;
    --font-family: 'Noto Sans TC', sans-serif;
      --wuxing-wood: #2ecc71;
      --wuxing-fire: #e74c3c;
      --wuxing-earth: #f1c40f;
      --wuxing-metal: #ecf0f1;
      --wuxing-water: #3498db;
  }

    body {
      font-family: var(--font-family);
      background: var(--background-color);
      color: var(--text-color);
      padding: 20px;
      line-height: 1.6;
      margin: 0;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: var(--card-bg);
      padding: 25px;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow-light);
    }

    h1 {
      margin: 0 0 8px 0;
      font-size: 28px;
      color: var(--primary-color);
    }

    h2.subtitle {
      margin: 0 0 20px 0;
      color: var(--sub-text-color);
      font-weight: 400;
      font-size: 16px;
      border-bottom: 1px solid var(--border-color);
      padding-bottom: 15px;
    }

    .tab-buttons {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }

    .tab-button {
      padding: 10px 18px;
      border-radius: var(--border-radius);
      border: 1px solid var(--border-color);
      background: transparent;
      cursor: pointer;
      color: var(--sub-text-color);
      transition: all 0.3s ease;
      font-size: 15px;
    }

    .tab-button.active {
      background: var(--primary-color);
      color: #fff;
      border-color: var(--primary-color);
    }

    .tab-content {
      display: none;
      padding-top: 10px;
    }

    .tab-content.active {
      display: block;
    }

    .row {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
      margin: 12px 0;
    }

    .hint {
      font-size: 13px;
      color: var(--sub-text-color);
      line-height: 1.5;
    }

    .gua-box {
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius);
      padding: 20px;
      background: var(--background-color);
      margin-bottom: 20px;
    }

    .hidden {
      display: none;
    }

    button.primary {
      background: var(--primary-color);
      color: #fff;
      border: none;
      padding: 10px 20px;
      border-radius: var(--border-radius);
      cursor: pointer;
      transition: background 0.3s ease;
    }

    button.primary:hover {
      background: var(--secondary-color);
    }

    input, select {
      padding: 8px;
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius);
      font-size: 14px;
    }

    .gua-display-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin: 10px 0;
    }

    .gua-line {
      width: 60px;
      height: 10px;
      margin: 5px 0;
      background: var(--text-color);
      position: relative;
    }

    .gua-line.yin::after {
      content: '';
      position: absolute;
      width: 20px;
      height: 10px;
      background: var(--card-bg);
      left: 20px;
    }

    .gua-line.moving::before {
      content: '×';
      position: absolute;
      color: var(--negative-color);
      font-size: 16px;
      left: -20px;
      top: -3px;
    }

    .gua-name {
      margin-top: 10px;
      font-weight: bold;
      font-size: 16px;
      color: var(--primary-color);
      text-align: center;
    }

    .wuxing-box {
      margin: 15px 0;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      max-width: 600px;
    }

    .wuxing-box ul {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .wuxing-box li {
      flex: 1 1 calc(50% - 10px);
      min-width: 280px;
      padding: 10px;
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius);
      background: var(--card-bg);
    }

    .wuxing-status {
      font-weight: bold;
    }

    .wuxing-status.positive { color: var(--positive-color); }
    .wuxing-status.neutral { color: var(--secondary-color); }
    .wuxing-status.negative { color: var(--negative-color); }

    .wuxing-node {
      fill: none;
      stroke: var(--primary-color);
      stroke-width: 2;
    }
    .wuxing-node:hover {
      fill: #d5e8f9;
      cursor: pointer;
    }

    .wuxing-node-text {
      text-anchor: middle;
      font-size: 12px;
      fill: var(--text-color);
    }

    .wuxing-edge-generate {
      stroke: var(--positive-color);
    }

    .wuxing-edge-overcome {
      stroke: var(--negative-color);
    }

    .wuxing-edge-harmony {
      stroke: var(--secondary-color);
    }

    .wuxing-edge-label {
      font-size: 10px;
      fill: var(--text-color);
      text-anchor: middle;
    }

    .score-card {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 10px 0;
      padding: 10px;
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius);
      font-size: 14px;
    }

    .score-bar-wrap {
      flex: 1;
      height: 20px;
      background: #e0e6ed;
      border-radius: 10px;
      overflow: hidden;
    }

    .score-bar {
      height: 100%;
      background: var(--primary-color);
      transition: width 0.3s ease;
    }

    .score-val {
      font-weight: bold;
      color: var(--positive-color);
      min-width: 40px;
      text-align: right;
    }

    .auspiciousness-index {
      font-size: 18px;
      font-weight: bold;
      margin: 15px 0;
      padding: 10px;
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius);
      text-align: center;
    }

    .auspiciousness-bar {
      height: 20px;
      width: 100%;
      max-width: 400px;
      margin: 10px auto;
      border-radius: var(--border-radius);
      overflow: hidden;
    }

    .line-explanation {
      margin: 15px 0;
      padding: 10px;
      background: var(--background-color);
      border-radius: var(--border-radius);
    }

    .wuxing-controls {
      display: flex;
      gap: 10px;
      margin: 10px 0;
    }
    .wuxing-box {
  margin: 20px 0;
  padding: 15px;
  background: var(--card-bg);
  border: 1px solid var(--border-color);
  border-radius: var(--border-radius);
}
    #wuxingAnalysis {
  display: block;
}
#wuxingSvg {
  display: block;
  margin: 0 auto;
  visibility: visible !important;
}
.wuxing-node, .wuxing-edge-generate, .wuxing-edge-overcome, .wuxing-edge-harmony, .wuxing-edge-label, .wuxing-node-text {
  visibility: visible !important;
}
    {
      font-family: 'Noto Sans TC', sans-serif;
      background: var(--background-color);
      color: var(--text-color);
      margin: 0;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    #wuxingSvg {
      display: block;
      margin: 0 auto;
      visibility: visible !important;
    }
    .wuxing-node {
      fill: none;
      stroke: var(--primary-color);
      stroke-width: 2;
    }
    .wuxing-background {
      stroke: none;
      opacity: 0.2;
    }
    .wuxing-edge-generate {
      stroke: var(--positive-color);
      stroke-width: 2;
    }
    .wuxing-edge-overcome {
      stroke: var(--negative-color);
      stroke-width: 2;
    }
    .wuxing-edge-harmony {
      stroke: var(--secondary-color);
      stroke-width: 2;
    }
    .wuxing-node-text, .wuxing-edge-label {
      visibility: visible !important;
      font-size: 14px;
      text-anchor: middle;
      fill: var(--text-color);
    }
    .hidden {
      display: none;
    }
    .auspiciousness-box {
      margin-top: 20px;
      text-align: center;
      display: block !important;
      visibility: visible !important;
    }
    #auspiciousnessBar {
      width: 100%;
      height: 20px;
      background: #ecf0f1;
      border-radius: 10px;
      overflow: hidden;
      display: block !important;
      visibility: visible !important;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>張老師易經(梅花心易)</h1>
    <h2 id="subtitle" class="subtitle">請選擇取卦方式以開始占卜</h2>
    <div class="tab-buttons">
      <button class="tab-button active" data-target="number">數字取卦</button>
      <button class="tab-button" data-target="manual">手動取卦</button>
      <button class="tab-button" data-target="time">時間取卦</button>
      <button class="tab-button" data-target="image">以象取卦</button>
      <button class="tab-button" data-target="history">歷史記錄</button>
    </div>
    <div id="number" class="tab-content active">
      <div class="row">
        <label>上卦數字(100-999)：</label>
        <input id="numUpper" type="number" min="100" max="999" />
      </div>
      <div class="row">
        <label>下卦數字(100-999)：</label>
        <input id="numLower" type="number" min="100" max="999" />
      </div>
      <div class="row">
        <label>動爻數字(100-999)：</label>
        <input id="numMoving" type="number" min="100" max="999" />
      </div>
      <div class="row">
        <label>問題（可選）：</label>
        <input id="questionNumber" type="text" placeholder="請輸入您的問題" />
      </div>
      <div class="row">
        <button id="btnNumber" class="primary">數字取卦</button>
        <button id="btnRandomNumber" class="primary">亂數取卦</button>
      </div>
      <div class="hint">說明：輸入三組100-999的數字，分別用於計算上卦、下卦與動爻，或點擊「亂數取卦」自動生成數字。數字經模數運算轉換為卦象。</div>
    </div>
    <div id="manual" class="tab-content">
      <div class="row">
        <label>上卦：</label>
        <select id="selUpper">
          <option value="">請選擇</option>
          <option value="1">乾</option>
          <option value="2">兌</option>
          <option value="3">離</option>
          <option value="4">震</option>
          <option value="5">巽</option>
          <option value="6">坎</option>
          <option value="7">艮</option>
          <option value="8">坤</option>
        </select>
      </div>
      <div class="row">
        <label>下卦：</label>
        <select id="selLower">
          <option value="">請選擇</option>
          <option value="1">乾</option>
          <option value="2">兌</option>
          <option value="3">離</option>
          <option value="4">震</option>
          <option value="5">巽</option>
          <option value="6">坎</option>
          <option value="7">艮</option>
          <option value="8">坤</option>
        </select>
      </div>
      <div class="row">
        <label>動爻（1-6，可多選以逗號分隔）：</label>
        <input id="inputMoving" type="text" placeholder="例如：1,3,5" />
      </div>
      <div class="row">
        <label>問題（可選）：</label>
        <input id="questionManual" type="text" placeholder="請輸入您的問題" />
      </div>
      <button id="btnManual" class="primary">手動取卦</button>
      <div class="hint">說明：直接選擇上卦與下卦，並指定動爻（若有）。動爻以逗號分隔輸入，例如“1,3,5”。</div>
    </div>
    <div id="time" class="tab-content">
      <div class="row">
        <label><input type="radio" name="time-method" value="modern" checked /> 現代時間</label>
        <label><input type="radio" name="time-method" value="traditional" /> 傳統時辰</label>
      </div>
      <div id="modern-time-inputs">
        <div class="row">
          <label>日期時間：</label>
          <input id="dtInput" type="datetime-local" />
          <button id="nowQuick" class="primary">現在</button>
        </div>
        <div class="row">
          <label>問題（可選）：</label>
          <input id="questionTime" type="text" placeholder="請輸入您的問題" />
        </div>
      </div>
      <div id="traditional-time-inputs" class="hidden">
        <div class="row">
          <label>日期：</label>
          <input id="dateInput" type="date" />
        </div>
        <div class="row">
          <label>時辰：</label>
          <select id="shichenInput">
            <option value="23">子時 (23:00-01:00)</option>
            <option value="1">丑時 (01:00-03:00)</option>
            <option value="3">寅時 (03:00-05:00)</option>
            <option value="5">卯時 (05:00-07:00)</option>
            <option value="7">辰時 (07:00-09:00)</option>
            <option value="9">巳時 (09:00-11:00)</option>
            <option value="11">午時 (11:00-13:00)</option>
            <option value="13">未時 (13:00-15:00)</option>
            <option value="15">申時 (15:00-17:00)</option>
            <option value="17">酉時 (17:00-19:00)</option>
            <option value="19">戌時 (19:00-21:00)</option>
            <option value="21">亥時 (21:00-23:00)</option>
        </select>
        </div>
        <div class="row">
          <label>分鐘（可選）：</label>
          <input id="minuteInput" type="number" min="0" max="59" />
        </div>
        <div class="row">
          <label>問題（可選）：</label>
          <input id="questionTime" type="text" placeholder="請輸入您的問題" />
        </div>
      </div>
      <button id="btnTime" class="primary">時間取卦</button>
      <div class="hint">說明：現代時間使用年月日時分計算卦象；傳統時辰使用日期與時辰（可選分鐘）。動爻由時間總和決定。</div>
    </div>
    <div id="image" class="tab-content">
      <div class="row">
        <label>上卦（物象）：</label>
        <select id="upperImageSelect">
          <option value="">請選擇</option>
          <option value="1">天、父、金屬</option>
          <option value="2">澤、少女、金屬</option>
          <option value="3">火、中女、電光</option>
          <option value="4">雷、長男、動態</option>
          <option value="5">風、長女、木</option>
          <option value="6">水、中男、液體</option>
          <option value="7">山、少男、石頭</option>
          <option value="8">地、母、土壤</option>
        </select>
      </div>
      <div class="row">
        <label>下卦（方位）：</label>
        <select id="lowerDirectionSelect">
          <option value="">請選擇</option>
          <option value="1">西北</option>
          <option value="2">西</option>
          <option value="3">南</option>
          <option value="4">東</option>
          <option value="5">東南</option>
          <option value="6">北</option>
          <option value="7">東北</option>
          <option value="8">中</option>
        </select>
      </div>
      <div class="row">
        <label><input id="imageUseMinute" type="checkbox" checked /> 使用當前分鐘作為動爻</label>
      </div>
      <div class="row">
        <label>動爻（1-6，若不勾選分鐘）：</label>
        <input id="imageMovingInput" type="number" min="1" max="6" />
      </div>
      <div class="row">
        <label>問題（可選）：</label>
        <input id="questionImage" type="text" placeholder="請輸入您的問題" />
      </div>
      <button id="btnImage" class="primary">以象取卦</button>
      <div class="hint">說明：根據物象選擇上卦，根據方位選擇下卦，動爻可由當前分鐘自動生成或手動輸入。</div>
    </div>
    <div id="history" class="tab-content">
      <div class="row">
        <button id="clearHistoryBtn" class="primary">清除記錄</button>
        <button id="exportHistoryBtn" class="primary">匯出記錄</button>
        <input type="file" id="importHistoryInput" accept=".json" style="padding: 10px;" />
        <button id="importHistoryBtn" class="primary">匯入記錄</button>
      </div>
      <div id="historyList"></div>
      <div class="hint">說明：顯示過去的占卜記錄，點擊可重新載入卦象進行分析。可匯出或匯入記錄（JSON格式）。</div>
    </div>
    <div id="result" class="gua-box hidden">
      <h3 id="resultTitle">占卜結果</h3>
      <div class="row">
        <div>
          <h4>本卦</h4>
          <div id="guaImage" class="gua-display-container"></div>
          <div id="guaName" class="gua-name">未知</div>
        </div>
        <div>
          <h4>互卦</h4>
          <div id="huGuaImage" class="gua-display-container"></div>
          <div id="huGuaName" class="gua-name">未知</div>
        </div>
        <div>
          <h4>變卦</h4>
          <div id="changeGuaImage" class="gua-display-container"></div>
          <div id="changeGuaName" class="gua-name">未知</div>
        </div>
      </div>
      <p id="guaNote"></p>
      <div id="lineExplanation" class="line-explanation"></div>
      <div class="row">
        <button id="judgeBtn" class="primary">五行與象徵</button>
      </div>
      <div id="judgeBox" class="gua-box hidden">
        <h3 id="judgeTitle">五行與象徵</h3>
        <div class="auspiciousness-index">
          <span id="auspiciousnessIndex">吉凶指數：未計算</span>
          <div id="auspiciousnessBar" class="auspiciousness-bar"></div>
        </div>
        <div class="wuxing-controls">
          <button id="downloadSvgBtn" class="primary">下載圖表</button>
          <button id="openSvgWindowBtn" class="primary">在新視窗查看</button>
        </div>
<div id="wuxingAnalysis">
    <div id="wuxingAnalysis" class="hidden">
    <svg id="wuxingSvg" width="600" height="400"></svg>
  </div>
  <div class="auspiciousness-box">
    <div id="auspiciousnessIndex">吉凶指數：0.0</div>
    <div id="auspiciousnessBar"><div style="width: 0%; height: 100%; background: var(--secondary-color);"></div></div>
  </div>
  <button onclick="openWuxingWindow()">開新視窗顯示五行圖</button>
  <script>
    // 五行顏色映射
    const wuxingColors = {
      '木': '#2ecc71',
      '火': '#e74c3c',
      '土': '#f1c40f',
      '金': '#ecf0f1',
      '水': '#3498db'
    };
  <svg id="wuxingSvg" width="600" height="400"></svg>
  <div class="wuxing-box">
    <h4>本卦現況</h4>
    <p><strong>整體：</strong> <span id="mainOverall"></span></p>
    <p><strong>描述：</strong> <span id="mainDescription"></span></p>
    <p><strong>愛情：</strong> <span id="mainLove"></span></p>
    <p><strong>事業：</strong> <span id="mainCareer"></span></p>
    <p><strong>財運：</strong> <span id="mainWealth"></span></p>
    <p><strong>健康：</strong> <span id="mainHealth"></span></p>
    <p><strong>人際：</strong> <span id="mainRelationship"></span></p>
    <p><strong>生活：</strong> <span id="mainLife"></span></p>
    <p><strong>建議：</strong> <span id="mainGuidance"></span></p>
  </div>
  <div class="wuxing-box">
    <h4>互卦外在過程（上卦）</h4>
    <p><strong>整體：</strong> <span id="huUpperOverall"></span></p>
    <p><strong>描述：</strong> <span id="huUpperDescription"></span></p>
  </div>
  <div class="wuxing-box">
    <h4>互卦內在過程（下卦）</h4>
    <p><strong>整體：</strong> <span id="huLowerOverall"></span></p>
    <p><strong>描述：</strong> <span id="huLowerDescription"></span></p>
  </div>
  <div class="wuxing-box">
    <h4>變卦未來趨勢（上卦）</h4>
    <p><strong>整體：</strong> <span id="changeUpperOverall"></span></p>
    <p><strong>描述：</strong> <span id="changeUpperDescription"></span></p>
  </div>
  <div class="wuxing-box">
    <h4>變卦變化基礎（下卦）</h4>
    <p><strong>整體：</strong> <span id="changeLowerOverall"></span></p>
    <p><strong>描述：</strong> <span id="changeLowerDescription"></span></p>
  </div>
  <div class="wuxing-box">
    <h4>綜合吉凶</h4>
    <p><strong>結果：</strong> <span id="combinedResult"></span></p>
  </div>
</div>

      </div>
    </div>
  </div>
  <script>
   <script>
  let hexagrams = {}, quotes = [], history = [], currentResult = null, wuxingExplanations = {};
  const trigramName = {
    1: '乾', 2: '兌', 3: '離', 4: '震', 5: '巽', 6: '坎', 7: '艮', 8: '坤'
  };

  const guaTable = {
    1: [1, 1, 1, '金', '乾'],
    2: [1, 1, 0, '金', '兌'],
    3: [1, 0, 1, '火', '離'],
    4: [1, 0, 0, '木', '震'],
    5: [0, 1, 1, '木', '巽'],
    6: [0, 1, 0, '水', '坎'],
    7: [0, 0, 1, '土', '艮'],
    8: [0, 0, 0, '土', '坤']
  };

  const triIndexByLines = new Map(Object.entries({
    '[1,1,1]': 1, '[1,1,0]': 2, '[1,0,1]': 3, '[1,0,0]': 4,
    '[0,1,1]': 5, '[0,1,0]': 6, '[0,0,1]': 7, '[0,0,0]': 8
  }).map(([k, v]) => [k, parseInt(v)]));

  const hexagramNameMap = new Map([
    ['[1,1,1,1,1,1]', '乾為天'],
    ['[0,1,1,1,1,1]', '天風姤'],
    ['[0,1,0,1,1,1]', '天水訟'],
    ['[0,0,1,1,1,1]', '天山遯'],
    ['[0,0,0,1,1,1]', '天地否'],
    ['[1,0,0,1,1,1]', '天雷無妄'],
    ['[0,1,1,0,1,1]', '天澤履'],
    ['[1,0,1,1,1,1]', '天火同人'],
    ['[1,1,0,1,1,0]', '兌為澤'],
    ['[0,1,0,1,1,0]', '澤水困'],
    ['[1,0,1,1,1,0]', '澤火革'],
    ['[0,0,1,1,1,0]', '澤山咸'],
    ['[0,0,0,1,1,0]', '澤地萃'],
    ['[1,0,0,1,1,0]', '澤雷隨'],
    ['[0,1,1,1,1,0]', '澤風大過'],
    ['[1,1,1,1,1,0]', '澤天夬'],
    ['[1,0,1,1,0,1]', '離為火'],
    ['[0,1,0,1,0,1]', '火水未濟'],
    ['[1,1,0,1,0,1]', '火風鼎'],
    ['[0,0,1,1,0,1]', '火山旅'],
    ['[0,0,0,1,0,1]', '火地晉'],
    ['[1,0,0,1,0,1]', '火雷噬嗑'],
    ['[0,1,1,1,0,1]', '火澤睽'],
    ['[1,1,1,1,0,1]', '火天大有'],
    ['[1,0,0,1,0,0]', '震為雷'],
    ['[0,1,0,1,0,0]', '雷水解'],
    ['[1,1,0,1,0,0]', '雷澤歸妹'],
    ['[0,0,1,1,0,0]', '雷山小過'],
    ['[0,0,0,1,0,0]', '雷地豫'],
    ['[1,0,1,1,0,0]', '雷火豐'],
    ['[0,1,1,1,0,0]', '雷風恆'],
    ['[1,1,1,1,0,0]', '雷天大壯'],
    ['[0,1,1,0,1,1]', '巽為風'],
    ['[0,1,0,0,1,1]', '風水渙'],
    ['[1,1,0,0,1,1]', '風澤中孚'],
    ['[0,0,1,0,1,1]', '風山漸'],
    ['[0,0,0,0,1,1]', '風地觀'],
    ['[1,0,0,0,1,1]', '風雷益'],
    ['[1,0,1,0,1,1]', '風火家人'],
    ['[0,1,1,0,1,1]', '風天小畜'],
    ['[0,1,0,0,1,0]', '坎為水'],
    ['[1,1,0,0,1,0]', '水澤節'],
    ['[0,0,1,0,1,0]', '水山蹇'],
    ['[0,0,0,0,1,0]', '水地比'],
    ['[1,0,0,0,1,0]', '水雷屯'],
    ['[1,0,1,0,1,0]', '水火既濟'],
    ['[0,1,1,0,1,0]', '水風井'],
    ['[1,1,1,0,1,0]', '水天需'],
    ['[0,0,1,0,0,1]', '艮為山'],
    ['[0,1,0,0,0,1]', '山水蒙'],
    ['[1,1,0,0,0,1]', '山澤損'],
    ['[1,0,1,0,0,1]', '山火賁'],
    ['[1,0,0,0,0,1]', '山雷頤'],
    ['[0,1,1,0,0,1]', '山風蠱'],
    ['[0,0,0,0,0,1]', '山地剝'],
    ['[1,1,1,0,0,1]', '山天大畜'],
    ['[0,0,0,0,0,0]', '坤為地'],
    ['[0,1,0,0,0,0]', '地水師'],
    ['[1,1,0,0,0,0]', '地澤臨'],
    ['[0,0,1,0,0,0]', '地山謙'],
    ['[1,0,0,0,0,0]', '地雷復'],
    ['[1,0,1,0,0,0]', '地火明夷'],
    ['[0,1,1,0,0,0]', '地風升'],
    ['[1,1,1,0,0,0]', '地天泰']
  ]);

  const palaceMap = {
    '乾為天': ['乾為天', '天澤履', '天火同人', '天雷無妄', '天風姤', '天水訟', '天山遯', '天地否'],
    '兌為澤': ['澤天夬', '兌為澤', '澤火革', '澤雷隨', '澤風大過', '澤水困', '澤山咸', '澤地萃'],
    '離為火': ['火天大有', '火澤睽', '離為火', '火雷噬嗑', '火風鼎', '火水未濟', '火山旅', '火地晉'],
    '震為雷': ['雷天大壯', '雷澤歸妹', '雷火豐', '震為雷', '雷風恆', '雷水解', '雷山小過', '雷地豫'],
    '巽為風': ['風天小畜', '風澤中孚', '風火家人', '風雷益', '巽為風', '風水渙', '風山漸', '風地觀'],
    '坎為水': ['水天需', '水澤節', '水火既濟', '水雷屯', '水風井', '坎為水', '水山蹇', '水地比'],
    '艮為山': ['山天大畜', '山澤損', '山火賁', '山雷頤', '山風蠱', '山水蒙', '艮為山', '山地剝'],
    '坤為地': ['地天泰', '地澤臨', '地火明夷', '地雷復', '地風升', '地水師', '地山謙', '坤為地']
  };

  const lunarCalendar = {
    gregorianToLunar: (date) => {
      const month = date.getMonth() + 1;
      const day = date.getDate();
      const lunarMonths = [
        { gregorian: [1, 1, 2, 15], lunarMonth: '臘月', season: '冬', lunarMonthNumber: 12 },
        { gregorian: [2, 16, 3, 15], lunarMonth: '正月', season: '春', lunarMonthNumber: 1 },
        { gregorian: [3, 16, 4, 15], lunarMonth: '二月', season: '春', lunarMonthNumber: 2 },
        { gregorian: [4, 16, 5, 15], lunarMonth: '三月', season: '春', lunarMonthNumber: 3 },
        { gregorian: [5, 16, 6, 15], lunarMonth: '四月', season: '夏', lunarMonthNumber: 4 },
        { gregorian: [6, 16, 7, 15], lunarMonth: '五月', season: '夏', lunarMonthNumber: 5 },
        { gregorian: [7, 16, 8, 15], lunarMonth: '六月', season: '夏', lunarMonthNumber: 6 },
        { gregorian: [8, 16, 9, 15], lunarMonth: '七月', season: '秋', lunarMonthNumber: 7 },
        { gregorian: [9, 16, 10, 15], lunarMonth: '八月', season: '秋', lunarMonthNumber: 8 },
        { gregorian: [10, 16, 11, 15], lunarMonth: '九月', season: '秋', lunarMonthNumber: 9 },
        { gregorian: [11, 16, 12, 15], lunarMonth: '十月', season: '冬', lunarMonthNumber: 10 },
        { gregorian: [12, 16, 12, 31], lunarMonth: '十一月', season: '冬', lunarMonthNumber: 11 }
      ];
      for (const period of lunarMonths) {
        const [startMonth, startDay, endMonth, endDay] = period.gregorian;
        if (
          (month > startMonth || (month === startMonth && day >= startDay)) &&
          (month < endMonth || (month === endMonth && day <= endDay))
        ) {
          return {
            lunarMonth: period.lunarMonth,
            season: period.season,
            lunarMonthNumber: period.lunarMonthNumber
          };
        }
      }
      return { lunarMonth: '七月', season: '秋', lunarMonthNumber: 7 }; // 預設 2025/8/25
    }
  };

  const ASPECTS = [
    { k: 'people', label: '人事' },
    { k: 'affairs', label: '事務' },
    { k: 'time', label: '時間' },
    { k: 'place', label: '地點' },
    { k: 'object', label: '物品' }
  ];

  function normalizeKey(str) {
    return str ? str.replace(/[\s-]/g, '').toLowerCase() : '';
  }

  function getHexagramName(upperIdx, lowerIdx) {
    const upperLines = guaTable[upperIdx]?.slice(0, 3) || [0, 0, 0];
    const lowerLines = guaTable[lowerIdx]?.slice(0, 3) || [0, 0, 0];
    const lines = [...lowerLines, ...upperLines];
    const key = JSON.stringify(lines);
    return hexagramNameMap.get(key) || `${trigramName[upperIdx] || '未知'}${trigramName[lowerIdx] || '未知'}`;
  }

  function getSamePalaceHexagrams(hexName) {
    for (const [palace, hexagrams] of Object.entries(palaceMap)) {
      if (hexagrams.includes(hexName)) {
        return { palace, hexagrams };
      }
    }
    return { palace: '未知', hexagrams: [hexName] };
  }

  function getTrigramInfo(idx) {
    const [lines1, lines2, lines3, wuxing, name] = guaTable[idx] || [0, 0, 0, '未知', '未知'];
    return { name, wuxing, lines: [lines1, lines2, lines3] };
  }

  function getRelation(tiWuxing, yongWuxing) {
    if (!tiWuxing || !yongWuxing) return '未知';
    if (tiWuxing === yongWuxing) return '比和';
    const generate = { '木': '火', '火': '土', '土': '金', '金': '水', '水': '木' };
    const overcome = { '木': '土', '土': '水', '水': '火', '火': '金', '金': '木' };
    if (generate[yongWuxing] === tiWuxing) return '用生體';
    if (generate[tiWuxing] === yongWuxing) return '體生用';
    if (overcome[yongWuxing] === tiWuxing) return '用剋體';
    if (overcome[tiWuxing] === yongWuxing) return '體剋用';
    return '未知';
  }

  function getRelationScore(relation) {
    switch (relation) {
      case '用生體': return 10;
      case '體剋用': return 3;
      case '比和': return 0;
      case '體生用': return -5;
      case '用剋體': return -10;
      default: return 0;
    }
  }

  function getWuxingStatus(wuxing, lunarMonthNumber) {
    const statuses = {
      '木': {
        1: '旺', 2: '旺', 3: '旺',
        4: '休', 5: '休', 6: '休',
        7: '囚', 8: '囚', 9: '囚',
        10: '死', 11: '死', 12: '死'
      },
      '火': {
        1: '死', 2: '相', 3: '相',
        4: '旺', 5: '旺', 6: '旺',
        7: '休', 8: '休', 9: '休',
        10: '囚', 11: '囚', 12: '囚'
      },
      '土': {
        1: '囚', 2: '囚', 3: '旺',
        4: '相', 5: '相', 6: '旺',
        7: '死', 8: '死', 9: '旺',
        10: '休', 11: '休', 12: '旺'
      },
      '金': {
        1: '囚', 2: '囚', 3: '相',
        4: '死', 5: '死', 6: '相',
        7: '旺', 8: '旺', 9: '旺',
        10: '休', 11: '休', 12: '相'
      },
      '水': {
        1: '休', 2: '休', 3: '死',
        4: '囚', 5: '囚', 6: '死',
        7: '相', 8: '相', 9: '死',
        10: '旺', 11: '旺', 12: '旺'
      }
    };
    return statuses[wuxing]?.[lunarMonthNumber] || '未知';
  }

  function getWuxingStatusScore(wuxing, lunarMonthNumber) {
    switch (getWuxingStatus(wuxing, lunarMonthNumber)) {
      case '旺': return 5;
      case '相': return 3;
      case '休': return 0;
      case '囚': return -3;
      case '死': return -5;
      default: return 0;
    }
  }

  function getWuxingStrength(status) {
    switch (status) {
      case '旺': return 5;
      case '相': return 4;
      case '休': return 3;
      case '囚': return 2;
      case '死': return 1;
      default: return 1;
    }
  }

  function getTiYong(result) {
    const moving = result.moving || [];
    const upperIdx = result.uIdx;
    const lowerIdx = result.lIdx;
    const tiGua = moving.length === 0 || moving.every(m => m > 3)
      ? getTrigramInfo(lowerIdx)
      : getTrigramInfo(upperIdx);
    const yongGua = moving.length === 0 || moving.every(m => m > 3)
      ? getTrigramInfo(upperIdx)
      : getTrigramInfo(lowerIdx);
    return { tiGua, yongGua };
  }

  function getLineEntryFor(hex, lineIdx) {
    return hex.lines?.find(line => line.index === lineIdx) || { text: '無爻辭', meaning: '無解釋', score: 5 };
  }

  function clamp(value) {
    return Math.max(0, Math.min(10, value));
  }

  async function loadResources() {
    try {
      const [hexResponse, quotesResponse, wuxingResponse] = await Promise.all([
        fetch('hexagrams.json').then(res => res.ok ? res.json() : Promise.reject(`hexagrams.json 載入失敗: ${res.status}`)),
        fetch('quotes.json').then(res => res.ok ? res.json() : Promise.reject(`quotes.json 載入失敗: ${res.status}`)),
        fetch('wuxing_explanations.json').then(res => res.ok ? res.json() : Promise.reject(`wuxing_explanations.json 載入失敗: ${res.status}`))
      ]);
      hexagrams = Object.fromEntries(
        Object.entries(hexResponse).map(([key, value]) => [normalizeKey(key), {
          name: value.name || key,
          judgment: value.judgment || { text: '無卦辭', meaning: '無解釋', people: 5, affairs: 5, time: 5, place: 5, object: 5 },
          symbolism: value.symbolism || { people: 5, affairs: 5, time: 5, place: 5, object: 5 },
          lines: value.lines || []
        }])
      );
      quotes = Array.isArray(quotesResponse) ? quotesResponse : ['請選擇取卦方式以開始占卜'];
      wuxingExplanations = wuxingResponse.relations || {
        main: { harmony: { overall: '無說明', details: { kun: { description: '無解釋', love: '', career: '', wealth: '', health: '', relationship: '', life: '', guidance: '' } } },
        hu_upper: { harmony: { overall: '無說明', details: { kun: { description: '無解釋' } } } },
        hu_lower: { harmony: { overall: '無說明', details: { kun: { description: '無解釋' } } } },
        change_upper: { harmony: { overall: '無說明', details: { kun: { description: '無解釋' } } } },
        change_lower: { harmony: { overall: '無說明', details: { kun: { description: '無解釋' } } } },
        combined: { neutral: { details: '無綜合說明' } }
      };
      document.getElementById('subtitle').textContent = quotes[Math.floor(Math.random() * quotes.length)];
    } catch (error) {
      console.error('載入 JSON 檔案失敗:', error);
      alert('無法載入資料，請檢查檔案路徑或格式！使用預設數據。');
      hexagrams = {
        '乾為天': {
          name: '乾為天',
          judgment: { text: '元亨利貞', meaning: '大吉大利', people: 8, affairs: 8, time: 8, place: 8, object: 8 },
          symbolism: { people: 8, affairs: 8, time: 8, place: 8, object: 8 },
          lines: []
        }
      };
      quotes = ['請選擇取卦方式以開始占卜'];
      wuxingExplanations = {
        main: { harmony: { overall: '無說明', details: { kun: { description: '無解釋', love: '', career: '', wealth: '', health: '', relationship: '', life: '', guidance: '' } } },
        hu_upper: { harmony: { overall: '無說明', details: { kun: { description: '無解釋' } } } },
        hu_lower: { harmony: { overall: '無說明', details: { kun: { description: '無解釋' } } } },
        change_upper: { harmony: { overall: '無說明', details: { kun: { description: '無解釋' } } } },
        change_lower: { harmony: { overall: '無說明', details: { kun: { description: '無解釋' } } } },
        combined: { neutral: { details: '無綜合說明' } }
      };
      document.getElementById('subtitle').textContent = quotes[0];
    }
  }

  function saveHistory() {
    try {
      localStorage.setItem('guaHistory', JSON.stringify(history));
    } catch (error) {
      console.error('儲存歷史記錄失敗:', error);
    }
  }

  function loadHistory() {
    try {
      const stored = localStorage.getItem('guaHistory');
      history = stored ? JSON.parse(stored) : [];
      renderHistory();
    } catch (error) {
      console.error('載入歷史記錄失敗:', error);
    }
  }

  function exportHistory() {
    try {
      const dataStr = JSON.stringify(history, null, 2);
      const blob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = 'gua_history.json';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
    } catch (error) {
      console.error('匯出歷史記錄失敗:', error);
      alert('無法匯出歷史記錄，請稍後再試！');
    }
  }

  function importHistory(file) {
    try {
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const imported = JSON.parse(e.target.result);
          if (!Array.isArray(imported)) {
            throw new Error('匯入檔案格式錯誤，必須為陣列');
          }
          const validEntries = imported.filter(item =>
            item.lines && Array.isArray(item.lines) && item.lines.length === 6 &&
            item.changeLines && Array.isArray(item.changeLines) && item.changeLines.length === 6 &&
            item.huLines && Array.isArray(item.huLines) && item.huLines.length === 6 &&
            item.moving && Array.isArray(item.moving) &&
            item.hexMain && item.hexChange && item.hexHu &&
            item.uIdx && item.lIdx && item.method && item.timestamp
          );
          history = [...history, ...validEntries];
          saveHistory();
          renderHistory();
          alert('歷史記錄匯入成功！');
        } catch (error) {
          console.error('解析匯入檔案失敗:', error);
          alert('匯入歷史記錄失敗，請檢查檔案格式！');
        }
      };
      reader.readAsText(file);
    } catch (error) {
      console.error('匯入歷史記錄失敗:', error);
      alert('無法匯入歷史記錄，請稍後再試！');
    }
  }

  function renderHistory() {
    const historyList = document.getElementById('historyList');
    if (!historyList) {
      console.error('找不到 historyList 元素');
      return;
    }
    historyList.innerHTML = history.length === 0 ? '<p>無歷史記錄</p>' : '';
    history.forEach((item, index) => {
      const div = document.createElement('div');
      div.className = 'history-item';
      div.innerHTML = `
        <p><strong>時間：</strong> ${item.timestamp}</p>
        <p><strong>本卦：</strong> ${item.hexMain?.name || '未知'}</p>
        <p><strong>問題：</strong> ${item.question || '無'}</p>
      `;
      div.addEventListener('click', () => {
        currentResult = item;
        generateGua(item.uIdx, item.lIdx, item.moving, item.method, item.timestamp);
        renderWuxingAnalysis(item);
        renderDetailedAnalysis(item);
      });
      historyList.appendChild(div);
    });
  }

  function renderGuaImage(lines, elementId, moving = []) {
    const container = document.getElementById(elementId);
    if (!container) {
      console.error(`找不到元素 ID: ${elementId}`);
      return;
    }
    container.innerHTML = '';
    if (!lines || lines.length !== 6) {
      container.innerHTML = '<p>無法顯示卦象</p>';
      console.warn(`無效的卦象線條數據: ${lines}`);
      return;
    }
    [...lines].reverse().forEach((line, idx) => {
      const lineDiv = document.createElement('div');
      lineDiv.className = `gua-line ${line === 0 ? 'yin' : ''} ${moving.includes(6 - idx) ? 'moving' : ''}`;
      container.appendChild(lineDiv);
    });
  }

  function renderLineExplanation(moving, mainHex, changeHex) {
    const explanationDiv = document.getElementById('lineExplanation');
    if (!explanationDiv) {
      console.error('找不到 lineExplanation 元素');
      return;
    }
    explanationDiv.innerHTML = '';
    if (!mainHex || !mainHex.judgment || !changeHex || !changeHex.judgment) {
      explanationDiv.innerHTML = '<p>無卦辭或爻辭數據</p>';
      console.warn('缺少卦辭或爻辭數據');
      return;
    }

    explanationDiv.innerHTML += `
      <div class="line-explanation">
        <p><strong>本卦：${mainHex.name || '未知'}</strong></p>
        <p><strong>卦辭：</strong> ${mainHex.judgment.text || '無卦辭'}</p>
        <p><strong>解釋：</strong> ${mainHex.judgment.meaning || '無解釋'}</p>
      </div>
    `;

    if (moving.length === 0) {
      // 如果無動爻，已經在卦辭顯示
    } else {
      moving.forEach(lineIdx => {
        const lineEntry = getLineEntryFor(mainHex, lineIdx);
        explanationDiv.innerHTML += `
          <div class="line-explanation">
            <p><strong>第 ${lineIdx} 爻：</strong> ${lineEntry.text || '無爻辭'}</p>
            <p><strong>解釋：</strong> ${lineEntry.meaning || '無解釋'}</p>
            <p><strong>評分：</strong> ${lineEntry.score || 5}</p>
          </div>
        `;
      });
    }

    explanationDiv.innerHTML += `
      <div class="line-explanation">
        <p><strong>變卦：${changeHex.name || '未知'}</strong></p>
        <p><strong>卦辭：</strong> ${changeHex.judgment.text || '無卦辭'}</p>
        <p><strong>解釋：</strong> ${changeHex.judgment.meaning || '無解釋'}</p>
      </div>
    `;
  }

  function generateGua(upperIdx, lowerIdx, moving, method = '未知', timestamp = new Date().toLocaleString('zh-TW')) {
    console.log('generateGua called with:', { upperIdx, lowerIdx, moving, method, timestamp });
    if (!trigramName[upperIdx] || !trigramName[lowerIdx]) {
      alert('無效的卦象輸入，請檢查上卦或下卦！');
      console.error(`無效的卦象索引: 上卦 ${upperIdx}, 下卦 ${lowerIdx}`);
      return;
    }

    const upperLines = guaTable[upperIdx].slice(0, 3);
    const lowerLines = guaTable[lowerIdx].slice(0, 3);
    const lines = [...lowerLines, ...upperLines];

    const changeLines = [...lines];
    moving.forEach(idx => {
      if (idx >= 1 && idx <= 6) {
        changeLines[idx - 1] = changeLines[idx - 1] === 1 ? 0 : 1;
      }
    });

    const huLines = [lines[1], lines[2], lines[3], lines[2], lines[3], lines[4]];

    const mainHexName = getHexagramName(upperIdx, lowerIdx);
    const changeUpperIdx = triIndexByLines.get(JSON.stringify(changeLines.slice(3, 6))) || 8;
    const changeLowerIdx = triIndexByLines.get(JSON.stringify(changeLines.slice(0, 3))) || 8;
    const changeHexName = getHexagramName(changeUpperIdx, changeLowerIdx);
    const huUpperIdx = triIndexByLines.get(JSON.stringify(huLines.slice(3, 6))) || 8;
    const huLowerIdx = triIndexByLines.get(JSON.stringify(huLines.slice(0, 3))) || 8;
    const huHexName = getHexagramName(huUpperIdx, huLowerIdx);

    const mainHex = hexagrams[normalizeKey(mainHexName)] || { name: mainHexName, judgment: { text: '無卦辭', meaning: '無解釋', people: 5, affairs: 5, time: 5, place: 5, object: 5 }, symbolism: { people: 5, affairs: 5, time: 5, place: 5, object: 5 }, lines: [] };
    const changeHex = hexagrams[normalizeKey(changeHexName)] || { name: changeHexName, judgment: { text: '無卦辭', meaning: '無解釋', people: 5, affairs: 5, time: 5, place: 5, object: 5 }, symbolism: { people: 5, affairs: 5, time: 5, place: 5, object: 5 }, lines: [] };
    const huHex = hexagrams[normalizeKey(huHexName)] || { name: huHexName, judgment: { text: '無卦辭', meaning: '無解釋', people: 5, affairs: 5, time: 5, place: 5, object: 5 }, symbolism: { people: 5, affairs: 5, time: 5, place: 5, object: 5 }, lines: [] };

    const mainPalace = getSamePalaceHexagrams(mainHexName);
    console.log(`本卦 ${mainHexName} 屬於 ${mainPalace.palace} 宮，同宮卦：${mainPalace.hexagrams.join(', ')}`);

    let question = '';
    const questionInputs = {
      '數字取卦': 'questionNumber',
      '數字亂數取卦': 'questionNumber',
      '手動取卦': 'questionManual',
      '現代時間取卦': 'questionTime',
      '傳統時辰取卦': 'questionTime',
      '以象取卦': 'questionImage'
    };
    const questionInputId = questionInputs[method];
    if (questionInputId) {
      const input = document.getElementById(questionInputId);
      question = input?.value.trim() || '';
    }

    currentResult = {
      lines,
      changeLines,
      huLines,
      moving,
      hexMain: mainHex,
      hexChange: changeHex,
      hexHu: huHex,
      uIdx: upperIdx,
      lIdx: lowerIdx,
      method,
      timestamp,
      question
    };

    history.push(currentResult);
    saveHistory();
    renderHistory();

    const resultDiv = document.getElementById('result');
    const guaName = document.getElementById('guaName');
    const changeGuaName = document.getElementById('changeGuaName');
    const huGuaName = document.getElementById('huGuaName');
    const guaNote = document.getElementById('guaNote');
    const resultTitle = document.getElementById('resultTitle');

    if (!resultDiv || !guaName || !changeGuaName || !huGuaName || !guaNote || !resultTitle) {
      console.error('找不到結果顯示相關元素');
      alert('頁面元素載入錯誤，請檢查 HTML 結構！');
      return;
    }

    resultDiv.classList.remove('hidden');
    guaName.textContent = mainHex.name || mainHexName;
    changeGuaName.textContent = changeHex.name || changeHexName;
    huGuaName.textContent = huHex.name || huHexName;
    guaNote.textContent = `本卦：${trigramName[lowerIdx]}為下，${trigramName[upperIdx]}為上，動爻：${moving.join('、') || '無'}，取卦方式：${method}${question ? `，問：${question}` : ''}`;
    resultTitle.textContent = question || '占卜結果';

    renderGuaImage(lines, 'guaImage', moving);
    renderGuaImage(changeLines, 'changeGuaImage', moving);
    renderGuaImage(huLines, 'huGuaImage');
    renderLineExplanation(moving, mainHex, changeHex);
  }

  function downloadSvg() {
    const svg = document.getElementById('wuxingSvg');
    if (!svg) {
      alert('無法找到圖表！');
      return;
    }
    const serializer = new XMLSerializer();
    const source = '<?xml version="1.0" standalone="no"?>\r\n' + serializer.serializeToString(svg);
    const blob = new Blob([source], { type: 'image/svg+xml;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    const filename = currentResult.question ? `wuxing_${currentResult.question.slice(0, 20)}.svg` : `wuxing_${new Date().toISOString().replace(/[:.]/g, '-')}.svg`;
    link.href = url;
    link.download = filename;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
  }

  function openSvgInNewWindow() {
    const svg = document.getElementById('wuxingSvg');
    if (!svg) {
      alert('無法找到圖表！');
      return;
    }
    const serializer = new XMLSerializer();
    const svgContent = serializer.serializeToString(svg);
    const newWindow = window.open('', '_blank');
    newWindow.document.write(`
      <!DOCTYPE html>
      <html>
      <head>
        <title>五行生克圖</title>
        <style>
          body { margin: 0; padding: 20px; background: #f4f7f9; font-family: 'Noto Sans TC', sans-serif; }
          svg { display: block; margin: 0 auto; }
        </style>
      </head>
      <body>
        ${svgContent}
      </body>
      </html>
    `);
    newWindow.document.close();
  }

  function renderWuxingDiagram(tiGua, mainUpperGua, mainLowerGua, huUpperGua, huLowerGua, changeUpperGua, changeLowerGua, lunarMonth, season, lunarMonthNumber) {
    const svg = d3.select('#wuxingSvg');
    if (!svg.node()) {
      console.error('找不到 wuxingSvg 元素');
      alert('無法顯示五行生克圖，請檢查頁面結構！');
      return;
    }
    if (!tiGua || !mainUpperGua || !mainLowerGua || !huUpperGua || !huLowerGua || !changeUpperGua || !changeLowerGua || !lunarMonth || !season || !lunarMonthNumber) {
      console.error('五行圖表缺少必要參數', { tiGua, mainUpperGua, mainLowerGua, huUpperGua, huLowerGua, changeUpperGua, changeLowerGua, lunarMonth, season, lunarMonthNumber });
      alert('無法生成五行圖表，數據不完整！');
      return;
    }

    svg.selectAll('*').remove();

    svg.append('defs').selectAll('marker')
      .data([
        { id: 'arrow-generate', fill: 'var(--positive-color)' },
        { id: 'arrow-overcome', fill: 'var(--negative-color)' },
        { id: 'arrow-harmony', fill: 'var(--secondary-color)' },
        { id: 'arrow-harmony-reverse', fill: 'var(--secondary-color)' }
      ])
      .enter()
      .append('marker')
      .attr('id', d => d.id)
      .attr('viewBox', '0 0 10 10')
      .attr('refX', 5)
      .attr('refY', 5)
      .attr('markerWidth', 6)
      .attr('markerHeight', 6)
      .attr('orient', d => d.id === 'arrow-harmony-reverse' ? 'auto-start-reverse' : 'auto')
      .append('path')
      .attr('d', 'M 0 0 L 10 5 L 0 10 z')
      .attr('fill', d => d.fill);

    const question = currentResult?.question ? `問題：${currentResult.question.slice(0, 30)}${currentResult.question.length > 30 ? '...' : ''}` : '五行生克圖';
    svg.append('text')
      .attr('x', 300)
      .attr('y', 20)
      .attr('text-anchor', 'middle')
      .attr('font-size', '16')
      .attr('font-weight', 'bold')
      .text(question);

    const wuxingStatus = {
      '木': getWuxingStatus('木', lunarMonthNumber),
      '火': getWuxingStatus('火', lunarMonthNumber),
      '土': getWuxingStatus('土', lunarMonthNumber),
      '金': getWuxingStatus('金', lunarMonthNumber),
      '水': getWuxingStatus('水', lunarMonthNumber)
    };
    const statusText = `農曆：${lunarMonth}（${season}），五行狀態：旺：${Object.keys(wuxingStatus).find(k => wuxingStatus[k] === '旺') || '無'}，` +
                      `相：${Object.keys(wuxingStatus).find(k => wuxingStatus[k] === '相') || '無'}，` +
                      `休：${Object.keys(wuxingStatus).find(k => wuxingStatus[k] === '休') || '無'}，` +
                      `囚：${Object.keys(wuxingStatus).find(k => wuxingStatus[k] === '囚') || '無'}，` +
                      `死：${Object.keys(wuxingStatus).find(k => wuxingStatus[k] === '死') || '無'}`;
    svg.append('text')
      .attr('x', 300)
      .attr('y', 40)
      .attr('text-anchor', 'middle')
      .attr('font-size', '14')
      .text(statusText);

    const nodes = [
      { id: 'ti', name: tiGua.name, wuxing: tiGua.wuxing, x: 250, y: 200, label: '體卦', status: getWuxingStatus(tiGua.wuxing, lunarMonthNumber) },
      { id: 'mainUpper', name: mainUpperGua.name, wuxing: mainUpperGua.wuxing, x: 100, y: 100, label: '本卦上卦', status: getWuxingStatus(mainUpperGua.wuxing, lunarMonthNumber) },
      { id: 'mainLower', name: mainLowerGua.name, wuxing: mainLowerGua.wuxing, x: 100, y: 300, label: '本卦下卦', status: getWuxingStatus(mainLowerGua.wuxing, lunarMonthNumber) },
      { id: 'huUpper', name: huUpperGua.name, wuxing: huUpperGua.wuxing, x: 400, y: 100, label: '互卦上卦', status: getWuxingStatus(huUpperGua.wuxing, lunarMonthNumber) },
      { id: 'huLower', name: huLowerGua.name, wuxing: huLowerGua.wuxing, x: 400, y: 300, label: '互卦下卦', status: getWuxingStatus(huLowerGua.wuxing, lunarMonthNumber) },
      { id: 'changeUpper', name: changeUpperGua.name, wuxing: changeUpperGua.wuxing, x: 550, y: 100, label: '變卦上卦', status: getWuxingStatus(changeUpperGua.wuxing, lunarMonthNumber) },
      { id: 'changeLower', name: changeLowerGua.name, wuxing: changeLowerGua.wuxing, x: 550, y: 300, label: '變卦下卦', status: getWuxingStatus(changeLowerGua.wuxing, lunarMonthNumber) }
    ];

    const nodeGroup = svg.selectAll('.wuxing-node')
      .data(nodes)
      .enter()
      .append('g');

    nodeGroup.append('circle')
      .attr('class', 'wuxing-node')
      .attr('cx', d => d.x)
      .attr('cy', d => d.y)
      .attr('r', 40)
      .attr('stroke-width', d => getWuxingStrength(d.status))
      .attr('fill', d => d.id === 'ti' ? '#d5e8f9' : 'none')
      .on('click', (event, d) => updateTiGua(d.id));

    nodeGroup.append('text')
      .attr('class', 'wuxing-node-text')
      .attr('x', d => d.x)
      .attr('y', d => d.y - 10)
      .attr('text-anchor', 'middle')
      .text(d => `${d.name} (${d.wuxing}, ${d.status})`);

    nodeGroup.append('text')
      .attr('class', 'wuxing-node-text')
      .attr('x', d => d.x)
      .attr('y', d => d.y + 15)
      .attr('text-anchor', 'middle')
      .text(d => d.label);

    const edges = [];
    nodes.forEach(node => {
      if (node.id !== 'ti') {
        const relation = getRelation(tiGua.wuxing, node.wuxing);
        let className, source, target, markers;
        if (relation === '用生體') {
          className = 'wuxing-edge-generate';
          source = node.id;
          target = 'ti';
          markers = { end: 'url(#arrow-generate)' };
        } else if (relation === '用剋體') {
          className = 'wuxing-edge-overcome';
          source = node.id;
          target = 'ti';
          markers = { end: 'url(#arrow-overcome)' };
        } else if (relation === '比和') {
          className = 'wuxing-edge-harmony';
          source = node.id;
          target = 'ti';
          markers = { start: 'url(#arrow-harmony-reverse)', end: 'url(#arrow-harmony)' };
        } else if (relation === '體生用') {
          className = 'wuxing-edge-generate';
          source = 'ti';
          target = node.id;
          markers = { end: 'url(#arrow-generate)' };
        } else if (relation === '體剋用') {
          className = 'wuxing-edge-overcome';
          source = 'ti';
          target = node.id;
          markers = { end: 'url(#arrow-overcome)' };
        } else {
          return;
        }
        edges.push({ source, target, className, label: relation, markers });
      }
    });

    const huRelation = getRelation(huUpperGua.wuxing, huLowerGua.wuxing);
    let huClassName, huSource, huTarget, huMarkers, huStrokeWidth;
    huStrokeWidth = getWuxingStrength(getWuxingStatus(huUpperGua.wuxing, lunarMonthNumber));
    if (huRelation === '用生體') {
      huClassName = 'wuxing-edge-generate';
      huSource = 'huLower';
      huTarget = 'huUpper';
      huMarkers = { end: 'url(#arrow-generate)' };
    } else if (huRelation === '用剋體') {
      huClassName = 'wuxing-edge-overcome';
      huSource = 'huLower';
      huTarget = 'huUpper';
      huMarkers = { end: 'url(#arrow-overcome)' };
    } else if (huRelation === '比和') {
      huClassName = 'wuxing-edge-harmony';
      huSource = 'huLower';
      huTarget = 'huUpper';
      huMarkers = { start: 'url(#arrow-harmony-reverse)', end: 'url(#arrow-harmony)' };
    } else if (huRelation === '體生用') {
      huClassName = 'wuxing-edge-generate';
      huSource = 'huUpper';
      huTarget = 'huLower';
      huMarkers = { end: 'url(#arrow-generate)' };
    } else if (huRelation === '體剋用') {
      huClassName = 'wuxing-edge-overcome';
      huSource = 'huUpper';
      huTarget = 'huLower';
      huMarkers = { end: 'url(#arrow-overcome)' };
    }
    if (huRelation !== '未知') {
      edges.push({ source: huSource, target: huTarget, className: huClassName, label: huRelation, markers: huMarkers, strokeWidth: huStrokeWidth });
    }

    const changeRelation = getRelation(changeUpperGua.wuxing, changeLowerGua.wuxing);
    let changeClassName, changeSource, changeTarget, changeMarkers, changeStrokeWidth;
    changeStrokeWidth = getWuxingStrength(getWuxingStatus(changeUpperGua.wuxing, lunarMonthNumber));
    if (changeRelation === '用生體') {
      changeClassName = 'wuxing-edge-generate';
      changeSource = 'changeLower';
      changeTarget = 'changeUpper';
      changeMarkers = { end: 'url(#arrow-generate)' };
    } else if (changeRelation === '用剋體') {
      changeClassName = 'wuxing-edge-overcome';
      changeSource = 'changeLower';
      changeTarget = 'changeUpper';
      changeMarkers = { end: 'url(#arrow-overcome)' };
    } else if (changeRelation === '比和') {
      changeClassName = 'wuxing-edge-harmony';
      changeSource = 'changeLower';
      changeTarget = 'changeUpper';
      changeMarkers = { start: 'url(#arrow-harmony-reverse)', end: 'url(#arrow-harmony)' };
    } else if (changeRelation === '體生用') {
      changeClassName = 'wuxing-edge-generate';
      changeSource = 'changeUpper';
      changeTarget = 'changeLower';
      changeMarkers = { end: 'url(#arrow-generate)' };
    } else if (changeRelation === '體剋用') {
      changeClassName = 'wuxing-edge-overcome';
      changeSource = 'changeUpper';
      changeTarget = 'changeLower';
      changeMarkers = { end: 'url(#arrow-overcome)' };
    }
    if (changeRelation !== '未知') {
      edges.push({ source: changeSource, target: changeTarget, className: changeClassName, label: changeRelation, markers: changeMarkers, strokeWidth: changeStrokeWidth });
    }

    svg.selectAll('.wuxing-edge')
      .data(edges)
      .enter()
      .append('g')
      .each(function(d) {
        const sourceNode = nodes.find(n => n.id === d.source);
        const targetNode = nodes.find(n => n.id === d.target);
        if (!sourceNode || !targetNode) return;

        const dx = targetNode.x - sourceNode.x;
        const dy = targetNode.y - sourceNode.y;
        const length = Math.sqrt(dx * dx + dy * dy);
        const offset = 40;
        const sx = sourceNode.x + (dx / length) * offset;
        const sy = sourceNode.y + (dy / length) * offset;
        const tx = targetNode.x - (dx / length) * offset;
        const ty = targetNode.y - (dy / length) * offset;
        const midX = (sx + tx) / 2;
        const midY = (sy + ty) / 2;

        const strokeWidth = d.strokeWidth || getWuxingStrength(sourceNode.status);

        d3.select(this)
          .append('line')
          .attr('class', d.className)
          .attr('x1', sx)
          .attr('y1', sy)
          .attr('x2', tx)
          .attr('y2', ty)
          .attr('stroke-width', strokeWidth)
          .attr('marker-start', d.markers.start || '')
          .attr('marker-end', d.markers.end || '');

        d3.select(this)
          .append('text')
          .attr('class', 'wuxing-edge-label')
          .attr('x', midX)
          .attr('y', midY - 10)
          .text(d.label);
      });
  }

  function updateTiGua(nodeId) {
    if (!currentResult) {
      console.error('無當前占卜結果');
      alert('請先進行占卜以生成卦象！');
      return;
    }

    console.log('更新體卦，節點 ID:', nodeId);

    const timestamp = new Date(currentResult.timestamp || '2025-08-25T19:02:00+08:00');
    const { lunarMonth, season, lunarMonthNumber } = lunarCalendar.gregorianToLunar(timestamp);

    const mainUpperGua = getTrigramInfo(currentResult.uIdx);
    const mainLowerGua = getTrigramInfo(currentResult.lIdx);
    const changeUpperIdx = triIndexByLines.get(JSON.stringify(currentResult.changeLines.slice(3, 6))) || 8;
    const changeLowerIdx = triIndexByLines.get(JSON.stringify(currentResult.changeLines.slice(0, 3))) || 8;
    const huUpperIdx = triIndexByLines.get(JSON.stringify(currentResult.huLines.slice(3, 6))) || 8;
    const huLowerIdx = triIndexByLines.get(JSON.stringify(currentResult.huLines.slice(0, 3))) || 8;
    const changeUpperGua = getTrigramInfo(changeUpperIdx);
    const changeLowerGua = getTrigramInfo(changeLowerIdx);
    const huUpperGua = getTrigramInfo(huUpperIdx);
    const huLowerGua = getTrigramInfo(huLowerIdx);

    const nodeMap = {
      'mainUpper': mainUpperGua,
      'mainLower': mainLowerGua,
      'huUpper': huUpperGua,
      'huLower': huLowerGua,
      'changeUpper': changeUpperGua,
      'changeLower': changeLowerGua,
      'ti': getTiYong(currentResult).tiGua
    };

    const newTiGua = nodeMap[nodeId];
    if (!newTiGua) {
      console.error(`無效的節點 ID: ${nodeId}`);
      alert(`無效的節點選擇: ${nodeId}`);
      return;
    }

    // 更新圓形填充顏色
    d3.selectAll('.wuxing-node')
      .attr('fill', d => d.id === nodeId ? '#d5e8f9' : 'none');

    const relationMap = {
      '用生體': 'generate_ti',
      '體生用': 'ti_generate_yong',
      '用剋體': 'yong_overcome_ti',
      '體剋用': 'ti_overcome_yong',
      '比和': 'harmony'
    };
    const trigramKeys = {
      1: 'qian', 2: 'dui', 3: 'li', 4: 'zhen', 5: 'xun', 6: 'kan', 7: 'gen', 8: 'kun'
    };

    const relations = {
      mainUpper: getRelation(newTiGua.wuxing, mainUpperGua.wuxing),
      mainLower: getRelation(newTiGua.wuxing, mainLowerGua.wuxing),
      huUpper: getRelation(newTiGua.wuxing, huUpperGua.wuxing),
      huLower: getRelation(newTiGua.wuxing, huLowerGua.wuxing),
      changeUpper: getRelation(newTiGua.wuxing, changeUpperGua.wuxing),
      changeLower: getRelation(newTiGua.wuxing, changeLowerGua.wuxing)
    };

    const explanations = {
      mainUpper: wuxingExplanations.main?.[relationMap[relations.mainUpper]]?.details?.[trigramKeys[currentResult.uIdx]] || { description: '無解釋', love: '無解釋', career: '無解釋', wealth: '無解釋', health: '無解釋', relationship: '無解釋', life: '無解釋', guidance: '無建議' },
      mainLower: wuxingExplanations.main?.[relationMap[relations.mainLower]]?.details?.[trigramKeys[currentResult.lIdx]] || { description: '無解釋' },
      huUpper: wuxingExplanations.hu_upper?.[relationMap[relations.huUpper]]?.details?.[trigramKeys[huUpperIdx]] || { description: '無解釋' },
      huLower: wuxingExplanations.hu_lower?.[relationMap[relations.huLower]]?.details?.[trigramKeys[huLowerIdx]] || { description: '無解釋' },
      changeUpper: wuxingExplanations.change_upper?.[relationMap[relations.changeUpper]]?.details?.[trigramKeys[changeUpperIdx]] || { description: '無解釋' },
      changeLower: wuxingExplanations.change_lower?.[relationMap[relations.changeLower]]?.details?.[trigramKeys[changeLowerIdx]] || { description: '無解釋' }
    };

    const totalRelationScore = [
      relations.mainUpper, relations.mainLower, relations.huUpper,
      relations.huLower, relations.changeUpper, relations.changeLower
    ].reduce((sum, relation) => sum + getRelationScore(relation), 0);
    const wuxingScores = [
      getWuxingStatusScore(mainUpperGua.wuxing, lunarMonthNumber),
      getWuxingStatusScore(mainLowerGua.wuxing, lunarMonthNumber),
      getWuxingStatusScore(huUpperGua.wuxing, lunarMonthNumber),
      getWuxingStatusScore(huLowerGua.wuxing, lunarMonthNumber),
      getWuxingStatusScore(changeUpperGua.wuxing, lunarMonthNumber),
      getWuxingStatusScore(changeLowerGua.wuxing, lunarMonthNumber)
    ];
    const totalWuxingScore = wuxingScores.reduce((sum, score) => sum + score, 0);
    const auspiciousnessScore = clamp((totalRelationScore + totalWuxingScore + 60) / 12);
    let combinedResultKey;
    if (auspiciousnessScore >= 8) combinedResultKey = 'auspicious';
    else if (auspiciousnessScore >= 6) combinedResultKey = 'moderately_auspicious';
    else if (auspiciousnessScore >= 4) combinedResultKey = 'neutral';
    else if (auspiciousnessScore >= 2) combinedResultKey = 'moderately_inauspicious';
    else combinedResultKey = 'inauspicious';
    const combinedExplanation = wuxingExplanations.combined?.[combinedResultKey]?.details || '無綜合說明';

    const auspiciousnessIndex = document.getElementById('auspiciousnessIndex');
    const auspiciousnessBar = document.getElementById('auspiciousnessBar');
    if (auspiciousnessIndex && auspiciousnessBar) {
      auspiciousnessIndex.textContent = `吉凶指數：${auspiciousnessScore.toFixed(1)}`;
      auspiciousnessBar.innerHTML = `<div style="width: ${auspiciousnessScore * 10}%; height: 100%; background: ${auspiciousnessScore >= 7 ? 'var(--positive-color)' : auspiciousnessScore <= 3 ? 'var(--negative-color)' : 'var(--secondary-color)'};"></div>`;
    } else {
      console.warn('找不到 auspiciousnessIndex 或 auspiciousnessBar 元素');
    }

    const wuxingAnalysis = document.getElementById('wuxingAnalysis');
    if (!wuxingAnalysis) {
      console.error('找不到 wuxingAnalysis 元素');
      return;
    }
    wuxingAnalysis.innerHTML = `
      <svg id="wuxingSvg" width="600" height="400"></svg>
      <div class="wuxing-box">
        <h4>本卦現況</h4>
        <p><strong>整體：</strong> <span id="mainOverall">${wuxingExplanations.main?.[relationMap[relations.mainUpper]]?.overall || '無說明'}</span></p>
        <p><strong>描述：</strong> <span id="mainDescription">${explanations.mainUpper.description}</span></p>
        <p><strong>愛情：</strong> <span id="mainLove">${explanations.mainUpper.love}</span></p>
        <p><strong>事業：</strong> <span id="mainCareer">${explanations.mainUpper.career}</span></p>
        <p><strong>財運：</strong> <span id="mainWealth">${explanations.mainUpper.wealth}</span></p>
        <p><strong>健康：</strong> <span id="mainHealth">${explanations.mainUpper.health}</span></p>
        <p><strong>人際：</strong> <span id="mainRelationship">${explanations.mainUpper.relationship}</span></p>
        <p><strong>生活：</strong> <span id="mainLife">${explanations.mainUpper.life}</span></p>
        <p><strong>建議：</strong> <span id="mainGuidance">${explanations.mainUpper.guidance}${wuxingExplanations.main?.[relationMap[relations.mainUpper]]?.remedy?.description ? `<br><strong>化解：</strong> ${wuxingExplanations.main?.[relationMap[relations.mainUpper]]?.remedy?.description}` : ''}</span></p>
      </div>
      <div class="wuxing-box">
        <h4>互卦外在過程（上卦）</h4>
        <p><strong>整體：</strong> <span id="huUpperOverall">${wuxingExplanations.hu_upper?.[relationMap[relations.huUpper]]?.overall || '無說明'}</span></p>
        <p><strong>描述：</strong> <span id="huUpperDescription">${explanations.huUpper.description}</span></p>
      </div>
      <div class="wuxing-box">
        <h4>互卦內在過程（下卦）</h4>
        <p><strong>整體：</strong> <span id="huLowerOverall">${wuxingExplanations.hu_lower?.[relationMap[relations.huLower]]?.overall || '無說明'}</span></p>
        <p><strong>描述：</strong> <span id="huLowerDescription">${explanations.huLower.description}</span></p>
      </div>
      <div class="wuxing-box">
        <h4>變卦未來趨勢（上卦）</h4>
        <p><strong>整體：</strong> <span id="changeUpperOverall">${wuxingExplanations.change_upper?.[relationMap[relations.changeUpper]]?.overall || '無說明'}</span></p>
        <p><strong>描述：</strong> <span id="changeUpperDescription">${explanations.changeUpper.description}</span></p>
      </div>
      <div class="wuxing-box">
        <h4>變卦變化基礎（下卦）</h4>
        <p><strong>整體：</strong> <span id="changeLowerOverall">${wuxingExplanations.change_lower?.[relationMap[relations.changeLower]]?.overall || '無說明'}</span></p>
        <p><strong>描述：</strong> <span id="changeLowerDescription">${explanations.changeLower.description}</span></p>
      </div>
      <div class="wuxing-box">
        <h4>綜合吉凶</h4>
        <p><strong>結果：</strong> <span id="combinedResult">${combinedExplanation}</span></p>
      </div>
    `;

    renderWuxingDiagram(newTiGua, mainUpperGua, mainLowerGua, huUpperGua, huLowerGua, changeUpperGua, changeLowerGua, lunarMonth, season, lunarMonthNumber);
    console.log('吉凶指數更新:', { auspiciousnessScore, combinedResultKey });
  }

  function renderWuxingAnalysis(result) {
    if (!result) {
      console.error('無有效結果數據');
      alert('請先進行占卜以生成卦象！');
      return;
    }

    const timestamp = new Date(result.timestamp || '2025-08-25T19:02:00+08:00');
    const { lunarMonth, season, lunarMonthNumber } = lunarCalendar.gregorianToLunar(timestamp);

    const { tiGua, yongGua } = getTiYong(result);
    const mainUpperGua = getTrigramInfo(result.uIdx);
    const mainLowerGua = getTrigramInfo(result.lIdx);
    const changeUpperIdx = triIndexByLines.get(JSON.stringify(result.changeLines.slice(3, 6))) || 8;
    const changeLowerIdx = triIndexByLines.get(JSON.stringify(result.changeLines.slice(0, 3))) || 8;
    const huUpperIdx = triIndexByLines.get(JSON.stringify(result.huLines.slice(3, 6))) || 8;
    const huLowerIdx = triIndexByLines.get(JSON.stringify(result.huLines.slice(0, 3))) || 8;
    const changeUpperGua = getTrigramInfo(changeUpperIdx);
    const changeLowerGua = getTrigramInfo(changeLowerIdx);
    const huUpperGua = getTrigramInfo(huUpperIdx);
    const huLowerGua = getTrigramInfo(huLowerIdx);

    document.getElementById('judgeBox').classList.remove('hidden');

    const relationMap = {
      '用生體': 'generate_ti',
      '體生用': 'ti_generate_yong',
      '用剋體': 'yong_overcome_ti',
      '體剋用': 'ti_overcome_yong',
      '比和': 'harmony'
    };
    const trigramKeys = {
      1: 'qian', 2: 'dui', 3: 'li', 4: 'zhen', 5: 'xun', 6: 'kan', 7: 'gen', 8: 'kun'
    };

    const mainRelation = getRelation(tiGua.wuxing, yongGua.wuxing);
    const mainRelationKey = relationMap[mainRelation] || 'harmony';
    const mainYongKey = trigramKeys[result.uIdx] || 'kun';
    const mainExplanation = wuxingExplanations.main?.[mainRelationKey]?.details?.[mainYongKey] || { description: '無解釋', love: '', career: '', wealth: '', health: '', relationship: '', life: '', guidance: '' };
    const mainOverall = wuxingExplanations.main?.[mainRelationKey]?.overall || '無說明';
    const mainRemedy = wuxingExplanations.main?.[mainRelationKey]?.remedy?.description || '';

    const huUpperRelation = getRelation(tiGua.wuxing, huUpperGua.wuxing);
    const huUpperRelationKey = relationMap[huUpperRelation] || 'harmony';
    const huUpperKey = trigramKeys[huUpperIdx] || 'kun';
    const huUpperExplanation = wuxingExplanations.hu_upper?.[huUpperRelationKey]?.details?.[huUpperKey] || { description: '無解釋' };

    const huLowerRelation = getRelation(tiGua.wuxing, huLowerGua.wuxing);
    const huLowerRelationKey = relationMap[huLowerRelation] || 'harmony';
    const huLowerKey = trigramKeys[huLowerIdx] || 'kun';
    const huLowerExplanation = wuxingExplanations.hu_lower?.[huLowerRelationKey]?.details?.[huLowerKey] || { description: '無解釋' };

    const changeUpperRelation = getRelation(tiGua.wuxing, changeUpperGua.wuxing);
    const changeUpperRelationKey = relationMap[changeUpperRelation] || 'harmony';
    const changeUpperKey = trigramKeys[changeUpperIdx] || 'kun';
    const changeUpperExplanation = wuxingExplanations.change_upper?.[changeUpperRelationKey]?.details?.[changeUpperKey] || { description: '無解釋' };

    const changeLowerRelation = getRelation(tiGua.wuxing, changeLowerGua.wuxing);
    const changeLowerRelationKey = relationMap[changeLowerRelation] || 'harmony';
    const changeLowerKey = trigramKeys[changeLowerIdx] || 'kun';
    const changeLowerExplanation = wuxingExplanations.change_lower?.[changeLowerRelationKey]?.details?.[changeLowerKey] || { description: '無解釋' };

    const totalRelationScore = [
      mainRelation, huUpperRelation, huLowerRelation,
      changeUpperRelation, changeLowerRelation
    ].reduce((sum, relation) => sum + getRelationScore(relation), 0);
    const wuxingScores = [
      getWuxingStatusScore(mainUpperGua.wuxing, lunarMonthNumber),
      getWuxingStatusScore(mainLowerGua.wuxing, lunarMonthNumber),
      getWuxingStatusScore(huUpperGua.wuxing, lunarMonthNumber),
      getWuxingStatusScore(huLowerGua.wuxing, lunarMonthNumber),
      getWuxingStatusScore(changeUpperGua.wuxing, lunarMonthNumber),
      getWuxingStatusScore(changeLowerGua.wuxing, lunarMonthNumber)
    ];
    const totalWuxingScore = wuxingScores.reduce((sum, score) => sum + score, 0);
    const auspiciousnessScore = clamp((totalRelationScore + totalWuxingScore + 60) / 12);
    let combinedResultKey;
    if (auspiciousnessScore >= 8) combinedResultKey = 'auspicious';
    else if (auspiciousnessScore >= 6) combinedResultKey = 'moderately_auspicious';
    else if (auspiciousnessScore >= 4) combinedResultKey = 'neutral';
    else if (auspiciousnessScore >= 2) combinedResultKey = 'moderately_inauspicious';
    else combinedResultKey = 'inauspicious';
    const combinedExplanation = wuxingExplanations.combined?.[combinedResultKey]?.details ||'無綜合說明';

    const wuxingAnalysis = document.getElementById('wuxingAnalysis');
    if (!wuxingAnalysis) {
      console.error('找不到 wuxingAnalysis 元素');
      alert('無法顯示五行分析，請檢查頁面結構！');
      return;
    }

    wuxingAnalysis.innerHTML = `
      <svg id="wuxingSvg" width="600" height="400"></svg>
      <div class="wuxing-box">
        <h4>本卦現況</h4>
        <p><strong>整體：</strong> <span id="mainOverall">${mainOverall}</span></p>
        <p><strong>描述：</strong> <span id="mainDescription">${mainExplanation.description}</span></p>
        <p><strong>愛情：</strong> <span id="mainLove">${mainExplanation.love}</span></p>
        <p><strong>事業：</strong> <span id="mainCareer">${mainExplanation.career}</span></p>
        <p><strong>財運：</strong> <span id="mainWealth">${mainExplanation.wealth}</span></p>
        <p><strong>健康：</strong> <span id="mainHealth">${mainExplanation.health}</span></p>
        <p><strong>人際：</strong> <span id="mainRelationship">${mainExplanation.relationship}</span></p>
        <p><strong>生活：</strong> <span id="mainLife">${mainExplanation.life}</span></p>
        <p><strong>建議：</strong> <span id="mainGuidance">${mainExplanation.guidance}${mainRemedy ? `<br><strong>化解：</strong> ${mainRemedy}` : ''}</span></p>
      </div>
      <div class="wuxing-box">
        <h4>互卦外在過程（上卦）</h4>
        <p><strong>整體：</strong> <span id="huUpperOverall">${wuxingExplanations.hu_upper?.[huUpperRelationKey]?.overall || '無說明'}</span></p>
        <p><strong>描述：</strong> <span id="huUpperDescription">${huUpperExplanation.description}</span></p>
      </div>
      <div class="wuxing-box">
        <h4>互卦內在過程（下卦）</h4>
        <p><strong>整體：</strong> <span id="huLowerOverall">${wuxingExplanations.hu_lower?.[huLowerRelationKey]?.overall || '無說明'}</span></p>
        <p><strong>描述：</strong> <span id="huLowerDescription">${huLowerExplanation.description}</span></p>
      </div>
      <div class="wuxing-box">
        <h4>變卦未來趨勢（上卦）</h4>
        <p><strong>整體：</strong> <span id="changeUpperOverall">${wuxingExplanations.change_upper?.[changeUpperRelationKey]?.overall || '無說明'}</span></p>
        <p><strong>描述：</strong> <span id="changeUpperDescription">${changeUpperExplanation.description}</span></p>
      </div>
      <div class="wuxing-box">
        <h4>變卦變化基礎（下卦）</h4>
        <p><strong>整體：</strong> <span id="changeLowerOverall">${wuxingExplanations.change_lower?.[changeLowerRelationKey]?.overall || '無說明'}</span></p>
        <p><strong>描述：</strong> <span id="changeLowerDescription">${changeLowerExplanation.description}</span></p>
      </div>
      <div class="wuxing-box">
        <h4>綜合吉凶</h4>
        <p><strong>結果：</strong> <span id="combinedResult">${combinedExplanation}</span></p>
      </div>
      <div id="auspiciousnessBar" class="auspiciousness-bar">
        <div style="width: ${auspiciousnessScore * 10}%; height: 100%; background: ${auspiciousnessScore >= 7 ? 'var(--positive-color)' : auspiciousnessScore <= 3 ? 'var(--negative-color)' : 'var(--secondary-color)'};"></div>
      </div>
      <p id="auspiciousnessIndex">吉凶指數：${auspiciousnessScore.toFixed(1)}</p>
    `;

    renderWuxingDiagram(tiGua, mainUpperGua, mainLowerGua, huUpperGua, huLowerGua, changeUpperGua, changeLowerGua, lunarMonth, season, lunarMonthNumber);
    console.log('五行分析更新:', { mainRelation, auspiciousnessScore, combinedResultKey });
  }

  function renderDetailedAnalysis(result) {
    const detailedAnalysis = document.getElementById('detailedAnalysis');
    if (!detailedAnalysis) {
      console.error('找不到 detailedAnalysis 元素');
      return;
    }
    detailedAnalysis.innerHTML = '';

    const { hexMain, hexChange, moving } = result;
    if (!hexMain || !hexMain.judgment || !hexChange || !hexChange.judgment) {
      detailedAnalysis.innerHTML = '<p>無詳細分析數據</p>';
      console.warn('缺少詳細分析數據');
      return;
    }

    const aspectsList = document.createElement('div');
    aspectsList.className = 'aspects-list';
    ASPECTS.forEach(aspect => {
      const score = hexMain.judgment[aspect.k] || 5;
      const changeScore = hexChange.judgment[aspect.k] || 5;
      const diff = clamp(changeScore - score);
      let diffText = '';
      if (diff > 0) diffText = `（較本卦 +${diff}）`;
      else if (diff < 0) diffText = `（較本卦 ${diff}）`;
      aspectsList.innerHTML += `
        <div class="aspect-item">
          <p><strong>${aspect.label}：</strong> ${score}/10 ${diffText}</p>
        </div>
      `;
    });
    detailedAnalysis.appendChild(aspectsList);

    const movingLines = document.createElement('div');
    movingLines.className = 'moving-lines';
    if (moving.length === 0) {
      movingLines.innerHTML = '<p>無動爻</p>';
    } else {
      moving.forEach(lineIdx => {
        const lineEntry = getLineEntryFor(hexMain, lineIdx);
        movingLines.innerHTML += `
          <div class="line-explanation">
            <p><strong>第 ${lineIdx} 爻：</strong> ${lineEntry.text || '無爻辭'}</p>
            <p><strong>解釋：</strong> ${lineEntry.meaning || '無解釋'}</p>
            <p><strong>評分：</strong> ${lineEntry.score || 5}</p>
          </div>
        `;
      });
    }
    detailedAnalysis.appendChild(movingLines);
  }

  document.addEventListener('DOMContentLoaded', async () => {
    console.log('DOMContentLoaded 事件觸發');
    await loadResources();
    loadHistory();

    const methodSelect = document.getElementById('methodSelect');
    const methodForms = {
      number: document.getElementById('numberForm'),
      randomNumber: document.getElementById('randomNumberForm'),
      manual: document.getElementById('manualForm'),
      timeModern: document.getElementById('timeForm'),
      timeTraditional: document.getElementById('traditionalTimeForm'),
      image: document.getElementById('imageForm')
    };

    if (!methodSelect || Object.values(methodForms).some(form => !form)) {
      console.error('找不到 methodSelect 或表單元素');
      alert('頁面元素載入錯誤，請檢查 HTML 結構！');
      return;
    }

    methodSelect.addEventListener('change', () => {
      Object.values(methodForms).forEach(form => form.classList.add('hidden'));
      const selectedForm = methodForms[methodSelect.value];
      if (selectedForm) {
        selectedForm.classList.remove('hidden');
      }
    });

    // 數字取卦
    const btnNumber = document.getElementById('btnNumber');
    if (btnNumber) {
      btnNumber.addEventListener('click', () => {
        console.log('數字取卦按鈕點擊');
        const numberInput = document.getElementById('numberInput');
        const number = parseInt(numberInput?.value);
        if (isNaN(number) || number < 100 || number > 999) {
          alert('請輸入 100 到 999 之間的數字！');
          console.warn('無效的數字輸入:', numberInput?.value);
          return;
        }
        const upper = Math.floor(number / 100) % 8 || 8;
        const lower = (number % 100) % 8 || 8;
        const moving = [(number % 6) || 6];
        generateGua(upper, lower, moving, '數字取卦');
        renderWuxingAnalysis(currentResult);
        renderDetailedAnalysis(currentResult);
      });
    } else {
      console.error('找不到 btnNumber 元素');
    }

    // 數字亂數取卦
    const btnRandomNumber = document.getElementById('btnRandomNumber');
    if (btnRandomNumber) {
      btnRandomNumber.addEventListener('click', () => {
        console.log('數字亂數取卦按鈕點擊');
        const number = Math.floor(Math.random() * 900) + 100;
        const upper = Math.floor(number / 100) % 8 || 8;
        const lower = (number % 100) % 8 || 8;
        const moving = [(number % 6) || 6];
        generateGua(upper, lower, moving, '數字亂數取卦');
        renderWuxingAnalysis(currentResult);
        renderDetailedAnalysis(currentResult);
        const numberInput = document.getElementById('numberInput');
        if (numberInput) numberInput.value = number;
      });
    } else {
      console.error('找不到 btnRandomNumber 元素');
    }

    // 手動取卦
    const btnManual = document.getElementById('btnManual');
    if (btnManual) {
      btnManual.addEventListener('click', () => {
        console.log('手動取卦按鈕點擊');
        const lines = Array.from(document.querySelectorAll('#manualLines input')).map(input => parseInt(input.value));
        if (lines.length !== 6 || lines.some(l => l !== 0 && l !== 1)) {
          alert('請輸入正確的六條陰陽線（0 或 1）！');
          console.warn('無效的手動卦象輸入:', lines);
          return;
        }
        const upperLines = lines.slice(3, 6);
        const lowerLines = lines.slice(0, 3);
        const upperIdx = triIndexByLines.get(JSON.stringify(upperLines)) || 8;
        const lowerIdx = triIndexByLines.get(JSON.stringify(lowerLines)) || 8;
        const movingInputs = document.querySelectorAll('#manualMoving input');
        const moving = Array.from(movingInputs)
          .map((input, idx) => input.checked ? idx + 1 : null)
          .filter(idx => idx !== null);
        generateGua(upperIdx, lowerIdx, moving, '手動取卦');
        renderWuxingAnalysis(currentResult);
        renderDetailedAnalysis(currentResult);
      });
    } else {
      console.error('找不到 btnManual 元素');
    }

    // 現代時間取卦
    const btnTime = document.getElementById('btnTime');
    if (btnTime) {
      btnTime.addEventListener('click', () => {
        console.log('現代時間取卦按鈕點擊');
        const timeInput = document.getElementById('timeInput');
        const date = timeInput?.value ? new Date(timeInput.value) : new Date();
        if (isNaN(date.getTime())) {
          alert('請輸入有效的日期時間！');
          console.warn('無效的時間輸入:', timeInput?.value);
          return;
        }
        const year = date.getFullYear();
        const month = date.getMonth() + 1;
        const day = date.getDate();
        const hour = date.getHours();
        const minute = date.getMinutes();
        const upper = (year + month + day) % 8 || 8;
        const lower = (month + day + hour) % 8 || 8;
        const moving = [(day + hour + minute) % 6 || 6];
        generateGua(upper, lower, moving, '現代時間取卦', date.toLocaleString('zh-TW'));
        renderWuxingAnalysis(currentResult);
        renderDetailedAnalysis(currentResult);
      });
    } else {
      console.error('找不到 btnTime 元素');
    }

    // 傳統時辰取卦
    const btnTraditionalTime = document.getElementById('btnTraditionalTime');
    if (btnTraditionalTime) {
      btnTraditionalTime.addEventListener('click', () => {
        console.log('傳統時辰取卦按鈕點擊');
        const lunarMonthInput = document.getElementById('lunarMonthInput');
        const lunarDayInput = document.getElementById('lunarDayInput');
        const hourSelect = document.getElementById('hourSelect');
        const lunarMonth = parseInt(lunarMonthInput?.value);
        const lunarDay = parseInt(lunarDayInput?.value);
        const hourIdx = parseInt(hourSelect?.value);
        if (isNaN(lunarMonth) || lunarMonth < 1 || lunarMonth > 12 ||
            isNaN(lunarDay) || lunarDay < 1 || lunarDay > 30 ||
            isNaN(hourIdx) || hourIdx < 1 || hourIdx > 12) {
          alert('請輸入有效的農曆月份（1-12）、日期（1-30）和時辰（1-12）！');
          console.warn('無效的傳統時辰輸入:', { lunarMonth, lunarDay, hourIdx });
          return;
        }
        const upper = (lunarMonth + lunarDay + hourIdx) % 8 || 8;
        const lower = (lunarDay + hourIdx) % 8 || 8;
        const moving = [(lunarDay + hourIdx) % 6 || 6];
        const timestamp = new Date(); // 簡化為當前時間，可改進
        generateGua(upper, lower, moving, '傳統時辰取卦', timestamp.toLocaleString('zh-TW'));
        renderWuxingAnalysis(currentResult);
        renderDetailedAnalysis(currentResult);
      });
    } else {
      console.error('找不到 btnTraditionalTime 元素');
    }

    // 以象取卦
    const btnImage = document.getElementById('btnImage');
    if (btnImage) {
      btnImage.addEventListener('click', () => {
        console.log('以象取卦按鈕點擊');
        const upperSelect = document.getElementById('upperGuaSelect');
        const lowerSelect = document.getElementById('lowerGuaSelect');
        const movingSelect = document.getElementById('movingLineSelect');
        const upperIdx = parseInt(upperSelect?.value);
        const lowerIdx = parseInt(lowerSelect?.value);
        const movingIdx = parseInt(movingSelect?.value);
        if (isNaN(upperIdx) || isNaN(lowerIdx) || upperIdx < 1 || upperIdx > 8 || lowerIdx < 1 || lowerIdx > 8) {
          alert('請選擇有效的上卦和下卦！');
          console.warn('無效的以象取卦輸入:', { upperIdx, lowerIdx });
          return;
        }
        const moving = movingIdx >= 1 && movingIdx <= 6 ? [movingIdx] : [];
        generateGua(upperIdx, lowerIdx, moving, '以象取卦');
        renderWuxingAnalysis(currentResult);
        renderDetailedAnalysis(currentResult);
      });
    } else {
      console.error('找不到 btnImage 元素');
    }

    // 匯出歷史記錄
    const exportBtn = document.getElementById('exportBtn');
    if (exportBtn) {
      exportBtn.addEventListener('click', exportHistory);
    } else {
      console.error('找不到 exportBtn 元素');
    }

    // 匯入歷史記錄
    const importInput = document.getElementById('importInput');
    if (importInput) {
      importInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
          importHistory(file);
          e.target.value = ''; // 重置輸入
        }
      });
    } else {
      console.error('找不到 importInput 元素');
    }

    // 下載 SVG
    const downloadSvgBtn = document.getElementById('downloadSvgBtn');
    if (downloadSvgBtn) {
      downloadSvgBtn.addEventListener('click', downloadSvg);
    } else {
      console.error('找不到 downloadSvgBtn 元素');
    }

    // 在新視窗開啟 SVG
    const openSvgBtn = document.getElementById('openSvgBtn');
    if (openSvgBtn) {
      openSvgBtn.addEventListener('click', openSvgInNewWindow);
    } else {
      console.error('找不到 openSvgBtn 元素');
    }

    // 初始化表單顯示
    methodSelect.dispatchEvent(new Event('change'));
  });
});
</script>

</body>
</html>
