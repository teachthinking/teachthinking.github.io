<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>梅花易數占卜</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    :root {
      --primary-color: #2c3e50;
      --secondary-color: #f1c40f;
      --positive-color: #27ae60;
      --negative-color: #c0392b;
      --card-bg: #f5f5f5;
      --border-color: #ddd;
      --border-radius: 8px;
      --text-color: #333;
    }

    body {
      font-family: 'Noto Sans TC', sans-serif;
      margin: 0;
      padding: 20px;
      background: #f0f2f5;
      color: var(--text-color);
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
    }

    h1, h2, h3, h4 {
      color: var(--primary-color);
    }

    .subtitle {
      font-style: italic;
      color: #666;
      margin-bottom: 20px;
    }

    .form-group {
      margin-bottom: 15px;
    }

    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }

    .form-group input, .form-group select {
      width: 100%;
      padding: 8px;
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius);
      font-size: 16px;
    }

    .primary {
      background: var(--primary-color);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: var(--border-radius);
      cursor: pointer;
      font-size: 16px;
    }

    .primary:hover {
      background: #34495e;
    }

    .gua-box {
      margin: 20px 0;
      padding: 15px;
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius);
    }

    .wuxing-box {
      margin: 20px 0;
      padding: 15px;
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius);
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      max-width: 600px;
    }

    .wuxing-controls {
      margin-top: 10px;
      display: flex;
      gap: 10px;
    }

    #wuxingSvg {
      display: block;
      margin: 0 auto;
    }

    .wuxing-node {
      fill: none;
      stroke: var(--primary-color);
      stroke-width: 2;
    }

    .wuxing-node:hover {
      fill: #d5e8f9;
      cursor: pointer;
    }

    .wuxing-edge-generate {
      stroke: var(--positive-color);
      stroke-width: 2;
    }

    .wuxing-edge-overcome {
      stroke: var(--negative-color);
      stroke-width: 2;
    }

    .wuxing-edge-harmony {
      stroke: var(--secondary-color);
      stroke-width: 2;
    }

    .wuxing-node-text, .wuxing-edge-label {
      font-size: 14px;
      text-anchor: middle;
      fill: var(--text-color);
    }

    .auspiciousness-bar {
      width: 100%;
      height: 10px;
      background: #e0e0e0;
      border-radius: 5px;
      overflow: hidden;
    }

    .auspiciousness-bar > div {
      height: 100%;
      transition: width 0.5s ease;
    }

    .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>梅花易數占卜</h1>
    <p id="subtitle">請選擇取卦方式以開始占卜</p>

    <div class="form-group">
      <label for="methodSelect">取卦方式</label>
      <select id="methodSelect" aria-label="選擇取卦方式">
        <option value="number">數字取卦</option>
        <option value="randomNumber">隨機數字</option>
        <option value="manual">手動取卦</option>
        <option value="time">時間取卦</option>
        <option value="image">以象取卦</option>
      </select>
    </div>

    <div id="numberForm" class="form-group hidden">
      <label for="numUpper">上卦數字 (100-999)</label>
      <input id="numUpper" type="number" min="100" max="999" aria-label="上卦數字 (100-999)" required>
      <label for="numLower">下卦數字 (100-999)</label>
      <input id="numLower" type="number" min="100" max="999" aria-label="下卦數字 (100-999)" required>
      <label for="numMoving">動爻數字 (100-999)</label>
      <input id="numMoving" type="number" min="100" max="999" aria-label="動爻數字 (100-999)" required>
      <button id="btnNumber" class="primary" aria-label="進行數字取卦">數字取卦</button>
    </div>

    <div id="randomNumberForm" class="form-group hidden">
      <button id="btnRandomNumber" class="primary" aria-label="進行隨機數字取卦">隨機數字取卦</button>
    </div>

    <div id="manualForm" class="form-group hidden">
      <label for="upperGuaSelect">上卦</label>
      <select id="upperGuaSelect" aria-label="選擇上卦">
        <option value="1">乾 ☰</option>
        <option value="2">兌 ☱</option>
        <option value="3">離 ☲</option>
        <option value="4">震 ☳</option>
        <option value="5">巽 ☴</option>
        <option value="6">坎 ☵</option>
        <option value="7">艮 ☶</option>
        <option value="8">坤 ☷</option>
      </select>
      <label for="lowerGuaSelect">下卦</label>
      <select id="lowerGuaSelect" aria-label="選擇下卦">
        <option value="1">乾 ☰</option>
        <option value="2">兌 ☱</option>
        <option value="3">離 ☲</option>
        <option value="4">震 ☳</option>
        <option value="5">巽 ☴</option>
        <option value="6">坎 ☵</option>
        <option value="7">艮 ☶</option>
        <option value="8">坤 ☷</option>
      </select>
      <label for="movingLineSelect">動爻</label>
      <select id="movingLineSelect" aria-label="選擇動爻">
        <option value="1">初爻</option>
        <option value="2">二爻</option>
        <option value="3">三爻</option>
        <option value="4">四爻</option>
        <option value="5">五爻</option>
        <option value="6">上爻</option>
      </select>
      <button id="btnManual" class="primary" aria-label="進行手動取卦">手動取卦</button>
    </div>

    <div id="timeForm" class="form-group hidden">
      <button id="btnTime" class="primary" aria-label="進行時間取卦">時間取卦</button>
    </div>

    <div id="imageForm" class="form-group hidden">
      <label for="imageInput">輸入象徵描述</label>
      <textarea id="imageInput" rows="4" aria-label="輸入象徵描述" placeholder="描述您看到的景象或物品"></textarea>
      <button id="btnImage" class="primary" aria-label="進行以象取卦">以象取卦</button>
    </div>

    <div id="judgeBox" class="gua-box hidden">
      <h3 id="judgeTitle">五行與象徵</h3>
      <div class="auspiciousness-index">
        <span id="auspiciousnessIndex">吉凶指數：未計算</span>
        <div id="auspiciousnessBar" class="auspiciousness-bar">
          <div style="width: 0%; height: 100%; background: var(--secondary-color);"></div>
        </div>
      </div>
      <div class="wuxing-controls">
        <button id="downloadSvgBtn" class="primary" aria-label="下載五行圖表">下載圖表</button>
        <button id="openSvgWindowBtn" class="primary" aria-label="在新視窗顯示五行圖">在新視窗查看</button>
      </div>
      <div id="wuxingAnalysis">
        <svg id="wuxingSvg" width="600" height="400" aria-label="五行生克圖"></svg>
        <div class="wuxing-box">
          <h4>本卦現況</h4>
          <p><strong>整體：</strong> <span id="mainOverall"></span></p>
          <p><strong>描述：</strong> <span id="mainDescription"></span></p>
          <p><strong>愛情：</strong> <span id="mainLove"></span></p>
          <p><strong>事業：</strong> <span id="mainCareer"></span></p>
          <p><strong>財運：</strong> <span id="mainWealth"></span></p>
          <p><strong>健康：</strong> <span id="mainHealth"></span></p>
          <p><strong>人際：</strong> <span id="mainRelationship"></span></p>
          <p><strong>生活：</strong> <span id="mainLife"></span></p>
          <p><strong>建議：</strong> <span id="mainGuidance"></span></p>
        </div>
        <div class="wuxing-box">
          <h4>互卦上</h4>
          <p><strong>整體：</strong> <span id="huUpperOverall"></span></p>
          <p><strong>描述：</strong> <span id="huUpperDescription"></span></p>
          <p><strong>愛情：</strong> <span id="huUpperLove"></span></p>
          <p><strong>事業：</strong> <span id="huUpperCareer"></span></p>
          <p><strong>財運：</strong> <span id="huUpperWealth"></span></p>
          <p><strong>健康：</strong> <span id="huUpperHealth"></span></p>
          <p><strong>人際：</strong> <span id="huUpperRelationship"></span></p>
          <p><strong>生活：</strong> <span id="huUpperLife"></span></p>
          <p><strong>建議：</strong> <span id="huUpperGuidance"></span></p>
        </div>
        <div class="wuxing-box">
          <h4>互卦下</h4>
          <p><strong>整體：</strong> <span id="huLowerOverall"></span></p>
          <p><strong>描述：</strong> <span id="huLowerDescription"></span></p>
          <p><strong>愛情：</strong> <span id="huLowerLove"></span></p>
          <p><strong>事業：</strong> <span id="huLowerCareer"></span></p>
          <p><strong>財運：</strong> <span id="huLowerWealth"></span></p>
          <p><strong>健康：</strong> <span id="huLowerHealth"></span></p>
          <p><strong>人際：</strong> <span id="huLowerRelationship"></span></p>
          <p><strong>生活：</strong> <span id="huLowerLife"></span></p>
          <p><strong>建議：</strong> <span id="huLowerGuidance"></span></p>
        </div>
        <div class="wuxing-box">
          <h4>變卦上</h4>
          <p><strong>整體：</strong> <span id="changeUpperOverall"></span></p>
          <p><strong>描述：</strong> <span id="changeUpperDescription"></span></p>
          <p><strong>愛情：</strong> <span id="changeUpperLove"></span></p>
          <p><strong>事業：</strong> <span id="changeUpperCareer"></span></p>
          <p><strong>財運：</strong> <span id="changeUpperWealth"></span></p>
          <p><strong>健康：</strong> <span id="changeUpperHealth"></span></p>
          <p><strong>人際：</strong> <span id="changeUpperRelationship"></span></p>
          <p><strong>生活：</strong> <span id="changeUpperLife"></span></p>
          <p><strong>建議：</strong> <span id="changeUpperGuidance"></span></p>
        </div>
        <div class="wuxing-box">
          <h4>變卦下</h4>
          <p><strong>整體：</strong> <span id="changeLowerOverall"></span></p>
          <p><strong>描述：</strong> <span id="changeLowerDescription"></span></p>
          <p><strong>愛情：</strong> <span id="changeLowerLove"></span></p>
          <p><strong>事業：</strong> <span id="changeLowerCareer"></span></p>
          <p><strong>財運：</strong> <span id="changeLowerWealth"></span></p>
          <p><strong>健康：</strong> <span id="changeLowerHealth"></span></p>
          <p><strong>人際：</strong> <span id="changeLowerRelationship"></span></p>
          <p><strong>生活：</strong> <span id="changeLowerLife"></span></p>
          <p><strong>建議：</strong> <span id="changeLowerGuidance"></span></p>
        </div>
      </div>
    </div>

    <div id="historyBox" class="gua-box hidden">
      <h3>歷史記錄</h3>
      <ul id="historyList"></ul>
      <button id="exportBtn" class="primary" aria-label="匯出歷史記錄">匯出</button>
      <input id="importInput" type="file" accept=".json" aria-label="匯入歷史記錄" style="display: none;">
      <button id="importBtn" class="primary" aria-label="匯入歷史記錄">匯入</button>
    </div>
  </div>

  <script>
    let hexagrams = {};
    let quotes = [];
    let wuxingExplanations = {};
    let currentResult = null;
    const history = [];

    const trigramKeys = {
      1: 'qian', 2: 'dui', 3: 'li', 4: 'zhen', 5: 'xun', 6: 'kan', 7: 'gen', 8: 'kun'
    };

    const guaTable = {
      1: { name: '乾', wuxing: '金', lines: [1, 1, 1] },
      2: { name: '兌', wuxing: '金', lines: [0, 1, 1] },
      3: { name: '離', wuxing: '火', lines: [1, 0, 1] },
      4: { name: '震', wuxing: '木', lines: [1, 0, 0] },
      5: { name: '巽', wuxing: '木', lines: [0, 1, 0] },
      6: { name: '坎', wuxing: '水', lines: [0, 1, 0] },
      7: { name: '艮', wuxing: '土', lines: [0, 0, 1] },
      8: { name: '坤', wuxing: '土', lines: [0, 0, 0] }
    };

    const hexagramNameMap = new Map([
      ['111111', '乾為天'], ['000000', '坤為地'], ['101000', '水雷屯'], ['001010', '山水蒙'],
      // ... 其他 60 卦（簡化展示）
      ['010101', '火水未濟']
    ]);

    const ASPECTS = ['people', 'affairs', 'time', 'place', 'object'];

    const defaultWuxingDetails = {
      description: '無具體解釋，請參考卦象整體意義',
      love: '感情平穩，需謹慎溝通',
      career: '事業穩定，宜穩中求進',
      wealth: '財運普通，注意理財規劃',
      health: '健康無大礙，保持規律生活',
      relationship: '人際關係和諧，宜多交流',
      life: '生活平穩，無重大變化',
      guidance: '保持現狀，謹慎行事'
    };

    function normalizeKey(str) {
      return str.replace(/[^a-zA-Z0-9]/g, '').toLowerCase();
    }

    async function loadResources() {
      try {
        const [hexResponse, quotesResponse, wuxingResponse] = await Promise.all([
          fetch('hexagrams.json').then(res => res.ok ? res.json() : Promise.reject(`hexagrams.json 載入失敗: ${res.status}`)),
          fetch('quotes.json').then(res => res.ok ? res.json() : Promise.reject(`quotes.json 載入失敗: ${res.status}`)),
          fetch('wuxing_explanations.json').then(res => res.ok ? res.json() : Promise.reject(`wuxing_explanations.json 載入失敗: ${res.status}`))
        ]);

        hexagrams = Object.fromEntries(
          Object.entries(hexResponse).map(([key, value]) => [normalizeKey(key), {
            name: value.name || key,
            judgment: value.judgment || { text: '無卦辭', meaning: '無解釋', people: 5, affairs: 5, time: 5, place: 5, object: 5 },
            symbolism: value.symbolism || { overall: '無象徵說明', people: 5, affairs: 5, time: 5, place: 5, object: 5 },
            lines: value.lines || []
          }])
        );

        for (const [lines, name] of hexagramNameMap) {
          const key = normalizeKey(name);
          if (!hexagrams[key]) {
            hexagrams[key] = {
              name,
              judgment: { text: '無卦辭', meaning: '無解釋', people: 5, affairs: 5, time: 5, place: 5, object: 5 },
              symbolism: { overall: '無象徵說明', people: 5, affairs: 5, time: 5, place: 5, object: 5 },
              lines: []
            };
            console.warn(`卦象 ${name} 缺失，使用預設數據`);
          }
        }

        quotes = Array.isArray(quotesResponse) && quotesResponse.length > 0 ? quotesResponse : ['易經占卜，探究天人之道'];

        wuxingExplanations = wuxingResponse.relations || {
          main: {
            harmony: { overall: '無說明', details: { kun: defaultWuxingDetails } },
            generate_ti: { overall: '無說明', details: { kun: defaultWuxingDetails } },
            ti_generate_yong: { overall: '無說明', details: { kun: defaultWuxingDetails } },
            yong_overcome_ti: { overall: '無說明', details: { kun: defaultWuxingDetails } },
            ti_overcome_yong: { overall: '無說明', details: { kun: defaultWuxingDetails } }
          },
          hu_upper: { harmony: { overall: '無說明', details: { kun: defaultWuxingDetails } } },
          hu_lower: { harmony: { overall: '無說明', details: { kun: defaultWuxingDetails } } },
          change_upper: { harmony: { overall: '無說明', details: { kun: defaultWuxingDetails } } },
          change_lower: { harmony: { overall: '無說明', details: { kun: defaultWuxingDetails } } },
          combined: {
            auspicious: { details: '無綜合說明' },
            moderately_auspicious: { details: '無綜合說明' },
            neutral: { details: '無綜合說明' },
            moderately_inauspicious: { details: '無綜合說明' },
            inauspicious: { details: '無綜合說明' }
          }
        };

        document.getElementById('subtitle').textContent = quotes[Math.floor(Math.random() * quotes.length)];
      } catch (error) {
        console.error('載入 JSON 檔案失敗:', error);
        alert('無法載入資料，請檢查檔案路徑或格式！使用預設數據。');
      }
    }

    function getTrigramInfo(idx) {
      return guaTable[idx] || { name: '未知', wuxing: '無', lines: [0, 0, 0], id: idx };
    }

    function getHexagramLines(uIdx, lIdx) {
      const upper = getTrigramInfo(uIdx).lines;
      const lower = getTrigramInfo(lIdx).lines;
      return [...upper, ...lower].join('');
    }

    function getTiYong(result) {
      const { uIdx, lIdx, moving } = result;
      return { tiGua: getTrigramInfo(uIdx), yongGua: getTrigramInfo(lIdx) };
    }

    function getRelation(wuxing1, wuxing2) {
      const generate = { 木: '火', 火: '土', 土: '金', 金: '水', 水: '木' };
      const overcome = { 木: '土', 火: '金', 土: '水', 金: '木', 水: '火' };
      if (wuxing1 === wuxing2) return 'harmony';
      if (generate[wuxing1] === wuxing2) return 'ti_generate_yong';
      if (generate[wuxing2] === wuxing1) return 'generate_ti';
      if (overcome[wuxing1] === wuxing2) return 'ti_overcome_yong';
      if (overcome[wuxing2] === wuxing1) return 'yong_overcome_ti';
      return 'harmony';
    }

    function getWuxingStatus(wuxing, lunarMonthNumber) {
      const seasonMap = {
        1: '木', 2: '木', 3: '木', 4: '火', 5: '火', 6: '火',
        7: '金', 8: '金', 9: '金', 10: '水', 11: '水', 12: '水'
      };
      const season = seasonMap[lunarMonthNumber] || '土';
      const generate = { 木: '火', 火: '土', 土: '金', 金: '水', 水: '木' };
      const overcome = { 木: '土', 火: '金', 土: '水', 金: '木', 水: '火' };
      if (wuxing === season) return '旺';
      if (generate[season] === wuxing) return '相';
      if (overcome[season] === wuxing) return '死';
      if (generate[wuxing] === season) return '休';
      return '囚';
    }

    function getWuxingStrength(status) {
      const strengths = { 旺: 4, 相: 3, 休: 2, 囚: 1, 死: 0.5 };
      return strengths[status] || 2;
    }

    function calculateAuspiciousnessScore(result, lunarMonthNumber) {
      const { uIdx, lIdx, moving } = result;
      const hexMain = hexagrams[normalizeKey(hexagramNameMap.get(getHexagramLines(uIdx, lIdx)))];
      const { tiGua, yongGua } = getTiYong(result);
      const relation = getRelation(yongGua.wuxing, tiGua.wuxing);
      let score = (hexMain.judgment.people + hexMain.judgment.affairs + hexMain.judgment.time + hexMain.judgment.place + hexMain.judgment.object) / 5;
      if (hexMain.judgment.people === 5 && hexMain.judgment.affairs === 5) {
        console.warn(`卦象 ${hexMain.name} 使用預設評分，可能影響吉凶指數`);
      }
      const tiStatus = getWuxingStatus(tiGua.wuxing, lunarMonthNumber);
      const modifiers = {
        harmony: 0, generate_ti: 2, ti_generate_yong: -1, yong_overcome_ti: -2, ti_overcome_yong: 1,
        旺: 1, 相: 0.5, 休: 0, 囚: -0.5, 死: -1
      };
      score += (modifiers[relation] || 0) + (modifiers[tiStatus] || 0);
      return Math.min(Math.max(score, 0), 10);
    }

    function generateGua(uIdx, lIdx, moving, method, question = '') {
      const hexMain = hexagrams[normalizeKey(hexagramNameMap.get(getHexagramLines(uIdx, lIdx)))];
      if (!hexMain) {
        console.error(`無效卦象: 上卦 ${uIdx}, 下卦 ${lIdx}`);
        alert('無法生成卦象，請檢查輸入！');
        return;
      }
      currentResult = { uIdx, lIdx, moving, method, question, timestamp: new Date().toISOString() };
      history.push(currentResult);
      localStorage.setItem('history', JSON.stringify(history));
      updateHistoryList();
    }

    function renderWuxingAnalysis(result) {
      if (!result) {
        console.error('無有效結果數據');
        alert('請先進行占卜以生成卦象！');
        return;
      }

      const { uIdx, lIdx, moving, method, question } = result;
      const hexMain = hexagrams[normalizeKey(hexagramNameMap.get(getHexagramLines(uIdx, lIdx)))];
      const mainUpperGua = getTrigramInfo(uIdx);
      const mainLowerGua = getTrigramInfo(lIdx);
      const { tiGua, yongGua } = getTiYong(result);
      const timestamp = new Date(result.timestamp || '2025-08-27T00:55:00+08:00');
      const { lunarMonth, season, lunarMonthNumber } = lunarCalendar.gregorianToLunar(timestamp);

      const mainRelation = getRelation(yongGua.wuxing, tiGua.wuxing);
      const mainDetails = wuxingExplanations.main[mainRelation].details[trigramKeys[tiGua.id]] || defaultWuxingDetails;
      const huUpperDetails = wuxingExplanations.hu_upper.harmony.details[trigramKeys[mainUpperGua.id]] || defaultWuxingDetails;
      const huLowerDetails = wuxingExplanations.hu_lower.harmony.details[trigramKeys[mainLowerGua.id]] || defaultWuxingDetails;
      const changeUpperDetails = wuxingExplanations.change_upper.harmony.details[trigramKeys[mainUpperGua.id]] || defaultWuxingDetails;
      const changeLowerDetails = wuxingExplanations.change_lower.harmony.details[trigramKeys[mainLowerGua.id]] || defaultWuxingDetails;

      let html = `
        <svg id="wuxingSvg" width="600" height="400" aria-label="五行生克圖"></svg>
        <div class="wuxing-box">
          <h4>本卦現況</h4>
          <p><strong>整體：</strong> <span id="mainOverall">${mainDetails.title || '無標題'}</span></p>
          <p><strong>描述：</strong> <span id="mainDescription">${mainDetails.description}</span></p>
          <p><strong>愛情：</strong> <span id="mainLove">${mainDetails.love}</span></p>
          <p><strong>事業：</strong> <span id="mainCareer">${mainDetails.career}</span></p>
          <p><strong>財運：</strong> <span id="mainWealth">${mainDetails.wealth}</span></p>
          <p><strong>健康：</strong> <span id="mainHealth">${mainDetails.health}</span></p>
          <p><strong>人際：</strong> <span id="mainRelationship">${mainDetails.relationship}</span></p>
          <p><strong>生活：</strong> <span id="mainLife">${mainDetails.life}</span></p>
          <p><strong>建議：</strong> <span id="mainGuidance">${mainDetails.guidance}</span></p>
        </div>
        <div class="wuxing-box">
          <h4>互卦上</h4>
          <p><strong>整體：</strong> <span id="huUpperOverall">${huUpperDetails.title || '無標題'}</span></p>
          <p><strong>描述：</strong> <span id="huUpperDescription">${huUpperDetails.description}</span></p>
          <p><strong>愛情：</strong> <span id="huUpperLove">${huUpperDetails.love}</span></p>
          <p><strong>事業：</strong> <span id="huUpperCareer">${huUpperDetails.career}</span></p>
          <p><strong>財運：</strong> <span id="huUpperWealth">${huUpperDetails.wealth}</span></p>
          <p><strong>健康：</strong> <span id="huUpperHealth">${huUpperDetails.health}</span></p>
          <p><strong>人際：</strong> <span id="huUpperRelationship">${huUpperDetails.relationship}</span></p>
          <p><strong>生活：</strong> <span id="huUpperLife">${huUpperDetails.life}</span></p>
          <p><strong>建議：</strong> <span id="huUpperGuidance">${huUpperDetails.guidance}</span></p>
        </div>
        <div class="wuxing-box">
          <h4>互卦下</h4>
          <p><strong>整體：</strong> <span id="huLowerOverall">${huLowerDetails.title || '無標題'}</span></p>
          <p><strong>描述：</strong> <span id="huLowerDescription">${huLowerDetails.description}</span></p>
          <p><strong>愛情：</strong> <span id="huLowerLove">${huLowerDetails.love}</span></p>
          <p><strong>事業：</strong> <span id="huLowerCareer">${huLowerDetails.career}</span></p>
          <p><strong>財運：</strong> <span id="huLowerWealth">${huLowerDetails.wealth}</span></p>
          <p><strong>健康：</strong> <span id="huLowerHealth">${huLowerDetails.health}</span></p>
          <p><strong>人際：</strong> <span id="huLowerRelationship">${huLowerDetails.relationship}</span></p>
          <p><strong>生活：</strong> <span id="huLowerLife">${huLowerDetails.life}</span></p>
          <p><strong>建議：</strong> <span id="huLowerGuidance">${huLowerDetails.guidance}</span></p>
        </div>
        <div class="wuxing-box">
          <h4>變卦上</h4>
          <p><strong>整體：</strong> <span id="changeUpperOverall">${changeUpperDetails.title || '無標題'}</span></p>
          <p><strong>描述：</strong> <span id="changeUpperDescription">${changeUpperDetails.description}</span></p>
          <p><strong>愛情：</strong> <span id="changeUpperLove">${changeUpperDetails.love}</span></p>
          <p><strong>事業：</strong> <span id="changeUpperCareer">${changeUpperDetails.career}</span></p>
          <p><strong>財運：</strong> <span id="changeUpperWealth">${changeUpperDetails.wealth}</span></p>
          <p><strong>健康：</strong> <span id="changeUpperHealth">${changeUpperDetails.health}</span></p>
          <p><strong>人際：</strong> <span id="changeUpperRelationship">${changeUpperDetails.relationship}</span></p>
          <p><strong>生活：</strong> <span id="changeUpperLife">${changeUpperDetails.life}</span></p>
          <p><strong>建議：</strong> <span id="changeUpperGuidance">${changeUpperDetails.guidance}</span></p>
        </div>
        <div class="wuxing-box">
          <h4>變卦下</h4>
          <p><strong>整體：</strong> <span id="changeLowerOverall">${changeLowerDetails.title || '無標題'}</span></p>
          <p><strong>描述：</strong> <span id="changeLowerDescription">${changeLowerDetails.description}</span></p>
          <p><strong>愛情：</strong> <span id="changeLowerLove">${changeLowerDetails.love}</span></p>
          <p><strong>事業：</strong> <span id="changeLowerCareer">${changeLowerDetails.career}</span></p>
          <p><strong>財運：</strong> <span id="changeLowerWealth">${changeLowerDetails.wealth}</span></p>
          <p><strong>健康：</strong> <span id="changeLowerHealth">${changeLowerDetails.health}</span></p>
          <p><strong>人際：</strong> <span id="changeLowerRelationship">${changeLowerDetails.relationship}</span></p>
          <p><strong>生活：</strong> <span id="changeLowerLife">${changeLowerDetails.life}</span></p>
          <p><strong>建議：</strong> <span id="changeLowerGuidance">${changeLowerDetails.guidance}</span></p>
        </div>
      `;

      const wuxingAnalysis = document.getElementById('wuxingAnalysis');
      wuxingAnalysis.innerHTML = html;
      document.getElementById('judgeBox').classList.remove('hidden');
      wuxingAnalysis.style.display = 'block';

      const auspiciousnessScore = calculateAuspiciousnessScore(result, lunarMonthNumber);
      document.getElementById('auspiciousnessIndex').textContent = `吉凶指數：${auspiciousnessScore.toFixed(1)}`;
      const bar = document.querySelector('#auspiciousnessBar > div');
      bar.style.width = `${auspiciousnessScore * 10}%`;
      bar.style.background = auspiciousnessScore >= 7 ? 'var(--positive-color)' : auspiciousnessScore <= 3 ? 'var(--negative-color)' : 'var(--secondary-color)';

      renderWuxingDiagram(tiGua, mainUpperGua, mainLowerGua, mainUpperGua, mainLowerGua, mainUpperGua, mainLowerGua, lunarMonth, season, lunarMonthNumber);
    }

    function renderWuxingDiagram(tiGua, mainUpperGua, mainLowerGua, huUpperGua, huLowerGua, changeUpperGua, changeLowerGua, lunarMonth, season, lunarMonthNumber) {
      const svg = d3.select('#wuxingSvg').attr('width', 600).attr('height', 400).selectAll('*').remove();
      if (!svg.node()) {
        console.error('找不到 wuxingSvg 元素');
        alert('無法顯示五行生克圖，請檢查頁面結構！');
        return;
      }

      svg.append('defs').selectAll('marker')
        .data(['generate', 'overcome'])
        .join('marker')
        .attr('id', d => `arrow-${d}`)
        .attr('viewBox', '0 -5 10 10')
        .attr('refX', 10)
        .attr('refY', 0)
        .attr('markerWidth', 6)
        .attr('markerHeight', 6)
        .attr('orient', 'auto')
        .append('path')
        .attr('d', 'M0,-5L10,0L0,5')
        .attr('fill', d => d === 'generate' ? 'var(--positive-color)' : 'var(--negative-color)');

      const nodes = [
        { id: 'ti', name: tiGua.name, wuxing: tiGua.wuxing, x: 300, y: 200, label: '體卦', status: getWuxingStatus(tiGua.wuxing, lunarMonthNumber) },
        { id: 'mainUpper', name: mainUpperGua.name, wuxing: mainUpperGua.wuxing, x: 150, y: 100, label: '本卦上', status: getWuxingStatus(mainUpperGua.wuxing, lunarMonthNumber) },
        { id: 'mainLower', name: mainLowerGua.name, wuxing: mainLowerGua.wuxing, x: 150, y: 300, label: '本卦下', status: getWuxingStatus(mainLowerGua.wuxing, lunarMonthNumber) },
        { id: 'huUpper', name: huUpperGua.name, wuxing: huUpperGua.wuxing, x: 450, y: 100, label: '互卦上', status: getWuxingStatus(huUpperGua.wuxing, lunarMonthNumber) },
        { id: 'huLower', name: huLowerGua.name, wuxing: huLowerGua.wuxing, x: 450, y: 300, label: '互卦下', status: getWuxingStatus(huLowerGua.wuxing, lunarMonthNumber) },
        { id: 'changeUpper', name: changeUpperGua.name, wuxing: changeUpperGua.wuxing, x: 300, y: 100, label: '變卦上', status: getWuxingStatus(changeUpperGua.wuxing, lunarMonthNumber) },
        { id: 'changeLower', name: changeLowerGua.name, wuxing: changeLowerGua.wuxing, x: 300, y: 300, label: '變卦下', status: getWuxingStatus(changeLowerGua.wuxing, lunarMonthNumber) }
      ];

      const nodeGroups = svg.selectAll('.wuxing-node-group')
        .data(nodes)
        .join('g')
        .attr('class', 'wuxing-node-group');

      nodeGroups.append('circle')
        .attr('class', 'wuxing-node')
        .attr('cx', d => d.x)
        .attr('cy', d => d.y)
        .attr('r', 40)
        .attr('stroke-width', d => getWuxingStrength(d.status))
        .attr('fill', d => d.id === 'ti' ? '#d5e8f9' : 'none')
        .on('click', (event, d) => {
          updateTiGua(d.id);
          d3.selectAll('.wuxing-node').attr('fill', d2 => d2.id === d.id ? '#d5e8f9' : 'none');
        });

      nodeGroups.append('text')
        .attr('class', 'wuxing-node-text')
        .attr('x', d => d.x)
        .attr('y', d => d.y - 10)
        .text(d => `${d.name} (${d.wuxing}, ${d.status})`);

      nodeGroups.append('text')
        .attr('class', 'wuxing-node-text')
        .attr('x', d => d.x)
        .attr('y', d => d.y + 15)
        .text(d => d.label);

      const edges = [
        { source: 'mainUpper', target: 'ti', type: getRelation(mainUpperGua.wuxing, tiGua.wuxing) },
        { source: 'mainLower', target: 'ti', type: getRelation(mainLowerGua.wuxing, tiGua.wuxing) },
        { source: 'huUpper', target: 'ti', type: getRelation(huUpperGua.wuxing, tiGua.wuxing) },
        { source: 'huLower', target: 'ti', type: getRelation(huLowerGua.wuxing, tiGua.wuxing) },
        { source: 'changeUpper', target: 'ti', type: getRelation(changeUpperGua.wuxing, tiGua.wuxing) },
        { source: 'changeLower', target: 'ti', type: getRelation(changeLowerGua.wuxing, tiGua.wuxing) }
      ];

      svg.selectAll('.wuxing-edge')
        .data(edges)
        .join('line')
        .attr('class', d => `wuxing-edge-${d.type}`)
        .attr('x1', d => nodes.find(n => n.id === d.source).x)
        .attr('y1', d => nodes.find(n => n.id === d.source).y)
        .attr('x2', d => nodes.find(n => n.id === d.target).x)
        .attr('y2', d => nodes.find(n => n.id === d.target).y)
        .attr('marker-end', d => `url(#arrow-${d.type})`);
    }

    function updateTiGua(tiGuaId) {
      if (!currentResult) return;
      const { uIdx, lIdx, moving } = currentResult;
      const mainUpperGua = getTrigramInfo(uIdx);
      const mainLowerGua = getTrigramInfo(lIdx);
      const newTiGua = {
        'ti': getTiYong(currentResult).tiGua,
        'mainUpper': mainUpperGua,
        'mainLower': mainLowerGua,
        'huUpper': mainUpperGua,
        'huLower': mainLowerGua,
        'changeUpper': mainUpperGua,
        'changeLower': mainLowerGua
      }[tiGuaId] || getTiYong(currentResult).tiGua;
      renderWuxingAnalysis({ ...currentResult, tiGuaId });
    }

    function updateHistoryList() {
      const historyList = document.getElementById('historyList');
      historyList.innerHTML = history.map((item, index) => `
        <li>
          ${new Date(item.timestamp).toLocaleString()} - ${item.method}: 
          上卦 ${getTrigramInfo(item.uIdx).name}, 下卦 ${getTrigramInfo(item.lIdx).name}, 
          動爻 ${item.moving.join(',')}
        </li>
      `).join('');
      document.getElementById('historyBox').classList.remove('hidden');
    }

    function openSvgInNewWindow() {
      const svgContent = document.getElementById('wuxingSvg').outerHTML;
      const win = window.open('', '_blank');
      win.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
          <title>五行生克圖</title>
          <style>
            body { margin: 0; padding: 20px; background: #f5f5f5; }
            svg { display: block; margin: 0 auto; }
          </style>
        </head>
        <body>${svgContent}</body>
        </html>
      `);
      win.document.close();
    }

    function downloadSvg() {
      const svg = document.getElementById('wuxingSvg');
      const serializer = new XMLSerializer();
      const source = '<?xml version="1.0" standalone="no"?>\r\n' + serializer.serializeToString(svg);
      const url = 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(source);
      const link = document.createElement('a');
      link.href = url;
      link.download = 'wuxing_diagram.svg';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    // 簡化的農曆計算模組（實際應用需更精確的實現）
    const lunarCalendar = {
      gregorianToLunar(date) {
        const lunarMonth = Math.floor((date.getMonth() + 1) % 12) + 1;
        const season = ['春', '春', '春', '夏', '夏', '夏', '秋', '秋', '秋', '冬', '冬', '冬'][lunarMonth - 1];
        return { lunarMonth, season, lunarMonthNumber: lunarMonth };
      }
    };

    // 初始化事件監聽器
    document.addEventListener('DOMContentLoaded', () => {
      loadResources().then(() => {
        const methodSelect = document.getElementById('methodSelect');
        const forms = {
          number: document.getElementById('numberForm'),
          randomNumber: document.getElementById('randomNumberForm'),
          manual: document.getElementById('manualForm'),
          time: document.getElementById('timeForm'),
          image: document.getElementById('imageForm')
        };

        methodSelect.addEventListener('change', () => {
          Object.values(forms).forEach(form => form.classList.add('hidden'));
          forms[methodSelect.value].classList.remove('hidden');
        });

        document.getElementById('btnNumber').addEventListener('click', () => {
          const numUpper = parseInt(document.getElementById('numUpper').value);
          const numLower = parseInt(document.getElementById('numLower').value);
          const numMoving = parseInt(document.getElementById('numMoving').value);
          if (
            isNaN(numUpper) || numUpper < 100 || numUpper > 999 ||
            isNaN(numLower) || numLower < 100 || numLower > 999 ||
            isNaN(numMoving) || numMoving < 100 || numMoving > 999
          ) {
            alert('請輸入 100 到 999 之間的數字！');
            console.warn('無效的數字輸入:', { numUpper, numLower, numMoving });
            return;
          }
          const upper = numUpper % 8 || 8;
          const lower = numLower % 8 || 8;
          const moving = [(numMoving % 6) || 6];
          generateGua(upper, lower, moving, '數字取卦');
          renderWuxingAnalysis(currentResult);
        });

        document.getElementById('btnRandomNumber').addEventListener('click', () => {
          const upper = Math.floor(Math.random() * 8) + 1;
          const lower = Math.floor(Math.random() * 8) + 1;
          const moving = [Math.floor(Math.random() * 6) + 1];
          generateGua(upper, lower, moving, '隨機數字');
          renderWuxingAnalysis(currentResult);
        });

        document.getElementById('btnManual').addEventListener('click', () => {
          const upper = parseInt(document.getElementById('upperGuaSelect').value);
          const lower = parseInt(document.getElementById('lowerGuaSelect').value);
          const moving = [parseInt(document.getElementById('movingLineSelect').value)];
          generateGua(upper, lower, moving, '手動取卦');
          renderWuxingAnalysis(currentResult);
        });

        document.getElementById('btnTime').addEventListener('click', () => {
          const now = new Date();
          const upper = (now.getHours() % 8) + 1;
          const lower = (now.getMinutes() % 8) + 1;
          const moving = [(now.getSeconds() % 6) + 1];
          generateGua(upper, lower, moving, '時間取卦');
          renderWuxingAnalysis(currentResult);
        });

        document.getElementById('btnImage').addEventListener('click', () => {
          const imageInput = document.getElementById('imageInput').value;
          if (!imageInput) {
            alert('請輸入象徵描述！');
            return;
          }
          const hash = imageInput.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0);
          const upper = (hash % 8) + 1;
          const lower = ((hash + 1) % 8) + 1;
          const moving = [(hash % 6) + 1];
          generateGua(upper, lower, moving, '以象取卦', imageInput);
          renderWuxingAnalysis(currentResult);
        });

        document.getElementById('downloadSvgBtn').addEventListener('click', downloadSvg);
        document.getElementById('openSvgWindowBtn').addEventListener('click', openSvgInNewWindow);

        document.getElementById('exportBtn').addEventListener('click', () => {
          const dataStr = 'data:text/json;charset=utf-8,' + encodeURIComponent(JSON.stringify(history));
          const link = document.createElement('a');
          link.href = dataStr;
          link.download = 'divination_history.json';
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
        });

        document.getElementById('importBtn').addEventListener('click', () => {
          document.getElementById('importInput').click();
        });

        document.getElementById('importInput').addEventListener('change', (event) => {
          const file = event.target.files[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = (e) => {
            try {
              const imported = JSON.parse(e.target.result);
              if (Array.isArray(imported)) {
                history.push(...imported);
                localStorage.setItem('history', JSON.stringify(history));
                updateHistoryList();
              } else {
                alert('匯入檔案格式錯誤！');
              }
            } catch (error) {
              console.error('匯入歷史記錄失敗:', error);
              alert('匯入檔案失敗，請檢查格式！');
            }
          };
          reader.readAsText(file);
        });

        // 載入歷史記錄
        const savedHistory = localStorage.getItem('history');
        if (savedHistory) {
          history.push(...JSON.parse(savedHistory));
          updateHistoryList();
        }
      });
    });
  </script>
</body>
</html>
