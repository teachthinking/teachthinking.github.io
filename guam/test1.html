```html
<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>易經五行占卜</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .container { max-width: 900px; margin: auto; }
    .tabs { display: flex; gap: 10px; margin-bottom: 20px; }
    .tab-button { padding: 10px 20px; cursor: pointer; background: #f0f0f0; border-radius: 5px; }
    .tab-button.active { background: #007bff; color: white; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .input-group { margin-bottom: 15px; }
    .input-group label { margin-right: 10px; }
    .input-group input, .input-group select { padding: 5px; }
    .hidden { display: none; }
    #wuxingSvg { border: 1px solid #ccc; margin: 20px 0; }
    .wuxing-node { stroke: black; stroke-opacity: 1; }
    .木 { fill: #228B22; }
    .火 { fill: #FF4500; }
    .土 { fill: #DAA520; }
    .金 { fill: #FFD700; }
    .水 { fill: #4169E1; }
    .wuxing-node-text { font-size: 14px; text-anchor: middle; fill: black; }
    .wuxing-edge-generate { stroke: green; stroke-opacity: 1; }
    .wuxing-edge-overcome { stroke: red; stroke-opacity: 1; }
    .wuxing-edge-harmony { stroke: blue; stroke-opacity: 1; }
    .wuxing-edge-label { font-size: 12px; text-anchor: middle; fill: black; }
    #judgeBox, #detailedAnalysis { margin-top: 20px; padding: 15px; border: 1px solid #ccc; border-radius: 5px; }
    .wuxing-status.positive { color: green; }
    .wuxing-status.neutral { color: blue; }
    .wuxing-status.negative { color: red; }
    .score-bar { height: 20px; border-radius: 5px; }
    .buttons { margin-top: 10px; }
    button { padding: 8px 16px; margin-right: 10px; cursor: pointer; }
  </style>
</head>
<body>
  <div class="container">
    <h1>易經五行占卜</h1>
    <div class="tabs">
      <div class="tab-button active" data-target="numberTab">數字取卦</div>
    </div>
    <div id="numberTab" class="tab-content active">
      <div class="input-group">
        <label>上卦數字 (100-999):</label>
        <input type="number" id="numUpper" min="100" max="999">
      </div>
      <div class="input-group">
        <label>下卦數字 (100-999):</label>
        <input type="number" id="numLower" min="100" max="999">
      </div>
      <div class="input-group">
        <label>動爻數字 (100-999):</label>
        <input type="number" id="numMoving" min="100" max="999">
      </div>
      <button id="btnNumber">數字取卦</button>
      <button id="btnRandomNumber">隨機數字取卦</button>
    </div>
    <svg id="wuxingSvg" width="800" height="600"></svg>
    <div id="judgeBox" class="hidden">
      <h3>五行分析</h3>
      <table>
        <tr><td>本卦上卦：</td><td id="mainUpperWuxing"></td><td id="mainUpperRelation" class="wuxing-status"></td></tr>
        <tr><td>本卦下卦：</td><td id="mainLowerWuxing"></td><td id="mainLowerRelation" class="wuxing-status"></td></tr>
        <tr><td>互卦上卦：</td><td id="huUpperWuxing"></td><td id="huUpperRelation" class="wuxing-status"></td></tr>
        <tr><td>互卦下卦：</td><td id="huLowerWuxing"></td><td id="huLowerRelation" class="wuxing-status"></td></tr>
        <tr><td>變卦上卦：</td><td id="changeUpperWuxing"></td><td id="changeUpperRelation" class="wuxing-status"></td></tr>
        <tr><td>變卦下卦：</td><td id="changeLowerWuxing"></td><td id="changeLowerRelation" class="wuxing-status"></td></tr>
        <tr><td>吉凶指數：</td><td id="auspiciousnessIndex" colspan="2"></td></tr>
        <tr><td colspan="3"><div id="auspiciousnessBar"></div></td></tr>
      </table>
    </div>
    <div id="detailedAnalysis" class="hidden">
      <h3>詳細分析</h3>
    </div>
    <div class="buttons">
      <button id="judgeBtn">五行與象徵</button>
      <button id="downloadSvgBtn">下載 SVG</button>
      <button id="openSvgWindowBtn">新視窗查看 SVG</button>
      <button id="debugSvgBtn">檢查 SVG</button>
    </div>
  </div>
  <script>
    let currentResult = null;
    let hexagrams = {}, quotes = {}, wuxingExplanations = {};
    const trigramSymbol = {
      '乾': '☰', '坤': '☷', '震': '☳', '巽': '☴', '坎': '☵', '離': '☲', '艮': '☶', '兌': '☱'
    };
    const relationMap = {
      '用生體': '用生體',
      '體生用': '體生用',
      '用剋體': '用剋體',
      '體剋用': '體剋用',
      '比和': '比和'
    };

    // 模擬載入 JSON 資源
    function loadResources() {
      // 假設已載入 wuxing_explanations.json
      wuxingExplanations = {
        "用生體": {
          "overall": "這是一個大吉的卦象，代表外在環境或貴人對您主動付出，使您無須費力就能心想事成。",
          "details": {
            "乾卦生體": { "title": "乾金生體卦", "description": "主有官方、公職、長輩或尊貴人士相助。", "love": "感情上得到長輩支持。", "career": "事業上得貴人提拔。", "wealth": "財運來自長輩、官方。", "guidance": "請多向長輩或有經驗的人請教。" },
            // 其他卦省略
          }
        },
        "體生用": { /* 簡化內容 */ },
        "用剋體": { /* 簡化內容 */ },
        "體剋用": { /* 簡化內容 */ },
        "比和": { /* 簡化內容 */ }
      };
      console.log('資源載入完成:', Object.keys(wuxingExplanations).length, '五行關係');
    }

    // 模擬五行狀態和關係函數
    function getWuxingStatus(wuxing, lunarMonthNumber) {
      const statusMap = {
        '金': { 8: '旺', 9: '相', 10: '休', 11: '囚', 12: '死', 1: '死', 2: '囚', 3: '休', 4: '相', 5: '旺', 6: '旺', 7: '相' },
        '木': { 11: '旺', 12: '相', 1: '休', 2: '囚', 3: '死', 4: '死', 5: '囚', 6: '休', 7: '相', 8: '旺', 9: '旺', 10: '相' },
        '水': { 5: '旺', 6: '相', 7: '休', 8: '囚', 9: '死', 10: '死', 11: '囚', 12: '休', 1: '相', 2: '旺', 3: '旺', 4: '相' },
        '火': { 2: '旺', 3: '相', 4: '休', 5: '囚', 6: '死', 7: '死', 8: '囚', 9: '休', 10: '相', 11: '旺', 12: '旺', 1: '相' },
        '土': { 1: '旺', 2: '相', 4: '旺', 5: '相', 7: '旺', 8: '相', 10: '旺', 11: '相', 12: '休', 3: '休', 6: '休', 9: '休' }
      };
      return statusMap[wuxing]?.[lunarMonthNumber] || '未知';
    }

    function getWuxingStrength(status) {
      const strengthMap = { '旺': 5, '相': 4, '休': 3, '囚': 2, '死': 1 };
      return strengthMap[status] || 1;
    }

    function getRelation(wuxing1, wuxing2) {
      if (wuxing1 === wuxing2) return '比和';
      const generate = { '木': '火', '火': '土', '土': '金', '金': '水', '水': '木' };
      const overcome = { '木': '土', '土': '水', '水': '火', '火': '金', '金': '木' };
      if (generate[wuxing1] === wuxing2) return '體生用';
      if (generate[wuxing2] === wuxing1) return '用生體';
      if (overcome[wuxing1] === wuxing2) return '體剋用';
      if (overcome[wuxing2] === wuxing1) return '用剋體';
      return '未知';
    }

    // 模擬農曆計算
    const lunarCalendar = {
      gregorianToLunar: (date) => ({
        lunarMonth: '五月',
        season: '夏季',
        lunarMonthNumber: 5
      })
    };

    // 模擬卦象資訊
    function getTrigramInfo(idx) {
      const trigramData = {
        1: { name: '乾', wuxing: '金' },
        2: { name: '坤', wuxing: '土' },
        3: { name: '震', wuxing: '木' },
        4: { name: '巽', wuxing: '木' },
        5: { name: '坎', wuxing: '水' },
        6: { name: '離', wuxing: '火' },
        7: { name: '艮', wuxing: '土' },
        8: { name: '兌', wuxing: '金' }
      };
      return trigramData[idx] || { name: '未知', wuxing: '未知' };
    }

    function generateGua(uIdx, lIdx, movingLines, method) {
      const mainUpperGua = getTrigramInfo(uIdx);
      const mainLowerGua = getTrigramInfo(lIdx);
      const date = new Date();
      const lunar = lunarCalendar.gregorianToLunar(date);
      const changeLines = Array(6).fill(0).map((_, i) => movingLines.includes(i + 1) ? 1 : 0);
      const huLines = [0, 0, 0, 0, 0, 0]; // 簡化模擬互卦
      currentResult = {
        uIdx,
        lIdx,
        changeLines,
        huLines,
        timestamp: date.toISOString(),
        question: '測試問題',
        questionType: 'general',
        tiGua: mainUpperGua // 假設體卦為本卦上卦
      };
      renderWuxingAnalysis(currentResult);
      renderDetailedAnalysis(currentResult);
    }

    function switchTiGua(newTiGua, mainUpperGua, mainLowerGua, huUpperGua, huLowerGua, changeUpperGua, changeLowerGua, lunarMonth, season, lunarMonthNumber) {
      currentResult.tiGua = newTiGua;
      renderWuxingDiagram(currentResult.tiGua, mainUpperGua, mainLowerGua, huUpperGua, huLowerGua, changeUpperGua, changeLowerGua, lunarMonth, season, lunarMonthNumber);
      renderWuxingAnalysis(currentResult);
      renderDetailedAnalysis(currentResult);
    }

    function renderWuxingDiagram(tiGua, mainUpperGua, mainLowerGua, huUpperGua, huLowerGua, changeUpperGua, changeLowerGua, lunarMonth, season, lunarMonthNumber) {
      console.log('開始渲染五行圖，體卦:', tiGua);
      const svg = document.getElementById('wuxingSvg');
      if (!svg) {
        console.error('找不到 wuxingSvg 元素');
        alert('無法渲染五行圖：缺少 SVG 容器');
        return;
      }

      svg.innerHTML = '';
      svg.setAttribute('width', '800');
      svg.setAttribute('height', '600');

      // 定義箭頭標記
      const defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');
      defs.innerHTML = `
        <marker id="arrow-generate" viewBox="0 0 10 10" refX="5" refY="5" markerWidth="6" markerHeight="6" orient="auto-start-reverse">
          <path d="M 0 0 L 10 5 L 0 10 z" fill="green" />
        </marker>
        <marker id="arrow-overcome" viewBox="0 0 10 10" refX="5" refY="5" markerWidth="6" markerHeight="6" orient="auto-start-reverse">
          <path d="M 0 0 L 10 5 L 0 10 z" fill="red" />
        </marker>
        <marker id="arrow-harmony" viewBox="0 0 10 10" refX="5" refY="5" markerWidth="6" markerHeight="6" orient="auto-start-reverse">
          <path d="M 0 0 L 10 5 L 0 10 z" fill="blue" />
        </marker>
        <marker id="arrow-harmony-reverse" viewBox="0 0 10 10" refX="5" refY="5" markerWidth="6" markerHeight="6" orient="auto-start-reverse">
          <path d="M 0 0 L 10 5 L 0 10 z" fill="blue" />
        </marker>
      `;
      svg.appendChild(defs);

      // 定義節點位置：體卦位於本卦與變卦之間
      const nodes = [
        { id: 'ti', name: tiGua.name, wuxing: tiGua.wuxing, status: getWuxingStatus(tiGua.wuxing, lunarMonthNumber), label: '體卦', x: 400, y: 200 },
        { id: 'mainUpper', name: mainUpperGua.name, wuxing: mainUpperGua.wuxing, status: getWuxingStatus(mainUpperGua.wuxing, lunarMonthNumber), label: '本卦上卦', x: 300, y: 100 },
        { id: 'mainLower', name: mainLowerGua.name, wuxing: mainLowerGua.wuxing, status: getWuxingStatus(mainLowerGua.wuxing, lunarMonthNumber), label: '本卦下卦', x: 300, y: 300 },
        { id: 'huUpper', name: huUpperGua.name, wuxing: huUpperGua.wuxing, status: getWuxingStatus(huUpperGua.wuxing, lunarMonthNumber), label: '互卦上卦', x: 200, y: 400 },
        { id: 'huLower', name: huLowerGua.name, wuxing: huLowerGua.wuxing, status: getWuxingStatus(huLowerGua.wuxing, lunarMonthNumber), label: '互卦下卦', x: 200, y: 500 },
        { id: 'changeUpper', name: changeUpperGua.name, wuxing: changeUpperGua.wuxing, status: getWuxingStatus(changeUpperGua.wuxing, lunarMonthNumber), label: '變卦上卦', x: 500, y: 100 },
        { id: 'changeLower', name: changeLowerGua.name, wuxing: changeLowerGua.wuxing, status: getWuxingStatus(changeLowerGua.wuxing, lunarMonthNumber), label: '變卦下卦', x: 500, y: 300 }
      ];

      // 渲染節點
      nodes.forEach(node => {
        if (!node.name || !node.wuxing || !node.status) {
          console.warn('節點數據不完整:', node);
          return;
        }

        const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
        const strokeWidth = getWuxingStrength(node.status);
        const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
        circle.classList.add('wuxing-node', node.wuxing);
        circle.setAttribute('cx', node.x);
        circle.setAttribute('cy', node.y);
        circle.setAttribute('r', '40');
        circle.setAttribute('stroke-width', strokeWidth.toString());
        g.appendChild(circle);

        const text1 = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        text1.classList.add('wuxing-node-text');
        text1.setAttribute('x', node.x);
        text1.setAttribute('y', node.y - 15);
        text1.textContent = node.name + ' (' + node.wuxing + ', ' + node.status + ')';
        g.appendChild(text1);

        const text2 = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        text2.classList.add('wuxing-node-text');
        text2.setAttribute('x', node.x);
        text2.setAttribute('y', node.y + 5);
        text2.textContent = node.label;
        g.appendChild(text2);

        const text3 = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        text3.classList.add('wuxing-node-text');
        text3.setAttribute('x', node.x);
        text3.setAttribute('y', node.y + 25);
        text3.textContent = trigramSymbol[node.name] || '';
        g.appendChild(text3);

        // 點擊事件
        circle.addEventListener('click', () => {
          const questionType = currentResult.questionType || 'general';
          const relation = getRelation(tiGua.wuxing, node.wuxing);
          const key = node.id === 'ti' ? relation : `${node.name}卦${relation.includes('生') ? '生體' : relation.includes('剋') ? '剋體' : '比和'}`;
          const explanation = wuxingExplanations[relationMap[relation]]?.details?.[key] || 
                             wuxingExplanations[relationMap[relation]]?.[questionType] || 
                             { description: '無具體解釋', guidance: '無具體建議' };

          if (node.id === 'ti') {
            alert(
              '卦象：' + node.label + ' (' + node.name + ')\n' +
              '五行：' + node.wuxing + '\n' +
              '狀態：' + node.status + '\n' +
              '與體卦關係：' + relation + '\n' +
              '說明：' + (explanation.description || '無') + '\n' +
              '建議：' + (explanation.guidance || '無') + '\n' +
              '感情：' + (explanation.love || '無') + '\n' +
              '事業：' + (explanation.career || '無') + '\n' +
              '財運：' + (explanation.wealth || '無')
            );
          } else {
            if (confirm('是否將 ' + node.label + ' (' + node.name + ') 設為新體卦並重新分析？')) {
              console.log('切換體卦至 ' + node.name + ' (' + node.wuxing + ')');
              switchTiGua(
                { name: node.name, wuxing: node.wuxing },
                mainUpperGua,
                mainLowerGua,
                huUpperGua,
                huLowerGua,
                changeUpperGua,
                changeLowerGua,
                lunarMonth,
                season,
                lunarMonthNumber
              );
            }
          }
        });

        svg.appendChild(g);
      });
      console.log('節點渲染完成，總節點數:', nodes.length);

      // 定義邊
      const edges = [
        { from: 'ti', to: 'mainUpper', relation: getRelation(tiGua.wuxing, mainUpperGua.wuxing) },
        { from: 'ti', to: 'mainLower', relation: getRelation(tiGua.wuxing, mainLowerGua.wuxing) },
        { from: 'ti', to: 'huUpper', relation: getRelation(tiGua.wuxing, huUpperGua.wuxing) },
        { from: 'ti', to: 'huLower', relation: getRelation(tiGua.wuxing, huLowerGua.wuxing) },
        { from: 'ti', to: 'changeUpper', relation: getRelation(tiGua.wuxing, changeUpperGua.wuxing) },
        { from: 'ti', to: 'changeLower', relation: getRelation(tiGua.wuxing, changeLowerGua.wuxing) },
        { from: 'mainUpper', to: 'mainLower', relation: getRelation(mainUpperGua.wuxing, mainLowerGua.wuxing) },
        { from: 'huUpper', to: 'huLower', relation: getRelation(huUpperGua.wuxing, huLowerGua.wuxing) },
        { from: 'changeUpper', to: 'changeLower', relation: getRelation(changeUpperGua.wuxing, changeLowerGua.wuxing) }
      ];

      // 渲染邊
      edges.forEach(edge => {
        if (edge.from === edge.to) return;
        const fromNode = nodes.find(n => n.id === edge.from);
        const toNode = nodes.find(n => n.id === edge.to);
        if (!fromNode || !toNode) {
          console.warn('無效的邊: ' + edge.from + ' -> ' + edge.to);
          return;
        }

        let marker = '';
        if (edge.relation === '用生體' || edge.relation === '體生用') {
          marker = 'url(#arrow-generate)';
        } else if (edge.relation === '用剋體' || edge.relation === '體�克用') {
          marker = 'url(#arrow-overcome)';
        } else if (edge.relation === '比和') {
          marker = edge.from < edge.to ? 'url(#arrow-harmony)' : 'url(#arrow-harmony-reverse)';
        }

        const strokeWidth = getWuxingStrength(fromNode.status);
        const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        line.classList.add('wuxing-edge-' + (edge.relation === '比和' ? 'harmony' : edge.relation.includes('生') ? 'generate' : 'overcome'));
        line.setAttribute('x1', fromNode.x);
        line.setAttribute('y1', fromNode.y);
        line.setAttribute('x2', toNode.x);
        line.setAttribute('y2', toNode.y);
        line.setAttribute('stroke-width', strokeWidth.toString());
        if (marker) {
          line.setAttribute('marker-end', marker);
        }
        svg.appendChild(line);

        const midX = (fromNode.x + toNode.x) / 2;
        const midY = (fromNode.y + toNode.y) / 2;
        const label = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        label.classList.add('wuxing-edge-label');
        label.setAttribute('x', midX);
        label.setAttribute('y', midY - 5);
        label.textContent = edge.relation;
        svg.appendChild(label);
      });
      console.log('邊渲染完成，總邊數:', edges.length);

      svg.style.display = 'none';
      svg.offsetHeight;
      svg.style.display = 'block';
      console.log('五行圖渲染完成');
    }

    function renderWuxingAnalysis(result) {
      const judgeBox = document.getElementById('judgeBox');
      if (!judgeBox) {
        console.error('找不到 judgeBox 元素');
        return;
      }
      judgeBox.classList.remove('hidden');

      const date = new Date(result.timestamp);
      const lunar = lunarCalendar.gregorianToLunar(date);
      const mainUpperGua = getTrigramInfo(result.uIdx);
      const mainLowerGua = getTrigramInfo(result.lIdx);
      const changeUpperGua = getTrigramInfo(8); // 簡化模擬
      const changeLowerGua = getTrigramInfo(8);
      const huUpperGua = getTrigramInfo(8);
      const huLowerGua = getTrigramInfo(8);

      document.getElementById('mainUpperWuxing').textContent = mainUpperGua.name + ' (' + mainUpperGua.wuxing + ')';
      document.getElementById('mainLowerWuxing').textContent = mainLowerGua.name + ' (' + mainLowerGua.wuxing + ')';
      document.getElementById('huUpperWuxing').textContent = huUpperGua.name + ' (' + huUpperGua.wuxing + ')';
      document.getElementById('huLowerWuxing').textContent = huLowerGua.name + ' (' + huLowerGua.wuxing + ')';
      document.getElementById('changeUpperWuxing').textContent = changeUpperGua.name + ' (' + changeUpperGua.wuxing + ')';
      document.getElementById('changeLowerWuxing').textContent = changeLowerGua.name + ' (' + changeLowerGua.wuxing + ')';

      const relations = {
        mainUpperRelation: getRelation(result.tiGua.wuxing, mainUpperGua.wuxing),
        mainLowerRelation: getRelation(result.tiGua.wuxing, mainLowerGua.wuxing),
        huUpperRelation: getRelation(result.tiGua.wuxing, huUpperGua.wuxing),
        huLowerRelation: getRelation(result.tiGua.wuxing, huLowerGua.wuxing),
        changeUpperRelation: getRelation(result.tiGua.wuxing, changeUpperGua.wuxing),
        changeLowerRelation: getRelation(result.tiGua.wuxing, changeLowerGua.wuxing)
      };

      Object.keys(relations).forEach(id => {
        const element = document.getElementById(id);
        if (element) {
          element.textContent = relations[id];
          element.className = 'wuxing-status';
          if (relations[id] === '用生體' || relations[id] === '體剋用') {
            element.classList.add('positive');
          } else if (relations[id] === '比和') {
            element.classList.add('neutral');
          } else if (relations[id] === '體生用' || relations[id] === '用剋體') {
            element.classList.add('negative');
          }
        }
      });

      const totalScore = 5; // 簡化模擬
      const auspiciousnessIndex = document.getElementById('auspiciousnessIndex');
      const auspiciousnessBar = document.getElementById('auspiciousnessBar');
      if (auspiciousnessIndex && auspiciousnessBar) {
        auspiciousnessIndex.textContent = '吉凶指數：' + totalScore.toFixed(1) + ' / 10';
        auspiciousnessBar.innerHTML = '<div class="score-bar" style="width: ' + (totalScore * 10) + '%; background: ' + (totalScore >= 7 ? 'green' : totalScore >= 4 ? 'yellow' : 'red') + '"></div>';
      }

      renderWuxingDiagram(result.tiGua, mainUpperGua, mainLowerGua, huUpperGua, huLowerGua, changeUpperGua, changeLowerGua, lunar.lunarMonth, lunar.season, lunar.lunarMonthNumber);
    }

    function renderDetailedAnalysis(result) {
      const detailedAnalysis = document.getElementById('detailedAnalysis');
      if (!detailedAnalysis) {
        console.error('找不到 detailedAnalysis 元素');
        return;
      }
      detailedAnalysis.classList.remove('hidden');

      const lunar = lunarCalendar.gregorianToLunar(new Date(result.timestamp));
      const mainUpperGua = getTrigramInfo(result.uIdx);
      const mainLowerGua = getTrigramInfo(result.lIdx);
      const changeUpperGua = getTrigramInfo(8);
      const changeLowerGua = getTrigramInfo(8);
      const huUpperGua = getTrigramInfo(8);
      const huLowerGua = getTrigramInfo(8);
      const questionType = result.questionType || 'general';

      let html = '<h3>詳細分析</h3>';
      html += '<table>';
      html += '<tr><th>卦象</th><th>五行</th><th>狀態</th><th>與體卦關係</th><th>說明</th><th>建議</th></tr>';
      
      const guas = [
        { label: '體卦', gua: result.tiGua, relation: '自身' },
        { label: '本卦上卦', gua: mainUpperGua, relation: getRelation(result.tiGua.wuxing, mainUpperGua.wuxing) },
        { label: '本卦下卦', gua: mainLowerGua, relation: getRelation(result.tiGua.wuxing, mainLowerGua.wuxing) },
        { label: '互卦上卦', gua: huUpperGua, relation: getRelation(result.tiGua.wuxing, huUpperGua.wuxing) },
        { label: '互卦下卦', gua: huLowerGua, relation: getRelation(result.tiGua.wuxing, huLowerGua.wuxing) },
        { label: '變卦上卦', gua: changeUpperGua, relation: getRelation(result.tiGua.wuxing, changeUpperGua.wuxing) },
        { label: '變卦下卦', gua: changeLowerGua, relation: getRelation(result.tiGua.wuxing, changeLowerGua.wuxing) }
      ];

      guas.forEach(g => {
        const explanation = wuxingExplanations[relationMap[g.relation]]?.details?.[`${g.gua.name}卦${g.relation.includes('生') ? '生體' : g.relation.includes('剋') ? '剋體' : '比和'}`] || 
                           wuxingExplanations[relationMap[g.relation]]?.[questionType] || 
                           { description: '無具體解釋', guidance: '無具體建議' };
        html += '<tr>' +
                '<td>' + g.label + '</td>' +
                '<td>' + g.gua.wuxing + '</td>' +
                '<td>' + getWuxingStatus(g.gua.wuxing, lunar.lunarMonthNumber) + '</td>' +
                '<td>' + g.relation + '</td>' +
                '<td>' + (explanation.description || '無') + '</td>' +
                '<td>' + (explanation.guidance || '無') + '</td>' +
                '</tr>';
      });
      html += '</table>';
      detailedAnalysis.innerHTML = html;
    }

    function downloadSvg() {
      const svg = document.getElementById('wuxingSvg');
      const serializer = new XMLSerializer();
      const source = serializer.serializeToString(svg);
      const blob = new Blob(['<?xml version="1.0" standalone="no"?>\r\n' + source], { type: 'image/svg+xml' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'wuxing_diagram.svg';
      a.click();
      URL.revokeObjectURL(url);
    }

    function openSvgInNewWindow() {
      const svg = document.getElementById('wuxingSvg');
      const serializer = new XMLSerializer();
      const source = serializer.serializeToString(svg);
      const win = window.open('');
      win.document.write('<!DOCTYPE html><html><head><title>五行圖</title></head><body>' + source + '</body></html>');
    }

    function debugSvg() {
      const edges = document.querySelectorAll('#wuxingSvg line');
      edges.forEach((edge, i) => {
        console.log('邊 ' + i + ': stroke-width=' + edge.getAttribute('stroke-width') + ', from=(' + edge.getAttribute('x1') + ',' + edge.getAttribute('y1') + '), to=(' + edge.getAttribute('x2') + ',' + edge.getAttribute('y2') + ')');
      });
    }

    document.addEventListener('DOMContentLoaded', () => {
      loadResources();

      document.querySelectorAll('.tab-button').forEach(button => {
        button.addEventListener('click', () => {
          document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
          document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
          button.classList.add('active');
          document.getElementById(button.dataset.target).classList.add('active');
        });
      });

      document.getElementById('btnNumber').addEventListener('click', () => {
        const upper = parseInt(document.getElementById('numUpper').value);
        const lower = parseInt(document.getElementById('numLower').value);
        const moving = parseInt(document.getElementById('numMoving').value);
        if (isNaN(upper) || isNaN(lower) || isNaN(moving) || upper < 100 || upper > 999 || lower < 100 || lower > 999 || moving < 100 || moving > 999) {
          alert('請輸入有效的100-999數字！');
          return;
        }
        const uIdx = ((upper % 8) === 0 ? 8 : upper % 8);
        const lIdx = ((lower % 8) === 0 ? 8 : lower % 8);
        const movingLine = ((moving % 6) === 0 ? 6 : moving % 6);
        generateGua(uIdx, lIdx, [movingLine], '數字取卦');
      });

      document.getElementById('btnRandomNumber').addEventListener('click', () => {
        const upper = Math.floor(Math.random() * 900) + 100;
        const lower = Math.floor(Math.random() * 900) + 100;
        const moving = Math.floor(Math.random() * 900) + 100;
        document.getElementById('numUpper').value = upper;
        document.getElementById('numLower').value = lower;
        document.getElementById('numMoving').value = moving;
        const uIdx = ((upper % 8) === 0 ? 8 : upper % 8);
        const lIdx = ((lower % 8) === 0 ? 8 : lower % 8);
        const movingLine = ((moving % 6) === 0 ? 6 : moving % 6);
        generateGua(uIdx, lIdx, [movingLine], '數字亂數取卦');
      });

      document.getElementById('judgeBtn').addEventListener('click', () => {
        if (currentResult) {
          renderWuxingAnalysis(currentResult);
          renderDetailedAnalysis(currentResult);
        } else {
          alert('請先進行取卦！');
        }
      });

      document.getElementById('downloadSvgBtn').addEventListener('click', downloadSvg);
      document.getElementById('openSvgWindowBtn').addEventListener('click', openSvgInNewWindow);
      document.getElementById('debugSvgBtn').addEventListener('click', debugSvg);
    });
  </script>
</body>
</html>
```
