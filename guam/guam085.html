<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>張老師易經(梅花心易)</title>
  <style>
    :root {
      --primary-color: #2c3e50;
      --secondary-color: #3498db;
      --negative-color: #e74c3c;
      --positive-color: #4caf50;
      --yellow-color: #f1c40f;
      --background-color: #f4f7f9;
      --card-bg: #ffffff;
      --border-color: #e0e6ed;
      --text-color: #333333;
      --sub-text-color: #7f8c8d;
      --shadow-light: 0 4px 12px rgba(0, 0, 0, 0.05);
      --border-radius: 12px;
      --font-family: 'Noto Sans TC', sans-serif;
      --wood-color: #228b22;
      --fire-color: #ff4500;
      --earth-color: #d2b48c;
      --metal-color: #f5f5f5;
      --water-color: #4682b4;
    }

    body {
      font-family: var(--font-family);
      background: var(--background-color);
      color: var(--text-color);
      padding: 20px;
      line-height: 1.6;
      margin: 0;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: var(--card-bg);
      padding: 25px;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow-light);
    }

    h1 {
      margin: 0 0 8px 0;
      font-size: 28px;
      color: var(--primary-color);
    }

    h2.subtitle {
      margin: 0 0 20px 0;
      color: var(--sub-text-color);
      font-weight: 400;
      font-size: 16px;
      border-bottom: 1px solid var(--border-color);
      padding-bottom: 15px;
    }

    .tab-buttons {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }

    .tab-button {
      padding: 10px 18px;
      border-radius: var(--border-radius);
      border: 1px solid var(--border-color);
      background: transparent;
      cursor: pointer;
      color: var(--sub-text-color);
      transition: all 0.3s ease;
      font-size: 15px;
    }

    .tab-button.active {
      background: var(--primary-color);
      color: #fff;
      border-color: var(--primary-color);
    }

    .tab-content {
      display: none;
      padding-top: 10px;
    }

    .tab-content.active {
      display: block;
    }

    .row {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
      margin: 12px 0;
    }

    .hint {
      font-size: 13px;
      color: var(--sub-text-color);
      line-height: 1.5;
    }

    .gua-box {
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius);
      padding: 20px;
      background: var(--background-color);
      margin-bottom: 20px;
    }

    .hidden {
      display: none;
    }

    button.primary {
      background: var(--primary-color);
      color: #fff;
      border: none;
      padding: 10px 20px;
      border-radius: var(--border-radius);
      cursor: pointer;
      transition: background 0.3s ease;
    }

    button.primary:hover {
      background: var(--secondary-color);
    }

    input, select {
      padding: 8px;
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius);
      font-size: 14px;
    }

    .gua-display-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin: 10px 0;
    }

    .gua-line {
      width: 60px;
      height: 10px;
      margin: 5px 0;
      background: var(--text-color);
      position: relative;
    }

    .gua-line.yin::after {
      content: '';
      position: absolute;
      width: 20px;
      height: 10px;
      background: var(--card-bg);
      left: 20px;
    }

    .gua-line.moving::before {
      content: '×';
      position: absolute;
      color: var(--negative-color);
      font-size: 16px;
      left: -20px;
      top: -3px;
    }

    .gua-name {
      margin-top: 10px;
      font-weight: bold;
      font-size: 16px;
      color: var(--primary-color);
      text-align: center;
    }

    .wuxing-box {
      margin: 15px 0;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      max-width: 600px;
    }

    .wuxing-box ul {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .wuxing-box li {
      flex: 1 1 calc(50% - 10px);
      min-width: 280px;
      padding: 10px;
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius);
      background: var(--card-bg);
    }

    .wuxing-status {
      font-weight: bold;
    }

    .wuxing-status.positive { color: var(--positive-color); }
    .wuxing-status.neutral { color: var(--secondary-color); }
    .wuxing-status.negative { color: var(--negative-color); }

    .wuxing-node {
      stroke: var(--primary-color);
      stroke-width: 2;
      transition: all 0.3s ease;
      animation: pulse 2s infinite;
    }

    .wuxing-node.wood { fill: var(--wood-color); }
    .wuxing-node.fire { fill: var(--fire-color); }
    .wuxing-node.earth { fill: var(--earth-color); }
    .wuxing-node.metal { fill: var(--metal-color); }
    .wuxing-node.water { fill: var(--water-color); }
    .wuxing-node.ti { stroke: #FFD700; stroke-width: 4; }

    .wuxing-node:hover {
      opacity: 0.8;
      cursor: pointer;
      transform: scale(1.1);
    }

    .wuxing-node-text {
      text-anchor: middle;
      font-size: 16px;
      fill: var(--text-color);
    }

    .wuxing-edge-generate {
      stroke: var(--positive-color);
      stroke-width: 2;
    }

    .wuxing-edge-overcome {
      stroke: var(--negative-color);
      stroke-width: 2;
    }

    .wuxing-edge-harmony {
      stroke: var(--secondary-color);
      stroke-width: 2;
    }

    .wuxing-edge-label {
      font-size: 12px;
      fill: var(--text-color);
      text-anchor: middle;
    }

    .score-card {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 10px 0;
      padding: 10px;
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius);
      font-size: 14px;
    }

    .score-bar-wrap {
      flex: 1;
      height: 20px;
      background: #e0e6ed;
      border-radius: 10px;
      overflow: hidden;
    }

    .score-bar {
      height: 100%;
      background: var(--primary-color);
      transition: width 0.5s ease-in-out;
    }

    .score-val {
      font-weight: bold;
      color: var(--positive-color);
      min-width: 40px;
      text-align: right;
    }

    .auspiciousness-index {
      font-size: 18px;
      font-weight: bold;
      margin: 15px 0;
      padding: 10px;
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius);
      text-align: center;
    }

    .auspiciousness-bar {
      height: 20px;
      width: 100%;
      max-width: 400px;
      margin: 10px auto;
      border-radius: var(--border-radius);
      overflow: hidden;
    }

    .line-explanation {
      margin: 15px 0;
      padding: 10px;
      background: var(--background-color);
      border-radius: var(--border-radius);
    }

    .wuxing-controls {
      display: flex;
      gap: 10px;
      margin: 10px 0;
    }

    .tooltip {
      position: absolute;
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: 4px;
      padding: 8px;
      font-size: 12px;
      color: var(--text-color);
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.2s ease;
      max-width: 300px;
      z-index: 1000;
    }

    .tooltip.active {
      opacity: 1;
    }

    .summary-box {
      margin: 20px 0;
      padding: 15px;
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius);
    }

    .summary-box h4 {
      margin-bottom: 10px;
      color: var(--primary-color);
    }

    .summary-box p {
      margin-bottom: 5px;
    }

    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>張老師易經(梅花心易)</h1>
    <h2 id="subtitle" class="subtitle">請選擇取卦方式以開始占卜</h2>
    <div class="tab-buttons">
      <button class="tab-button active" data-target="number">數字取卦</button>
      <button class="tab-button" data-target="manual">手動取卦</button>
      <button class="tab-button" data-target="time">時間取卦</button>
      <button class="tab-button" data-target="image">以象取卦</button>
      <button class="tab-button" data-target="history">歷史記錄</button>
    </div>
    <div id="number" class="tab-content active">
      <div class="row">
        <label>上卦數字(100-999)：</label>
        <input id="numUpper" type="number" min="100" max="999" />
      </div>
      <div class="row">
        <label>下卦數字(100-999)：</label>
        <input id="numLower" type="number" min="100" max="999" />
      </div>
      <div class="row">
        <label>動爻數字(100-999)：</label>
        <input id="numMoving" type="number" min="100" max="999" />
      </div>
      <div class="row">
        <label>問題（可選）：</label>
        <input id="questionNumber" type="text" placeholder="請輸入您的問題" />
      </div>
      <div class="row">
        <button id="btnNumber" class="primary">數字取卦</button>
        <button id="btnRandomNumber" class="primary">亂數取卦</button>
      </div>
      <div class="hint">說明：輸入三組100-999的數字，分別用於計算上卦、下卦與動爻，或點擊「亂數取卦」自動生成數字。數字經模數運算轉換為卦象。</div>
    </div>
    <div id="manual" class="tab-content">
      <div class="row">
        <label>上卦：</label>
        <select id="selUpper">
          <option value="">請選擇</option>
          <option value="1">乾</option>
          <option value="2">兌</option>
          <option value="3">離</option>
          <option value="4">震</option>
          <option value="5">巽</option>
          <option value="6">坎</option>
          <option value="7">艮</option>
          <option value="8">坤</option>
        </select>
      </div>
      <div class="row">
        <label>下卦：</label>
        <select id="selLower">
          <option value="">請選擇</option>
          <option value="1">乾</option>
          <option value="2">兌</option>
          <option value="3">離</option>
          <option value="4">震</option>
          <option value="5">巽</option>
          <option value="6">坎</option>
          <option value="7">艮</option>
          <option value="8">坤</option>
        </select>
      </div>
      <div class="row">
        <label>動爻（1-6，可多選以逗號分隔）：</label>
        <input id="inputMoving" type="text" placeholder="例如：1,3,5" />
      </div>
      <div class="row">
        <label>問題（可選）：</label>
        <input id="questionManual" type="text" placeholder="請輸入您的問題" />
      </div>
      <button id="btnManual" class="primary">手動取卦</button>
      <div class="hint">說明：直接選擇上卦與下卦，並指定動爻（若有）。動爻以逗號分隔輸入，例如“1,3,5”。</div>
    </div>
    <div id="time" class="tab-content">
      <div class="row">
        <label><input type="radio" name="time-method" value="modern" checked /> 現代時間</label>
        <label><input type="radio" name="time-method" value="traditional" /> 傳統時辰</label>
      </div>
      <div id="modern-time-inputs">
        <div class="row">
          <label>日期時間：</label>
          <input id="dtInput" type="datetime-local" />
          <button id="nowQuick" class="primary">現在</button>
        </div>
        <div class="row">
          <label>問題（可選）：</label>
          <input id="questionTime" type="text" placeholder="請輸入您的問題" />
        </div>
      </div>
      <div id="traditional-time-inputs" class="hidden">
        <div class="row">
          <label>日期：</label>
          <input id="dateInput" type="date" />
        </div>
        <div class="row">
          <label>時辰：</label>
          <select id="shichenInput">
            <option value="23">子時 (23:00-01:00)</option>
            <option value="1">丑時 (01:00-03:00)</option>
            <option value="3">寅時 (03:00-05:00)</option>
            <option value="5">卯時 (05:00-07:00)</option>
            <option value="7">辰時 (07:00-09:00)</option>
            <option value="9">巳時 (09:00-11:00)</option>
            <option value="11">午時 (11:00-13:00)</option>
            <option value="13">未時 (13:00-15:00)</option>
            <option value="15">申時 (15:00-17:00)</option>
            <option value="17">酉時 (17:00-19:00)</option>
            <option value="19">戌時 (19:00-21:00)</option>
            <option value="21">亥時 (21:00-23:00)</option>
          </select>
        </div>
        <div class="row">
          <label>分鐘（可選）：</label>
          <input id="minuteInput" type="number" min="0" max="59" />
        </div>
        <div class="row">
          <label>問題（可選）：</label>
          <input id="questionTime" type="text" placeholder="請輸入您的問題" />
        </div>
      </div>
      <button id="btnTime" class="primary">時間取卦</button>
      <div class="hint">說明：現代時間使用年月日時分計算卦象；傳統時辰使用日期與時辰（可選分鐘）。動爻由時間總和決定。</div>
    </div>
    <div id="image" class="tab-content">
      <div class="row">
        <label>上卦（物象）：</label>
        <select id="upperImageSelect">
          <option value="">請選擇</option>
          <option value="1">天、父、金屬</option>
          <option value="2">澤、少女、金屬</option>
          <option value="3">火、中女、電光</option>
          <option value="4">雷、長男、動態</option>
          <option value="5">風、長女、木</option>
          <option value="6">水、中男、液體</option>
          <option value="7">山、少男、石頭</option>
          <option value="8">地、母、土壤</option>
        </select>
      </div>
      <div class="row">
        <label>下卦（方位）：</label>
        <select id="lowerDirectionSelect">
          <option value="">請選擇</option>
          <option value="1">西北</option>
          <option value="2">西</option>
          <option value="3">南</option>
          <option value="4">東</option>
          <option value="5">東南</option>
          <option value="6">北</option>
          <option value="7">東北</option>
          <option value="8">中</option>
        </select>
      </div>
      <div class="row">
        <label><input id="imageUseMinute" type="checkbox" checked /> 使用當前分鐘作為動爻</label>
      </div>
      <div class="row">
        <label>動爻（1-6，若不勾選分鐘）：</label>
        <input id="imageMovingInput" type="number" min="1" max="6" />
      </div>
      <div class="row">
        <label>問題（可選）：</label>
        <input id="questionImage" type="text" placeholder="請輸入您的問題" />
      </div>
      <button id="btnImage" class="primary">以象取卦</button>
      <div class="hint">說明：根據物象選擇上卦，根據方位選擇下卦，動爻可由當前分鐘自動生成或手動輸入。</div>
    </div>
    <div id="history" class="tab-content">
      <div class="row">
        <button id="clearHistoryBtn" class="primary">清除記錄</button>
        <button id="exportHistoryBtn" class="primary">匯出記錄</button>
        <input type="file" id="importHistoryInput" accept=".json" style="padding: 10px;" />
        <button id="importHistoryBtn" class="primary">匯入記錄</button>
      </div>
      <div id="historyList"></div>
      <div class="hint">說明：顯示過去的占卜記錄，點擊可重新載入卦象進行分析。可匯出或匯入記錄（JSON格式）。</div>
    </div>
    <div id="result" class="gua-box hidden">
      <h3 id="resultTitle">占卜結果</h3>
      <div class="row">
        <div>
          <h4>本卦</h4>
          <div id="guaImage" class="gua-display-container"></div>
          <div id="guaName" class="gua-name">未知</div>
        </div>
        <div>
          <h4>互卦</h4>
          <div id="huGuaImage" class="gua-display-container"></div>
          <div id="huGuaName" class="gua-name">未知</div>
        </div>
        <div>
          <h4>變卦</h4>
          <div id="changeGuaImage" class="gua-display-container"></div>
          <div id="changeGuaName" class="gua-name">未知</div>
        </div>
      </div>
      <p id="guaNote"></p>
      <div id="lineExplanation" class="line-explanation"></div>
      <div class="row">
        <button id="judgeBtn" class="primary">五行與象徵</button>
      </div>
      <div id="judgeBox" class="gua-box hidden">
        <h3 id="judgeTitle">五行與象徵</h3>
        <div class="auspiciousness-index">
          <span id="auspiciousnessIndex">吉凶指數：未計算</span>
          <div id="auspiciousnessBar" class="auspiciousness-bar"></div>
        </div>
        <div class="wuxing-controls">
          <button id="downloadSvgBtn" class="primary">下載圖表</button>
          <button id="openSvgWindowBtn" class="primary">在新視窗查看</button>
        </div>
        <div id="wuxingAnalysis">
          <svg id="wuxingSvg" width="600" height="400"></svg>
          <div class="wuxing-box">
            <h4>本卦五行分析</h4>
            <ul>
              <li><strong>本卦上卦（外在環境）：</strong> <span id="mainUpperWuxing"></span> → 體卦（<span id="tiGuaWuxing"></span>）：<span id="mainUpperRelation" class="wuxing-status"></span></li>
              <li><strong>本卦下卦（內在基礎）：</strong> <span id="mainLowerWuxing"></span> → 體卦（<span id="tiGuaWuxing2"></span>）：<span id="mainLowerRelation" class="wuxing-status"></span></li>
            </ul>
          </div>
          <div class="wuxing-box">
            <h4>互卦五行分析</h4>
            <ul>
              <li><strong>互卦上卦（潛在發展）：</strong> <span id="huUpperWuxing"></span> → 體卦（<span id="tiGuaWuxing3"></span>）：<span id="huUpperRelation" class="wuxing-status"></span></li>
              <li><strong>互卦下卦（內在潛力）：</strong> <span id="huLowerWuxing"></span> → 體卦（<span id="tiGuaWuxing4"></span>）：<span id="huLowerRelation" class="wuxing-status"></span></li>
            </ul>
          </div>
          <div class="wuxing-box">
            <h4>變卦五行分析</h4>
            <ul>
              <li><strong>變卦上卦（未來趨勢）：</strong> <span id="changeUpperWuxing"></span> → 體卦（<span id="tiGuaWuxing5"></span>）：<span id="changeUpperRelation" class="wuxing-status"></span></li>
              <li><strong>變卦下卦（變化基礎）：</strong> <span id="changeLowerWuxing"></span> → 體卦（<span id="tiGuaWuxing6"></span>）：<span id="changeLowerRelation" class="wuxing-status"></span></li>
            </ul>
          </div>
          <div class="wuxing-box">
            <h4>建議</h4>
            <div id="wuxingSuggestions"></div>
          </div>
        </div>
        <div id="detailedAnalysis" class="hidden">
          <h4>象徵分析</h4>
          <div id="scoreWrap"></div>
          <div id="movingLineScores" class="moving-line-scores"></div>
        </div>
      </div>
      <div id="summaryBox" class="summary-box hidden">
        <h4>總結</h4>
        <div id="summaryContent"></div>
      </div>
    </div>
  </div>
  <script>
    // 八卦與五行對應及符號
    const TRIGRAM_INFO = {
      1: { name: '乾', wuxing: '金', symbol: '☰', label: '乾卦' },
      2: { name: '兌', wuxing: '金', symbol: '☱', label: '兌卦' },
      3: { name: '離', wuxing: '火', symbol: '☲', label: '離卦' },
      4: { name: '震', wuxing: '木', symbol: '☳', label: '震卦' },
      5: { name: '巽', wuxing: '木', symbol: '☴', label: '巽卦' },
      6: { name: '坎', wuxing: '水', symbol: '☵', label: '坎卦' },
      7: { name: '艮', wuxing: '土', symbol: '☶', label: '艮卦' },
      8: { name: '坤', wuxing: '土', symbol: '☷', label: '坤卦' }
    };

    // 五行生剋關係
    const WUXING_RELATIONS = {
      '木': { generates: '火', overcomes: '土' },
      '火': { generates: '土', overcomes: '金' },
      '土': { generates: '金', overcomes: '水' },
      '金': { generates: '水', overcomes: '木' },
      '水': { generates: '木', overcomes: '火' }
    };

    // 六十四卦名稱
    const HEXAGRAM_NAMES = {
      '11': '乾為天', '12': '天澤履', '13': '天火同人', '14': '天雷無妄', '15': '天風姤', '16': '天水訟', '17': '天山遯', '18': '天地否',
      '21': '澤天夬', '22': '兌為澤', '23': '澤火革', '24': '澤雷隨', '25': '澤風大過', '26': '澤水困', '27': '澤山咸', '28': '澤地萃',
      '31': '火天大有', '32': '火澤睽', '33': '離為火', '34': '火雷噬嗑', '35': '火風鼎', '36': '火水未濟', '37': '火山旅', '38': '火地晉',
      '41': '雷天大壯', '42': '雷澤歸妹', '43': '雷火豐', '44': '震為雷', '45': '雷風恆', '46': '雷水解', '47': '雷山小過', '48': '雷地豫',
      '51': '風天小畜', '52': '風澤中孚', '53': '風火家人', '54': '風雷益', '55': '巽為風', '56': '風水渙', '57': '風山漸', '58': '風地觀',
      '61': '水天需', '62': '水澤節', '63': '水火既濟', '64': '水雷屯', '65': '水風井', '66': '坎為水', '67': '水山蹇', '68': '水地比',
      '71': '山天大畜', '72': '山澤損', '73': '山火賁', '74': '山雷頤', '75': '山風蠱', '76': '山水蒙', '77': '艮為山', '78': '山地剝',
      '81': '地天泰', '82': '地澤臨', '83': '地火明夷', '84': '地雷復', '85': '地風升', '86': '地水師', '87': '地山謙', '88': '坤為地'
    };

    // 五行顏色映射
    const WUXING_COLORS = {
      '木': 'wood', '火': 'fire', '土': 'earth', '金': 'metal', '水': 'water'
    };

    let hexagrams = {}, quotes = [], history = [], currentResult = null, trigramExplanations = null, wuxingExplanations = null;
    let mainUpperGua, mainLowerGua, huUpperGua, huLowerGua, changeUpperGua, changeLowerGua, tiGua, lunarMonth, season, lunarMonthNumber;

    // 八卦線條定義
    const GUA_LINES = {
      '1': [1, 1, 1], // 乾
      '2': [0, 1, 1], // 兌
      '3': [1, 0, 1], // 離
      '4': [0, 0, 1], // 震
      '5': [1, 0, 0], // 巽
      '6': [0, 1, 0], // 坎
      '7': [1, 1, 0], // 艮
      '8': [0, 0, 0]  // 坤
    };

    // 預設 JSON 數據
    const DEFAULT_HEXAGRAMS = {
      '乾為天': {
        name: '乾為天',
        judgment: { text: '元亨利貞', meaning: '大吉大利，堅定正直，宜積極進取。', people: 8, affairs: 9, time: 7, place: 8, object: 7 },
        lines: Array.from({ length: 6 }, (_, i) => ({ index: i + 1, text: '無爻辭', meaning: '無解釋', score: 5 }))
      },
      '天風姤': {
        name: '天風姤',
        judgment: { text: '女壯，勿用取女', meaning: '遇強則慎，宜觀察形勢，勿急進。', people: 5, affairs: 4, time: 5, place: 4, object: 5 },
        lines: Array.from({ length: 6 }, (_, i) => ({ index: i + 1, text: '無爻辭', meaning: '無解釋', score: 5 }))
      }
    };

    const DEFAULT_TRIGRAM_EXPLANATIONS = {
      '1': { people: '領導者、父輩', affairs: '事業大展', time: '秋季或白天', place: '高處或西北', object: '金屬、圓形物品' },
      '2': { people: '少女、喜悅之人', affairs: '交際順利', time: '秋季或傍晚', place: '西方或湖澤', object: '金屬、器皿' },
      '3': { people: '中女、文藝之人', affairs: '文化事業', time: '夏季或中午', place: '南方或明亮處', object: '火、光亮物' },
      '4': { people: '長男、行動之人', affairs: '開創事業', time: '春季或清晨', place: '東方或震動處', object: '雷、木器' },
      '5': { people: '長女、靈活之人', affairs: '靈活應變', time: '春季或清晨', place: '東南或林地', object: '木製品' },
      '6': { people: '中男、智慧之人', affairs: '謀略事業', time: '冬季或夜晚', place: '北方或水域', object: '水、液體' },
      '7': { people: '少男、穩重之人', affairs: '穩固事業', time: '冬季或夜晚', place: '東北或山地', object: '石頭、堅物' },
      '8': { people: '母、包容之人', affairs: '穩定事業', time: '四季末', place: '中央或平地', object: '土壤、布帛' }
    };

    const DEFAULT_WUXING_EXPLANATIONS = {
      '金': {
        description: '代表剛毅、果斷、正義，宜在秋季行動。',
        suggestions: {
          '旺': '金旺，宜果斷行動，展現領導力。',
          '相': '金相，宜穩中求進，借助權威。',
          '休': '金休，宜謹慎，尋求水屬性助力。',
          '囚': '金囚，宜低調，借助土屬性支持。',
          '死': '金死，宜暫緩，尋求水或土助力。'
        }
      },
      '木': {
        description: '代表生機、靈活、成長，宜在春季行動。',
        suggestions: {
          '旺': '木旺，宜拓展創新，抓住生機。',
          '相': '木相，宜穩健發展，尋求水屬性助力。',
          '休': '木休，宜調整策略，借助火屬性支持。',
          '囚': '木囚，宜謹慎，尋求水屬性幫助。',
          '死': '木死，宜等待時機，借助水或火助力。'
        }
      },
      '火': {
        description: '代表熱情、光明、變革，宜在夏季行動。',
        suggestions: {
          '旺': '火旺，宜積極進取，展現熱情。',
          '相': '火相，宜穩健發展，借助木屬性助力。',
          '休': '火休，宜謹慎，尋求土屬性支持。',
          '囚': '火囚，宜低調，借助木屬性幫助。',
          '死': '火死，宜等待時機，借助木或土助力。'
        }
      },
      '土': {
        description: '代表穩重、包容、信任，宜在四季末行動。',
        suggestions: {
          '旺': '土旺，宜穩固基礎，增強信任。',
          '相': '土相，宜穩健發展，借助火屬性助力。',
          '休': '土休，宜謹慎，尋求金屬性支持。',
          '囚': '土囚，宜低調，借助火屬性幫助。',
          '死': '土死，宜等待時機，借助火或金助力。'
        }
      },
      '水': {
        description: '代表智慧、流動、謀略，宜在冬季行動。',
        suggestions: {
          '旺': '水旺，宜靈活謀略，抓住機遇。',
          '相': '水相，宜穩健發展，借助金屬性助力。',
          '休': '水休，宜謹慎，尋求木屬性支持。',
          '囚': '水囚，宜低調，借助金屬性幫助。',
          '死': '水死，宜等待時機，借助金或木助力。'
        }
      }
    };

    const DEFAULT_QUOTES = [
      '易經占卜，洞悉天機，隨心而動。',
      '梅花心易，隨機應變，知進退。',
      '以心觀象，以象求卦，順勢而為。'
    ];

    // 正規化鍵值
    function normalizeKey(key) {
      return key.replace(/\s+/g, '').toLowerCase();
    }

    // 加載資源
    async function loadResources() {
      try {
        const [hexResponse, quotesResponse, trigramResponse, wuxingResponse] = await Promise.all([
          fetch('hexagrams.json').then(res => res.ok ? res.json() : Promise.resolve(DEFAULT_HEXAGRAMS)),
          fetch('quotes.json').then(res => res.ok ? res.json() : Promise.resolve(DEFAULT_QUOTES)),
          fetch('trigram_explanations.json').then(res => res.ok ? res.json() : Promise.resolve(DEFAULT_TRIGRAM_EXPLANATIONS)),
          fetch('wuxing_explanations.json').then(res => res.ok ? res.json() : Promise.resolve(DEFAULT_WUXING_EXPLANATIONS))
        ]);
        hexagrams = Object.fromEntries(
          Object.entries(hexResponse).map(([key, value]) => [normalizeKey(key), {
            name: value.name || key,
            judgment: value.judgment || { text: '無卦辭', meaning: '無解釋', people: 5, affairs: 5, time: 5, place: 5, object: 5 },
            symbolism: value.symbolism || { people: 5, affairs: 5, time: 5, place: 5, object: 5 },
            lines: value.lines || Array.from({ length: 6 }, (_, i) => ({ index: i + 1, text: '無爻辭', meaning: '無解釋', score: 5 }))
          }])
        );
        quotes = Array.isArray(quotesResponse) ? quotesResponse : DEFAULT_QUOTES;
        trigramExplanations = trigramResponse;
        wuxingExplanations = wuxingResponse;
        document.getElementById('subtitle').textContent = quotes[Math.floor(Math.random() * quotes.length)] || '請選擇取卦方式以開始占卜';
      } catch (error) {
        console.error('載入 JSON 檔案失敗，啟用預設數據:', error);
        hexagrams = Object.fromEntries(
          Object.entries(DEFAULT_HEXAGRAMS).map(([key, value]) => [normalizeKey(key), value])
        );
        quotes = DEFAULT_QUOTES;
        trigramExplanations = DEFAULT_TRIGRAM_EXPLANATIONS;
        wuxingExplanations = DEFAULT_WUXING_EXPLANATIONS;
        document.getElementById('subtitle').textContent = quotes[Math.floor(Math.random() * quotes.length)];
      }
    }

    // 農曆計算
    const lunarCalendar = {
      gregorianToLunar: (date) => {
        const month = date.getMonth() + 1;
        const day = date.getDate();
        const lunarMonths = [
          { gregorian: [1, 1, 2, 15], lunarMonth: '臘月', season: '冬', lunarMonthNumber: 12 },
          { gregorian: [2, 16, 3, 15], lunarMonth: '正月', season: '春', lunarMonthNumber: 1 },
          { gregorian: [3, 16, 4, 15], lunarMonth: '二月', season: '春', lunarMonthNumber: 2 },
          { gregorian: [4, 16, 5, 15], lunarMonth: '三月', season: '春', lunarMonthNumber: 3 },
          { gregorian: [5, 16, 6, 15], lunarMonth: '四月', season: '夏', lunarMonthNumber: 4 },
          { gregorian: [6, 16, 7, 15], lunarMonth: '五月', season: '夏', lunarMonthNumber: 5 },
          { gregorian: [7, 16, 8, 15], lunarMonth: '六月', season: '夏', lunarMonthNumber: 6 },
          { gregorian: [8, 16, 9, 15], lunarMonth: '七月', season: '秋', lunarMonthNumber: 7 },
          { gregorian: [9, 16, 10, 15], lunarMonth: '八月', season: '秋', lunarMonthNumber: 8 },
          { gregorian: [10, 16, 11, 15], lunarMonth: '九月', season: '秋', lunarMonthNumber: 9 },
          { gregorian: [11, 16, 12, 15], lunarMonth: '十月', season: '冬', lunarMonthNumber: 10 },
          { gregorian: [12, 16, 12, 31], lunarMonth: '十一月', season: '冬', lunarMonthNumber: 11 }
        ];
        for (const period of lunarMonths) {
          const [startMonth, startDay, endMonth, endDay] = period.gregorian;
          if (
            (month > startMonth || (month === startMonth && day >= startDay)) &&
            (month < endMonth || (month === endMonth && day <= endDay))
          ) {
            return {
              lunarMonth: period.lunarMonth,
              season: period.season,
              lunarMonthNumber: period.lunarMonthNumber
            };
          }
        }
        return { lunarMonth: '七月', season: '秋', lunarMonthNumber: 7 }; // 預設 2025/8/27
      }
    };

    // 五行狀態計算
    function getWuxingStatus(wuxing, lunarMonthNumber) {
      const statuses = {
        '木': { 1: '旺', 2: '旺', 3: '旺', 4: '休', 5: '休', 6: '休', 7: '囚', 8: '囚', 9: '囚', 10: '死', 11: '死', 12: '死' },
        '火': { 1: '死', 2: '相', 3: '相', 4: '旺', 5: '旺', 6: '旺', 7: '休', 8: '休', 9: '休', 10: '囚', 11: '囚', 12: '囚' },
        '土': { 1: '囚', 2: '囚', 3: '旺', 4: '相', 5: '相', 6: '旺', 7: '死', 8: '死', 9: '旺', 10: '休', 11: '休', 12: '旺' },
        '金': { 1: '囚', 2: '囚', 3: '相', 4: '死', 5: '死', 6: '相', 7: '旺', 8: '旺', 9: '旺', 10: '休', 11: '休', 12: '相' },
        '水': { 1: '休', 2: '休', 3: '死', 4: '囚', 5: '囚', 6: '死', 7: '相', 8: '相', 9: '死', 10: '旺', 11: '旺', 12: '旺' }
      };
      return statuses[wuxing]?.[lunarMonthNumber] || '未知';
    }

    function getWuxingStatusScore(wuxing, lunarMonthNumber) {
      switch (getWuxingStatus(wuxing, lunarMonthNumber)) {
        case '旺': return 5;
        case '相': return 3;
        case '休': return 0;
        case '囚': return -3;
        case '死': return -5;
        default: return 0;
      }
    }

    function getWuxingStrength(status) {
      switch (status) {
        case '旺': return 5;
        case '相': return 4;
        case '休': return 3;
        case '囚': return 2;
        case '死': return 1;
        default: return 1;
      }
    }

    // 五行關係計算
    function getRelation(tiWuxing, yongWuxing) {
      if (!tiWuxing || !yongWuxing) return '未知';
      if (tiWuxing === yongWuxing) return '比和';
      if (WUXING_RELATIONS[yongWuxing].generates === tiWuxing) return '用生體';
      if (WUXING_RELATIONS[tiWuxing].generates === yongWuxing) return '體生用';
      if (WUXING_RELATIONS[yongWuxing].overcomes === tiWuxing) return '用剋體';
      if (WUXING_RELATIONS[tiWuxing].overcomes === yongWuxing) return '體剋用';
      return '未知';
    }

    function getRelationScore(relation) {
      switch (relation) {
        case '用生體': return 10;
        case '體剋用': return 3;
        case '比和': return 0;
        case '體生用': return -5;
        case '用剋體': return -10;
        default: return 0;
      }
    }

    // 建議生成（用剋體的情況）
    function getSuggestions(tiWuxing, yongWuxing, relation, lunarMonthNumber) {
      if (relation !== '用剋體') return '';
      const suggestions = [];
      const wuxingStatus = getWuxingStatus(yongWuxing, lunarMonthNumber);
      const wuxingExplanation = wuxingExplanations[yongWuxing]?.suggestions[wuxingStatus] || '無具體建議';

      // 尋求生體之人
      const generateTi = Object.keys(WUXING_RELATIONS).find(w => WUXING_RELATIONS[w].generates === tiWuxing);
      if (generateTi) {
        const guaList = Object.entries(TRIGRAM_INFO)
          .filter(([_, info]) => info.wuxing === generateTi)
          .map(([_, info]) => info.name)
          .join('、');
        suggestions.push(`尋求${generateTi}屬性之人或事物（如${guaList}，${wuxingExplanations[generateTi]?.description || '無描述'}）以增強體卦力量，因為${generateTi}生${tiWuxing}。`);
      }
      // 尋求剋用之人
      const overcomeYong = Object.keys(WUXING_RELATIONS).find(w => WUXING_RELATIONS[w].overcomes === yongWuxing);
      if (overcomeYong) {
        const guaList = Object.entries(TRIGRAM_INFO)
          .filter(([_, info]) => info.wuxing === overcomeYong)
          .map(([_, info]) => info.name)
          .join('、');
        suggestions.push(`尋求${overcomeYong}屬性之人或事物（如${guaList}，${wuxingExplanations[overcomeYong]?.description || '無描述'}）以削弱用卦影響，因為${overcomeYong}剋${yongWuxing}。`);
      }
      // 尋求被用卦生之人
      const generatedByYong = WUXING_RELATIONS[yongWuxing].generates;
      if (generatedByYong) {
        const guaList = Object.entries(TRIGRAM_INFO)
          .filter(([_, info]) => info.wuxing === generatedByYong)
          .map(([_, info]) => info.name)
          .join('、');
        suggestions.push(`尋求${generatedByYong}屬性之人或事物（如${guaList}，${wuxingExplanations[generatedByYong]?.description || '無描述'}）以消耗用卦能量，因為${yongWuxing}生${generatedByYong}。`);
      }
      // 當前季節建議
      suggestions.push(`當前${yongWuxing}狀態：${wuxingStatus}，建議：${wuxingExplanation}`);
      return suggestions.join('<br>');
    }

    // 體用卦判定
    function determineTiYong(moving, upperIdx, lowerIdx) {
      let tiIdx, yongIdx;
      if (moving.length === 0) {
        tiIdx = lowerIdx;
        yongIdx = upperIdx;
      } else {
        const hasLowerMoving = moving.some(idx => idx >= 1 && idx <= 3);
        const hasUpperMoving = moving.some(idx => idx >= 4 && idx <= 6);
        if (hasLowerMoving && !hasUpperMoving) {
          tiIdx = upperIdx;
          yongIdx = lowerIdx;
        } else if (hasUpperMoving && !hasLowerMoving) {
          tiIdx = lowerIdx;
          yongIdx = upperIdx;
        } else {
          tiIdx = lowerIdx;
          yongIdx = upperIdx;
        }
      }
      return { tiGua: TRIGRAM_INFO[tiIdx], yongGua: TRIGRAM_INFO[yongIdx] };
    }

    // 卦象生成
    function generateGua(upperIdx, lowerIdx, moving, method = '未知', timestamp = new Date().toLocaleString('zh-TW')) {
      if (!TRIGRAM_INFO[upperIdx] || !TRIGRAM_INFO[lowerIdx]) {
        alert('無效的卦象輸入，請檢查上卦或下卦！');
        return;
      }

      const upperLines = [...(GUA_LINES[upperIdx] || [0, 0, 0])];
      const lowerLines = [...(GUA_LINES[lowerIdx] || [0, 0, 0])];
      const lines = [...lowerLines, ...upperLines];
      const changeLines = [...lines];
      moving.forEach(idx => {
        if (idx >= 1 && idx <= 6) {
          changeLines[idx - 1] = changeLines[idx - 1] === 1 ? 0 : 1;
        }
      });
      const huLines = [lines[1], lines[2], lines[3], lines[2], lines[3], lines[4]];
      const mainHexName = HEXAGRAM_NAMES[`${upperIdx}${lowerIdx}`] || `${TRIGRAM_INFO[upperIdx].name}${TRIGRAM_INFO[lowerIdx].name}`;
      const changeUpperIdx = Object.keys(GUA_LINES).find(k => GUA_LINES[k].every((v, i) => v === changeLines.slice(3, 6)[i])) || '8';
      const changeLowerIdx = Object.keys(GUA_LINES).find(k => GUA_LINES[k].every((v, i) => v === changeLines.slice(0, 3)[i])) || '8';
      const huUpperIdx = Object.keys(GUA_LINES).find(k => GUA_LINES[k].every((v, i) => v === huLines.slice(3, 6)[i])) || '8';
      const huLowerIdx = Object.keys(GUA_LINES).find(k => GUA_LINES[k].every((v, i) => v === huLines.slice(0, 3)[i])) || '8';
      const changeHexName = HEXAGRAM_NAMES[`${changeUpperIdx}${changeLowerIdx}`] || `${TRIGRAM_INFO[changeUpperIdx].name}${TRIGRAM_INFO[changeLowerIdx].name}`;
      const huHexName = HEXAGRAM_NAMES[`${huUpperIdx}${huLowerIdx}`] || `${TRIGRAM_INFO[huUpperIdx].name}${TRIGRAM_INFO[huLowerIdx].name}`;

      const questionInputs = {
        '數字取卦': 'questionNumber',
        '數字亂數取卦': 'questionNumber',
        '手動取卦': 'questionManual',
        '現代時間取卦': 'questionTime',
        '傳統時辰取卦': 'questionTime',
        '以象取卦': 'questionImage'
      };
      const question = document.getElementById(questionInputs[method])?.value.trim() || '';

      const { tiGua: determinedTiGua, yongGua } = determineTiYong(moving, upperIdx, lowerIdx);

      currentResult = {
        lines,
        changeLines,
        huLines,
        moving,
        hexMain: hexagrams[normalizeKey(mainHexName)] || { name: mainHexName, judgment: { text: '無卦辭', meaning: '無解釋' }, symbolism: { people: 5, affairs: 5, time: 5, place: 5, object: 5 }, lines: [] },
        hexChange: hexagrams[normalizeKey(changeHexName)] || { name: changeHexName, judgment: { text: '無卦辭', meaning: '無解釋' }, symbolism: { people: 5, affairs: 5, time: 5, place: 5, object: 5 }, lines: [] },
        hexHu: hexagrams[normalizeKey(huHexName)] || { name: huHexName, judgment: { text: '無卦辭', meaning: '無解釋' }, symbolism: { people: 5, affairs: 5, time: 5, place: 5, object: 5 }, lines: [] },
        uIdx: upperIdx,
        lIdx: lowerIdx,
        tiGua: determinedTiGua,
        yongGua,
        method,
        timestamp,
        question
      };

      history.push(currentResult);
      localStorage.setItem('guaHistory', JSON.stringify(history));
      renderHistory();

      document.getElementById('result').classList.remove('hidden');
      document.getElementById('guaName').textContent = currentResult.hexMain.name;
      document.getElementById('changeGuaName').textContent = currentResult.hexChange.name;
      document.getElementById('huGuaName').textContent = currentResult.hexHu.name;
      document.getElementById('guaNote').textContent = `本卦：${TRIGRAM_INFO[lowerIdx].name}為下，${TRIGRAM_INFO[upperIdx].name}為上，動爻：${moving.join('、') || '無'}，體卦：${determinedTiGua.name}，用卦：${yongGua.name}，取卦方式：${method}${question ? `，問：${question}` : ''}`;
      document.getElementById('resultTitle').textContent = question || '占卜結果';

      renderGuaImage(lines, 'guaImage', moving);
      renderGuaImage(changeLines, 'changeGuaImage', moving);
      renderGuaImage(huLines, 'huGuaImage');
      renderLineExplanation(moving, currentResult.hexMain, currentResult.hexChange);
    }

    // 渲染卦象
    function renderGuaImage(lines, elementId, moving = []) {
      const container = document.getElementById(elementId);
      container.innerHTML = '';
      [...lines].reverse().forEach((line, idx) => {
        const lineDiv = document.createElement('div');
        lineDiv.className = `gua-line ${line === 0 ? 'yin' : ''} ${moving.includes(6 - idx) ? 'moving' : ''}`;
        container.appendChild(lineDiv);
      });
    }

    // 渲染爻辭解釋
    function renderLineExplanation(moving, mainHex, changeHex) {
      const explanationDiv = document.getElementById('lineExplanation');
      explanationDiv.innerHTML = `
        <div class="line-explanation">
          <p><strong>本卦：${mainHex.name}</strong></p>
          <p><strong>卦辭：</strong> ${mainHex.judgment.text}</p>
          <p><strong>解釋：</strong> ${mainHex.judgment.meaning}</p>
        </div>
      `;
      if (moving.length > 0) {
        moving.forEach(lineIdx => {
          const lineEntry = mainHex.lines.find(line => line.index === lineIdx) || { text: '無爻辭', meaning: '無解釋', score: 5 };
          explanationDiv.innerHTML += `
            <div class="line-explanation">
              <p><strong>第 ${lineIdx} 爻：</strong> ${lineEntry.text}</p>
              <p><strong>解釋：</strong> ${lineEntry.meaning}</p>
            </div>
          `;
        });
      }
      explanationDiv.innerHTML += `
        <div class="line-explanation">
          <p><strong>變卦：${changeHex.name}</strong></p>
          <p><strong>卦辭：</strong> ${changeHex.judgment.text}</p>
          <p><strong>解釋：</strong> ${changeHex.judgment.meaning}</p>
        </div>
      `;
    }

    // 渲染五行分析
    function renderWuxingAnalysis(result) {
      const date = new Date();
      const lunar = lunarCalendar.gregorianToLunar(date);
      lunarMonth = lunar.lunarMonth;
      season = lunar.season;
      lunarMonthNumber = lunar.lunarMonthNumber;

      const upperIdx = result.uIdx;
      const lowerIdx = result.lIdx;
      const moving = result.moving;
      mainUpperGua = { ...TRIGRAM_INFO[upperIdx], label: '本卦上卦' };
      mainLowerGua = { ...TRIGRAM_INFO[lowerIdx], label: '本卦下卦' };
      const { tiGua: determinedTiGua, yongGua } = determineTiYong(moving, upperIdx, lowerIdx);
      tiGua = determinedTiGua;
      const changeUpperIdx = Object.keys(GUA_LINES).find(k => GUA_LINES[k].every((v, i) => v === result.changeLines.slice(3, 6)[i])) || '8';
      const changeLowerIdx = Object.keys(GUA_LINES).find(k => GUA_LINES[k].every((v, i) => v === result.changeLines.slice(0, 3)[i])) || '8';
      const huUpperIdx = Object.keys(GUA_LINES).find(k => GUA_LINES[k].every((v, i) => v === result.huLines.slice(3, 6)[i])) || '8';
      const huLowerIdx = Object.keys(GUA_LINES).find(k => GUA_LINES[k].every((v, i) => v === result.huLines.slice(0, 3)[i])) || '8';
      changeUpperGua = { ...TRIGRAM_INFO[changeUpperIdx], label: '變卦上卦' };
      changeLowerGua = { ...TRIGRAM_INFO[changeLowerIdx], label: '變卦下卦' };
      huUpperGua = { ...TRIGRAM_INFO[huUpperIdx], label: '互卦上卦' };
      huLowerGua = { ...TRIGRAM_INFO[huLowerIdx], label: '互卦下卦' };

      const relations = {
        mainUpper: getRelation(tiGua.wuxing, mainUpperGua.wuxing),
        mainLower: getRelation(tiGua.wuxing, mainLowerGua.wuxing),
        huUpper: getRelation(tiGua.wuxing, huUpperGua.wuxing),
        huLower: getRelation(tiGua.wuxing, huLowerGua.wuxing),
        changeUpper: getRelation(tiGua.wuxing, changeUpperGua.wuxing),
        changeLower: getRelation(tiGua.wuxing, changeLowerGua.wuxing)
      };

      document.getElementById('judgeBox').classList.remove('hidden');
      document.getElementById('mainUpperWuxing').textContent = `${mainUpperGua.name}（${mainUpperGua.wuxing}, ${getWuxingStatus(mainUpperGua.wuxing, lunarMonthNumber)}）`;
      document.getElementById('mainLowerWuxing').textContent = `${mainLowerGua.name}（${mainLowerGua.wuxing}, ${getWuxingStatus(mainLowerGua.wuxing, lunarMonthNumber)}）`;
      document.getElementById('huUpperWuxing').textContent = `${huUpperGua.name}（${huUpperGua.wuxing}, ${getWuxingStatus(huUpperGua.wuxing, lunarMonthNumber)}）`;
      document.getElementById('huLowerWuxing').textContent = `${huLowerGua.name}（${huLowerGua.wuxing}, ${getWuxingStatus(huLowerGua.wuxing, lunarMonthNumber)}）`;
      document.getElementById('changeUpperWuxing').textContent = `${changeUpperGua.name}（${changeUpperGua.wuxing}, ${getWuxingStatus(changeUpperGua.wuxing, lunarMonthNumber)}）`;
      document.getElementById('changeLowerWuxing').textContent = `${changeLowerGua.name}（${changeLowerGua.wuxing}, ${getWuxingStatus(changeLowerGua.wuxing, lunarMonthNumber)}）`;
      ['tiGuaWuxing', 'tiGuaWuxing2', 'tiGuaWuxing3', 'tiGuaWuxing4', 'tiGuaWuxing5', 'tiGuaWuxing6'].forEach(id => {
        document.getElementById(id).textContent = `${tiGua.name}（${tiGua.wuxing}）`;
      });
      Object.entries(relations).forEach(([key, relation]) => {
        const elementId = `${key}Relation`;
        document.getElementById(elementId).textContent = relation;
        document.getElementById(elementId).className = `wuxing-status ${relation.includes('生') ? 'positive' : relation.includes('剋') ? 'negative' : 'neutral'}`;
      });

      const suggestionsDiv = document.getElementById('wuxingSuggestions');
      suggestionsDiv.innerHTML = '';
      Object.entries(relations).forEach(([key, relation]) => {
        const gua = {
          mainUpper: mainUpperGua,
          mainLower: mainLowerGua,
          huUpper: huUpperGua,
          huLower: huLowerGua,
          changeUpper: changeUpperGua,
          changeLower: changeLowerGua
        }[key];
        if (relation === '用剋體') {
          const suggestion = getSuggestions(tiGua.wuxing, gua.wuxing, relation, lunarMonthNumber);
          if (suggestion) {
            suggestionsDiv.innerHTML += `<p><strong>${gua.label}（${gua.name}，${gua.wuxing}）與體卦關係：${relation}</strong><br>${suggestion}</p>`;
          }
        }
      });

      let auspiciousnessScore = 0;
      Object.values(relations).forEach(relation => {
        auspiciousnessScore += getRelationScore(relation);
      });
      auspiciousnessScore += getWuxingStatusScore(tiGua.wuxing, lunarMonthNumber);
      const normalizedScore = Math.max(0, Math.min(100, Math.round((auspiciousnessScore + 50) * 100 / 70)));
      document.getElementById('auspiciousnessIndex').textContent = `吉凶指數：${normalizedScore}%`;
      document.getElementById('auspiciousnessBar').innerHTML = `<div class="score-bar" style="width: ${normalizedScore}%; background: ${normalizedScore >= 50 ? 'var(--positive-color)' : 'var(--negative-color)'};"></div`;

      const scoreWrap = document.getElementById('scoreWrap');
      scoreWrap.innerHTML = `
        <h5>本卦象徵</h5>
        ${renderScoreCard('人事', result.hexMain.symbolism.people, trigramExplanations[result.uIdx]?.people || '無描述')}
        ${renderScoreCard('事業', result.hexMain.symbolism.affairs, trigramExplanations[result.uIdx]?.affairs || '無描述')}
        ${renderScoreCard('時間', result.hexMain.symbolism.time, trigramExplanations[result.uIdx]?.time || '無描述')}
        ${renderScoreCard('地點', result.hexMain.symbolism.place, trigramExplanations[result.uIdx]?.place || '無描述')}
        ${renderScoreCard('物品', result.hexMain.symbolism.object, trigramExplanations[result.uIdx]?.object || '無描述')}
      `;
      document.getElementById('detailedAnalysis').classList.remove('hidden');

      const movingLineScores = document.getElementById('movingLineScores');
      movingLineScores.innerHTML = '';
      result.moving.forEach(lineIdx => {
        const lineEntry = result.hexMain.lines.find(line => line.index === lineIdx) || { score: 5, meaning: '無解釋' };
        movingLineScores.innerHTML += renderScoreCard(`第 ${lineIdx} 爻`, lineEntry.score, lineEntry.meaning);
      });

      renderWuxingDiagram(tiGua, mainUpperGua, mainLowerGua, huUpperGua, huLowerGua, changeUpperGua, changeLowerGua, lunarMonth, season, lunarMonthNumber);
      renderSummary(tiGua, relations);
    }

    // 渲染分數卡片
    function renderScoreCard(label, score, description) {
      const percentage = score * 10;
      return `
        <div class="score-card">
          <span>${label}</span>
          <div class="score-bar-wrap">
            <div class="score-bar" style="width: ${percentage}%"></div>
          </div>
          <span class="score-val">${score}/10</span>
        </div>
        <div class="hint">${description}</div>
      `;
    }

    // 渲染五行圖表
   // 渲染五行圖表（從指定行繼續）
    function renderWuxingDiagram(tiGua, mainUpperGua, mainLowerGua, huUpperGua, huLowerGua, changeUpperGua, changeLowerGua, lunarMonth, season, lunarMonthNumber) {
      const svg = document.getElementById('wuxingSvg');
      svg.innerHTML = `
        <defs>
          <marker id="arrow-generate" viewBox="0 0 10 10" refX="5" refY="5" markerWidth="6" markerHeight="6" orient="auto">
            <path d="M 0 0 L 10 5 L 0 10 z" fill="var(--positive-color)" />
          </marker>
          <marker id="arrow-overcome" viewBox="0 0 10 10" refX="5" refY="5" markerWidth="6" markerHeight="6" orient="auto">
            <path d="M 0 0 L 10 5 L 0 10 z" fill="var(--negative-color)" />
          </marker>
          <marker id="arrow-harmony" viewBox="0 0 10 10" refX="5" refY="5" markerWidth="6" markerHeight="6" orient="auto">
            <path d="M 0 0 L 10 5 L 0 10 z" fill="var(--secondary-color)" />
          </marker>
          <marker id="arrow-harmony-reverse" viewBox="0 0 10 10" refX="5" refY="5" markerWidth="6" markerHeight="6" orient="auto-start-reverse">
            <path d="M 0 0 L 10 5 L 0 10 z" fill="var(--secondary-color)" />
          </marker>
        </defs>
      `;
      const question = currentResult?.question ? `問題：${currentResult.question.slice(0, 30)}${currentResult.question.length > 30 ? '...' : ''}` : '五行生克圖';
      svg.innerHTML += `<text x="300" y="20" text-anchor="middle" font-size="16" font-weight="bold">${question}</text>`;
      const statusText = `農曆：${lunarMonth}（${season}），五行狀態：旺：${Object.keys(TRIGRAM_INFO).find(k => getWuxingStatus(TRIGRAM_INFO[k].wuxing, lunarMonthNumber) === '旺') ? TRIGRAM_INFO[Object.keys(TRIGRAM_INFO).find(k => getWuxingStatus(TRIGRAM_INFO[k].wuxing, lunarMonthNumber) === '旺')].wuxing : '無'}，相：${Object.keys(TRIGRAM_INFO).find(k => getWuxingStatus(TRIGRAM_INFO[k].wuxing, lunarMonthNumber) === '相') ? TRIGRAM_INFO[Object.keys(TRIGRAM_INFO).find(k => getWuxingStatus(TRIGRAM_INFO[k].wuxing, lunarMonthNumber) === '相')].wuxing : '無'}`;
      svg.innerHTML += `<text x="300" y="40" text-anchor="middle" font-size="14">${statusText}</text>`;

      const nodes = [
        { id: 'ti', name: tiGua.name, wuxing: tiGua.wuxing, symbol: tiGua.symbol, x: 300, y: 200, label: '體卦', status: getWuxingStatus(tiGua.wuxing, lunarMonthNumber) },
        { id: 'mainUpper', name: mainUpperGua.name, wuxing: mainUpperGua.wuxing, symbol: mainUpperGua.symbol, x: 150, y: 100, label: '本卦上卦', status: getWuxingStatus(mainUpperGua.wuxing, lunarMonthNumber) },
        { id: 'mainLower', name: mainLowerGua.name, wuxing: mainLowerGua.wuxing, symbol: mainLowerGua.symbol, x: 150, y: 300, label: '本卦下卦', status: getWuxingStatus(mainLowerGua.wuxing, lunarMonthNumber) },
        { id: 'huUpper', name: huUpperGua.name, wuxing: huUpperGua.wuxing, symbol: huUpperGua.symbol, x: 450, y: 100, label: '互卦上卦', status: getWuxingStatus(huUpperGua.wuxing, lunarMonthNumber) },
        { id: 'huLower', name: huLowerGua.name, wuxing: huLowerGua.wuxing, symbol: huLowerGua.symbol, x: 450, y: 300, label: '互卦下卦', status: getWuxingStatus(huLowerGua.wuxing, lunarMonthNumber) },
        { id: 'changeUpper', name: changeUpperGua.name, wuxing: changeUpperGua.wuxing, symbol: changeUpperGua.symbol, x: 600, y: 100, label: '變卦上卦', status: getWuxingStatus(changeUpperGua.wuxing, lunarMonthNumber) },
        { id: 'changeLower', name: changeLowerGua.name, wuxing: changeLowerGua.wuxing, symbol: changeLowerGua.symbol, x: 600, y: 300, label: '變卦下卦', status: getWuxingStatus(changeLowerGua.wuxing, lunarMonthNumber) }
      ];

      nodes.forEach(node => {
        const strokeWidth = getWuxingStrength(node.status);
        const wuxingClass = WUXING_COLORS[node.wuxing] || 'water';
        const tooltipContent = `五行：${node.wuxing} (${node.status})<br>建議：${getSuggestions(tiGua.wuxing, node.wuxing, getRelation(tiGua.wuxing, node.wuxing), lunarMonthNumber) || '無'}`;
        svg.innerHTML += `
          <circle class="wuxing-node ${wuxingClass} ${node.id === 'ti' ? 'ti' : ''}" cx="${node.x}" cy="${node.y}" r="40" stroke-width="${strokeWidth}" data-id="${node.id}" data-tooltip="${tooltipContent.replace(/"/g, '&quot;')}"></circle>
          <text x="${node.x}" y="${node.y - 10}" class="wuxing-node-text">${node.name}</text>
          <text x="${node.x}" y="${node.y + 10}" class="wuxing-node-text">${node.symbol}</text>
          <text x="${node.x}" y="${node.y + 30}" class="wuxing-node-text">${node.label}</text>
        `;
      });

      const edges = [];
      nodes.forEach(node => {
        if (node.id !== 'ti') {
          const relation = getRelation(tiGua.wuxing, node.wuxing);
          let marker = 'arrow-harmony';
          let edgeClass = 'wuxing-edge-harmony';
          if (relation.includes('生')) {
            marker = 'arrow-generate';
            edgeClass = 'wuxing-edge-generate';
          } else if (relation.includes('剋')) {
            marker = 'arrow-overcome';
            edgeClass = 'wuxing-edge-overcome';
          }
          const tiNode = nodes.find(n => n.id === 'ti');
          edges.push({
            from: node.id === 'ti' ? tiNode : node,
            to: node.id === 'ti' ? node : tiNode,
            relation,
            marker,
            edgeClass
          });
        }
      });

      edges.forEach(edge => {
        const dx = edge.to.x - edge.from.x;
        const dy = edge.to.y - edge.from.y;
        const length = Math.sqrt(dx * dx + dy * dy);
        const offset = 40;
        const x1 = edge.from.x + (dx * offset) / length;
        const y1 = edge.from.y + (dy * offset) / length;
        const x2 = edge.to.x - (dx * offset) / length;
        const y2 = edge.to.y - (dy * offset) / length;
        const midX = (x1 + x2) / 2;
        const midY = (y1 + y2) / 2;
        svg.innerHTML += `
          <line class="${edge.edgeClass}" x1="${x1}" y1="${y1}" x2="${x2}" y2="${y2}" marker-end="url(#${edge.marker})"></line>
          <text x="${midX}" y="${midY - 10}" class="wuxing-edge-label">${edge.relation}</text>
        `;
      });

      const tooltip = document.createElement('div');
      tooltip.className = 'tooltip';
      document.body.appendChild(tooltip);

      svg.querySelectorAll('.wuxing-node').forEach(node => {
        node.addEventListener('mousemove', e => {
          tooltip.innerHTML = node.getAttribute('data-tooltip');
          tooltip.classList.add('active');
          tooltip.style.left = `${e.pageX + 10}px`;
          tooltip.style.top = `${e.pageY + 10}px`;
        });
        node.addEventListener('mouseout', () => {
          tooltip.classList.remove('active');
        });
      });
    }

    // 渲染總結
    function renderSummary(tiGua, relations) {
      const summaryDiv = document.getElementById('summaryContent');
      let summary = `<p><strong>總結分析</strong></p>`;
      summary += `<p>體卦（${tiGua.name}, ${tiGua.wuxing}）代表您的核心處境，當前五行狀態：${getWuxingStatus(tiGua.wuxing, lunarMonthNumber)}，${wuxingExplanations[tiGua.wuxing]?.suggestions[getWuxingStatus(tiGua.wuxing, lunarMonthNumber)] || '無建議'}。</p>`;

      const relationSummary = Object.entries(relations).map(([key, relation]) => {
        const gua = {
          mainUpper: mainUpperGua,
          mainLower: mainLowerGua,
          huUpper: huUpperGua,
          huLower: huLowerGua,
          changeUpper: changeUpperGua,
          changeLower: changeLowerGua
        }[key];
        return `<p>${gua.label}（${gua.name}, ${gua.wuxing}）：與體卦關係為${relation}，${relation.includes('剋') ? '需謹慎應對' : relation.includes('生') ? '有利發展' : '保持平衡'}。</p>`;
      }).join('');

      summary += relationSummary;
      summary += `<p>根據${lunarMonth}（${season}），建議您${wuxingExplanations[tiGua.wuxing]?.description || '無描述'}，並留意五行生剋的影響。</p>`;
      summaryDiv.innerHTML = summary;
      document.getElementById('summaryBox').classList.remove('hidden');
    }

    // 數字取卦
    document.getElementById('btnNumber').addEventListener('click', () => {
      const upperNum = parseInt(document.getElementById('numUpper').value);
      const lowerNum = parseInt(document.getElementById('numLower').value);
      const movingNum = parseInt(document.getElementById('numMoving').value);
      if (isNaN(upperNum) || isNaN(lowerNum) || isNaN(movingNum) || upperNum < 100 || upperNum > 999 || lowerNum < 100 || lowerNum > 999 || movingNum < 100 || movingNum > 999) {
        alert('請輸入100-999之間的數字！');
        return;
      }
      const upperIdx = ((upperNum % 8) || 8).toString();
      const lowerIdx = ((lowerNum % 8) || 8).toString();
      const moving = [((movingNum % 6) || 6)];
      generateGua(upperIdx, lowerIdx, moving, '數字取卦');
    });

    // 亂數取卦
    document.getElementById('btnRandomNumber').addEventListener('click', () => {
      const upperNum = Math.floor(Math.random() * 900) + 100;
      const lowerNum = Math.floor(Math.random() * 900) + 100;
      const movingNum = Math.floor(Math.random() * 900) + 100;
      document.getElementById('numUpper').value = upperNum;
      document.getElementById('numLower').value = lowerNum;
      document.getElementById('numMoving').value = movingNum;
      const upperIdx = ((upperNum % 8) || 8).toString();
      const lowerIdx = ((lowerNum % 8) || 8).toString();
      const moving = [((movingNum % 6) || 6)];
      generateGua(upperIdx, lowerIdx, moving, '數字亂數取卦');
    });

    // 手動取卦
    document.getElementById('btnManual').addEventListener('click', () => {
      const upperIdx = document.getElementById('selUpper').value;
      const lowerIdx = document.getElementById('selLower').value;
      const movingInput = document.getElementById('inputMoving').value.trim();
      if (!upperIdx || !lowerIdx) {
        alert('請選擇上卦與下卦！');
        return;
      }
      const moving = movingInput ? movingInput.split(',').map(Number).filter(n => n >= 1 && n <= 6) : [];
      generateGua(upperIdx, lowerIdx, moving, '手動取卦');
    });

    // 時間取卦
    document.getElementById('btnTime').addEventListener('click', () => {
      const method = document.querySelector('input[name="time-method"]:checked').value;
      let date, moving;
      if (method === 'modern') {
        const dtInput = document.getElementById('dtInput').value;
        if (!dtInput) {
          alert('請選擇日期時間！');
          return;
        }
        date = new Date(dtInput);
        if (isNaN(date)) {
          alert('無效的日期時間！');
          return;
        }
        const year = date.getFullYear();
        const month = date.getMonth() + 1;
        const day = date.getDate();
        const hour = date.getHours();
        const minute = date.getMinutes();
        const upperNum = year + month + day;
        const lowerNum = month + day + hour;
        const movingNum = hour + minute;
        const upperIdx = ((upperNum % 8) || 8).toString();
        const lowerIdx = ((lowerNum % 8) || 8).toString();
        moving = [((movingNum % 6) || 6)];
        generateGua(upperIdx, lowerIdx, moving, '現代時間取卦', date.toLocaleString('zh-TW'));
      } else {
        const dateInput = document.getElementById('dateInput').value;
        const shichen = parseInt(document.getElementById('shichenInput').value);
        const minute = parseInt(document.getElementById('minuteInput').value) || 0;
        if (!dateInput) {
          alert('請選擇日期！');
          return;
        }
        date = new Date(dateInput);
        if (isNaN(date)) {
          alert('無效的日期！');
          return;
        }
        const year = date.getFullYear();
        const month = date.getMonth() + 1;
        const day = date.getDate();
        const upperNum = year + month + day;
        const lowerNum = month + day + shichen;
        const movingNum = shichen + minute;
        const upperIdx = ((upperNum % 8) || 8).toString();
        const lowerIdx = ((lowerNum % 8) || 8).toString();
        moving = [((movingNum % 6) || 6)];
        generateGua(upperIdx, lowerIdx, moving, '傳統時辰取卦', `${date.toLocaleDateString('zh-TW')} ${shichen}:00`);
      }
    });

    // 以象取卦
    document.getElementById('btnImage').addEventListener('click', () => {
      const upperIdx = document.getElementById('upperImageSelect').value;
      const lowerIdx = document.getElementById('lowerDirectionSelect').value;
      const useMinute = document.getElementById('imageUseMinute').checked;
      if (!upperIdx || !lowerIdx) {
        alert('請選擇上卦與下卦！');
        return;
      }
      let moving;
      if (useMinute) {
        const minute = new Date().getMinutes();
        moving = [((minute % 6) || 6)];
      } else {
        const movingNum = parseInt(document.getElementById('imageMovingInput').value);
        if (isNaN(movingNum) || movingNum < 1 || movingNum > 6) {
          alert('請輸入有效的動爻（1-6）！');
          return;
        }
        moving = [movingNum];
      }
      generateGua(upperIdx, lowerIdx, moving, '以象取卦');
    });

    // 現在按鈕
    document.getElementById('nowQuick').addEventListener('click', () => {
      const now = new Date();
      document.getElementById('dtInput').value = now.toISOString().slice(0, 16);
    });

    // 切換時間輸入方式
    document.querySelectorAll('input[name="time-method"]').forEach(radio => {
      radio.addEventListener('change', () => {
        const modernInputs = document.getElementById('modern-time-inputs');
        const traditionalInputs = document.getElementById('traditional-time-inputs');
        if (radio.value === 'modern') {
          modernInputs.classList.remove('hidden');
          traditionalInputs.classList.add('hidden');
        } else {
          modernInputs.classList.add('hidden');
          traditionalInputs.classList.remove('hidden');
        }
      });
    });

    // 切換標籤
    document.querySelectorAll('.tab-button').forEach(button => {
      button.addEventListener('click', () => {
        document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
        button.classList.add('active');
        document.getElementById(button.dataset.target).classList.add('active');
      });
    });

    // 五行分析按鈕
    document.getElementById('judgeBtn').addEventListener('click', () => {
      if (currentResult) {
        renderWuxingAnalysis(currentResult);
      }
    });

    // 下載 SVG
    document.getElementById('downloadSvgBtn').addEventListener('click', () => {
      const svg = document.getElementById('wuxingSvg');
      const serializer = new XMLSerializer();
      const source = '<?xml version="1.0" standalone="no"?>\r\n' + serializer.serializeToString(svg);
      const blob = new Blob([source], { type: 'image/svg+xml;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = 'wuxing_diagram.svg';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
    });

    // 在新視窗查看 SVG
    document.getElementById('openSvgWindowBtn').addEventListener('click', () => {
      const svg = document.getElementById('wuxingSvg');
      const serializer = new XMLSerializer();
      const source = '<?xml version="1.0" standalone="no"?>\r\n' + serializer.serializeToString(svg);
      const blob = new Blob([source], { type: 'image/svg+xml;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const newWindow = window.open(url);
      setTimeout(() => URL.revokeObjectURL(url), 1000);
    });

    // 渲染歷史記錄
    function renderHistory() {
      const historyList = document.getElementById('historyList');
      historyList.innerHTML = '';
      history.forEach((entry, index) => {
        const div = document.createElement('div');
        div.className = 'gua-box';
        div.innerHTML = `
          <p><strong>記錄 ${index + 1} (${entry.timestamp})</strong></p>
          <p>本卦：${entry.hexMain.name}，動爻：${entry.moving.join('、') || '無'}，體卦：${entry.tiGua.name}，用卦：${entry.yongGua.name}</p>
          ${entry.question ? `<p>問題：${entry.question}</p>` : ''}
          <button class="primary" onclick="loadHistory(${index})">重新載入</button>
        `;
        historyList.appendChild(div);
      });
    }

    // 載入歷史記錄
    window.loadHistory = function(index) {
      currentResult = history[index];
      document.getElementById('result').classList.remove('hidden');
      document.getElementById('guaName').textContent = currentResult.hexMain.name;
      document.getElementById('changeGuaName').textContent = currentResult.hexChange.name;
      document.getElementById('huGuaName').textContent = currentResult.hexHu.name;
      document.getElementById('guaNote').textContent = `本卦：${TRIGRAM_INFO[currentResult.lIdx].name}為下，${TRIGRAM_INFO[currentResult.uIdx].name}為上，動爻：${currentResult.moving.join('、') || '無'}，體卦：${currentResult.tiGua.name}，用卦：${currentResult.yongGua.name}，取卦方式：${currentResult.method}${currentResult.question ? `，問：${currentResult.question}` : ''}`;
      document.getElementById('resultTitle').textContent = currentResult.question || '占卜結果';
      renderGuaImage(currentResult.lines, 'guaImage', currentResult.moving);
      renderGuaImage(currentResult.changeLines, 'changeGuaImage', currentResult.moving);
      renderGuaImage(currentResult.huLines, 'huGuaImage');
      renderLineExplanation(currentResult.moving, currentResult.hexMain, currentResult.hexChange);
      document.getElementById('judgeBox').classList.add('hidden');
      document.getElementById('summaryBox').classList.add('hidden');
    };

    // 清除歷史記錄
    document.getElementById('clearHistoryBtn').addEventListener('click', () => {
      if (confirm('確定要清除所有歷史記錄？')) {
        history = [];
        localStorage.removeItem('guaHistory');
        renderHistory();
      }
    });

    // 匯出歷史記錄
    document.getElementById('exportHistoryBtn').addEventListener('click', () => {
      const blob = new Blob([JSON.stringify(history, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = 'gua_history.json';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
    });

    // 匯入歷史記錄
    document.getElementById('importHistoryBtn').addEventListener('click', () => {
      const fileInput = document.getElementById('importHistoryInput');
      const file = fileInput.files[0];
      if (!file) {
        alert('請選擇一個 JSON 檔案！');
        return;
      }
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const importedHistory = JSON.parse(e.target.result);
          if (Array.isArray(importedHistory)) {
            history = importedHistory;
            localStorage.setItem('guaHistory', JSON.stringify(history));
            renderHistory();
            alert('歷史記錄匯入成功！');
          } else {
            alert('無效的歷史記錄格式！');
          }
        } catch (error) {
          alert('匯入失敗：無效的 JSON 檔案！');
        }
      };
      reader.readAsText(file);
    });

    // 初始化
    document.addEventListener('DOMContentLoaded', () => {
      loadResources();
      const savedHistory = localStorage.getItem('guaHistory');
      if (savedHistory) {
        history = JSON.parse(savedHistory);
        renderHistory();
      }
    });
  </script>
</body>
</html>
