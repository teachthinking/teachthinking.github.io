<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>梅花易數卜卦系統 - 尋找遺失物或人物</title>
    <style>
        /* CSS 樣式 */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f4f4f9;
            color: #333;
            margin: 0;
            padding: 20px;
            line-height: 1.6;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        h1, h2, h3 {
            color: #4a4a4a;
        }
        section {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, select, textarea {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        button {
            background-color: #5cb85c;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #4cae4c;
        }
        #result {
            margin-top: 20px;
            padding: 15px;
            background: #e9ffe9;
            border: 1px solid #5cb85c;
            border-radius: 4px;
        }
        .hexagram {
            font-size: 2em;
            text-align: center;
            margin: 10px 0;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>梅花易數卜卦系統 - 專為尋找遺失物或人物</h1>
        
        <!-- A. 卜卦起始：選擇占測目標 -->
        <section id="target-selection">
            <h2>您想要占測什麼？</h2>
            <select id="target-type">
                <option value="">請選擇</option>
                <option value="lost-item">尋找遺失物</option>
                <option value="lost-person">尋找人物</option>
                <option value="other">其他</option>
            </select>
        </section>
        
        <!-- B. 步驟一：選擇起卦方式 -->
        <section id="divination-method" class="hidden">
            <h2>請選擇一種起卦方式</h2>
            <select id="method">
                <option value="">請選擇</option>
                <option value="time">時間起卦</option>
                <option value="number">數字起卦</option>
                <option value="manual">手動輸入卦象</option>
            </select>
            
            <!-- 時間起卦輸入 -->
            <div id="time-input" class="hidden">
                <label>公曆年 (YYYY):</label>
                <input type="number" id="year" min="1900" max="2100">
                <label>公曆月 (1-12):</label>
                <input type="number" id="month" min="1" max="12">
                <label>公曆日 (1-31):</label>
                <input type="number" id="day" min="1" max="31">
                <label>時辰 (子=1, 丑=2, ..., 亥=12):</label>
                <input type="number" id="hour" min="1" max="12">
            </div>
            
            <!-- 數字起卦輸入 -->
            <div id="number-input" class="hidden">
                <label>第一個數字 (三位數或任意):</label>
                <input type="number" id="num1">
                <label>第二個數字:</label>
                <input type="number" id="num2">
                <label>第三個數字:</label>
                <input type="number" id="num3">
            </div>
            
            <!-- 手動輸入卦象 -->
            <div id="manual-input" class="hidden">
                <label>上卦:</label>
                <select id="upper-trigram">
                    <option value="1">乾</option>
                    <option value="2">兌</option>
                    <option value="3">離</option>
                    <option value="4">震</option>
                    <option value="5">巽</option>
                    <option value="6">坎</option>
                    <option value="7">艮</option>
                    <option value="8">坤</option>
                </select>
                <label>下卦:</label>
                <select id="lower-trigram">
                    <option value="1">乾</option>
                    <option value="2">兌</option>
                    <option value="3">離</option>
                    <option value="4">震</option>
                    <option value="5">巽</option>
                    <option value="6">坎</option>
                    <option value="7">艮</option>
                    <option value="8">坤</option>
                </select>
                <label>動爻 (1-6):</label>
                <input type="number" id="moving-line" min="1" max="6">
            </div>
        </section>
        
        <!-- C. 步驟二：輸入欲尋目標的詳細屬性 -->
        <section id="target-details" class="hidden">
            <h2>請提供更多關於您要尋找的細節</h2>
            
            <!-- 遺失物細節 -->
            <div id="lost-item-details" class="hidden">
                <label>物品類別 (多選):</label>
                <select id="item-category" multiple>
                    <option value="貴重物品">貴重物品 (金、玉等)</option>
                    <option value="文書/電子產品">文書/電子產品</option>
                    <option value="金屬製品">金屬製品</option>
                    <option value="木製品">木製品</option>
                    <option value="土器瓦器/陶瓷">土器瓦器/陶瓷</option>
                    <option value="布料/衣物">布料/衣物</option>
                    <option value="水相關物品">水相關物品</option>
                    <option value="其他">其他</option>
                </select>
                <label>顏色:</label>
                <select id="item-color">
                    <option value="">無</option>
                    <option value="紅">紅</option>
                    <option value="黃">黃</option>
                    <option value="藍">藍</option>
                    <option value="綠">綠</option>
                    <option value="白">白</option>
                    <option value="黑">黑</option>
                    <option value="紫">紫</option>
                </select>
                <label>形狀:</label>
                <input type="text" id="item-shape" placeholder="圓形、方形等">
                <label>材質:</label>
                <input type="text" id="item-material" placeholder="金屬、木等">
                <label>其他特徵:</label>
                <textarea id="item-other" placeholder="大小、新舊等"></textarea>
            </div>
            
            <!-- 人物細節 -->
            <div id="lost-person-details" class="hidden">
                <label>與占卜者的關係:</label>
                <select id="person-relation">
                    <option value="">無</option>
                    <option value="家人">家人</option>
                    <option value="朋友">朋友</option>
                    <option value="同事">同事</option>
                    <option value="陌生人">陌生人</option>
                    <option value="嫌犯">嫌犯</option>
                    <option value="被害人">被害人</option>
                </select>
                <label>性別:</label>
                <select id="person-gender">
                    <option value="">無</option>
                    <option value="男">男</option>
                    <option value="女">女</option>
                </select>
                <label>年齡範圍:</label>
                <select id="person-age">
                    <option value="">無</option>
                    <option value="幼童">幼童</option>
                    <option value="少年">少年</option>
                    <option value="青年">青年</option>
                    <option value="中年">中年</option>
                    <option value="老年">老年</option>
                </select>
                <label>外貌特徵:</label>
                <textarea id="person-appearance" placeholder="身高、體型等"></textarea>
                <label>行為模式:</label>
                <input type="text" id="person-behavior" placeholder="靜止、活躍等">
                <label>職業/身份:</label>
                <input type="text" id="person-occupation" placeholder="官貴、農夫等">
                <label>失蹤前情況:</label>
                <textarea id="person-situation"></textarea>
            </div>
        </section>
        
        <!-- D. 步驟三：占卜時外應記錄 -->
        <section id="external-response" class="hidden">
            <h2>占卜時外應記錄 (選填)</h2>
            <textarea id="external-desc" placeholder="描述周遭特別事件，如狗叫、紅色物體等"></textarea>
        </section>
        
        <button id="start-divination">開始卜卦</button>
        
        <!-- E. 卜卦結果顯示 -->
        <section id="result" class="hidden">
            <h2>卜卦結果</h2>
            <div id="hexagram-display"></div>
            <div id="interpretation"></div>
        </section>
        
        <!-- F. 進階應用 -->
        <section id="advanced" class="hidden">
            <h2>進階功能</h2>
            <button id="view-cases">查看卦例庫</button>
            <div id="case-studies"></div>
            <button id="view-basics">梅花易數基礎知識</button>
            <div id="basics-info"></div>
            <button id="save-record">儲存卜卦記錄</button>
            <button id="load-record">載入卜卦記錄</button>
        </section>
    </div>

    <script>
        // JavaScript 核心邏輯

        // A. 資料載入模組
        let data = {};
        async function loadData() {
            const files = [
                'trigrams.json',
                'five_elements_relations.json',
                'trigram_properties.json',
                'seasonal_strength.json',
                'directions.json',
                'gua_texts.json',
                'case_studies.json'
            ];
            for (let file of files) {
                try {
                    const response = await fetch(`data/${file}`);
                    data[file.split('.')[0]] = await response.json();
                } catch (error) {
                    console.error(`載入 ${file} 失敗:`, error);
                }
            }
            console.log('所有數據載入完成');
        }

        // B. 起卦引擎
        function generateHexagram(method) {
            let upper, lower, moving;
            if (method === 'time') {
                const year = parseInt(document.getElementById('year').value);
                const month = parseInt(document.getElementById('month').value);
                const day = parseInt(document.getElementById('day').value);
                const hour = parseInt(document.getElementById('hour').value);
                // 簡化：假設輸入為農曆或直接使用公曆計算 (實際需公曆轉農曆邏輯，但這裡簡化)
                const sum1 = year % 12 + month + day; // 年數簡化為 year % 12 +1
                upper = (sum1 % 8) || 8;
                const sum2 = sum1 + hour;
                lower = (sum2 % 8) || 8;
                moving = (sum2 % 6) || 6;
            } else if (method === 'number') {
                const num1 = parseInt(document.getElementById('num1').value);
                const num2 = parseInt(document.getElementById('num2').value);
                const num3 = parseInt(document.getElementById('num3').value);
                upper = (num1 % 8) || 8;
                lower = (num2 % 8) || 8;
                moving = (num3 % 6) || 6;
            } else if (method === 'manual') {
                upper = parseInt(document.getElementById('upper-trigram').value);
                lower = parseInt(document.getElementById('lower-trigram').value);
                moving = parseInt(document.getElementById('moving-line').value);
            }
            return { upper, lower, moving };
        }

        // C. 卦象解析與轉換模組
        function parseHexagram(upper, lower, moving) {
            const upperTrigram = data.trigrams[upper];
            const lowerTrigram = data.trigrams[lower];
            const baseHexagram = `${upperTrigram.name}為上，${lowerTrigram.name}為下`; // 簡化卦名
            // 互卦：上卦下二爻 + 下卦上二爻 + 中間交叉 (簡化邏輯)
            const mutualUpper = (upper % 8 + 1); // placeholder
            const mutualLower = (lower % 8 + 1); // 需實作完整互卦邏輯
            const mutual = { upper: mutualUpper, lower: mutualLower };
            // 變卦：動爻變陰陽反轉
            const changedLower = lower; // 需根據moving計算變卦
            const changed = { upper, lower: changedLower };
            return { base: {upper, lower}, mutual, changed, moving };
        }

        // D. 梅花易數解卦引擎
        function interpretHexagram(hexagram, targetType, targetDetails, external) {
            const { base, mutual, changed, moving } = hexagram;
            const bodyTrigram = base.lower; // 假設下卦為體
            const useTrigram = base.upper; // 上卦為用

            // 體用關係
            const bodyElement = data.trigrams[bodyTrigram].five_element;
            const useElement = data.trigrams[useTrigram].five_element;
            let relation = '未知';
            if (data.five_elements_relations.相生[useElement] === bodyElement) relation = '用生體 (吉)';
            else if (data.five_elements_relations.相生[bodyElement] === useElement) relation = '體生用 (凶)';
            else if (data.five_elements_relations.相剋[useElement] === bodyElement) relation = '用剋體 (凶)';
            else if (data.five_elements_relations.相剋[bodyElement] === useElement) relation = '體剋用 (吉)';
            else if (bodyElement === useElement) relation = '比和 (吉)';

            // 卦氣旺衰
            const currentDate = new Date();
            const season = getSeason(currentDate); // 需實作getSeason函數
            const strength = data.seasonal_strength[season] || {};
            const baseStrength = strength.旺.includes(data.trigrams[base.upper].name) ? '旺' : '衰';

            // 萬物屬類匹配
            const props = data.trigram_properties[data.trigrams[changed.upper].name] || {};
            let clues = '';
            if (targetType === 'lost-item') {
                clues = props.尋物線索 || '無特定線索';
                // 匹配用戶輸入
                if (targetDetails.color && props.顏色.includes(targetDetails.color)) clues += ` 匹配顏色: ${targetDetails.color}`;
            } else if (targetType === 'lost-person') {
                clues = props.尋人線索 || '無特定線索';
                // 匹配年齡、性別等
            }

            // 方位
            const mainDirection = data.directions[data.trigrams[changed.upper].name];

            // 應期預測 (簡化)
            const period = '數日內'; // 基於動爻等計算

            // 外應
            const externalInterp = external ? `外應解讀: ${external} 可能表示吉兆` : '無外應';

            // 綜合結果
            let result = `
                <h3>卦象顯示</h3>
                <div class="hexagram">${data.trigrams[base.upper].symbol} 上卦: ${data.trigrams[base.upper].name}</div>
                <div class="hexagram">${data.trigrams[base.lower].symbol} 下卦: ${data.trigrams[base.lower].name}</div>
                <p>動爻: ${moving}</p>
                <h3>總論</h3>
                <p>體用關係: ${relation}</p>
                <p>卦氣: ${baseStrength}</p>
                <h3>方位指引</h3>
                <p>主要方向: ${mainDirection}</p>
                <h3>環境/人物線索</h3>
                <p>${clues}</p>
                <h3>應期預測</h3>
                <p>${period}</p>
                <h3>外應</h3>
                <p>${externalInterp}</p>
            `;
            if (data.gua_texts) {
                result += `<h3>卦辭參考</h3><p>${data.gua_texts[base.upper + base.lower] || '無'}</p>`;
            }
            return result;
        }

        // 輔助函數：獲取季節 (簡化)
        function getSeason(date) {
            const month = date.getMonth() + 1;
            if ([3,4,5].includes(month)) return '春';
            if ([6,7,8].includes(month)) return '夏';
            if ([9,10,11].includes(month)) return '秋';
            if ([12,1,2].includes(month)) return '冬';
            return '季月';
        }

        // 事件監聽
        document.addEventListener('DOMContentLoaded', () => {
            loadData();

            const targetSelect = document.getElementById('target-type');
            targetSelect.addEventListener('change', (e) => {
                document.getElementById('divination-method').classList.remove('hidden');
                const type = e.target.value;
                if (type === 'lost-item') {
                    document.getElementById('lost-item-details').classList.remove('hidden');
                    document.getElementById('lost-person-details').classList.add('hidden');
                } else if (type === 'lost-person') {
                    document.getElementById('lost-person-details').classList.remove('hidden');
                    document.getElementById('lost-item-details').classList.add('hidden');
                } else {
                    document.getElementById('lost-item-details').classList.add('hidden');
                    document.getElementById('lost-person-details').classList.add('hidden');
                }
                document.getElementById('target-details').classList.remove('hidden');
                document.getElementById('external-response').classList.remove('hidden');
                document.getElementById('advanced').classList.remove('hidden');
            });

            const methodSelect = document.getElementById('method');
            methodSelect.addEventListener('change', (e) => {
                const method = e.target.value;
                document.getElementById('time-input').classList.add('hidden');
                document.getElementById('number-input').classList.add('hidden');
                document.getElementById('manual-input').classList.add('hidden');
                if (method) document.getElementById(`${method}-input`).classList.remove('hidden');
            });

            document.getElementById('start-divination').addEventListener('click', () => {
                const method = document.getElementById('method').value;
                if (!method) return alert('請選擇起卦方式');
                const hex = generateHexagram(method);
                const parsed = parseHexagram(hex.upper, hex.lower, hex.moving);
                const targetType = document.getElementById('target-type').value;
                let targetDetails = {};
                if (targetType === 'lost-item') {
                    targetDetails = {
                        category: Array.from(document.getElementById('item-category').selectedOptions).map(o => o.value),
                        color: document.getElementById('item-color').value,
                        shape: document.getElementById('item-shape').value,
                        material: document.getElementById('item-material').value,
                        other: document.getElementById('item-other').value
                    };
                } else if (targetType === 'lost-person') {
                    targetDetails = {
                        relation: document.getElementById('person-relation').value,
                        gender: document.getElementById('person-gender').value,
                        age: document.getElementById('person-age').value,
                        appearance: document.getElementById('person-appearance').value,
                        behavior: document.getElementById('person-behavior').value,
                        occupation: document.getElementById('person-occupation').value,
                        situation: document.getElementById('person-situation').value
                    };
                }
                const external = document.getElementById('external-desc').value;
                const interp = interpretHexagram(parsed, targetType, targetDetails, external);
                document.getElementById('interpretation').innerHTML = interp;
                document.getElementById('result').classList.remove('hidden');
            });

            // 卦例庫
            document.getElementById('view-cases').addEventListener('click', () => {
                let cases = '';
                for (let key in data.case_studies) {
                    cases += `<p>${key}: ${data.case_studies[key]}</p>`;
                }
                document.getElementById('case-studies').innerHTML = cases;
            });

            // 基礎知識 (假設內嵌或從JSON)
            document.getElementById('view-basics').addEventListener('click', () => {
                document.getElementById('basics-info').innerHTML = '八卦基礎: 乾為天... (詳細內容從JSON載入)';
            });

            // 本地儲存
            document.getElementById('save-record').addEventListener('click', () => {
                const record = { /* 收集所有輸入 */ };
                localStorage.setItem('divination-record', JSON.stringify(record));
            });

            document.getElementById('load-record').addEventListener('click', () => {
                const record = JSON.parse(localStorage.getItem('divination-record'));
                if (record) {
                    // 填充輸入欄位
                }
            });
        });
    </script>
</body>
</html>
