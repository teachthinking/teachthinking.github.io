<html lang="zh-TW">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>張老師易經(梅花心易)</title>
  <style>
   :root {
    --primary-color: #2c3e50;
    --secondary-color: #3498db;
    --negative-color: #e74c3c;
    --positive-color: #4caf50;
    --yellow-color: #f1c40f;
    --background-color: #f4f7f9;
    --card-bg: #ffffff;
    --border-color: #e0e6ed;
    --text-color: #333333;
    --sub-text-color: #7f8c8d;
    --shadow-light: 0 4px 12px rgba(0, 0, 0, 0.05);
    --border-radius: 12px;
    --font-family: 'Noto Sans TC', sans-serif;
    --wood-color: #27ae60;
    --fire-color: #e74c3c;
    --earth-color: #f1c40f;
    --metal-color: #bdc3c7;
    --water-color: #3498db;
  }

    body {
      font-family: var(--font-family);
      background: var(--background-color);
      color: var(--text-color);
      padding: 20px;
      line-height: 1.6;
      margin: 0;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: var(--card-bg);
      padding: 25px;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow-light);
    }

    h1 {
      margin: 0 0 8px 0;
      font-size: 28px;
      color: var(--primary-color);
    }

    h2.subtitle {
      margin: 0 0 20px 0;
      color: var(--sub-text-color);
      font-weight: 400;
      font-size: 16px;
      border-bottom: 1px solid var(--border-color);
      padding-bottom: 15px;
    }

    .tab-buttons {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }

    .tab-button {
      padding: 10px 18px;
      border-radius: var(--border-radius);
      border: 1px solid var(--border-color);
      background: transparent;
      cursor: pointer;
      color: var(--sub-text-color);
      transition: all 0.3s ease;
      font-size: 15px;
    }

    .tab-button.active {
      background: var(--primary-color);
      color: #fff;
      border-color: var(--primary-color);
    }

    .tab-content {
      display: none;
      padding-top: 10px;
    }

    .tab-content.active {
      display: block;
    }

    .row {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
      margin: 12px 0;
    }

    .hint {
      font-size: 13px;
      color: var(--sub-text-color);
      line-height: 1.5;
    }

    .gua-box {
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius);
      padding: 20px;
      background: var(--background-color);
      margin-bottom: 20px;
    }

    .hidden {
      display: none;
    }

    button.primary {
      background: var(--primary-color);
      color: #fff;
      border: none;
      padding: 10px 20px;
      border-radius: var(--border-radius);
      cursor: pointer;
      transition: background 0.3s ease;
    }

    button.primary:hover {
      background: var(--secondary-color);
    }

    input, select {
      padding: 8px;
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius);
      font-size: 14px;
    }

    .gua-display-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin: 10px 0;
    }

    .gua-line {
      width: 60px;
      height: 10px;
      margin: 5px 0;
      background: var(--text-color);
      position: relative;
    }

    .gua-line.yin::after {
      content: '';
      position: absolute;
      width: 20px;
      height: 10px;
      background: var(--card-bg);
      left: 20px;
    }

    .gua-line.moving::before {
      content: '×';
      position: absolute;
      color: var(--negative-color);
      font-size: 16px;
      left: -20px;
      top: -3px;
    }

    .gua-name {
      margin-top: 10px;
      font-weight: bold;
      font-size: 16px;
      color: var(--primary-color);
      text-align: center;
    }

    .wuxing-box {
      margin: 15px 0;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      max-width: 600px;
    }

    .wuxing-box ul {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .wuxing-box li {
      flex: 1 1 calc(50% - 10px);
      min-width: 280px;
      padding: 10px;
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius);
      background: var(--card-bg);
    }

    .wuxing-status {
      font-weight: bold;
    }

    .wuxing-status.positive { color: var(--positive-color); }
    .wuxing-status.neutral { color: var(--secondary-color); }
    .wuxing-status.negative { color: var(--negative-color); }

    .wuxing-node {
      stroke: var(--primary-color);
      stroke-width: 2;
    }

    .wuxing-node.木 {
      fill: var(--wood-color);
    }
    .wuxing-node.火 {
      fill: var(--fire-color);
    }
    .wuxing-node.土 {
      fill: var(--earth-color);
    }
    .wuxing-node.金 {
      fill: var(--metal-color);
    }
    .wuxing-node.水 {
      fill: var(--water-color);
    }

    .wuxing-node:hover {
      opacity: 0.8;
      cursor: pointer;
    }

    .wuxing-node-text {
      text-anchor: middle;
      font-size: 12px;
      fill: var(--text-color);
    }

    .wuxing-edge-generate {
      stroke: var(--positive-color);
    }

    .wuxing-edge-overcome {
      stroke: var(--negative-color);
    }

    .wuxing-edge-harmony {
      stroke: var(--secondary-color);
    }

    .wuxing-edge-label {
      font-size: 10px;
      fill: var(--text-color);
      text-anchor: middle;
    }

    .score-card {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 10px 0;
      padding: 10px;
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius);
      font-size: 14px;
    }

    .score-bar-wrap {
      flex: 1;
      height: 20px;
      background: #e0e6ed;
      border-radius: 10px;
      overflow: hidden;
    }

    .score-bar {
      height: 100%;
      transition: width 0.3s ease;
    }

    .auspiciousness-index {
      font-size: 18px;
      font-weight: bold;
      margin: 15px 0;
      padding: 10px;
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius);
      text-align: center;
    }

    .auspiciousness-bar {
      height: 20px;
      width: 100%;
      max-width: 400px;
      margin: 10px auto;
      border-radius: var(--border-radius);
      overflow: hidden;
    }

    .line-explanation {
      margin: 15px 0;
      padding: 10px;
      background: var(--background-color);
      border-radius: var(--border-radius);
    }

    .wuxing-controls {
      display: flex;
      gap: 10px;
      margin: 10px 0;
    }
    .wuxing-box p {
      margin: 8px 0;
      font-size: 14px;
      line-height: 1.6;
    }
    .wuxing-box h4 {
      margin: 15px 0 10px;
      font-size: 16px;
      color: var(--primary-color);
    }
    .wuxing-box strong {
      color: var(--text-color);
      font-weight: 600;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>張老師易經(梅花心易)</h1>
    <h2 id="subtitle" class="subtitle">請選擇取卦方式以開始占卜</h2>
    <div class="tab-buttons">
      <button class="tab-button active" data-target="number">數字取卦</button>
      <button class="tab-button" data-target="manual">手動取卦</button>
      <button class="tab-button" data-target="time">時間取卦</button>
      <button class="tab-button" data-target="image">以象取卦</button>
      <button class="tab-button" data-target="history">歷史記錄</button>
    </div>
    <div id="number" class="tab-content active">
      <div class="row">
        <label>上卦數字(100-999)：</label>
        <input id="numUpper" type="number" min="100" max="999" />
      </div>
      <div class="row">
        <label>下卦數字(100-999)：</label>
        <input id="numLower" type="number" min="100" max="999" />
      </div>
      <div class="row">
        <label>動爻數字(100-999)：</label>
        <input id="numMoving" type="number" min="100" max="999" />
      </div>
      <div class="row">
        <label>問題（可選）：</label>
        <input id="questionNumber" type="text" placeholder="請輸入您的問題" />
      </div>
      <div class="row">
        <button id="btnNumber" class="primary">數字取卦</button>
        <button id="btnRandomNumber" class="primary">亂數取卦</button>
      </div>
      <div class="hint">說明：輸入三組100-999的數字，分別用於計算上卦、下卦與動爻，或點擊「亂數取卦」自動生成數字。數字經模數運算轉換為卦象。</div>
    </div>
    <div id="manual" class="tab-content">
      <div class="row">
        <label>上卦：</label>
        <select id="selUpper">
          <option value="">請選擇</option>
          <option value="1">乾</option>
          <option value="2">兌</option>
          <option value="3">離</option>
          <option value="4">震</option>
          <option value="5">巽</option>
          <option value="6">坎</option>
          <option value="7">艮</option>
          <option value="8">坤</option>
        </select>
      </div>
      <div class="row">
        <label>下卦：</label>
        <select id="selLower">
          <option value="">請選擇</option>
          <option value="1">乾</option>
          <option value="2">兌</option>
          <option value="3">離</option>
          <option value="4">震</option>
          <option value="5">巽</option>
          <option value="6">坎</option>
          <option value="7">艮</option>
          <option value="8">坤</option>
        </select>
      </div>
      <div class="row">
        <label>動爻（1-6，可多選以逗號分隔）：</label>
        <input id="inputMoving" type="text" placeholder="例如：1,3,5" />
      </div>
      <div class="row">
        <label>問題（可選）：</label>
        <input id="questionManual" type="text" placeholder="請輸入您的問題" />
      </div>
      <button id="btnManual" class="primary">手動取卦</button>
      <div class="hint">說明：直接選擇上卦與下卦，並指定動爻（若有）。動爻以逗號分隔輸入，例如“1,3,5”。</div>
    </div>
    <div id="time" class="tab-content">
      <div class="row">
        <label><input type="radio" name="time-method" value="modern" checked /> 現代時間</label>
        <label><input type="radio" name="time-method" value="traditional" /> 傳統時辰</label>
      </div>
      <div id="modern-time-inputs">
        <div class="row">
          <label>日期時間：</label>
          <input id="dtInput" type="datetime-local" />
          <button id="nowQuick" class="primary">現在</button>
        </div>
        <div class="row">
          <label>問題（可選）：</label>
          <input id="questionTime" type="text" placeholder="請輸入您的問題" />
        </div>
      </div>
      <div id="traditional-time-inputs" class="hidden">
        <div class="row">
          <label>日期：</label>
          <input id="dateInput" type="date" />
        </div>
        <div class="row">
          <label>時辰：</label>
          <select id="shichenInput">
            <option value="23">子時 (23:00-01:00)</option>
            <option value="1">丑時 (01:00-03:00)</option>
            <option value="3">寅時 (03:00-05:00)</option>
            <option value="5">卯時 (05:00-07:00)</option>
            <option value="7">辰時 (07:00-09:00)</option>
            <option value="9">巳時 (09:00-11:00)</option>
            <option value="11">午時 (11:00-13:00)</option>
            <option value="13">未時 (13:00-15:00)</option>
            <option value="15">申時 (15:00-17:00)</option>
            <option value="17">酉時 (17:00-19:00)</option>
            <option value="19">戌時 (19:00-21:00)</option>
            <option value="21">亥時 (21:00-23:00)</option>
        </select>
        </div>
        <div class="row">
          <label>分鐘（可選）：</label>
          <input id="minuteInput" type="number" min="0" max="59" />
        </div>
        <div class="row">
          <label>問題（可選）：</label>
          <input id="questionTime" type="text" placeholder="請輸入您的問題" />
        </div>
      </div>
      <button id="btnTime" class="primary">時間取卦</button>
      <div class="hint">說明：現代時間使用年月日時分計算卦象；傳統時辰使用日期與時辰（可選分鐘）。動爻由時間總和決定。</div>
    </div>
    <div id="image" class="tab-content">
      <div class="row">
        <label>上卦（物象）：</label>
        <select id="upperImageSelect">
          <option value="">請選擇</option>
          <option value="1">天、父、金屬</option>
          <option value="2">澤、少女、金屬</option>
          <option value="3">火、中女、電光</option>
          <option value="4">雷、長男、動態</option>
          <option value="5">風、長女、木</option>
          <option value="6">水、中男、液體</option>
          <option value="7">山、少男、石頭</option>
          <option value="8">地、母、土壤</option>
        </select>
      </div>
      <div class="row">
        <label>下卦（方位）：</label>
        <select id="lowerDirectionSelect">
          <option value="">請選擇</option>
          <option value="1">西北</option>
          <option value="2">西</option>
          <option value="3">南</option>
          <option value="4">東</option>
          <option value="5">東南</option>
          <option value="6">北</option>
          <option value="7">東北</option>
          <option value="8">中</option>
        </select>
      </div>
      <div class="row">
        <label><input id="imageUseMinute" type="checkbox" checked /> 使用當前分鐘作為動爻</label>
      </div>
      <div class="row">
        <label>動爻（1-6，若不勾選分鐘）：</label>
        <input id="imageMovingInput" type="number" min="1" max="6" />
      </div>
      <div class="row">
        <label>問題（可選）：</label>
        <input id="questionImage" type="text" placeholder="請輸入您的問題" />
      </div>
      <button id="btnImage" class="primary">以象取卦</button>
      <div class="hint">說明：根據物象選擇上卦，根據方位選擇下卦，動爻可由當前分鐘自動生成或手動輸入。</div>
    </div>
    <div id="history" class="tab-content">
      <div class="row">
        <button id="clearHistoryBtn" class="primary">清除記錄</button>
        <button id="exportHistoryBtn" class="primary">匯出記錄</button>
        <input type="file" id="importHistoryInput" accept=".json" style="padding: 10px;" />
        <button id="importHistoryBtn" class="primary">匯入記錄</button>
      </div>
      <div id="historyList"></div>
      <div class="hint">說明：顯示過去的占卜記錄，點擊可重新載入卦象進行分析。可匯出或匯入記錄（JSON格式）。</div>
    </div>
    <div id="result" class="gua-box hidden">
      <h3 id="resultTitle">占卜結果</h3>
      <p id="questionDisplay" class="hidden"></p>
      <div class="row">
        <div>
          <h4>本卦</h4>
          <div id="guaImage" class="gua-display-container"></div>
          <div id="guaName" class="gua-name">未知</div>
        </div>
        <div>
          <h4>互卦</h4>
          <div id="huGuaImage" class="gua-display-container"></div>
          <div id="huGuaName" class="gua-name">未知</div>
        </div>
        <div>
          <h4>變卦</h4>
          <div id="changeGuaImage" class="gua-display-container"></div>
          <div id="changeGuaName" class="gua-name">未知</div>
        </div>
      </div>
      <p id="guaNote"></p>
      <div id="lineExplanation" class="line-explanation"></div>
      <div id="movingLineScores" class="moving-line-scores"></div>
      <div class="row">
        <button id="judgeBtn" class="primary">五行與象徵</button>
      </div>
      <div id="judgeBox" class="gua-box hidden">
        <h3 id="judgeTitle">五行與象徵</h3>
        <div class="auspiciousness-index">
          <span id="auspiciousnessIndex">吉凶指數：未計算</span>
          <div id="auspiciousnessBar" class="auspiciousness-bar"></div>
        </div>
        <div class="wuxing-controls">
          <button id="downloadSvgBtn" class="primary">下載圖表</button>
          <button id="openSvgWindowBtn" class="primary">在新視窗查看</button>
        </div>
        <div id="wuxingAnalysis">
          <svg id="wuxingSvg" width="600" height="400"></svg>
          <div class="wuxing-box">
            <h4>本卦五行分析</h4>
            <ul>
              <li><strong>本卦上卦（外在環境）：</strong> <span id="mainUpperWuxing"></span> → 體卦（<span id="tiGuaWuxing"></span>）：<span id="mainUpperRelation" class="wuxing-status"></span></li>
              <li><strong>本卦下卦（內在基礎）：</strong> <span id="mainLowerWuxing"></span> → 體卦（<span id="tiGuaWuxing2"></span>）：<span id="mainLowerRelation" class="wuxing-status"></span></li>
            </ul>
          </div>
          <div class="wuxing-box">
            <h4>互卦五行分析</h4>
            <ul>
              <li><strong>互卦上卦（潛在發展）：</strong> <span id="huUpperWuxing"></span> → 體卦（<span id="tiGuaWuxing3"></span>）：<span id="huUpperRelation" class="wuxing-status"></span></li>
              <li><strong>互卦下卦（內在潛力）：</strong> <span id="huLowerWuxing"></span> → 體卦（<span id="tiGuaWuxing4"></span>）：<span id="huLowerRelation" class="wuxing-status"></span></li>
            </ul>
          </div>
          <div class="wuxing-box">
            <h4>變卦五行分析</h4>
            <ul>
              <li><strong>變卦上卦（未來趨勢）：</strong> <span id="changeUpperWuxing"></span> → 體卦（<span id="tiGuaWuxing5"></span>）：<span id="changeUpperRelation" class="wuxing-status"></span></li>
              <li><strong>變卦下卦（變化基礎）：</strong> <span id="changeLowerWuxing"></span> → 體卦（<span id="tiGuaWuxing6"></span>）：<span id="changeLowerRelation" class="wuxing-status"></span></li>
            </ul>
          </div>
        </div>
        <div id="detailedAnalysis" class="hidden">
        </div>
      </div>
    </div>
  </div>
  <script>
  let wuxingExplanations = {};
  let trigramExplanations = {};
  let hexagrams = {};
  let quotes = [];
  let guaTable = {};
  let hexagramNameMap = {};
  let currentResult = null;
  let history = [];

  const TI_GUA_INDEX = 0;
  const YONG_GUA_INDEX = 1;
  const HUGUA_INDEX = 2;
  const BIANGUA_INDEX = 3;

  function loadHistory() {
    const savedHistory = localStorage.getItem('guaHistory');
    if (savedHistory) {
      history = JSON.parse(savedHistory);
      renderHistory();
    }
  }

  function saveHistory() {
    localStorage.setItem('guaHistory', JSON.stringify(history));
  }

  function fetchJSON(url) {
    return fetch(url)
      .then(response => {
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
      })
      .catch(e => {
        console.error(`無法載入 ${url}:`, e);
        return {};
      });
  }

  async function loadData() {
    [wuxingExplanations, trigramExplanations, hexagrams, quotes] = await Promise.all([
      fetchJSON('wuxing_explanations.json'),
      fetchJSON('trigram_explanations.json'),
      fetchJSON('hexagrams.json'),
      fetchJSON('quotes.json')
    ]);

    if (Object.keys(hexagrams).length > 0) {
      hexagramNameMap = Object.entries(hexagrams).reduce((acc, [name, data]) => {
        acc[data.id] = name;
        return acc;
      }, {});
    }

    if (Object.keys(trigramExplanations).length > 0) {
      guaTable = Object.entries(trigramExplanations).reduce((acc, [name, data]) => {
        acc[data.id] = { name: name, wuxing: data.wuxing };
        return acc;
      }, {});
    }

    console.log("所有資料載入完成。");
  }

  function getGuaName(lines) {
    if (!hexagrams) return '未知';
    const hexagramId = lines.join('');
    return hexagramNameMap[hexagramId] || '未知';
  }

  function getTrigramName(lines) {
    const trigramId = lines.slice(0, 3).join('');
    return guaTable[trigramId] ? guaTable[trigramId].name : '未知';
  }

  function getWuxingRelation(tiWuxing, yongWuxing) {
    const wuxingRelations = {
      '金': { '木': '用剋體', '火': '體剋用', '土': '用生體', '金': '比和', '水': '體生用' },
      '木': { '金': '體剋用', '木': '比和', '水': '用生體', '火': '體生用', '土': '用剋體' },
      '水': { '金': '體生用', '木': '體生用', '水': '比和', '火': '用剋體', '土': '用剋體' },
      '火': { '金': '用剋體', '木': '用生體', '水': '體剋用', '火': '比和', '土': '用生體' },
      '土': { '金': '體生用', '木': '用剋體', '水': '用剋體', '火': '用生體', '土': '比和' }
    };
    return wuxingRelations[tiWuxing]?.[yongWuxing] || '未知';
  }

  function getRelationType(relation) {
    if (relation === '體生用' || relation === '用生體') return 'generate';
    if (relation === '體剋用' || relation === '用剋體') return 'restrain';
    return 'compare';
  }

  function getMovingLineText(guaLines) {
    const movingLine = guaLines.findIndex(line => line === 6 || line === 9);
    if (movingLine === -1) return '本卦無動爻';

    const hexagramName = getGuaName(guaLines);
    if (!hexagrams[hexagramName] || !hexagrams[hexagramName].lines) return '動爻解釋未知';

    const lineData = hexagrams[hexagramName].lines[movingLine];
    return lineData ? lineData.text : '動爻解釋未知';
  }

  function generateGua(upperLines, lowerLines, totalSum, source) {
    const tiLines = upperLines;
    const yongLines = lowerLines;
    const movingLineIndex = (totalSum % 6) === 0 ? 5 : (totalSum % 6) - 1;

    const mainGuaId = tiLines.concat(yongLines).join('');
    const tiGuaId = tiLines.join('');
    const yongGuaId = yongLines.join('');

    const mainGuaName = hexagramNameMap[mainGuaId];
    const tiGuaName = guaTable[tiGuaId]?.name;
    const yongGuaName = guaTable[yongGuaId]?.name;

    const tiWuxing = guaTable[tiGuaId]?.wuxing;
    const yongWuxing = guaTable[yongGuaId]?.wuxing;
    const wuxingRelation = getWuxingRelation(tiWuxing, yongWuxing);
    const relationType = getRelationType(wuxingRelation);

    let mainHuLines = [];
    if (guaTable[tiGuaId] && guaTable[yongGuaId]) {
      mainHuLines = [
        tiLines[1], tiLines[2], yongLines[0],
        tiLines[2], yongLines[0], yongLines[1]
      ].join('').split('').map(Number);
    }
    const huGuaId = mainHuLines.join('');
    const huGuaName = hexagramNameMap[huGuaId] || '未知';

    const bianGuaLines = [...tiLines, ...yongLines];
    if (movingLineIndex !== -1) {
      bianGuaLines[movingLineIndex] = bianGuaLines[movingLineIndex] === 6 ? 7 : (bianGuaLines[movingLineIndex] === 9 ? 8 : bianGuaLines[movingLineIndex]);
      const upperBian = bianGuaLines.slice(0, 3).join('');
      const lowerBian = bianGuaLines.slice(3, 6).join('');
      const bianGuaId = bianGuaLines.join('');
      const bianGuaName = hexagramNameMap[bianGuaId] || '未知';

      const tiBianWuxing = guaTable[upperBian]?.wuxing;
      const yongBianWuxing = guaTable[lowerBian]?.wuxing;
      const wuxingBianRelation = getWuxingRelation(tiBianWuxing, yongBianWuxing);
      const relationBianType = getRelationType(wuxingBianRelation);

      return {
        source, ti_lines: tiLines, yong_lines: yongLines,
        ti_name: tiGuaName, yong_name: yongGuaName,
        main_lines: tiLines.concat(yongLines), main_name: mainGuaName,
        ti_wuxing: tiWuxing, yong_wuxing: yongWuxing,
        wuxing_relation: wuxingRelation, relation_type: relationType,
        moving_line_index: movingLineIndex,
        hu_lines: mainHuLines, hu_name: huGuaName,
        bian_lines: bianGuaLines, bian_name: bianGuaName,
        bian_wuxing_relation: wuxingBianRelation, bian_relation_type: relationBianType
      };
    }

    return {
      source, ti_lines: tiLines, yong_lines: yongLines,
      ti_name: tiGuaName, yong_name: yongGuaName,
      main_lines: tiLines.concat(yongLines), main_name: mainGuaName,
      ti_wuxing: tiWuxing, yong_wuxing: yongWuxing,
      wuxing_relation: wuxingRelation, relation_type: relationType,
      moving_line_index: -1,
      hu_lines: mainHuLines, hu_name: huGuaName,
      bian_lines: null, bian_name: null,
      bian_wuxing_relation: null, bian_relation_type: null
    };
  }

  function renderResult(result) {
    if (!result) return;
    document.getElementById('result').classList.remove('hidden');

    const renderLines = (elementId, lines) => {
      const svg = d3.select(`#${elementId}`);
      svg.selectAll('*').remove();
      const lineData = lines.map((line, i) => ({
        value: line,
        index: i,
        isYang: line === 9 || line === 7,
        isMoving: line === 6 || line === 9
      }));

      const lineGroups = svg.selectAll('.gua-line').data(lineData).enter().append('g').attr('transform', (d, i) => `translate(0, ${i * 20})`);
      const lineLength = 100;
      const lineGap = 10;
      lineGroups.each(function(d) {
        const group = d3.select(this);
        if (d.isYang) {
          group.append('line').attr('x1', 0).attr('y1', 0).attr('x2', lineLength).attr('y2', 0).attr('stroke', '#333').attr('stroke-width', 3);
        } else {
          group.append('line').attr('x1', 0).attr('y1', 0).attr('x2', (lineLength - lineGap) / 2).attr('y2', 0).attr('stroke', '#333').attr('stroke-width', 3);
          group.append('line').attr('x1', (lineLength + lineGap) / 2).attr('y1', 0).attr('x2', lineLength).attr('y2', 0).attr('stroke', '#333').attr('stroke-width', 3);
        }
        if (d.isMoving) {
          group.append('text').attr('x', lineLength + 10).attr('y', 0).attr('dy', '0.35em').attr('fill', 'var(--negative-color)').text(d.value === 6 ? '×' : '○').style('font-size', '16px');
        }
      });
    };

    renderLines('main-gua-svg', result.main_lines);
    document.getElementById('main-gua-name').textContent = result.main_name;
    document.getElementById('ti-gua-name').textContent = result.ti_name;
    document.getElementById('yong-gua-name').textContent = result.yong_name;
    document.getElementById('hu-gua-name').textContent = result.hu_name;
    document.getElementById('bian-gua-name').textContent = result.bian_name || '無變卦';

    if (result.hu_lines && result.hu_lines.length === 6) {
      document.getElementById('hu-gua-container').classList.remove('hidden');
      renderLines('hu-gua-svg', result.hu_lines);
    } else {
      document.getElementById('hu-gua-container').classList.add('hidden');
    }

    if (result.bian_lines) {
      document.getElementById('bian-gua-container').classList.remove('hidden');
      renderLines('bian-gua-svg', result.bian_lines);
    } else {
      document.getElementById('bian-gua-container').classList.add('hidden');
    }

    renderWuxingAnalysis(result);
    renderDetailedAnalysis(result);
    updateResultDetails(result);
  }

  function renderWuxingAnalysis(result) {
    const wuxingAnalysisDiv = document.getElementById('wuxing-analysis');
    wuxingAnalysisDiv.innerHTML = '';
    const mainAnalysis = wuxingExplanations.relations.main;
    const explanation = mainAnalysis[`${result.relation_type}_${result.yong_wuxing.toLowerCase()}_${result.ti_wuxing.toLowerCase()}`] || mainAnalysis.restrain_ti;
    if (explanation) {
      const titleEl = document.createElement('h3');
      titleEl.textContent = `${result.ti_name}(${result.ti_wuxing}) 與 ${result.yong_name} (${result.yong_wuxing}) - ${explanation.display_name}`;
      const overallEl = document.createElement('p');
      overallEl.textContent = explanation.overall;
      wuxingAnalysisDiv.appendChild(titleEl);
      wuxingAnalysisDiv.appendChild(overallEl);
      if (explanation.details) {
        const detailsList = document.createElement('ul');
        for (const key in explanation.details) {
          const detail = explanation.details[key];
          const item = document.createElement('li');
          item.innerHTML = `<strong>${detail.title}</strong>: ${detail.description}`;
          detailsList.appendChild(item);
        }
        wuxingAnalysisDiv.appendChild(detailsList);
      }
    }
  }

  function renderDetailedAnalysis(result) {
    const detailedAnalysisDiv = document.getElementById('detailed-analysis');
    detailedAnalysisDiv.innerHTML = '';

    const createSection = (title, content, color = '') => {
      const section = document.createElement('div');
      section.className = 'analysis-section';
      const heading = document.createElement('h4');
      heading.textContent = title;
      if (color) heading.style.color = color;
      section.appendChild(heading);
      const contentP = document.createElement('p');
      contentP.innerHTML = content;
      section.appendChild(contentP);
      detailedAnalysisDiv.appendChild(section);
    };

    const mainHexagram = hexagrams[result.main_name];
    if (mainHexagram) {
      createSection('卦象總論', mainHexagram.judgment.overall);
      createSection('卦辭', mainHexagram.judgment.overall);
    }
    const movingLine = result.moving_line_index !== -1 ? mainHexagram.lines[result.moving_line_index] : null;
    if (movingLine) {
      createSection('動爻解析', `${movingLine.text} - ${movingLine.meaning}`);
    }
    if (result.bian_name) {
      const bianHexagram = hexagrams[result.bian_name];
      if (bianHexagram) {
        createSection('變卦總論', bianHexagram.judgment.overall);
        createSection('變卦卦辭', bianHexagram.judgment.overall);
      }
    }
    if (result.ti_name && trigramExplanations[result.ti_name]) {
      const explanation = trigramExplanations[result.ti_name];
      createSection('體卦 (主體、內在) 解析', `
        <p><strong>感情:</strong> ${explanation.love}</p>
        <p><strong>事業:</strong> ${explanation.career}</p>
        <p><strong>財富:</strong> ${explanation.wealth}</p>
      `);
    }
    if (result.yong_name && trigramExplanations[result.yong_name]) {
      const explanation = trigramExplanations[result.yong_name];
      createSection('用卦 (外在、變動) 解析', `
        <p><strong>感情:</strong> ${explanation.love}</p>
        <p><strong>事業:</strong> ${explanation.career}</p>
        <p><strong>財富:</strong> ${explanation.wealth}</p>
      `);
    }
  }

  function updateResultDetails(result) {
    const detailsContainer = document.getElementById('result-details');
    detailsContainer.innerHTML = '';
    const details = {
      '起卦時間': new Date().toLocaleString(),
      '起卦來源': result.source,
      '上卦': `${result.ti_name} (${result.ti_wuxing})`,
      '下卦': `${result.yong_name} (${result.yong_wuxing})`,
      '本卦': `${result.main_name}`,
      '互卦': `${result.hu_name}`,
      '動爻': result.moving_line_index !== -1 ? `第${result.moving_line_index + 1}爻` : '無動爻',
      '變卦': result.bian_name ? `${result.bian_name}` : '無變卦'
    };
    for (const key in details) {
      const p = document.createElement('p');
      p.innerHTML = `<strong>${key}:</strong> ${details[key]}`;
      detailsContainer.appendChild(p);
    }
  }

  function generate(method, data) {
    let result;
    if (method === 'number') {
      const num1 = parseInt(document.getElementById('upper-num').value);
      const num2 = parseInt(document.getElementById('lower-num').value);
      const num3 = parseInt(document.getElementById('moving-num').value);
      if (isNaN(num1) || isNaN(num2) || isNaN(num3)) {
        alert('請輸入三個有效數字！');
        return;
      }
      const upperLines = Array(3).fill(0).map(() => (num1 % 8 === 0 ? 8 : num1 % 8));
      const lowerLines = Array(3).fill(0).map(() => (num2 % 8 === 0 ? 8 : num2 % 8));
      result = generateGua(upperLines, lowerLines, num3, '數字起卦');
    } else if (method === 'random') {
      const random1 = Math.floor(Math.random() * 8) + 1;
      const random2 = Math.floor(Math.random() * 8) + 1;
      const random3 = Math.floor(Math.random() * 6) + 1;
      document.getElementById('random-result').textContent = `生成數字：${random1}, ${random2}, ${random3}`;
      const upperLines = Array(3).fill(0).map(() => (random1 % 8 === 0 ? 8 : random1 % 8));
      const lowerLines = Array(3).fill(0).map(() => (random2 % 8 === 0 ? 8 : random2 % 8));
      result = generateGua(upperLines, lowerLines, random3, '隨機數字起卦');
    } else if (method === 'manual') {
      const upperLines = [
        parseInt(document.getElementById('manual-upper-1').value),
        parseInt(document.getElementById('manual-upper-2').value),
        parseInt(document.getElementById('manual-upper-3').value)
      ];
      const lowerLines = [
        parseInt(document.getElementById('manual-lower-1').value),
        parseInt(document.getElementById('manual-lower-2').value),
        parseInt(document.getElementById('manual-lower-3').value)
      ];
      const movingNum = parseInt(document.getElementById('manual-moving-num').value);
      result = generateGua(upperLines, lowerLines, movingNum, '手動起卦');
    } else if (method === 'time') {
      const selectedTimeMethod = document.querySelector('input[name="time-method"]:checked').value;
      let upperNum, lowerNum, movingNum;
      if (selectedTimeMethod === 'modern') {
        const date = new Date(document.getElementById('modern-date').value + 'T' + document.getElementById('modern-time').value);
        if (isNaN(date.getTime())) {
          alert('請輸入有效的時間！');
          return;
        }
        upperNum = date.getFullYear() + date.getMonth() + date.getDate();
        lowerNum = date.getHours() + date.getMinutes() + date.getSeconds();
        movingNum = date.getFullYear() + date.getMonth() + date.getDate() + date.getHours() + date.getMinutes() + date.getSeconds();
      } else {
        upperNum = parseInt(document.getElementById('traditional-upper-num').value);
        lowerNum = parseInt(document.getElementById('traditional-lower-num').value);
        movingNum = parseInt(document.getElementById('traditional-moving-num').value);
      }
      result = generateGua(
        Array(3).fill(0).map(() => (upperNum % 8 === 0 ? 8 : upperNum % 8)),
        Array(3).fill(0).map(() => (lowerNum % 8 === 0 ? 8 : lowerNum % 8)),
        movingNum,
        '時間起卦'
      );
    } else if (method === 'image') {
      // 圖像起卦邏輯
      const imgWidth = parseInt(document.getElementById('img-width').value) || 0;
      const imgHeight = parseInt(document.getElementById('img-height').value) || 0;
      const sum = imgWidth + imgHeight;
      const upperNum = sum;
      const lowerNum = sum;
      const movingNum = sum;
      const upperLines = Array(3).fill(0).map(() => (upperNum % 8 === 0 ? 8 : upperNum % 8));
      const lowerLines = Array(3).fill(0).map(() => (lowerNum % 8 === 0 ? 8 : lowerNum % 8));
      result = generateGua(upperLines, lowerLines, movingNum, '物象起卦');
    }

    if (result) {
      currentResult = result;
      history.unshift(result);
      if (history.length > 10) history.pop();
      saveHistory();
      renderResult(result);
      renderHistory();
      const randomQuote = quotes[Math.floor(Math.random() * quotes.length)];
      document.getElementById('quote').textContent = randomQuote;
    }
  }

  function renderHistory() {
    const historyList = document.getElementById('history-list');
    historyList.innerHTML = '';
    history.forEach((item, index) => {
      const li = document.createElement('li');
      li.className = 'history-item';
      li.innerHTML = `
        <span><strong>${index + 1}.</strong> 本卦: ${item.main_name} | 變卦: ${item.bian_name || '無'} (${item.source})</span>
        <button class="small-btn" onclick="showHistoryItem(${index})">查看</button>
      `;
      historyList.appendChild(li);
    });
  }

  function showHistoryItem(index) {
    currentResult = history[index];
    renderResult(currentResult);
    document.getElementById('result').scrollIntoView({ behavior: 'smooth' });
  }

  function exportHistory() {
    const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(history, null, 2));
    const downloadAnchorNode = document.createElement('a');
    downloadAnchorNode.setAttribute("href", dataStr);
    downloadAnchorNode.setAttribute("download", "gua_history.json");
    document.body.appendChild(downloadAnchorNode);
    downloadAnchorNode.click();
    downloadAnchorNode.remove();
  }

  function importHistory(file) {
    const reader = new FileReader();
    reader.onload = function(e) {
      try {
        const importedHistory = JSON.parse(e.target.result);
        if (Array.isArray(importedHistory)) {
          history = importedHistory;
          saveHistory();
          renderHistory();
          alert('歷史記錄匯入成功！');
        } else {
          alert('檔案格式錯誤，請選擇有效的 JSON 歷史記錄檔。');
        }
      } catch (error) {
        alert('匯入失敗：' + error.message);
      }
    };
    reader.readAsText(file);
  }

  function downloadSvg() {
    const svgElement = document.getElementById('main-gua-svg');
    const svgData = new XMLSerializer().serializeToString(svgElement);
    const blob = new Blob([svgData], { type: 'image/svg+xml' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'gua_diagram.svg';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  function openSvgInNewWindow() {
    const svgElement = document.getElementById('main-gua-svg');
    const svgData = new XMLSerializer().serializeToString(svgElement);
    const svgWindow = window.open('', '_blank');
    svgWindow.document.write(`
      <!DOCTYPE html>
      <html lang="en">
      <head><title>卦象圖</title></head>
      <body>${svgData}</body>
      </html>
    `);
    svgWindow.document.close();
  }

  document.addEventListener('DOMContentLoaded', async () => {
    await loadData();
    loadHistory();

    document.getElementById('btnNumber').addEventListener('click', () => {
      generate('number', {});
    });
    document.getElementById('btnRandomNumber').addEventListener('click', () => {
      generate('random', {});
    });
    document.getElementById('btnManual').addEventListener('click', () => {
      generate('manual', {});
    });
    document.getElementById('btnTime').addEventListener('click', () => {
      generate('time', {});
    });
    document.getElementById('btnImage').addEventListener('click', () => {
      generate('image', {});
    });

    document.getElementById('judgeBtn').addEventListener('click', () => {
      if (!currentResult) {
        alert('請先進行占卜以生成卦象！');
        return;
      }
      renderWuxingAnalysis(currentResult);
      renderDetailedAnalysis(currentResult);
    });

    document.getElementById('clearHistoryBtn').addEventListener('click', () => {
      if (confirm('確定要清除所有歷史記錄嗎？')) {
        history = [];
        saveHistory();
        renderHistory();
      }
    });

    document.getElementById('exportHistoryBtn').addEventListener('click', () => {
      exportHistory();
    });

    document.getElementById('importHistoryBtn').addEventListener('click', () => {
      const input = document.getElementById('importHistoryInput');
      if (input.files.length > 0) {
        importHistory(input.files[0]);
      } else {
        alert('請選擇要匯入的檔案！');
      }
    });

    document.getElementById('downloadSvgBtn').addEventListener('click', () => {
      downloadSvg();
    });

    document.getElementById('openSvgWindowBtn').addEventListener('click', () => {
      openSvgInNewWindow();
    });

    document.querySelectorAll('input[name="time-method"]').forEach(radio => {
      radio.addEventListener('change', () => {
        const modernInputs = document.getElementById('modern-time-inputs');
        const traditionalInputs = document.getElementById('traditional-time-inputs');
        if (radio.value === 'modern') {
          modernInputs.classList.remove('hidden');
          traditionalInputs.classList.add('hidden');
        } else {
          modernInputs.classList.add('hidden');
          traditionalInputs.classList.remove('hidden');
        }
      });
    });
  });
</script>
</body>
</html>
