<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>專業梅花心易五行分析系統 - 解卦端</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
  <style>
    .hexagram-svg {
      width: 100px;
      height: 120px;
      margin-bottom: 10px;
    }
    .tooltip {
      position: relative;
    }
    .tooltip:hover::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background-color: #333;
      color: white;
      padding: 5px 10px;
      border-radius: 4px;
      font-size: 12px;
      white-space: nowrap;
      z-index: 10;
    }
    .advice {
      background-color: #f4f8f6;
      border-left: 6px solid #2c6f4e;
      padding: 10px;
      border-radius: 4px;
    }
    @media (max-width: 640px) {
      .hexagram-svg {
        width: 80px;
        height: 100px;
      }
      .hexagram-box {
        min-width: 100px;
      }
    }
  </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center p-4 font-sans">
  <header class="w-full max-w-3xl bg-white shadow-md rounded-lg p-6 mb-6">
    <h2 class="text-2xl font-bold text-center text-gray-800">專業梅花心易五行分析系統 - 解卦端</h2>
    <p class="text-center text-gray-600 mt-2">監聽MQTT訊息並進行解卦</p>
  </header>

  <main class="w-full max-w-3xl bg-white shadow-md rounded-lg p-6">
    <p id="status" class="text-center text-gray-600">連線狀態...</p>
    <div id="logDiv" class="mt-4 bg-gray-100 p-4 rounded-lg overflow-y-auto max-h-96">
      </div>
  </main>

  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <script>
    const trigrams = [
      { name: "乾", element: "金" },
      { name: "兑", element: "金" },
      { name: "離", element: "火" },
      { name: "震", element: "木" },
      { name: "巽", element: "木" },
      { name: "坎", element: "水" },
      { name: "艮", element: "土" },
      { name: "坤", element: "土" }
    ];

    const fiveElementsOrder = ["火", "土", "金", "水", "木"];
    const fiveRelations = [
      { from: "木", to: "火", type: "生" },
      { from: "火", to: "土", type: "生" },
      { from: "土", to: "金", type: "生" },
      { from: "金", to: "水", type: "生" },
      { from: "水", to: "木", type: "生" },
      { from: "木", to: "土", type: "剋" },
      { from: "土", to: "水", type: "剋" },
      { from: "水", to: "火", type: "剋" },
      { from: "火", to: "金", type: "剋" },
      { from: "金", to: "木", type: "剋" }
    ];

    const fiveElementColors = {
      "金": "#ffd700",
      "木": "#228b22",
      "水": "#1e90ff",
      "火": "#dc143c",
      "土": "#a52a2a"
    };

    const wuxingStatus = {
      "旺": { strokeWidth: 6, opacity: 1 },
      "相": { strokeWidth: 4, opacity: 0.8 },
      "休": { strokeWidth: 2, opacity: 0.6 },
      "囚": { strokeWidth: 1, opacity: 0.4 },
      "死": { strokeWidth: 1, opacity: 0.3 }
    };

    const colors = { "用生體": "green", "用剋體": "red", "比和": "orange", "體生用": "blue", "體剋用": "purple", "無": "gray" };

    const baguaLines = {
      0: ["—", "—", "—"],
      1: ["—", "—", "--"],
      2: ["—", "--", "—"],
      3: ["—", "--", "--"],
      4: ["--", "—", "—"],
      5: ["--", "—", "--"],
      6: ["--", "--", "—"],
      7: ["--", "--", "--"]
    };

    const trigramsName = ["乾", "兑", "離", "震", "巽", "坎", "艮", "坤"];
    const trigramFiveElement = {
      "乾": "金", "兑": "金", "離": "火",
      "震": "木", "巽": "木", "坎": "水",
      "艮": "土", "坤": "土"
    };

    const sixtyFourHexagrams = {
      "00": "乾為天", "01": "天澤履", "02": "天火同人", "03": "天雷無妄",
      "04": "天風姤", "05": "天水訟", "06": "天山遯", "07": "天地否",
      "10": "澤天夬", "11": "兌為澤", "12": "澤火革", "13": "澤雷隨",
      "14": "澤風大過", "15": "澤水困", "16": "澤山咸", "17": "澤地萃",
      "20": "火天大有", "21": "火澤睽", "22": "離為火", "23": "火雷噬嗑",
      "24": "火風鼎", "25": "火水未濟", "26": "火山旅", "27": "火地晉",
      "30": "雷天大壯", "31": "雷澤歸妹", "32": "雷火豐", "33": "震為雷",
      "34": "雷風恆", "35": "雷水解", "36": "雷山小過", "37": "雷地豫",
      "40": "風天小畜", "41": "風澤中孚", "42": "風火家人", "43": "風雷益",
      "44": "巽為風", "45": "風水渙", "46": "風山漸", "47": "風地觀",
      "50": "水天需", "51": "水澤節", "52": "水火既濟", "53": "水雷屯",
      "54": "水風井", "55": "坎為水", "56": "水山蹇", "57": "水地比",
      "60": "山天大畜", "61": "山澤損", "62": "山火賁", "63": "山雷頤",
      "64": "山風蠱", "65": "山水蒙", "66": "艮為山", "67": "山地剝",
      "70": "地天泰", "71": "地澤臨", "72": "地火明夷", "73": "地雷復",
      "74": "地風升", "75": "地水師", "76": "地山謙", "77": "坤為地"
    };

    const wuxingStatusMap = {
      "WS,WS,WS": "初始吉利，過程中得到幫助，最終結果吉利。整體大吉。\n\n乾天坤地，祥瑞盈門\n陰陽和合，萬物生春\n順天應人，福壽康寧\n吉星高照，心想事成",
      "WS,WS,WK": "初始吉利，過程中得到幫助，最終結果凶險。整體小吉。\n\n初陽普照，中得貴人\n末路崎嶇，謹慎前行\n雲開月明，自有天助\n守正持中，轉危為安",
      "WS,WS,SS": "初始吉利，過程中得到幫助，最終付出多收穫少。整體小吉。\n\n春風送暖，夏雨滋苗\n秋實雖薄，冬藏有餘\n耕耘不輟，天道酬勤\n積善之家，必有餘慶",
      "WS,WS,SK": "初始吉利，過程中得到幫助，最終通過努力成功。整體大吉。\n\n初陽普照，中得貴人\n末需自強，終成大業\n金石為開，精誠所至\n青雲直上，鵬程萬里",
      "WS,WS,BH": "初始吉利，過程中得到幫助，最終平穩。整體大吉。\n\n紫氣東來，祥雲西至\n中正平和，安泰無憂\n穩如泰山，靜若秋水\n長久安康，福澤綿延",
      "WS,WK,WS": "初始吉利，過程中遇到阻礙，最終結果吉利。整體小吉。\n\n初陽方升，中遇坎坷\n末路通達，否極泰來\n破繭成蝶，逆境奮起\n雨過天晴，見虹萬里",
      "WS,WK,WK": "初始吉利，過程中遇到阻礙，最終結果凶險。整體小凶。\n\n初陽中阻，末路多艱\n暗流潛藏，謹言慎行\n韜光養晦，以待時機\n守得雲開，自見月明",
      "WS,WK,SS": "初始吉利，過程中遇到阻礙，最終付出多收穫少。整體小凶。\n\n初陽中阻，末勞少獲\n勤儉持家，細水長流\n知足常樂，隨遇而安\n福雖遲來，終將降至",
      "WS,WK,SK": "初始吉利，過程中遇到阻礙，最終通過努力成功。整體小吉。\n\n初陽中阻，末靠自強\n鐵杵磨針，功到自成\n逆水行舟，不進則退\n堅持不懈，終抵彼岸",
      "WS,WK,BH": "初始吉利，過程中遇到阻礙，最終平穩。整體小吉。\n\n初陽普照，中遇風霜\n末歸平靜，穩如磐石\n以柔克剛，以靜制動\n平和處世，安康長久",
      "WS,SS,WS": "初始吉利，過程中付出努力，最終結果吉利。整體小吉。\n\n初吉中勞，末得圓滿\n勤耕不輟，碩果累累\n天道酬勤，人道酬善\n春華秋實，福運綿長",
      "WS,SS,WK": "初始吉利，過程中付出努力，最終結果凶險。整體小凶。\n\n初吉中奮，末路多艱\n勞而少功，時運未濟\n韜光養晦，靜待時機\n積蓄力量，東山再起",
      "WS,SS,SS": "初始吉利，過程中付出努力，最終付出多收穫少。整體小凶。\n\n初吉中奮，末得薄收\n勤儉持家，細水長流\n知足常樂，隨遇而安\n福雖遲來，終將降至",
      "WS,SS,SK": "初始吉利，過程中付出努力，最終通過努力成功。整體小吉。\n\n初吉中奮，末靠自強\n精衛填海，愚公移山\n堅持不懈，終有所成\n功成名就，福壽雙全",
      "WS,SS,BH": "初始吉利，過程中付出努力，最終平穩。整體小吉。\n\n初吉中勞，末歸平靜\n平和安泰，穩健前行\n知足常樂，心安理得\n平淡是真，安康是福",
      "WS,SK,WS": "初始吉利，過程中克服困難，最終結果吉利。整體大吉。\n\n初克中克，末得大成\n披荆斩棘，終見坦途\n勇者無懼，智者無憂\n成就偉業，名揚四方",
      "WS,SK,WK": "初始吉利，過程中克服困難，最終結果凶險。整體小吉。\n\n初克中克，末路艱辛\n逆水行舟，不進則退\n堅守正道，不忘初心\n黑暗過後，必見曙光",
      "WS,SK,SS": "初始吉利，過程中克服困難，最終付出多收穫少。整體小吉。\n\n初克中克，末勞少獲\n耕耘雖苦，天道酬勤\n積少成多，聚沙成塔\n堅持不懈，終有回報",
      "WS,SK,SK": "初始吉利，過程中克服困難，最終通過努力成功。整體大吉。\n\n初克中克，末靠自強\n千錘百煉，終成利器\n風雨過後，見彩虹美\n成就非凡，福澤綿長",
      "WS,SK,BH": "初始吉利，過程中克服困難，最終平穩。整體大吉。\n\n初克中克，末歸平靜\n穩健前行，安泰無憂\n以剛克柔，以動制靜\n平衡陰陽，福壽安康",
      "WS,BH,WS": "初始吉利，過程平穩，最終結果吉利。整體大吉。\n\n初陽中平，末得圓滿\n穩中求進，順水行舟\n平和安泰，福運自來\n吉祥如意，萬事順遂",
      "WS,BH,WK": "初始吉利，過程平穩，最終結果凶險。整體小吉。\n\n初吉中平，末路多艱\n居安思危，未雨綢繆\n以靜制動，以守為攻\n轉危為安，化險為夷",
      "WS,BH,SS": "初始吉利，過程平穩，最終付出多收穫少。整體小吉。\n\n初陽中平，末勞少獲\n知足常樂，隨遇而安\n勤儉持家，細水長流\n福雖遲來，終將降至",
      "WS,BH,SK": "初始吉利，過程平穩，最終通過努力成功。整體大吉。\n\n初吉中平，末靠自強\n穩中求進，勤能補拙\n堅持不懈，終有所成\n功成名就，福壽雙全",
      "WS,BH,BH": "初始吉利，過程平穩，最終平穩。整體大吉。\n\n初陽中平，末歸平靜\n四平八穩，安泰無憂\n平和處世，安康長久\n福澤綿延，吉祥如意",
      "WK,WS,WS": "初始凶險，過程中得到幫助，最終結果吉利。整體小吉。\n\n初凶中助，末得吉慶\n遇難呈祥，轉危為安\n貴人相助，逢凶化吉\n雨過天晴，見虹萬里",
      "WK,WS,WK": "初始凶險，過程中得到幫助，最終結果凶險。整體小凶。\n\n初凶中助，末路多艱\n外力難挽，內修自強\n韜光養晦，以待時機\n守得雲開，自見月明",
      "WK,WS,SS": "初始凶險，過程中得到幫助，最終付出多收穫少。整體小凶。\n\n初凶中助，末勞少獲\n勤儉持家，細水長流\n知足常樂，隨遇而安\n福雖遲來，終將降至",
      "WK,WS,SK": "初始凶險，過程中得到幫助，最終通過努力成功。整體小吉。\n\n初凶中助，末靠自強\n逆水行舟，不進則退\n堅持不懈，終抵彼岸\n功成名就，福壽雙全",
      "WK,WS,BH": "初始凶險，過程中得到幫助，最終平穩。整體小吉。\n\n初凶中助，末歸平靜\n以柔克剛，以靜制動\n平和處世，安康長久\n轉危為安，化險為夷",
      "WK,WK,WS": "初始凶險，過程中遇到阻礙，最終結果吉利。整體小凶。\n\n初凶中阻，末得吉慶\n逆水行舟，不進則退\n堅持不懈，終抵彼岸\n雨過天晴，見虹萬里",
      "WK,WK,WK": "初始凶險，過程中遇到阻礙，最終結果凶險。整體大凶。\n\n初凶中阻，末路多艱\n暗流潛藏，謹言慎行\n韜光養晦，以待時機\n守得雲開，自見月明",
      "WK,WK,SS": "初始凶險，過程中遇到阻礙，最終付出多收穫少。整體大凶。\n\n初凶中阻，末勞少獲\n勤儉持家，細水長流\n知足常樂，隨遇而安\n福雖遲來，終將降至",
      "WK,WK,SK": "初始凶險，過程中遇到阻礙，最終通過努力成功。整體小凶。\n\n初凶中阻，末靠自強\n鐵杵磨針，功到自成\n逆水行舟，不進則退\n堅持不懈，終抵彼岸",
      "WK,WK,BH": "初始凶險，過程中遇到阻礙，最終平穩。整體小凶。\n\n初凶中阻，末歸平靜\n穩如磐石，靜若處子\n以柔克剛，以靜制動\n平和處世，安康長久",
      "WK,SS,WS": "初始凶險，過程中付出努力，最終結果吉利。整體小凶。\n\n初凶中勞，末得圓滿\n勤耕不輟，碩果累累\n天道酬勤，人道酬善\n春華秋實，福運綿長",
      "WK,SS,WK": "初始凶險，過程中付出努力，最終結果凶險。整體大凶。\n\n初凶中勞，末路多艱\n勞而無功，時運不濟\n韜光養晦，靜待時機\n積蓄力量，東山再起",
      "WK,SS,SS": "初始凶險，過程中付出努力，最終付出多收穫少。整體大凶。\n\n初凶中勞，末得薄收\n勤儉持家，細水長流\n知足常樂，隨遇而安\n福雖遲來，終將降至",
      "WK,SS,SK": "初始凶險，過程中付出努力，最終通過努力成功。整體小凶。\n\n初凶中勞，末靠自強\n精衛填海，愚公移山\n堅持不懈，終有所成\n功成名就，福壽雙全",
      "WK,SS,BH": "初始凶險，過程中付出努力，最終平穩。整體小凶。\n\n初凶中勞，末歸平靜\n平和安泰，穩健前行\n知足常樂，心安理得\n平淡是真，安康是福",
      "WK,SK,WS": "初始凶險，過程中克服困難，最終結果吉利。整體小吉。\n\n初凶中克，末得大成\n披荆斩棘，終見坦途\n勇者無懼，智者無憂\n成就偉業，名揚四方",
      "WK,SK,WK": "初始凶險，過程中克服困難，最終結果凶險。整體小凶。\n\n初凶中克，末路艱辛\n逆水行舟，不進則退\n堅守正道，不忘初心\n黑暗過後，必見曙光",
      "WK,SK,SS": "初始凶險，過程中克服困難，最終付出多收穫少。整體小凶。\n\n初凶中克，末勞少獲\n耕耘雖苦，天道酬勤\n積少成多，聚沙成塔\n堅持不懈，終有回報",
      "WK,SK,SK": "初始凶險，過程中克服困難，最終通過努力成功。整體小吉。\n\n初凶中克，末靠自強\n千錘百煉，終成利器\n風雨過後，見彩虹美\n成就非凡，福澤綿長",
      "WK,SK,BH": "初始凶險，過程中克服困難，最終平穩。整體小吉。\n\n初凶中克，末歸平靜\n穩健前行，安泰無憂\n以剛克柔，以動制靜\n平衡陰陽，福壽安康",
      "WK,BH,WS": "初始凶險，過程平穩，最終結果吉利。整體小凶。\n\n初凶中平，末得圓滿\n穩中求進，順水行舟\n平和安泰，福運自來\n吉祥如意，萬事順遂",
      "WK,BH,WK": "初始凶險，過程平穩，最終結果凶險。整體大凶。\n\n初凶中平，末路多艱\n居安思危，未雨綢繆\n以靜制動，以守為攻\n轉危為安，化險為夷",
      "WK,BH,SS": "初始凶險，過程平穩，最終付出多收穫少。整體大凶。\n\n初凶中平，末勞少獲\n知足常樂，隨遇而安\n勤儉持家，細水長流\n福雖遲來，終將降至",
      "WK,BH,SK": "初始凶險，過程平穩，最終通過努力成功。整體小凶。\n\n初凶中平，末靠自強\n穩中求進，勤能補拙\n堅持不懈，終有所成\n功成名就，福壽雙全",
      "WK,BH,BH": "初始凶險，過程平穩，最終平穩。整體大凶。\n\n初凶中平，末歸平靜\n四平八穩，安泰無憂\n平和處世，安康長久\n福澤綿延，吉祥如意",
      "SS,WS,WS": "初始付出多收穫少，過程中得到幫助，最終結果吉利。整體小吉。\n\n初勞中助，末得圓滿\n勤耕不輟，天道酬勤\n積善之家，必有餘慶\n春華秋實，福運綿長",
      "SS,WS,WK": "初始付出多收穫少，過程中得到幫助，最終結果凶險。整體小凶。\n\n初勞中助，末路多艱\n勞而無功，時運不濟\n韜光養晦，靜待時機\n積蓄力量，東山再起",
      "SS,WS,SS": "初始付出多收穫少，過程中得到幫助，最終付出多收穫少。整體小凶。\n\n初勞中助，末得薄收\n勤儉持家，細水長流\n知足常樂，隨遇而安\n福雖遲來，終將降至",
      "SS,WS,SK": "初始付出多收穫少，過程中得到幫助，最終通過努力成功。整體小吉。\n\n初勞中助，末靠自強\n精衛填海，愚公移山\n堅持不懈，終有所成\n功成名就，福壽雙全",
      "SS,WS,BH": "初始付出多收穫少，過程中得到幫助，最終平穩。整體小吉。\n\n初勞中助，末歸平靜\n平和安泰，穩健前行\n知足常樂，心安理得\n平淡是真，安康是福",
      "SS,WK,WS": "初始付出多收穫少，過程中遇到阻礙，最終結果吉利。整體小凶。\n\n初勞中阻，末得吉慶\n逆水行舟，不進則退\n堅持不懈，終抵彼岸\n雨過天晴，見虹萬里",
      "SS,WK,WK": "初始付出多收穫少，過程中遇到阻礙，最終結果凶險。整體大凶。\n\n初勞中阻，末路多艱\n暗流潛藏，謹言慎行\n韜光養晦，以待時機\n守得雲開，自見月明",
      "SS,WK,SS": "初始付出多收穫少，過程中遇到阻礙，最終付出多收穫少。整體大凶。\n\n初勞中阻，末得薄收\n勤儉持家，細水長流\n知足常樂，隨遇而安\n福雖遲來，終將降至",
      "SS,WK,SK": "初始付出多收穫少，過程中遇到阻礙，最終通過努力成功。整體小凶。\n\n初勞中阻，末靠自強\n鐵杵磨針，功到自成\n逆水行舟，不進則退\n堅持不懈，終抵彼岸",
      "SS,WK,BH": "初始付出多收穫少，過程中遇到阻礙，最終平穩。整體小凶。\n\n初勞中阻，末歸平靜\n穩如磐石，靜若處子\n以柔克剛，以靜制動\n平和處世，安康長久",
      "SS,SS,WS": "初始付出多收穫少，過程中付出努力，最終結果吉利。整體小凶。\n\n初勞中奮，末得圓滿\n勤耕不輟，碩果累累\n天道酬勤，人道酬善\n春華秋實，福運綿長",
      "SS,SS,WK": "初始付出多收穫少，過程中付出努力，最終結果凶險。整體大凶。\n\n初勞中奮，末路多艱\n勞而無功，時運不濟\n韜光養晦，靜待時機\n積蓄力量，東山再起",
      "SS,SS,SS": "初始付出多收穫少，過程中付出努力，最終付出多收穫少。整體大凶。\n\n初勞中奮，末得薄收\n勤儉持家，細水長流\n知足常樂，隨遇而安\n福雖遲來，終將降至",
      "SS,SS,SK": "初始付出多收穫少，過程中付出努力，最終通過努力成功。整體小凶。\n\n初勞中奮，末靠自強\n精衛填海，愚公移山\n堅持不懈，終有所成\n功成名就，福壽雙全",
      "SS,SS,BH": "初始付出多收穫少，過程中付出努力，最終平穩。整體小凶。\n\n初勞中奮，末歸平靜\n平和安泰，穩健前行\n知足常樂，心安理得\n平淡是真，安康是福",
      "SS,SK,WS": "初始付出多收穫少，過程中克服困難，最終結果吉利。整體小吉。\n\n初勞中克，末得大成\n披荆斩棘，終見坦途\n勇者無懼，智者無憂\n成就偉業，名揚四方",
      "SS,SK,WK": "初始付出多收穫少，過程中克服困難，最終結果凶險。整體小凶。\n\n初勞中克，末路艱辛\n逆水行舟，不進則退\n堅守正道，不忘初心\n黑暗過後，必見曙光",
      "SS,SK,SS": "初始付出多收穫少，過程中克服困難，最終付出多收穫少。整體小凶。\n\n初勞中克，末勞少獲\n耕耘雖苦，天道酬勤\n積少成多，聚沙成塔\n堅持不懈，終有回報",
      "SS,SK,SK": "初始付出多收穫少，過程中克服困難，最終通過努力成功。整體小吉。\n\n初勞中克，末靠自強\n千錘百煉，終成利器\n風雨過後，見彩虹美\n成就非凡，福澤綿長",
      "SS,SK,BH": "初始付出多收穫少，過程中克服困難，最終平穩。整體小吉。\n\n初勞中克，末歸平靜\n穩健前行，安泰無憂\n以剛克柔，以動制靜\n平衡陰陽，福壽安康",
      "SS,BH,WS": "初始付出多收穫少，過程平穩，最終結果吉利。整體小凶。\n\n初勞中平，末得圓滿\n穩中求進，順水行舟\n平和安泰，福運自來\n吉祥如意，萬事順遂",
      "SS,BH,WK": "初始付出多收穫少，過程平穩，最終結果凶險。整體大凶。\n\n初勞中平，末路多艱\n居安思危，未雨綢繆\n以靜制動，以守為攻\n轉危為安，化險為夷",
      "SS,BH,SS": "初始付出多收穫少，過程平穩，最終付出多收穫少。整體大凶。\n\n初勞中平，末勞少獲\n知足常樂，隨遇而安\n勤儉持家，細水長流\n福雖遲來，終將降至",
      "SS,BH,SK": "初始付出多收穫少，過程平穩，最終通過努力成功。整體小凶。\n\n初勞中平，末靠自強\n穩中求進，勤能補拙\n堅持不懈，終有所成\n功成名就，福壽雙全",
      "SS,BH,BH": "初始付出多收穫少，過程平穩，最終平穩。整體小凶。\n\n初勞中平，末歸平靜\n四平八穩，安泰無憂\n平和處世，安康長久\n福澤綿延，吉祥如意",
      "SK,WS,WS": "初始克服困難，過程中得到幫助，最終結果吉利。整體大吉。\n\n初克中助，末得大成\n披荆斩棘，終見坦途\n勇者無懼，智者無憂\n成就偉業，名揚四方",
      "SK,WS,WK": "初始克服困難，過程中得到幫助，最終結果凶險。整體小吉。\n\n初克中助，末路艱辛\n逆水行舟，不進則退\n堅守正道，不忘初心\n黑暗過後，必見曙光",
      "SK,WS,SS": "初始克服困難，過程中得到幫助，最終付出多收穫少。整體小吉。\n\n初克中助，末勞少獲\n耕耘雖苦，天道酬勤\n積少成多，聚沙成塔\n堅持不懈，終有回報",
      "SK,WS,SK": "初始克服困難，過程中得到幫助，最終通過努力成功。整體大吉。\n\n初克中助，末靠自強\n千錘百煉，終成利器\n風雨過後，見彩虹美\n成就非凡，福澤綿長",
      "SK,WS,BH": "初始克服困難，過程中得到幫助，最終平穩。整體大吉。\n\n初克中助，末歸平靜\n穩健前行，安泰無憂\n以剛克柔，以動制靜\n平衡陰陽，福壽安康",
      "SK,WK,WS": "初始克服困難，過程中遇到阻礙，最終結果吉利。整體小吉。\n\n初克中阻，末得大成\n披荆斩棘，終見坦途\n勇者無懼，智者無憂\n成就偉業，名揚四方",
      "SK,WK,WK": "初始克服困難，過程中遇到阻礙，最終結果凶險。整體小凶。\n\n初克中阻，末路艱辛\n逆水行舟，不進則退\n堅守正道，不忘初心\n黑暗過後，必見曙光",
      "SK,WK,SS": "初始克服困難，過程中遇到阻礙，最終付出多收穫少。整體小凶。\n\n初克中阻，末勞少獲\n耕耘雖苦，天道酬勤\n積少成多，聚沙成塔\n堅持不懈，終有回報",
      "SK,WK,SK": "初始克服困難，過程中遇到阻礙，最終通過努力成功。整體小吉。\n\n初克中阻，末靠自強\n千錘百煉，終成利器\n風雨過後，見彩虹美\n成就非凡，福澤綿長",
      "SK,WK,BH": "初始克服困難，過程中遇到阻礙，最終平穩。整體小吉。\n\n初克中阻，末歸平靜\n穩健前行，安泰無憂\n以剛克柔，以動制靜\n平衡陰陽，福壽安康",
      "SK,SS,WS": "初始克服困難，過程中付出努力，最終結果吉利。整體小吉。\n\n初克中勞，末得大成\n披荆斩棘，終見坦途\n勇者無懼，智者無憂\n成就偉業，名揚四方",
      "SK,SS,WK": "初始克服困難，過程中付出努力，最終結果凶險。整體小凶。\n\n初克中勞，末路艱辛\n逆水行舟，不進則退\n堅守正道，不忘初心\n黑暗過後，必見曙光",
      "SK,SS,SS": "初始克服困難，過程中付出努力，最終付出多收穫少。整體小凶。\n\n初克中勞，末勞少獲\n耕耘雖苦，天道酬勤\n積少成多，聚沙成塔\n堅持不懈，終有回報",
      "SK,SS,SK": "初始克服困難，過程中付出努力，最終通過努力成功。整體大吉。\n\n初克中勞，末靠自強\n千錘百煉，終成利器\n風雨過後，見彩虹美\n成就非凡，福澤綿長",
      "SK,SS,BH": "初始克服困難，過程中付出努力，最終平穩。整體小吉。\n\n初克中勞，末歸平靜\n穩健前行，安泰無憂\n以剛克柔，以動制靜\n平衡陰陽，福壽安康",
      "SK,BH,WS": "初始克服困難，過程平穩，最終結果吉利。整體大吉。\n\n初克中平，末得大成\n披荆斩棘，終見坦途\n勇者無懼，智者無憂\n成就偉業，名揚四方",
      "SK,BH,WK": "初始克服困難，過程平穩，最終結果凶險。整體小吉。\n\n初克中平，末路艱辛\n逆水行舟，不進則退\n堅守正道，不忘初心\n黑暗過後，必見曙光",
      "SK,BH,SS": "初始克服困難，過程平穩，最終付出多收穫少。整體小吉。\n\n初克中平，末勞少獲\n耕耘雖苦，天道酬勤\n積少成多，聚沙成塔\n堅持不懈，終有回報",
      "SK,BH,SK": "初始克服困難，過程平穩，最終通過努力成功。整體大吉。\n\n初克中平，末靠自強\n千錘百煉，終成利器\n風雨過後，見彩虹美\n成就非凡，福澤綿長",
      "SK,BH,BH": "初始克服困難，過程平穩，最終平穩。整體大吉。\n\n初克中平，末歸平靜\n穩健前行，安泰無憂\n以剛克柔，以動制靜\n平衡陰陽，福壽安康",
      "BH,WS,WS": "初始平穩，過程中得到幫助，最終結果吉利。整體大吉。\n\n初平中助，末得圓滿\n穩中求進，順水行舟\n平和安泰，福運自來\n吉祥如意，萬事順遂",
      "BH,WS,WK": "初始平穩，過程中得到幫助，最終結果凶險。整體小吉。\n\n初平中助，末路多艱\n居安思危，未雨綢繆\n以靜制動，以守為攻\n轉危為安，化險為夷",
      "BH,WS,SS": "初始平穩，過程中得到幫助，最終付出多收穫少。整體小吉。\n\n初平中助，末勞少獲\n知足常樂，隨遇而安\n勤儉持家，細水長流\n福雖遲來，終將降至",
      "BH,WS,SK": "初始平穩，過程中得到幫助，最終通過努力成功。整體大吉。\n\n初平中助，末靠自強\n穩中求進，勤能補拙\n堅持不懈，終有所成\n功成名就，福壽雙全",
      "BH,WS,BH": "初始平穩，過程中得到幫助，最終平穩。整體大吉。\n\n初平中助，末歸平靜\n四平八穩，安泰無憂\n平和處世，安康長久\n福澤綿延，吉祥如意",
      "BH,WK,WS": "初始平穩，過程中遇到阻礙，最終結果吉利。整體小吉。\n\n初平中阻，末得圓滿\n穩中求進，順水行舟\n平和安泰，福運自來\n吉祥如意，萬事順遂",
      "BH,WK,WK": "初始平穩，過程中遇到阻礙，最終結果凶險。整體小凶。\n\n初平中阻，末路多艱\n居安思危，未雨綢繆\n以靜制動，以守為攻\n轉危為安，化險為夷",
      "BH,WK,SS": "初始平穩，過程中遇到阻礙，最終付出多收穫少。整體小凶。\n\n初平中阻，末勞少獲\n知足常樂，隨遇而安\n勤儉持家，細水長流\n福雖遲來，終將降至",
      "BH,WK,SK": "初始平穩，過程中遇到阻礙，最終通過努力成功。整體小吉。\n\n初平中阻，末靠自強\n穩中求進，勤能補拙\n堅持不懈，終有所成\n功成名就，福壽雙全",
      "BH,WK,BH": "初始平穩，過程中遇到阻礙，最終平穩。整體小吉。\n\n初平中阻，末歸平靜\n四平八穩，安泰無憂\n平和處世，安康長久\n福澤綿延，吉祥如意",
      "BH,SS,WS": "初始平穩，過程中付出努力，最終結果吉利。整體小吉。\n\n初平中勞，末得圓滿\n穩中求進，順水行舟\n平和安泰，福運自來\n吉祥如意，萬事順遂",
      "BH,SS,WK": "初始平穩，過程中付出努力，最終結果凶險。整體小凶。\n\n初平中勞，末路多艱\n居安思危，未雨綢繆\n以靜制動，以守為攻\n轉危為安，化險為夷",
      "BH,SS,SS": "初始平穩，過程中付出努力，最終付出多收穫少。整體小凶。\n\n初平中勞，末勞少獲\n知足常樂，隨遇而安\n勤儉持家，細水長流\n福雖遲來，終將降至",
      "BH,SS,SK": "初始平穩，過程中付出努力，最終通過努力成功。整體小吉。\n\n初平中勞，末靠自強\n穩中求進，勤能補拙\n堅持不懈，終有所成\n功成名就，福壽雙全",
      "BH,SS,BH": "初始平穩，過程中付出努力，最終平穩。整體小吉。\n\n初平中勞，末歸平靜\n四平八穩，安泰無憂\n平和處世，安康長久\n福澤綿延，吉祥如意",
      "BH,SK,WS": "初始平穩，過程中克服困難，最終結果吉利。整體大吉。\n\n初平中克，末得圓滿\n穩中求進，順水行舟\n平和安泰，福運自來\n吉祥如意，萬事順遂",
      "BH,SK,WK": "初始平穩，過程中克服困難，最終結果凶險。整體小吉。\n\n初平中克，末路多艱\n居安思危，未雨綢繆\n以靜制動，以守為攻\n轉危為安，化險為夷",
      "BH,SK,SS": "初始平穩，過程中克服困難，最終付出多收穫少。整體小吉。\n\n初平中克，末勞少獲\n知足常樂，隨遇而安\n勤儉持家，細水長流\n福雖遲來，終將降至",
      "BH,SK,SK": "初始平穩，過程中克服困難，最終通過努力成功。整體大吉。\n\n初平中克，末靠自強\n穩中求進，勤能補拙\n堅持不懈，終有所成\n功成名就，福壽雙全",
      "BH,SK,BH": "初始平穩，過程中克服困難，最終平穩。整體大吉。\n\n初平中克，末歸平靜\n四平八穩，安泰無憂\n平和處世，安康長久\n福澤綿延，吉祥如意",
      "BH,BH,WS": "初始平穩，過程平穩，最終結果吉利。整體大吉。\n\n初平中平，末得圓滿\n穩中求進，順水行舟\n平和安泰，福運自來\n吉祥如意，萬事順遂",
      "BH,BH,WK": "初始平穩，過程平穩，最終結果凶險。整體小吉。\n\n初平中平，末路多艱\n居安思危，未雨綢繆\n以靜制動，以守為攻\n轉危為安，化險為夷",
      "BH,BH,SS": "初始平穩，過程平穩，最終付出多收穫少。整體小吉。\n\n初平中平，末勞少獲\n知足常樂，隨遇而安\n勤儉持家，細水長流\n福雖遲來，終將降至",
      "BH,BH,SK": "初始平穩，過程平穩，最終通過努力成功。整體大吉。\n\n初平中平，末靠自強\n穩中求進，勤能補拙\n堅持不懈，終有所成\n功成名就，福壽雙全",
      "BH,BH,BH": "初始平穩，過程平穩，最終平穩。整體大吉。\n\n初平中平，末歸平靜\n四平八穩，安泰無憂\n平和處世，安康長久\n福澤綿延，吉祥如意",
    };

    function getRelation(fromElement, toElement) {
      const relation = fiveRelations.find(rel => rel.from === fromElement && rel.to === toElement);
      if (relation) {
        if (relation.type === "生") {
          return { type: "生", str: `${fromElement}生${toElement}` };
        } else if (relation.type === "剋") {
          return { type: "剋", str: `${fromElement}剋${toElement}` };
        }
      }
      if (fromElement === toElement) {
        return { type: "比和", str: `${fromElement}比和${toElement}` };
      }
      return { type: "無", str: "無關" };
    }

    function analyzeFiveElements(bodyElement, useElement) {
      let relationType = "無";
      let relationStr = "無關";
      let relationColor = "gray";

      const relation = fiveRelations.find(r => r.from === bodyElement && r.to === useElement);
      if (relation) {
        if (relation.type === "生") {
          relationStr = `體生用: ${bodyElement}生${useElement}`;
          relationColor = "blue";
          relationType = "體生用";
        } else if (relation.type === "剋") {
          relationStr = `體剋用: ${bodyElement}剋${useElement}`;
          relationColor = "purple";
          relationType = "體剋用";
        }
      }
      const reverseRelation = fiveRelations.find(r => r.from === useElement && r.to === bodyElement);
      if (reverseRelation) {
        if (reverseRelation.type === "生") {
          relationStr = `用生體: ${useElement}生${bodyElement}`;
          relationColor = "green";
          relationType = "用生體";
        } else if (reverseRelation.type === "剋") {
          relationStr = `用剋體: ${useElement}剋${bodyElement}`;
          relationColor = "red";
          relationType = "用剋體";
        }
      }

      if (bodyElement === useElement) {
        relationStr = `比和: ${bodyElement}比和${useElement}`;
        relationColor = "orange";
        relationType = "比和";
      }

      return { relationType, relationStr, relationColor };
    }

    function calculateWuxingStatus(timeElement) {
      const fiveElements = ["木", "火", "土", "金", "水"];
      const status = {};

      for (const element of fiveElements) {
        let currentStatus = "死";
        const relation = getRelation(timeElement, element);
        const reverseRelation = getRelation(element, timeElement);

        if (timeElement === element) {
          currentStatus = "旺";
        } else if (relation.type === "生") {
          currentStatus = "相";
        } else if (relation.type === "剋") {
          currentStatus = "休";
        } else if (reverseRelation.type === "剋") {
          currentStatus = "囚";
        } else if (reverseRelation.type === "生") {
          currentStatus = "死";
        }
        status[element] = currentStatus;
      }
      return status;
    }

    function drawRelationGraph(relationships, allTrigrams, timeElement, question) {
      const elementsToDraw = [...new Set([...allTrigrams.map(t => trigramFiveElement[t.name]), timeElement])];
      const positions = {};
      const centerX = 150, centerY = 150, radius = 120;
      const angleStep = (2 * Math.PI) / elementsToDraw.length;
      elementsToDraw.forEach((el, i) => {
        positions[el] = {
          x: centerX + radius * Math.cos(angleStep * i - Math.PI / 2),
          y: centerY + radius * Math.sin(angleStep * i - Math.PI / 2),
        };
      });

      let svgHtml = `<svg width="300" height="300" viewBox="0 0 300 300" xmlns="http://www.w3.org/2000/svg" class="mx-auto">`;
      svgHtml += `<text x="150" y="20" font-size="14" font-weight="bold" text-anchor="middle" fill="#333">五行生剋關係圖</text>`;
      svgHtml += `<text x="150" y="35" font-size="12" text-anchor="middle" fill="#666">問題: ${question}</text>`;

      const drawnLines = new Set();
      relationships.forEach(rel => {
        const fromPos = positions[rel.bodyElement];
        const toPos = positions[rel.useElement];
        const lineId = [rel.bodyElement, rel.useElement].sort().join('-');
        if (fromPos && toPos && !drawnLines.has(lineId)) {
          const color = rel.relationType === "生" ? "green" : (rel.relationType === "剋" ? "red" : "gray");
          const strokeWidth = 2;
          svgHtml += `<line x1="${fromPos.x}" y1="${fromPos.y}" x2="${toPos.x}" y2="${toPos.y}" stroke="${color}" stroke-width="${strokeWidth}" marker-end="url(#arrowhead-${color.replace('#', '')})" />`;
          drawnLines.add(lineId);
        }
      });

      elementsToDraw.forEach(el => {
        const pos = positions[el];
        const status = wuxingStatus[calculateWuxingStatus(timeElement)[el]];
        svgHtml += `<circle cx="${pos.x}" cy="${pos.y}" r="20" fill="${fiveElementColors[el]}" stroke="black" stroke-width="${status.strokeWidth}" opacity="${status.opacity}" />`;
        svgHtml += `<text x="${pos.x}" y="${pos.y + 5}" font-size="12" text-anchor="middle" fill="white" font-weight="bold">${el}</text>`;
      });

      relationships.forEach(rel => {
        const fromPos = positions[rel.bodyElement];
        const toPos = positions[rel.useElement];
        if (fromPos && toPos) {
          const midX = (fromPos.x + toPos.x) / 2;
          const midY = (fromPos.y + toPos.y) / 2;
          const color = colors[rel.relationType];
          svgHtml += `<text x="${midX}" y="${midY}" font-size="10" fill="${color}" text-anchor="middle" font-weight="bold">${rel.relationType}</text>`;
        }
      });

      svgHtml += `<defs>`;
      for (const key in colors) {
        const color = colors[key];
        svgHtml += `<marker id="arrowhead-${color.replace('#', '')}" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto" fill="${color}"><polygon points="0 0, 10 3.5, 0 7" /></marker>`;
      }
      svgHtml += `</defs>`;
      svgHtml += `</svg>`;
      return svgHtml;
    }

    function generateWuxingStatusHtml(wuxingStatus, timeElement) {
      let html = `<div class="grid grid-cols-5 gap-2 text-center text-sm font-bold">`;
      for (const element of fiveElementsOrder) {
        html += `
          <div class="p-2 rounded-lg" style="background-color: ${fiveElementColors[element]}; color: white;">
            ${element}<br>
            <span class="text-xl">${wuxingStatus[element]}</span>
          </div>
        `;
      }
      html += `</div>`;
      html += `<p class="mt-4 text-center text-gray-700">當前時辰五行為<span class="font-bold text-lg text-${fiveElementColors[timeElement]}">${timeElement}</span>，決定各個五行的狀態。</p>`;
      return html;
    }

    const statusEl = document.getElementById("status");
    const logDiv = document.getElementById("logDiv");

    const client = mqtt.connect('wss://broker.mqttgo.io:8084/mqtt');

    client.on('connect', () => {
      statusEl.textContent = '已成功連線到 MQTT Broker。';
      client.subscribe('mhxingyi/+/request');
      logDiv.innerHTML = `<div class="text-green-600 font-bold">已成功連線，正在監聽請求...</div>`;
    });

    client.on('message', (topic, message) => {
      logDiv.innerHTML += `<div class="mt-2 text-blue-600">收到請求: ${topic}</div>`;
      try {
        const payload = JSON.parse(message.toString());
        const { id, question, data } = payload;
        const now = new Date();

        const upperName = trigramsName[data.upper];
        const lowerName = trigramsName[data.lower];
        const hexagramName = sixtyFourHexagrams[`${data.upper}${data.lower}`];
        
        let changedUpper = data.upper;
        let changedLower = data.lower;
        
        const isUpperMoving = data.movingLine <= 3;
        const isLowerMoving = data.movingLine > 3;

        if(data.movingLine === 1) changedLower = data.lower ^ 1;
        if(data.movingLine === 2) changedLower = data.lower ^ 2;
        if(data.movingLine === 3) changedLower = data.lower ^ 4;
        if(data.movingLine === 4) changedUpper = data.upper ^ 1;
        if(data.movingLine === 5) changedUpper = data.upper ^ 2;
        if(data.movingLine === 6) changedUpper = data.upper ^ 4;

        const changedHexagramName = sixtyFourHexagrams[`${changedUpper}${changedLower}`];
        const changedUpperName = trigramsName[changedUpper];
        const changedLowerName = trigramsName[changedLower];

        const mutualUpper = data.lower;
        const mutualLower = data.upper;
        const mutualHexagramName = sixtyFourHexagrams[`${mutualUpper}${mutualLower}`];
        const mutualUpperName = trigramsName[mutualUpper];
        const mutualLowerName = trigramsName[mutualLower];
        
        const bodyTrigram = isUpperMoving ? trigramsName[data.lower] : trigramsName[data.upper];
        const useTrigram = isUpperMoving ? trigramsName[data.upper] : trigramsName[data.lower];
        const mutualUseTrigram = isUpperMoving ? trigramsName[mutualUpper] : trigramsName[mutualLower];
        const changedUseTrigram = isUpperMoving ? trigramsName[changedUpper] : trigramsName[changedLower];

        const timeElement = fiveElementsOrder[now.getHours() % 5];
        const wuxingStatusResult = calculateWuxingStatus(timeElement);
        
        const fiveRelAnalysis = analyzeFiveElements(trigramFiveElement[bodyTrigram], trigramFiveElement[useTrigram]);
        const mutualFiveRelAnalysis = analyzeFiveElements(trigramFiveElement[bodyTrigram], trigramFiveElement[mutualUseTrigram]);
        const changedFiveRelAnalysis = analyzeFiveElements(trigramFiveElement[bodyTrigram], trigramFiveElement[changedUseTrigram]);

        const finalVerdictKey = [fiveRelAnalysis.relationType, mutualFiveRelAnalysis.relationType, changedFiveRelAnalysis.relationType]
          .map(t => {
            if(t === "用生體") return "WS";
            if(t === "用剋體") return "WK";
            if(t === "體生用") return "SS";
            if(t === "體剋用") return "SK";
            if(t === "比和") return "BH";
            return "無";
          }).join(',');

        const finalVerdict = wuxingStatusMap[finalVerdictKey];
        const adviceText = finalVerdict || "無對應判斷，請參考五行生剋關係。";
        const hexagramStr = `${data.upper}${data.lower}`;
        const mutualHexagramStr = `${mutualUpper}${mutualLower}`;
        const changedHexagramStr = `${changedUpper}${changedLower}`;
        const wuxingStatusHtml = generateWuxingStatusHtml(wuxingStatusResult, timeElement);
        
        const allTrigrams = [
          {name: bodyTrigram, label: "體:"},
          {name: useTrigram, label: "用(本):"},
          {name: mutualUseTrigram, label: "用(互):"},
          {name: changedUseTrigram, label: "用(變):"}
        ];

        const relationshipsToDraw = [
          {bodyElement: trigramFiveElement[bodyTrigram], useElement: trigramFiveElement[useTrigram], relationType: fiveRelAnalysis.relationType},
          {bodyElement: trigramFiveElement[bodyTrigram], useElement: trigramFiveElement[mutualUseTrigram], relationType: mutualFiveRelAnalysis.relationType},
          {bodyElement: trigramFiveElement[bodyTrigram], useElement: trigramFiveElement[changedUseTrigram], relationType: changedFiveRelAnalysis.relationType},
        ];

        const graphHtml = drawRelationGraph(relationshipsToDraw, allTrigrams, timeElement, question);

        const resultData = {
          hexagramStr, mutualHexagramStr, changedHexagramStr,
          hexagramName, mutualHexagramName, changedHexagramName,
          upperName, lowerName, mutualUpperName, mutualLowerName,
          changedUpperName, changedLowerName,
          bodyTrigram, useTrigram, mutualUseTrigram, changedUseTrigram,
          fiveRelAnalysis, mutualFiveRelAnalysis, changedFiveRelAnalysis,
          finalVerdict, adviceText, graphHtml,
          wuxingStatusHtml,
          timestamp: now.toISOString(),
          question: question,
          data
        };

        client.publish(`mhxingyi/${id}/result`, JSON.stringify(resultData));
        statusEl.textContent = `已處理並回傳: ${topic}`;
      } catch (e) {
        logDiv.innerHTML += `<div class="mt-2 text-red-600 font-bold">處理訊息失敗: ${e.message}</div>`;
        console.error("Failed to process message:", e);
      }
    });

    client.on('error', (err) => {
      logDiv.innerHTML += `<div class="mt-2 text-red-600 font-bold">MQTT 連線錯誤：${err.message}</div>`;
      statusEl.textContent = '連線錯誤。';
    });

    client.on('offline', () => {
      logDiv.innerHTML += `<div class="mt-2 text-red-600 font-bold">MQTT 連線已中斷。</div>`;
      statusEl.textContent = '連線已中斷。';
    });
  </script>
</body>
</html>
