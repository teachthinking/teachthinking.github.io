<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>æ™ºæ…§åœå¦ç³»çµ±</title>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; max-width: 800px; margin: auto; }
    select, button { padding: 8px; margin: 5px; font-size: 16px; }
    #chart { width: 600px; height: 600px; background: #f9f9f9; margin-top: 20px; }
    .log { background: #eee; padding: 10px; margin-top: 10px; white-space: pre-wrap; }
  </style>
</head>
<body>
  <h2>ğŸŒ¿ æ™ºæ…§åœå¦ç³»çµ±</h2>

  <p><strong>MQTT Brokerï¼š</strong> wss://broker.mqttgo.io:8084/mqtt</p>
  <button onclick="connectMQTT()">é€£ç·š MQTT</button>

  <div>
    <label>ä¸Šå¦ï¼š</label>
    <select id="upper">
      <option value="1">ä¹¾</option><option value="2">å…Œ</option><option value="3">é›¢</option>
      <option value="4">éœ‡</option><option value="5">å·½</option><option value="6">å</option>
      <option value="7">è‰®</option><option value="8">å¤</option>
    </select>

    <label>ä¸‹å¦ï¼š</label>
    <select id="lower">
      <option value="1">ä¹¾</option><option value="2">å…Œ</option><option value="3">é›¢</option>
      <option value="4">éœ‡</option><option value="5">å·½</option><option value="6">å</option>
      <option value="7">è‰®</option><option value="8">å¤</option>
    </select>

    <label>å‹•çˆ»ï¼š</label>
    <select id="yao">
      <option value="1">åˆçˆ»</option><option value="2">äºŒçˆ»</option><option value="3">ä¸‰çˆ»</option>
      <option value="4">å››çˆ»</option><option value="5">äº”çˆ»</option><option value="6">ä¸Šçˆ»</option>
    </select>

    <button onclick="sendGua()">é€å‡ºå¦è±¡</button>
  </div>

  <div class="log" id="log"></div>
  <svg id="chart"></svg>

  <script>
    let client;
    const brokerURL = "wss://broker.mqttgo.io:8084/mqtt";

    const guaMap = ['ä¹¾','å…Œ','é›¢','éœ‡','å·½','å','è‰®','å¤'];
    const elements = {
      'ä¹¾': 'é‡‘', 'å¤': 'åœŸ', 'éœ‡': 'æœ¨', 'å·½': 'æœ¨',
      'å': 'æ°´', 'é›¢': 'ç«', 'è‰®': 'åœŸ', 'å…Œ': 'é‡‘'
    };
    const colors = {
      'æœ¨': '#4CAF50', 'ç«': '#F44336', 'åœŸ': '#FFEB3B',
      'é‡‘': '#9E9E9E', 'æ°´': '#2196F3'
    };
    const generate = { æœ¨: 'ç«', ç«: 'åœŸ', åœŸ: 'é‡‘', é‡‘: 'æ°´', æ°´: 'æœ¨' };
    const overcome = { æœ¨: 'åœŸ', åœŸ: 'æ°´', æ°´: 'ç«', ç«: 'é‡‘', é‡‘: 'æœ¨' };

    function connectMQTT() {
      client = mqtt.connect(brokerURL);
      client.on('connect', () => log('âœ… å·²é€£ç·šè‡³ MQTT Broker'));
      client.subscribe('JUSTIN/Q1');
      client.on('message', (topic, message) => {
        log(ğŸ“© æ”¶åˆ°è¨Šæ¯ï¼š${topic} â†’ ${message});
        if (topic === 'JUSTIN/Q1') {
          const parts = message.toString().split('/');
          const guaInfo = parseGua(parts);
          const analysis = analyzeGua(guaInfo);
          drawChart(analysis);
        }
      });
    }

    function sendGua() {
      const upper = document.getElementById('upper').value;
      const lower = document.getElementById('lower').value;
      const yao = document.getElementById('yao').value;
      const msg = JUSTIN/Q1/${upper}/${lower}/${yao};
      client.publish('JUSTIN/Q1', msg);
      log(ğŸš€ ç™¼é€å¦è±¡ï¼š${msg});
    }

    function parseGua(parts) {
      const upperGua = guaMap[parseInt(parts[2]) - 1];
      const lowerGua = guaMap[parseInt(parts[3]) - 1];
      const movingYao = parseInt(parts[4]);
      return { upperGua, lowerGua, movingYao };
    }

    function analyzeGua({ upperGua, lowerGua }) {
      const ti = elements[lowerGua];
      const yong = elements[upperGua];
      const hu = 'æœ¨';   // æ¨¡æ“¬äº’å¦äº”è¡Œ
      const bian = 'ç«'; // æ¨¡æ“¬è®Šå¦äº”è¡Œ
      return {
        ti, yong, hu, bian,
        relations: [
          { from: yong, to: ti },
          { from: hu, to: ti },
          { from: bian, to: ti }
        ]
      };
    }

    function drawChart({ ti, relations }) {
      const svg = document.getElementById('chart');
      svg.innerHTML = '';
      const pos = {
        æœ¨: [300, 100], ç«: [450, 250], åœŸ: [300, 400],
        é‡‘: [150, 250], æ°´: [300, 250]
      };

      for (let key in pos) {
        const [x, y] = pos[key];
        const circle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
        circle.setAttribute("cx", x);
        circle.setAttribute("cy", y);
        circle.setAttribute("r", 40);
        circle.setAttribute("fill", colors[key]);
        svg.appendChild(circle);

        const text = document.createElementNS("http://www.w3.org/2000/svg", "text");
        text.setAttribute("x", x);
        text.setAttribute("y", y);
        text.setAttribute("text-anchor", "middle");
        text.setAttribute("dominant-baseline", "middle");
        text.setAttribute("font-size", "20");
        text.textContent = key;
        svg.appendChild(text);
      }

      relations.forEach(rel => {
        const [x1, y1] = pos[rel.from];
        const [x2, y2] = pos[rel.to];
        const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
        line.setAttribute("x1", x1);
        line.setAttribute("y1", y1);
        line.setAttribute("x2", x2);
        line.setAttribute("y2", y2);

        const type = getRelationType(rel.from, rel.to, ti);
        line.setAttribute("stroke", type === 'ç”Ÿ' ? 'green' : type === 'å…‹' ? 'red' : 'gray');
        line.setAttribute("stroke-width", type === 'ç”Ÿ' ? 4 : type === 'å…‹' ? 2 : 3);
        svg.appendChild(line);
      });
    }

    function getRelationType(from, to, ti) {
      if (generate[from] === to) return 'ç”Ÿ';
      if (overcome[from] === to) return 'å…‹';
      if (from === to) return 'æ¯”å’Œ';
      return 'ç„¡';
    }

    function log(msg) {
      document.getElementById('log').textContent += msg + '\n';
    }
  </script>
</body>
</html>
