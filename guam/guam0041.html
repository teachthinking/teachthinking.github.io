<html lang="zh-TW">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>張老師易經(梅花心易)</title>
  <style>
   :root {
    --primary-color: #2c3e50;
    --secondary-color: #3498db;
    --negative-color: #e74c3c;
    --positive-color: #4caf50;
    --yellow-color: #f1c40f;
    --background-color: #f4f7f9;
    --card-bg: #ffffff;
    --border-color: #e0e6ed;
    --text-color: #333333;
    --sub-text-color: #7f8c8d;
    --shadow-light: 0 4px 12px rgba(0, 0, 0, 0.05);
    --border-radius: 12px;
    --font-family: 'Noto Sans TC', sans-serif;
  }

    body {
      font-family: var(--font-family);
      background: var(--background-color);
      color: var(--text-color);
      padding: 20px;
      line-height: 1.6;
      margin: 0;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: var(--card-bg);
      padding: 25px;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow-light);
    }

    h1 {
      margin: 0 0 8px 0;
      font-size: 28px;
      color: var(--primary-color);
    }

    h2.subtitle {
      margin: 0 0 20px 0;
      color: var(--sub-text-color);
      font-weight: 400;
      font-size: 16px;
      border-bottom: 1px solid var(--border-color);
      padding-bottom: 15px;
    }

    .tab-buttons {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }

    .tab-button {
      padding: 10px 18px;
      border-radius: var(--border-radius);
      border: 1px solid var(--border-color);
      background: transparent;
      cursor: pointer;
      color: var(--sub-text-color);
      transition: all 0.3s ease;
      font-size: 15px;
    }

    .tab-button.active {
      background: var(--primary-color);
      color: #fff;
      border-color: var(--primary-color);
    }

    .tab-content {
      display: none;
      padding-top: 10px;
    }

    .tab-content.active {
      display: block;
    }

    .row {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
      margin: 12px 0;
    }

    .hint {
      font-size: 13px;
      color: var(--sub-text-color);
      line-height: 1.5;
    }

    .gua-box {
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius);
      padding: 20px;
      background: var(--background-color);
      margin-bottom: 20px;
    }

    .hidden {
      display: none;
    }

    button.primary {
      background: var(--primary-color);
      color: #fff;
      border: none;
      padding: 10px 20px;
      border-radius: var(--border-radius);
      cursor: pointer;
      transition: background 0.3s ease;
    }

    button.primary:hover {
      background: var(--secondary-color);
    }

    input, select {
      padding: 8px;
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius);
      font-size: 14px;
    }

    .gua-display-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin: 10px 0;
    }

    .gua-line {
      width: 60px;
      height: 10px;
      margin: 5px 0;
      background: var(--text-color);
      position: relative;
    }

    .gua-line.yin::after {
      content: '';
      position: absolute;
      width: 20px;
      height: 10px;
      background: var(--card-bg);
      left: 20px;
    }

    .gua-line.moving::before {
      content: '×';
      position: absolute;
      color: var(--negative-color);
      font-size: 16px;
      left: -20px;
      top: -3px;
    }

    .gua-name {
      margin-top: 10px;
      font-weight: bold;
      font-size: 16px;
      color: var(--primary-color);
      text-align: center;
    }

    .wuxing-box {
      margin: 15px 0;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      max-width: 600px;
    }

    .wuxing-box ul {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .wuxing-box li {
      flex: 1 1 calc(50% - 10px);
      min-width: 280px;
      padding: 10px;
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius);
      background: var(--card-bg);
    }

    .wuxing-status {
      font-weight: bold;
    }

    .wuxing-status.positive { color: var(--positive-color); }
    .wuxing-status.neutral { color: var(--secondary-color); }
    .wuxing-status.negative { color: var(--negative-color); }

    .wuxing-node {
      fill: #ecf0f1;
      stroke: var(--primary-color);
      stroke-width: 2;
    }

    .wuxing-node:hover {
      fill: #d5e8f9;
      cursor: pointer;
    }

    .wuxing-node-text {
      text-anchor: middle;
      font-size: 12px;
      fill: var(--text-color);
    }

    .wuxing-edge-generate {
      stroke: var(--positive-color);
    }

    .wuxing-edge-overcome {
      stroke: var(--negative-color);
    }

    .wuxing-edge-harmony {
      stroke: var(--secondary-color);
    }

    .wuxing-edge-label {
      font-size: 10px;
      fill: var(--text-color);
      text-anchor: middle;
    }

    .score-card {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 10px 0;
      padding: 10px;
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius);
      font-size: 14px;
    }

    .score-bar-wrap {
      flex: 1;
      height: 20px;
      background: #e0e6ed;
      border-radius: 10px;
      overflow: hidden;
    }

    .score-bar {
      height: 100%;
      transition: width 0.3s ease;
    }

    .score-val {
      font-weight: bold;
      color: var(--positive-color);
      min-width: 40px;
      text-align: right;
    }

    .auspiciousness-index {
      font-size: 18px;
      font-weight: bold;
      margin: 15px 0;
      padding: 10px;
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius);
      text-align: center;
    }

    .auspiciousness-bar {
      height: 20px;
      width: 100%;
      max-width: 400px;
      margin: 10px auto;
      border-radius: var(--border-radius);
      overflow: hidden;
    }

    .line-explanation {
      margin: 15px 0;
      padding: 10px;
      background: var(--background-color);
      border-radius: var(--border-radius);
    }

    .wuxing-controls {
      display: flex;
      gap: 10px;
      margin: 10px 0;
    }
    .wuxing-box p {
      margin: 8px 0;
      font-size: 14px;
      line-height: 1.6;
    }
    .wuxing-box h4 {
      margin: 15px 0 10px;
      font-size: 16px;
      color: var(--primary-color);
    }
    .wuxing-box strong {
      color: var(--text-color);
      font-weight: 600;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>張老師易經(梅花心易)</h1>
    <h2 id="subtitle" class="subtitle">請選擇取卦方式以開始占卜</h2>
    <div class="tab-buttons">
      <button class="tab-button active" data-target="number">數字取卦</button>
      <button class="tab-button" data-target="manual">手動取卦</button>
      <button class="tab-button" data-target="time">時間取卦</button>
      <button class="tab-button" data-target="image">以象取卦</button>
      <button class="tab-button" data-target="history">歷史記錄</button>
    </div>
    <div id="number" class="tab-content active">
      <div class="row">
        <label>上卦數字(100-999)：</label>
        <input id="numUpper" type="number" min="100" max="999" />
      </div>
      <div class="row">
        <label>下卦數字(100-999)：</label>
        <input id="numLower" type="number" min="100" max="999" />
      </div>
      <div class="row">
        <label>動爻數字(100-999)：</label>
        <input id="numMoving" type="number" min="100" max="999" />
      </div>
      <div class="row">
        <label>問題（可選）：</label>
        <input id="questionNumber" type="text" placeholder="請輸入您的問題" />
      </div>
      <div class="row">
        <button id="btnNumber" class="primary">數字取卦</button>
        <button id="btnRandomNumber" class="primary">亂數取卦</button>
      </div>
      <div class="hint">說明：輸入三組100-999的數字，分別用於計算上卦、下卦與動爻，或點擊「亂數取卦」自動生成數字。數字經模數運算轉換為卦象。</div>
    </div>
    <div id="manual" class="tab-content">
      <div class="row">
        <label>上卦：</label>
        <select id="selUpper">
          <option value="">請選擇</option>
          <option value="1">乾</option>
          <option value="2">兌</option>
          <option value="3">離</option>
          <option value="4">震</option>
          <option value="5">巽</option>
          <option value="6">坎</option>
          <option value="7">艮</option>
          <option value="8">坤</option>
        </select>
      </div>
      <div class="row">
        <label>下卦：</label>
        <select id="selLower">
          <option value="">請選擇</option>
          <option value="1">乾</option>
          <option value="2">兌</option>
          <option value="3">離</option>
          <option value="4">震</option>
          <option value="5">巽</option>
          <option value="6">坎</option>
          <option value="7">艮</option>
          <option value="8">坤</option>
        </select>
      </div>
      <div class="row">
        <label>動爻（1-6，可多選以逗號分隔）：</label>
        <input id="inputMoving" type="text" placeholder="例如：1,3,5" />
      </div>
      <div class="row">
        <label>問題（可選）：</label>
        <input id="questionManual" type="text" placeholder="請輸入您的問題" />
      </div>
      <button id="btnManual" class="primary">手動取卦</button>
      <div class="hint">說明：直接選擇上卦與下卦，並指定動爻（若有）。動爻以逗號分隔輸入，例如“1,3,5”。</div>
    </div>
    <div id="time" class="tab-content">
      <div class="row">
        <label><input type="radio" name="time-method" value="modern" checked /> 現代時間</label>
        <label><input type="radio" name="time-method" value="traditional" /> 傳統時辰</label>
      </div>
      <div id="modern-time-inputs">
        <div class="row">
          <label>日期時間：</label>
          <input id="dtInput" type="datetime-local" />
          <button id="nowQuick" class="primary">現在</button>
        </div>
        <div class="row">
          <label>問題（可選）：</label>
          <input id="questionTime" type="text" placeholder="請輸入您的問題" />
        </div>
      </div>
      <div id="traditional-time-inputs" class="hidden">
        <div class="row">
          <label>日期：</label>
          <input id="dateInput" type="date" />
        </div>
        <div class="row">
          <label>時辰：</label>
          <select id="shichenInput">
            <option value="23">子時 (23:00-01:00)</option>
            <option value="1">丑時 (01:00-03:00)</option>
            <option value="3">寅時 (03:00-05:00)</option>
            <option value="5">卯時 (05:00-07:00)</option>
            <option value="7">辰時 (07:00-09:00)</option>
            <option value="9">巳時 (09:00-11:00)</option>
            <option value="11">午時 (11:00-13:00)</option>
            <option value="13">未時 (13:00-15:00)</option>
            <option value="15">申時 (15:00-17:00)</option>
            <option value="17">酉時 (17:00-19:00)</option>
            <option value="19">戌時 (19:00-21:00)</option>
            <option value="21">亥時 (21:00-23:00)</option>
          </select>
        </div>
        <div class="row">
          <label>問題（可選）：</label>
          <input id="questionTraditional" type="text" placeholder="請輸入您的問題" />
        </div>
      </div>
      <button id="btnTime" class="primary">時間取卦</button>
      <div class="hint">說明：根據日期與時辰的數字來計算上卦、下卦與動爻。</div>
    </div>
    <div id="image" class="tab-content">
      <div class="row">
        <label>上卦：</label>
        <select id="selImageUpper">
          <option value="">請選擇</option>
          <option value="1">圓、馬</option>
          <option value="2">缺、羊、石</option>
          <option value="3">電、日、火</option>
          <option value="4">雷、龍、木</option>
          <option value="5">風、雞、繩</option>
          <option value="6">水、月、豬</option>
          <option value="7">山、狗、虎</option>
          <option value="8">方、牛、地</option>
        </select>
      </div>
      <div class="row">
        <label>下卦：</label>
        <select id="selImageLower">
          <option value="">請選擇</option>
          <option value="1">圓、馬</option>
          <option value="2">缺、羊、石</option>
          <option value="3">電、日、火</option>
          <option value="4">雷、龍、木</option>
          <option value="5">風、雞、繩</option>
          <option value="6">水、月、豬</option>
          <option value="7">山、狗、虎</option>
          <option value="8">方、牛、地</option>
        </select>
      </div>
      <div class="row">
        <label>動爻：</label>
        <select id="selImageMoving">
          <option value="">請選擇</option>
          <option value="1">1</option>
          <option value="2">2</option>
          <option value="3">3</option>
          <option value="4">4</option>
          <option value="5">5</option>
          <option value="6">6</option>
        </select>
      </div>
      <div class="row">
        <label>問題（可選）：</label>
        <input id="questionImage" type="text" placeholder="請輸入您的問題" />
      </div>
      <button id="btnImage" class="primary">以象取卦</button>
      <div class="hint">說明：根據所見之物象，將其屬性轉換為卦象。</div>
    </div>
    <div id="history" class="tab-content">
      <div class="row">
        <button id="clearHistoryBtn" class="primary">清除歷史記錄</button>
        <button id="exportHistoryBtn" class="primary">匯出歷史記錄</button>
      </div>
      <div class="row">
        <input type="file" id="importHistoryInput" accept=".json" />
        <button id="importHistoryBtn" class="primary">匯入歷史記錄</button>
      </div>
      <div id="historyList"></div>
    </div>
    <div id="result" class="gua-box hidden">
      <h3 id="result-question"></h3>
      <div class="auspiciousness-index">
        <span id="auspiciousness-text"></span>
        <div class="auspiciousness-bar"><div id="auspiciousness-bar-inner" class="score-bar"></div></div>
      </div>
      <div class="row" style="justify-content: center; gap: 40px; margin: 25px 0;">
        <div id="originalGua" class="gua-display-container"></div>
        <div id="movingGua" class="gua-display-container"></div>
        <div id="changedGua" class="gua-display-container"></div>
      </div>
      <div id="wuxing-relations-box" class="wuxing-box">
        <h4>五行生克分析</h4>
        <div class="wuxing-controls">
          <button id="downloadSvgBtn" class="primary">下載五行圖(SVG)</button>
          <button id="openSvgWindowBtn" class="primary">新視窗開啟五行圖</button>
        </div>
        <div id="wuxing-diagram-container"></div>
        <div id="wuxing-analysis-content"></div>
      </div>
      <div id="detailed-analysis-box" class="gua-box">
        <h4>詳細卦象解釋</h4>
        <div id="detailed-analysis-content"></div>
      </div>
      <div id="line-explanation-box" class="gua-box hidden">
        <h4>動爻解釋</h4>
        <div id="line-explanation-content"></div>
      </div>
      <div id="tip-for-yong-ke-ti-box" class="gua-box hidden">
        <h4>用卦克體卦化解建議</h4>
        <div id="tip-for-yong-ke-ti-content"></div>
      </div>
    </div>
  </div>

  <script>
    const GUA_DATA = {
      1: { name: "乾", wuxing: "金", symbol: "☰", english: "Qian" },
      2: { name: "兌", wuxing: "金", symbol: "☱", english: "Dui" },
      3: { name: "離", wuxing: "火", symbol: "☲", english: "Li" },
      4: { name: "震", wuxing: "木", symbol: "☳", english: "Zhen" },
      5: { name: "巽", wuxing: "木", symbol: "☴", english: "Xun" },
      6: { name: "坎", wuxing: "水", symbol: "☵", english: "Kan" },
      7: { name: "艮", wuxing: "土", symbol: "☶", english: "Gen" },
      8: { name: "坤", wuxing: "土", symbol: "☷", english: "Kun" },
    };

    const WUXING_COLORS = {
      "木": "#27ae60",
      "火": "#e74c3c",
      "土": "#d35400",
      "金": "#f1c40f",
      "水": "#3498db"
    };

    const WUXING_RELATIONS_DATA = {
      "relations": {
        "main": {
          "generate_ti": {
            "relation_id": "main_generate_ti",
            "display_name": "用生體",
            "overall": "這是一個大吉的卦象，代表外在環境或貴人對您主動付出，使您無須費力就能心想事成。",
            "details": {
              "qian": { "title": "乾金生體卦", "description": "主有官方、公職、長輩或尊貴人士相助。事情能得到官方認可，或因名聲、地位而獲利。有意外之財，或長輩饋贈。", "love": "感情上得到長輩支持，或對方地位顯赫，能為您帶來幫助。", "career": "事業上得貴人提拔，或有升職加薪、名聲遠播的機會。", "wealth": "財運來自長輩、官方或高層人士，或有投資黃金、珠寶獲利之喜。", "health": "健康受貴人支持，精神狀態佳。", "relationship": "人際關係中有權威人士協助，易得尊重。", "life": "生活順利，貴人運強。", "guidance": "請多向長輩或有經驗的人請教，他們將是您的貴人。" },
              "kun": { "title": "坤土生體卦", "description": "主有田地、房產之利，或得女性、大眾、基層人士的幫助。事情踏實穩定，能循序漸進地取得成果。", "love": "感情基礎穩固，能得到女性長輩或親友的支持。關係踏實，能給您安全感。", "career": "事業上能獲得基層或大眾的支持，適合從事房地產、農業或與大眾服務相關的行業。", "wealth": "財運來自不動產、土地或穩定的被動收入。適合穩健投資，財富能逐步累積。", "health": "健康因飲食規律或居住環境而改善，身體踏實。", "relationship": "人際關係和諧，能得眾人相助。", "life": "生活踏實穩定，能循序漸進。", "guidance": "腳踏實地，穩紮穩打，不要急於求成。與人為善，能得眾人之助。" },
              "zhen": { "title": "震木生體卦", "description": "主有突發之喜，或來自東方的財利。事情進展快速，能因變動而獲益。", "love": "感情進展迅速，可能有閃電式戀愛或意外的驚喜。對方充滿活力，能帶給您新鮮感。", "career": "事業有新的機會出現，適合開拓新市場或展開新專案。變動能帶來升職機會。", "wealth": "有意外之財或動態收入，適合投資新興產業或快速流通的商品。", "health": "健康因突發改變而改善，或適合進行動態運動。", "relationship": "人際關係活躍，能結交新朋友。", "life": "生活充滿驚喜，能因變動而獲益。", "guidance": "抓住機會，果斷行動。主動出擊，能事半功倍。" },
              "xun": { "title": "巽木生體卦", "description": "主有山林之利，或來自東南方、經商而得財。事情能順利進行，適合交易買賣。", "love": "感情關係順利，能因共同興趣或旅行而增進感情。適合與對方一起探索新事物。", "career": "事業進展順利，適合從事銷售、貿易或與流通相關的行業。能從溝通協調中獲益。", "wealth": "財運來自交易、商業買賣，適合經商或投資流動性強的商品。", "health": "健康平穩，注意呼吸系統。", "relationship": "人際關係和諧，能因良好溝通而獲利。", "life": "生活順利，能因交易買賣而獲利。", "guidance": "保持彈性與開放的心態，順應趨勢而為。多與人交流，能獲得商機。" },
              "kan": { "title": "坎水生體卦", "description": "主有來自北方或與水、酒相關的財利。事情能因溝通、文書而順利，或有酒食宴會之喜。", "love": "感情能從深入溝通中獲得滋養，適合敞開心扉，坦誠相待。", "career": "事業上適合從事寫作、出版、法律或與溝通相關的行業。能從合約或文書中獲得好處。", "wealth": "財運來自北方、與水相關的行業（如漁業、航運）或文書合約。有因應酬而得財的機會。", "health": "健康因飲食調整或水分補充而改善，注意腎臟。", "relationship": "人際關係能從深入溝通中獲得滋養。", "life": "生活順利，能因溝通而獲利。", "guidance": "多與人溝通，解決問題的關鍵在於信息的交流。保持冷靜與耐心，不要被表象迷惑。" },
              "li": { "title": "離火生體卦", "description": "主有南方之財，或文書、名譽之喜。事情能得到認可，或因名氣而獲利。", "love": "感情關係充滿熱情，能得到公開認可。雙方樂於展現自我，關係高調而熱烈。", "career": "事業上能因名氣、創意或曝光而成功。適合從事演藝、媒體、設計或任何需要展現自我的行業。", "wealth": "財運來自南方、與火相關的行業（如能源、餐飲）或智慧財產。適合投資具有高知名度的品牌。", "health": "健康因陽光照射或熱情而改善，注意心臟。", "relationship": "人際關係充滿熱情，能因名氣而獲利。", "life": "生活充滿熱情，能因名氣而獲利。", "guidance": "展現您的才華與熱情，能吸引好運。保持正面形象，名聲將為您帶來財富。" },
              "gen": { "title": "艮土生體卦", "description": "主有來自東北方或山林、田地之財。事情能穩健進展，最終能達到目標。", "love": "感情關係穩定，能因共同的興趣或穩定的生活而增進感情。適合建立長期的承諾。", "career": "事業發展穩健，適合從事房地產、建築或需要耐心的長期專案。", "wealth": "財運來自不動產或與土地相關的投資，適合長期持有，能穩步增值。", "health": "健康狀況穩定，適合進行戶外活動，注意脾胃。", "relationship": "人際關係穩定，能因誠信而獲利。", "life": "生活穩健，能因耐心而獲利。", "guidance": "保持耐心與毅力，所有努力最終都會有收穫。不要急於改變，堅守目標是成功的關鍵。" },
              "dui": { "title": "兌金生體卦", "description": "主有喜悅事，或因口舌、飲食而得利。能因人際關係和諧而獲益。", "love": "感情關係和諧愉快，能因良好的溝通和歡樂的氛圍而增進感情。適合享受生活中的小確幸。", "career": "事業上能因口才、人脈或社交而成功。適合從事銷售、公關或與娛樂相關的行業。", "wealth": "財運來自口才、人脈或餐飲娛樂業。有因喜事宴會而得財的機會。", "health": "健康因愉悅的心情而改善，注意呼吸道。", "relationship": "人際關係和諧，能因口才而獲利。", "life": "生活愉快，能因口才而獲利。", "guidance": "多與人交流，保持樂觀的心態，能吸引更多好運。享受當下，是最好的回報。" }
            }
          },
          "ti_generate_yong": {
            "relation_id": "main_ti_generate_yong",
            "display_name": "體生用",
            "overall": "這是一個凶險的卦象，代表您付出多但收穫少，容易勞而無功。在行動前務必三思。",
            "details": {
              "qian": { "title": "體卦乾金生用", "description": "主為公事、名譽而勞心，或因追求名聲、地位而損財。付出極大，但回報不彰。", "love": "感情中您付出較多，但可能得不到同等的回報，或因面子、金錢問題而耗損心力。", "career": "為工作付出大量心血，但成果與付出不成正比，甚至可能名聲受損。", "wealth": "財運不佳，投資或花費過多，入不敷出。或為維護形象而大筆開銷。", "health": "健康因過度勞累而下降，注意精神壓力。", "relationship": "人際關係中付出多，易被利用。", "life": "生活付出多，收穫少。", "guidance": "重新評估目標，學會放手。不要為虛名而勞心勞力。" },
              "kun": { "title": "體卦坤土生用", "description": "主為人際關係或家庭事務勞碌，付出辛勤勞動，但收穫甚微。易為他人作嫁衣。", "love": "您在感情中過於包容或付出，但對方可能視為理所當然，容易感到疲憊。", "career": "工作上為他人善後或做基層的辛苦活，但功勞可能被他人奪走。", "wealth": "財運不佳，容易為了家人或人際關係而花費過多，導致財務緊張。", "health": "健康因過度勞累而下降，注意脾胃。", "relationship": "人際關係中付出多，易感到疲憊。", "life": "生活付出多，收穫少。", "guidance": "照顧好自己，不要過度為他人付出。學會拒絕與適度放手。" },
              "zhen": { "title": "體卦震木生用", "description": "主因行動、衝動或變動而耗損精力。做事常虎頭蛇尾，付出後卻沒有顯著成果。", "love": "感情中您過於主動或衝動，但可能沒有考慮對方的感受，導致關係沒有實質進展。", "career": "事業上頻繁變動或轉換跑道，但沒有累積，導致勞而無功。", "wealth": "財運不佳，因衝動消費或不切實際的投資而破財。", "health": "健康因過度勞累而下降，注意肝臟。", "relationship": "人際關係中過於主動，易感到疲憊。", "life": "生活付出多，收穫少。", "guidance": "三思而後行，避免衝動。將精力集中在一件事上，才能看到成果。" },
              "xun": { "title": "體卦巽木生用", "description": "主因過度謙讓或優柔寡斷而耗損。付出多但效率低，容易陷入無謂的消耗。", "love": "感情中您過於被動或無法明確表達，導致關係停滯不前，錯失良機。", "career": "工作上猶豫不決，或因過度考慮他人感受而無法推進專案。", "wealth": "財運不佳，因過度謹慎或錯失良機而無法獲利。", "health": "健康因過度勞累而下降，注意呼吸系統。", "relationship": "人際關係中過於被動，易感到疲憊。", "life": "生活付出多，收穫少。", "guidance": "果斷決策，避免拖延。堅定自己的立場，才能減少不必要的消耗。" },
              "kan": { "title": "體卦坎水生用", "description": "主為人際關係、酒色或危險之事而耗損。付出多，但可能被他人欺騙或利用。", "love": "感情中您過度付出，但可能被對方利用或欺騙，需謹慎。", "career": "工作上可能為他人背黑鍋或陷入複雜的辦公室政治中，難以自拔。", "wealth": "財運不佳，容易因投資失誤、借貸或被騙而損失錢財。", "health": "健康因過度勞累而下降，注意腎臟。", "relationship": "人際關係中付出多，易被利用。", "life": "生活付出多，收穫少。", "guidance": "保持警惕，不要輕易相信他人。遠離是非，保護好自己的利益。" },
              "li": { "title": "體卦離火生用", "description": "主因情緒、脾氣或虛名而耗損。付出多但成果浮華，容易有口舌是非。", "love": "感情中您過於情緒化或急躁，導致關係緊張。過度的熱情可能嚇到對方。", "career": "工作上常因情緒用事或過度張揚而影響人際關係，導致無法順利推展。", "wealth": "財運不佳，容易因炫耀、虛榮心或一時衝動而花錢如流水。", "health": "健康因過度勞累而下降，注意心臟。", "relationship": "人際關係中過於情緒化，易感到疲憊。", "life": "生活付出多，收穫少。", "guidance": "保持冷靜，管理好情緒。凡事低調，才能減少是非與消耗。" },
              "gen": { "title": "體卦艮土生用", "description": "主為不動產、家庭或人際關係付出，但進展緩慢或停滯不前。感到心有餘而力不足。", "love": "感情中您付出很多耐心與時間，但對方可能沒有積極回應，關係停滯。", "career": "工作進展緩慢，遇到瓶頸或阻礙，需要長時間的努力才能有微小進展。", "wealth": "財運不佳，投資不動產或長期項目可能被套牢，難以變現。", "health": "健康因過度勞累而下降，注意脾胃。", "relationship": "人際關係中付出多，易感到疲憊。", "life": "生活付出多，收穫少。", "guidance": "學會變通，不要固執己見。有時放手，才能找到新的出路。" },
              "dui": { "title": "體卦兌金生用", "description": "主因言語、口舌或享樂而耗損精力與財富。容易因一時的歡樂而付出代價。", "love": "感情中您可能過度遷就或言不由衷，導致關係不平衡，感到心累。", "career": "工作上可能因閒言閒語或不當言論而惹上麻煩，影響工作進展。", "wealth": "財運不佳，容易因應酬、娛樂或享樂而花費過多，導致財務空虛。", "health": "健康因過度勞累而下降，注意呼吸道。", "relationship": "人際關係中付出多，易感到疲憊。", "life": "生活付出多，收穫少。", "guidance": "謹言慎行，避免無謂的口舌。量入為出，才能避免財務危機。" }
            }
          },
          "yong_overcome_ti": {
            "relation_id": "main_yong_overcome_ti",
            "display_name": "用剋體",
            "overall": "這是一個大凶的卦象，代表外在環境充滿威脅，您將處於被動挨打的局面。務必謹慎行事，以柔克剛。",
            "details": {
              "qian": { "title": "用卦乾金克體", "description": "主有官方、公職或長輩所帶來的麻煩。或因金錢、名譽而受損。應謹防來自權威的壓力。", "love": "感情中對方過於強勢，可能對您造成傷害，或因長輩反對而受阻。", "career": "事業上遇到上司刁難、官司訴訟或被權貴壓制，難以施展抱負。", "wealth": "有破財之憂，尤其與金融、黃金或公務相關的損失。應避免投資高風險項目。", "health": "健康受外在壓力影響，注意骨骼、肺部。", "relationship": "人際關係中遇到權威人士的壓力或衝突。", "life": "生活充滿外部壓力，需小心應對。", "guidance": "切勿硬碰硬，保持低調，尋求其他管道解決問題。遠離權勢鬥爭。" },
              "kun": { "title": "用卦坤土克體", "description": "主有田土、房產之擾，或得女性、小人之害。應謹防來自基層或身邊人的暗算。", "love": "感情中可能因家庭事務或女性長輩的反對而受阻，或對方與您關係不平等。", "career": "事業上可能因同事、基層人員的排擠或打小報告而受損。避免與人有土地或房產上的糾紛。", "wealth": "有因不動產、土地或女性而破財的風險。應謹慎處理任何與此相關的交易。", "health": "健康受居住環境影響，注意脾胃。", "relationship": "人際關係中遇到小人或女性的阻礙。", "life": "生活充滿外部阻力，需小心應對。", "guidance": "保持謙遜，遠離是非。謹慎處理與女性、家庭相關的事務。" },
              "zhen": { "title": "用卦震木克體", "description": "主有虛驚、恐懼之事，或因外來變動而受驚。應謹防突發事件或外來的衝擊。", "love": "感情中可能發生突發性的爭執或變故，讓您措手不及。", "career": "事業上可能因突發狀況、人事變動或意外而受阻。注意與東方人的合作。", "wealth": "有意外之財的損失，或因突發事件而需要大筆開銷。應避免衝動性投資。", "health": "健康受突發意外影響，注意肝臟、足部。", "relationship": "人際關係中遇到突然的衝突或變故。", "life": "生活充滿變動，需小心應對。", "guidance": "保持冷靜，隨時做好應變準備。不要輕易被外在的變化所影響。" },
              "xun": { "title": "用卦巽木克體", "description": "主有東南方之人相害，或因優柔寡斷而受困。應謹防小人算計或被他人左右。", "love": "感情中可能因第三者介入或對方猶豫不決而受傷。要注意來自東南方的人。", "career": "事業上可能因小人背後說閒話或被不誠實的合作夥伴拖累。", "wealth": "有被欺騙或因優柔寡斷而錯失良機，導致財務受損。", "health": "健康受環境影響，注意呼吸系統。", "relationship": "人際關係中遇到小人的暗算或流言蜚語。", "life": "生活充滿外部阻力，需小心應對。", "guidance": "果斷決策，不要輕易受他人影響。謹慎選擇合作夥伴。" },
              "kan": { "title": "用卦坎水克體", "description": "主有險陷之事，或因水、酒、色而生災。應謹防被他人設下陷阱或欺騙。", "love": "感情中可能遇到不誠實或有不良意圖的人，甚至被欺騙感情。", "career": "事業上可能因契約、文書或法律問題而陷入困境，甚至有官司之憂。", "wealth": "財運極差，有破財、被騙或借貸糾紛的風險。應避免所有與賭博相關的行為。", "health": "健康受水影響，注意泌尿系統、腎臟。", "relationship": "人際關係中遇到欺騙或陷阱。", "life": "生活充滿外部阻力，需小心應對。", "guidance": "保持警惕，不要輕易相信承諾。凡事三思而後行，遠離誘惑。" },
              "li": { "title": "用卦離火克體", "description": "主有文書之擾或失火之驚。應謹防口舌是非、名譽受損或意外事件。", "love": "感情中可能因誤會、口舌是非或衝動而產生激烈爭吵，導致關係破裂。", "career": "事業上可能因文書錯誤、合約問題或名譽受損而陷入困境。要特別注意用火安全。", "wealth": "有因衝動消費、投資失利或意外火災而破財的風險。", "health": "健康受火影響，注意心血管。", "relationship": "人際關係中遇到口舌是非或爭執。", "life": "生活充滿外部阻力，需小心應對。", "guidance": "謹言慎行，避免捲入口舌是非。在簽署任何文件前務必仔細檢查。" },
              "gen": { "title": "用卦艮土克體", "description": "主有東北方之人相害，或因阻礙、停滯而受困。應謹防來自不動產或山林的麻煩。", "love": "感情關係停滯不前，可能因外部阻礙或內心瓶頸而難以進展。", "career": "事業發展受阻，遇到瓶頸或外部壓力，進展緩慢。", "wealth": "財運停滯，投資不動產可能被套牢，或因阻礙而無法獲利。", "health": "健康受外部環境影響，注意脾胃、關節。", "relationship": "人際關係中遇到阻礙或僵局。", "life": "生活充滿外部阻力，需小心應對。", "guidance": "耐心等待時機，不要強求。尋找變通之道，化解阻礙。" },
              "dui": { "title": "用卦兌金克體", "description": "主有西方之人相害，或因口舌、喜事而生災。應謹防言語爭執或虛假的喜悅。", "love": "感情中可能因口舌是非或爭執而受傷。", "career": "工作上可能因不當言論或謠言而影響聲譽。要小心辦公室八卦。", "wealth": "有因應酬、娛樂過度而破財的風險。或因輕信他人而有財物損失。", "health": "健康受口舌影響，注意呼吸道。", "relationship": "人際關係中遇到口舌是非或爭執。", "life": "生活充滿外部阻力，需小心應對。", "guidance": "謹言慎行，避免捲入口舌是非。保持低調，避免不必要的應酬。" }
            }
          },
          "harmony": {
            "relation_id": "main_harmony",
            "display_name": "比和",
            "overall": "這是一個小吉的卦象，代表外在環境與您本身狀況相符，沒有太大的阻力或助力，一切穩定而平順。",
            "details": {
              "qian": { "title": "用卦乾金與體卦比和", "description": "主有官方、長輩之助，或因名聲、地位而獲利。順利而平穩。", "love": "感情關係穩定，能得到長輩認可，或雙方地位相當，能互相扶持。", "career": "事業進展順利，能得到上司或貴人協助，穩步上升。", "wealth": "財運穩定，沒有大起大落，適合穩健投資。", "health": "健康狀況平穩，注意頭部、骨骼。", "relationship": "人際關係和諧，能得貴人相助。", "life": "生活穩定，順利而平靜。", "guidance": "維持現狀，穩中求進。多與長輩、貴人請教，能得到幫助。" },
              "kun": { "title": "用卦坤土與體卦比和", "description": "主有土地、房產之利，或得女性、大眾之助。踏實而平穩。", "love": "感情關係穩定，能得到女性長輩或親友支持，適合長久關係。", "career": "事業發展穩健，能獲得基層支持，適合從事不動產或農業。", "wealth": "財運穩定，來自不動產或穩定收入，適合保守投資。", "health": "健康狀況平穩，注意脾胃。", "relationship": "人際關係和諧，能得大眾相助。", "life": "生活穩定，踏實而平靜。", "guidance": "腳踏實地，穩步前進。不要急於求成。" },
              "zhen": { "title": "用卦震木與體卦比和", "description": "主有變動、動態之利。事情進展快速，能因行動而獲益。", "love": "感情關係充滿活力，能因共同行動而增進感情。", "career": "事業發展迅速，有新機會出現，適合開拓新市場。", "wealth": "財運來自動態收入，適合投資新興產業。", "health": "健康狀況平穩，適合進行運動。", "relationship": "人際關係活躍，能結交新朋友。", "life": "生活充滿活力，能因變動而獲益。", "guidance": "果斷行動，抓住轉瞬即逝的機會。" },
              "xun": { "title": "用卦巽木與體卦比和", "description": "主有山林之利，或來自貿易之財。順利而平穩。", "love": "感情關係平順，能因良好溝通而增進感情。", "career": "事業進展順利，適合從事銷售、貿易或與流通相關的行業。", "wealth": "財運來自交易，適合經商或投資流動性強的商品。", "health": "健康狀況平穩，注意呼吸系統。", "relationship": "人際關係和諧，能因良好溝通而獲利。", "life": "生活平順，能因交易買賣而獲利。", "guidance": "保持彈性，順應趨勢。多與人交流，能獲得商機。" },
              "kan": { "title": "用卦坎水與體卦比和", "description": "主有來自北方或與水相關的財利。順利而平穩。", "love": "感情能從深入溝通中獲得滋養。", "career": "事業上適合從事寫作、法律或與溝通相關的行業。", "wealth": "財運來自北方、與水相關的行業，適合投資穩定項目。", "health": "健康狀況平穩，注意腎臟。", "relationship": "人際關係能從深入溝通中獲得滋養。", "life": "生活平順，能因溝通而獲利。", "guidance": "多與人溝通，解決問題的關鍵在於信息的交流。" },
              "li": { "title": "用卦離火與體卦比和", "description": "主有文書、名譽之喜。順利而平穩。", "love": "感情關係充滿熱情，能得到公開認可。", "career": "事業上能因名氣、創意或曝光而成功。", "wealth": "財運來自南方、與火相關的行業，適合投資具有高知名度的品牌。", "health": "健康狀況平穩，注意心臟。", "relationship": "人際關係充滿熱情，能因名氣而獲利。", "life": "生活平順，能因名氣而獲利。", "guidance": "展現您的才華與熱情，能吸引好運。" },
              "gen": { "title": "用卦艮土與體卦比和", "description": "主有來自東北方或山林、田地之財。順利而平穩。", "love": "感情關係穩定，能因共同的興趣或穩定的生活而增進感情。", "career": "事業發展穩健，適合從事房地產、建築或需要耐心的長期專案。", "wealth": "財運來自不動產或與土地相關的投資，適合長期持有。", "health": "健康狀況穩定，注意脾胃、關節。", "relationship": "人際關係穩定，能因誠信而獲利。", "life": "生活穩健，能因耐心而獲利。", "guidance": "保持耐心與毅力，所有努力最終都會有收穫。" },
              "dui": { "title": "用卦兌金與體卦比和", "description": "主有喜悅事，或因口舌、飲食而得利。順利而平穩。", "love": "感情關係和諧愉快，能因良好的溝通和歡樂的氛圍而增進感情。", "career": "事業上能因口才、人脈或社交而成功。", "wealth": "財運來自口才、人脈或餐飲娛樂業，有因喜事宴會而得財的機會。", "health": "健康狀況平穩，注意呼吸道。", "relationship": "人際關係和諧，能因口才而獲利。", "life": "生活愉快，能因口才而獲利。", "guidance": "多與人交流，保持樂觀的心態，能吸引更多好運。" }
            }
          },
          "ti_overcome_yong": {
            "relation_id": "main_ti_overcome_yong",
            "display_name": "體剋用",
            "overall": "這是一個小吉的卦象，代表您處於主導地位，能夠控制局面，但需小心付出過多，導致氣力耗損。",
            "details": {
              "qian": { "title": "體卦乾金克用", "description": "主有公事、名譽之利，或因金錢、地位而獲利。順利而平穩。", "love": "感情中您處於主導地位，能掌控關係走向。", "career": "事業上有掌控權，能順利推展計畫。", "wealth": "財運佳，能夠掌控投資或理財方向。", "health": "健康狀況平穩，注意頭部、骨骼。", "relationship": "人際關係中處於主導地位。", "life": "生活順利，能掌控局面。", "guidance": "果斷決策，掌握主動權。" },
              "kun": { "title": "體卦坤土克用", "description": "主有田土、房產之利，或得女性、大眾之助。順利而平穩。", "love": "感情中您處於主導地位，能掌控關係走向。", "career": "事業上有掌控權，能順利推展計畫。", "wealth": "財運佳，能夠掌控投資或理財方向。", "health": "健康狀況平穩，注意脾胃。", "relationship": "人際關係中處於主導地位。", "life": "生活順利，能掌控局面。", "guidance": "腳踏實地，穩步前進。" },
              "zhen": { "title": "體卦震木克用", "description": "主有變動、動態之利。事情進展快速，能因行動而獲益。", "love": "感情中您處於主導地位，能掌控關係走向。", "career": "事業上有掌控權，能順利推展計畫。", "wealth": "財運佳，能夠掌控投資或理財方向。", "health": "健康狀況平穩，注意肝臟。", "relationship": "人際關係中處於主導地位。", "life": "生活順利，能掌控局面。", "guidance": "果斷行動，抓住機會。" },
              "xun": { "title": "體卦巽木克用", "description": "主有山林之利，或來自貿易之財。順利而平穩。", "love": "感情中您處於主導地位，能掌控關係走向。", "career": "事業上有掌控權，能順利推展計畫。", "wealth": "財運佳，能夠掌控投資或理財方向。", "health": "健康狀況平穩，注意呼吸系統。", "relationship": "人際關係中處於主導地位。", "life": "生活順利，能掌控局面。", "guidance": "保持彈性，順應趨勢。" },
              "kan": { "title": "體卦坎水克用", "description": "主有來自北方或與水相關的財利。順利而平穩。", "love": "感情中您處於主導地位，能掌控關係走向。", "career": "事業上有掌控權，能順利推展計畫。", "wealth": "財運佳，能夠掌控投資或理財方向。", "health": "健康狀況平穩，注意腎臟。", "relationship": "人際關係中處於主導地位。", "life": "生活順利，能掌控局面。", "guidance": "多與人溝通，解決問題。" },
              "li": { "title": "體卦離火克用", "description": "主有文書、名譽之喜。順利而平穩。", "love": "感情中您處於主導地位，能掌控關係走向。", "career": "事業上有掌控權，能順利推展計畫。", "wealth": "財運佳，能夠掌控投資或理財方向。", "health": "健康狀況平穩，注意心臟。", "relationship": "人際關係中處於主導地位。", "life": "生活順利，能掌控局面。", "guidance": "展現您的才華與熱情。" },
              "gen": { "title": "體卦艮土克用", "description": "主有來自東北方或山林、田地之財。順利而平穩。", "love": "感情中您處於主導地位，能掌控關係走向。", "career": "事業上有掌控權，能順利推展計畫。", "wealth": "財運佳，能夠掌控投資或理財方向。", "health": "健康狀況平穩，注意脾胃、關節。", "relationship": "人際關係中處於主導地位。", "life": "生活順利，能掌控局面。", "guidance": "保持耐心與毅力，所有努力最終都會有收穫。" },
              "dui": { "title": "體卦兌金克用", "description": "主有喜悅事，或因口舌、飲食而得利。順利而平穩。", "love": "感情中您處於主導地位，能掌控關係走向。", "career": "事業上有掌控權，能順利推展計畫。", "wealth": "財運佳，能夠掌控投資或理財方向。", "health": "健康狀況平穩，注意呼吸道。", "relationship": "人際關係中處於主導地位。", "life": "生活順利，能掌控局面。", "guidance": "多與人交流，保持樂觀的心態。" }
            }
          }
        },
        "combined": {
          "auspicious": {
            "result_id": "combined_auspicious",
            "display_name": "吉",
            "details": "外部助力 + 內部穩固：體卦強盛，走向大吉。"
          },
          "moderately_auspicious": {
            "result_id": "combined_moderately_auspicious",
            "display_name": "中吉",
            "details": "外部有利但內部平穩：外在環境與內在條件相輔相成，發展順利。"
          },
          "neutral": {
            "result_id": "combined_neutral",
            "display_name": "平",
            "details": "外部平穩 + 內部平穩：外部與內部皆無變動，一切順其自然。"
          },
          "moderately_inauspicious": {
            "result_id": "combined_moderately_inauspicious",
            "display_name": "中凶",
            "details": "外部克制但內部平穩：外在環境壓力大，但內在穩定，尚有能力抵抗。"
          },
          "inauspicious": {
            "result_id": "combined_inauspicious",
            "display_name": "凶",
            "details": "外部克制 + 內部消耗：外在壓力大，內在力量又被消耗，非常不利。"
          }
        }
      }
    };
    
    const TRIGRAM_EXPLANATIONS = {
      "乾": { "love": "感情方面可能需要主動、積極的態度。婚姻利於正而長，陰陽相交，秋占宜成。", "career": "代表事業順利，有領導能力和突破機會。求名利於出名，宜從事京都或形勝之地相關職務。", "wealth": "財運強勁，適合大膽投資。主有金玉、寶珠之利，多主有財。", "health": "頭部、骨骼、呼吸道。疾病發於頭部、肺部或筋骨。", "relationship": "代表父輩或權威人士，與之互動順利。人物為君父、大人、老人、長者、官宦、名人、公門人。", "life": "運勢強勁，適合計畫大型目標。家宅形勝，高上莊嚴，秋占宅興隆。", "guidance": "主動出擊，把握時機。剛健勇武、果決、多動少靜。" },
      "兌": { "love": "關係中充滿喜悅，但也可能有爭執或口角。婚姻難以成功，或易有口舌是非，利於少女的婚事，夏季占卜不利。", "career": "工作場所人際關係良好，適合溝通協調的職務。求名不易出名，或名聲受損，適合西方、刑官、武職、伶官、譯官等職業。", "wealth": "財源來自口才或交易。求利無利或有損，財利方面易有口舌糾紛，秋季占卜有財喜，但需防範爭執。", "health": "口、舌、牙、喉、肺。多發咳嗽、喉疾、氣鬱等疾病。", "relationship": "代表少女或與口才、喜悅相關的人。人物為少女、巫師、說客、歌妓、妾、娼、與言談相關的職業者。", "life": "生活充滿喜悅與變化，運勢起伏。利於飲食、娛樂、口才，但要防口舌是非。", "guidance": "保持樂觀，但需謹慎言行。享受生活中的美好，同時避免不必要的爭執。" },
      "離": { "love": "感情熱烈而浪漫，但也可能缺乏穩定性。婚姻利於中女，但易有口舌是非，夏季占卜大利。", "career": "適合演藝、媒體、設計等需要展現自我的工作。求名易出名，宜從事與火、電、文書、藝術、文化相關的行業。", "wealth": "財源來自名氣或創意。財利方面易有虛名，但夏季占卜有財喜，利於火性行業。", "health": "眼、心臟、血液。多發眼疾、心臟病、血疾、發熱等疾病。", "relationship": "代表中女或與美、文化、知識相關的人。人物為中女、美人、軍官、文化人、文書工作者。", "life": "運勢高漲，但要小心虛華不實。利於文化、藝術、名聲，但需防範口舌是非。", "guidance": "憑直覺行動，發光發熱。" },
      "震": { "love": "感情進展迅速，但可能衝動或不穩。", "career": "適合創業或需要快速決策的工作，但也可能有突然變動。", "wealth": "財運突然爆發，但需防範意外損失。", "health": "腳部、肝膽、神經系統。", "relationship": "代表長子或與變動、行動有關的人。", "life": "生活充滿變數與驚喜，運勢起伏大。", "guidance": "果斷行動，抓住轉瞬即逝的機會。" },
      "巽": { "love": "感情柔順，但可能關係複雜或有隱藏的問題。", "career": "工作進展緩慢而深入，適合幕後協調。", "wealth": "財運緩慢增長，需細水長流。", "health": "大腿、神經、呼吸道。", "relationship": "代表長女或與風、草木相關的人。", "life": "運勢平順，但要小心隱藏的暗流。", "guidance": "順其自然，靈活應變。" },
      "坎": { "love": "感情可能陷入困境，充滿不確定性。", "career": "工作困難重重，可能面臨挫折或陷阱。", "wealth": "財運低迷，有破財風險。", "health": "腎臟、泌尿系統、生殖器官、耳部。", "relationship": "代表中年男子或與危險、暗處相關的人。", "life": "運勢低迷，需謹慎應對。", "guidance": "保持冷靜，以智慧面對困境。" },
      "艮": { "love": "感情穩定，但可能進展緩慢或遇到阻礙。", "career": "工作穩健，適合需要耐心和毅力的工作。", "wealth": "財運平穩，適合長期投資。", "health": "手、背、關節、脾胃。", "relationship": "代表少男或與山、靜止相關的人。", "life": "運勢穩定，但要小心停滯不前。", "guidance": "保持耐心，堅守原則。" },
      "坤": { "love": "感情穩定，但可能缺乏激情或變化。婚姻利於安靜，利於老母，秋占不利，春占不宜。", "career": "適合房地產、農業、服務業等踏實穩定的工作。求名不易出名，適合與土地、大眾相關的行業。", "wealth": "財運穩定，來自不動產或積累。財利方面易有口舌糾紛，秋季占卜有財喜，但需防範爭執。", "health": "脾胃、腹部。多發脾胃虛弱、腹脹、腹痛等疾病。", "relationship": "代表母親或與大眾、土地相關的人。人物為老母、大眾、農人、大腹人、布衣人。", "life": "運勢平穩，適合按部就班。利於積累財富，但要防被動或缺乏主見。", "guidance": "腳踏實地，穩紮穩打。" }
    };
    
    // Five Elements relationships for advice generation
    const WUXING_GENERATE = {
      "木": "水",
      "火": "木",
      "土": "火",
      "金": "土",
      "水": "金"
    };

    const WUXING_OVERCOME = {
      "木": "金",
      "火": "水",
      "土": "木",
      "金": "火",
      "水": "土"
    };

    const WUXING_TO_GUA = {
      "木": ["震", "巽"],
      "火": ["離"],
      "土": ["坤", "艮"],
      "金": ["乾", "兌"],
      "水": ["坎"]
    };

    let history = JSON.parse(localStorage.getItem('guam_history')) || [];
    let currentResult = null;

    function saveHistory() {
      localStorage.setItem('guam_history', JSON.stringify(history));
    }

    function renderGua(guaId, elementId, movingLine = null) {
      const gua = GUA_DATA[guaId];
      const container = document.getElementById(elementId);
      container.innerHTML = `<p class="gua-name">${gua.name}卦</p>`;
      const guaLines = [];
      const binary = (guaId - 1).toString(2).padStart(3, '0');
      for (let i = 0; i < 3; i++) {
        const lineDiv = document.createElement('div');
        lineDiv.className = 'gua-line';
        if (binary[i] === '0') {
          lineDiv.classList.add('yin');
        }
        if (movingLine && (movingLine - 1) === i) {
          lineDiv.classList.add('moving');
        }
        guaLines.unshift(lineDiv);
      }
      guaLines.forEach(line => container.appendChild(line));
    }

    function getMovingGua(upperGua, lowerGua, movingLine) {
      const originalGua = upperGua.toString() + lowerGua.toString();
      const binaryUpper = (upperGua - 1).toString(2).padStart(3, '0');
      const binaryLower = (lowerGua - 1).toString(2).padStart(3, '0');
      let newBinary = '';

      if (movingLine > 3) {
        let newUpper = binaryUpper;
        if (newUpper[6 - movingLine] === '0') {
          newUpper = newUpper.substring(0, 6 - movingLine) + '1' + newUpper.substring(6 - movingLine + 1);
        } else {
          newUpper = newUpper.substring(0, 6 - movingLine) + '0' + newUpper.substring(6 - movingLine + 1);
        }
        newBinary = newUpper + binaryLower;
      } else {
        let newLower = binaryLower;
        if (newLower[3 - movingLine] === '0') {
          newLower = newLower.substring(0, 3 - movingLine) + '1' + newLower.substring(3 - movingLine + 1);
        } else {
          newLower = newLower.substring(0, 3 - movingLine) + '0' + newLower.substring(3 - movingLine + 1);
        }
        newBinary = binaryUpper + newLower;
      }

      const changedUpper = parseInt(newBinary.substring(0, 3), 2) + 1;
      const changedLower = parseInt(newBinary.substring(3, 6), 2) + 1;
      return { upper: changedUpper, lower: changedLower };
    }

    function getWuxingRelation(yongGua, tiGua, movingGua = null) {
      const yongWuxing = GUA_DATA[yongGua].wuxing;
      const tiWuxing = GUA_DATA[tiGua].wuxing;

      let relation = '';
      let status = '';
      if (yongWuxing === tiWuxing) {
        relation = '比和';
        status = 'neutral';
      } else if (yongWuxing === '木' && tiWuxing === '火' || yongWuxing === '火' && tiWuxing === '土' || yongWuxing === '土' && tiWuxing === '金' || yongWuxing === '金' && tiWuxing === '水' || yongWuxing === '水' && tiWuxing === '木') {
        relation = '用生體';
        status = 'positive';
      } else if (tiWuxing === '木' && yongWuxing === '火' || tiWuxing === '火' && yongWuxing === '土' || tiWuxing === '土' && yongWuxing === '金' || tiWuxing === '金' && yongWuxing === '水' || tiWuxing === '水' && yongWuxing === '木') {
        relation = '體生用';
        status = 'negative';
      } else if (yongWuxing === '木' && tiWuxing === '土' || yongWuxing === '土' && tiWuxing === '水' || yongWuxing === '水' && tiWuxing === '火' || yongWuxing === '火' && tiWuxing === '金' || yongWuxing === '金' && tiWuxing === '木') {
        relation = '用剋體';
        status = 'negative';
      } else if (tiWuxing === '木' && yongWuxing === '土' || tiWuxing === '土' && yongWuxing === '水' || tiWuxing === '水' && yongWuxing === '火' || tiWuxing === '火' && yongWuxing === '金' || tiWuxing === '金' && yongWuxing === '木') {
        relation = '體剋用';
        status = 'positive';
      }

      let movingRelation = null;
      if (movingGua) {
        const movingWuxing = GUA_DATA[movingGua].wuxing;
        if (movingWuxing === tiWuxing) {
          movingRelation = '比和';
        } else if (movingWuxing === '木' && tiWuxing === '火' || movingWuxing === '火' && tiWuxing === '土' || movingWuxing === '土' && tiWuxing === '金' || movingWuxing === '金' && tiWuxing === '水' || movingWuxing === '水' && tiWuxing === '木') {
          movingRelation = '用生體';
        } else if (tiWuxing === '木' && movingWuxing === '火' || tiWuxing === '火' && movingWuxing === '土' || tiWuxing === '土' && movingWuxing === '金' || tiWuxing === '金' && movingWuxing === '水' || tiWuxing === '水' && movingWuxing === '木') {
          movingRelation = '體生用';
        } else if (movingWuxing === '木' && tiWuxing === '土' || movingWuxing === '土' && tiWuxing === '水' || movingWuxing === '水' && tiWuxing === '火' || movingWuxing === '火' && tiWuxing === '金' || movingWuxing === '金' && tiWuxing === '木') {
          movingRelation = '用剋體';
        } else if (tiWuxing === '木' && movingWuxing === '土' || tiWuxing === '土' && movingWuxing === '水' || tiWuxing === '水' && movingWuxing === '火' || tiWuxing === '火' && movingWuxing === '金' || tiWuxing === '金' && movingWuxing === '木') {
          movingRelation = '體剋用';
        }
      }

      return {
        main: { relation, status, detail: WUXING_RELATIONS_DATA.relations.main[relation_map[relation]].details[GUA_DATA[yongGua].english.toLowerCase()] },
        moving: movingRelation ? { relation: movingRelation, detail: WUXING_RELATIONS_DATA.relations.moving[relation_map[movingRelation]].details[GUA_DATA[movingGua].english.toLowerCase()] } : null,
        overall: WUXING_RELATIONS_DATA.relations.combined[getOverallAuspiciousness(relation, movingRelation)]
      };
    }

    const relation_map = {
      '用生體': 'generate_ti',
      '體生用': 'ti_generate_yong',
      '用剋體': 'yong_overcome_ti',
      '體剋用': 'ti_overcome_yong',
      '比和': 'harmony'
    };
    
    function getOverallAuspiciousness(mainRelation, movingRelation) {
      if (mainRelation === '用生體' && movingRelation === '用生體') return 'auspicious';
      if (mainRelation === '用生體' && movingRelation === '體剋用') return 'auspicious';
      if (mainRelation === '體剋用' && movingRelation === '用生體') return 'auspicious';
      if (mainRelation === '比和' && movingRelation === '比和') return 'neutral';
      if (mainRelation === '比和' && movingRelation === '用生體') return 'moderately_auspicious';
      if (mainRelation === '比和' && movingRelation === '體剋用') return 'moderately_auspicious';
      if (mainRelation === '用生體' && movingRelation === '比和') return 'moderately_auspicious';
      if (mainRelation === '體剋用' && movingRelation === '比和') return 'moderately_auspicious';
      if (mainRelation === '體生用' && movingRelation === '比和') return 'moderately_inauspicious';
      if (mainRelation === '用剋體' && movingRelation === '比和') return 'moderately_inauspicious';
      if (mainRelation === '用剋體' && movingRelation === '體生用') return 'inauspicious';
      if (mainRelation === '體生用' && movingRelation === '用剋體') return 'inauspicious';
      if (mainRelation === '用剋體' && movingRelation === '用剋體') return 'inauspicious';
      if (mainRelation === '體生用' && movingRelation === '體生用') return 'inauspicious';
      return 'neutral';
    }

    function renderWuxingAnalysis(result) {
      const wuxingAnalysisContent = document.getElementById('wuxing-analysis-content');
      wuxingAnalysisContent.innerHTML = '';
      const wuxingData = result.wuxing;

      const mainAnalysis = document.createElement('div');
      mainAnalysis.innerHTML = `
        <p><strong>${wuxingData.main.display_name}</strong> - ${wuxingData.main.overall}</p>
        <p><strong>解釋:</strong> ${wuxingData.main.details[GUA_DATA[result.yongGua].english.toLowerCase()].description}</p>
        <p class="wuxing-status ${wuxingData.main.status}">
          ${wuxingData.main.display_name}：${wuxingData.main.overall}
        </p>
      `;
      wuxingAnalysisContent.appendChild(mainAnalysis);

      if (result.movingLine) {
        const movingWuxing = getWuxingRelation(result.changedGua, result.tiGua).main;
        const movingAnalysis = document.createElement('div');
        movingAnalysis.innerHTML = `
          <h4>變卦五行分析</h4>
          <p><strong>${movingWuxing.display_name}</strong> - ${movingWuxing.overall}</p>
          <p><strong>解釋:</strong> ${movingWuxing.details[GUA_DATA[result.changedGua].english.toLowerCase()].description}</p>
        `;
        wuxingAnalysisContent.appendChild(movingAnalysis);
      }

      if (wuxingData.main.relation === '用剋體') {
        renderYongKeTiTip(result.yongGua, result.tiGua);
      } else {
        document.getElementById('tip-for-yong-ke-ti-box').classList.add('hidden');
      }

      const overallAnalysis = document.createElement('div');
      overallAnalysis.innerHTML = `
        <h4>綜合吉凶</h4>
        <p><strong>${wuxingData.overall.display_name}</strong> - ${wuxingData.overall.details}</p>
      `;
      wuxingAnalysisContent.appendChild(overallAnalysis);
      
      const auspiciousnessText = document.getElementById('auspiciousness-text');
      const auspiciousnessBar = document.getElementById('auspiciousness-bar-inner');
      const scoreMap = {
        '吉': 100,
        '中吉': 75,
        '平': 50,
        '中凶': 25,
        '凶': 0
      };
      auspiciousnessText.textContent = wuxingData.overall.display_name;
      auspiciousnessBar.style.width = `${scoreMap[wuxingData.overall.display_name]}%`;
      if (scoreMap[wuxingData.overall.display_name] > 50) {
        auspiciousnessBar.style.background = 'var(--positive-color)';
      } else if (scoreMap[wuxingData.overall.display_name] === 50) {
        auspiciousnessBar.style.background = 'var(--secondary-color)';
      } else {
        auspiciousnessBar.style.background = 'var(--negative-color)';
      }
      
      renderWuxingDiagram(result.yongGua, result.tiGua);
    }

    function renderYongKeTiTip(yongGua, tiGua) {
      const yongWuxing = GUA_DATA[yongGua].wuxing;
      const tiWuxing = GUA_DATA[tiGua].wuxing;

      const generateWuxing = WUXING_GENERATE[tiWuxing];
      const overcomeWuxing = WUXING_OVERCOME[yongWuxing];

      const generateGua = WUXING_TO_GUA[generateWuxing][0];
      const overcomeGua = WUXING_TO_GUA[overcomeWuxing][0];
      
      const tipContent = document.getElementById('tip-for-yong-ke-ti-content');
      tipContent.innerHTML = `
        <p>卦象顯示，外在環境（用卦）對您的內在情況（體卦）產生了克制作用，屬於不順利的狀況。建議您可以尋求以下兩種管道來化解：</p>
        <ul>
          <li>**尋求生體卦之人的協助**：找尋屬性為「${generateWuxing}」的人或事物協助，因為「${generateWuxing}」能**生**「${tiWuxing}」。例如：${GUA_DATA[GUA_DATA[generateGua].name].name}卦象之人事物。</li>
          <li>**尋求克用卦之人來消耗**：找尋屬性為「${overcomeWuxing}」的人或事物，因為「${overcomeWuxing}」能**克**「${yongWuxing}」，或**被用卦所生**來消耗用卦之氣。例如：${GUA_DATA[GUA_DATA[overcomeGua].name].name}卦象之人事物。</li>
        </ul>
        <p>例如：您的用卦(<strong>${GUA_DATA[yongGua].name}</strong>, ${yongWuxing})克體卦(<strong>${GUA_DATA[tiGua].name}</strong>, ${tiWuxing})，可尋求${GUA_DATA[GUA_DATA[overcomeGua].name].name}卦克之，或${GUA_DATA[GUA_DATA[generateGua].name].name}卦消耗之，且${GUA_DATA[GUA_DATA[generateGua].name].name}水生${GUA_DATA[tiGua].name}木。</p>
      `;

      document.getElementById('tip-for-yong-ke-ti-box').classList.remove('hidden');
    }

    function renderDetailedAnalysis(result) {
      const detailedAnalysisContent = document.getElementById('detailed-analysis-content');
      detailedAnalysisContent.innerHTML = '';
      
      const tiGuaData = TRIGRAM_EXPLANATIONS[GUA_DATA[result.tiGua].name];
      const tiGuaElement = document.createElement('div');
      tiGuaElement.innerHTML = `
        <h4>體卦：${GUA_DATA[result.tiGua].name}卦</h4>
        <p><strong>運勢：</strong> ${tiGuaData.life}</p>
        <p><strong>感情：</strong> ${tiGuaData.love}</p>
        <p><strong>事業：</strong> ${tiGuaData.career}</p>
        <p><strong>財運：</strong> ${tiGuaData.wealth}</p>
        <p><strong>健康：</strong> ${tiGuaData.health}</p>
        <p><strong>人際關係：</strong> ${tiGuaData.relationship}</p>
        <p><strong>占卜建議：</strong> ${tiGuaData.guidance}</p>
      `;
      detailedAnalysisContent.appendChild(tiGuaElement);

      const yongGuaData = TRIGRAM_EXPLANATIONS[GUA_DATA[result.yongGua].name];
      const yongGuaElement = document.createElement('div');
      yongGuaElement.innerHTML = `
        <h4>用卦：${GUA_DATA[result.yongGua].name}卦</h4>
        <p><strong>運勢：</strong> ${yongGuaData.life}</p>
        <p><strong>感情：</strong> ${yongGuaData.love}</p>
        <p><strong>事業：</strong> ${yongGuaData.career}</p>
        <p><strong>財運：</strong> ${yongGuaData.wealth}</p>
        <p><strong>健康：</strong> ${yongGuaData.health}</p>
        <p><strong>人際關係：</strong> ${yongGuaData.relationship}</p>
        <p><strong>占卜建議：</strong> ${yongGuaData.guidance}</p>
      `;
      detailedAnalysisContent.appendChild(yongGuaElement);
    }
    
    function renderLineExplanation(result) {
      const lineExplanationBox = document.getElementById('line-explanation-box');
      const lineExplanationContent = document.getElementById('line-explanation-content');
      if (result.lineExplanation) {
        lineExplanationBox.classList.remove('hidden');
        lineExplanationContent.innerHTML = `<p>${result.lineExplanation}</p>`;
      } else {
        lineExplanationBox.classList.add('hidden');
      }
    }

    function getSvgString(yongGua, tiGua, withStyles = false) {
      const wuxingData = [
        { name: '木', x: 200, y: 50, gua: GUA_DATA[4].name, symbol: GUA_DATA[4].symbol },
        { name: '火', x: 350, y: 150, gua: GUA_DATA[3].name, symbol: GUA_DATA[3].symbol },
        { name: '土', x: 275, y: 300, gua: GUA_DATA[7].name, symbol: GUA_DATA[7].symbol },
        { name: '金', x: 50, y: 150, gua: GUA_DATA[1].name, symbol: GUA_DATA[1].symbol },
        { name: '水', x: 125, y: 300, gua: GUA_DATA[6].name, symbol: GUA_DATA[6].symbol }
      ];

      const relations = [
        { from: '木', to: '火', label: '生', type: 'generate' },
        { from: '火', to: '土', label: '生', type: 'generate' },
        { from: '土', to: '金', label: '生', type: 'generate' },
        { from: '金', to: '水', label: '生', type: 'generate' },
        { from: '水', to: '木', label: '生', type: 'generate' },
        { from: '木', to: '土', label: '克', type: 'overcome' },
        { from: '火', to: '金', label: '克', type: 'overcome' },
        { from: '土', to: '水', label: '克', type: 'overcome' },
        { from: '金', to: '木', label: '克', type: 'overcome' },
        { from: '水', to: '火', label: '克', type: 'overcome' }
      ];

      const tiWuxing = GUA_DATA[tiGua].wuxing;
      const yongWuxing = GUA_DATA[yongGua].wuxing;

      let svgContent = `<svg width="400" height="400" xmlns="http://www.w3.org/2000/svg">`;

      if (withStyles) {
        svgContent += `
        <style>
            .wuxing-node {
                stroke: var(--primary-color);
                stroke-width: 2;
                transition: fill 0.3s ease, stroke-width 0.3s ease;
            }
            .wuxing-node-text {
                text-anchor: middle;
                font-size: 20px;
                fill: #333333;
                font-family: 'Noto Sans TC', sans-serif;
            }
            .wuxing-name-text {
                text-anchor: middle;
                font-size: 14px;
                font-weight: bold;
                fill: #333333;
                font-family: 'Noto Sans TC', sans-serif;
            }
            .wuxing-edge-generate {
                stroke: #4caf50;
                stroke-width: 2;
                marker-end: url(#arrow-generate);
            }
            .wuxing-edge-overcome {
                stroke: #e74c3c;
                stroke-width: 2;
                marker-end: url(#arrow-overcome);
            }
            .wuxing-edge-label {
                font-size: 12px;
                fill: #333333;
                text-anchor: middle;
                font-family: 'Noto Sans TC', sans-serif;
            }
        </style>`;
      }

      svgContent += `
          <defs>
              <marker id="arrow-generate" markerWidth="10" markerHeight="10" refX="8" refY="3" orient="auto">
                  <path d="M0,0 L0,6 L9,3 z" fill="#4caf50" />
              </marker>
              <marker id="arrow-overcome" markerWidth="10" markerHeight="10" refX="8" refY="3" orient="auto">
                  <path d="M0,0 L0,6 L9,3 z" fill="#e74c3c" />
              </marker>
          </defs>
      `;

      relations.forEach(rel => {
          const fromNode = wuxingData.find(d => d.name === rel.from);
          const toNode = wuxingData.find(d => d.name === rel.to);
          let strokeWidth = 2;
          if (rel.from === yongWuxing && rel.to === tiWuxing) {
              strokeWidth = 4;
          } else if (rel.from === tiWuxing && rel.to === yongWuxing) {
              strokeWidth = 4;
          }
          svgContent += `<line x1="${fromNode.x}" y1="${fromNode.y}" x2="${toNode.x}" y2="${toNode.y}" class="wuxing-edge-${rel.type}" stroke-width="${strokeWidth}" marker-end="url(#arrow-${rel.type})"/>`;

          const midX = (fromNode.x + toNode.x) / 2;
          const midY = (fromNode.y + toNode.y) / 2;
          svgContent += `<text x="${midX}" y="${midY}" dx="${rel.type === 'overcome' ? 10 : -10}" dy="${rel.type === 'overcome' ? 10 : -10}" class="wuxing-edge-label">${rel.label}</text>`;
      });

      wuxingData.forEach(node => {
        let isTi = (node.name === tiWuxing);
        let isYong = (node.name === yongWuxing);
        let stroke = isTi ? WUXING_COLORS[tiWuxing] : (isYong ? WUXING_COLORS[yongWuxing] : '#333333');
        let strokeWidth = isTi || isYong ? 4 : 2;
        let fill = WUXING_COLORS[node.name];
        svgContent += `<circle cx="${node.x}" cy="${node.y}" r="30" class="wuxing-node" fill="${fill}" stroke="${stroke}" stroke-width="${strokeWidth}"/>`;
        svgContent += `<text x="${node.x}" y="${node.y}" dy="-8" class="wuxing-name-text">${node.name}</text>`;
        svgContent += `<text x="${node.x}" y="${node.y}" dy="12" class="wuxing-node-text">${node.symbol}</text>`;
      });

      svgContent += `</svg>`;
      return svgContent;
    }

    function renderWuxingDiagram(yongGua, tiGua) {
      const wuxingDiagramContainer = document.getElementById('wuxing-diagram-container');
      wuxingDiagramContainer.innerHTML = getSvgString(yongGua, tiGua);
    }
    
    function downloadSvg() {
      if (!currentResult) {
        alert('請先進行占卜以生成卦象！');
        return;
      }
      const svgString = getSvgString(currentResult.yongGua, currentResult.tiGua, true);
      const blob = new Blob([svgString], { type: 'image/svg+xml;charset=utf-8' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = 'wuxing-diagram.svg';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }
    
    function openSvgInNewWindow() {
      if (!currentResult) {
        alert('請先進行占卜以生成卦象！');
        return;
      }
      const svgString = getSvgString(currentResult.yongGua, currentResult.tiGua, true);
      const newWindow = window.open('', '_blank');
      newWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
          <title>五行生克圖</title>
          <style>
            body { margin: 0; display: flex; justify-content: center; align-items: center; height: 100vh; background: #f4f7f9; }
          </style>
        </head>
        <body>
          ${svgString}
        </body>
        </html>
      `);
      newWindow.document.close();
    }

    // Event listeners and other functions remain the same as the original code...
    function switchTab(targetId) {
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
      });
      document.getElementById(targetId).classList.add('active');
      document.querySelectorAll('.tab-button').forEach(button => {
        button.classList.remove('active');
      });
      document.querySelector(`.tab-button[data-target="${targetId}"]`).classList.add('active');
      if (targetId === 'history') {
        renderHistory();
      }
    }

    document.querySelectorAll('.tab-button').forEach(button => {
      button.addEventListener('click', () => {
        switchTab(button.dataset.target);
      });
    });

    document.getElementById('btnNumber').addEventListener('click', () => {
      const upperNum = parseInt(document.getElementById('numUpper').value);
      const lowerNum = parseInt(document.getElementById('numLower').value);
      const movingNum = parseInt(document.getElementById('numMoving').value);
      const question = document.getElementById('questionNumber').value;
      if (isNaN(upperNum) || isNaN(lowerNum) || isNaN(movingNum)) {
        alert('請輸入有效的數字！');
        return;
      }
      generateGuaResult((upperNum % 8) || 8, (lowerNum % 8) || 8, (movingNum % 6) || 6, question);
    });

    document.getElementById('btnRandomNumber').addEventListener('click', () => {
      const upperNum = Math.floor(Math.random() * 900) + 100;
      const lowerNum = Math.floor(Math.random() * 900) + 100;
      const movingNum = Math.floor(Math.random() * 900) + 100;
      document.getElementById('numUpper').value = upperNum;
      document.getElementById('numLower').value = lowerNum;
      document.getElementById('numMoving').value = movingNum;
      document.getElementById('numMoving').value = movingNum;
      document.getElementById('questionNumber').value = '亂數取卦';
      generateGuaResult((upperNum % 8) || 8, (lowerNum % 8) || 8, (movingNum % 6) || 6, '亂數取卦');
    });

    document.getElementById('btnManual').addEventListener('click', () => {
      const upperGua = parseInt(document.getElementById('selUpper').value);
      const lowerGua = parseInt(document.getElementById('selLower').value);
      const movingLines = document.getElementById('inputMoving').value.split(',').map(n => parseInt(n.trim())).filter(n => !isNaN(n) && n >= 1 && n <= 6);
      const question = document.getElementById('questionManual').value;
      if (isNaN(upperGua) || isNaN(lowerGua)) {
        alert('請選擇上下卦！');
        return;
      }
      generateGuaResult(upperGua, lowerGua, movingLines.length > 0 ? movingLines[0] : null, question);
    });

    document.getElementById('btnTime').addEventListener('click', () => {
      const method = document.querySelector('input[name="time-method"]:checked').value;
      let date, question;
      if (method === 'modern') {
        date = new Date(document.getElementById('dtInput').value);
        question = document.getElementById('questionTime').value;
      } else {
        date = new Date(document.getElementById('dateInput').value);
        const shichen = parseInt(document.getElementById('shichenInput').value);
        date.setHours(shichen);
        question = document.getElementById('questionTraditional').value;
      }

      if (isNaN(date.getTime())) {
        alert('請選擇有效的日期和時間！');
        return;
      }

      const year = date.getFullYear();
      const month = date.getMonth() + 1;
      const day = date.getDate();
      const hour = date.getHours();

      const upperGua = (year + month + day) % 8 || 8;
      const lowerGua = (year + month + day + hour) % 8 || 8;
      const movingLine = (year + month + day + hour) % 6 || 6;

      generateGuaResult(upperGua, lowerGua, movingLine, question);
    });

    document.getElementById('btnImage').addEventListener('click', () => {
      const upperGua = parseInt(document.getElementById('selImageUpper').value);
      const lowerGua = parseInt(document.getElementById('selImageLower').value);
      const movingLine = parseInt(document.getElementById('selImageMoving').value);
      const question = document.getElementById('questionImage').value;
      if (isNaN(upperGua) || isNaN(lowerGua) || isNaN(movingLine)) {
        alert('請選擇卦象與動爻！');
        return;
      }
      generateGuaResult(upperGua, lowerGua, movingLine, question);
    });

    function generateGuaResult(upperGua, lowerGua, movingLine = null, question = '') {
      const tiGua = lowerGua;
      const yongGua = upperGua;

      let changedGua = null;
      if (movingLine) {
        changedGua = getMovingGua(upperGua, lowerGua, movingLine);
      }

      const wuxingRelation = getWuxingRelation(yongGua, tiGua);
      const result = {
        question,
        tiGua,
        yongGua,
        movingLine,
        changedGua: changedGua ? changedGua.upper : null,
        changedLower: changedGua ? changedGua.lower : null,
        wuxing: wuxingRelation,
        timestamp: new Date().toLocaleString('zh-TW', { timeZone: 'Asia/Taipei' })
      };
      
      currentResult = result;
      history.unshift(result);
      if (history.length > 10) history.pop();
      saveHistory();

      document.getElementById('result').classList.remove('hidden');
      document.getElementById('result-question').textContent = question ? `問題：${question}` : '';
      document.getElementById('subtitle').textContent = `卦象結果：${GUA_DATA[tiGua].name}${GUA_DATA[yongGua].name}卦`;

      renderGua(yongGua, 'originalGua');
      if (movingLine) {
        renderGua(yongGua, 'movingGua', movingLine);
        renderGua(changedGua.upper, 'changedGua');
        document.getElementById('movingGua').classList.remove('hidden');
        document.getElementById('changedGua').classList.remove('hidden');
      } else {
        document.getElementById('movingGua').classList.add('hidden');
        document.getElementById('changedGua').classList.add('hidden');
      }

      renderWuxingAnalysis(result);
      renderDetailedAnalysis(result);
      renderLineExplanation(result);
    }

    function renderHistory() {
      const historyList = document.getElementById('historyList');
      historyList.innerHTML = '';
      if (history.length === 0) {
        historyList.innerHTML = '<p>尚無歷史記錄。</p>';
        return;
      }
      history.forEach((item, index) => {
        const itemDiv = document.createElement('div');
        itemDiv.className = 'gua-box';
        itemDiv.innerHTML = `
          <p><strong>占卜時間:</strong> ${item.timestamp}</p>
          <p><strong>問題:</strong> ${item.question || '無'}</p>
          <p><strong>本卦:</strong> ${GUA_DATA[item.yongGua].name}${GUA_DATA[item.tiGua].name}卦</p>
          <p><strong>五行關係:</strong> ${item.wuxing.main.display_name} - ${item.wuxing.overall.display_name}</p>
          <button class="primary" onclick="loadHistoryItem(${index})">載入此卦</button>
        `;
        historyList.appendChild(itemDiv);
      });
    }

    function loadHistoryItem(index) {
      currentResult = history[index];
      const { tiGua, yongGua, movingLine, changedGua, question } = currentResult;
      
      document.getElementById('result').classList.remove('hidden');
      document.getElementById('result-question').textContent = question ? `問題：${question}` : '';
      document.getElementById('subtitle').textContent = `卦象結果：${GUA_DATA[tiGua].name}${GUA_DATA[yongGua].name}卦`;

      renderGua(yongGua, 'originalGua');
      if (movingLine) {
        renderGua(yongGua, 'movingGua', movingLine);
        renderGua(changedGua, 'changedGua');
        document.getElementById('movingGua').classList.remove('hidden');
        document.getElementById('changedGua').classList.remove('hidden');
      } else {
        document.getElementById('movingGua').classList.add('hidden');
        document.getElementById('changedGua').classList.add('hidden');
      }

      renderWuxingAnalysis(currentResult);
      renderDetailedAnalysis(currentResult);
      renderLineExplanation(currentResult);
      
      switchTab('number');
    }

    document.getElementById('nowQuick').addEventListener('click', () => {
      const now = new Date();
      now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
      document.getElementById('dtInput').value = now.toISOString().slice(0, 16);
    });

    document.getElementById('btnImage').addEventListener('click', () => {
      const upperGua = parseInt(document.getElementById('selImageUpper').value);
      const lowerGua = parseInt(document.getElementById('selImageLower').value);
      const movingLine = parseInt(document.getElementById('selImageMoving').value);
      const question = document.getElementById('questionImage').value;
      if (isNaN(upperGua) || isNaN(lowerGua) || isNaN(movingLine)) {
        alert('請選擇卦象與動爻！');
        return;
      }
      generateGuaResult(upperGua, lowerGua, movingLine, question);
    });

    document.getElementById('downloadSvgBtn').addEventListener('click', () => {
      downloadSvg();
    });

    document.getElementById('openSvgWindowBtn').addEventListener('click', () => {
      openSvgInNewWindow();
    });
    
  </script>
</body>
</html>
