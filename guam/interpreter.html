<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>專業梅花心易五行分析系統 - 解卦端</title>
</head>
<body>
    <h1>解卦端：監聽MQTT訊息</h1>
    <div id="status">連線狀態...</div>

    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <script>
        const broker = 'wss://broker.mqttgo.io:8084/mqtt';
        const elements = {1: '金', 2: '金', 3: '火', 4: '木', 5: '木', 6: '水', 7: '土', 8: '土'};
        const trigramNames = {1: '乾', 2: '兌', 3: '離', 4: '震', 5: '巽', 6: '坎', 7: '艮', 8: '坤'};
        const trigramMeanings = {
            1: '剛健、領導、積極進取',
            2: '喜悅、交流、和諧',
            3: '光明、熱情、依附',
            4: '行動、振奮、開創',
            5: '柔順、靈活、潛入',
            6: '危險、深沉、內斂',
            7: '止息、穩重、堅守',
            8: '柔順、包容、大地'
        };
        const trigramLines = {
            1: [1,1,1], // 乾 ☰
            2: [0,1,1], // 兌 ☱
            3: [1,0,1], // 離 ☲
            4: [0,0,1], // 震 ☳
            5: [1,1,0], // 巽 ☴
            6: [0,1,0], // 坎 ☵
            7: [1,0,0], // 艮 ☶
            8: [0,0,0]  // 坤 ☷
        };
        const generation = {'木': '火', '火': '土', '土': '金', '金': '水', '水': '木'};
        const destruction = {'木': '土', '火': '金', '土': '水', '金': '木', '水': '火'};
        // 簡化爻辭（模擬，實際需64卦爻辭資料庫）
        const yaoDict = {
            1: ['初爻：潛龍勿用，謀事需謹慎，宜靜待時機。',
                '二爻：見龍在田，時機漸熟，宜穩健行事。',
                '三爻：君子終日乾乾，需防小人阻礙。',
                '四爻：或躍在淵，進退自如，謀事可成。',
                '五爻：飛龍在天，大吉大利，宜積極進取。',
                '六爻：亢龍有悔，物極必反，宜謹防過盛。'],
            // 其他卦可擴展，這裡簡化為相同爻辭
        };
        // 簡單的64卦名稱（部分示例，實際需完整映射）
        const hexagramNames = {
            '11': '乾為天', '12': '天澤履', '13': '天火同人', '14': '天雷無妄',
            '81': '地天泰', '82': '地澤臨', '83': '地火明夷', '84': '地雷復'
            // 需補充完整64卦
        };

        function getRelation(body, use) {
            if (body === use) return '比和：兩卦五行相合，運勢穩定，宜穩中求進。';
            if (generation[body] === use) return '體生用：主卦耗力，付出較多，需量力而行。';
            if (generation[use] === body) return '用生體：得外力相助，運勢順暢，宜把握機會。';
            if (destruction[body] === use) return '體克用：主卦掌控局面，易獲成功，但需防驕傲。';
            if (destruction[use] === body) return '用克體：主卦受制，運勢受阻，宜謹慎行事。';
            return '無直接生克關係，宜觀察卦象變化。';
        }

        function getHexagram(upper, lower) {
            const key = `${upper}${lower}`;
            return hexagramNames[key] || `${trigramNames[upper]}為上，${trigramNames[lower]}為下`;
        }

        function getMutualHexagram(upper, lower) {
            const upperLines = trigramLines[upper];
            const lowerLines = trigramLines[lower];
            const lines = [...lowerLines, ...upperLines];
            const mutualLower = [lines[1], lines[2], lines[3]];
            const mutualUpper = [lines[2], lines[3], lines[4]];
            const findTrigram = lines => Object.keys(trigramLines).find(k => 
                trigramLines[k].every((v, i) => v === lines[i])
            );
            return {
                upper: parseInt(findTrigram(mutualUpper) || 8),
                lower: parseInt(findTrigram(mutualLower) || 8)
            };
        }

        function getChangedHexagram(upper, lower, moving) {
            const upperLines = [...trigramLines[upper]];
            const lowerLines = [...trigramLines[lower]];
            const lines = [...lowerLines, ...upperLines];
            lines[moving - 1] = 1 - lines[moving - 1]; // 動爻陰陽互換
            const changedLower = lines.slice(0, 3);
            const changedUpper = lines.slice(3, 6);
            const findTrigram = lines => Object.keys(trigramLines).find(k => 
                trigramLines[k].every((v, i) => v === lines[i])
            );
            return {
                upper: parseInt(findTrigram(changedUpper) || 8),
                lower: parseInt(findTrigram(changedLower) || 8)
            };
        }

        function generateAnalysis(upper, lower, moving, question) {
            const elemBody = elements[lower];
            const elemUse = elements[upper];
            const relation = getRelation(elemBody, elemUse);
            const hexagram = getHexagram(upper, lower);
            const mutual = getMutualHexagram(upper, lower);
            const changed = getChangedHexagram(upper, lower, moving);
            const yao = yaoDict[1]?.[moving - 1] || `第${moving}爻動：宜審慎行事，參考卦象變化。`;
            const upperMeaning = trigramMeanings[upper];
            const lowerMeaning = trigramMeanings[lower];
            const mutualHexagram = getHexagram(mutual.upper, mutual.lower);
            const changedHexagram = getHexagram(changed.upper, changed.lower);
            // 綜合建議（模擬梅花心易斷卦）
            let advice = '';
            if (relation.includes('比和') || relation.includes('用生體')) {
                advice = '運勢較順，宜把握時機，結合問題背景積極行動，但需注意動爻變化。';
            } else if (relation.includes('用克體')) {
                advice = '運勢受阻，宜謹慎決策，觀察互卦與變卦，尋求化解之道。';
            } else if (relation.includes('體生用')) {
                advice = '需付出較多努力，宜穩紮穩打，參考變卦趨勢調整策略。';
            } else if (relation.includes('體克用')) {
                advice = '局面有利，宜積極進取，但動爻提示需防過於激進。';
            } else {
                advice = '運勢平穩，宜觀察情勢變化，參考互卦與變卦尋求方向。';
            }
            return `問題：${question}\n` +
                   `本卦：${hexagram}\n` +
                   `上卦：${trigramNames[upper]}（${upperMeaning}）\n` +
                   `下卦：${trigramNames[lower]}（${lowerMeaning}）\n` +
                   `動爻：第${moving}爻\n` +
                   `五行分析：\n` +
                   `  體（下卦）：${elemBody}\n` +
                   `  用（上卦）：${elemUse}\n` +
                   `  生克關係：${relation}\n` +
                   `互卦：${mutualHexagram}\n` +
                   `變卦：${changedHexagram}\n` +
                   `爻辭參考：${yao}\n` +
                   `解卦建議：${advice}\n` +
                   `綜合分析：本卦反映當前情勢，互卦揭示中間過程，變卦預示最終趨勢。請結合問題背景，參考五行生克與爻辭，謹慎決策。`;
        }

        function generateSVG(body, use) {
            const pos = {'木': '50 10', '火': '90 35', '土': '75 80', '金': '25 80', '水': '10 35'};
            const fill = el => (el === body || el === use) ? 'red' : 'black';
            return `<svg width="100" height="100" viewBox="0 0 100 100">
                <circle cx="50" cy="10" r="5" fill="${fill('木')}"/><text x="50" y="5">木</text>
                <circle cx="90" cy="35" r="5" fill="${fill('火')}"/><text x="90" y="30">火</text>
                <circle cx="75" cy="80" r="5" fill="${fill('土')}"/><text x="75" y="75">土</text>
                <circle cx="25" cy="80" r="5" fill="${fill('金')}"/><text x="25" y="75">金</text>
                <circle cx="10" cy="35" r="5" fill="${fill('水')}"/><text x="10" y="30">水</text>
                <!-- 生箭頭 (綠) -->
                <line x1="50" y1="10" x2="90" y2="35" stroke="green"/>
                <line x1="90" y1="35" x2="75" y2="80" stroke="green"/>
                <line x1="75" y1="80" x2="25" y2="80" stroke="green"/>
                <line x1="25" y1="80" x2="10" y2="35" stroke="green"/>
                <line x1="10" y1="35" x2="50" y2="10" stroke="green"/>
                <!-- 克箭頭 (紅虛線) -->
                <line x1="50" y1="10" x2="75" y2="80" stroke="red" stroke-dasharray="5"/>
                <line x1="90" y1="35" x2="25" y2="80" stroke="red" stroke-dasharray="5"/>
                <line x1="75" y1="80" x2="10" y2="35" stroke="red" stroke-dasharray="5"/>
                <line x1="25" y1="80" x2="50" y2="10" stroke="red" stroke-dasharray="5"/>
                <line x1="10" y1="35" x2="90" y2="35" stroke="red" stroke-dasharray="5"/>
            </svg>`;
        }

        const client = mqtt.connect(broker);
        const status = document.getElementById('status');
        client.on('connect', () => {
            status.innerText = '已連線，監聽中...';
            client.subscribe('mhxingyi/#');
        });
        client.on('message', (topic, message) => {
            const parts = topic.split('/');
            if (parts.length !== 3 || parts[0] !== 'mhxingyi') return;
            const id = parts[1];
            const code = parts[2];
            if (code.length !== 3) return;
            const upper = parseInt(code[0]);
            const lower = parseInt(code[1]);
            const moving = parseInt(code[2]);
            const question = message.toString();
            const analysis = generateAnalysis(upper, lower, moving, question);
            const svg = generateSVG(elements[lower], elements[upper]);
            const payload = JSON.stringify({analysis, svg});
            client.publish(`mhxingyi/${id}/result`, payload);
            status.innerText = `已處理並回傳: ${topic}`;
        });
    </script>
</body>
</html>
