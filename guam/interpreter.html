<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>專業梅花心易五行分析系統 - 解卦端</title>
</head>
<body>
    <h1>解卦端：監聽MQTT訊息</h1>
    <div id="status">連線狀態...</div>

    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <script>
        const broker = 'wss://broker.mqttgo.io:8084/mqtt';
        const elements = {1: '金', 2: '金', 3: '火', 4: '木', 5: '木', 6: '水', 7: '土', 8: '土'};
        const trigramNames = {1: '乾', 2: '兌', 3: '離', 4: '震', 5: '巽', 6: '坎', 7: '艮', 8: '坤'};
        const trigramMeanings = {
            1: '剛健、領導、積極進取',
            2: '喜悅、交流、和諧',
            3: '光明、熱情、依附',
            4: '行動、振奮、開創',
            5: '柔順、靈活、潛入',
            6: '危險、深沉、內斂',
            7: '止息、穩重、堅守',
            8: '柔順、包容、大地'
        };
        const trigramLines = {
            1: [1,1,1], // 乾 ☰
            2: [0,1,1], // 兌 ☱
            3: [1,0,1], // 離 ☲
            4: [0,0,1], // 震 ☳
            5: [1,1,0], // 巽 ☴
            6: [0,1,0], // 坎 ☵
            7: [1,0,0], // 艮 ☶
            8: [0,0,0]  // 坤 ☷
        };
        const generation = {'木': '火', '火': '土', '土': '金', '金': '水', '水': '木'};
        const destruction = {'木': '土', '火': '金', '土': '水', '金': '木', '水': '火'};
        // 簡化爻辭（模擬乾卦，實際需64卦384爻資料庫）
        const yaoDict = {
            1: ['初爻：潛龍勿用，時機未至，宜靜待。',
                '二爻：見龍在田，時機漸熟，宜穩健行事。',
                '三爻：君子終日乾乾，謹防小人，宜守正。',
                '四爻：或躍在淵，進退自如，謀事可成。',
                '五爻：飛龍在天，大吉大利，宜積極進取。',
                '六爻：亢龍有悔，物極必反，宜謹慎收斂。'],
            // 其他卦簡化為通用爻辭
            default: ['初爻：起初謹慎，宜觀察形勢。',
                      '二爻：時機初現，宜穩中求進。',
                      '三爻：小有波折，宜守正待時。',
                      '四爻：運勢漸開，宜謀定後動。',
                      '五爻：大吉之象，宜果斷行動。',
                      '六爻：過盛則衰，宜謹防風險。']
        };
        // 簡單64卦名稱（部分示例）
        const hexagramNames = {
            '11': '乾為天', '12': '天澤履', '13': '天火同人', '14': '天雷無妄',
            '81': '地天泰', '82': '地澤臨', '83': '地火明夷', '84': '地雷復',
            '36': '火水未濟', '63': '水火既濟'
            // 需補充完整64卦
        };

        function getRelation(body, use) {
            if (body === use) return {text: '比和：五行相同，力量均衡，穩定有利。', luck: '吉'};
            if (generation[body] === use) return {text: '體生用：主卦耗力，付出較多，需謹慎用力。', luck: '平'};
            if (generation[use] === body) return {text: '用生體：得外力相助，運勢順暢。', luck: '吉'};
            if (destruction[body] === use) return {text: '體克用：主卦掌控局面，易獲成功。', luck: '吉'};
            if (destruction[use] === body) return {text: '用克體：主卦受制，運勢受阻，需防風險。', luck: '凶'};
            return {text: '無直接生克：五行無強烈交互，宜觀察卦象變化。', luck: '平'};
        }

        function getHexagram(upper, lower) {
            const key = `${upper}${lower}`;
            return hexagramNames[key] || `${trigramNames[upper]}為上，${trigramNames[lower]}為下`;
        }

        function getMutualHexagram(upper, lower) {
            const upperLines = trigramLines[upper];
            const lowerLines = trigramLines[lower];
            const lines = [...lowerLines, ...upperLines];
            const mutualLower = [lines[1], lines[2], lines[3]];
            const mutualUpper = [lines[2], lines[3], lines[4]];
            const findTrigram = lines => Object.keys(trigramLines).find(k => 
                trigramLines[k].every((v, i) => v === lines[i])
            );
            return {
                upper: parseInt(findTrigram(mutualUpper) || 8),
                lower: parseInt(findTrigram(mutualLower) || 8)
            };
        }

        function getChangedHexagram(upper, lower, moving) {
            const upperLines = [...trigramLines[upper]];
            const lowerLines = [...trigramLines[lower]];
            const lines = [...lowerLines, ...upperLines];
            lines[moving - 1] = 1 - lines[moving - 1];
            const changedLower = lines.slice(0, 3);
            const changedUpper = lines.slice(3, 6);
            const findTrigram = lines => Object.keys(trigramLines).find(k => 
                trigramLines[k].every((v, i) => v === lines[i])
            );
            return {
                upper: parseInt(findTrigram(changedUpper) || 8),
                lower: parseInt(findTrigram(changedLower) || 8)
            };
        }

        function getLuckJudgment(relationLuck, moving, changedUpper, changedLower) {
            let luck = relationLuck;
            // 動爻影響：初爻偏凶，五爻偏吉
            if (moving === 1 || moving === 6) luck = luck === '吉' ? '平' : '凶';
            if (moving === 5) luck = luck === '凶' ? '平' : '吉';
            // 變卦影響：乾（1）、泰（81）等偏吉，否（18）、未濟（36）偏凶
            const changedKey = `${changedUpper}${changedLower}`;
            if (['11', '81'].includes(changedKey)) luck = luck === '平' ? '吉' : luck;
            if (['18', '36'].includes(changedKey)) luck = luck === '平' ? '凶' : luck;
            return luck;
        }

        function getAdvice(relation, luck, moving, question) {
            const actions = {
                '吉': `宜積極進取，把握當前機會，結合問題「${question}」，可果斷行動，但注意動爻${moving}的提示，避免過於激進。`,
                '平': `運勢平穩，宜穩中求進，針對「${question}」，建議謹慎規劃，參考動爻${moving}的時機指引。`,
                '凶': `運勢不利，宜謹慎行事，針對「${question}」，建議暫緩行動，觀察形勢，依動爻${moving}尋求化解之道。`
            };
            return actions[luck] || `針對「${question}」，宜審慎觀察，結合動爻${moving}與五行${relation.text}，靈活應對。`;
        }

        function generateAnalysis(upper, lower, moving, question) {
            const elemBody = elements[lower];
            const elemUse = elements[upper];
            const relation = getRelation(elemBody, elemUse);
            const hexagram = getHexagram(upper, lower);
            const mutual = getMutualHexagram(upper, lower);
            const changed = getChangedHexagram(upper, lower, moving);
            const yao = yaoDict[upper] || yaoDict['default'];
            const yaoText = yao[moving - 1];
            const upperMeaning = trigramMeanings[upper];
            const lowerMeaning = trigramMeanings[lower];
            const mutualHexagram = getHexagram(mutual.upper, mutual.lower);
            const changedHexagram = getHexagram(changed.upper, changed.lower);
            const luck = getLuckJudgment(relation.luck, moving, changed.upper, changed.lower);
            const advice = getAdvice(relation, luck, moving, question);
            return `問題：${question}\n` +
                   `本卦：${hexagram}\n` +
                   `上卦：${trigramNames[upper]}（${upperMeaning}）\n` +
                   `下卦：${trigramNames[lower]}（${lowerMeaning}）\n` +
                   `動爻：第${moving}爻\n` +
                   `五行分析：\n` +
                   `  體（下卦）：${elemBody}\n` +
                   `  用（上卦）：${elemUse}\n` +
                   `  生克狀態：${relation.text}\n` +
                   `互卦：${mutualHexagram}\n` +
                   `變卦：${changedHexagram}\n` +
                   `爻辭參考：${yaoText}\n` +
                   `吉凶判斷：${luck}\n` +
                   `趨吉避凶建議：${advice}\n` +
                   `綜合分析：本卦反映當前情勢，互卦揭示過程變化，變卦預示未來趨勢。結合五行生克與動爻，針對「${question}」，宜依建議行動。`;
        }

        function generateSVG(body, use) {
            const pos = {'木': '50 10', '火': '90 35', '土': '75 80', '金': '25 80', '水': '10 35'};
            const fill = el => (el === body || el === use) ? 'red' : 'black';
            const strokeGen = (from, to) => generation[from] === to ? 'green' : 'transparent';
            const strokeDes = (from, to) => destruction[from] === to ? 'red' : 'transparent';
            return `<svg width="120" height="120" viewBox="0 0 120 120">
                <!-- 五行節點 -->
                <circle cx="50" cy="10" r="5" fill="${fill('木')}"/><text x="50" y="5">木</text>
                <circle cx="90" cy="35" r="5" fill="${fill('火')}"/><text x="90" y="30">火</text>
                <circle cx="75" cy="80" r="5" fill="${fill('土')}"/><text x="75" y="75">土</text>
                <circle cx="25" cy="80" r="5" fill="${fill('金')}"/><text x="25" y="75">金</text>
                <circle cx="10" cy="35" r="5" fill="${fill('水')}"/><text x="10" y="30">水</text>
                <!-- 生箭頭（僅顯示與體用相關） -->
                <line x1="50" y1="10" x2="90" y2="35" stroke="${strokeGen(body, '火') || strokeGen(use, '火')}" stroke-width="2"/>
                <line x1="90" y1="35" x2="75" y2="80" stroke="${strokeGen(body, '土') || strokeGen(use, '土')}" stroke-width="2"/>
                <line x1="75" y1="80" x2="25" y2="80" stroke="${strokeGen(body, '金') || strokeGen(use, '金')}" stroke-width="2"/>
                <line x1="25" y1="80" x2="10" y2="35" stroke="${strokeGen(body, '水') || strokeGen(use, '水')}" stroke-width="2"/>
                <line x1="10" y1="35" x2="50" y2="10" stroke="${strokeGen(body, '木') || strokeGen(use, '木')}" stroke-width="2"/>
                <!-- 克箭頭（僅顯示與體用相關） -->
                <line x1="50" y1="10" x2="75" y2="80" stroke="${strokeDes(body, '土') || strokeDes(use, '土')}" stroke-width="2" stroke-dasharray="5"/>
                <line x1="90" y1="35" x2="25" y2="80" stroke="${strokeDes(body, '金') || strokeDes(use, '金')}" stroke-width="2" stroke-dasharray="5"/>
                <line x1="75" y1="80" x2="10" y2="35" stroke="${strokeDes(body, '水') || strokeDes(use, '水')}" stroke-width="2" stroke-dasharray="5"/>
                <line x1="25" y1="80" x2="50" y2="10" stroke="${strokeDes(body, '木') || strokeDes(use, '木')}" stroke-width="2" stroke-dasharray="5"/>
                <line x1="10" y1="35" x2="90" y2="35" stroke="${strokeDes(body, '火') || strokeDes(use, '火')}" stroke-width="2" stroke-dasharray="5"/>
                <!-- 圖例 -->
                <text x="10" y="110">圖例：紅色=體/用，綠色實線=生，紅色虛線=克</text>
            </svg>`;
        }

        const client = mqtt.connect(broker);
        const status = document.getElementById('status');
        client.on('connect', () => {
            status.innerText = '已連線，監聽中...';
            client.subscribe('mhxingyi/#');
        });
        client.on('message', (topic, message) => {
            const parts = topic.split('/');
            if (parts.length !== 3 || parts[0] !== 'mhxingyi') return;
            const id = parts[1];
            const code = parts[2];
            if (code.length !== 3) return;
            const upper = parseInt(code[0]);
            const lower = parseInt(code[1]);
            const moving = parseInt(code[2]);
            const question = message.toString();
            const analysis = generateAnalysis(upper, lower, moving, question);
            const svg = generateSVG(elements[lower], elements[upper]);
            const payload = JSON.stringify({analysis, svg});
            client.publish(`mhxingyi/${id}/result`, payload);
            status.innerText = `已處理並回傳: ${topic}`;
        });
    </script>
</body>
</html>
