<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>專業梅花心易五行分析系統 - 解卦端</title>
</head>
<body>
    <h1>解卦端：監聽MQTT訊息</h1>
    <div id="status">連線狀態...</div>

    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <script>
        const broker = 'wss://broker.mqttgo.io:8084/mqtt';
        const elements = {1: '金', 2: '金', 3: '火', 4: '木', 5: '木', 6: '水', 7: '土', 8: '土'};
        const trigramNames = {1: '乾', 2: '兌', 3: '離', 4: '震', 5: '巽', 6: '坎', 7: '艮', 8: '坤'};
        const trigramLines = {
            1: [1,1,1], // 乾 ☰
            2: [0,1,1], // 兌 ☱
            3: [1,0,1], // 離 ☲
            4: [0,0,1], // 震 ☳
            5: [1,1,0], // 巽 ☴
            6: [0,1,0], // 坎 ☵
            7: [1,0,0], // 艮 ☶
            8: [0,0,0]  // 坤 ☷
        };
        const generation = {'木': '火', '火': '土', '土': '金', '金': '水', '水': '木'};
        const destruction = {'木': '土', '火': '金', '土': '水', '金': '木', '水': '火'};
        // 簡化爻辭（實際需64卦每爻的詳細資料庫，這裡用模擬）
        const yaoDict = {
            1: ['初爻動：謀事需謹慎，宜守不宜進。', '二爻動：時機未熟，耐心等待。', '三爻動：小有阻礙，宜穩中求進。', 
                '四爻動：運勢漸開，謀事可成。', '五爻動：大吉大利，宜積極進取。', '六爻動：物極必反，謹防過猶不及。'],
            // 其他卦的爻辭可擴展，這裡簡化假設相同
        };

        function getRelation(body, use) {
            if (body === use) return '比和（相合，運勢穩定）';
            if (generation[body] === use) return '體生用（耗力，付出較多）';
            if (generation[use] === body) return '用生體（得助，助力較強）';
            if (destruction[body] === use) return '體克用（掌控，易成功）';
            if (destruction[use] === body) return '用克體（受損，需謹慎）';
            return '無直接生克關係';
        }

        function getHexagram(upper, lower) {
            // 簡單映射，實際需64卦表，這裡假設上卦=下卦時為乾（1）等
            return `${trigramNames[upper]}為上，${trigramNames[lower]}為下`;
        }

        function getMutualHexagram(upper, lower) {
            const upperLines = trigramLines[upper];
            const lowerLines = trigramLines[lower];
            const lines = [...lowerLines, ...upperLines]; // 六爻：下卦+上卦
            const mutualLower = [lines[1], lines[2], lines[3]]; // 二三四爻
            const mutualUpper = [lines[2], lines[3], lines[4]]; // 三四五爻
            const findTrigram = lines => Object.keys(trigramLines).find(k => 
                trigramLines[k].every((v, i) => v === lines[i])
            );
            return {
                upper: parseInt(findTrigram(mutualUpper) || 8),
                lower: parseInt(findTrigram(mutualLower) || 8)
            };
        }

        function getChangedHexagram(upper, lower, moving) {
            const upperLines = [...trigramLines[upper]];
            const lowerLines = [...trigramLines[lower]];
            const lines = [...lowerLines, ...upperLines];
            lines[moving - 1] = 1 - lines[moving - 1]; // 動爻陰陽互換
            const changedLower = lines.slice(0, 3);
            const changedUpper = lines.slice(3, 6);
            const findTrigram = lines => Object.keys(trigramLines).find(k => 
                trigramLines[k].every((v, i) => v === lines[i])
            );
            return {
                upper: parseInt(findTrigram(changedUpper) || 8),
                lower: parseInt(findTrigram(changedLower) || 8)
            };
        }

        function generateAnalysis(upper, lower, moving, question) {
            const elemBody = elements[lower];
            const elemUse = elements[upper];
            const relation = getRelation(elemBody, elemUse);
            const hexagram = getHexagram(upper, lower);
            const mutual = getMutualHexagram(upper, lower);
            const changed = getChangedHexagram(upper, lower, moving);
            const yao = yaoDict[1]?.[moving - 1] || `第${moving}爻動：宜審慎行事。`; // 簡化爻辭
            return `問題：${question}\n` +
                   `本卦：${hexagram}，動爻第${moving}爻\n` +
                   `體元素（下卦）：${elemBody}，用元素（上卦）：${elemUse}\n` +
                   `五行生克：${relation}\n` +
                   `互卦：上${trigramNames[mutual.upper]} 下${trigramNames[mutual.lower]}\n` +
                   `變卦：上${trigramNames[changed.upper]} 下${trigramNames[changed.lower]}\n` +
                   `爻辭參考：${yao}\n` +
                   `解卦建議：依據五行${relation}，動爻位於${moving}，宜參考爻辭與互變卦象，審慎決策。`;
        }

        function generateSVG(body, use) {
            const pos = {'木': '50 10', '火': '90 35', '土': '75 80', '金': '25 80', '水': '10 35'};
            const fill = el => (el === body || el === use) ? 'red' : 'black';
            return `<svg width="100" height="100" viewBox="0 0 100 100">
                <circle cx="50" cy="10" r="5" fill="${fill('木')}"/><text x="50" y="5">木</text>
                <circle cx="90" cy="35" r="5" fill="${fill('火')}"/><text x="90" y="30">火</text>
                <circle cx="75" cy="80" r="5" fill="${fill('土')}"/><text x="75" y="75">土</text>
                <circle cx="25" cy="80" r="5" fill="${fill('金')}"/><text x="25" y="75">金</text>
                <circle cx="10" cy="35" r="5" fill="${fill('水')}"/><text x="10" y="30">水</text>
                <!-- 生箭頭 (綠) -->
                <line x1="50" y1="10" x2="90" y2="35" stroke="green"/>
                <line x1="90" y1="35" x2="75" y2="80" stroke="green"/>
                <line x1="75" y1="80" x2="25" y2="80" stroke="green"/>
                <line x1="25" y1="80" x2="10" y2="35" stroke="green"/>
                <line x1="10" y1="35" x2="50" y2="10" stroke="green"/>
                <!-- 克箭頭 (紅虛線) -->
                <line x1="50" y1="10" x2="75" y2="80" stroke="red" stroke-dasharray="5"/>
                <line x1="90" y1="35" x2="25" y2="80" stroke="red" stroke-dasharray="5"/>
                <line x1="75" y1="80" x2="10" y2="35" stroke="red" stroke-dasharray="5"/>
                <line x1="25" y1="80" x2="50" y2="10" stroke="red" stroke-dasharray="5"/>
                <line x1="10" y1="35" x2="90" y2="35" stroke="red" stroke-dasharray="5"/>
            </svg>`;
        }

        const client = mqtt.connect(broker);
        const status = document.getElementById('status');
        client.on('connect', () => {
            status.innerText = '已連線，監聽中...';
            client.subscribe('mhxingyi/#');
        });
        client.on('message', (topic, message) => {
            const parts = topic.split('/');
            if (parts.length !== 3 || parts[0] !== 'mhxingyi') return;
            const id = parts[1];
            const code = parts[2];
            if (code.length !== 3) return;
            const upper = parseInt(code[0]);
            const lower = parseInt(code[1]);
            const moving = parseInt(code[2]);
            const question = message.toString();
            const analysis = generateAnalysis(upper, lower, moving, question);
            const svg = generateSVG(elements[lower], elements[upper]);
            const payload = JSON.stringify({analysis, svg});
            client.publish(`mhxingyi/${id}/result`, payload);
            status.innerText = `已處理並回傳: ${topic}`;
        });
    </script>
</body>
</html>
