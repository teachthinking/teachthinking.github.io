<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>梅花心易卜卦與解卦</title>
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f0f4f8;
            color: #333;
        }
        h1, h2, h3 {
            color: #2c3e50;
        }
        .tab-container {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .tab {
            padding: 10px 20px;
            background-color: #ddd;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .tab.active {
            background-color: #3498db;
            color: white;
        }
        .input-container, .result-container {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .line-input {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        .line-input label {
            width: 120px;
            font-weight: bold;
        }
        select, input[type="number"], input[type="text"], textarea {
            padding: 8px;
            border-radius: 5px;
            border: 1px solid #ccc;
            width: 200px;
        }
        button {
            padding: 10px 20px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px 5px;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #2980b9;
        }
        .result {
            margin-top: 10px;
        }
        .canvas-container {
            text-align: center;
            margin-top: 20px;
        }
        canvas {
            border: 1px solid #ddd;
            border-radius: 5px;
            cursor: pointer;
        }
        .error {
            color: #e74c3c;
            text-align: center;
            margin-top: 10px;
            font-weight: bold;
        }
        .quote {
            text-align: center;
            font-style: italic;
            color: #666;
            margin: 10px 0;
        }
        .history {
            margin-top: 20px;
        }
        .history-item {
            border: 1px solid #ddd;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
            background-color: #fff;
        }
        .line-analysis {
            margin-top: 10px;
            padding: 10px;
            border-top: 1px solid #ddd;
        }
    </style>
</head>
<body>
    <h1>梅花心易卜卦與解卦</h1>
    <div id="quote" class="quote"></div>

    <div class="tab-container">
        <div class="tab active" onclick="showTab('number')">數字取卦</div>
        <div class="tab" onclick="showTab('symbol')">以象取卦</div>
        <div class="tab" onclick="showTab('time')">時間取卦</div>
        <div class="tab" onclick="showTab('manual')">手動取卦</div>
    </div>

    <div id="number" class="input-container">
        <h3>數字取卦法</h3>
        <div class="line-input">
            <label>數字1 (100-999):</label>
            <input type="number" id="num1" min="100" max="999">
        </div>
        <div class="line-input">
            <label>數字2 (100-999):</label>
            <input type="number" id="num2" min="100" max="999">
        </div>
        <div class="line-input">
            <label>數字3 (100-999):</label>
            <input type="number" id="num3" min="100" max="999">
        </div>
        <button onclick="randomNumbers()">隨機生成</button>
        <button onclick="divine('number')">卜卦</button>
    </div>

    <div id="symbol" class="input-container" style="display: none;">
        <h3>以象取卦法</h3>
        <div class="line-input">
            <label>象徵描述:</label>
            <textarea id="symbol-input" rows="4" placeholder="輸入看到的景象或象徵"></textarea>
        </div>
        <button onclick="divine('symbol')">卜卦</button>
    </div>

    <div id="time" class="input-container" style="display: none;">
        <h3>時間取卦法</h3>
        <p>使用當前時間或輸入時間進行卜卦</p>
        <div class="line-input">
            <label>年份:</label>
            <input type="number" id="year" value="2025">
        </div>
        <div class="line-input">
            <label>月份:</label>
            <input type="number" id="month" min="1" max="12" value="8">
        </div>
        <div class="line-input">
            <label>日期:</label>
            <input type="number" id="day" min="1" max="31" value="28">
        </div>
        <div class="line-input">
            <label>時辰:</label>
            <select id="hour">
                <option value="0">子時 (23:00-01:00)</option>
                <option value="1">丑時 (01:00-03:00)</option>
                <option value="2">寅時 (03:00-05:00)</option>
                <option value="3">卯時 (05:00-07:00)</option>
                <option value="4">辰時 (07:00-09:00)</option>
                <option value="5">巳時 (09:00-11:00)</option>
                <option value="6">午時 (11:00-13:00)</option>
                <option value="7">未時 (13:00-15:00)</option>
                <option value="8">申時 (15:00-17:00)</option>
                <option value="9">酉時 (17:00-19:00)</option>
                <option value="10">戌時 (19:00-21:00)</option>
                <option value="11">亥時 (21:00-23:00)</option>
            </select>
        </div>
        <button onclick="divine('time')">卜卦</button>
    </div>

    <div id="manual" class="input-container" style="display: none;">
        <h3>手動取卦法</h3>
        <div class="line-input">
            <label>初爻 (Line 1):</label>
            <select id="line1">
                <option value="1">陽 (—)</option>
                <option value="0">陰 (- -)</option>
                <option value="9">老陽 (變)</option>
                <option value="6">老陰 (變)</option>
            </select>
        </div>
        <div class="line-input">
            <label>二爻 (Line 2):</label>
            <select id="line2">
                <option value="1">陽 (—)</option>
                <option value="0">陰 (- -)</option>
                <option value="9">老陽 (變)</option>
                <option value="6">老陰 (變)</option>
            </select>
        </div>
        <div class="line-input">
            <label>三爻 (Line 3):</label>
            <select id="line3">
                <option value="1">陽 (—)</option>
                <option value="0">陰 (- -)</option>
                <option value="9">老陽 (變)</option>
                <option value="6">老陰 (變)</option>
            </select>
        </div>
        <div class="line-input">
            <label>四爻 (Line 4):</label>
            <select id="line4">
                <option value="1">陽 (—)</option>
                <option value="0">陰 (- -)</option>
                <option value="9">老陽 (變)</option>
                <option value="6">老陰 (變)</option>
            </select>
        </div>
        <div class="line-input">
            <label>五爻 (Line 5):</label>
            <select id="line5">
                <option value="1">陽 (—)</option>
                <option value="0">陰 (- -)</option>
                <option value="9">老陽 (變)</option>
                <option value="6">老陰 (變)</option>
            </select>
        </div>
        <div class="line-input">
            <label>上爻 (Line 6):</label>
            <select id="line6">
                <option value="1">陽 (—)</option>
                <option value="0">陰 (- -)</option>
                <option value="9">老陽 (變)</option>
                <option value="6">老陰 (變)</option>
            </select>
        </div>
        <button onclick="divine('manual')">卜卦</button>
    </div>

    <div class="result-container" id="result" style="display: none;">
        <h2>卜卦結果</h2>
        <div class="result">
            <h3>傳統易經解卦</h3>
            <div id="main-hexagram"></div>
            <div id="changed-hexagram" style="display: none;"></div>
            <div id="changing-lines"></div>
            <div id="yao-analysis" class="line-analysis"></div>
            <div id="shi-ying" class="line-analysis"></div>
        </div>
        <div class="result">
            <h3>梅花心易解卦</h3>
            <div id="wuxing-analysis"></div>
            <div class="canvas-container">
                <h4>五行生剋圖</h4>
                <canvas id="wuxing-canvas" width="900" height="250"></canvas>
            </div>
        </div>
        <button onclick="saveResult()">保存結果</button>
        <button onclick="exportResults()">匯出記錄</button>
    </div>
    <div id="error" class="error" style="display: none;"></div>
    <div class="history">
        <h3>歷史記錄</h3>
        <div id="history-list"></div>
    </div>

    <script>
        const wuxingColors = {
            '木': '#2ecc71',
            '火': '#e74c3c',
            '土': '#f1c40f',
            '金': '#ecf0f1',
            '水': '#3498db'
        };

        const wuxingRelations = {
            '生': { '木': '火', '火': '土', '土': '金', '金': '水', '水': '木' },
            '剋': { '木': '土', '土': '水', '水': '火', '火': '金', '金': '木' }
        };

        const seasonWuxing = {
            '春': { 旺: '木', 相: '火', 休: '水', 囚: ['土', '金'], 死: '火' },
            '夏': { 旺: '火', 相: '土', 休: '金', 囚: ['水', '木'], 死: '木' },
            '秋': { 旺: '金', 相: '土', 休: '火', 囚: ['木', '水'], 死: '水' },
            '冬': { 旺: '水', 相: '金', 休: '木', 囚: ['火', '土'], 死: '土' },
            '四季末': { 旺: '土', 相: '火', 休: '金', 囚: ['水', '木'], 死: '水' }
        };

        const lineNames = ['初爻', '二爻', '三爻', '四爻', '五爻', '上爻'];

        const yaoWuxing = {
            1: ['金', '金', '水', '木', '木', '土'], // 乾
            2: ['土', '土', '木', '火', '火', '水'], // 坤
            // ... 其他卦的爻位五行，需根據 hexagrams.json 補充
        };

        function showTab(tabId) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.input-container').forEach(container => container.style.display = 'none');
            document.getElementById(tabId).style.display = 'block';
            document.querySelector(`.tab[onclick="showTab('${tabId}')"]`).classList.add('active');
        }

        function randomNumbers() {
            document.getElementById('num1').value = Math.floor(Math.random() * 900) + 100;
            document.getElementById('num2').value = Math.floor(Math.random() * 900) + 100;
            document.getElementById('num3').value = Math.floor(Math.random() * 900) + 100;
        }

        function getSeason(month) {
            if ([1, 2, 3].includes(month)) return '春';
            if ([3, 6, 9, 12].includes(month)) return '四季末';
            if ([4, 5, 6].includes(month)) return '夏';
            if ([7, 8, 9].includes(month)) return '秋';
            if ([10, 11, 12].includes(month)) return '冬';
            return '春';
        }

        function getWuxingStrength(wuxing, season) {
            const status = seasonWuxing[season];
            if (status.旺 === wuxing) return { status: '旺', thickness: 5 };
            if (status.相 === wuxing) return { status: '相', thickness: 4 };
            if (status.休 === wuxing) return { status: '休', thickness: 3 };
            if (status.囚.includes(wuxing)) return { status: '囚', thickness: 2 };
            if (status.死 === wuxing) return { status: '死', thickness: 1 };
            return { status: '未知', thickness: 1 };
        }

        function getHexagramFromNumbers(num1, num2, num3) {
            const upper = (num1 % 8) || 8;
            const lower = (num2 % 8) || 8;
            const changing = (num3 % 6) || 6;
            return { upper, lower, changing };
        }

        function getHexagramFromTime(year, month, day, hour) {
            const sum = year + month + day + hour;
            const upper = (sum % 8) || 8;
            const lower = ((sum + month) % 8) || 8;
            const changing = ((sum + hour) % 6) || 6;
            return { upper, lower, changing };
        }

        function getHexagramFromSymbol(text) {
            const hash = text.split('').reduce((sum, char) => sum + char.charCodeAt(0), 0);
            const upper = (hash % 8) || 8;
            const lower = ((hash + 1) % 8) || 8;
            const changing = ((hash + 2) % 6) || 6;
            return { upper, lower, changing };
        }

        function getHexagramLines(upper, lower, hexagrams) {
            const upperHex = hexagrams.find(h => h.trigram_number === upper);
            const lowerHex = hexagrams.find(h => h.trigram_number === lower);
            return [...lowerHex.binary.slice(0, 3), ...upperHex.binary.slice(0, 3)];
        }

        function getMutualHexagram(lines) {
            return [lines[1], lines[2], lines[3], lines[2], lines[3], lines[4]];
        }

        function getShiYing(mainHexagram) {
            const shiYingRules = {
                1: { shi: 5, ying: 2 },
                2: { shi: 5, ying: 2 },
                // ... 其他卦的世應爻規則，需根據 hexagrams.json 補充
            };
            return shiYingRules[mainHexagram.hexagram_number] || { shi: 5, ying: 2 };
        }

        function drawWuxingDiagram(main, mutual, changed, body, season, swapCallback) {
            const canvas = document.getElementById('wuxing-canvas');
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            const positions = [
                { x: 50, y: 50, label: '主卦上', hexagram: main.upper, wuxing: main.upper.wuxing },
                { x: 50, y: 150, label: '主卦下', hexagram: main.lower, wuxing: main.lower.wuxing },
                { x: 300, y: 100, label: '體卦', hexagram: body, wuxing: body.wuxing },
                { x: 550, y: 50, label: '互卦上', hexagram: mutual.upper, wuxing: mutual.upper.wuxing },
                { x: 550, y: 150, label: '互卦下', hexagram: mutual.lower, wuxing: mutual.lower.wuxing },
                { x: 800, y: 50, label: '變卦上', hexagram: changed.upper, wuxing: changed.upper.wuxing },
                { x: 800, y: 150, label: '變卦下', hexagram: changed.lower, wuxing: changed.lower.wuxing }
            ];

            positions.forEach((pos, index) => {
                const strength = getWuxingStrength(pos.wuxing, season);
                ctx.fillStyle = wuxingColors[pos.wuxing];
                ctx.beginPath();
                ctx.arc(pos.x, pos.y, 30, 0, Math.PI * 2);
                ctx.fill();
                ctx.fillStyle = '#000';
                ctx.font = '14px Noto Sans TC';
                ctx.textAlign = 'center';
                ctx.fillText(pos.label, pos.x, pos.y - 40);
                ctx.fillText(`${pos.hexagram.name} (${pos.wuxing} - ${strength.status})`, pos.x, pos.y + 50);
                pos.hexagram.binary.slice(0, 3).forEach((line, i) => {
                    ctx.beginPath();
                    if (line === 1) {
                        ctx.moveTo(pos.x - 20, pos.y - 20 + i * 10);
                        ctx.lineTo(pos.x + 20, pos.y - 20 + i * 10);
                    } else {
                        ctx.moveTo(pos.x - 20, pos.y - 20 + i * 10);
                        ctx.lineTo(pos.x - 5, pos.y - 20 + i * 10);
                        ctx.moveTo(pos.x + 5, pos.y - 20 + i * 10);
                        ctx.lineTo(pos.x + 20, pos.y - 20 + i * 10);
                    }
                    ctx.stroke();
                });
                canvas.addEventListener('click', (e) => {
                    const rect = canvas.getBoundingClientRect();
                    const clickX = e.clientX - rect.left;
                    const clickY = e.clientY - rect.top;
                    if (Math.sqrt((clickX - pos.x) ** 2 + (clickY - pos.y) ** 2) < 30 && index !== 2) {
                        swapCallback(pos.hexagram);
                    }
                }, { once: true });
            });

            const relations = [
                { from: positions[0], to: positions[2], type: wuxingRelations.生[positions[0].wuxing] === positions[2].wuxing ? '生' : wuxingRelations.剋[positions[0].wuxing] === positions[2].wuxing ? '剋' : '比和' },
                { from: positions[1], to: positions[2], type: wuxingRelations.生[positions[1].wuxing] === positions[2].wuxing ? '生' : wuxingRelations.剋[positions[1].wuxing] === positions[2].wuxing ? '剋' : '比和' },
                { from: positions[2], to: positions[3], type: wuxingRelations.生[positions[2].wuxing] === positions[3].wuxing ? '生' : wuxingRelations.剋[positions[2].wuxing] === positions[3].wuxing ? '剋' : '比和' },
                { from: positions[2], to: positions[4], type: wuxingRelations.生[positions[2].wuxing] === positions[4].wuxing ? '生' : wuxingRelations.剋[positions[2].wuxing] === positions[4].wuxing ? '剋' : '比和' },
                { from: positions[2], to: positions[5], type: wuxingRelations.生[positions[2].wuxing] === positions[5].wuxing ? '生' : wuxingRelations.剋[positions[2].wuxing] === positions[5].wuxing ? '剋' : '比和' },
                { from: positions[2], to: positions[6], type: wuxingRelations.生[positions[2].wuxing] === positions[5].wuxing ? '生' : wuxingRelations.剋[positions[2].wuxing] === positions[6].wuxing ? '剋' : '比和' }
            ];

            relations.forEach(rel => {
                const strength = getWuxingStrength(rel.from.wuxing, season);
                ctx.beginPath();
                ctx.moveTo(rel.from.x, rel.from.y);
                ctx.lineTo(rel.to.x, rel.to.y);
                ctx.strokeStyle = rel.type === '生' ? '#2ecc71' : rel.type === '剋' ? '#e74c3c' : '#95a5a6';
                ctx.lineWidth = strength.thickness;
                ctx.stroke();
                const midX = (rel.from.x + rel.to.x) / 2;
                const midY = (rel.from.y + rel.to.y) / 2;
                ctx.fillStyle = ctx.strokeStyle;
                ctx.fillText(rel.type, midX, midY - 10);
            });
        }

        async function divine(method) {
            let lines, season, inputData = {};
            const month = method === 'time' ? parseInt(document.getElementById('month').value) : new Date().getMonth() + 1;
            season = getSeason(month);

            if (method === 'number') {
                const num1 = parseInt(document.getElementById('num1').value);
                const num2 = parseInt(document.getElementById('num2').value);
                const num3 = parseInt(document.getElementById('num3').value);
                if (!num1 || !num2 || !num3 || num1 < 100 || num2 < 100 || num3 < 100 || num1 > 999 || num2 > 999 || num3 > 999) {
                    document.getElementById('error').textContent = '請輸入三個 100-999 的數字';
                    document.getElementById('error').style.display = 'block';
                    return;
                }
                inputData = { num1, num2, num3 };
                const { upper, lower, changing } = getHexagramFromNumbers(num1, num2, num3);
                lines = getHexagramLines(upper, lower, hexagramsData);
                lines[changing - 1] = lines[changing - 1] === 1 ? 9 : 6;
            } else if (method === 'symbol') {
                const text = document.getElementById('symbol-input').value;
                if (!text) {
                    document.getElementById('error').textContent = '請輸入象徵描述';
                    document.getElementById('error').style.display = 'block';
                    return;
                }
                inputData = { text };
                const { upper, lower, changing } = getHexagramFromSymbol(text);
                lines = getHexagramLines(upper, lower, hexagramsData);
                lines[changing - 1] = lines[changing - 1] === 1 ? 9 : 6;
            } else if (method === 'time') {
                const year = parseInt(document.getElementById('year').value);
                const month = parseInt(document.getElementById('month').value);
                const day = parseInt(document.getElementById('day').value);
                const hour = parseInt(document.getElementById('hour').value);
                if (!year || !month || !day || month < 1 || month > 12 || day < 1 || day > 31) {
                    document.getElementById('error').textContent = '請輸入有效的時間';
                    document.getElementById('error').style.display = 'block';
                    return;
                }
                inputData = { year, month, day, hour };
                const { upper, lower, changing } = getHexagramFromTime(year, month, day, hour);
                lines = getHexagramLines(upper, lower, hexagramsData);
                lines[changing - 1] = lines[changing - 1] === 1 ? 9 : 6;
            } else if (method === 'manual') {
                lines = [
                    parseInt(document.getElementById('line1').value),
                    parseInt(document.getElementById('line2').value),
                    parseInt(document.getElementById('line3').value),
                    parseInt(document.getElementById('line4').value),
                    parseInt(document.getElementById('line5').value),
                    parseInt(document.getElementById('line6').value)
                ];
                inputData = { lines };
            }

            try {
                const response = await fetch('hexagrams.json');
                if (!response.ok) throw new Error('無法載入 hexagrams.json');
                const hexagrams = await response.json();

                const wuxingResponse = await fetch('wuxing_explanations.json');
                if (!wuxingResponse.ok) throw new Error('無法載入 wuxing_explanations.json');
                const wuxingExplanations = await wuxingResponse.json();

                const quoteResponse = await fetch('quotes.json');
                if (!quoteResponse.ok) throw new Error('無法載入 quotes.json');
                const quotes = await quoteResponse.json();
                const randomQuote = quotes[Math.floor(Math.random() * quotes.length)];
                document.getElementById('quote').textContent = randomQuote.text;

                const mainLines = lines.map(l => l === 9 ? 1 : l === 6 ? 0 : l);
                const mainHexagram = hexagrams.find(h => JSON.stringify(h.binary) === JSON.stringify(mainLines));
                const changedLines = lines.map(l => l === 9 ? 0 : l === 6 ? 1 : l);
                const changedHexagram = hexagrams.find(h => JSON.stringify(h.binary) === JSON.stringify(changedLines));
                const mutualLines = getMutualHexagram(mainLines);
                const mutualHexagram = hexagrams.find(h => JSON.stringify(h.binary) === JSON.stringify(mutualLines));

                let bodyHexagram = mainHexagram;
                const upperTrigram = hexagrams.find(h => JSON.stringify(h.binary.slice(0, 3)) === JSON.stringify(mainLines.slice(3)));
                const lowerTrigram = hexagrams.find(h => JSON.stringify(h.binary.slice(0, 3)) === JSON.stringify(mainLines.slice(0, 3)));
                const mutualUpper = hexagrams.find(h => JSON.stringify(h.binary.slice(0, 3)) === JSON.stringify(mutualLines.slice(3)));
                const mutualLower = hexagrams.find(h => JSON.stringify(h.binary.slice(0, 3)) === JSON.stringify(mutualLines.slice(0, 3)));
                const changedUpper = hexagrams.find(h => JSON.stringify(h.binary.slice(0, 3)) === JSON.stringify(changedLines.slice(3)));
                const changedLower = hexagrams.find(h => JSON.stringify(h.binary.slice(0, 3)) === JSON.stringify(changedLines.slice(0, 3)));

                if (!mainHexagram) {
                    document.getElementById('error').textContent = '未找到匹配的本卦';
                    document.getElementById('error').style.display = 'block';
                    return;
                }

                document.getElementById('main-hexagram').innerHTML = `
                    <h4>本卦：${mainHexagram.name} (第 ${mainHexagram.hexagram_number} 卦)</h4>
                    <p>卦象：${mainHexagram.symbol}</p>
                    <p>卦辭：${mainHexagram.description}</p>
                    <p>五行：${mainHexagram.wuxing}</p>
                    <p>人：${mainHexagram.aspects.person}</p>
                    <p>事：${mainHexagram.aspects.event}</p>
                    <p>時：${mainHexagram.aspects.time}</p>
                    <p>地：${mainHexagram.aspects.place}</p>
                    <p>物：${mainHexagram.aspects.object}</p>
                `;

                if (changedHexagram && JSON.stringify(mainLines) !== JSON.stringify(changedLines)) {
                    document.getElementById('changed-hexagram').innerHTML = `
                        <h4>變卦：${changedHexagram.name} (第 ${changedHexagram.hexagram_number} 卦)</h4>
                        <p>卦象：${changedHexagram.symbol}</p>
                        <p>卦辭：${changedHexagram.description}</p>
                        <p>五行：${changedHexagram.wuxing}</p>
                        <p>人：${changedHexagram.aspects.person}</p>
                        <p>事：${changedHexagram.aspects.event}</p>
                        <p>時：${changedHexagram.aspects.time}</p>
                        <p>地：${changedHexagram.aspects.place}</p>
                        <p>物：${changedHexagram.aspects.object}</p>
                    `;
                    document.getElementById('changed-hexagram').style.display = 'block';
                } else {
                    document.getElementById('changed-hexagram').style.display = 'none';
                }

                const changingLinesText = lines.map((line, i) => {
                    if (line === 9 || line === 6) {
                        return `${lineNames[i]} (${line === 9 ? '老陽' : '老陰'})：${mainHexagram.lines[i].text} - ${mainHexagram.lines[i].meaning}`;
                    }
                    return '';
                }).filter(text => text).join('<br>');
                document.getElementById('changing-lines').innerHTML = `<h4>變爻（分數：${lines.filter(l => l === 9 || l === 6).length}）</h4>${changingLinesText || '無變爻'}`;

                const yaoAnalysis = lines.map((line, i) => {
                    const wuxing = yaoWuxing[mainHexagram.hexagram_number]?.[i] || '未知';
                    const strength = getWuxingStrength(wuxing, season);
                    let advice = '';
                    if (line === 9 || line === 6) {
                        if (strength.status === '旺' || strength.status === '相') {
                            advice = '動爻得令，影響力強，宜積極行動。';
                        } else if (strength.status === '囚' || strength.status === '死') {
                            advice = '動爻失令，影響力弱，宜謹慎行事。';
                        }
                    }
                    return `<p>${lineNames[i]}（${wuxing} - ${strength.status}）：${mainHexagram.lines[i].text} ${advice}</p>`;
                }).join('');
                document.getElementById('yao-analysis').innerHTML = `<h4>爻位分析</h4>${yaoAnalysis}`;

                const shiYing = getShiYing(mainHexagram);
                const shiWuxing = yaoWuxing[mainHexagram.hexagram_number]?.[shiYing.shi - 1] || '未知';
                const yingWuxing = yaoWuxing[mainHexagram.hexagram_number]?.[shiYing.ying - 1] || '未知';
                const shiStrength = getWuxingStrength(shiWuxing, season);
                const yingStrength = getWuxingStrength(yingWuxing, season);
                const shiYingRelation = wuxingRelations.生[shiWuxing] === yingWuxing ? '生' : wuxingRelations.剋[shiWuxing] === yingWuxing ? '剋' : '比和';
                document.getElementById('shi-ying').innerHTML = `
                    <h4>世應爻分析</h4>
                    <p>世爻（主方）：${lineNames[shiYing.shi - 1]}（${shiWuxing} - ${shiStrength.status}）</p>
                    <p>應爻（對方）：${lineNames[shiYing.ying - 1]}（${yingWuxing} - ${yingStrength.status}）</p>
                    <p>關係：世爻 ${shiYingRelation} 應爻</p>
                    <p>建議：${shiYingRelation === '生' ? '主方付出較多，宜謹慎' : shiYingRelation === '剋' ? '主方占優勢，宜積極' : '雙方平衡，宜合作'}</p>
                `;

                const wuxingStatus = getWuxingStrength(bodyHexagram.wuxing, season);
                let analysis = '';
                const relations = [
                    { from: upperTrigram, to: bodyHexagram, type: wuxingRelations.生[upperTrigram.wuxing] === bodyHexagram.wuxing ? '生' : wuxingRelations.剋[upperTrigram.wuxing] === bodyHexagram.wuxing ? '剋' : '比和' },
                    { from: lowerTrigram, to: bodyHexagram, type: wuxingRelations.生[lowerTrigram.wuxing] === bodyHexagram.wuxing ? '生' : wuxingRelations.剋[lowerTrigram.wuxing] === bodyHexagram.wuxing ? '剋' : '比和' },
                    { from: bodyHexagram, to: mutualUpper, type: wuxingRelations.生[bodyHexagram.wuxing] === mutualUpper.wuxing ? '生' : wuxingRelations.剋[bodyHexagram.wuxing] === mutualUpper.wuxing ? '剋' : '比和' },
                    { from: bodyHexagram, to: mutualLower, type: wuxingRelations.生[bodyHexagram.wuxing] === mutualLower.wuxing ? '生' : wuxingRelations.剋[bodyHexagram.wuxing] === mutualLower.wuxing ? '剋' : '比和' },
                    { from: bodyHexagram, to: changedUpper, type: wuxingRelations.生[bodyHexagram.wuxing] === changedUpper.wuxing ? '生' : wuxingRelations.剋[bodyHexagram.wuxing] === changedUpper.wuxing ? '剋' : '比和' },
                    { from: bodyHexagram, to: changedLower, type: wuxingRelations.生[bodyHexagram.wuxing] === changedLower.wuxing ? '生' : wuxingRelations.剋[bodyHexagram.wuxing] === changedLower.wuxing ? '剋' : '比和' }
                ];

                const wuxingAnalysis = relations.map(rel => {
                    const fromStrength = getWuxingStrength(rel.from.wuxing, season);
                    const toStrength = getWuxingStrength(rel.to.wuxing, season);
                    const explanation = wuxingExplanations.find(exp => exp.from === rel.from.wuxing && exp.to === rel.to.wuxing && exp.type === rel.type) || {};
                    return `
                        <p>${rel.from.name} (${rel.from.wuxing}, ${fromStrength.status}) ${rel.type} ${rel.to.name} (${rel.to.wuxing}, ${toStrength.status})</p>
                        <p>${explanation.description || '無具體解釋'}</p>
                        <p>愛情：${explanation.aspects?.love || '無'}</p>
                        <p>事業：${explanation.aspects?.career || '無'}</p>
                        <p>財運：${explanation.aspects?.wealth || '無'}</p>
                        <p>指引：${explanation.aspects?.guidance || '無'}</p>
                    `;
                }).join('<hr>');

                analysis += `<h4>五行分析（季節：${season}，體卦五行：${bodyHexagram.wuxing} - ${wuxingStatus.status}）</h4>${wuxingAnalysis}`;
                if (wuxingStatus.status === '旺' && relations.some(r => r.type === '生' && r.to === bodyHexagram)) {
                    analysis += '<p><strong>大吉</strong>：體卦旺且得生，事件順利，易得助力。</p>';
                } else if (wuxingStatus.status === '囚' && relations.some(r => r.type === '剋' && r.to === bodyHexagram)) {
                    analysis += '<p><strong>凶</strong>：體卦弱且受剋，需謹慎行事，尋求生體卦之人協助。</p>';
                } else if (wuxingStatus.status === '弱' && relations.some(r => r.type === '生' && r.to === bodyHexagram)) {
                    analysis += '<p><strong>漸吉</strong>：體卦雖弱但得生，情況將逐漸好轉。</p>';
                } else if (wuxingStatus.status === '旺' && relations.some(r => r.type === '生' && r.from === bodyHexagram)) {
                    analysis += '<p><strong>辛苦但可成</strong>：體卦旺但生用卦，需付出努力但有成果。</p>';
                }

                document.getElementById('wuxing-analysis').innerHTML = analysis;

                drawWuxingDiagram(
                    { upper: upperTrigram, lower: lowerTrigram },
                    { upper: mutualUpper, lower: mutualLower },
                    { upper: changedUpper, lower: changedLower },
                    bodyHexagram,
                    season,
                    (newBody) => {
                        bodyHexagram = newBody;
                        divine(method);
                    }
                );

                document.getElementById('result').style.display = 'block';
                document.getElementById('error').style.display = 'none';

                const result = {
                    method,
                    inputData,
                    lines,
                    mainHexagram,
                    changedHexagram,
                    mutualHexagram,
                    season,
                    wuxingAnalysis: analysis,
                    yaoAnalysis,
                    shiYing,
                    timestamp: new Date().toISOString()
                };
                saveResult(result);
            } catch (error) {
                document.getElementById('error').textContent = `錯誤：${error.message}`;
                document.getElementById('error').style.display = 'block';
                document.getElementById('result').style.display = 'none';
            }
        }

        function saveResult(result) {
            let history = JSON.parse(localStorage.getItem('divinationHistory') || '[]');
            history.push(result);
            localStorage.setItem('divinationHistory', JSON.stringify(history));
            updateHistory();
        }

        function exportResults() {
            const history = JSON.parse(localStorage.getItem('divinationHistory') || '[]');
            const blob = new Blob([JSON.stringify(history, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'divination_history.json';
            a.click();
            URL.revokeObjectURL(url);
        }

        function updateHistory() {
            const history = JSON.parse(localStorage.getItem('divinationHistory') || '[]');
            const historyList = document.getElementById('history-list');
            historyList.innerHTML = history.map((item, index) => `
                <div class="history-item">
                    <p>時間：${item.timestamp}</p>
                    <p>取卦方式：${item.method}</p>
                    <p>本卦：${item.mainHexagram.name}</p>
                    ${item.changedHexagram && JSON.stringify(item.mainHexagram.binary) !== JSON.stringify(item.changedHexagram.binary) ? `<p>變卦：${item.changedHexagram.name}</p>` : ''}
                    <p>五行分析：${item.wuxingAnalysis.replace(/<[^>]+>/g, '').substring(0, 100)}...</p>
                </div>
            `).join('');
        }

        document.addEventListener('DOMContentLoaded', () => {
            updateHistory();
            fetch('quotes.json').then(res => res.json()).then(quotes => {
                document.getElementById('quote').textContent = quotes[Math.floor(Math.random() * quotes.length)].text;
            });
        });
    </script>
</body>
</html>
