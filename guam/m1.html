
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>æ™ºæ…§åœå¦ç³»çµ±</title>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; max-width: 800px; margin: auto; }
    input, button { padding: 8px; margin: 5px; font-size: 16px; }
    #chart { width: 600px; height: 600px; background: #f9f9f9; margin-top: 20px; }
    .log { background: #eee; padding: 10px; margin-top: 10px; white-space: pre-wrap; }
  </style>
</head>
<body>
  <h2>ğŸŒ¿ æ™ºæ…§åœå¦ç³»çµ±</h2>

  <label>MQTT Broker URLï¼š</label>
  <input id="broker" value="wss://broker.hivemq.com:8000/mqtt" size="40">
  <button onclick="connectMQTT()">é€£ç·š</button><br>

  <label>è¼¸å…¥å¦è±¡ä»£ç¢¼ï¼ˆå¦‚ JUSTIN/Q1/2/3/1ï¼‰ï¼š</label>
  <input id="guaCode" size="40">
  <button onclick="sendGua()">é€å‡ºå¦è±¡</button>

  <div class="log" id="log"></div>
  <svg id="chart"></svg>

  <script>
    let client;

    const elements = {
      'ä¹¾': 'é‡‘', 'å¤': 'åœŸ', 'éœ‡': 'æœ¨', 'å·½': 'æœ¨',
      'å': 'æ°´', 'é›¢': 'ç«', 'è‰®': 'åœŸ', 'å…Œ': 'é‡‘'
    };

    const colors = {
      'æœ¨': '#4CAF50', 'ç«': '#F44336', 'åœŸ': '#FFEB3B',
      'é‡‘': '#9E9E9E', 'æ°´': '#2196F3'
    };

    const generate = { æœ¨: 'ç«', ç«: 'åœŸ', åœŸ: 'é‡‘', é‡‘: 'æ°´', æ°´: 'æœ¨' };
    const overcome = { æœ¨: 'åœŸ', åœŸ: 'æ°´', æ°´: 'ç«', ç«: 'é‡‘', é‡‘: 'æœ¨' };

    function connectMQTT() {
      const url = document.getElementById('broker').value;
      client = mqtt.connect(url);
      client.on('connect', () => log('âœ… å·²é€£ç·šè‡³ MQTT Broker'));
      client.on('message', (topic, message) => {
        log(ğŸ“© æ”¶åˆ°è¨Šæ¯ï¼š${topic} â†’ ${message});
        if (topic.includes('Q1')) {
          const parts = message.toString().split('/');
          const guaInfo = parseGua(parts);
          const analysis = analyzeGua(guaInfo);
          drawChart(analysis);
        }
      });
      client.subscribe('JUSTIN/Q1');
    }

    function sendGua() {
      const code = document.getElementById('guaCode').value;
      client.publish('JUSTIN/Q1', code);
      log(ğŸš€ ç™¼é€å¦è±¡ï¼š${code});

      // æ¨¡æ“¬æ¨å°äº’å¦èˆ‡è®Šå¦ï¼ˆç°¡åŒ–ï¼‰
      client.publish('JUSTIN/Q2', 'JUSTIN/Q2/1/5');
      client.publish('JUSTIN/Q3', 'JUSTIN/Q3/2/7');
    }

    function parseGua(parts) {
      // å‡è¨­æ ¼å¼ï¼šJUSTIN/Q1/ä¸Šå¦ä»£ç¢¼/ä¸‹å¦ä»£ç¢¼/å‹•çˆ»
      const upper = parseInt(parts[2]);
      const lower = parseInt(parts[3]);
      const yao = parseInt(parts[4]);

      const guaMap = ['ä¹¾','å…Œ','é›¢','éœ‡','å·½','å','è‰®','å¤'];
      return {
        upperGua: guaMap[upper - 1],
        lowerGua: guaMap[lower - 1],
        movingYao: yao
      };
    }

    function analyzeGua({ upperGua, lowerGua }) {
      const ti = elements[lowerGua];
      const yong = elements[upperGua];
      const hu = 'æœ¨'; // æ¨¡æ“¬äº’å¦äº”è¡Œ
      const bian = 'ç«'; // æ¨¡æ“¬è®Šå¦äº”è¡Œ

      return {
        ti, yong, hu, bian,
        relations: [
          { from: yong, to: ti },
          { from: hu, to: ti },
          { from: bian, to: ti }
        ]
      };
    }

    function drawChart({ ti, relations }) {
      const svg = document.getElementById('chart');
      svg.innerHTML = '';

      const pos = {
        æœ¨: [300, 100], ç«: [450, 250], åœŸ: [300, 400],
        é‡‘: [150, 250], æ°´: [300, 250]
      };

      for (let key in pos) {
        const [x, y] = pos[key];
        const circle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
        circle.setAttribute("cx", x);
        circle.setAttribute("cy", y);
        circle.setAttribute("r", 40);
        circle.setAttribute("fill", colors[key]);
        svg.appendChild(circle);

        const text = document.createElementNS("http://www.w3.org/2000/svg", "text");
        text.setAttribute("x", x);
        text.setAttribute("y", y);
        text.setAttribute("text-anchor", "middle");
        text.setAttribute("dominant-baseline", "middle");
        text.setAttribute("font-size", "20");
        text.textContent = key;
        svg.appendChild(text);
      }

      relations.forEach(rel => {
        const [x1, y1] = pos[rel.from];
        const [x2, y2] = pos[rel.to];
        const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
        line.setAttribute("x1", x1);
        line.setAttribute("y1", y1);
        line.setAttribute("x2", x2);
        line.setAttribute("y2", y2);

        const type = getRelationType(rel.from, rel.to, ti);
        line.setAttribute("stroke", type === 'ç”Ÿ' ? 'green' : type === 'å…‹' ? 'red' : 'gray');
        line.setAttribute("stroke-width", type === 'ç”Ÿ' ? 4 : type === 'å…‹' ? 2 : 3);
        svg.appendChild(line);
      });
    }

    function getRelationType(from, to, ti) {
      if (generate[from] === to) return 'ç”Ÿ';
      if (overcome[from] === to) return 'å…‹';
      if (from === to) return 'æ¯”å’Œ';
      return 'ç„¡';
    }

    function log(msg) {
      document.getElementById('log').textContent += msg + '\n';
    }
  </script>
</body>
</html>
