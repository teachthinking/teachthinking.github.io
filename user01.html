<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>西勢國小智慧回收箱</title>
  
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIINfQ7o4A9o1s9lE0p8CsaV1+UZn5+9e4L0=" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-2009230537020092305370200923053702009230537020092305370200923053702" crossorigin=""></script>
  
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

  <style>
    :root {
      --primary-color: #007bff;
      --secondary-color: #6c757d;
      --background-light: #f8f9fa;
      --text-dark: #343a40;
      --status-green: #4CAF50; /* 空箱 */
      --status-orange: #FF9800; /* 七分滿 */
      --status-red: #F44336;   /* 滿箱 */
      --status-purple: #9C27B0; /* 異常 */
    }
    
    body { font-family: 'Arial', 'Microsoft JhengHei', sans-serif; margin: 0; padding: 0; background-color: var(--background-light); color: var(--text-dark); }
    .header { background-color: var(--primary-color); color: white; padding: 15px; text-align: center; }
    .nav-bar { display: flex; justify-content: space-around; background-color: white; border-bottom: 1px solid #dee2e6; }
    .nav-btn { flex-grow: 1; padding: 15px 0; border: none; background: none; font-size: 16px; cursor: pointer; color: var(--secondary-color); transition: color 0.3s; border-bottom: 3px solid transparent; }
    .nav-btn.active { color: var(--primary-color); font-weight: bold; border-bottom: 3px solid var(--primary-color); }
    
    .content-container { padding: 20px; }
    #map { height: 70vh; width: 100%; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    
    .status-badge { display: inline-block; padding: 5px 10px; border-radius: 20px; color: white; font-weight: bold; font-size: 0.9em; }
    .status-0 { background-color: var(--status-green); }
    .status-1, .status-2 { background-color: var(--status-orange); }
    .status-3 { background-color: var(--status-red); }
    .status-4 { background-color: var(--status-purple); }
    
    .bin-list-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; margin-bottom: 10px; background-color: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    .bin-name { font-weight: bold; font-size: 1.1em; }
    .bin-address { font-size: 0.9em; color: var(--secondary-color); }
    
    .info-section h3 { color: var(--primary-color); border-left: 4px solid var(--primary-color); padding-left: 10px; }
    .info-section p, .info-section ul { line-height: 1.6; }
    .info-section img { max-width: 100%; height: auto; margin-top: 15px; border-radius: 8px; }
    
    /* 彈出視窗 */
    .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); }
    .modal-content { background-color: #fefefe; margin: 15% auto; padding: 20px; border-radius: 10px; width: 90%; max-width: 500px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); position: relative; }
    .close-btn { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
    .close-btn:hover { color: black; }
    
    .hidden { display: none; }
  </style>
</head>
<body>
  <div class="header">
    <h1>西勢國小智慧回收箱</h1>
  </div>

  <div class="nav-bar">
    <button class="nav-btn active" onclick="showSection('map-view')">地圖檢視</button>
    <button class="nav-btn" onclick="showSection('list-view')">列表檢視</button>
    <button class="nav-btn" onclick="showSection('recycle-guide')">回收指南</button>
    <button class="nav-btn" onclick="showSection('schedule')">回收車時間</button>
    <button class="nav-btn" onclick="showSection('my-points')">我的點數</button>
  </div>

  <div class="content-container">
    <div id="map-view">
      <div id="map"></div>
    </div>

    <div id="list-view" class="hidden">
      <div id="bin-list"></div>
    </div>
    
    <div id="recycle-guide" class="hidden info-section">
      <h3>可回收衣物種類</h3>
      <p>請將乾淨、完整的舊衣物投入回收箱，這些衣物將會被重新利用或回收製成其他產品。</p>
      <ul>
        <li>**可回收:** 外套、襯衫、褲子、裙子、毛衣、包包、帽子、鞋子。</li>
        <li>**不可回收:** 內衣褲、襪子、棉被、枕頭、地毯、窗簾、布娃娃、鞋類、毛絨玩具。</li>
      </ul>
      <p>請確保衣物已清洗乾淨並裝袋，以保持回收箱內的整潔。</p>
    </div>
    
    <div id="schedule" class="hidden info-section">
      <h3>彰化縣福興鄉回收車時間</h3>
      <p>以下為部分地點的回收車時間參考，請以當地環保局公告為準。</p>
      <ul>
        <li>**福興國中**：每週一、三、五，晚間 8:00 - 8:30</li>
        <li>**彰鹿路七段**：每週二、四，晚間 7:30 - 8:00</li>
        <li>**沿海路五段**：每週一、三，晚間 7:00 - 7:30</li>
      </ul>
      <p>您也可以前往福興鄉公所網站查詢更詳細的回收路線與時間表。</p>
    </div>
    
    <div id="my-points" class="hidden info-section">
      <h3>我的環保點數</h3>
      <p>點數系統正在開發中，未來您可透過回收衣物累積點數，並兌換環保商品或合作商家的優惠券。</p>
      <p>當點數系統正式上線時，您只需掃描回收箱上的 QR Code，即可輕鬆累積點數。</p>
    </div>
  </div>

  <div id="binDetailsModal" class="modal">
    <div class="modal-content">
      <span class="close-btn" onclick="closeModal('binDetailsModal')">&times;</span>
      <h3 id="modalBinTitle"></h3>
      <p><strong>地址：</strong><span id="modalBinAddress"></span></p>
      <p><strong>目前狀態：</strong><span id="modalBinStatus"></span></p>
    </div>
  </div>
  
  <script>
    // 回收箱的經緯度與名稱資料
    const boxLocations = [
      { id: 1, name: '沿海路四段 559 號（全家南環店旁）', lat: 24.0507, lng: 120.4195, status: 0 },
      { id: 2, name: '沿海路五段 363 號（全聯沿海店旁）', lat: 24.0495, lng: 120.4090, status: 1 },
      { id: 3, name: '彰鹿路七段 245 號（福興分駐所旁）', lat: 24.0565, lng: 120.4415, status: 0 },
      { id: 4, name: '彰鹿路七段 255 號（寶成旁）', lat: 24.0569, lng: 120.4423, status: 2 },
      { id: 5, name: '彰鹿路七段 16 號（締寶傢具旁）', lat: 24.0505, lng: 120.4342, status: 0 },
      { id: 6, name: '彰鹿路六段 506 號（嘉里大榮旁）', lat: 24.0458, lng: 120.4268, status: 3 },
      { id: 7, name: '彰鹿路六段 392 號（英發企業旁）', lat: 24.0475, lng: 120.4300, status: 0 },
      { id: 8, name: '番花路一段 853 號（外中派出所前）', lat: 24.0715, lng: 120.4158, status: 1 },
      { id: 9, name: '番花路二段 867 號（萊爾富福星店前）', lat: 24.0780, lng: 120.4085, status: 0 },
      { id: 10, name: '員鹿路一段 266 號（福安宮斜對面）', lat: 24.0585, lng: 120.4505, status: 4 },
      { id: 11, name: '員鹿路二段 88 號（全聯員鹿店旁）', lat: 24.0622, lng: 120.4550, status: 0 },
      { id: 12, name: '員鹿路二段 184 號（福興郵局對面）', lat: 24.0640, lng: 120.4580, status: 0 },
      { id: 13, name: '彰水路 22 號（快速道路旁）', lat: 24.0415, lng: 120.4225, status: 2 },
      { id: 14, name: '彰水路二段 1 號（福懋加油站南邊）', lat: 24.0375, lng: 120.4205, status: 0 },
      { id: 15, name: '南環路/福三路三段路口（7-11 福興旺福門市）', lat: 24.0525, lng: 120.4160, status: 1 }
    ];
    
    // 狀態對應的名稱和顏色
    const statusInfo = {
      0: { name: '空箱（可回收）', color: 'var(--status-green)' },
      1: { name: '三分滿', color: 'var(--status-orange)' },
      2: { name: '七分滿', color: 'var(--status-orange)' },
      3: { name: '已滿箱', color: 'var(--status-red)' },
      4: { name: '異常', color: 'var(--status-purple)' }
    };

    let map;
    const markers = {};
    let activeSection = 'map-view';
    
    // 初始化地圖
    function initMap() {
      map = L.map('map').setView([24.05, 120.43], 13); // 以彰化縣福興鄉為中心
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
      }).addTo(map);
      
      boxLocations.forEach(bin => {
        addMarker(bin);
      });
    }
    
    // 在地圖上新增標記點
    function addMarker(bin) {
      const status = bin.status;
      const binColor = statusInfo[status].color;
      
      const iconHtml = `<div style="background-color: ${binColor}; width: 30px; height: 30px; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 5px rgba(0,0,0,0.4);"></div>`;
      const customIcon = L.divIcon({ className: 'custom-div-icon', html: iconHtml });

      const marker = L.marker([bin.lat, bin.lng], { icon: customIcon }).addTo(map);
      
      marker.on('click', function() {
        showBinDetails(bin);
      });

      markers[bin.id] = marker;
    }
    
    // 顯示回收箱詳細資訊
    function showBinDetails(bin) {
      document.getElementById('modalBinTitle').textContent = `回收箱 ${bin.id}`;
      document.getElementById('modalBinAddress').textContent = bin.name;
      document.getElementById('modalBinStatus').textContent = statusInfo[bin.status].name;
      document.getElementById('modalBinStatus').style.color = statusInfo[bin.status].color;
      
      document.getElementById('binDetailsModal').style.display = 'block';
    }

    // 關閉彈出視窗
    function closeModal(modalId) {
      document.getElementById(modalId).style.display = 'none';
    }
    
    // 渲染列表檢視
    function renderBinList() {
      const listContainer = document.getElementById('bin-list');
      listContainer.innerHTML = '';
      boxLocations.forEach(bin => {
        const binItem = document.createElement('div');
        binItem.className = 'bin-list-item';
        binItem.innerHTML = `
          <div>
            <div class="bin-name">回收箱 ${bin.id}</div>
            <div class="bin-address">${bin.name}</div>
          </div>
          <div class="status-badge status-${bin.status}">${statusInfo[bin.status].name}</div>
        `;
        binItem.addEventListener('click', () => showBinDetails(bin));
        listContainer.appendChild(binItem);
      });
    }

    // 切換顯示區塊
    function showSection(sectionId) {
      document.querySelectorAll('.content-container > div').forEach(section => {
        section.classList.add('hidden');
      });
      document.getElementById(sectionId).classList.remove('hidden');

      document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      document.querySelector(`.nav-btn[onclick="showSection('${sectionId}')"]`).classList.add('active');
      
      // 如果切換回地圖，重新調整地圖大小
      if (sectionId === 'map-view' && map) {
        setTimeout(() => { map.invalidateSize(); }, 300);
      }
    }
    
    // MQTT 連線與數據更新
    let client;
    function connectMqtt() {
      const brokerUrl = "wss://broker.mqttgo.io:8084/mqtt";
      const clientId = `web-client-${Math.random().toString(16).substr(2, 8)}`;
      client = mqtt.connect(brokerUrl, { clientId: clientId });

      client.on("connect", () => {
        console.log("✅ 已連線到 MQTT Broker");
        boxLocations.forEach(bin => {
          client.subscribe(`SSSES/BOX${bin.id}/S`);
        });
      });
      
      client.on("message", (topic, message) => {
        const msg = message.toString();
        const parts = topic.split('/');
        const boxId = parseInt(parts[1].replace('BOX', ''));
        const newStatus = parseInt(msg);
        
        updateBinStatus(boxId, newStatus);
      });
    }
    
    function updateBinStatus(boxId, newStatus) {
      const binIndex = boxLocations.findIndex(bin => bin.id === boxId);
      if (binIndex > -1) {
        boxLocations[binIndex].status = newStatus;
        
        // 更新地圖標記
        if (markers[boxId]) {
          const newColor = statusInfo[newStatus].color;
          const newIconHtml = `<div style="background-color: ${newColor}; width: 30px; height: 30px; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 5px rgba(0,0,0,0.4);"></div>`;
          const newIcon = L.divIcon({ className: 'custom-div-icon', html: newIconHtml });
          markers[boxId].setIcon(newIcon);
        }
        
        // 更新列表
        if (!document.getElementById('list-view').classList.contains('hidden')) {
            renderBinList();
        }
      }
    }

    // 頁面載入時執行
    window.onload = function() {
      initMap();
      renderBinList();
      connectMqtt();
      
      // 確保在任何地方點擊彈出視窗以外的區域都能關閉視窗
      window.onclick = function(event) {
        if (event.target == document.getElementById('binDetailsModal')) {
          closeModal('binDetailsModal');
        }
      }
    };
  </script>
</body>
</html>
