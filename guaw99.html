<html lang="zh-TW">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>張老師易經(梅花心易)</title>
  <style>
    :root {
      --primary-color: #2c3e50;
      --secondary-color: #3498db;
      --background-color: #f4f7f9;
      --card-bg: #ffffff;
      --border-color: #e0e6ed;
      --text-color: #333333;
      --sub-text-color: #7f8c8d;
      --shadow-light: 0 4px 12px rgba(0, 0, 0, 0.05);
      --border-radius: 12px;
      --font-family: 'Noto Sans TC', sans-serif;
    }

    body {
      font-family: var(--font-family);
      background: var(--background-color);
      color: var(--text-color);
      padding: 20px;
      line-height: 1.6;
      margin: 0;
    }

    .container {
      max-width: 1000px;
      margin: 0 auto;
      background: var(--card-bg);
      padding: 25px;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow-light);
    }

    h1 {
      margin: 0 0 8px 0;
      font-size: 28px;
      color: var(--primary-color);
    }

    h2.subtitle {
      margin: 0 0 20px 0;
      color: var(--sub-text-color);
      font-weight: 400;
      font-size: 16px;
      border-bottom: 1px solid var(--border-color);
      padding-bottom: 15px;
    }

    .tab-buttons {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }

    .tab-button {
      padding: 10px 18px;
      border-radius: var(--border-radius);
      border: 1px solid var(--border-color);
      background: transparent;
      cursor: pointer;
      color: var(--sub-text-color);
      transition: all 0.3s ease;
      font-size: 15px;
    }

    .tab-button.active {
      background: var(--primary-color);
      color: #fff;
      border-color: var(--primary-color);
    }

    .tab-content {
      display: none;
      padding-top: 10px;
    }

    .tab-content.active {
      display: block;
    }

    .row {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
      margin: 12px 0;
    }

    .hint {
      font-size: 13px;
      color: var(--sub-text-color);
      line-height: 1.5;
    }

    .gua-box {
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius);
      padding: 20px;
      background: var(--background-color);
      margin-bottom: 20px;
    }

    .hidden {
      display: none;
    }

    button.primary {
      background: var(--primary-color);
      color: #fff;
      border: none;
      padding: 10px 20px;
      border-radius: var(--border-radius);
      cursor: pointer;
      transition: background 0.3s ease;
    }

    button.primary:hover {
      background: var(--secondary-color);
    }

    input, select {
      padding: 8px;
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius);
      font-size: 14px;
    }

    .gua-display-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin: 10px 0;
    }

    .gua-line {
      width: 60px;
      height: 10px;
      margin: 5px 0;
      background: var(--text-color);
      position: relative;
    }

    .gua-line.yin::after {
      content: '';
      position: absolute;
      width: 20px;
      height: 10px;
      background: var(--card-bg);
      left: 20px;
    }

    .gua-line.moving::before {
      content: '×';
      position: absolute;
      color: #e74c3c;
      font-size: 16px;
      left: -20px;
      top: -3px;
    }

    .gua-name {
      margin-top: 10px;
      font-weight: bold;
      font-size: 16px;
      color: var(--primary-color);
      text-align: center;
    }

    .wuxing-box {
      margin: 15px 0;
    }

    .wuxing-status {
      font-weight: bold;
    }

    .wuxing-status.大吉 { color: #2ecc71; }
    .wuxing-status.吉 { color: #27ae60; }
    .wuxing-status.平 { color: #3498db; }
    .wuxing-status.凶 { color: #e67e22; }
    .wuxing-status.大凶 { color: #e74c3c; }

    .wuxing-node {
      fill: #ecf0f1;
      stroke: var(--primary-color);
      stroke-width: 2;
    }

    .wuxing-node-text {
      text-anchor: middle;
      font-size: 12px;
      fill: var(--text-color);
    }

    .wuxing-edge-generate {
      stroke: #2ecc71;
      stroke-width: 2;
    }

    .wuxing-edge-overcome {
      stroke: #e74c3c;
      stroke-width: 2;
    }

    .wuxing-edge-harmony {
      stroke: #3498db;
      stroke-width: 2;
    }

    .wuxing-edge-label {
      font-size: 10px;
      fill: var(--text-color);
      text-anchor: middle;
    }

    canvas {
      max-width: 100%;
      margin: 10px 0;
    }

    .line-explanation {
      margin: 15px 0;
      padding: 10px;
      background: var(--background-color);
      border-radius: var(--border-radius);
    }

    .auspiciousness-index {
      font-size: 18px;
      font-weight: bold;
      margin: 15px 0;
      padding: 10px;
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius);
      text-align: center;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>張老師易經(梅花心易)</h1>
    <h2 id="subtitle" class="subtitle">請選擇取卦方式以開始占卜</h2>
    <div class="tab-buttons">
      <button class="tab-button active" data-target="number">數字取卦</button>
      <button class="tab-button" data-target="manual">手動取卦</button>
      <button class="tab-button" data-target="time">時間取卦</button>
      <button class="tab-button" data-target="image">以象取卦</button>
      <button class="tab-button" data-target="history">歷史記錄</button>
    </div>
    <div id="number" class="tab-content active">
      <div class="row">
        <label>上卦數字(100-999)：</label>
        <input id="numUpper" type="number" min="100" max="999" />
      </div>
      <div class="row">
        <label>下卦數字(100-999)：</label>
        <input id="numLower" type="number" min="100" max="999" />
      </div>
      <div class="row">
        <label>動爻數字(100-999)：</label>
        <input id="numMoving" type="number" min="100" max="999" />
      </div>
      <div class="row">
        <label>問題（可選）：</label>
        <input id="questionNumber" type="text" placeholder="請輸入您的問題" />
      </div>
      <button id="btnNumber" class="primary">數字取卦</button>
      <div class="hint">說明：輸入三組100-999的數字，分別用於計算上卦、下卦與動爻。數字會經由模數運算轉換為卦象。</div>
    </div>
    <div id="manual" class="tab-content">
      <div class="row">
        <label>上卦：</label>
        <select id="selUpper">
          <option value="">請選擇</option>
          <option value="1">乾</option>
          <option value="2">兌</option>
          <option value="3">離</option>
          <option value="4">震</option>
          <option value="5">巽</option>
          <option value="6">坎</option>
          <option value="7">艮</option>
          <option value="8">坤</option>
        </select>
      </div>
      <div class="row">
        <label>下卦：</label>
        <select id="selLower">
          <option value="">請選擇</option>
          <option value="1">乾</option>
          <option value="2">兌</option>
          <option value="3">離</option>
          <option value="4">震</option>
          <option value="5">巽</option>
          <option value="6">坎</option>
          <option value="7">艮</option>
          <option value="8">坤</option>
        </select>
      </div>
      <div class="row">
        <label>動爻（1-6，可多選以逗號分隔）：</label>
        <input id="inputMoving" type="text" placeholder="例如：1,3,5" />
      </div>
      <div class="row">
        <label>問題（可選）：</label>
        <input id="questionManual" type="text" placeholder="請輸入您的問題" />
      </div>
      <button id="btnManual" class="primary">手動取卦</button>
      <div class="hint">說明：直接選擇上卦與下卦，並指定動爻（若有）。動爻以逗號分隔輸入，例如“1,3,5”。</div>
    </div>
    <div id="time" class="tab-content">
      <div class="row">
        <label><input type="radio" name="time-method" value="modern" checked /> 現代時間</label>
        <label><input type="radio" name="time-method" value="traditional" /> 傳統時辰</label>
      </div>
      <div id="modern-time-inputs">
        <div class="row">
          <label>日期時間：</label>
          <input id="dtInput" type="datetime-local" />
          <button id="nowQuick" class="primary">現在</button>
        </div>
        <div class="row">
          <label>問題（可選）：</label>
          <input id="questionTime" type="text" placeholder="請輸入您的問題" />
        </div>
      </div>
      <div id="traditional-time-inputs" class="hidden">
        <div class="row">
          <label>日期：</label>
          <input id="dateInput" type="date" />
        </div>
        <div class="row">
          <label>時辰：</label>
          <select id="shichenInput">
            <option value="23">子時 (23:00-01:00)</option>
            <option value="1">丑時 (01:00-03:00)</option>
            <option value="3">寅時 (03:00-05:00)</option>
            <option value="5">卯時 (05:00-07:00)</option>
            <option value="7">辰時 (07:00-09:00)</option>
            <option value="9">巳時 (09:00-11:00)</option>
            <option value="11">午時 (11:00-13:00)</option>
            <option value="13">未時 (13:00-15:00)</option>
            <option value="15">申時 (15:00-17:00)</option>
            <option value="17">酉時 (17:00-19:00)</option>
            <option value="19">戌時 (19:00-21:00)</option>
            <option value="21">亥時 (21:00-23:00)</option>
          </select>
        </div>
        <div class="row">
          <label>分鐘（可選）：</label>
          <input id="minuteInput" type="number" min="0" max="59" />
        </div>
        <div class="row">
          <label>問題（可選）：</label>
          <input id="questionTime" type="text" placeholder="請輸入您的問題" />
        </div>
      </div>
      <button id="btnTime" class="primary">時間取卦</button>
      <div class="hint">說明：現代時間使用年月日時分計算卦象；傳統時辰使用日期與時辰（可選分鐘）。動爻由時間總和決定。</div>
    </div>
    <div id="image" class="tab-content">
      <div class="row">
        <label>上卦（物象）：</label>
        <select id="upperImageSelect">
          <option value="">請選擇</option>
          <option value="1">天、父、金屬</option>
          <option value="2">澤、少女、金屬</option>
          <option value="3">火、中女、電光</option>
          <option value="4">雷、長男、動態</option>
          <option value="5">風、長女、木</option>
          <option value="6">水、中男、液體</option>
          <option value="7">山、少男、石頭</option>
          <option value="8">地、母、土壤</option>
        </select>
      </div>
      <div class="row">
        <label>下卦（方位）：</label>
        <select id="lowerDirectionSelect">
          <option value="">請選擇</option>
          <option value="1">西北</option>
          <option value="2">西</option>
          <option value="3">南</option>
          <option value="4">東</option>
          <option value="5">東南</option>
          <option value="6">北</option>
          <option value="7">東北</option>
          <option value="8">中</option>
        </select>
      </div>
      <div class="row">
        <label><input id="imageUseMinute" type="checkbox" checked /> 使用當前分鐘作為動爻</label>
      </div>
      <div class="row">
        <label>動爻（1-6，若不勾選分鐘）：</label>
        <input id="imageMovingInput" type="number" min="1" max="6" />
      </div>
      <div class="row">
        <label>問題（可選）：</label>
        <input id="questionImage" type="text" placeholder="請輸入您的問題" />
      </div>
      <button id="btnImage" class="primary">以象取卦</button>
      <div class="hint">說明：根據物象選擇上卦，根據方位選擇下卦，動爻可由當前分鐘自動生成或手動輸入。</div>
    </div>
    <div id="history" class="tab-content">
      <div class="row">
        <button id="clearHistoryBtn" class="primary">清除記錄</button>
        <button id="exportHistoryBtn" class="primary">匯出記錄</button>
        <input type="file" id="importHistoryInput" accept=".json" style="padding: 10px;" />
        <button id="importHistoryBtn" class="primary">匯入記錄</button>
      </div>
      <div id="historyList"></div>
      <div class="hint">說明：顯示過去的占卜記錄，點擊可重新載入卦象進行分析。可匯出或匯入記錄（JSON格式）。</div>
    </div>
    <div id="result" class="gua-box hidden">
      <h3 id="resultTitle">占卜結果</h3>
      <div class="row">
        <div>
          <h4>本卦</h4>
          <div id="guaImage" class="gua-display-container"></div>
          <div id="guaName" class="gua-name">未知</div>
        </div>
        <div>
          <h4>互卦</h4>
          <div id="huGuaImage" class="gua-display-container"></div>
          <div id="huGuaName" class="gua-name">未知</div>
        </div>
        <div>
          <h4>變卦</h4>
          <div id="changeGuaImage" class="gua-display-container"></div>
          <div id="changeGuaName" class="gua-name">未知</div>
        </div>
      </div>
      <p id="guaNote"></p>
      <div id="lineExplanation" class="line-explanation"></div>
      <div class="row">
        <button id="judgeBtn" class="primary">五行與象徵</button>
      </div>
      <div id="judgeBox" class="gua-box hidden">
        <h3 id="judgeTitle">五行與象徵</h3>
        <div class="auspiciousness-index">
          <span id="auspiciousnessIndex">吉凶指數：未計算</span>
        </div>
        <div id="wuxingAnalysis">
          <svg id="wuxingSvg" width="500" height="300"></svg>
          <div class="wuxing-box">
            <h4>本卦五行分析</h4>
            <ul>
              <li><strong>本卦上卦（外在環境）：</strong> <span id="mainUpperWuxing"></span> → 體卦（<span id="tiGuaWuxing"></span>）：<span id="mainUpperRelation" class="wuxing-status"></span></li>
              <li><strong>本卦下卦（內在基礎）：</strong> <span id="mainLowerWuxing"></span> → 體卦（<span id="tiGuaWuxing2"></span>）：<span id="mainLowerRelation" class="wuxing-status"></span></li>
            </ul>
          </div>
          <div class="wuxing-box">
            <h4>互卦五行分析</h4>
            <ul>
              <li><strong>互卦上卦（潛在發展）：</strong> <span id="huUpperWuxing"></span> → 體卦（<span id="tiGuaWuxing3"></span>）：<span id="huUpperRelation" class="wuxing-status"></span></li>
              <li><strong>互卦下卦（內在潛力）：</strong> <span id="huLowerWuxing"></span> → 體卦（<span id="tiGuaWuxing4"></span>）：<span id="huLowerRelation" class="wuxing-status"></span></li>
            </ul>
          </div>
          <div class="wuxing-box">
            <h4>變卦五行分析</h4>
            <ul>
              <li><strong>變卦上卦（未來趨勢）：</strong> <span id="changeUpperWuxing"></span> → 體卦（<span id="tiGuaWuxing5"></span>）：<span id="changeUpperRelation" class="wuxing-status"></span></li>
              <li><strong>變卦下卦（變化基礎）：</strong> <span id="changeLowerWuxing"></span> → 體卦（<span id="tiGuaWuxing6"></span>）：<span id="changeLowerRelation" class="wuxing-status"></span></li>
            </ul>
          </div>
        </div>
        <div id="detailedAnalysis" class="hidden">
          <h4>象徵分析</h4>
          <canvas id="symbolismRadarChart" width="600" height="600"></canvas>
          <canvas id="overallBarChart" width="400" height="200"></canvas>
          <canvas id="movingLineBarChart" width="400" height="200"></canvas>
        </div>
      </div>
    </div>
  </div>
  <script>
    let hexagrams = {}, quotes = [], history = [], currentResult = null;

    const trigramName = {
      1: '乾', 2: '兌', 3: '離', 4: '震', 5: '巽', 6: '坎', 7: '艮', 8: '坤'
    };

    const guaTable = {
      1: [1, 1, 1, '金', '乾'], // 乾 (yang, yang, yang, Metal)
      2: [1, 1, 0, '金', '兌'], // 兌 (yang, yang, yin, Metal)
      3: [1, 0, 1, '火', '離'], // 離 (yang, yin, yang, Fire)
      4: [1, 0, 0, '木', '震'], // 震 (yin, yang, yang, Wood)
      5: [0, 1, 1, '木', '巽'], // 巽 (yin, yang, yin, Wood)
      6: [0, 1, 0, '水', '坎'], // 坎 (yin, yin, yang, Water)
      7: [0, 0, 1, '土', '艮'], // 艮 (yang, yin, yin, Earth)
      8: [0, 0, 0, '土', '坤']  // 坤 (yin, yin, yin, Earth)
    };

    const triIndexByLines = new Map(Object.entries({
      '[1,1,1]': 1, '[1,1,0]': 2, '[1,0,1]': 3, '[0,1,1]': 4,
      '[0,1,0]': 5, '[0,0,1]': 6, '[1,0,0]': 7, '[0,0,0]': 8
    }).map(([k, v]) => [k, parseInt(v)]));

    // Standard hexagram name mapping table, matching hexagrams.json keys
    const hexagramNameMap = new Map([
          ['[1,1,1,1,1,1]', '乾為天'], ['[0,1,1,1,1,1]', '天風姤'], ['[0,1,0,1,1,1]', '天水訟'], ['[0,0,1,1,1,1]', '天山遯'],
      ['[0,0,0,1,1,1]', '天地否'], ['[1,0,0,1,1,1]', '天雷無妄'], ['[0,1,1,0,1,1]', '天澤履'], ['[1,0,1,1,1,1]', '天火同人'],
      ['[1,1,0,1,1,0]', '兌為澤'], ['[0,1,0,1,1,0]', '澤雷隨'], ['[1,0,1,1,1,0]', '澤火革'], ['[0,0,1,1,1,0]', '澤山咸'],
      ['[0,0,0,1,1,0]', '澤地萃'], ['[1,0,0,1,1,0]', '澤雷隨'], ['[0,1,1,1,1,0]', '澤風大過'], ['[1,1,1,1,1,0]', '澤天夬'],
      ['[1,0,1,1,0,1]', '離為火'], ['[0,1,0,1,0,1]', '火水未濟'], ['[1,1,0,1,0,1]', '火風鼎'], ['[0,0,1,1,0,1]', '火山旅'],
      ['[0,0,0,1,0,1]', '火地晉'], ['[1,0,0,1,0,1]', '火雷噬嗑'], ['[0,1,1,1,0,1]', '火澤睽'], ['[1,1,1,1,0,1]', '火天大有'],
      ['[1,0,0,1,0,0]', '震為雷'], ['[0,1,0,1,0,0]', '雷水解'], ['[1,1,0,1,0,0]', '雷澤歸妹'], ['[0,0,1,1,0,0]', '雷山小過'],
      ['[0,0,0,1,0,0]', '雷地豫'], ['[1,0,1,1,0,0]', '雷火豐'], ['[0,1,1,1,0,0]', '雷風恆'], ['[1,1,1,1,0,0]', '雷天大壯'],
      ['[0,1,1,0,1,1]', '巽為風'], ['[0,1,0,0,1,1]', '風水渙'], ['[1,1,0,0,1,1]', '風澤中孚'], ['[0,0,1,0,1,1]', '風山漸'],
      ['[0,0,0,0,1,1]', '風地觀'], ['[1,0,0,0,1,1]', '風雷益'], ['[1,0,1,0,1,1]', '風火家人'], ['[0,1,1,0,1,1]', '風天小畜'],
      ['[0,1,0,0,1,0]', '坎為水'], ['[1,1,0,0,1,0]', '水澤節'], ['[0,0,1,0,1,0]', '水山蹇'], ['[0,0,0,0,1,0]', '水地比'],
      ['[1,0,0,0,1,0]', '水雷屯'], ['[1,0,1,0,1,0]', '水火既濟'], ['[0,1,1,0,1,0]', '水風井'], ['[1,1,1,0,1,0]', '水天需'],
      ['[0,0,1,0,0,1]', '艮為山'], ['[0,1,0,0,0,1]', '山水蒙'], ['[1,1,0,0,0,1]', '山澤損'], ['[1,0,1,0,0,1]', '山火賁'],
      ['[1,0,0,0,0,1]', '山雷頤'], ['[0,1,1,0,0,1]', '山風蠱'], ['[0,0,0,0,0,1]', '山地剝'], ['[1,1,1,0,0,1]', '山天大畜'],
      ['[0,0,0,0,0,0]', '坤為地'], ['[0,1,0,0,0,0]', '地水師'], ['[1,1,0,0,0,0]', '地澤臨'], ['[0,0,1,0,0,0]', '地山謙'],
      ['[1,0,0,0,0,0]', '地雷復'], ['[1,0,1,0,0,0]', '地火明夷'], ['[0,1,1,0,0,0]', '地風升'], ['[1,1,1,0,0,0]', '地天泰']
    ]);

    // Same-palace hexagram mapping
    const palaceMap = {
      '乾為天': ['乾為天', '天風姤', '天山遯', '天地否', '風地觀', '山地剝', '火地晉', '火天大有'],
      '坤為地': ['坤為地', '地水師', '地雷復', '地天泰', '雷天大壯', '澤天夬', '澤地萃', '澤水困'],
      '水雷屯': ['水雷屯', '水火既濟', '水天需', '水地比', '雷地豫', '澤地萃', '天水訟', '火水未濟'],
      '震為雷': ['震為雷', '雷風恆', '雷地豫', '雷天大壯', '水天需', '火天大有', '天山遯', '山天大畜'],
      '巽為風': ['巽為風', '風雷益', '風水渙', '風地觀', '水地比', '火地晉', '天水訟', '澤水困'],
      '艮為山': ['艮為山', '山雷頤', '山水蒙', '山風蠱', '風雷益', '水雷屯', '地雷復', '雷風恆'],
      '離為火': ['離為火', '火山旅', '火地晉', '火風鼎', '風火家人', '地火明夷', '水火既濟', '雷火豐'],
      '兌為澤': ['兌為澤', '澤雷隨', '澤風大過', '澤水困', '雷水解', '水山蹇', '地水師', '風水渙']
    };

    function normalizeKey(str) {
      return str ? str.replace(/[\s-]/g, '').toLowerCase() : '';
    }

    function getHexagramName(upperIdx, lowerIdx) {
      const upperLines = guaTable[upperIdx]?.slice(0, 3) || [0, 0, 0];
      const lowerLines = guaTable[lowerIdx]?.slice(0, 3) || [0, 0, 0];
      const lines = [...lowerLines, ...upperLines];
      return hexagramNameMap.get(JSON.stringify(lines)) || `${trigramName[upperIdx] || '未知'}${trigramName[lowerIdx] || '未知'}`;
    }

    function getSamePalaceHexagrams(hexName) {
      const normalized = normalizeKey(hexName);
      for (const [palace, hexagrams] of Object.entries(palaceMap)) {
        if (hexagrams.includes(hexName)) {
          return { palace, hexagrams };
        }
      }
      return { palace: '未知', hexagrams: [hexName] };
    }

    function getTrigramInfo(idx) {
      const [lines1, lines2, lines3, wuxing, name] = guaTable[idx] || [0, 0, 0, '未知', '未知'];
      return { name, wuxing, lines: [lines1, lines2, lines3], overall: 0 };
    }

    function getRelation(tiWuxing, yongWuxing) {
      if (!tiWuxing || !yongWuxing) return '未知';
      if (tiWuxing === yongWuxing) return '比和';
      const generate = { '木': '火', '火': '土', '土': '金', '金': '水', '水': '木' };
      const overcome = { '木': '土', '土': '水', '水': '火', '火': '金', '金': '木' };
      if (generate[yongWuxing] === tiWuxing) return '用生體';
      if (generate[tiWuxing] === yongWuxing) return '體生用';
      if (overcome[yongWuxing] === tiWuxing) return '用剋體';
      if (overcome[tiWuxing] === yongWuxing) return '體剋用';
      return '未知';
    }

    function getTiYong(result) {
      const moving = result.moving || [];
      const upperIdx = result.uIdx;
      const lowerIdx = result.lIdx;
      const tiGua = moving.length === 0 || moving.every(m => m > 3)
        ? getTrigramInfo(lowerIdx)
        : getTrigramInfo(upperIdx);
      const yongGua = moving.length === 0 || moving.every(m => m > 3)
        ? getTrigramInfo(upperIdx)
        : getTrigramInfo(lowerIdx);
      return { tiGua, yongGua };
    }

    function getLineEntryFor(hex, lineIdx) {
      return hex.lines?.find(line => line.index === lineIdx) || { text: '無爻辭', meaning: '無解釋', score: 0 };
    }

    async function loadResources() {
      try {
        const [hexResponse, quotesResponse] = await Promise.all([
          fetch('hexagrams.json').then(res => res.ok ? res.json() : Promise.reject(`hexagrams.json 載入失敗: ${res.status}`)),
          fetch('quotes.json').then(res => res.ok ? res.json() : Promise.reject(`quotes.json 載入失敗: ${res.status}`))
        ]);
        hexagrams = Object.fromEntries(
          Object.entries(hexResponse).map(([key, value]) => [normalizeKey(key), {
            name: value.name || key,
            judgment: value.judgment || { overall: 0, text: '無卦辭', meaning: '無解釋', people: 5, affairs: 5, time: 5, place: 5, object: 5 },
            symbolism: value.symbolism || { people: 5, affairs: 5, time: 5, place: 5, object: 5 },
            lines: value.lines || []
          }])
        );
        quotes = Array.isArray(quotesResponse) ? quotesResponse : [];
        const randomQuote = quotes[Math.floor(Math.random() * quotes.length)] || '請選擇取卦方式以開始占卜';
        const subtitle = document.getElementById('subtitle');
        if (subtitle) {
          subtitle.textContent = randomQuote;
        } else {
          console.warn('找不到 subtitle 元素');
        }
      } catch (error) {
        console.error('載入 JSON 檔案失敗:', error);
        alert('無法載入卦象資料或名言，請檢查檔案路徑或格式！');
        const subtitle = document.getElementById('subtitle');
        if (subtitle) {
          subtitle.textContent = '資料載入失敗，請檢查網路或檔案';
        }
      }
    }

    function saveHistory() {
      try {
        localStorage.setItem('guaHistory', JSON.stringify(history));
      } catch (error) {
        console.error('儲存歷史記錄失敗:', error);
      }
    }

    function loadHistory() {
      try {
        const stored = localStorage.getItem('guaHistory');
        history = stored ? JSON.parse(stored) : [];
        renderHistory();
      } catch (error) {
        console.error('載入歷史記錄失敗:', error);
      }
    }

    function exportHistory() {
      try {
        const dataStr = JSON.stringify(history, null, 2);
        const blob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = 'gua_history.json';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
      } catch (error) {
        console.error('匯出歷史記錄失敗:', error);
        alert('無法匯出歷史記錄，請稍後再試！');
      }
    }

    function importHistory(file) {
      try {
        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const imported = JSON.parse(e.target.result);
            if (!Array.isArray(imported)) {
              throw new Error('匯入檔案格式錯誤，必須為陣列');
            }
            // Validate each history entry
            const validEntries = imported.filter(item => 
              item.lines && Array.isArray(item.lines) && item.lines.length === 6 &&
              item.changeLines && Array.isArray(item.changeLines) && item.changeLines.length === 6 &&
              item.huLines && Array.isArray(item.huLines) && item.huLines.length === 6 &&
              item.moving && Array.isArray(item.moving) &&
              item.hexMain && item.hexChange && item.hexHu &&
              item.uIdx && item.lIdx && item.method && item.timestamp
            );
            history = [...history, ...validEntries];
            saveHistory();
            renderHistory();
            alert('歷史記錄匯入成功！');
          } catch (error) {
            console.error('解析匯入檔案失敗:', error);
            alert('匯入歷史記錄失敗，請檢查檔案格式！');
          }
        };
        reader.readAsText(file);
      } catch (error) {
        console.error('匯入歷史記錄失敗:', error);
        alert('無法匯入歷史記錄，請稍後再試！');
      }
    }

    function renderHistory() {
      const historyList = document.getElementById('historyList');
      if (!historyList) {
        console.error('找不到 historyList 元素');
        return;
      }
      historyList.innerHTML = history.length === 0 ? '<p>無歷史記錄</p>' : '';
      history.forEach((item, index) => {
        const div = document.createElement('div');
        div.className = 'history-item';
        div.innerHTML = `
          <p><strong>時間：</strong> ${item.timestamp}</p>
          <p><strong>本卦：</strong> ${item.hexMain?.name || '未知'}</p>
          <p><strong>問題：</strong> ${item.question || '無'}</p>
        `;
        div.addEventListener('click', () => {
          currentResult = item;
          generateGua(item.uIdx, item.lIdx, item.moving, item.method);
          renderWuxingAnalysis(item);
          renderDetailedAnalysis(item);
        });
        historyList.appendChild(div);
      });
    }

    function renderGuaImage(lines, elementId, moving = []) {
      const container = document.getElementById(elementId);
      if (!container) {
        console.error(`找不到 ${elementId} 元素`);
        return;
      }
      container.innerHTML = '';
      if (!lines || lines.length !== 6) {
        console.error(`無效的卦象線條數據: ${lines}`);
        container.innerHTML = '<p>無法顯示卦象</p>';
        return;
      }
      [...lines].reverse().forEach((line, idx) => {
        const lineDiv = document.createElement('div');
        lineDiv.className = `gua-line ${line === 0 ? 'yin' : ''} ${moving.includes(6 - idx) ? 'moving' : ''}`;
        container.appendChild(lineDiv);
      });
    }

    function renderLineExplanation(moving, hex) {
      const explanationDiv = document.getElementById('lineExplanation');
      if (!explanationDiv) {
        console.error('找不到 lineExplanation 元素');
        return;
      }
      explanationDiv.innerHTML = '';
      if (!hex || !hex.judgment) {
        console.warn('缺少卦象數據或 judgment 屬性');
        explanationDiv.innerHTML = '<p>無卦辭或爻辭數據</p>';
        return;
      }
      if (moving.length === 0) {
        explanationDiv.innerHTML = `
          <div class="line-explanation">
            <p><strong>卦辭：</strong> ${hex.judgment.text || '無卦辭'}</p>
            <p><strong>解釋：</strong> ${hex.judgment.meaning || '無解釋'}</p>
          </div>
        `;
        return;
      }
      moving.forEach(lineIdx => {
        const lineEntry = getLineEntryFor(hex, lineIdx);
        explanationDiv.innerHTML += `
          <div class="line-explanation">
            <p><strong>第 ${lineIdx} 爻：</strong> ${lineEntry.text || '無爻辭'}</p>
            <p><strong>解釋：</strong> ${lineEntry.meaning || '無解釋'}</p>
          </div>
        `;
      });
    }

    function generateGua(upperIdx, lowerIdx, moving, method = '未知') {
      if (!trigramName[upperIdx] || !trigramName[lowerIdx]) {
        console.error(`無效卦索引: 上卦=${upperIdx}, 下卦=${lowerIdx}`);
        alert('無效的卦象輸入，請檢查上卦或下卦！');
        return;
      }

      const upperLines = guaTable[upperIdx].slice(0, 3);
      const lowerLines = guaTable[lowerIdx].slice(0, 3);
      const lines = [...lowerLines, ...upperLines];

      const changeLines = [...lines];
      moving.forEach(idx => {
        if (idx >= 1 && idx <= 6) {
          changeLines[idx - 1] = changeLines[idx - 1] === 1 ? 0 : 1;
        }
      });

      const huLines = [lines[1], lines[2], lines[3], lines[2], lines[3], lines[4]];

      const mainHexName = getHexagramName(upperIdx, lowerIdx);
      const changeUpperIdx = triIndexByLines.get(JSON.stringify(changeLines.slice(3, 6))) || 8;
      const changeLowerIdx = triIndexByLines.get(JSON.stringify(changeLines.slice(0, 3))) || 8;
      const changeHexName = getHexagramName(changeUpperIdx, changeLowerIdx);
      const huUpperIdx = triIndexByLines.get(JSON.stringify(huLines.slice(3, 6))) || 8;
      const huLowerIdx = triIndexByLines.get(JSON.stringify(huLines.slice(0, 3))) || 8;
      const huHexName = getHexagramName(huUpperIdx, huLowerIdx);

      const mainHex = hexagrams[normalizeKey(mainHexName)] || { name: mainHexName, judgment: { overall: 0, text: '無卦辭', meaning: '無解釋', people: 5, affairs: 5, time: 5, place: 5, object: 5 }, symbolism: { people: 5, affairs: 5, time: 5, place: 5, object: 5 }, lines: [] };
      const changeHex = hexagrams[normalizeKey(changeHexName)] || { name: changeHexName, judgment: { overall: 0, text: '無卦辭', meaning: '無解釋', people: 5, affairs: 5, time: 5, place: 5, object: 5 }, symbolism: { people: 5, affairs: 5, time: 5, place: 5, object: 5 }, lines: [] };
      const huHex = hexagrams[normalizeKey(huHexName)] || { name: huHexName, judgment: { overall: 0, text: '無卦辭', meaning: '無解釋', people: 5, affairs: 5, time: 5, place: 5, object: 5 }, symbolism: { people: 5, affairs: 5, time: 5, place: 5, object: 5 }, lines: [] };

      if (!hexagrams[normalizeKey(mainHexName)]) console.warn(`本卦 ${mainHexName} 在 hexagrams.json 中未找到，使用標準名稱`);
      if (!hexagrams[normalizeKey(changeHexName)]) console.warn(`變卦 ${changeHexName} 在 hexagrams.json 中未找到，使用標準名稱`);
      if (!hexagrams[normalizeKey(huHexName)]) console.warn(`互卦 ${huHexName} 在 hexagrams.json 中未找到，使用標準名稱`);

      const mainPalace = getSamePalaceHexagrams(mainHexName);
      console.log(`本卦 ${mainHexName} 屬於 ${mainPalace.palace} 宮，同宮卦：${mainPalace.hexagrams.join(', ')}`);

      let question = '';
      const questionInputs = {
        '數字取卦': 'questionNumber',
        '手動取卦': 'questionManual',
        '現代時間取卦': 'questionTime',
        '傳統時辰取卦': 'questionTime',
        '以象取卦': 'questionImage'
      };
      const questionInputId = questionInputs[method];
      if (questionInputId) {
        const input = document.getElementById(questionInputId);
        question = input?.value.trim() || '';
      }

      currentResult = {
        lines,
        changeLines,
        huLines,
        moving,
        hexMain: mainHex,
        hexChange: changeHex,
        hexHu: huHex,
        uIdx: upperIdx,
        lIdx: lowerIdx,
        method,
        timestamp: new Date().toLocaleString('zh-TW'),
        question
      };

      history.push(currentResult);
      saveHistory();
      renderHistory();

      const resultDiv = document.getElementById('result');
      const guaName = document.getElementById('guaName');
      const changeGuaName = document.getElementById('changeGuaName');
      const huGuaName = document.getElementById('huGuaName');
      const guaNote = document.getElementById('guaNote');
      const resultTitle = document.getElementById('resultTitle');
      if (!resultDiv || !guaName || !changeGuaName || !huGuaName || !guaNote || !resultTitle) {
        console.error('缺少必要的顯示元素', { resultDiv, guaName, changeGuaName, huGuaName, guaNote, resultTitle });
        alert('無法顯示卦象，缺少必要的 DOM 元素！');
        return;
      }

      resultDiv.classList.remove('hidden');
      guaName.textContent = mainHex.name || mainHexName;
      changeGuaName.textContent = changeHex.name || changeHexName;
      huGuaName.textContent = huHex.name || huHexName;
      guaNote.textContent = `本卦：${trigramName[lowerIdx]}為下，${trigramName[upperIdx]}為上，動爻：${moving.join('、') || '無'}，取卦方式：${method}${question ? `，問：${question}` : ''}`;
      resultTitle.textContent = question || '占卜結果';

      renderGuaImage(lines, 'guaImage', moving);
      renderGuaImage(changeLines, 'changeGuaImage', moving);
      renderGuaImage(huLines, 'huGuaImage');
      renderLineExplanation(moving, mainHex);
    }

    function renderWuxingAnalysis(result) {
      const wuxingDiv = document.getElementById('wuxingAnalysis');
      const judgeBox = document.getElementById('judgeBox');
      const judgeTitle = document.getElementById('judgeTitle');
      if (!wuxingDiv || !judgeBox || !judgeTitle) {
        console.error('找不到 wuxingAnalysis 或 judgeBox 或 judgeTitle 元素');
        return;
      }

      const { tiGua } = getTiYong(result);
      const mainUpperGua = getTrigramInfo(result.uIdx);
      const mainLowerGua = getTrigramInfo(result.lIdx);
      const changeUpperIdx = triIndexByLines.get(JSON.stringify(result.changeLines.slice(3, 6))) || 8;
      const changeLowerIdx = triIndexByLines.get(JSON.stringify(result.changeLines.slice(0, 3))) || 8;
      const huUpperIdx = triIndexByLines.get(JSON.stringify(result.huLines.slice(3, 6))) || 8;
      const huLowerIdx = triIndexByLines.get(JSON.stringify(result.huLines.slice(0, 3))) || 8;
      const changeUpperGua = getTrigramInfo(changeUpperIdx);
      const changeLowerGua = getTrigramInfo(changeLowerIdx);
      const huUpperGua = getTrigramInfo(huUpperIdx);
      const huLowerGua = getTrigramInfo(huLowerIdx);

      judgeBox.classList.remove('hidden');
      judgeTitle.textContent = result.question || '五行與象徵';

      document.getElementById('mainUpperWuxing').textContent = `${mainUpperGua.name}（${mainUpperGua.wuxing}）`;
      document.getElementById('mainLowerWuxing').textContent = `${mainLowerGua.name}（${mainLowerGua.wuxing}）`;
      document.getElementById('huUpperWuxing').textContent = `${huUpperGua.name}（${huUpperGua.wuxing}）`;
      document.getElementById('huLowerWuxing').textContent = `${huLowerGua.name}（${huLowerGua.wuxing}）`;
      document.getElementById('changeUpperWuxing').textContent = `${changeUpperGua.name}（${changeUpperGua.wuxing}）`;
      document.getElementById('changeLowerWuxing').textContent = `${changeLowerGua.name}（${changeLowerGua.wuxing}）`;
      document.getElementById('tiGuaWuxing').textContent = tiGua.wuxing;
      document.getElementById('tiGuaWuxing2').textContent = tiGua.wuxing;
      document.getElementById('tiGuaWuxing3').textContent = tiGua.wuxing;
      document.getElementById('tiGuaWuxing4').textContent = tiGua.wuxing;
      document.getElementById('tiGuaWuxing5').textContent = tiGua.wuxing;
      document.getElementById('tiGuaWuxing6').textContent = tiGua.wuxing;
      document.getElementById('mainUpperRelation').textContent = getRelation(tiGua.wuxing, mainUpperGua.wuxing);
      document.getElementById('mainLowerRelation').textContent = getRelation(tiGua.wuxing, mainLowerGua.wuxing);
      document.getElementById('huUpperRelation').textContent = getRelation(tiGua.wuxing, huUpperGua.wuxing);
      document.getElementById('huLowerRelation').textContent = getRelation(tiGua.wuxing, huLowerGua.wuxing);
      document.getElementById('changeUpperRelation').textContent = getRelation(tiGua.wuxing, changeUpperGua.wuxing);
      document.getElementById('changeLowerRelation').textContent = getRelation(tiGua.wuxing, changeLowerGua.wuxing);

      document.querySelectorAll('.wuxing-status').forEach(el => {
        const status = el.textContent;
        el.className = `wuxing-status ${status === '用生體' ? '大吉' : status === '體剋用' ? '吉' : status === '比和' ? '平' : status === '體生用' ? '凶' : status === '用剋體' ? '大凶' : ''}`;
      });

      renderWuxingDiagram(tiGua, mainUpperGua, mainLowerGua, huUpperGua, huLowerGua, changeUpperGua, changeLowerGua);
    }

    function renderWuxingDiagram(tiGua, mainUpperGua, mainLowerGua, huUpperGua, huLowerGua, changeUpperGua, changeLowerGua) {
      const svg = document.getElementById('wuxingSvg');
      if (!svg) {
        console.error('找不到 wuxingSvg 元素');
        return;
      }

      svg.innerHTML = `
        <defs>
          <marker id="arrow-generate" viewBox="0 0 10 10" refX="5" refY="5" markerWidth="6" markerHeight="6" orient="auto">
            <path d="M 0 0 L 10 5 L 0 10 z" fill="#2ecc71" />
          </marker>
          <marker id="arrow-overcome" viewBox="0 0 10 10" refX="5" refY="5" markerWidth="6" markerHeight="6" orient="auto">
            <path d="M 0 0 L 10 5 L 0 10 z" fill="#e74c3c" />
          </marker>
          <marker id="arrow-harmony" viewBox="0 0 10 10" refX="5" refY="5" markerWidth="6" markerHeight="6" orient="auto">
            <path d="M 0 0 L 10 5 L 0 10 z" fill="#3498db" />
          </marker>
          <marker id="arrow-harmony-reverse" viewBox="0 0 10 10" refX="5" refY="5" markerWidth="6" markerHeight="6" orient="auto-start-reverse">
            <path d="M 0 0 L 10 5 L 0 10 z" fill="#3498db" />
          </marker>
        </defs>
      `;

      const nodes = [
        { id: 'ti', name: tiGua.name, wuxing: tiGua.wuxing, x: 200, y: 150, label: '體卦' },
        { id: 'mainUpper', name: mainUpperGua.name, wuxing: mainUpperGua.wuxing, x: 100, y: 50, label: '本卦上卦' },
        { id: 'mainLower', name: mainLowerGua.name, wuxing: mainLowerGua.wuxing, x: 100, y: 250, label: '本卦下卦' },
        { id: 'huUpper', name: huUpperGua.name, wuxing: huUpperGua.wuxing, x: 300, y: 50, label: '互卦上卦' },
        { id: 'huLower', name: huLowerGua.name, wuxing: huLowerGua.wuxing, x: 300, y: 250, label: '互卦下卦' },
        { id: 'changeUpper', name: changeUpperGua.name, wuxing: changeUpperGua.wuxing, x: 400, y: 50, label: '變卦上卦' },
        { id: 'changeLower', name: changeLowerGua.name, wuxing: changeLowerGua.wuxing, x: 400, y: 250, label: '變卦下卦' }
      ];

      const edges = [];
      nodes.forEach(node => {
        if (node.id !== 'ti') {
          const relation = getRelation(tiGua.wuxing, node.wuxing);
          let className, source, target, markers;
          if (relation === '用生體') {
            className = 'wuxing-edge-generate';
            source = node.id;
            target = 'ti';
            markers = { end: 'url(#arrow-generate)' };
          } else if (relation === '用剋體') {
            className = 'wuxing-edge-overcome';
            source = node.id;
            target = 'ti';
            markers = { end: 'url(#arrow-overcome)' };
          } else if (relation === '比和') {
            className = 'wuxing-edge-harmony';
            source = node.id;
            target = 'ti';
            markers = { start: 'url(#arrow-harmony-reverse)', end: 'url(#arrow-harmony)' };
          } else if (relation === '體生用') {
            className = 'wuxing-edge-generate';
            source = 'ti';
            target = node.id;
            markers = { end: 'url(#arrow-generate)' };
          } else if (relation === '體剋用') {
            className = 'wuxing-edge-overcome';
            source = 'ti';
            target = node.id;
            markers = { end: 'url(#arrow-overcome)' };
          } else {
            return;
          }
          edges.push({ source, target, className, label: relation, markers });
        }
      });

      nodes.forEach(node => {
        svg.innerHTML += `
          <circle class="wuxing-node" cx="${node.x}" cy="${node.y}" r="30" />
          <text class="wuxing-node-text" x="${node.x}" y="${node.y - 10}">${node.name} (${node.wuxing})</text>
          <text class="wuxing-node-text" x="${node.x}" y="${node.y + 15}">${node.label}</text>
        `;
      });

      edges.forEach(edge => {
        const sourceNode = nodes.find(n => n.id === edge.source);
        const targetNode = nodes.find(n => n.id === edge.target);
        if (!sourceNode || !targetNode) return;

        const dx = targetNode.x - sourceNode.x;
        const dy = targetNode.y - sourceNode.y;
        const length = Math.sqrt(dx * dx + dy * dy);
        const offset = 30;
        const sx = sourceNode.x + (dx / length) * offset;
        const sy = sourceNode.y + (dy / length) * offset;
        const tx = targetNode.x - (dx / length) * offset;
        const ty = targetNode.y - (dy / length) * offset;
        const midX = (sx + tx) / 2;
        const midY = (sy + ty) / 2;

        svg.innerHTML += `
          <line class="${edge.className}" x1="${sx}" y1="${sy}" x2="${tx}" y2="${ty}" marker-start="${edge.markers.start || ''}" marker-end="${edge.markers.end || ''}" />
          <text class="wuxing-edge-label" x="${midX}" y="${midY - 10}">${edge.label}</text>
        `;
      });
    }

    function renderDetailedAnalysis(result) {
      const detailedDiv = document.getElementById('detailedAnalysis');
      const radarCanvas = document.getElementById('symbolismRadarChart');
      const overallCanvas = document.getElementById('overallBarChart');
      const movingLineCanvas = document.getElementById('movingLineBarChart');
      const auspiciousnessIndex = document.getElementById('auspiciousnessIndex');
      if (!detailedDiv || !radarCanvas || !overallCanvas || !movingLineCanvas || !auspiciousnessIndex) {
        console.error('找不到詳細分析元素或畫布', { detailedDiv, radarCanvas, overallCanvas, movingLineCanvas, auspiciousnessIndex });
        detailedDiv.innerHTML = '<p>無法顯示圖表，缺少必要的畫布元素。</p>';
        return;
      }
      detailedDiv.classList.remove('hidden');

      const mainHex = result.hexMain || { judgment: { overall: 0, text: '無卦辭', people: 5, affairs: 5, time: 5, place: 5, object: 5 }, symbolism: { people: 5, affairs: 5, time: 5, place: 5, object: 5 }, lines: [] };
      const huHex = result.hexHu || { judgment: { overall: 0, text: '無卦辭', people: 5, affairs: 5, time: 5, place: 5, object: 5 }, symbolism: { people: 5, affairs: 5, time: 5, place: 5, object: 5 }, lines: [] };
      const changeHex = result.hexChange || { judgment: { overall: 0, text: '無卦辭', people: 5, affairs: 5, time: 5, place: 5, object: 5 }, symbolism: { people: 5, affairs: 5, time: 5, place: 5, object: 5 }, lines: [] };
      const mainUpperGua = getTrigramInfo(result.uIdx);
      const mainLowerGua = getTrigramInfo(result.lIdx);

      // Calculate auspiciousness index
      const movingScores = result.moving.length > 0 ? result.moving.map(idx => getLineEntryFor(mainHex, idx).score ?? 0) : [0];
      const movingScore = movingScores.length > 0 ? movingScores.reduce((sum, score) => sum + score, 0) / movingScores.length : 0;
      const mainScore = mainHex.judgment?.overall ?? 0;
      const huScore = huHex.judgment?.overall ?? 0;
      const changeScore = changeHex.judgment?.overall ?? 0;
      const auspiciousness = (5 * movingScore + 2 * mainScore + 1 * huScore + 2 * changeScore) / 10;
      const auspiciousnessLabel = auspiciousness >= 8 ? '大吉' : auspiciousness >= 6 ? '吉' : auspiciousness >= 4 ? '平' : auspiciousness >= 2 ? '凶' : '大凶';
      auspiciousnessIndex.innerHTML = `吉凶指數：${auspiciousness.toFixed(2)}（${auspiciousnessLabel}）`;
      auspiciousnessIndex.className = `auspiciousness-index ${auspiciousnessLabel}`;

      try {
        // Radar chart for people, affairs, time, place, object
        const radarData = {
          labels: ['人事', '事宜', '時機', '地點', '物品'],
          datasets: [
            {
              label: '本卦',
              data: [
                mainHex.judgment?.people ?? 5,
                mainHex.judgment?.affairs ?? 5,
                mainHex.judgment?.time ?? 5,
                mainHex.judgment?.place ?? 5,
                mainHex.judgment?.object ?? 5
              ],
              backgroundColor: 'rgba(46, 204, 113, 0.2)',
              borderColor: '#2ecc71',
              borderWidth: 2
            },
            {
              label: '互卦',
              data: [
                huHex.judgment?.people ?? 5,
                huHex.judgment?.affairs ?? 5,
                huHex.judgment?.time ?? 5,
                huHex.judgment?.place ?? 5,
                huHex.judgment?.object ?? 5
              ],
              backgroundColor: 'rgba(52, 152, 219, 0.2)',
              borderColor: '#3498db',
              borderWidth: 2
            },
            {
              label: '變卦',
              data: [
                changeHex.judgment?.people ?? 5,
                changeHex.judgment?.affairs ?? 5,
                changeHex.judgment?.time ?? 5,
                changeHex.judgment?.place ?? 5,
                changeHex.judgment?.object ?? 5
              ],
              backgroundColor: 'rgba(231, 76, 60, 0.2)',
              borderColor: '#e74c3c',
              borderWidth: 2
            }
          ]
        };

        new Chart(radarCanvas, {
          type: 'radar',
          data: radarData,
          options: {
            scales: {
              r: {
                min: 0,
                max: 10,
                ticks: { stepSize: 2 }
              }
            },
            plugins: {
              legend: { display: true },
              title: { display: true, text: '人事、事宜、時機、地點、物品分析' }
            }
          }
        });

        // Bar chart for overall scores with gradient
        const ctx = overallCanvas.getContext('2d');
        const scores = [
          mainHex.judgment?.overall ?? 0,
          huHex.judgment?.overall ?? 0,
          changeHex.judgment?.overall ?? 0,
          mainUpperGua.overall ?? 0,
          mainLowerGua.overall ?? 0
        ];
        const gradientBars = scores.map(score => {
          const gradient = ctx.createLinearGradient(0, 0, 0, 200);
          const ratio = score / 10;
          gradient.addColorStop(0, `rgba(231, 76, 60, ${1 - ratio})`); // Red for low score
          gradient.addColorStop(1, `rgba(46, 204, 113, ${ratio})`); // Green for high score
          return gradient;
        });

        const overallData = {
          labels: ['本卦', '互卦', '變卦', '本卦上卦', '本卦下卦'],
          datasets: [{
            label: '總體評分',
            data: scores,
            backgroundColor: gradientBars,
            borderWidth: 1
          }]
        };

        new Chart(overallCanvas, {
          type: 'bar',
          data: overallData,
          options: {
            scales: {
              y: {
                beginAtZero: true,
                max: 10,
                ticks: { stepSize: 2 }
              }
            },
            plugins: {
              legend: { display: false },
              title: { display: true, text: '各卦總體評分' }
            }
          }
        });

        // Bar chart for moving line scores
        const movingLineData = {
          labels: result.moving.length > 0 ? result.moving.map(idx => `第 ${idx} 爻`) : ['無動爻'],
          datasets: [{
            label: '動爻評分',
            data: result.moving.length > 0 ? result.moving.map(idx => getLineEntryFor(mainHex, idx).score ?? 0) : [0],
            backgroundColor: '#e74c3c'
          }]
        };

        new Chart(movingLineCanvas, {
          type: 'bar',
          data: movingLineData,
          options: {
            scales: {
              y: {
                beginAtZero: true,
                max: 10,
                ticks: { stepSize: 2 }
              }
            },
            plugins: {
              legend: { display: false },
              title: { display: true, text: '動爻評分' }
            }
          }
        });
      } catch (error) {
        console.error('渲染圖表失敗:', error);
        detailedDiv.innerHTML = '<p>無法渲染圖表，請檢查 Chart.js 載入或數據格式。</p>';
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      loadResources();
      loadHistory();

      document.querySelectorAll('.tab-button').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
          document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
          btn.classList.add('active');
          document.getElementById(btn.dataset.target).classList.add('active');
          const subtitle = document.getElementById('subtitle');
          if (subtitle) {
            subtitle.textContent = quotes[Math.floor(Math.random() * quotes.length)] || '請選擇取卦方式以開始占卜';
          }
        });
      });

      document.getElementById('btnNumber')?.addEventListener('click', () => {
        const upperNum = parseInt(document.getElementById('numUpper').value);
        const lowerNum = parseInt(document.getElementById('numLower').value);
        const movingNum = parseInt(document.getElementById('numMoving').value);
        if (isNaN(upperNum) || isNaN(lowerNum) || isNaN(movingNum) || upperNum < 100 || upperNum > 999 || lowerNum < 100 || lowerNum > 999 || movingNum < 100 || movingNum > 999) {
          alert('請輸入有效的三位數（100-999）！');
          return;
        }
        const upperIdx = ((upperNum % 8) || 8);
        const lowerIdx = ((lowerNum % 8) || 8);
        const moving = [((movingNum % 6) || 6)];
        generateGua(upperIdx, lowerIdx, moving, '數字取卦');
      });

      document.getElementById('btnManual')?.addEventListener('click', () => {
        const upperIdx = parseInt(document.getElementById('selUpper').value);
        const lowerIdx = parseInt(document.getElementById('selLower').value);
        const movingInput = document.getElementById('inputMoving').value.trim();
        if (!upperIdx || !lowerIdx) {
          alert('請選擇上卦與下卦！');
          return;
        }
        const moving = movingInput ? movingInput.split(',').map(Number).filter(n => n >= 1 && n <= 6) : [];
        if (movingInput && moving.length === 0) {
          alert('動爻輸入格式錯誤，請輸入1-6的數字，以逗號分隔！');
          return;
        }
        generateGua(upperIdx, lowerIdx, moving, '手動取卦');
      });

      document.getElementById('btnTime')?.addEventListener('click', () => {
        const method = document.querySelector('input[name="time-method"]:checked').value;
        let upperIdx, lowerIdx, moving;
        if (method === 'modern') {
          const dtInput = document.getElementById('dtInput').value;
          if (!dtInput) {
            alert('請選擇日期時間！');
            return;
          }
          const dt = new Date(dtInput);
          if (isNaN(dt.getTime())) {
            alert('無效的日期時間！');
            return;
          }
          const year = dt.getFullYear();
          const month = dt.getMonth() + 1;
          const day = dt.getDate();
          const hour = dt.getHours();
          const minute = dt.getMinutes();
          const total = year + month + day + hour + minute;
          upperIdx = ((month + day) % 8) || 8;
          lowerIdx = ((month + day + hour) % 8) || 8;
          moving = [((total % 6) || 6)];
        } else {
          const dateInput = document.getElementById('dateInput').value;
          const shichen = parseInt(document.getElementById('shichenInput').value);
          const minute = parseInt(document.getElementById('minuteInput').value) || 0;
          if (!dateInput || isNaN(shichen)) {
            alert('請選擇日期與時辰！');
            return;
          }
          const dt = new Date(dateInput);
          if (isNaN(dt.getTime())) {
            alert('無效的日期！');
            return;
          }
          const year = dt.getFullYear();
          const month = dt.getMonth() + 1;
          const day = dt.getDate();
          const total = year + month + day + shichen + minute;
          upperIdx = ((month + day) % 8) || 8;
          lowerIdx = ((month + day + shichen) % 8) || 8;
          moving = [((total % 6) || 6)];
        }
        generateGua(upperIdx, lowerIdx, moving, method === 'modern' ? '現代時間取卦' : '傳統時辰取卦');
      });

      document.getElementById('nowQuick')?.addEventListener('click', () => {
        const dtInput = document.getElementById('dtInput');
        if (dtInput) {
          dtInput.value = new Date().toISOString().slice(0, 16);
        }
      });

      document.getElementById('btnImage')?.addEventListener('click', () => {
        const upperIdx = parseInt(document.getElementById('upperImageSelect').value);
        const lowerIdx = parseInt(document.getElementById('lowerDirectionSelect').value);
        const useMinute = document.getElementById('imageUseMinute').checked;
        const movingInput = parseInt(document.getElementById('imageMovingInput').value);
        if (!upperIdx || !lowerIdx) {
          alert('請選擇物象與方位！');
          return;
        }
        let moving;
        if (useMinute) {
          const minute = new Date().getMinutes();
          moving = [((minute % 6) || 6)];
        } else {
          if (isNaN(movingInput) || movingInput < 1 || movingInput > 6) {
            alert('請輸入有效的動爻（1-6）！');
            return;
          }
          moving = [movingInput];
        }
        generateGua(upperIdx, lowerIdx, moving, '以象取卦');
      });

      document.querySelectorAll('input[name="time-method"]').forEach(radio => {
        radio.addEventListener('change', () => {
          const modernInputs = document.getElementById('modern-time-inputs');
          const traditionalInputs = document.getElementById('traditional-time-inputs');
          if (!modernInputs || !traditionalInputs) {
            console.error('找不到時間輸入元素');
            return;
          }
          if (radio.value === 'modern') {
            modernInputs.classList.remove('hidden');
            traditionalInputs.classList.add('hidden');
          } else {
            modernInputs.classList.add('hidden');
            traditionalInputs.classList.remove('hidden');
          }
        });
      });

      document.getElementById('judgeBtn')?.addEventListener('click', () => {
        if (currentResult) {
          renderWuxingAnalysis(currentResult);
          renderDetailedAnalysis(currentResult);
        } else {
          alert('請先進行占卜！');
        }
      });

      document.getElementById('clearHistoryBtn')?.addEventListener('click', () => {
        if (confirm('確定要清除所有歷史記錄嗎？')) {
          history = [];
          saveHistory();
          renderHistory();
        }
      });

      document.getElementById('exportHistoryBtn')?.addEventListener('click', () => {
        exportHistory();
      });

      document.getElementById('importHistoryBtn')?.addEventListener('click', () => {
        const input = document.getElementById('importHistoryInput');
        if (input.files.length === 0) {
          alert('請選擇要匯入的 JSON 檔案！');
          return;
        }
        importHistory(input.files[0]);
        input.value = ''; // Reset file input
      });
    });
  </script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</body>
</html>
