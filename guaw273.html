<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>張老師易經卜卦</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      background-color: #f5f5f5;
    }
    h1, h3, h4 {
      text-align: center;
      color: #333;
    }
    .section {
      margin: 20px 0;
      padding: 15px;
      background-color: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .gua-buttons button {
      margin: 5px;
      padding: 10px;
      font-size: 16px;
      cursor: pointer;
    }
    .gua-buttons button.selected {
      background-color: #4CAF50;
      color: white;
    }
    select, input, button {
      padding: 8px;
      margin: 5px;
      font-size: 16px;
    }
    #wuxing-result, #moving-line-result {
      margin-top: 20px;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
    }
    .tabs {
      display: flex;
      justify-content: center;
      margin-bottom: 10px;
    }
    .tab {
      padding: 10px 20px;
      cursor: pointer;
      background-color: #eee;
      margin: 0 5px;
      border-radius: 5px;
    }
    .tab.active {
      background-color: #4CAF50;
      color: white;
    }
    .error {
      color: red;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>張老師易經卜卦</h1>

  <div class="section">
    <div class="tabs">
      <div class="tab active" onclick="showSection('number-gua')">數字取卦</div>
      <div class="tab" onclick="showSection('manual-gua')">手動取卦</div>
      <div class="tab" onclick="showSection('time-gua')">時間取卦（梅花易）</div>
      <div class="tab" onclick="showSection('symbol-gua')">以象取卦</div>
    </div>

    <!-- 數字取卦 -->
    <div id="number-gua" class="section-content">
      <h3>數字取卦</h3>
      <input type="number" id="number-input" min="100" max="999" placeholder="輸入100-999">
      <button onclick="generateNumberGua()">生成卦象</button>
      <p>提示：輸入100–999。上/下卦 = 數字 % 8（0視為8），動爻 = 數字 % 6（0視為6）。頁面載入會隨機預設三個數字。</p>
    </div>

    <!-- 手動取卦 -->
    <div id="manual-gua" class="section-content" style="display: none;">
      <h3>手動取卦</h3>
      <div>
        <label>上卦（本卦）：</label>
        <div class="gua-buttons" id="upper-gua-buttons">
          <button onclick="selectGua('upper', '乾')">乾</button>
          <button onclick="selectGua('upper', '兌')">兌</button>
          <button onclick="selectGua('upper', '離')">離</button>
          <button onclick="selectGua('upper', '震')">震</button>
          <button onclick="selectGua('upper', '巽')">巽</button>
          <button onclick="selectGua('upper', '坎')">坎</button>
          <button onclick="selectGua('upper', '艮')">艮</button>
          <button onclick="selectGua('upper', '坤')">坤</button>
        </div>
      </div>
      <div>
        <label>下卦（變卦）：</label>
        <div class="gua-buttons" id="lower-gua-buttons">
          <button onclick="selectGua('lower', '乾')">乾</button>
          <button onclick="selectGua('lower', '兌')">兌</button>
          <button onclick="selectGua('lower', '離')">離</button>
          <button onclick="selectGua('lower', '震')">震</button>
          <button onclick="selectGua('lower', '巽')">巽</button>
          <button onclick="selectGua('lower', '坎')">坎</button>
          <button onclick="selectGua('lower', '艮')">艮</button>
          <button onclick="selectGua('lower', '坤')">坤</button>
        </div>
      </div>
      <button onclick="generateManualGua()">生成卦象</button>
    </div>

    <!-- 時間取卦 -->
    <div id="time-gua" class="section-content" style="display: none;">
      <h3>時間取卦（梅花易）</h3>
      <div>
        <input type="radio" name="time-method" value="modern" checked> 現代時間
        <input type="radio" name="time-method" value="traditional"> 傳統時辰
      </div>
      <div id="modern-time">
        <button onclick="useCurrentTime()">使用現在時間</button>
      </div>
      <div id="traditional-time" style="display: none;">
        <select id="time-select">
          <option value="23">子時 (23-1)</option>
          <option value="1">丑時 (1-3)</option>
          <option value="3">寅時 (3-5)</option>
          <option value="5">卯時 (5-7)</option>
          <option value="7">辰時 (7-9)</option>
          <option value="9">巳時 (9-11)</option>
          <option value="11">午時 (11-13)</option>
          <option value="13">未時 (13-15)</option>
          <option value="15">申時 (15-17)</option>
          <option value="17">酉時 (17-19)</option>
          <option value="19">戌時 (19-21)</option>
          <option value="21">亥時 (21-23)</option>
        </select>
      </div>
      <button onclick="generateTimeGua()">生成卦象</button>
      <p>算法：上卦 = (年+月+日) % 8；下卦 = (年+月+日+時) % 8；動爻 = (年+月+日+時+分) % 6；餘數為0則視為8或6。</p>
    </div>

    <!-- 以象取卦 -->
    <div id="symbol-gua" class="section-content" style="display: none;">
      <h3>以象取卦</h3>
      <div>
        <label>上卦（本卦）：</label>
        <select id="upper-symbol">
          <option value="乾">乾（金）—天、圓、馬、父</option>
          <option value="兌">兌（金）—澤、口、悅、羊</option>
          <option value="離">離（火）—日、電、目、中女</option>
          <option value="震">震（木）—雷、動、竹、長男</option>
          <option value="巽">巽（木）—風、入、雞、長女</option>
          <option value="坎">坎（水）—水、陷、耳、中男</option>
          <option value="艮">艮（土）—山、止、手、少男</option>
          <option value="坤">坤（土）—地、母、牛、腹</option>
        </select>
      </div>
      <div>
        <label>下卦（後天方位）：</label>
        <select id="lower-symbol">
          <option value="坎">北（坎）</option>
          <option value="離">南（離）</option>
          <option value="震">東（震）</option>
          <option value="兌">西（兌）</option>
          <option value="艮">東北（艮）</option>
          <option value="乾">西北（乾）</option>
          <option value="巽">東南（巽）</option>
          <option value="坤">西南（坤）</option>
        </select>
      </div>
      <div>
        <input type="checkbox" id="use-current-minute"> 用當前分鐘取動爻
      </div>
      <button onclick="generateSymbolGua()">生成卦象</button>
    </div>

    <!-- 卦象結果 -->
    <div class="section">
      <h3>卦象結果</h3>
      <div id="gua-result">
        <p><strong>本卦：</strong> <span id="body-gua">-</span></p>
        <p><strong>變卦：</strong> <span id="use-gua">-</span></p>
        <p><strong>動爻：</strong> <span id="moving-line">-</span></p>
        <p><strong>卦名：</strong> <span id="gua-name">-</span></p>
      </div>
      <div id="moving-line-result">
        <h4>動爻解釋</h4>
        <p id="moving-line-text">請生成卦象以顯示動爻解釋</p>
      </div>
      <div>
        <label>請選擇問事類別：</label>
        <select id="category-select">
          <option value="感情問題">1. 感情問題</option>
          <option value="工作/學業">2. 工作/學業</option>
          <option value="財運問題">3. 財運問題</option>
          <option value="健康問題">4. 健康問題</option>
          <option value="人際關係">5. 人際關係</option>
          <option value="生活/運勢">6. 生活/運勢</option>
          <option value="尋找指引">7. 尋找指引</option>
        </select>
        <button onclick="analyzeWuxing()">分析</button>
      </div>
      <div id="wuxing-result">
        <h3>梅花心易五行解卦</h3>
        <p>請生成卦象並選擇類別進行分析</p>
      </div>
    </div>
  </div>

  <script>
    // 載入JSON
    let explanations, hexagrams;
    Promise.all([
      fetch('wuxing_explanations.json').then(res => {
        if (!res.ok) throw new Error('無法載入 wuxing_explanations.json');
        return res.json();
      }),
      fetch('hexagrams.json').then(res => {
        if (!res.ok) throw new Error('無法載入 hexagrams.json');
        return res.json();
      })
    ]).then(([wuxingData, hexagramData]) => {
      explanations = wuxingData;
      hexagrams = hexagramData;
    }).catch(error => {
      console.error('載入JSON失敗:', error);
      document.getElementById('moving-line-text').innerHTML = `<p class="error">錯誤：${error.message}，請確保JSON檔案存在並正確</p>`;
      document.getElementById('wuxing-result').innerHTML = `<h3>梅花心易五行解卦</h3><p class="error">錯誤：${error.message}，請確保JSON檔案存在並正確</p>`;
    });

    // 卦到五行的映射
    const guaToWuxing = {
      "乾": "金", "兌": "金", "離": "火", "震": "木",
      "巽": "木", "坎": "水", "艮": "土", "坤": "土"
    };

    // 生規則：key被value生（value 生 key）
    const bornBy = {
      "金": "土", "水": "金", "木": "水", "火": "木", "土": "火"
    };

    // 克規則：key被value克（value 克 key）
    const clashBy = {
      "金": "火", "水": "土", "木": "金", "火": "水", "土": "木"
    };

    // 八宮映射（根據上卦/本卦）
    const guaToPalace = {
      "乾為天": "乾", "天澤履": "乾", "天火同人": "乾", "天雷無妄": "乾", "天風姤": "乾", "天水訟": "乾", "天山遁": "乾", "天地否": "乾",
      "坤為地": "坤", "地澤臨": "坤", "地火明夷": "坤", "地雷復": "坤", "地風升": "坤", "地水師": "坤", "地山謙": "坤", "地天泰": "坤",
      "艮為山": "艮", "山澤損": "艮", "山火賁": "艮", "山雷頤": "艮", "山風蠱": "艮", "山水蒙": "艮", "山天大畜": "艮", "山地剝": "艮",
      "兌為澤": "兌", "澤火革": "兌", "澤雷隨": "兌", "澤風大過": "兌", "澤水困": "兌", "澤山咸": "兌", "澤天夬": "兌", "澤地萃": "兌",
      "坎為水": "坎", "水澤節": "坎", "水火既濟": "坎", "水雷屯": "坎", "水風井": "坎", "水天需": "坎", "水山蹇": "坎", "水地比": "坎",
      "離為火": "離", "火澤睽": "離", "火雷噬嗑": "離", "火風鼎": "離", "火水未濟": "離", "火山旅": "離", "火天大有": "離", "火地晉": "離",
      "震為雷": "震", "雷澤歸妹": "震", "雷火豐": "震", "雷風恆": "震", "雷水解": "震", "雷山小過": "震", "雷天大壯": "震", "雷地豫": "震",
      "巽為風": "巽", "風澤中孚": "巽", "風火家人": "巽", "風雷益": "巽", "風水渙": "巽", "風山漸": "巽", "風天小畜": "巽", "風地觀": "巽"
    };

    // 檢查是否同宮
    function isSamePalace(bodyGua, useGua) {
      const guaKey = bodyGua + useGua;
      const guaName = guaNameMap[guaKey] || "未知卦名";
      const bodyPalace = guaToPalace[guaName];
      const usePalace = guaToPalace[useGua + bodyGua] || guaToWuxing[useGua];
      return bodyPalace === usePalace;
    }

    // 八純卦到64卦名稱的映射（完整8×8）
    const guaNameMap = {
      "乾乾": "乾為天", "乾兌": "天澤履", "乾離": "天火同人", "乾震": "天雷無妄", "乾巽": "天風姤", "乾坎": "天水訟", "乾艮": "天山遁", "乾坤": "天地否",
      "兌乾": "澤天夬", "兌兌": "兌為澤", "兌離": "澤火革", "兌震": "澤雷隨", "兌巽": "澤風大過", "兌坎": "澤水困", "兌艮": "澤山咸", "兌坤": "澤地萃",
      "離乾": "火天大有", "離兌": "火澤睽", "離離": "離為火", "離震": "火雷噬嗑", "離巽": "火風鼎", "離坎": "火水未濟", "離艮": "火山旅", "離坤": "火地晉",
      "震乾": "雷天大壯", "震兌": "雷澤歸妹", "震離": "雷火豐", "震震": "震為雷", "震巽": "雷風恆", "震坎": "雷水解", "震艮": "雷山小過", "震坤": "雷地豫",
      "巽乾": "風天小畜", "巽兌": "風澤中孚", "巽離": "風火家人", "巽震": "風雷益", "巽巽": "巽為風", "巽坎": "風水渙", "巽艮": "風山漸", "巽坤": "風地觀",
      "坎乾": "水天需", "坎兌": "水澤節", "坎離": "水火既濟", "坎震": "水雷屯", "坎巽": "水風井", "坎坎": "坎為水", "坎艮": "山水蒙", "坎坤": "水地比",
      "艮乾": "山天大畜", "艮兌": "山澤損", "艮離": "山火賁", "艮震": "山雷頤", "艮巽": "山風蠱", "艮坎": "山水蒙", "艮艮": "艮為山", "艮坤": "山地剝",
      "坤乾": "地天泰", "坤兌": "地澤臨", "坤離": "地火明夷", "坤震": "地雷復", "坤巽": "地風升", "坤坎": "地水師", "坤艮": "地山謙", "坤坤": "坤為地"
    };

    // 五行解卦函數
    function getWuxingExplanation(bodyGua, useGua, category) {
      if (!explanations) return { overall: "無五行資料", title: "", description: "請確保 wuxing_explanations.json 正確載入", categoryText: "", guidance: "" };
      const bodyWuxing = guaToWuxing[bodyGua];
      const useWuxing = guaToWuxing[useGua];
      let relation, subkey;

      if (bodyGua === useGua) {
        relation = "比和";
        subkey = bodyGua + "卦比和";
      } else if (isSamePalace(bodyGua, useGua)) {
        relation = "體用同宮";
        subkey = bodyGua + "卦同宮";
      } else if (useWuxing === bornBy[bodyWuxing]) {
        relation = "用生體";
        subkey = useGua + "卦生體";
      } else if (bodyWuxing === bornBy[useWuxing]) {
        relation = "體生用";
        subkey = bodyGua + "卦生用";
      } else if (useWuxing === clashBy[bodyWuxing]) {
        relation = "用克體";
        subkey = useGua + "卦克體";
      } else if (bodyWuxing === clashBy[useWuxing]) {
        relation = "體克用";
        subkey = bodyGua + "卦克體";
      } else {
        relation = "比和";
        subkey = bodyGua + "卦比和";
      }

      const overall = explanations[relation]?.overall || "無對應解釋";
      const detail = explanations[relation]?.details[subkey] || {};
      const title = detail.title || "";
      const description = detail.description || "";
      let categoryText = "";
      if (category === "感情問題") {
        categoryText = detail.love || description;
      } else if (category === "工作/學業") {
        categoryText = detail.career || description;
      } else if (category === "財運問題") {
        categoryText = detail.wealth || description;
      } else if (category === "尋找指引") {
        categoryText = detail.guidance || description;
      } else {
        categoryText = `${description} （綜合：${overall}）`;
      }
      const guidance = detail.guidance || "";

      return { overall, title, description, categoryText, guidance };
    }

    // 動爻解釋函數
    function getMovingLineExplanation(guaName, movingLine, category) {
      if (!hexagrams) return `<p class="error">錯誤：請確保 hexagrams.json 正確載入</p>`;
      const gua = hexagrams[guaName];
      if (!gua || !gua.lines) return `<p class="error">無動爻解釋資料（卦名：${guaName}）</p>`;
      const line = gua.lines.find(l => l.index === parseInt(movingLine));
      if (!line) return `<p class="error">無對應動爻解釋（爻序：${movingLine}）</p>`;

      const categoryMap = {
        "感情問題": "people",
        "工作/學業": "affairs",
        "財運問題": "object",
        "健康問題": "time",
        "人際關係": "people",
        "生活/運勢": "overall",
        "尋找指引": "overall"
      };
      const symbolField = categoryMap[category] || "overall";
      return `
        <p><strong>爻辭：</strong> ${line.text}</p>
        <p><strong>解釋：</strong> ${line.meaning}</p>
        <p><strong>分數：</strong> ${line.score}</p>
        <p><strong>${category}：</strong> ${line.symbolism[symbolField]}</p>
      `;
    }

    // 切換分頁
    function showSection(sectionId) {
      document.querySelectorAll('.section-content').forEach(section => {
        section.style.display = 'none';
      });
      document.getElementById(sectionId).style.display = 'block';
      document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
      });
      document.querySelector(`.tab[onclick="showSection('${sectionId}')"]`).classList.add('active');
      if (sectionId === 'time-gua') {
        document.querySelector('input[name="time-method"]').addEventListener('change', (e) => {
          document.getElementById('modern-time').style.display = e.target.value === 'modern' ? 'block' : 'none';
          document.getElementById('traditional-time').style.display = e.target.value === 'traditional' ? 'block' : 'none';
        });
      }
    }

    // 手動取卦選擇
    let selectedUpperGua = null;
    let selectedLowerGua = null;
    function selectGua(type, gua) {
      const buttons = document.getElementById(type === 'upper' ? 'upper-gua-buttons' : 'lower-gua-buttons').children;
      for (let btn of buttons) {
        btn.classList.remove('selected');
      }
      document.querySelector(`#${type}-gua-buttons button[onclick="selectGua('${type}', '${gua}')"]`).classList.add('selected');
      if (type === 'upper') selectedUpperGua = gua;
      else selectedLowerGua = gua;
    }

    // 數字取卦
    function generateNumberGua() {
      if (!hexagrams || !explanations) {
        alert('JSON檔案尚未載入，請稍後重試');
        return;
      }
      const number = parseInt(document.getElementById('number-input').value);
      if (number < 100 || number > 999) {
        alert('請輸入100-999的數字');
        return;
      }
      const guaList = ["乾", "兌", "離", "震", "巽", "坎", "艮", "坤"];
      const upperGuaIdx = number % 8 === 0 ? 8 : number % 8;
      const lowerGuaIdx = number % 8 === 0 ? 8 : number % 8;
      const movingLine = number % 6 === 0 ? 6 : number % 6;
      displayResult(guaList[upperGuaIdx - 1], guaList[lowerGuaIdx - 1], movingLine);
    }

    // 手動取卦
    function generateManualGua() {
      if (!hexagrams || !explanations) {
        alert('JSON檔案尚未載入，請稍後重試');
        return;
      }
      if (!selectedUpperGua || !selectedLowerGua) {
        alert('請選擇上卦和下卦');
        return;
      }
      const movingLine = Math.floor(Math.random() * 6) + 1;
      displayResult(selectedUpperGua, selectedLowerGua, movingLine);
    }

    // 時間取卦
    function useCurrentTime() {
      const now = new Date();
      document.getElementById('time-select').value = Math.floor(now.getHours() / 2) * 2 + 1;
    }

    function generateTimeGua() {
      if (!hexagrams || !explanations) {
        alert('JSON檔案尚未載入，請稍後重試');
        return;
      }
      const method = document.querySelector('input[name="time-method"]:checked').value;
      let year, month, day, hour, minute;
      if (method === 'modern') {
        const now = new Date();
        year = now.getFullYear();
        month = now.getMonth() + 1;
        day = now.getDate();
        hour = now.getHours();
        minute = now.getMinutes();
      } else {
        year = 2025;
        month = 8;
        day = 22;
        hour = parseInt(document.getElementById('time-select').value);
        minute = Math.floor(Math.random() * 60);
      }
      const guaList = ["乾", "兌", "離", "震", "巽", "坎", "艮", "坤"];
      const upperGuaIdx = (year + month + day) % 8 === 0 ? 8 : (year + month + day) % 8;
      const lowerGuaIdx = (year + month + day + hour) % 8 === 0 ? 8 : (year + month + day + hour) % 8;
      const movingLine = (year + month + day + hour + minute) % 6 === 0 ? 6 : (year + month + day + hour + minute) % 6;
      displayResult(guaList[upperGuaIdx - 1], guaList[lowerGuaIdx - 1], movingLine);
    }

    // 以象取卦
    function generateSymbolGua() {
      if (!hexagrams || !explanations) {
        alert('JSON檔案尚未載入，請稍後重試');
        return;
      }
      const upperGua = document.getElementById('upper-symbol').value;
      const lowerGua = document.getElementById('lower-symbol').value;
      const useMinute = document.getElementById('use-current-minute').checked;
      const movingLine = useMinute ? (new Date().getMinutes() % 6 === 0 ? 6 : new Date().getMinutes() % 6) : Math.floor(Math.random() * 6) + 1;
      displayResult(upperGua, lowerGua, movingLine);
    }

    // 顯示卦象結果
    function displayResult(bodyGua, useGua, movingLine) {
      document.getElementById('body-gua').textContent = bodyGua;
      document.getElementById('use-gua').textContent = useGua;
      document.getElementById('moving-line').textContent = movingLine;
      const guaKey = bodyGua + useGua;
      const guaName = guaNameMap[guaKey] || "未知卦名";
      document.getElementById('gua-name').textContent = guaName;
      const category = document.getElementById('category-select').value;
      const movingLineText = getMovingLineExplanation(guaName, movingLine, category);
      document.getElementById('moving-line-text').innerHTML = movingLineText;
    }

    // 五行分析
    function analyzeWuxing() {
      const bodyGua = document.getElementById('body-gua').textContent;
      const useGua = document.getElementById('use-gua').textContent;
      const category = document.getElementById('category-select').value;
      if (bodyGua === '-' || useGua === '-') {
        alert('請先生成卦象');
        return;
      }
      const result = getWuxingExplanation(bodyGua, useGua, category);
      document.getElementById('wuxing-result').innerHTML = `
        <h3>梅花心易五行解卦</h3>
        <p><strong>整體運勢：</strong> ${result.overall}</p>
        <p><strong>卦象標題：</strong> ${result.title}</p>
        <p><strong>詳細解釋：</strong> ${result.description}</p>
        <p><strong>${category}：</strong> ${result.categoryText}</p>
        <p><strong>行動指引：</strong> ${result.guidance}</p>
      `;
    }

    // 初始化：隨機數字
    document.getElementById('number-input').value = Math.floor(Math.random() * 900) + 100;
  </script>
</body>
</html>
