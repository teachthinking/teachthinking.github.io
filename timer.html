<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>線上計時器</title>
<style>
  :root{
    --bg: #0b1220; --panel:#0f172a; --panel-2:#111827;
    --text:#e5e7eb; --muted:#94a3b8; --border:#1f2937;
    --accent:#22d3ee; --accent-2:#60a5fa; --danger:#ef4444; --good:#10b981;
    --shadow: 0 18px 60px #0006;
  }
  :root[data-theme="light"]{
    --bg:#f6f7fb; --panel:#ffffff; --panel-2:#f1f5f9;
    --text:#0b1220; --muted:#475569; --border:#e2e8f0;
    --accent:#0284c7; --accent-2:#60a5fa; --shadow:0 12px 30px #0001;
  }
  *{ box-sizing: border-box }
  html,body{ height:100% }
  body{
    margin:0; background:
      radial-gradient(1000px 680px at 80% -10%, #1e293b33 0%, transparent 60%),
      radial-gradient(900px 700px at -10% 10%, #082f4922 0%, transparent 60%),
      var(--bg);
    color:var(--text); font-family: ui-sans-serif, system-ui, -apple-system,
      "Noto Sans TC","Segoe UI",Roboto,Helvetica,Arial,"Apple Color Emoji";
    min-height:100svh; display:flex; align-items:center; justify-content:center; padding:18px;
  }
  .app{ width:min(700px,100%); display:grid; gap:16px }
  .card{ background:var(--panel); border:1px solid var(--border); border-radius:18px; box-shadow:var(--shadow); overflow:hidden }
  header{ display:flex; gap:14px; align-items:center; justify-content:space-between; padding:16px 18px; flex-wrap:wrap; }
  .title-wrap{ display:flex; gap:12px; align-items:center }
  .title{
    font-size: clamp(20px, 3.8vw, 28px); font-weight:800; letter-spacing:.3px; display:flex; gap:10px; align-items:center
  }
  .subtitle{
    font-size: clamp(16px, 2.8vw, 22px);
    color:var(--muted); font-weight:700;
  }
  .right-controls{ display:flex; gap:10px; align-items:center; flex-wrap:wrap }
  input[type="text"], input[type="datetime-local"], input[type="number"]{
    background:var(--panel-2); border:1px solid var(--border); color:var(--text);
    padding:10px 12px; border-radius:12px; outline:none;
  }
  .btn{
    appearance:none; background:var(--panel-2); color:var(--text);
    border:1px solid var(--border); padding:10px 14px; border-radius:12px; cursor:pointer; font-weight:700;
  }
  .btn.primary{ color:#001018; background:linear-gradient(90deg, var(--accent), var(--accent-2)); border-color:transparent }
  .btn.ghost{ color:var(--muted); background:transparent }
  .btn.danger{ background:#1b0a0a; color:#fecaca; border-color:#7f1d1d }
  .btn.good{ background:#062016; color:#bbf7d0; border-color:#14532d }

  .tabs{ display:flex; gap:8px; padding:0 18px 12px 18px; border-bottom:1px solid var(--border); flex-wrap:wrap }
  .tab{ appearance:none; background:var(--panel-2); color:var(--muted); border:1px solid var(--border); padding:10px 14px; border-radius:12px; cursor:pointer; font-weight:800 }
  .tab[aria-selected="true"]{ color:#001018; background:linear-gradient(90deg, var(--accent), var(--accent-2)); border-color:transparent }

  main{ display:grid; grid-template-columns: 1fr; gap:16px; padding:16px; }

  .panel{ background:var(--panel); border:1px solid var(--border); border-radius:16px; padding:16px; display:none }
  .panel.active{ display:grid; gap:12px }
  .display{ font-variant-numeric: tabular-nums; text-align:center; font-size: clamp(34px, 8.6vw, 76px); font-weight:900; letter-spacing:1px }
  .sub{ text-align:center; color:var(--muted) }

  .controls{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:center; margin-top:4px }
  .laps{ max-height:230px; overflow:auto; border:1px solid var(--border); border-radius:12px }
  table{ width:100%; border-collapse:collapse; font-variant-numeric:tabular-nums }
  th,td{ padding:10px 12px; border-bottom:1px solid #11182733; text-align:right }
  th:first-child, td:first-child{ text-align:left }

  .inputs, .presets{ display:flex; gap:8px; flex-wrap:wrap; justify-content:center; align-items:center }
  .inputs input{ width:100px; text-align:center; font-weight:800 }
  .progress{ height:10px; background:var(--panel-2); border:1px solid var(--border); border-radius:999px; overflow:hidden }
  .bar{ height:100%; width:0%; background:linear-gradient(90deg, var(--accent), var(--accent-2)) }
  .overtime{ color: var(--danger) }

  footer{ text-align:center; color:var(--muted); padding:0 0 12px 0; font-size:13px }
  .small{ font-size:12px; color:var(--muted) }
  .file{ border:1px dashed var(--border); padding:8px 10px; border-radius:10px }

  /* 手機模式優化 */
  @media (max-width: 600px) {
    header { flex-direction: column; align-items: flex-start; gap: 10px; }
    .title-wrap { width: 100%; justify-content: space-between; }
    .title { font-size: 24px; }
    .subtitle { font-size: 18px; }
    .right-controls { width: 100%; justify-content: flex-start; }
    .inputs label { width: 100%; text-align: left; }
    .inputs input { width: 100%; text-align: center; }
  }
</style>
</head>
<body>
  <div class="app">
    <div class="card">
      <header>
        <div class="title-wrap">
          <div class="title">⏱️ 線上計時器</div>
          <div class="subtitle" id="subtitleEvent">（尚未設定事件）</div>
        </div>
        <div class="right-controls">
          <input id="eventInput" type="text" placeholder="事件名稱（會儲存）" />
          <button class="btn primary" id="saveEvent">儲存事件</button>
          <button class="btn" id="themeToggle" title="深/淺色主題">主題：深色</button>
        </div>
      </header>
      <nav class="tabs" role="tablist" aria-label="模式切換">
        <button class="tab" role="tab" aria-selected="true" data-tab="clock">時鐘</button>
        <button class="tab" role="tab" aria-selected="false" data-tab="stopwatch">碼錶</button>
        <button class="tab" role="tab" aria-selected="false" data-tab="countdown">倒數</button>
      </nav>
      <main>
        <section>
          <section id="panel-clock" class="panel active" role="tabpanel">
            <div class="display" id="clockDisplay">--:--:--</div>
            <div class="sub" id="dateDisplay">----</div>
          </section>

          <section id="panel-stopwatch" class="panel" role="tabpanel">
            <div class="display" id="swDisplay">00:00.00</div>
            <div class="controls">
              <button class="btn primary" id="swStart">開始</button>
              <button class="btn" id="swLap" disabled>圈數</button>
              <button class="btn" id="swPause" disabled>暫停</button>
              <button class="btn danger" id="swReset" disabled>重設</button>
            </div>
            <div class="laps" aria-live="polite">
              <table>
                <thead><tr><th>圈數</th><th>單圈</th><th>總計</th></tr></thead>
                <tbody id="lapsBody"></tbody>
              </table>
            </div>
          </section>

          <section id="panel-countdown" class="panel" role="tabpanel">
            <div class="display" id="cdDisplay">00:00:00</div>
            <div class="sub" id="cdOver"> </div>
            <div class="inputs">
              <label>時 <input id="hours" type="number" min="0" max="99" inputmode="numeric" placeholder="0" /></label>
              <label>分 <input id="minutes" type="number" min="0" max="59" inputmode="numeric" placeholder="0" /></label>
              <label>秒 <input id="seconds" type="number" min="0" max="59" inputmode="numeric" placeholder="0" /></label>
            </div>
            <div class="presets">
              <button class="btn" data-preset="60">1 分</button>
              <button class="btn" data-preset="300">5 分</button>
              <button class="btn" data-preset="600">10 分</button>
              <button class="btn" data-preset="1500">25 分（番茄）</button>
            </div>
            <div class="controls">
              <button class="btn primary" id="cdStart">開始</button>
              <button class="btn" id="cdPause" disabled>暫停</button>
              <button class="btn danger" id="cdReset" disabled>重設</button>
              <div class="row file">
                <label class="small">自訂音效：
                  <input id="soundFile" type="file" accept="audio/*" />
                </label>
                <button class="btn" id="testSound">試聽</button>
                <button class="btn ghost" id="clearSound">清除音效</button>
                <span class="small" id="soundHint">未設定</span>
              </div>
            </div>
            <div class="progress" aria-hidden="true"><div class="bar" id="cdBar"></div></div>
          </section>
        </section>
      </main>
      <footer>
        快捷鍵：<b>Space</b> 開始/暫停、<b>R</b> 重設、<b>L</b> 記錄圈數（碼錶）。主題、事件名稱、自訂音效皆會儲存於本機。
      </footer>
    </div>
  </div>

<script>
(function(){
  const $ = s => document.querySelector(s);
  const $$ = s => [...document.querySelectorAll(s)];

  /* ---------------- 事件名稱（標題下，加註並儲存） ---------------- */
  const EVENT_KEY = 'timer.eventName.v2';
  const eventInput = $('#eventInput');
  const subtitleEvent = $('#subtitleEvent');
  const saveEvent = $('#saveEvent');
  const savedEvent = localStorage.getItem(EVENT_KEY) || '';
  eventInput.value = savedEvent;
  renderSubtitle();
  saveEvent.addEventListener('click', ()=>{
    localStorage.setItem(EVENT_KEY, eventInput.value.trim());
    renderSubtitle();
    blink(saveEvent, '已儲存');
  });
  eventInput.addEventListener('keydown', e => { if(e.key==='Enter') saveEvent.click(); });
  function renderSubtitle(){
    const v = (eventInput.value||'').trim();
    subtitleEvent.textContent = v ? `（${v}）` : '（尚未設定事件）';
    document.title = `線上計時器${v? '｜'+v : ''}`;
  }
  function blink(btn, text){
    const old = btn.textContent; btn.textContent = text; setTimeout(()=> btn.textContent = old, 1100);
  }

  /* ---------------- 主題切換（記憶） ---------------- */
  const THEME_KEY = 'timer.theme.v1';
  const themeToggle = $('#themeToggle');
  const preferDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
  const savedTheme = localStorage.getItem(THEME_KEY) || (preferDark ? 'dark':'light');
  setTheme(savedTheme);
  themeToggle.addEventListener('click', ()=> setTheme(document.documentElement.dataset.theme === 'dark' ? 'light':'dark'));
  function setTheme(t){
    document.documentElement.dataset.theme = t;
    localStorage.setItem(THEME_KEY, t);
    themeToggle.textContent = `主題：${t==='dark'?'深色':'淺色'}`;
  }

  /* ---------------- 分頁切換 ---------------- */
  const panels = {
    clock: $('#panel-clock'),
    stopwatch: $('#panel-stopwatch'),
    countdown: $('#panel-countdown')
  };
  $$('.tab').forEach(tab=>{
    tab.addEventListener('click', ()=>{
      $$('.tab').forEach(t=> t.setAttribute('aria-selected','false'));
      tab.setAttribute('aria-selected','true');
      Object.values(panels).forEach(p=> p.classList.remove('active'));
      panels[tab.dataset.tab].classList.add('active');
    });
  });

  /* ---------------- 時鐘 ---------------- */
  const pad = n => String(n).padStart(2,'0');
  const clockDisplay = $('#clockDisplay');
  const dateDisplay = $('#dateDisplay');
  function tickClock(){
    const now = new Date();
    clockDisplay.textContent = `${pad(now.getHours())}:${pad(now.getMinutes())}:${pad(now.getSeconds())}`;
    const weekdays = ['週日','週一','週二','週三','週四','週五','週六'];
    dateDisplay.textContent = `${now.getFullYear()}-${pad(now.getMonth()+1)}-${pad(now.getDate())} · ${weekdays[now.getDay()]}`;
  }
  tickClock(); setInterval(tickClock, 1000);

  /* ---------------- 碼錶 ---------------- */
  const swDisplay = $('#swDisplay'), swStart = $('#swStart'), swPause = $('#swPause'), swReset = $('#swReset'), swLap = $('#swLap'), lapsBody = $('#lapsBody');
  let swRunning = false, swStartTime = 0, swAccum = 0, rafId = 0, lapCount = 0, lastLapAt = 0;
  function fmtSW(ms){
    const t = Math.max(0, Math.floor(ms));
    const H = Math.floor(t/3600000), M = Math.floor(t/60000)%60, S = Math.floor(t/1000)%60, C = Math.floor((t%1000)/10);
    return (H>0? pad(H)+':' : '') + pad(M)+':'+pad(S)+'.'+pad(C);
  }
  function paintSW(){
    const now = performance.now();
    const elapsed = swRunning ? (now - swStartTime) + swAccum : swAccum;
    swDisplay.textContent = fmtSW(elapsed);
    if(swRunning) rafId = requestAnimationFrame(paintSW);
  }
  function startSW(){ if(swRunning) return; swRunning = true; swStartTime = performance.now(); swStart.textContent='繼續'; swPause.disabled=false; swReset.disabled=false; swLap.disabled=false; paintSW(); }
  function pauseSW(){ if(!swRunning) return; swRunning=false; cancelAnimationFrame(rafId); swAccum += performance.now()-swStartTime; paintSW(); }
  function resetSW(){ swRunning=false; swAccum=0; lastLapAt=0; lapCount=0; lapsBody.innerHTML=''; swStart.textContent='開始'; swPause.disabled=true; swReset.disabled=true; swLap.disabled=true; cancelAnimationFrame(rafId); paintSW(); }
  function addLap(){
    const total = swRunning? (performance.now()-swStartTime)+swAccum : swAccum;
    const lap = total - lastLapAt; lastLapAt = total; lapCount++;
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>#${lapCount}</td><td>${fmtSW(lap)}</td><td>${fmtSW(total)}</td>`;
    lapsBody.prepend(tr);
  }
  swStart.addEventListener('click', startSW);
  swPause.addEventListener('click', pauseSW);
  swReset.addEventListener('click', resetSW);
  swLap.addEventListener('click', addLap);
  resetSW();

  /* ---------------- 倒數 ---------------- */
  const cdDisplay = $('#cdDisplay'), cdOver = $('#cdOver'), cdStart = $('#cdStart'), cdPause = $('#cdPause'), cdReset = $('#cdReset'), cdBar = $('#cdBar');
  const hIn = $('#hours'), mIn = $('#minutes'), sIn = $('#seconds');
  let cdRunning=false, cdStartAt=0, cdDuration=0, cdRemain=0, cdTimerId=0, cdOverMs=0, alerted=false;

  // 自訂音效（儲存 base64）
  const SOUND_KEY = 'timer.sound.b64.v1';
  const soundFile = $('#soundFile'), testSound = $('#testSound'), clearSound = $('#clearSound'), soundHint = $('#soundHint');
  let alarmAudio = new Audio();
  const savedSound = localStorage.getItem(SOUND_KEY);
  if(savedSound){ alarmAudio.src = savedSound; soundHint.textContent = '已設定自訂音效'; } else { buildBeep(); }

  soundFile.addEventListener('change', async (e)=>{
    const f = e.target.files?.[0]; if(!f) return;
    const b64 = await fileToDataURL(f);
    localStorage.setItem(SOUND_KEY, b64);
    alarmAudio.src = b64; soundHint.textContent = `已設定：${f.name}`;
  });
  clearSound.addEventListener('click', ()=>{
    localStorage.removeItem(SOUND_KEY); buildBeep(); soundHint.textContent = '未設定';
  });
  testSound.addEventListener('click', ()=>{ alarmAudio.loop=false; alarmAudio.currentTime=0; alarmAudio.play(); setTimeout(()=>alarmAudio.pause(), 1200); });

  function buildBeep(){
    alarmAudio.src = "data:audio/wav;base64,UklGRkQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABYAAABhYXVhAAAAAAAAPwAAAP8AAP8AAP8AAP8AAP8AAP8AAP8AAP8AAP8AAP8AAP8AAP8AAP8AAP8AAP8A";
  }
  function fileToDataURL(file){ return new Promise(res=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.readAsDataURL(file); }); }

  function fmtCD(ms){
    const total = Math.max(0, Math.floor(ms/1000));
    const h = Math.floor(total/3600), m = Math.floor((total%3600)/60), s = total%60;
    return `${pad(h)}:${pad(m)}:${pad(s)}`;
  }
  function getInputSeconds(){
    const h = Math.max(0, parseInt(hIn.value||'0',10));
    const m = Math.max(0, parseInt(mIn.value||'0',10));
    const s = Math.max(0, parseInt(sIn.value||'0',10));
    return Math.min(359999, h*3600 + m*60 + s);
  }
  function setFromSeconds(secs){
    const h = Math.floor(secs/3600), m = Math.floor((secs%3600)/60), s = secs%60;
    hIn.value=h; mIn.value=m; sIn.value=s;
  }
  function updateCDUI(){
    cdDisplay.textContent = fmtCD(cdRemain);
    const p = cdDuration>0 ? (1 - cdRemain/cdDuration)*100 : 0;
    cdBar.style.width = Math.max(0, Math.min(100, p))+'%';
    if(cdRemain<=0){
      cdDisplay.classList.add('overtime');
      cdOver.textContent = `已超過：${fmtCD(cdOverMs)}`;
    }else{
      cdDisplay.classList.remove('overtime');
      cdOver.textContent = '';
    }
  }
  function tickCD(){
    const now = performance.now();
    const elapsed = now - cdStartAt;
    cdRemain = Math.max(0, cdDuration - elapsed);
    if(cdRemain<=0){
      cdOverMs = Math.abs(cdDuration - elapsed);
      if(!alerted){
        alerted = true;
        alarmAudio.loop = true;
        alarmAudio.currentTime = 0;
        alarmAudio.play().catch(()=>{});
        const original = document.title;
        let n=0; const id = setInterval(()=>{
          document.title = (n++%2===0? '⏰ 時間到！' : original);
          if(!cdRunning){ clearInterval(id); document.title = original; }
        }, 500);
      }
    }
    updateCDUI();
    if(cdRunning){ cdTimerId = requestAnimationFrame(tickCD); }
  }
  $('#cdStart').addEventListener('click', ()=>{
    if(cdRunning) return;
    const secs = getInputSeconds();
    if(secs<=0) { cdOver.textContent = '請先輸入時間或用快速鍵。'; return; }
    cdRunning = true; alerted = false; cdOverMs=0;
    cdDuration = secs*1000; cdStartAt = performance.now(); cdRemain = cdDuration;
    $('#cdPause').disabled=false; $('#cdReset').disabled=false;
    tickCD();
  });
  $('#cdPause').addEventListener('click', ()=>{
    if(!cdRunning) return;
    cdRunning = false; cancelAnimationFrame(cdTimerId);
    const now = performance.now();
    const elapsed = now - cdStartAt;
    if(cdRemain>0){ cdRemain = Math.max(0, cdDuration - elapsed); cdDuration = cdRemain; }
    else{ cdOverMs = Math.abs(cdDuration - elapsed); cdDuration = 0; }
    alarmAudio.pause();
  });
  $('#cdReset').addEventListener('click', ()=>{
    cdRunning=false; cancelAnimationFrame(cdTimerId);
    cdDuration=0; cdRemain=0; cdOverMs=0; alerted=false; cdBar.style.width='0%';
    cdDisplay.textContent='00:00:00'; cdOver.textContent=''; cdDisplay.classList.remove('overtime');
    $('#cdPause').disabled=true; $('#cdReset').disabled=true;
    alarmAudio.pause(); alarmAudio.currentTime=0;
  });
  $$('.presets .btn').forEach(b=> b.addEventListener('click', ()=>{ const s=parseInt(b.dataset.preset,10); setFromSeconds(s); }));

  /* ---------------- 快捷鍵 ---------------- */
  window.addEventListener('keydown', (e)=>{
    const focused = document.activeElement && ['INPUT','TEXTAREA'].includes(document.activeElement.tagName);
    if(focused) return;
    const activePanel = Object.entries(panels).find(([,p])=> p.classList.contains('active'))?.[0];
    if(e.code==='Space'){ e.preventDefault();
      if(activePanel==='stopwatch'){ swRunning? pauseSW(): startSW(); }
      if(activePanel==='countdown'){ cdRunning? $('#cdPause').click(): $('#cdStart').click(); }
    }
    if(e.key.toLowerCase()==='r'){
      if(activePanel==='stopwatch') resetSW();
      if(activePanel==='countdown') $('#cdReset').click();
    }
    if(e.key.toLowerCase()==='l' && activePanel==='stopwatch') addLap();
  });
})();
</script>
</body>
</html>