<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>梅花心易卜卦系統</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Noto Serif TC', serif;
      background: linear-gradient(to bottom, #f5e8c7, #d9c2a6);
      color: #2f2f2f;
    }
    .scroll-bg {
      background: url('https://via.placeholder.com/800x600.png?text=Scroll+Background') center/cover, #f5e8c7;
      border: 2px solid #8b4513;
      border-radius: 8px;
      padding: 2rem;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    .hexagram-line {
      width: 100px;
      height: 10px;
      margin: 5px 0;
    }
    .yang-line {
      background: #2f2f2f;
    }
    .yin-line {
      background: linear-gradient(to right, #2f2f2f 40%, transparent 40%, transparent 60%, #2f2f2f 60%);
    }
    .moving-dot {
      display: inline-block;
      width: 8px;
      height: 8px;
      background: #a94438;
      border-radius: 50%;
      margin-left: 8px;
    }
    .table-container {
      max-height: 300px;
      overflow-y: auto;
    }
    th, td {
      border: 1px solid #d9c2a6;
      padding: 8px;
      text-align: center;
    }
    .history-item {
      cursor: pointer;
      padding: 0.5rem;
      border-bottom: 1px solid #d9c2a6;
    }
    .history-item:hover {
      background: #f5e8c7;
    }
    @media (max-width: 640px) {
      .scroll-bg {
        padding: 1rem;
      }
      .hexagram-line {
        width: 80px;
      }
    }
  </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center">
  <div class="w-full max-w-4xl mx-auto scroll-bg">
    <h1 class="text-4xl font-bold text-center mb-4 text-ink">梅花心易卜卦系統</h1>
    <p class="text-center text-lg mb-6">觀天地之象，察萬物之理，得易數之妙</p>

    <div class="mb-6">
      <label class="block text-lg font-medium mb-2">起卦方式</label>
      <select id="castMethod" class="w-full p-2 border rounded-md mb-4">
        <option value="random">隨機起卦</option>
        <option value="date">日期起卦</option>
        <option value="number">數字起卦</option>
      </select>

      <div id="dateInput" class="hidden mb-4">
        <label class="block text-lg font-medium mb-2">選擇日期</label>
        <input type="date" id="castDate" class="w-full p-2 border rounded-md" />
      </div>

      <div id="numberInput" class="hidden mb-4">
        <label class="block text-lg font-medium mb-2">輸入三個數字（用空格分隔，1-100）</label>
        <input type="text" id="numberInput" class="w-full p-2 border rounded-md" placeholder="例如：12 34 56" />
      </div>

      <label class="block text-lg font-medium mb-2">占問事項</label>
      <select id="questionType" class="w-full p-2 border rounded-md mb-4">
        <option value="事業">事業</option>
        <option value="財運">財運</option>
        <option value="感情">感情</option>
        <option value="健康">健康</option>
        <option value="學業">學業</option>
        <option value="其他">其他</option>
      </select>
      <input id="question" type="text" class="w-full p-2 border rounded-md mb-4" placeholder="請述問事詳情（可略）">

      <button onclick="castHexagram()" class="w-full bg-red-700 text-white p-2 rounded-md hover:bg-red-800">開始卜卦</button>
    </div>

    <div id="result" class="hidden">
      <h2 class="text-2xl font-semibold mb-4">卦象顯示</h2>
      <div class="flex flex-col sm:flex-row justify-around mb-4">
        <div>
          <h3 class="text-lg font-medium">本卦</h3>
          <div id="mainHexagram" class="mb-2"></div>
          <p id="mainGuaName" class="text-center"></p>
        </div>
        <div>
          <h3 class="text-lg font-medium">互卦</h3>
          <div id="mutualHexagram" class="mb-2"></div>
          <p id="mutualGuaName" class="text-center"></p>
        </div>
        <div>
          <h3 class="text-lg font-medium">變卦</h3>
          <div id="changedHexagram" class="mb-2"></div>
          <p id="changedGuaName" class="text-center"></p>
        </div>
      </div>

      <h2 class="text-2xl font-semibold mb-4">卦象深度解讀</h2>
      <h3 class="text-lg font-medium mb-2">卦象詳解</h3>
      <div id="guaCi" class="mb-4"></div>
      <h3 class="text-lg font-medium mb-2">五行生克詳解</h3>
      <div id="fiveElements" class="mb-4"></div>
      <h3 class="text-lg font-medium mb-2">旺相休囚死分析</h3>
      <div id="seasonalAnalysis" class="mb-4"></div>
      <h3 class="text-lg font-medium mb-2">動爻分析</h3>
      <div id="movingYao" class="mb-4"></div>
      <h3 class="text-lg font-medium mb-2">卦象組合</h3>
      <div id="guaCombination" class="mb-4"></div>
      <h3 class="text-lg font-medium mb-2">應事範圍</h3>
      <div id="application" class="mb-4"></div>
      <h3 class="text-lg font-medium mb-2">處世之道</h3>
      <div id="suggestion" class="mb-4"></div>

      <h2 class="text-2xl font-semibold mb-4">五行生克分析表</h2>
      <div class="table-container">
        <table class="w-full text-sm">
          <thead>
            <tr class="bg-gray-100">
              <th>卦象</th>
              <th>五行屬性</th>
              <th>生克關係</th>
              <th>吉凶判斷</th>
              <th>旺相休囚</th>
            </tr>
          </thead>
          <tbody id="fiveElementTable"></tbody>
        </table>
      </div>

      <h3 class="text-lg font-medium mb-2 mt-4">應期分析</h3>
      <div id="prediction" class="mb-4"></div>
    </div>

    <div id="history" class="mt-6 hidden">
      <h2 class="text-2xl font-semibold mb-4">卜卦歷史</h2>
      <div id="historyList" class="mb-4"></div>
      <button onclick="clearHistory()" class="w-full bg-red-600 text-white p-2 rounded-md hover:bg-red-700">清除歷史</button>
    </div>

    <div class="mt-6 text-center">
      <button onclick="showHistory()" class="bg-gray-600 text-white p-2 rounded-md hover:bg-gray-700">查看歷史</button>
    </div>
  </div>

  <footer class="mt-6 text-center text-sm">
    梅花心易卜卦系統 · 傳承千年智慧 · 僅供參考
  </footer>

  <script>
    const guaNames = ['乾', '兌', '離', '震', '巽', '坎', '艮', '坤'];
    const guaImages = {
      '乾': '天，剛健中正，宜果斷進取，行健不息。',
      '兌': '澤，悅而通達，宜和睦交流，喜悅以成。',
      '離': '火，麗而依附，宜明察慎行，文明以麗。',
      '震': '雷，動而奮發，宜振作有為，震驚百里。',
      '巽': '風，順而入微，宜柔和漸進，隨風而入。',
      '坎': '水，險而深邃，宜謹慎守正，履險如夷。',
      '艮': '山，止而厚重，宜靜觀待機，止於至善。',
      '坤': '地，順而廣博，宜包容謙卑，厚德載物。'
    };
    const fiveElements = ['金', '金', '火', '木', '木', '水', '土', '土'];
    const yaoSymbols = ['—', '- -'];
    const fiveElementRelations = {
      '金': { generates: '水', overcomes: '木', generatedBy: '土', overcomeBy: '火' },
      '木': { generates: '火', overcomes: '土', generatedBy: '水', overcomeBy: '金' },
      '水': { generates: '木', overcomes: '火', generatedBy: '金', overcomeBy: '土' },
      '火': { generates: '土', overcomes: '金', generatedBy: '木', overcomeBy: '水' },
      '土': { generates: '金', overcomes: '水', generatedBy: '火', overcomeBy: '木' }
    };
    const guaCiData = { /* Full 64 hexagrams as provided in previous artifact */ };
    const seasons = {
      '木': '春季（正月至三月）',
      '火': '夏季（四月至六月）',
      '土': '季末（三、六、九、十二月）',
      '金': '秋季（七月至九月）',
      '水': '冬季（十月至十二月）'
    };

    function validateElement(element) {
      return ['金', '木', '水', '火', '土'].includes(element);
    }

    function getRandomYao() {
      return Math.floor(Math.random() * 2);
    }

    function generateHexagram() {
      const yao = Array(6).fill().map(() => ({ value: getRandomYao(), isMoving: Math.random() < 0.3 }));
      const upper = yao.slice(3, 6).reverse().map(y => y.value);
      const lower = yao.slice(0, 3).reverse().map(y => y.value);
      const upperGua = parseInt(upper.join(''), 2) % 8;
      const lowerGua = parseInt(lower.join(''), 2) % 8;
      return { yao, upperGua, lowerGua };
    }

    function getDateHexagram(date) {
      const d = new Date(date);
      if (isNaN(d.getTime())) throw new Error('無效日期');
      const year = d.getFullYear();
      const month = d.getMonth() + 1;
      const day = d.getDate();
      const upperGua = (year + month + day) % 8;
      const lowerGua = (month + day + Math.floor(Math.random() * 100)) % 8;
      const yao = Array(6).fill().map(() => ({ value: getRandomYao(), isMoving: Math.random() < 0.3 }));
      return { yao, upperGua, lowerGua };
    }

    function getNumberHexagram(numbers) {
      const nums = numbers.split(/\s+/).map(Number);
      if (nums.length !== 3 || nums.some(n => isNaN(n) || n < 1 || n > 100)) {
        throw new Error('請輸入三個1-100的數字，用空格分隔');
      }
      const upperGua = nums.reduce((a, b) => a + b, 0) % 8;
      const lowerGua = (nums[1] + nums[2]) % 8;
      const yao = Array(6).fill().map(() => ({ value: getRandomYao(), isMoving: Math.random() < 0.3 }));
      return { yao, upperGua, lowerGua };
    }

    function getMutualHexagram(yao) {
      const mutualYao = yao.slice(1, 5).map(y => y.value);
      const upper = mutualYao.slice(2, 4).reverse();
      const lower = mutualYao.slice(0, 2).reverse();
      const upperGua = parseInt(upper.join(''), 2) % 8;
      const lowerGua = parseInt(lower.join(''), 2) % 8;
      return { yao: mutualYao.map(value => ({ value, isMoving: false })), upperGua, lowerGua };
    }

    function getChangedHexagram(yao) {
      const changedYao = yao.map(y => ({
        value: y.isMoving ? 1 - y.value : y.value,
        isMoving: y.isMoving
      }));
      const upper = changedYao.slice(3, 6).reverse().map(y => y.value);
      const lower = changedYao.slice(0, 3).reverse().map(y => y.value);
      const upperGua = parseInt(upper.join(''), 2) % 8;
      const lowerGua = parseInt(lower.join(''), 2) % 8;
      return { yao: changedYao, upperGua, lowerGua };
    }

    function renderHexagram(yao, elementId) {
      const element = document.getElementById(elementId);
      element.innerHTML = yao.reverse().map((y, i) => `
        <div class="${y.value === 1 ? 'yang-line' : 'yin-line'} hexagram-line">
          ${y.isMoving ? '<span class="moving-dot"></span>' : ''}
        </div>
      `).join('');
    }

    function getSeasonalStatus(element, date = new Date()) {
      const month = date.getMonth() + 1;
      if (element === '木' && [1, 2, 3].includes(month)) return '旺';
      if (element === '火' && [4, 5, 6].includes(month)) return '旺';
      if (element === '金' && [7, 8, 9].includes(month)) return '旺';
      if (element === '水' && [10, 11, 12].includes(month)) return '旺';
      if (element === '土' && [3, 6, 9, 12].includes(month)) return '旺';
      if (fiveElementRelations[element].generatedBy === '木' && [1, 2, 3].includes(month)) return '相';
      if (fiveElementRelations[element].generatedBy === '火' && [4, 5, 6].includes(month)) return '相';
      if (fiveElementRelations[element].generatedBy === '金' && [7, 8, 9].includes(month)) return '相';
      if (fiveElementRelations[element].generatedBy === '水' && [10, 11, 12].includes(month)) return '相';
      if (fiveElementRelations[element].generates === '木' && [1, 2, 3].includes(month)) return '休';
      if (fiveElementRelations[element].generates === '火' && [4, 5, 6].includes(month)) return '休';
      if (fiveElementRelations[element].generates === '金' && [7, 8, 9].includes(month)) return '休';
      if (fiveElementRelations[element].generates === '水' && [10, 11, 12].includes(month)) return '休';
      return '囚';
    }

    function castHexagram() {
      try {
        const castMethod = document.getElementById('castMethod').value;
        const questionType = document.getElementById('questionType').value;
        const question = document.getElementById('question').value.trim() || '未詳述問事';

        let mainGua, mutualGua, changedGua;
        if (castMethod === 'date') {
          const date = document.getElementById('castDate').value;
          mainGua = getDateHexagram(date);
        } else if (castMethod === 'number') {
          const numbers = document.getElementById('numberInput').value;
          mainGua = getNumberHexagram(numbers);
        } else {
          mainGua = generateHexagram();
        }
        mutualGua = getMutualHexagram(mainGua.yao);
        changedGua = getChangedHexagram(mainGua.yao);

        const mainElement = fiveElements[mainGua.upperGua];
        const useElement = fiveElements[mainGua.lowerGua];
        const changedElement = fiveElements[changedGua.upperGua];

        renderHexagram(mainGua.yao, 'mainHexagram');
        renderHexagram(mutualGua.yao, 'mutualHexagram');
        renderHexagram(changedGua.yao, 'changedHexagram');

        document.getElementById('mainGuaName').textContent = `${guaNames[mainGua.upperGua]}上${guaNames[mainGua.lowerGua]}下`;
        document.getElementById('mutualGuaName').textContent = `${guaNames[mutualGua.upperGua]}上${guaNames[mutualGua.lowerGua]}下`;
        document.getElementById('changedGuaName').textContent = `${guaNames[changedGua.upperGua]}上${guaNames[changedGua.lowerGua]}下`;

        const guaCi = getGuaCi(mainGua.upperGua, mainGua.lowerGua, mainGua.yao, questionType);
        const fiveElementsAnalysis = analyzeFiveElements(mainGua, changedGua, mainGua.yao);
        const { judgment, judgmentType } = getJudgment(mainElement, useElement, changedElement, mainGua.yao);
        const prediction = getPrediction(mainElement, changedElement, mainGua.yao);
        const suggestion = getSuggestion(questionType, { judgmentType }, mainElement, mainGua.yao);
        const seasonalAnalysis = `【旺相休囚死分析】：<br>本卦五行 ${mainElement}，當前狀態：${getSeasonalStatus(mainElement)}<br>` +
                                `用卦五行 ${useElement}，當前狀態：${getSeasonalStatus(useElement)}<br>` +
                                `變卦五行 ${changedElement}，當前狀態：${getSeasonalStatus(changedElement)}`;
        const movingYaoAnalysis = `【動爻分析】：<br>動爻數 ${mainGua.yao.filter(y => y.isMoving).length}，${mainGua.yao.filter(y => y.isMoving).length > 2 ? '事變速疾，宜迅速應對' : '事變適中，宜穩中求進'}.`;
        const guaCombination = `【卦象組合】：<br>本卦：${guaNames[mainGua.upperGua]}上${guaNames[mainGua.lowerGua]}下，意為${guaImages[guaNames[mainGua.upperGua]]}<br>` +
                              `互卦：${guaNames[mutualGua.upperGua]}上${guaNames[mutualGua.lowerGua]}下，意為${guaImages[guaNames[mutualGua.upperGua]]}<br>` +
                              `變卦：${guaNames[changedGua.upperGua]}上${guaNames[changedGua.lowerGua]}下，意為${guaImages[guaNames[changedGua.upperGua]]}`;

        document.getElementById('guaCi').innerHTML = guaCi;
        document.getElementById('fiveElements').innerHTML = fiveElementsAnalysis;
        document.getElementById('seasonalAnalysis').innerHTML = seasonalAnalysis;
        document.getElementById('movingYao').innerHTML = movingYaoAnalysis;
        document.getElementById('guaCombination').innerHTML = guaCombination;
        document.getElementById('application').innerHTML = `【應事範圍】：<br>${questionType}相關事項，宜參考卦象與動爻，謹慎行事。`;
        document.getElementById('suggestion').innerHTML = suggestion;
        document.getElementById('prediction').innerHTML = prediction;

        const tableBody = document.getElementById('fiveElementTable');
        tableBody.innerHTML = `
          <tr>
            <td>本卦</td><td>${mainElement}</td><td>${fiveElementRelations[mainElement].generates === useElement ? '體生用' : fiveElementRelations[mainElement].overcomes === useElement ? '體克用' : '比和'}</td><td>${judgmentType}</td><td>${getSeasonalStatus(mainElement)}</td>
          </tr>
          <tr>
            <td>用卦</td><td>${useElement}</td><td>${fiveElementRelations[useElement].generates === mainElement ? '用生體' : fiveElementRelations[useElement].overcomes === mainElement ? '用克體' : '比和'}</td><td>-</td><td>${getSeasonalStatus(useElement)}</td>
          </tr>
          <tr>
            <td>變卦</td><td>${changedElement}</td><td>${fiveElementRelations[mainElement].overcomes === changedElement ? '體克變' : fiveElementRelations[changedElement].overcomes === mainElement ? '變克體' : '同體'}</td><td>-</td><td>${getSeasonalStatus(changedElement)}</td>
          </tr>
        `;

        document.getElementById('result').classList.remove('hidden');
        document.getElementById('history').classList.add('hidden');

        const history = JSON.parse(localStorage.getItem('hexagramHistory') || '[]');
        history.unshift({
          date: new Date().toLocaleString('zh-TW'),
          questionType,
          question,
          mainGua: `${guaNames[mainGua.upperGua]}上${guaNames[mainGua.lowerGua]}下`,
          mutualGua: `${guaNames[mutualGua.upperGua]}上${guaNames[mutualGua.lowerGua]}下`,
          changedGua: `${guaNames[changedGua.upperGua]}上${guaNames[changedGua.lowerGua]}下`,
          guaCi,
          fiveElements: fiveElementsAnalysis,
          seasonalAnalysis,
          movingYao: movingYaoAnalysis,
          guaCombination,
          application: `【應事範圍】：${questionType}相關事項`,
          suggestion,
          prediction
        });
        localStorage.setItem('hexagramHistory', JSON.stringify(history));

        document.getElementById('numberInput').value = '';
        document.getElementById('castDate').value = '';
      } catch (error) {
        console.error('卜卦錯誤:', error);
        alert('卜卦失敗：' + error.message);
      }
    }

    function showHistory() {
      const historyList = document.getElementById('historyList');
      const history = JSON.parse(localStorage.getItem('hexagramHistory') || '[]');
      historyList.innerHTML = history.length ? history.map((item, i) => `
        <div class="history-item" onclick="displayHistoryItem(${i})">
          ${item.date} - ${item.questionType}: ${item.question}
        </div>
      `).join('') : '無卜卦歷史';
      document.getElementById('history').classList.remove('hidden');
      document.getElementById('result').classList.add('hidden');
    }

    function displayHistoryItem(index) {
      const history = JSON.parse(localStorage.getItem('hexagramHistory') || '[]');
      const item = history[index];
      if (item) {
        document.getElementById('mainGuaName').textContent = item.mainGua;
        document.getElementById('mutualGuaName').textContent = item.mutualGua;
        document.getElementById('changedGuaName').textContent = item.changedGua;
        document.getElementById('guaCi').innerHTML = item.guaCi;
        document.getElementById('fiveElements').innerHTML = item.fiveElements;
        document.getElementById('seasonalAnalysis').innerHTML = item.seasonalAnalysis;
        document.getElementById('movingYao').innerHTML = item.movingYao;
        document.getElementById('guaCombination').innerHTML = item.guaCombination;
        document.getElementById('application').innerHTML = item.application;
        document.getElementById('suggestion').innerHTML = item.suggestion;
        document.getElementById('prediction').innerHTML = item.prediction;
        document.getElementById('result').classList.remove('hidden');
        document.getElementById('history').classList.add('hidden');
      }
    }

    function clearHistory() {
      localStorage.removeItem('hexagramHistory');
      document.getElementById('historyList').innerHTML = '無卜卦歷史';
    }

    document.getElementById('castMethod').addEventListener('change', () => {
      const method = document.getElementById('castMethod').value;
      document.getElementById('dateInput').classList.toggle('hidden', method !== 'date');
      document.getElementById('numberInput').classList.toggle('hidden', method !== 'number');
    });

    console.log('Script loaded, castHexagram defined:', typeof castHexagram);
  </script>
</body>
</html>
