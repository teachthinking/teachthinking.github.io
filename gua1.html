<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>梅花心易卜卦與解卦系統</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: "Microsoft YaHei", "Heiti TC", sans-serif;
        }

        body {
            background-color: #f9f5eb;
            color: #333;
            line-height: 1.6;
            padding: 20px;
            max-width: 1000px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #8e7d5b 0%, #c9ad7a 100%);
            border-radius: 10px;
            color: #fff;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        h1 {
            font-size: 2.2rem;
            margin-bottom: 10px;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.3);
        }

        .description {
            font-size: 1.1rem;
            margin-bottom: 20px;
            color: #f0e6d2;
        }

        .container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 30px;
        }

        .divination-section {
            flex: 1;
            min-width: 300px;
            background: #fff;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        }

        .result-section {
            flex: 2;
            min-width: 300px;
            background: #fff;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        }

        h2 {
            color: #8e7d5b;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e8dbc5;
        }

        h3 {
            color: #a94438;
            margin-top: 15px;
            margin-bottom: 10px;
            font-size: 1.2rem;
        }

        .input-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #666;
        }

        input, select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
        }

        button {
            display: block;
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #8e7d5b 0%, #c9ad7a 100%);
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
        }

        button:hover {
            background: linear-gradient(135deg, #7a6b4e 0%, #b09868 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        .random-btn {
            background: linear-gradient(135deg, #6b7d8e 0%, #7a9cc9 100%);
        }

        .random-btn:hover {
            background: linear-gradient(135deg, #5b6b7a 0%, #6888b0 100%);
        }

        .result-content {
            padding: 20px;
            background-color: #f8f4e9;
            border-radius: 8px;
            min-height: 200px;
        }

        .interpretation {
            font-size: 1.1rem;
            line-height: 1.8;
            padding: 15px;
            background-color: #fff;
            border-left: 4px solid #c9ad7a;
            border-radius: 4px;
            white-space: pre-line;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #8e7d5b;
        }

        .gua-info {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .gua-item {
            flex: 1;
            min-width: 150px;
            text-align: center;
            padding: 15px;
            margin: 10px;
            background: #f3eee2;
            border-radius: 8px;
        }

        .gua-title {
            font-weight: bold;
            color: #8e7d5b;
            margin-bottom: 10px;
        }

        .gua-value {
            font-size: 1.3rem;
            font-weight: bold;
        }

        footer {
            text-align: center;
            margin-top: 40px;
            color: #888;
            font-size: 0.9rem;
        }

        .method-selector {
            margin-bottom: 20px;
        }

        .method-tab {
            display: none;
        }

        .method-tab.active {
            display: block;
        }

        .tab-buttons {
            display: flex;
            margin-bottom: 15px;
            border-bottom: 1px solid #e8dbc5;
        }

        .tab-btn {
            padding: 10px 15px;
            background: #f3eee2;
            border: none;
            border-radius: 5px 5px 0 0;
            cursor: pointer;
            margin-right: 5px;
            font-weight: bold;
            color: #8e7d5b;
        }

        .tab-btn.active {
            background: #8e7d5b;
            color: white;
        }

        .hexagram-container {
            display: flex;
            justify-content: space-around;
            margin-bottom: 20px;
        }

        .hexagram-group {
            text-align: center;
        }

        .hexagram-lines {
            display: flex;
            flex-direction: column;
            align-items: center;
            border: 1px solid #ccc;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .hexagram-line {
            width: 100px;
            height: 8px;
            margin: 4px 0;
            background: #2f2f2f;
        }

        .yin-line {
            background: linear-gradient(to right, #2f2f2f 40%, transparent 40%, transparent 60%, #2f2f2f 60%);
        }

        .moving-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            background: #a94438;
            border-radius: 50%;
            margin-left: 8px;
        }

        .table-container {
            overflow-x: auto;
            margin-top: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            border: 1px solid #d9c2a6;
            padding: 10px;
            text-align: center;
        }

        th {
            background-color: #f3eee2;
        }

        .hidden {
            display: none;
        }

        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            .gua-info {
                flex-direction: column;
            }
            .tab-buttons {
                flex-wrap: wrap;
            }
            .tab-btn {
                margin-bottom: 5px;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>梅花心易卜卦與解卦系統</h1>
        <p class="description">根據五行生克關係，解析卦象的吉凶變化</p>
    </header>

    <div class="container">
        <section class="divination-section">
            <h2>卜卦區</h2>

            <div class="method-selector">
                <div class="tab-buttons">
                    <button class="tab-btn active" data-tab="direct">直接取卦</button>
                    <button class="tab-btn" data-tab="time">時間取卦</button>
                    <button class="tab-btn" data-tab="number">數字取卦</button>
                </div>

                <div class="method-tab active" id="direct-tab">
                    <div class="input-group">
                        <label for="shang-gua">上卦（1-8）：</label>
                        <select id="shang-gua">
                            <option value="1">1 - 乾卦 (金)</option>
                            <option value="2">2 - 兌卦 (金)</option>
                            <option value="3">3 - 離卦 (火)</option>
                            <option value="4">4 - 震卦 (木)</option>
                            <option value="5">5 - 巽卦 (木)</option>
                            <option value="6">6 - 坎卦 (水)</option>
                            <option value="7">7 - 艮卦 (土)</option>
                            <option value="8">8 - 坤卦 (土)</option>
                        </select>
                    </div>

                    <div class="input-group">
                        <label for="xia-gua">下卦（1-8）：</label>
                        <select id="xia-gua">
                            <option value="1">1 - 乾卦 (金)</option>
                            <option value="2">2 - 兌卦 (金)</option>
                            <option value="3">3 - 離卦 (火)</option>
                            <option value="4">4 - 震卦 (木)</option>
                            <option value="5">5 - 巽卦 (木)</option>
                            <option value="6">6 - 坎卦 (水)</option>
                            <option value="7">7 - 艮卦 (土)</option>
                            <option value="8">8 - 坤卦 (土)</option>
                        </select>
                    </div>

                    <div class="input-group">
                        <label for="moving-yao">變爻（1-6）：</label>
                        <select id="moving-yao">
                            <option value="1">1 - 初爻</option>
                            <option value="2">2 - 二爻</option>
                            <option value="3">3 - 三爻</option>
                            <option value="4">4 - 四爻</option>
                            <option value="5">5 - 五爻</option>
                            <option value="6">6 - 上爻</option>
                        </select>
                    </div>
                </div>

                <div class="method-tab" id="time-tab">
                    <div class="input-group">
                        <label for="year">年份：</label>
                        <input type="number" id="year" min="1900" max="2100" value="2025">
                    </div>

                    <div class="input-group">
                        <label for="month">月份：</label>
                        <input type="number" id="month" min="1" max="12" value="9">
                    </div>

                    <div class="input-group">
                        <label for="day">日期：</label>
                        <input type="number" id="day" min="1" max="31" value="4">
                    </div>

                    <div class="input-group">
                        <label for="hour">時辰（0-23）：</label>
                        <input type="number" id="hour" min="0" max="23" value="1">
                    </div>

                    <button id="use-current-time">使用當前時間</button>
                </div>

                <div class="method-tab" id="number-tab">
                    <div class="input-group">
                        <label for="number1">第一個數字（1-1000）：</label>
                        <input type="number" id="number1" min="1" max="1000" value="35">
                    </div>

                    <div class="input-group">
                        <label for="number2">第二個數字（1-1000）：</label>
                        <input type="number" id="number2" min="1" max="1000" value="48">
                    </div>

                    <div class="input-group">
                        <label for="number3">第三個數字（1-6）：</label>
                        <input type="number" id="number3" min="1" max="6" value="6">
                    </div>
                </div>
            </div>

            <button id="calculate-btn">開始卜卦</button>
            <button id="random-btn" class="random-btn">隨機卜卦</button>
        </section>

        <section class="result-section">
            <h2>解卦結果</h2>
            <div class="result-content">
                <div class="loading" id="result-loading">請選擇取卦方式並點擊"開始卜卦"按鈕獲取結果</div>
                <div id="result" style="display: none;">
                    <h3>卦象顯示</h3>
                    <div class="hexagram-container">
                        <div class="hexagram-group">
                            <div class="gua-title">本卦</div>
                            <div class="hexagram-lines" id="mainHexagram"></div>
                            <div class="gua-value" id="ben-gua"></div>
                        </div>
                        <div class="hexagram-group">
                            <div class="gua-title">互卦</div>
                            <div class="hexagram-lines" id="mutualHexagram"></div>
                            <div class="gua-value" id="hu-gua"></div>
                        </div>
                        <div class="hexagram-group">
                            <div class="gua-title">變卦</div>
                            <div class="hexagram-lines" id="changedHexagram"></div>
                            <div class="gua-value" id="bian-gua"></div>
                        </div>
                    </div>

                    <h3>五行生克分析表</h3>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>卦象</th>
                                    <th>五行屬性</th>
                                    <th>生克關係</th>
                                    <th>吉凶判斷</th>
                                    <th>旺相休囚</th>
                                </tr>
                            </thead>
                            <tbody id="fiveElementTable"></tbody>
                        </table>
                    </div>

                    <h3>卦象深度解讀</h3>
                    <div class="interpretation" id="interpretation"></div>
                    <p id="guaCi"></p>

                    <h3>五行生克詳解</h3>
                    <div id="fiveElements"></div>

                    <h3>旺相休囚死分析</h3>
                    <div id="seasonalAnalysis"></div>

                    <h3>動爻分析</h3>
                    <div id="movingYao"></div>

                    <h3>卦象組合</h3>
                    <div id="guaCombination"></div>

                    <h3>應事範圍</h3>
                    <div id="application"></div>

                    <h3>處世之道</h3>
                    <div id="suggestion"></div>

                    <h3>應期分析</h3>
                    <div id="prediction"></div>
                </div>
            </div>
        </section>
    </div>

    <div id="history-section" class="divination-section hidden">
        <h2>卜卦歷史</h2>
        <div id="historyList"></div>
        <button id="clear-history-btn">清除歷史</button>
    </div>

    <button id="show-history-btn" style="width: 200px; margin: 20px auto;">查看歷史紀錄</button>

    <footer>
        <p>梅花心易卜卦程式 &copy; 2025 - 傳承千年智慧，僅供參考</p>
    </footer>

    <script>
        // 八卦數據
        const guaTable = {
            1: { name: '乾', fiveElement: '金', binary: '111' },
            2: { name: '兌', fiveElement: '金', binary: '011' },
            3: { name: '離', fiveElement: '火', binary: '101' },
            4: { name: '震', fiveElement: '木', binary: '001' },
            5: { name: '巽', fiveElement: '木', binary: '110' },
            6: { name: '坎', fiveElement: '水', binary: '010' },
            7: { name: '艮', fiveElement: '土', binary: '100' },
            8: { name: '坤', fiveElement: '土', binary: '000' }
        };

        const guaNames = ['', '乾', '兌', '離', '震', '巽', '坎', '艮', '坤'];
        const guaImages = {
            '乾': '天，剛健中正，宜果斷進取，行健不息。',
            '兌': '澤，悅而通達，宜和睦交流，喜悅以成。',
            '離': '火，麗而依附，宜明察慎行，文明以麗。',
            '震': '雷，動而奮發，宜振作有為，震驚百里。',
            '巽': '風，順而入微，宜柔和漸進，隨風而入。',
            '坎': '水，險而深邃，宜謹慎守正，履險如夷。',
            '艮': '山，止而厚重，宜靜觀待機，止於至善。',
            '坤': '地，順而廣博，宜包容謙卑，厚德載物。'
        };

        const guaCiData = {
            '乾上乾下': { name: '乾為天', ci: '元亨利貞，剛健中正，宜自強不息。', yaoCi: ['初九：潛龍勿用，宜潛藏蓄力。', '九二：見龍在田，宜顯露才華。', '九三：君子終日乾乾，宜勤勉不懈。', '九四：或躍在淵，宜審時進退。', '九五：飛龍在天，宜乘勢而為。', '上九：亢龍有悔，宜謙退防過。'] },
            '乾上坎下': { name: '天水訟', ci: '有孚窒惕，宜謹慎爭訟，守正以待。', yaoCi: ['初六：不永所事，宜小事謹慎。', '六二：不克訟，宜退避三舍。', '九三：食舊德，宜安守本分。', '六四：不克訟，宜復正安和。', '九五：訟元吉，宜公正處事。', '上九：或錫之鞶帶，宜謙退勿爭。'] },
            '震上坤下': { name: '雷地豫', ci: '利建侯行師，宜振奮順時，謀定而動。', yaoCi: ['初六：鳴豫凶，宜謹慎勿躁。', '六二：介於石，宜守正不移。', '六三：盱豫悔，宜審慎勿進。', '九四：由豫大有得，宜順勢而為。', '六五：貞疾，宜調養慎行。', '上六：冥豫，宜謙退防過。'] },
            '坤上坤下': { name: '坤為地', ci: '元亨，利牝馬之貞，宜順勢而為，厚德載物。', yaoCi: ['初六：履霜堅冰至，宜謹慎行事。', '六二：直方大，宜正直行事。', '六三：含章可貞，宜潛藏待時。', '六四：括囊無咎，宜謹慎守口。', '六五：黃裳元吉，宜謙和行事。', '上六：龍戰於野，宜謙退防爭。'] },
            '艮上坤下': { name: '山地剝', ci: '不利有攸往，宜靜守待時，謹慎以行。', yaoCi: ['初六：剝床以足，宜謹慎小事。', '六二：剝床以辨，宜穩固根基。', '六三：剝之無咎，宜守正不爭。', '六四：剝床以膚，宜謹防損失。', '六五：貫魚以宮人，宜順勢而為。', '上九：碩果不食，宜謙退守成。'] },
            '坎上坤下': { name: '水地比', ci: '吉，原筮元永貞，宜親比和睦，誠信以行。', yaoCi: ['初六：有孚比之，宜誠信相交。', '六二：比之自內，宜內修德行。', '六三：比之匪人，宜慎選同道。', '六四：外比之，宜廣結善緣。', '九五：顯比，宜公正無私。', '上六：比之無首，宜謹慎行事。'] },
            '巽上坤下': { name: '風地觀', ci: '盥而不薦，宜觀察時機，謹慎以待。', yaoCi: ['初六：童觀，宜謙學觀察。', '六二：窺觀，宜內省慎行。', '六三：觀我生，宜審己進退。', '六四：觀國之光，宜廣學求進。', '九五：觀我生，宜自省修德。', '上九：觀其生，宜高瞻遠矚。'] },
            '離上坤下': { name: '火地晉', ci: '康侯用錫馬，宜進取有為，光明正大。', yaoCi: ['初六：晉如摧如，宜謹慎起步。', '六二：晉如愁如，宜堅守正道。', '六三：眾允悔亡，宜團結進取。', '九四：晉如鼫鼠，宜謹防小人。', '六五：悔亡失得，宜坦然進取。', '上九：晉其角，宜謙退防過。'] },
            '兌上坤下': { name: '澤地萃', ci: '亨，王假有廟，宜團結和睦，聚眾成事。', yaoCi: ['初六：有孚不終，宜誠信團結。', '六二：引吉無咎，宜真誠相交。', '六三：萃如嗟如，宜謹慎求援。', '九四：大吉無咎，宜廣結善緣。', '九五：萃有位，宜公正行事。', '上六：齎咨涕洟，宜靜觀其變。'] },
            '乾上兌下': { name: '天澤履', ci: '履虎尾，宜謹慎行事，守正無咎。', yaoCi: ['初九：素履往，宜謙慎起步。', '九二：履道坦坦，宜中正前行。', '六三：眇能視，宜謹慎行事。', '九四：履虎尾，宜審慎進退。', '九五：夬夬其正，宜果斷中正。', '上九：視履考祥，宜審慎持正。'] }
        };

        const fiveElementRelations = {
            '金': { generates: '水', overcomes: '木', generatedBy: '土', overcomeBy: '火' },
            '木': { generates: '火', overcomes: '土', generatedBy: '水', overcomeBy: '金' },
            '水': { generates: '木', overcomes: '火', generatedBy: '金', overcomeBy: '土' },
            '火': { generates: '土', overcomes: '金', generatedBy: '木', overcomeBy: '水' },
            '土': { generates: '金', overcomes: '水', generatedBy: '火', overcomeBy: '木' }
        };

        const seasons = {
            '木': '春季（正月至三月）',
            '火': '夏季（四月至六月）',
            '土': '季末（三、六、九、十二月）',
            '金': '秋季（七月至九月）',
            '水': '冬季（十月至十二月）'
        };

        const interpretations = {
            "WS,WS,WS": "初始吉利，過程中得到幫助，最終結果吉利。整體大吉。\n\n乾坤和合福運開，\n貴人相助路途寬，\n順天應人成大業，\n吉星高照夢圓滿",
            "WS,WS,WK": "初始吉利，過程中得到幫助，最終結果凶險。整體小吉。\n\n初陽普照福運生，\n貴人相助路途平，\n末遇風波需謹慎，\n守正持中化險情",
            // 其他解釋略，保留原 interpretations 數據
        };

        document.addEventListener('DOMContentLoaded', () => {
            const tabs = document.querySelectorAll('.tab-btn');
            const tabContents = document.querySelectorAll('.method-tab');
            const calculateBtn = document.getElementById('calculate-btn');
            const randomBtn = document.getElementById('random-btn');
            const useCurrentTimeBtn = document.getElementById('use-current-time');
            const showHistoryBtn = document.getElementById('show-history-btn');
            const clearHistoryBtn = document.getElementById('clear-history-btn');
            const historySection = document.getElementById('history-section');
            const resultDiv = document.getElementById('result');
            const resultLoading = document.getElementById('result-loading');

            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    tabs.forEach(t => t.classList.remove('active'));
                    tabContents.forEach(c => c.classList.remove('active'));
                    tab.classList.add('active');
                    document.getElementById(`${tab.dataset.tab}-tab`).classList.add('active');
                });
            });

            useCurrentTimeBtn.addEventListener('click', () => {
                const now = new Date();
                document.getElementById('year').value = now.getFullYear();
                document.getElementById('month').value = now.getMonth() + 1;
                document.getElementById('day').value = now.getDate();
                document.getElementById('hour').value = now.getHours();
            });

            calculateBtn.addEventListener('click', calculateDivination);
            randomBtn.addEventListener('click', generateRandomDivination);
            showHistoryBtn.addEventListener('click', toggleHistory);
            clearHistoryBtn.addEventListener('click', clearHistory);

            function toggleHistory() {
                if (historySection.classList.contains('hidden')) {
                    historySection.classList.remove('hidden');
                    resultDiv.style.display = 'none';
                    resultLoading.style.display = 'none';
                    loadHistory();
                    showHistoryBtn.textContent = '隱藏歷史紀錄';
                } else {
                    historySection.classList.add('hidden');
                    resultLoading.style.display = 'block';
                    resultDiv.style.display = 'none';
                    showHistoryBtn.textContent = '查看歷史紀錄';
                }
            }

function calculateDivination() {
    const activeTab = document.querySelector('.method-tab.active').id;
    let shangGua, xiaGua, movingYao;

    if (activeTab === 'direct-tab') {
        shangGua = parseInt(document.getElementById('shang-gua').value);
        xiaGua = parseInt(document.getElementById('xia-gua').value);
        movingYao = parseInt(document.getElementById('moving-yao').value);
    } else if (activeTab === 'time-tab') {
        const year = parseInt(document.getElementById('year').value) || 0;
        const month = parseInt(document.getElementById('month').value) || 0;
        const day = parseInt(document.getElementById('day').value) || 0;
        const hour = parseInt(document.getElementById('hour').value) || 0;
        if (!year || !month || !day || hour < 0) return alert('請輸入完整時間');
        shangGua = (year + month + day) % 8 || 8;
        xiaGua = (year + month + day + hour) % 8 || 8;
        movingYao = (year + month + day + hour) % 6 || 6;
    } else if (activeTab === 'number-tab') {
        const num1 = parseInt(document.getElementById('number1').value) || 0;
        const num2 = parseInt(document.getElementById('number2').value) || 0;
        const num3 = parseInt(document.getElementById('number3').value) || 0;
        if (!num1 || !num2 || !num3) return alert('請輸入三個數字');
        shangGua = num1 % 8 || 8;
        xiaGua = num2 % 8 || 8;
        movingYao = num3 % 6 || 6;
    }

    showLoading();
    setTimeout(() => {
        // 本卦
        const benGuaName = guaTable[shangGua].name + '上' + guaTable[xiaGua].name + '下';
        const benBinary = guaTable[xiaGua].binary + guaTable[shangGua].binary; // 下卦+上卦

        // 互卦
        const yaoArray = benBinary.split('').map(Number);
        const huLowerYao = [yaoArray[1], yaoArray[2], yaoArray[3]]; // 二三四爻
        const huUpperYao = [yaoArray[2], yaoArray[3], yaoArray[4]]; // 三四五爻
        const shangHuIndex = findGuaIndex(huUpperYao);
        const xiaHuIndex = findGuaIndex(huLowerYao);
        const huGuaName = guaNames[shangHuIndex] + '上' + guaNames[xiaHuIndex] + '下';

        // 變卦
        let bianBinary = [...yaoArray];
        bianBinary[movingYao - 1] = 1 - bianBinary[movingYao - 1]; // 翻轉動爻（0-based index）
        const bianLowerYao = [bianBinary[0], bianBinary[1], bianBinary[2]]; // 前三爻
        const bianUpperYao = [bianBinary[3], bianBinary[4], bianBinary[5]]; // 後三爻
        const shangBianIndex = findGuaIndex(bianUpperYao);
        const xiaBianIndex = findGuaIndex(bianLowerYao);
        const bianGuaName = guaNames[shangBianIndex] + '上' + guaNames[xiaBianIndex] + '下';

        // 五行屬性
        const benGuaShangElement = guaTable[shangGua].fiveElement;
        const benGuaXiaElement = guaTable[xiaGua].fiveElement;
        const huGuaShangElement = guaTable[shangHuIndex].fiveElement;
        const huGuaXiaElement = guaTable[xiaHuIndex].fiveElement;
        const bianGuaShangElement = guaTable[shangBianIndex].fiveElement;
        const bianGuaXiaElement = guaTable[xiaBianIndex].fiveElement;

        // 顯示結果
        document.getElementById('ben-gua').textContent = benGuaName;
        document.getElementById('hu-gua').textContent = huGuaName;
        document.getElementById('bian-gua').textContent = bianGuaName;
        document.getElementById('interpretation').textContent = getInterpretation(
            benGuaShangElement, benGuaXiaElement,
            huGuaShangElement, huGuaXiaElement,
            bianGuaShangElement, bianGuaXiaElement
        );

        drawHexagram('mainHexagram', benBinary, movingYao);
        drawHexagram('mutualHexagram', huLowerYao.join('') + huUpperYao.join(''), 0);
        drawHexagram('changedHexagram', bianBinary.join(''), 0);

        displayDeepInterpretation(benGuaName, huGuaName, bianGuaName, movingYao, shangGua, xiaGua, shangHuIndex, xiaHuIndex, shangBianIndex, xiaBianIndex);
        displayFiveElementTable(shangGua, xiaGua, shangHuIndex, xiaHuIndex, shangBianIndex, xiaBianIndex);

        resultDiv.style.display = 'block';
        saveHistory({
            date: new Date().toLocaleString(),
            benGua: guaTable[shangGua].name + guaTable[xiaGua].name,
            huGua: guaNames[shangHuIndex] + guaNames[xiaHuIndex],
            bianGua: guaNames[shangBianIndex] + guaNames[xiaBianIndex],
            movingYao: movingYao
        });
    }, 800);
}

function findGuaIndex(yao) {
    const binary = yao.join('');
    for (let i = 1; i <= 8; i++) {
        if (guaTable[i].binary === binary) return i;
    }
    return 1; // 默認乾
}

            function getInterpretation(benGuaShangElement, benGuaXiaElement, huGuaShangElement, huGuaXiaElement, bianGuaShangElement, bianGuaXiaElement) {
                const benRelation = getRelation(benGuaXiaElement, benGuaShangElement); // 體卦(下)與用卦(上)
                const huRelation = getRelation(benGuaXiaElement, huGuaShangElement);
                const bianRelation = getRelation(benGuaXiaElement, bianGuaShangElement);
                const key = `${benRelation},${huRelation},${bianRelation}`;
                return interpretations[key] || '無法解析此組合';
            }

            function getRelation(el1, el2) {
                if (!el1 || !el2) return 'BH';
                if (el1 === el2) return 'BH';
                if (fiveElementRelations[el1].generates === el2) return 'WS';
                if (fiveElementRelations[el1].overcomes === el2) return 'WK';
                if (fiveElementRelations[el1].generatedBy === el2) return 'SS';
                if (fiveElementRelations[el1].overcomeBy === el2) return 'SK';
                return 'UNKNOWN';
            }

            function generateRandomDivination() {
                const activeTab = document.querySelector('.method-tab.active').id;
                if (activeTab === 'direct-tab') {
                    document.getElementById('shang-gua').value = Math.floor(Math.random() * 8) + 1;
                    document.getElementById('xia-gua').value = Math.floor(Math.random() * 8) + 1;
                    document.getElementById('moving-yao').value = Math.floor(Math.random() * 6) + 1;
                } else if (activeTab === 'time-tab') {
                    const now = new Date();
                    document.getElementById('year').value = now.getFullYear();
                    document.getElementById('month').value = now.getMonth() + 1;
                    document.getElementById('day').value = now.getDate();
                    document.getElementById('hour').value = now.getHours();
                } else if (activeTab === 'number-tab') {
                    document.getElementById('number1').value = Math.floor(Math.random() * 999) + 1;
                    document.getElementById('number2').value = Math.floor(Math.random() * 999) + 1;
                    document.getElementById('number3').value = Math.floor(Math.random() * 6) + 1;
                }
                calculateDivination();
            }

            function showLoading() {
                resultLoading.style.display = 'block';
                resultDiv.style.display = 'none';
            }

            function drawHexagram(elementId, binaryString, movingYao) {
                const element = document.getElementById(elementId);
                element.innerHTML = '';
                for (let i = 0; i < 6; i++) {
                    const lineDiv = document.createElement('div');
                    lineDiv.classList.add('hexagram-line');
                    const lineIndex = 5 - i;
                    if (binaryString[lineIndex] === '0') {
                        lineDiv.classList.add('yin-line');
                    }
                    if (movingYao && movingYao === i + 1) {
                        const dot = document.createElement('span');
                        dot.classList.add('moving-dot');
                        lineDiv.appendChild(dot);
                    }
                    element.appendChild(lineDiv);
                }
            }

            function displayDeepInterpretation(benGuaName, huGuaName, bianGuaName, movingYao, shangGua, xiaGua, shangHuIndex, xiaHuIndex, shangBianIndex, xiaBianIndex) {
                const guaCi = guaCiData[benGuaName];
                if (guaCi) {
                    document.getElementById('guaCi').innerHTML = `<h3>${guaCi.name} - 卦辭：</h3><p>${guaCi.ci}</p>`;
                    const movingYaoText = guaCi.yaoCi[movingYao - 1];
                    document.getElementById('movingYao').innerHTML = `<h3>動爻分析：</h3><p>動爻為第 ${movingYao} 爻，${movingYaoText}</p>`;
                } else {
                    document.getElementById('guaCi').innerHTML = `<h3>卦辭：</h3><p>無特定卦辭，請參考易經原文。</p>`;
                    document.getElementById('movingYao').innerHTML = `<h3>動爻分析：</h3><p>動爻為第 ${movingYao} 爻，需結合卦象具體分析。</p>`;
                }

                const mainFiveElement = guaTable[shangGua].fiveElement;
                const changingFiveElement = guaTable[shangBianIndex].fiveElement;

                document.getElementById('fiveElements').innerHTML = `<h3>五行生克詳解：</h3><p>本卦上卦屬 ${mainFiveElement}，變卦上卦屬 ${changingFiveElement}，其關係為 ${getRelationText(mainFiveElement, changingFiveElement)}</p>`;
                document.getElementById('seasonalAnalysis').innerHTML = `<h3>旺相休囚死分析：</h3><p>本卦五行${mainFiveElement}，當前季節${seasons[mainFiveElement]}時最旺。判斷吉凶需結合占卜日期。</p>`;
                document.getElementById('guaCombination').innerHTML = `<h3>卦象組合：</h3><p>${guaImages[guaNames[shangGua]]} - ${guaImages[guaNames[xiaGua]]}</p>`;
                document.getElementById('application').innerHTML = `<h3>應事範圍：</h3><p>此卦象對應於事業、決策或變化，需結合動爻與五行生克進一步分析。</p>`;
                document.getElementById('suggestion').innerHTML = `<h3>處世之道：</h3><p>根據卦象特性，建議謹慎行事，順應五行生克之勢，審時度勢。</p>`;
                document.getElementById('prediction').innerHTML = `<h3>應期分析：</h3><p>應期可參考動爻${movingYao}與五行${mainFiveElement}的季節旺衰，結合流年、月、日判斷。</p>`;
            }

            function getRelationText(el1, el2) {
                if (!el1 || !el2) return '無關係';
                if (el1 === el2) return `比和（平）`;
                if (fiveElementRelations[el1].generates === el2) return `我生（泄）`;
                if (fiveElementRelations[el1].overcomes === el2) return `我剋（耗）`;
                if (fiveElementRelations[el1].generatedBy === el2) return `生我（吉）`;
                if (fiveElementRelations[el1].overcomeBy === el2) return `剋我（凶）`;
                return '無關係';
            }

            function getJudgement(mainElement, element) {
                if (!mainElement || !element) return '平';
                if (fiveElementRelations[mainElement].generatedBy === element) return '吉';
                if (fiveElementRelations[mainElement].overcomes === element) return '中吉';
                if (fiveElementRelations[mainElement].overcomeBy === element) return '凶';
                if (fiveElementRelations[mainElement].generates === element) return '中凶';
                return '平';
            }

            function displayFiveElementTable(shangGua, xiaGua, shangHuIndex, xiaHuIndex, shangBianIndex, xiaBianIndex) {
                const tableBody = document.getElementById('fiveElementTable');
                tableBody.innerHTML = '';

                const month = parseInt(document.getElementById('month').value) || new Date().getMonth() + 1;
                const guaData = [
                    { name: `本卦上卦 (${guaTable[shangGua].name})`, element: guaTable[shangGua].fiveElement },
                    { name: `本卦下卦 (${guaTable[xiaGua].name})`, element: guaTable[xiaGua].fiveElement },
                    { name: `互卦上卦 (${guaNames[shangHuIndex]})`, element: guaTable[shangHuIndex].fiveElement },
                    { name: `互卦下卦 (${guaNames[xiaHuIndex]})`, element: guaTable[xiaHuIndex].fiveElement },
                    { name: `變卦上卦 (${guaNames[shangBianIndex]})`, element: guaTable[shangBianIndex].fiveElement },
                    { name: `變卦下卦 (${guaNames[xiaBianIndex]})`, element: guaTable[xiaBianIndex].fiveElement }
                ];

                guaData.forEach(data => {
                    const row = tableBody.insertRow();
                    row.insertCell(0).textContent = data.name;
                    row.insertCell(1).textContent = data.element;
                    row.insertCell(2).textContent = getRelationText(guaTable[xiaGua].fiveElement, data.element);
                    row.insertCell(3).textContent = getJudgement(guaTable[xiaGua].fiveElement, data.element);
                    row.insertCell(4).textContent = getWangXiang(data.element, month);
                });
            }

            function getWangXiang(element, month) {
                const season = month === 12 || month === 1 || month === 2 ? '冬' :
                               month >= 3 && month <= 5 ? '春' :
                               month >= 6 && month <= 8 ? '夏' : '秋';
                const wangxiang = {
                    '春': { '木': '旺', '火': '相', '水': '休', '金': '囚', '土': '死' },
                    '夏': { '火': '旺', '土': '相', '木': '休', '水': '囚', '金': '死' },
                    '秋': { '金': '旺', '水': '相', '土': '休', '火': '囚', '木': '死' },
                    '冬': { '水': '旺', '木': '相', '金': '休', '土': '囚', '火': '死' }
                };
                return wangxiang[season][element] || '未知';
            }

            function saveHistory(result) {
                let history = JSON.parse(localStorage.getItem('hexagramHistory')) || [];
                history.unshift(result);
                localStorage.setItem('hexagramHistory', JSON.stringify(history));
            }

            function loadHistory() {
                const historyList = document.getElementById('historyList');
                historyList.innerHTML = '';
                const history = JSON.parse(localStorage.getItem('hexagramHistory')) || [];

                if (history.length === 0) {
                    historyList.innerHTML = '<p style="text-align:center;">無卜卦歷史</p>';
                    return;
                }

                history.forEach(item => {
                    const listItem = document.createElement('div');
                    listItem.classList.add('history-item');
                    listItem.innerHTML = `<p><strong>時間：</strong>${item.date}</p>
                                        <p><strong>本卦：</strong>${item.benGua} <strong>互卦：</strong>${item.huGua} <strong>變卦：</strong>${item.bianGua} <strong>動爻：</strong>${item.movingYao}</p>`;
                    historyList.appendChild(listItem);
                });
            }

            function clearHistory() {
                localStorage.removeItem('hexagramHistory');
                loadHistory();
            }
        });
    </script>
</body>
</html>
