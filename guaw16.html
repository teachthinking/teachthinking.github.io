<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>張老師易經卜卦</title>
  <style>
    body { font-family: "Noto Sans TC", sans-serif; background: #f7f7f7; color: #222; padding: 20px; }
    .container { max-width: 980px; margin: 0 auto; background: #fff; padding: 22px; border-radius: 12px; box-shadow: 0 6px 24px rgba(0, 0, 0, 0.06); }
    h1 { margin: 0 0 6px 0; font-size: 26px; }
    h2.subtitle { margin: 0 0 16px 0; color: #666; font-weight: 400; font-size: 15px; }
    .tab-buttons { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 14px; }
    .tab-button { padding: 8px 14px; border-radius: 8px; border: 0; background: #efefef; cursor: pointer; }
    .tab-button.active { background: #222; color: #fff; }
    .tab-content { display: none; padding-top: 8px; }
    .tab-content.active { display: block; }
    .row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; margin: 8px 0; }
    .hint { font-size: 13px; color: #666; }
    .gua-box { border: 1px solid #e6e6e6; border-radius: 10px; padding: 12px; background: #fafafa; margin-bottom: 12px; }
    .hidden { display: none; }
    button.primary { padding: 9px 16px; background: #222; color: #fff; border-radius: 8px; border: 0; cursor: pointer; }
    input, select, textarea { padding: 8px; border-radius: 8px; border: 1px solid #d0d0d0; font-size: 14px; }
    .pill { display: inline-block; padding: 4px 8px; border-radius: 999px; background: #f0f0f0; font-size: 12px; }
    #line-explanation > div { margin-bottom: 10px; padding-bottom: 8px; border-bottom: 1px dashed #eee; }
    .score-card { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; }
    .score-bar-wrap { flex: 1; height: 10px; background: #eee; border-radius: 6px; overflow: hidden; }
    .score-bar { height: 100%; width: 0; transition: width 0.4s; background: linear-gradient(90deg, #f44336, #ff9800, #4caf50); }
    .score-val { min-width: 36px; text-align: right; font-weight: 600; }
    pre { background: #fafafa; padding: 8px; border-radius: 6px; overflow: auto; }
    .gua-line { font-family: 'Courier New', monospace; font-size: 20px; line-height: 1.2; }
    .gua-line div { padding: 2px 0; }
    .gua-yang { display: flex; align-items: center; justify-content: center; height: 1.2em; }
    .gua-yang::before { content: ''; width: 100%; height: 6px; background: #222; }
    .gua-yin { display: flex; align-items: center; justify-content: space-between; height: 1.2em; }
    .gua-yin::before, .gua-yin::after { content: ''; width: 45%; height: 6px; background: #222; }
    .gua-moving { font-weight: bold; color: #b71c1c; display: flex; align-items: center; justify-content: center; height: 1.2em; }
    .gua-moving.yang::before { content: ''; width: 100%; height: 6px; background: #b71c1c; }
    .gua-moving.yang::after { content: '◎'; margin-left: 8px; font-size: 0.8em; }
    .gua-moving.yin::before, .gua-moving.yin::after { content: ''; width: 45%; height: 6px; background: #b71c1c; }
    .gua-moving.yin::after { content: '×'; margin-left: 8px; font-size: 0.8em; }
    .wuxing-analysis { margin-top: 20px; border-top: 1px dashed #e6e6e6; padding-top: 15px; }
    .wuxing-box { padding: 8px 12px; background: #f0f0f0; border-radius: 8px; margin-bottom: 10px; }
    .wuxing-result { font-weight: bold; }
    .wuxing-desc { font-size: 14px; margin-top: 4px; color: #555; }
    .wuxing-sug { margin-top: 8px; padding: 8px; background: #e0f2f1; border-radius: 6px; border: 1px solid #b2dfdb; }
    .wuxing-sug p { margin: 0; font-size: 14px; color: #00796b; }
    .analysis-item { margin-bottom: 15px; }
    .analysis-item h3 { margin-top: 0; margin-bottom: 8px; border-left: 4px solid #64b5f6; padding-left: 8px; }
    .analysis-item p { margin: 0 0 6px 0; line-height: 1.6; }
    .analysis-item ul { margin: 0; padding-left: 20px; line-height: 1.6; }
    .analysis-item ul li { margin-bottom: 4px; }
    .suggestion { padding: 15px; background: #e8f5e9; border: 1px solid #c8e6c9; border-radius: 8px; }
    .suggestion h3 { color: #2e7d32; border-left-color: #4caf50; }
  </style>
</head>
<body>
  <div class="container">
    <h1>張老師易經卜卦</h1>
    <h2 class="subtitle">輸入三個數字，為您解卦</h2>
    <div class="row">
      <input type="number" id="num1" placeholder="數字1" />
      <input type="number" id="num2" placeholder="數字2" />
      <input type="number" id="num3" placeholder="數字3" />
      <button id="generateBtn" class="primary">生成卦象</button>
    </div>

    <div id="guaResult" class="gua-box hidden">
      <h3>卦象分析</h3>
      <div class="row">
        <span>本卦：</span><b id="mainGuaName"></b>
        <span class="pill" id="mainWuxing"></span>
      </div>
      <div id="mainGuaLines" class="gua-line"></div>
      <div class="row">
        <span>之卦（變卦）：</span><b id="derivedGuaName"></b>
        <span class="pill" id="derivedWuxing"></span>
      </div>
      <div id="derivedGuaLines" class="gua-line"></div>
    </div>

    <div class="tab-buttons">
      <button class="tab-button active" data-tab="tab1">六爻解卦</button>
      <button class="tab-button" data-tab="tab2">五行解卦</button>
      <button id="judgeBtn" class="tab-button">卦象分數</button>
    </div>

    <div id="tab1" class="tab-content active">
      <div id="lineExplanation" class="hidden">
        <h3>爻辭解說</h3>
        <div id="line-explanation"></div>
      </div>
    </div>

    <div id="tab2" class="tab-content">
      <div class="row">
        <select id="questionSelector">
          <option value="1">選擇問事類別...</option>
          <option value="love">感情</option>
          <option value="career">事業</option>
          <option value="wealth">財運</option>
          <option value="health">健康</option>
        </select>
        <button id="analyzeBtn" class="primary">開始分析</button>
      </div>
      <div id="wuxingAnalysis" class="hidden">
        <h3>五行解卦</h3>
        <div id="analysis-output"></div>
      </div>
    </div>

    <div id="judgeBox" class="gua-box hidden">
      <h3>卦象分數</h3>
      <p class="hint">此分數為綜合判斷，僅供參考。</p>
      <div id="judgmentScores"></div>
    </div>
  </div>

  <script>
    let hexagramsData;
    let trigramExplanationsData;
    let wuxingExplanationsData;
    let currentResult;
    let dataReady = false;

    const trigramsMap = {
      '乾': [1, 1, 1], '兌': [1, 1, 0], '離': [1, 0, 1], '震': [0, 0, 1],
      '巽': [0, 1, 0], '坎': [0, 1, 1], '艮': [1, 0, 0], '坤': [0, 0, 0]
    };
    const trigramWuxing = {
      '乾': '金', '兌': '金', '離': '火', '震': '木',
      '巽': '木', '坎': '水', '艮': '土', '坤': '土'
    };

    async function loadData() {
      try {
        const [hexagramsRes, trigramsRes, wuxingRes] = await Promise.all([
          fetch('hexagrams.json.txt'),
          fetch('trigram_explanations.json.txt'),
          fetch('wuxing_explanations.json.txt')
        ]);
        hexagramsData = await hexagramsRes.json();
        trigramExplanationsData = await trigramsRes.json();
        wuxingExplanationsData = await wuxingRes.json();
        dataReady = true;
      } catch (error) {
        console.error("Failed to load data:", error);
        alert('載入資料失敗，請檢查檔案是否存在。');
      }
    }

    loadData();

    function getGuaInfo(lines) {
      const lineStr = lines.map(l => (l === 7 || l === 9) ? 1 : 0).join('');
      for (const name in hexagramsData) {
        const hexagramLines = hexagramsData[name].lines.map(l => l.index > 6 ? 1 : 0);
        if (hexagramLines.join('') === lineStr) {
          return { name, ...hexagramsData[name] };
        }
      }
      return null;
    }

    function renderGua(lines, containerId) {
      const container = document.getElementById(containerId);
      container.innerHTML = '';
      lines.forEach(line => {
        const div = document.createElement('div');
        if (line === 9) {
          div.className = 'gua-moving yang';
        } else if (line === 6) {
          div.className = 'gua-moving yin';
        } else if (line === 7) {
          div.className = 'gua-yang';
        } else if (line === 8) {
          div.className = 'gua-yin';
        }
        container.appendChild(div);
      });
    }

    function renderLineExplanation(gua, movingLines) {
      const container = document.getElementById('line-explanation');
      container.innerHTML = '';
      if (movingLines.length > 0) {
        document.getElementById('lineExplanation').classList.remove('hidden');
        movingLines.forEach(lineIndex => {
          const lineData = gua.lines.find(l => l.index === lineIndex);
          if (lineData) {
            const div = document.createElement('div');
            div.innerHTML = `<h4>${lineData.text}</h4><p>${lineData.meaning}</p>`;
            container.appendChild(div);
          }
        });
      } else {
        document.getElementById('lineExplanation').classList.add('hidden');
      }
    }

    function getTrigramNameByBinary(trigramLines) {
      const trigramStr = trigramLines.join('');
      for (const name in trigramsMap) {
        if (trigramsMap[name].join('') === trigramStr) {
          return name;
        }
      }
      return '未知';
    }

    function getTiYongGua(mainGua, movingLineIndex) {
      const mainLinesBinary = mainGua.lines.map(l => l.index > 6 ? 1 : 0);
      const lowerTrigramBinary = mainLinesBinary.slice(0, 3);
      const upperTrigramBinary = mainLinesBinary.slice(3, 6);
      
      const lowerTrigramName = getTrigramNameByBinary(lowerTrigramBinary);
      const upperTrigramName = getTrigramNameByBinary(upperTrigramBinary);

      let tiGua, yongGua;

      if (movingLineIndex <= 3) {
        tiGua = { name: upperTrigramName, wuxing: trigramWuxing[upperTrigramName] };
        yongGua = { name: lowerTrigramName, wuxing: trigramWuxing[lowerTrigramName] };
      } else {
        tiGua = { name: lowerTrigramName, wuxing: trigramWuxing[lowerTrigramName] };
        yongGua = { name: upperTrigramName, wuxing: trigramWuxing[upperTrigramName] };
      }
      return { tiGua, yongGua };
    }

    function getWuxingRelationship(tiWuxing, yongWuxing) {
      const wuxingRelation = {
        '金': { '金': '比和', '木': '剋', '水': '生', '火': '被剋', '土': '生' },
        '木': { '金': '被剋', '木': '比和', '水': '生', '火': '生', '土': '剋' },
        '水': { '金': '生', '木': '生', '水': '比和', '火': '剋', '土': '被剋' },
        '火': { '金': '剋', '木': '生', '水': '被剋', '火': '比和', '土': '生' },
        '土': { '金': '生', '木': '被剋', '水': '剋', '火': '生', '土': '比和' }
      };
      return wuxingRelation[tiWuxing][yongWuxing];
    }
    
    function renderQuestionAnalysis(result, questionType) {
      const analysisDiv = document.getElementById('analysis-output');
      analysisDiv.innerHTML = '';
      document.getElementById('wuxingAnalysis').classList.remove('hidden');

      const { mainGua, derivedGua, moving } = result;
      const movingLineIndex = moving[0];
      const lineData = mainGua.lines.find(l => l.index === movingLineIndex);

      // 基本分析
      const basicAnalysisHtml = `
          <h3>基本分析</h3>
          <p>您所問的事，得到<b>${mainGua.name}</b>卦，變爻在<b>第${movingLineIndex}爻</b>，成為<b>${derivedGua.name}</b>卦。</p>
          <p>此爻的爻辭為：「${lineData.text}」</p>
          <p>其解釋為：「${lineData.meaning}」</p>
      `;
      analysisDiv.innerHTML += `<div class="analysis-item">${basicAnalysisHtml}</div>`;

      // 八卦體用分析
      const { tiGua, yongGua } = getTiYongGua(mainGua, movingLineIndex);
      const tiExplanation = trigramExplanationsData[tiGua.name];
      const yongExplanation = trigramExplanationsData[yongGua.name];
      const trigramAnalysisHtml = `
          <h3>八卦體用分析</h3>
          <p><b>體卦</b>：<b>${tiGua.name}</b>，五行屬<b>${tiGua.wuxing}</b>。代表問事者本身，也代表事物本身。
            <p class="hint">解釋：${tiExplanation[questionType]}</p>
          </p>
          <p><b>用卦</b>：<b>${yongGua.name}</b>，五行屬<b>${yongGua.wuxing}</b>。代表問事所涉及的對方、環境或事物。
            <p class="hint">解釋：${yongExplanation[questionType]}</p>
          </p>
      `;
      analysisDiv.innerHTML += `<div class="analysis-item">${trigramAnalysisHtml}</div>`;

      // 五行生剋分析
      const wuxingRelationship = getWuxingRelationship(tiGua.wuxing, yongGua.wuxing);
      const wuxingAnalysisHtml = `
          <h3>五行生剋分析</h3>
          <p>體用關係為：<b>${tiGua.wuxing}</b>${wuxingRelationship}<b>${yongGua.wuxing}</b>。</p>
      `;
      analysisDiv.innerHTML += `<div class="analysis-item">${wuxingAnalysisHtml}</div>`;

      // 卦象建議
      if (wuxingExplanationsData[wuxingRelationship] && wuxingExplanationsData[wuxingRelationship][questionType]) {
          const suggestionObj = wuxingExplanationsData[wuxingRelationship][questionType];
          let suggestionHtml = `<h3>綜合建議</h3>`;
          suggestionHtml += `<p>${suggestionObj.overall.replace(/\${tiGua.wuxing}/g, tiGua.wuxing).replace(/\${yongGua.wuxing}/g, yongGua.wuxing)}</p>`;
          
          if (suggestionObj.specific && suggestionObj.specific[questionType]) {
              const specificContent = suggestionObj.specific[questionType];
              if (Object.keys(specificContent).length > 0) {
                  suggestionHtml += '<ul>';
                  for (const wuxing in specificContent) {
                      const content = specificContent[wuxing];
                      if (content) {
                          suggestionHtml += `<li>**${wuxing}**：${content}</li>`;
                      }
                  }
                  suggestionHtml += '</ul>';
              }
          }
          analysisDiv.innerHTML += `<div class="analysis-item suggestion">${suggestionHtml}</div>`;
      }
    }

    function renderJudgmentScores(gua) {
      const scores = gua.judgment;
      const container = document.getElementById('judgmentScores');
      container.innerHTML = '';

      const categories = [
        { name: '整體運勢', key: 'overall' },
        { name: '問人', key: 'people' },
        { name: '問事', key: 'affairs' },
        { name: '問時機', key: 'time' },
        { name: '問地點', key: 'place' },
        { name: '問物品', key: 'object' }
      ];

      categories.forEach(cat => {
        const score = scores[cat.key];
        const scoreCard = document.createElement('div');
        scoreCard.className = 'score-card';
        scoreCard.innerHTML = `
          <span>${cat.name}：</span>
          <div class="score-bar-wrap">
            <div class="score-bar" style="width: ${score * 10}%;"></div>
          </div>
          <span class="score-val">${score} / 10</span>
        `;
        container.appendChild(scoreCard);
      });
    }

    document.getElementById('generateBtn').addEventListener('click', () => {
      const nums = [
        parseInt(document.getElementById('num1').value),
        parseInt(document.getElementById('num2').value),
        parseInt(document.getElementById('num3').value)
      ].filter(n => !isNaN(n));

      if (nums.length !== 3) {
        alert('請輸入三個有效的數字');
        return;
      }
      
      const mainLines = nums.map(n => n % 6 === 0 ? 6 : (n % 6 === 1 ? 7 : (n % 6 === 2 ? 8 : (n % 6 === 3 ? 9 : (n % 6 === 4 ? 7 : 8)))));
      const derivedLines = mainLines.map(line => {
        if (line === 6) return 7;
        if (line === 9) return 8;
        return line;
      });

      const movingLines = mainLines.reduce((acc, line, index) => {
        if (line === 6 || line === 9) {
          acc.push(index + 1);
        }
        return acc;
      }, []);

      const mainGua = getGuaInfo(mainLines);
      const derivedGua = getGuaInfo(derivedLines);

      if (mainGua && derivedGua) {
        currentResult = { mainGua, derivedGua, moving: movingLines };
        document.getElementById('guaResult').classList.remove('hidden');
        document.getElementById('mainGuaName').textContent = mainGua.name;
        document.getElementById('derivedGuaName').textContent = derivedGua.name;
        renderGua(mainLines, 'mainGuaLines');
        renderGua(derivedLines, 'derivedGuaLines');
        renderLineExplanation(mainGua, movingLines);
      } else {
        alert('卦象生成失敗，請檢查輸入。');
      }
    });

    document.querySelectorAll('.tab-button').forEach(button => {
      button.addEventListener('click', () => {
        document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
        button.classList.add('active');
        document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
        document.getElementById('wuxingAnalysis').classList.add('hidden');
        document.getElementById('judgeBox').classList.add('hidden');
        if (button.dataset.tab) {
          document.getElementById(button.dataset.tab).classList.add('active');
        }
      });
    });

    document.getElementById('analyzeBtn').addEventListener('click', () => {
      if (!dataReady) {
        alert('資料仍在載入中，請稍候再試。');
        return;
      }
      const questionType = document.getElementById('questionSelector').value;
      if (questionType === '1') {
        alert('請先選擇一個問事類別！');
        return;
      }
      if (!currentResult) {
        alert('請先生成卦象');
        return;
      }
      if (currentResult.moving.length !== 1) {
        alert('五行解卦僅適用於單一動爻的情況。');
        return;
      }
      renderQuestionAnalysis(currentResult, questionType);
    });

    document.getElementById('judgeBtn').addEventListener('click', () => {
      if (!currentResult) {
        alert('請先生成卦象');
        return;
      }
      document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
      document.getElementById('judgeBtn').classList.add('active');
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      document.getElementById('wuxingAnalysis').classList.add('hidden');

      document.getElementById('judgeBox').classList.remove('hidden');
      renderJudgmentScores(currentResult.mainGua);
    });
  </script>
</body>
</html>
