
<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>張老師易經卜卦</title>
  <style>
    body{font-family:"Noto Sans TC",sans-serif;background:#f7f7f7;color:#222;padding:20px}
    .container{max-width:980px;margin:0 auto;background:#fff;padding:22px;border-radius:12px;box-shadow:0 6px 24px rgba(0,0,0,.06)}
    h1{margin:0 0 6px 0;font-size:26px}
    h2.subtitle{margin:0 0 16px 0;color:#666;font-weight:400;font-size:15px}
    .tab-buttons{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:14px}
    .tab-button{padding:8px 14px;border-radius:8px;border:0;background:#efefef;cursor:pointer}
    .tab-button.active{background:#222;color:#fff}
    .tab-content{display:none;padding-top:8px}
    .tab-content.active{display:block}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin:8px 0}
    label{font-size:14px;color:#555}
    input[type=number]{padding:6px 8px;border:1px solid #ccc;border-radius:6px;width:60px;text-align:center}
    button{padding:8px 14px;border-radius:6px;border:0;background:#2980b9;color:#fff;cursor:pointer;font-size:14px;transition:background-color .3s}
    button:hover{background:#3498db}
    .result-box{background:#f0f4f7;border-radius:8px;padding:16px;margin-top:20px;box-shadow:inset 0 1px 3px rgba(0,0,0,.06)}
    .result-section h3{margin:0 0 8px;font-size:18px;border-bottom:1px solid #ddd;padding-bottom:6px;margin-bottom:12px}
    .result-section p{margin:4px 0}
    .hexagram-visual{font-family:monospace;font-size:16px;line-height:1.6;white-space:pre}
    .analysis-box{margin-top:20px;border-top:1px dashed #ccc;padding-top:20px}
    .analysis-item{background:#fafafa;padding:14px;border-radius:8px;margin-bottom:12px;border:1px solid #eee}
    .analysis-item h4{margin:0 0 8px;font-size:16px;color:#444}
    .analysis-item p, .analysis-item ul{margin:0;font-size:14px;line-height:1.8}
    .analysis-item ul{padding-left:20px;list-style-type:disc}
    .analysis-item ul li{margin-bottom:4px}
    .hidden{display:none}
    select{padding:6px 8px;border-radius:6px;border:1px solid #ccc}
  </style>
</head>
<body>

<div class="container">
  <h1>易經卜卦工具</h1>
  <h2 class="subtitle">輸入三個隨機數字，生成您的卦象與解析。</h2>

  <div class="row">
    <label for="num1">數字一:</label>
    <input type="number" id="num1" value="0" min="0" />
    <label for="num2">數字二:</label>
    <input type="number" id="num2" value="0" min="0" />
    <label for="num3">數字三:</label>
    <input type="number" id="num3" value="0" min="0" />
    <button id="generateBtn">生成卦象</button>
  </div>
  <div class="row">
    <button id="analyzeBtn" class="hidden">詳細分析</button>
    <select id="questionSelector" class="hidden">
        <option value="1">請選擇問事類別</option>
        <option value="love">感情</option>
        <option value="career">事業</option>
        <option value="wealth">財運</option>
        <option value="health">健康</option>
        <option value="relationship">人際關係</option>
        <option value="life">人生運勢</option>
        <option value="guidance">求問指引</option>
    </select>
  </div>
  
  <div id="resultBox" class="result-box hidden">
    </div>
  
</div>

<script>
    let trigramExplanations = {};
    let hexagrams = {};
    let quotes = [];
    let wuxingExplanations = {};
    let dataReady = false;
    let currentResult = null;
    
    // 定義卦象的對應關係
    const hexagramMap = {
        '1': '乾', '2': '兌', '3': '離', '4': '震', '5': '巽', '6': '坎', '7': '艮', '8': '坤'
    };

    // 每個八卦的五行屬性
    const wuxingMap = {
        '乾': '金', '兌': '金',
        '離': '火',
        '震': '木', '巽': '木',
        '坎': '水',
        '艮': '土', '坤': '土'
    };

    // 五行生剋關係表
    const wuxingRelations = {
        '金': { '金': '體用同宮', '木': '體剋用', '水': '體生用', '火': '用剋體', '土': '用生體' },
        '木': { '金': '用剋體', '木': '體用同宮', '水': '用生體', '火': '體生用', '土': '體剋用' },
        '水': { '金': '用生體', '木': '體生用', '水': '體用同宮', '火': '體剋用', '土': '用剋體' },
        '火': { '金': '體剋用', '木': '用生體', '水': '用剋體', '火': '體用同宮', '土': '體生用' },
        '土': { '金': '體生用', '木': '用剋體', '水': '體剋用', '火': '用生體', '土': '體用同宮' }
    };
    
    // 載入所有JSON檔案
    function loadData() {
        Promise.all([
            fetch('trigram_explanations.json'),
            fetch('hexagrams.json'),
            fetch('quotes.json'),
            fetch('wuxing_explanations.json')
        ]).then(responses => {
            return Promise.all(responses.map(response => {
                if (!response.ok) {
                    throw new Error(`Failed to load ${response.url}: ${response.status}`);
                }
                return response.json();
            }));
        }).then(data => {
            trigramExplanations = data[0];
            hexagrams = data[1];
            quotes = data[2];
            wuxingExplanations = data[3];
            dataReady = true;
            console.log("All data loaded.");
        }).catch(error => {
            console.error('Error loading JSON data:', error);
            alert('載入資料失敗：' + error.message);
        });
    }

    // *** 修正一：新增輔助函式，從六十四卦名中提取上下兩個單卦名 ***
    function getTrigrams(hexagramName) {
        // 從 hexagrams.json.txt 的鍵值中，根據格式提取單卦
        // 假設卦名格式為 "乾為天", "雷火豐" 或 "天火同人"
        const nameMapping = {
            '乾': '乾', '坤': '坤', '震': '震', '巽': '巽',
            '坎': '坎', '離': '離', '艮': '艮', '兌': '兌',
            '天': '乾', '地': '坤', '雷': '震', '風': '巽',
            '水': '坎', '火': '離', '山': '艮', '澤': '兌'
        };

        const cleanedName = hexagramName.replace(/為/, '');
        const parts = [];
        let i = 0;
        while (i < cleanedName.length) {
            let found = false;
            // 檢查雙字卦名，如"天火"
            if (i + 1 < cleanedName.length) {
                const twoChars = cleanedName.substring(i, i + 2);
                if (nameMapping[twoChars]) {
                    parts.push(twoChars);
                    i += 2;
                    found = true;
                }
            }
            // 檢查單字卦名，如"乾"
            if (!found) {
                parts.push(cleanedName.substring(i, i + 1));
                i++;
            }
        }
        
        return {
            upper: nameMapping[parts[0]],
            lower: nameMapping[parts[1]]
        };
    }
    // *** 修正一：結束 ***
    
    // 卦象生成邏輯 (這部分保持不變)
    function generateHexagram(num1, num2, num3) {
        const lines = [];
        let movingLines = [];
        
        const getLine = (num) => {
            let remainder = num % 6;
            if (remainder === 0) remainder = 6;
            if (remainder === 6 || remainder === 9) {
                movingLines.push(lines.length + 1);
            }
            return remainder;
        };
        
        for (let i = 0; i < 3; i++) lines.push(getLine(num1));
        for (let i = 0; i < 3; i++) lines.push(getLine(num2));
        
        const originalHexagram = getHexagramFromLines(lines);
        const changedHexagram = getChangedHexagram(lines, movingLines);
        
        const originalGua = hexagrams[originalHexagram.name];
        
        let yongGua, tiGua;
        if (movingLines[0] >= 4) {
            yongGua = { name: originalHexagram.upper, wuxing: wuxingMap[originalHexagram.upper] };
            tiGua = { name: originalHexagram.lower, wuxing: wuxingMap[originalHexagram.lower] };
        } else {
            yongGua = { name: originalHexagram.lower, wuxing: wuxingMap[originalHexagram.lower] };
            tiGua = { name: originalHexagram.upper, wuxing: wuxingMap[originalHexagram.upper] };
        }

        const guaRelation = wuxingRelations[yongGua.wuxing][tiGua.wuxing];

        return {
            original: originalHexagram,
            changed: changedHexagram,
            moving: movingLines,
            yongGua: yongGua,
            tiGua: tiGua,
            guaRelation: guaRelation
        };
    }

    function getHexagramFromLines(lines) {
        const upperLines = lines.slice(3, 6);
        const lowerLines = lines.slice(0, 3);
        
        const upperTrigramIndex = getTrigramIndex(upperLines);
        const lowerTrigramIndex = getTrigramIndex(lowerLines);
        
        const upperTrigram = hexagramMap[upperTrigramIndex];
        const lowerTrigram = hexagramMap[lowerTrigramIndex];
        
        let hexagramName = '';
        for (const name in hexagrams) {
            const trigs = getTrigrams(name);
            if (trigs.upper === upperTrigram && trigs.lower === lowerTrigram) {
                hexagramName = name;
                break;
            }
        }
        
        return {
            name: hexagramName,
            upper: upperTrigram,
            lower: lowerTrigram,
            lines: lines
        };
    }

    function getTrigramIndex(lines) {
        const binary = lines.map(line => (line === 6 || line === 9) ? 0 : 1).join('');
        const decimal = parseInt(binary, 2);
        return (decimal + 1).toString();
    }
    
    function getChangedHexagram(originalLines, movingLines) {
        const changedLines = originalLines.map(line => {
            if (line === 6) return 7;
            if (line === 9) return 8;
            return line;
        });
        
        return getHexagramFromLines(changedLines);
    }
    
    function renderResult(result) {
        const resultBox = document.getElementById('resultBox');
        
        let html = '';
        
        html += `<div class="result-section"><h3>本卦：${result.original.name}</h3>`;
        html += `<div class="hexagram-visual">`;
        for (let i = 5; i >= 0; i--) {
            const line = result.original.lines[i];
            const moving = result.moving.includes(i + 1);
            const lineText = (line === 6) ? '--- X ---' : (line === 9) ? '--- O ---' : (line === 8) ? '--- ---' : '---  ---';
            html += `${lineText} ${moving ? '(動爻)' : ''}\n`;
        }
        html += `</div></div>`;
        
        html += `<div class="result-section"><h3>變卦：${result.changed.name}</h3>`;
        html += `<div class="hexagram-visual">`;
        for (let i = 5; i >= 0; i--) {
            const line = result.changed.lines[i];
            const lineText = (line === 7) ? '---  ---' : '--- ---';
            html += `${lineText}\n`;
        }
        html += `</div></div>`;
        
        if (result.moving.length > 0) {
            html += `<div class="result-section"><h3>動爻</h3>`;
            html += `<p>變動爻為：${result.moving.join('、')}爻</p></div>`;
        }
        
        resultBox.innerHTML = html;
        resultBox.classList.remove('hidden');
        document.getElementById('analyzeBtn').classList.remove('hidden');
        document.getElementById('questionSelector').classList.remove('hidden');
    }
    
    // *** 修正二：只修改八卦解析部分，保留原有邏輯和介面 ***
    function renderQuestionAnalysis(result) {
        const analysisDiv = document.createElement('div');
        analysisDiv.classList.add('analysis-box');
        
        const questionType = document.getElementById('questionSelector').value;
        const typeMapping = {
            'love': '感情', 'career': '事業', 'wealth': '財運',
            'health': '健康', 'relationship': '人際關係',
            'life': '人生運勢', 'guidance': '求問指引'
        };
        const questionName = typeMapping[questionType];

        let html = '';

        // *** 修正：使用 getTrigrams 輔助函式來獲取八卦解釋 ***
        const originalTrigrams = getTrigrams(result.original.name);
        const changedTrigrams = getTrigrams(result.changed.name);

        const originalUpperTrigram = trigramExplanations[originalTrigrams.upper];
        const originalLowerTrigram = trigramExplanations[originalTrigrams.lower];
        const changedUpperTrigram = trigramExplanations[changedTrigrams.upper];
        const changedLowerTrigram = trigramExplanations[changedTrigrams.lower];

        // 顯示本卦的八卦解釋
        html += `<div class="analysis-item"><h4>【本卦八卦解析】</h4>`;
        if (originalUpperTrigram) {
            html += `<p><strong>上卦(${originalTrigrams.upper})：</strong>${originalUpperTrigram[questionType] || '無資料'}</p>`;
        }
        if (originalLowerTrigram) {
            html += `<p><strong>下卦(${originalTrigrams.lower})：</strong>${originalLowerTrigram[questionType] || '無資料'}</p>`;
        }
        html += `</div>`;

        // 顯示變卦的八卦解釋
        html += `<div class="analysis-item"><h4>【變卦八卦解析】</h4>`;
        if (changedUpperTrigram) {
            html += `<p><strong>上卦(${changedTrigrams.upper})：</strong>${changedUpperTrigram[questionType] || '無資料'}</p>`;
        }
        if (changedLowerTrigram) {
            html += `<p><strong>下卦(${changedTrigrams.lower})：</strong>${changedLowerTrigram[questionType] || '無資料'}</p>`;
        }
        html += `</div>`;
        // *** 修正結束 ***

        // 五行分析 (這部分保持不變)
        if (result.moving.length === 1) {
            const guaRelation = result.guaRelation;
            const suggestionObj = wuxingExplanations[guaRelation];
            
            if (suggestionObj) {
                const guaRelationName = {
                    "用生體": "用生體 (大吉)", "體生用": "體生用 (次吉)",
                    "體剋用": "體剋用 (次凶)", "用剋體": "用剋體 (大凶)",
                    "體用同宮": "體用同宮 (平)"
                };
                let suggestionHtml = `<h4>【五行解卦】</h4>`;
                suggestionHtml += `<p><strong>卦象關係：</strong>${guaRelationName[guaRelation] || ''}</p>`;
                
                if (suggestionObj.overall) {
                    suggestionHtml += `<p><strong>總體分析：</strong>${suggestionObj.overall}</p>`;
                }

                if (suggestionObj[questionType] && typeof suggestionObj[questionType] === 'object') {
                    const specificContent = suggestionObj[questionType];
                    suggestionHtml += `<p><strong>針對${questionName}的建議：</strong></p>`;
                    suggestionHtml += `<ul>`;
                    for (const key in specificContent) {
                        if (specificContent[key]) {
                            suggestionHtml += `<li><strong>${key}：</strong>${specificContent[key]}</li>`;
                        }
                    }
                    suggestionHtml += `</ul>`;
                }

                analysisDiv.innerHTML += `<div class="analysis-item suggestion">${suggestionHtml}</div>`;
            } else {
                analysisDiv.innerHTML += `<div class="analysis-item suggestion"><h4>【五行解卦】</h4><p>抱歉，無法找到對應的五行解釋。</p></div>`;
            }
        }
        
        const oldAnalysisBox = document.querySelector('.analysis-box');
        if (oldAnalysisBox) oldAnalysisBox.remove();
        document.getElementById('resultBox').appendChild(analysisDiv);
    }
    // *** 修正二：結束 ***
    
    document.getElementById('generateBtn').addEventListener('click', () => {
        const num1 = parseInt(document.getElementById('num1').value);
        const num2 = parseInt(document.getElementById('num2').value);
        const num3 = parseInt(document.getElementById('num3').value);
        
        if (isNaN(num1) || isNaN(num2) || isNaN(num3) || num1 <= 0 || num2 <= 0 || num3 <= 0) {
            alert('請輸入正整數！');
            return;
        }
        
        if (!dataReady) {
            alert('資料仍在載入中，請稍候再試。');
            return;
        }

        currentResult = generateHexagram(num1, num2, num3);
        renderResult(currentResult);
    });

    document.getElementById('analyzeBtn').addEventListener('click', () => {
        if (!currentResult) {
            alert('請先生成卦象');
            return;
        }
        const questionType = document.getElementById('questionSelector').value;
        if (questionType === '1') {
            alert('請先選擇一個問事類別！');
            return;
        }
        if (currentResult.moving.length !== 1) {
            alert('五行解卦僅適用於單一動爻的情況，本卦不適用。');
            return;
        }
        
        renderQuestionAnalysis(currentResult);
    });

    loadData();
</script>

</body>
</html>
