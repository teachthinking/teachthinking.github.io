<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>梅花心易｜五行定吉凶（五面向分析 Demo）</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .tab-active { @apply border-b-2 border-slate-900 text-slate-900; }
    .hexagram-lines { font-family: monospace; white-space: pre; }
    .explanation { display: none; }
    .explanation.active { display: block; }
  </style>
</head>
<body class="bg-gradient-to-b from-white to-slate-50 text-slate-800 min-h-screen">
  <div class="max-w-5xl mx-auto p-6 md:p-10 space-y-6">
    <header class="flex items-center justify-between">
      <h1 class="text-2xl md:text-3xl font-bold tracking-tight">梅花心易｜五行定吉凶（五面向分析 Demo）</h1>
      <button id="resetBtn" class="px-3 py-2 text-sm rounded-xl border shadow-sm hover:bg-slate-50">重置示例</button>
    </header>
    <!-- 輸入區 -->
    <section class="bg-white rounded-2xl shadow-sm border p-5">
      <h2 class="font-semibold mb-4">輸入區</h2>
      <div class="grid md:grid-cols-3 gap-4">
        <div>
          <label class="text-sm font-medium">取卦方式</label>
          <select id="methodSelect" class="mt-1 w-full border rounded-xl p-2">
            <option value="manual">手動輸入</option>
            <option value="number">數字取卜</option>
            <option value="time">時間取卦</option>
          </select>
        </div>
        <div id="manualInput" class="grid md:grid-cols-3 gap-4 col-span-3">
          <div>
            <label class="text-sm font-medium">下卦（內卦）</label>
            <select id="lowerSelect" class="mt-1 w-full border rounded-xl p-2"></select>
          </div>
          <div>
            <label class="text-sm font-medium">上卦（外卦）</label>
            <select id="upperSelect" class="mt-1 w-full border rounded-xl p-2"></select>
          </div>
          <div>
            <label class="text-sm font-medium">動爻（1~6，自下而上）</label>
            <input id="movingInput" type="number" min="1" max="6" step="1" class="mt-1 w-full border rounded-xl p-2" value="1" />
          </div>
        </div>
        <div id="numberInput" class="hidden col-span-3">
          <label class="text-sm font-medium">輸入數字（例如：123）</label>
          <input id="numberValue" type="number" class="mt-1 w-full border rounded-xl p-2" />
          <p class="text-xs text-slate-500 mt-1">使用輸入數字除8取餘得下卦，上卦用數字+1除8，動爻用數字除6餘1-6。</p>
        </div>
        <div id="timeInput" class="hidden col-span-3">
          <label class="text-sm font-medium">選擇日期時間</label>
          <input id="datetimeValue" type="datetime-local" class="mt-1 w-full border rounded-xl p-2" />
          <p class="text-xs text-slate-500 mt-1">年+月+日除8得下卦，時除8得上卦，總和除6得動爻（+1確保1-6）。</p>
        </div>
      </div>
    </section>

    <!-- 推算結果 -->
    <section class="bg-white rounded-2xl shadow-sm border p-5">
      <h2 class="font-semibold mb-4">推算結果</h2>
      <div class="grid md:grid-cols-3 gap-4 text-sm" id="resultCards">
        <div>
          <div class="font-medium">本卦</div>
          <div id="baseName"></div>
          <div id="baseSymbol" style="font-size: 2em;"></div>
          <div id="baseHexagram" class="hexagram-lines"></div>
          <div id="baseDictum"></div>
          <div id="baseLower"></div>
          <div id="baseUpper"></div>
          <div id="baseRelation"></div>
          <div id="movingDictum"></div>
        </div>
        <div>
          <div class="font-medium">互卦</div>
          <div id="mutualName"></div>
          <div id="mutualSymbol" style="font-size: 2em;"></div>
          <div id="mutualHexagram" class="hexagram-lines"></div>
          <div id="mutualDictum"></div>
          <div id="mutualLower"></div>
          <div id="mutualUpper"></div>
          <div id="mutualRelation"></div>
        </div>
        <div>
          <div class="font-medium">變卦</div>
          <div id="changedName"></div>
          <div id="changedSymbol" style="font-size: 2em;"></div>
          <div id="changedHexagram" class="hexagram-lines"></div>
          <div id="changedDictum"></div>
          <div id="changedLower"></div>
          <div id="changedUpper"></div>
          <div id="changedRelation"></div>
        </div>
      </div>
    </section>

    <!-- 應期 -->
    <section class="bg-white rounded-2xl shadow-sm border p-5">
      <h2 class="font-semibold mb-4">應期分析</h2>
      <div id="responsePeriod" class="text-sm"></div>
    </section>

    <!-- 五行生克圖 -->
    <section class="bg-white rounded-2xl shadow-sm border p-5">
      <h2 class="font-semibold mb-4">五行生克圖</h2>
      <canvas id="fiveElementsChart" width="600" height="600" class="mx-auto"></canvas>
    </section>

    <!-- 五行旺相休囚死分析 -->
    <section class="bg-white rounded-2xl shadow-sm border p-5">
      <h2 class="font-semibold mb-4">五行旺相休囚死分析</h2>
      <div id="elementsStatus" class="text-sm"></div>
    </section>

    <!-- 分頁 -->
    <section class="bg-white rounded-2xl shadow-sm border p-5">
      <div class="flex gap-4 border-b pb-2 text-sm">
        <button class="tab-btn tab-active" data-tab="human">人</button>
        <button class="tab-btn" data-tab="event">事</button>
        <button class="tab-btn" data-tab="time">時</button>
        <button class="tab-btn" data-tab="place">地</button>
        <button class="tab-btn" data-tab="object">物</button>
      </div>
      <div class="pt-4 text-sm leading-7">
        <div id="tab-human" class="tab-pane"></div>
        <div id="tab-event" class="tab-pane hidden"></div>
        <div id="tab-time" class="tab-pane hidden"></div>
        <div id="tab-place" class="tab-pane hidden"></div>
        <div id="tab-object" class="tab-pane hidden"></div>
      </div>
    </section>

    <footer class="text-xs text-slate-500 text-center pt-2">© <span id="year"></span> 梅花心易前端示範 — 可自由改作商業/教學用途。</footer>
  </div>

  <script>
    const TRIGRAMS = [
      { key: "乾", bin: [1,1,1], element: "金", symbol: "☰", color: "#FFD700" },
      { key: "兌", bin: [0,1,1], element: "金", symbol: "☱", color: "#FFD700" },
      { key: "離", bin: [1,0,1], element: "火", symbol: "☲", color: "#FF0000" },
      { key: "震", bin: [0,0,1], element: "木", symbol: "☳", color: "#008000" },
      { key: "巽", bin: [1,1,0], element: "木", symbol: "☴", color: "#008000" },
      { key: "坎", bin: [0,1,0], element: "水", symbol: "☵", color: "#0000FF" },
      { key: "艮", bin: [1,0,0], element: "土", symbol: "☶", color: "#A52A2A" },
      { key: "坤", bin: [0,0,0], element: "土", symbol: "☷", color: "#A52A2A" },
    ];

    const HEXAGRAMS = {
  "乾乾": { "name": "乾為天", "symbol": "䷀", "dictum": "元亨利貞。", "yaos": ["初九：潛龍勿用。", "九二：見龍在田，利見大人。", "九三：君子終日乾乾，夕惕若厲，无咎。", "九四：或躍在淵，无咎。", "九五：飛龍在天，利見大人。", "上九：亢龍有悔。"] },
  "坤坤": { "name": "坤為地", "symbol": "䷁", "dictum": "元亨。利牝馬之貞。君子有攸往，先迷後得主，利西南得朋，東北喪朋。安貞吉。", "yaos": ["初六：履霜，堅冰至。", "六二：直方大，不習无不利。", "六三：含章可貞，或從王事，无成有終。", "六四：括囊，无咎无譽。", "六五：黃裳元吉。", "上六：龍戰于野，其血玄黃。"] },
  "震坎": { "name": "屯", "symbol": "䷂", "dictum": "元亨利貞，勿用有攸往，利建侯。", "yaos": ["初九：磐桓，利居貞，利建侯。", "六二：屯如邅如，乘馬班如。匪寇婚媾，女子貞不字，十年乃字。", "六三：即鹿无虞，惟入于林中，君子幾不如捨，往吝。", "六四：乘馬班如，求婚媾，往吉，无不利。", "九五：屯其膏，小貞吉，大貞凶。", "上六：乘馬班如，泣血漣如。"] },
  "艮坎": { "name": "蒙", "symbol": "䷃", "dictum": "亨。匪我求童蒙，童蒙求我。初筮告，再三瀆，瀆則不告。利貞。", "yaos": ["初六：發蒙，利用刑人，用說桎梏，以往吝。", "九二：包蒙吉，納婦吉，子克家。", "六三：勿用取女，見金夫，不有躬，无攸利。", "六四：困蒙，吝。", "六五：童蒙，吉。", "上九：擊蒙，不利為寇，利禦寇。"] },
  "坎乾": { "name": "需", "symbol": "䷄", "dictum": "有孚，光亨，貞吉。利涉大川。", "yaos": ["初九：需于郊，利用恆，无咎。", "九二：需于沙，小有言，終吉。", "九三：需于泥，致寇至。", "六四：需于血，出自穴。", "九五：需于酒食，貞吉。", "上六：入于穴，有不速之客三人來，敬之終吉。"] },
  "乾坎": { "name": "訟", "symbol": "䷅", "dictum": "有孚窒。惕中吉，終凶。利見大人，不利涉大川。", "yaos": ["初六：不永所事，小有言，終吉。", "九二：不克訟，歸而逋，其邑人三百戶无眚。", "六三：食舊德，貞厲，終吉。或從王事，无成。", "九四：不克訟，復即命渝，安貞吉。", "九五：訟元吉。", "上九：或錫之鞶帶，終朝三褫之。"] },
  "坤震": { "name": "師", "symbol": "䷆", "dictum": "貞，丈人，吉无咎。", "yaos": ["初六：師出以律，否臧凶。", "九二：在師中，吉无咎，王三錫命。", "六三：師或輿尸，凶。", "六四：師左次，无咎。", "六五：田有禽，利執言，无咎。長子帥師，弟子輿尸，貞凶。", "上六：大君有命，開國承家，小人勿用。"] },
  "震坤": { "name": "比", "symbol": "䷇", "dictum": "吉。原筮元永貞，无咎。不寧方來，後夫凶。", "yaos": ["初六：有孚比之，无咎。有孚盈缶，終來有它吉。", "六二：比之自內，貞吉。", "六三：比之匪人。", "六四：外比之，貞吉。", "九五：顯比，王用三驅，失前禽。邑人不誡，吉。", "上六：比之无首，凶。"] },
  "巽巽": { "name": "小畜", "symbol": "䷈", "dictum": "亨。密雲不雨，自我西郊。", "yaos": ["初九：復自道，何其咎，吉。", "九二：牽復，吉。", "九三：輿說輻，夫妻反目。", "六四：有孚，血去惕出，无咎。", "九五：有孚攣如，富以其鄰。", "上九：既雨既處，尚德載，婦貞厲。月幾望，君子征凶。"] },
  "乾兌": { "name": "履", "symbol": "䷉", "dictum": "履虎尾，不咥人，亨。", "yaos": ["初九：素履，往无咎。", "九二：履道坦坦，幽人貞吉。", "六三：眇能視，跛能履，履虎尾咥人，凶。武人為于大君。", "九四：履虎尾，愬愬終吉。", "九五：夬履，貞厲。", "上九：視履考祥，其旋元吉。"] },
  "坤乾": { "name": "泰", "symbol": "䷊", "dictum": "小往大來，吉亨。", "yaos": ["初九：拔茅茹，以其彙，征吉。", "九二：包荒，用馮河，不遐遺，朋亡，得尚于中行。", "九三：无平不陂，无往不復，艱貞无咎。勿恤其孚，于食有福。", "六四：翩翩不富，以其鄰，不戒以孚。", "六五：帝乙歸妹，以祉元吉。", "上六：城復于隍，勿用師。自邑告命，貞吝。"] },
  "乾坤": { "name": "否", "symbol": "䷋", "dictum": "否之匪人，不利君子貞，大往小來。", "yaos": ["初六：拔茅茹，以其彙，貞吉亨。", "六二：包承。小人吉，大人否亨。", "六三：包羞。", "九四：有命无咎，疇離祉。", "九五：休否，大人吉。其亡其亡，繫于苞桑。", "上九：傾否，先否後喜。"] },
  "乾離": { "name": "同人", "symbol": "䷌", "dictum": "同人于野，亨。利涉大川，利君子貞。", "yaos": ["初九：同人于門，无咎。", "六二：同人于宗，吝。", "九三：伏戎于莽，升其高陵，三歲不興。", "九四：乘其墉，弗克攻，吉。", "九五：同人，先號咷而後笑，大師克相遇。", "上九：同人于郊，无悔。"] },
  "離乾": { "name": "大有", "symbol": "䷍", "dictum": "元亨。", "yaos": ["初九：无交害，匪咎，艱則无咎。", "九二：大車以載，有攸往，无咎。", "九三：公用亨于天子，小人弗克。", "九四：匪其彭，无咎。", "六五：厥孚交如，威如，吉。", "上九：自天祐之，吉无不利。"] },
  "坤艮": { "name": "謙", "symbol": "䷎", "dictum": "亨，君子有終。", "yaos": ["初六：謙謙君子，用涉大川，吉。", "六二：鳴謙，貞吉。", "九三：勞謙，君子有終，吉。", "六四：无不利，撝謙。", "六五：不富以其鄰，利用侵伐，无不利。", "上六：鳴謙，利用行師，征邑國。"] },
  "震巽": { "name": "豫", "symbol": "䷏", "dictum": "利建侯行師。", "yaos": ["初六：鳴豫，凶。", "六二：介于石，不終日，貞吉。", "六三：盱豫，悔。遲有悔。", "九四：由豫，大有得。勿疑。朋盍簪。", "六五：貞疾，恆不死。", "上六：冥豫，成有渝，无咎。"] },
  "兌震": { "name": "隨", "symbol": "䷐", "dictum": "元亨利貞，无咎。", "yaos": ["初九：官有渝，貞吉。出門交有功。", "六二：係小子，失丈夫。", "六三：係丈夫，失小子。隨有求得，利居貞。", "九四：隨有獲，貞凶。有孚在道，以明，何咎。", "九五：孚于嘉，吉。", "上六：拘係之，乃從維之。王用亨于西山。"] },
  "艮兌": { "name": "蠱", "symbol": "䷑", "dictum": "元亨，利涉大川。先甲三日，後甲三日。", "yaos": ["初六：幹父之蠱，有子，考无咎，厲終吉。", "九二：幹母之蠱，不可貞。", "九三：幹父之蠱，小有悔，无大咎。", "六四：裕父之蠱，往見吝。", "六五：幹父之蠱，用譽。", "上九：不事王侯，高尚其事。"] },
  "坤巽": { "name": "臨", "symbol": "䷒", "dictum": "元亨，利貞。至于八月有凶。", "yaos": ["初九：咸臨，貞吉。", "九二：咸臨，吉无不利。", "六三：甘臨，无攸利。既憂之，无咎。", "六四：至臨，无咎。", "六五：知臨，大君之宜，吉。", "上六：敦臨，吉无咎。"] },
  "巽坤": { "name": "觀", "symbol": "䷓", "dictum": "盥而不薦，有孚顒若。", "yaos": ["初六：童觀，小人无咎，君子吝。", "六二：闚觀，利女貞。", "六三：觀我生，進退。", "六四：觀國之光，利用賓于王。", "九五：觀我生，君子无咎。", "上九：觀其生，君子无咎。"] },
  "離震": { "name": "噬嗑", "symbol": "䷔", "dictum": "亨。利用獄。", "yaos": ["初九：屨校滅趾，无咎。", "六二：噬膚滅鼻，无咎。", "六三：噬臘肉，遇毒，小吝，无咎。", "九四：噬乾胏，得金矢，利艱貞，吉。", "六五：噬乾肉，得黃金，貞厲，无咎。", "上九：何校滅耳，凶。"] },
  "艮離": { "name": "賁", "symbol": "䷕", "dictum": "亨。小利有攸往。", "yaos": ["初九：賁其趾，捨車而徒。", "六二：賁其須。", "九三：賁如濡如，永貞吉。", "六四：賁如皤如，白馬翰如，匪寇婚媾。", "六五：賁于丘園，束帛戔戔，吝，終吉。", "上九：白賁，无咎。"] },
  "艮坤": { "name": "剝", "symbol": "䷖", "dictum": "不利有攸往。", "yaos": ["初六：剝床以足，蔑貞凶。", "六二：剝床以辨，蔑貞凶。", "六三：剝之，无咎。", "六四：剝床以膚，凶。", "六五：貫魚，以宮人寵，无不利。", "上九：碩果不食，君子得輿，小人剝廬。"] },
  "坤艮": { "name": "復", "symbol": "䷗", "dictum": "亨。出入无疾，朋來无咎。反復其道，七日來復，利有攸往。", "yaos": ["初九：不遠復，无祗悔，元吉。", "六二：休復，吉。", "六三：頻復，厲无咎。", "六四：中行獨復。", "六五：敦復，无悔。", "上六：迷復，凶，有災眚。用行師，終有大敗，以其國君凶，至于十年不克征。"] },
  "乾震": { "name": "無妄", "symbol": "䷘", "dictum": "元亨，利貞。其匪正有眚，不利有攸往。", "yaos": ["初九：無妄，往吉。", "六二：不耕穫，不菑畬，則利有攸往。", "六三：無妄之災，或繫之牛，行人之得，邑人之災。", "九四：可貞，无咎。", "九五：無妄之疾，勿藥有喜。", "上九：無妄，行有眚，无攸利。"] },
  "艮乾": { "name": "大畜", "symbol": "䷙", "dictum": "利貞，不家食吉，利涉大川。", "yaos": ["初九：有厲，利已。", "九二：輿說輻。", "九三：良馬逐，利艱貞。曰閑輿衛，利有攸往。", "六四：童牛之牿，元吉。", "六五：豶豕之牙，吉。", "上九：何天之衢，亨。"] },
  "坎艮": { "name": "頤", "symbol": "䷚", "dictum": "貞吉。觀頤，自求口實。", "yaos": ["初九：捨爾靈龜，觀我朵頤，凶。", "六二：顛頤，拂經，于丘頤，征凶。", "六三：拂頤，貞凶，十年勿用，无攸利。", "六四：顛頤，吉。虎視眈眈，其欲逐逐，无咎。", "六五：拂經，居貞吉，不可涉大川。", "上九：由頤，厲吉，利涉大川。"] },
  "巽離": { "name": "大過", "symbol": "䷛", "dictum": "棟橈，利有攸往，亨。", "yaos": ["初六：藉用白茅，无咎。", "九二：枯楊生稊，老夫得其女妻，无不利。", "九三：棟橈，凶。", "九四：棟隆，吉。有它吝。", "九五：枯楊生華，老婦得其士夫，无咎无譽。", "上六：過涉滅頂，凶，无咎。"] },
  "坎坎": { "name": "坎為水", "symbol": "䷜", "dictum": "習坎，有孚，維心亨，行有尚。", "yaos": ["初六：習坎，入于坎窞，凶。", "九二：坎有險，求小得。", "六三：來之坎坎，險且枕，入于坎窞，勿用。", "六四：樽酒簋貳，用缶，納約自牖，終无咎。", "九五：坎不盈，祗既平，无咎。", "上六：係用徽纆，寘于叢棘，三歲不得，凶。"] },
  "離離": { "name": "離為火", "symbol": "䷝", "dictum": "利貞，亨。畜牝牛吉。", "yaos": ["初九：履錯然，敬之无咎。", "六二：黃離，元吉。", "九三：日昃之離，不鼓缶而歌，則大耋之嗟，凶。", "九四：突如其來如，焚如，死如，棄如。", "六五：出涕沱若，戚嗟若，吉。", "上九：王用出征，有嘉折首，獲匪其醜，无咎。"] },
  "兌兌": { "name": "兌為澤", "symbol": "䷞", "dictum": "亨，利貞。", "yaos": ["初九：和兌，吉。", "九二：孚兌，吉，悔亡。", "六三：來兌，凶。", "九四：商兌未寧，介疾有喜。", "九五：孚于剝，有厲。", "上六：引兌。"] },
  "震震": { "name": "震為雷", "symbol": "䷟", "dictum": "亨。震來虩虩，笑言啞啞。震驚百里，不喪匕鬯。", "yaos": ["初九：震來虩虩，後笑言啞啞，吉。", "六二：震來厲，億喪貝，躋于九陵，勿逐，七日得。", "六三：震蘇蘇，震行无眚。", "九四：震遂泥。", "六五：震往來厲，億无喪，有事。", "上六：震索索，視矍矍，征凶。震不于其躬，于其鄰，无咎。婚媾有言。"] },
  "艮艮": { "name": "艮為山", "symbol": "䷠", "dictum": "艮其背，不獲其身，行其庭，不見其人，无咎。", "yaos": ["初六：艮其趾，无咎，利永貞。", "六二：艮其腓，不拯其隨，其心不快。", "九三：艮其限，列其夤，厲薰心。", "六四：艮其身，无咎。", "六五：艮其輔，言有序，悔亡。", "上九：敦艮，吉。"] },
  "巽乾": { "name": "漸", "symbol": "䷡", "dictum": "女歸吉，利貞。", "yaos": ["初六：鴻漸于干，小子厲，有言，无咎。", "六二：鴻漸于磐，飲食衎衎，吉。", "九三：鴻漸于陸，夫征不復，婦孕不育，凶。利禦寇。", "六四：鴻漸于木，或得其桷，无咎。", "九五：鴻漸于陵，婦三歲不孕，終莫之勝，吉。", "上九：鴻漸于逵，其羽可用為儀，吉。"] },
  "兌離": { "name": "歸妹", "symbol": "䷢", "dictum": "征凶，无攸利。", "yaos": ["初九：歸妹以娣，跛能履，征吉。", "九二：眇能視，利幽人之貞。", "六三：歸妹以須，反歸以娣。", "九四：歸妹愆期，遲歸有時。", "六五：帝乙歸妹，其君之袂不如其娣之袂良，月幾望，吉。", "上六：女承筐无實，士刲羊无血，无攸利。"] },
  "震離": { "name": "豐", "symbol": "䷣", "dictum": "亨，王假之，勿憂，宜日中。", "yaos": ["初九：遇其配主，雖旬无咎，往有尚。", "六二：豐其蔀，日中見斗，往得疑疾，有孚發若，吉。", "九三：豐其沛，日中見沬，折其右肱，无咎。", "九四：豐其蔀，日中見斗，遇其夷主，吉。", "六五：來章，有慶譽，吉。", "上六：豐其屋，蔀其家，闚其戶，闃其无人，三歲不覿，凶。"] },
  "離巽": { "name": "旅", "symbol": "䷤", "dictum": "小亨，旅貞吉。", "yaos": ["初六：旅瑣瑣，斯其所取災。", "六二：旅即次，懷其資，得童僕貞。", "九三：旅焚其次，喪其童僕，貞厲。", "九四：旅于處，得其資斧，我心不快。", "六五：射雉一矢亡，終以譽命。", "上九：鳥焚其巢，旅人先笑後號咷。喪牛于易，凶。"] },
  "巽巽": { "name": "巽為風", "symbol": "䷥", "dictum": "小亨，利有攸往，利見大人。", "yaos": ["初六：進退，利武人之貞。", "九二：巽在床下，用史巫紛若，吉无咎。", "九三：頻巽，吝。", "六四：悔亡，田獲三品。", "九五：貞吉悔亡，无不利。无初有終，先庚三日，後庚三日，吉。", "上九：巽在床下，喪其資斧，貞凶。"] },
  "坎兌": { "name": "渙", "symbol": "䷧", "dictum": "亨。王假有廟，利涉大川，利貞。", "yaos": ["初六：用拯馬壯，吉。", "九二：渙奔其機，悔亡。", "六三：渙其躬，无悔。", "六四：渙其群，元吉。渙有丘，匪夷所思。", "九五：渙汗其大號，渙王居，无咎。", "上九：渙其血，去逖出，无咎。"] },
  "兌坎": { "name": "節", "symbol": "䷨", "dictum": "亨。苦節不可貞。", "yaos": ["初九：不出戶庭，无咎。", "九二：不出門庭，凶。", "六三：不節若，則嗟若，无咎。", "六四：安節，亨。", "九五：甘節，吉，往有尚。", "上六：苦節，貞凶，悔亡。"] },
  "兌艮": { "name": "中孚", "symbol": "䷩", "dictum": "豚魚吉，利涉大川，利貞。", "yaos": ["初九：虞吉，有他不燕。", "九二：鳴鶴在陰，其子和之，我有好爵，吾與爾靡之。", "六三：得敵，或鼓或罷，或泣或歌。", "六四：月幾望，馬匹亡，无咎。", "九五：有孚攣如，无咎。", "上九：翰音登于天，貞凶。"] },
  "震巽": { "name": "小過", "symbol": "䷪", "dictum": "亨，利貞，可小事，不可大事。", "yaos": ["初六：飛鳥以凶。", "六二：過其祖，遇其妣，不及其君，遇其臣，无咎。", "九三：弗過防之，從或戕之，凶。", "九四：无咎，弗過遇之。往厲必戒，勿用永貞。", "六五：密雲不雨，自我西郊，公弋取彼在穴。", "上六：弗遇過之，飛鳥離之，凶，是謂災眚。"] },
  "坎離": { "name": "既濟", "symbol": "䷫", "dictum": "亨小，利貞，初吉終亂。", "yaos": ["初九：曳其輪，濡其尾，无咎。", "六二：婦喪其茀，勿逐，七日得。", "九三：高宗伐鬼方，三年克之，小人勿用。", "六四：繻有衣袽，終日戒。", "九五：東鄰殺牛，不如西鄰之禴祭，實受其福。", "上六：濡其首，厲。"] },
  "離坎": { "name": "未濟", "symbol": "䷬", "dictum": "亨，小狐汔濟，濡其尾，无攸利。", "yaos": ["初六：濡其尾，吝。", "九二：曳其輪，貞吉。", "六三：未濟，征凶，利涉大川。", "九四：貞吉，悔亡，震用伐鬼方，三年有賞于大國。", "六五：貞吉，无悔，君子之光，有孚吉。", "上九：有孚于飲酒，无咎，濡其首，有孚失是。"] }
};

    const ELEMENTS = {
      木: { generates: "火", overcomes: "土", generatedBy: "水", overcomeBy: "金", color: "#008000" },
      火: { generates: "土", overcomes: "金", generatedBy: "木", overcomeBy: "水", color: "#FF0000" },
      土: { generates: "金", overcomes: "水", generatedBy: "火", overcomeBy: "木", color: "#A52A2A" },
      金: { generates: "水", overcomes: "木", generatedBy: "土", overcomeBy: "火", color: "#FFD700" },
      水: { generates: "木", overcomes: "火", generatedBy: "金", overcomeBy: "土", color: "#0000FF" },
    };

    const INTERPRETATIONS = {
      human: {
        乾: { desc: "父、長者、領導", impact: "影響：權威、決斷力強。", auspicious: "吉：得貴人助。", inauspicious: "凶：過剛易折。" },
        兌: { desc: "少女、悅口之人", impact: "影響：溝通順暢。", auspicious: "吉：喜悅和睦。", inauspicious: "凶：口舌是非。" },
        離: { desc: "中女、文明之人", impact: "影響：智慧明達。", auspicious: "吉：文化興盛。", inauspicious: "凶：虛華不實。" },
        震: { desc: "長男、驚動者", impact: "影響：動盪變革。", auspicious: "吉：振奮人心。", inauspicious: "凶：驚恐不安。" },
        巽: { desc: "長女、商賈、流通者", impact: "影響：柔順入理。", auspicious: "吉：商業順利。", inauspicious: "凶：猶豫不決。" },
        坎: { desc: "中男、行旅、險難者", impact: "影響：危險困頓。", auspicious: "吉：渡過難關。", inauspicious: "凶：陷入險境。" },
        艮: { desc: "少男、門戶、止守者", impact: "影響：靜止堅守。", auspicious: "吉：安定平和。", inauspicious: "凶：頑固不化。" },
        坤: { desc: "母、眾、承載者", impact: "影響：包容順從。", auspicious: "吉：大地豐收。", inauspicious: "凶：過柔無主。" },
      },
      event: {
        乾: { desc: "事勢剛健", impact: "影響：快速推進。", auspicious: "吉：利於開創。", inauspicious: "凶：過急生變。" },
        兌: { desc: "和悅之事", impact: "影響：和諧順利。", auspicious: "吉：合作順利。", inauspicious: "凶：表面和睦。" },
        // ... 補齊
      },
      time: {
        乾: { desc: "秋冬之時", impact: "影響：時機成熟。", auspicious: "吉：利於收成。", inauspicious: "凶：寒冷阻礙。" },
        兌: { desc: "秋季之時", impact: "影響：交流頻繁。", auspicious: "吉：利於談判。", inauspicious: "凶：口舌爭端。" },
        // ... 補齊
      },
      place: {
        乾: { desc: "西北、天上", impact: "影響：高遠廣闊。", auspicious: "吉：利西北行。", inauspicious: "凶：高處不勝寒。" },
        兌: { desc: "西方、澤地", impact: "影響：濕潤交流。", auspicious: "吉：利於西方。", inauspicious: "凶：水患口舌。" },
        // ... 補齊
      },
      object: {
        乾: { desc: "金屬、圓形物", impact: "影響：堅硬耐用。", auspicious: "吉：利於工具。", inauspicious: "凶：易生銹。" },
        兌: { desc: "金屬、口器", impact: "影響：銳利可用。", auspicious: "吉：利於器具。", inauspicious: "凶：損壞易傷。" },
        // ... 補齊
      }
    };

    const SEASONS_ELEMENTS = {
      spring: { 旺: "木", 相: "火", 休: "土", 囚: "金", 死: "水" },
      summer: { 旺: "火", 相: "土", 休: "金", 囚: "水", 死: "木" },
      autumn: { 旺: "金", 相: "水", 休: "木", 囚: "火", 死: "土" },
      winter: { 旺: "水", 相: "木", 休: "火", 囚: "土", 死: "金" },
      lateSummer: { 旺: "土", 相: "金", 休: "水", 囚: "木", 死: "火" },
    };

    const RELATION_AUSPICIOUS = {
      '生': { desc: "吉", detail: "用生體，大吉。" },
      '克': { desc: "凶", detail: "用克體，大凶。" },
      '被生': { desc: "吉", detail: "體生用，耗力但可。" },
      '被克': { desc: "凶", detail: "體克用，洩氣不佳。" },
      '平': { desc: "中", detail: "相平，視其他。" },
    };

    const $ = (sel) => document.querySelector(sel);
    const $$ = (sel) => Array.from(document.querySelectorAll(sel));

    function optionHtml(t) { return `<option value="${t.key}">${t.key}（${t.symbol}／${t.element}）</option>`; }

    function initSelectors() {
      const lowerSel = $('#lowerSelect');
      const upperSel = $('#upperSelect');
      lowerSel.innerHTML = TRIGRAMS.map(optionHtml).join('');
      upperSel.innerHTML = TRIGRAMS.map(optionHtml).join('');
      lowerSel.value = '離';
      upperSel.value = '兌';
    }

    function getTrigramByRemainder(rem) {
      return TRIGRAMS[(rem || 8) - 1]; // 餘1乾,2兌,...,8坤
    }

    function getInputData() {
      const method = $('#methodSelect').value;
      let lower, upper, moving;
      if (method === 'manual') {
        lower = TRIGRAMS.find(t => t.key === $('#lowerSelect').value);
        upper = TRIGRAMS.find(t => t.key === $('#upperSelect').value);
        moving = parseInt($('#movingInput').value || '1', 10);
      } else if (method === 'number') {
        const num = parseInt($('#numberValue').value || '1', 10);
        lower = getTrigramByRemainder(num % 8);
        upper = getTrigramByRemainder((num + 1) % 8);
        moving = (num % 6) + 1;
      } else if (method === 'time') {
        const dt = new Date($('#datetimeValue').value || new Date());
        const y = dt.getFullYear() % 100;
        const m = dt.getMonth() + 1;
        const d = dt.getDate();
        const h = dt.getHours();
        const sum = y + m + d;
        lower = getTrigramByRemainder(sum % 8);
        upper = getTrigramByRemainder(h % 8);
        moving = ((sum + h) % 6) + 1;
      }
      moving = Math.max(1, Math.min(6, moving));
      return { lowerKey: lower.key, upperKey: upper.key, movingLine: moving };
    }

    function buildHexagram(lowerKey, upperKey) {
      const lower = TRIGRAMS.find(t => t.key === lowerKey);
      const upper = TRIGRAMS.find(t => t.key === upperKey);
      const lines = [...lower.bin, ...upper.bin];
      const hexKey = upper.key + lower.key;
      const hex = HEXAGRAMS[hexKey] || { name: "未知", symbol: "", dictum: "", yaos: [] };
      return { lines, lower, upper, name: hex.name, symbol: hex.symbol, dictum: hex.dictum, yaos: hex.yaos };
    }

    function flipAt(lines, index1to6) {
      const idx = index1to6 - 1;
      const next = lines.slice();
      next[idx] = next[idx] ? 0 : 1;
      return next;
    }

    function linesToTrigram(lines3) {
      return TRIGRAMS.find(t => t.bin.every((b, i) => b === lines3[i]));
    }

    function hexFromLines(lines) {
      const lower = linesToTrigram(lines.slice(0, 3));
      const upper = linesToTrigram(lines.slice(3, 6));
      const hexKey = upper.key + lower.key;
      const hex = HEXAGRAMS[hexKey] || { name: "未知", symbol: "", dictum: "", yaos: [] };
      return { lines, lower, upper, name: hex.name, symbol: hex.symbol, dictum: hex.dictum, yaos: hex.yaos };
    }

    function mutualHexagram(lines) {
      const lowerMutual = lines.slice(1, 4);
      const upperMutual = lines.slice(2, 5);
      const lower = linesToTrigram(lowerMutual);
      const upper = linesToTrigram(upperMutual);
      const hexKey = upper.key + lower.key;
      const hex = HEXAGRAMS[hexKey] || { name: "未知", symbol: "", dictum: "", yaos: [] };
      return { lines: [...lowerMutual, ...upperMutual], lower, upper, name: hex.name, symbol: hex.symbol, dictum: hex.dictum, yaos: hex.yaos };
    }

    function relation(fromElem, toElem) {
      if (ELEMENTS[fromElem].generates === toElem) return '生';
      if (ELEMENTS[fromElem].overcomes === toElem) return '克';
      if (ELEMENTS[fromElem].generatedBy === toElem) return '被生';
      if (ELEMENTS[fromElem].overcomeBy === toElem) return '被克';
      return '平';
    }

    function prettyRelation(fromElem, toElem) {
      const r = relation(fromElem, toElem);
      if (r === '生') return `${fromElem}生${toElem}`;
      if (r === '克') return `${fromElem}克${toElem}`;
      if (r === '被生') return `${fromElem}受${toElem}所生`;
      if (r === '被克') return `${fromElem}受${toElem}所克`;
      return `${fromElem}與${toElem}相平`;
    }

    function getRelationAuspicious(r) {
      return RELATION_AUSPICIOUS[r] || { desc: "中", detail: "無特殊吉凶。" };
    }

    function getSeasonFromDate(dt = new Date()) {
      const m = dt.getMonth() + 1;
      if ([2, 5, 8, 11].includes(m)) return 'lateSummer';
      if (m >= 3 && m <= 5) return 'spring';
      if (m >= 6 && m <= 8) return 'summer';
      if (m >= 9 && m <= 11) return 'autumn';
      return 'winter';
    }

    function getElementStatus(element, season) {
      const statuses = SEASONS_ELEMENTS[season];
      for (let status in statuses) {
        if (statuses[status] === element) return status;
      }
      return '未知';
    }

    function getLineThickness(status) {
      switch (status) {
        case '旺': return 6;
        case '相': return 5;
        case '休': return 4;
        case '囚': return 3;
        case '死': return 2;
        default: return 2;
      }
    }

    function calculatePentagonPositions(center, radius) {
      const positions = [];
      for (let i = 0; i < 5; i++) {
        const angle = 2 * Math.PI * i / 5 - Math.PI / 2;
        positions.push({
          x: center.x + radius * Math.cos(angle),
          y: center.y + radius * Math.sin(angle)
        });
      }
      return positions;
    }

    function drawFiveElementsChart(ctx, base, mutual, changed, movingLine, season) {
      ctx.clearRect(0, 0, 600, 600);
      const center = { x: 300, y: 300 };
      const radius = 200;
      const circleRadius = 60;
      const pos = calculatePentagonPositions(center, radius);
      const elOrder = ['木', '火', '土', '金', '水'];
      const elPositions = {};
      elOrder.forEach((el, i) => {
        ELEMENTS[el].position = pos[i];
        elPositions[el] = pos[i];
      });

      // 畫圓
      elOrder.forEach(el => {
        const p = elPositions[el];
        ctx.beginPath();
        ctx.arc(p.x, p.y, circleRadius, 0, 2 * Math.PI);
        ctx.fillStyle = ELEMENTS[el].color;
        ctx.fill();
        ctx.strokeStyle = "#000000";
        ctx.stroke();
        ctx.fillStyle = "#FFFFFF";
        ctx.font = "24px Arial";
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        ctx.fillText(el, p.x, p.y);
      });

      // 收集相關卦
      const elementsMap = {};
      const isLowerMoving = movingLine <= 3;
      const baseUse = isLowerMoving ? base.lower : base.upper;
      const baseBody = isLowerMoving ? base.upper : base.lower;
      const changedUse = changed.lower;
      const changedBody = changed.upper;
      elementsMap[baseUse.element] = (elementsMap[baseUse.element] || '') + `[用卦${baseUse.symbol}${baseUse.key}]${getElementStatus(baseUse.element, season)} `;
      elementsMap[baseBody.element] = (elementsMap[baseBody.element] || '') + `[體卦${baseBody.symbol}${baseBody.key}]${getElementStatus(baseBody.element, season)} `;
      elementsMap[mutual.upper.element] = (elementsMap[mutual.upper.element] || '') + `[互上${mutual.upper.symbol}${mutual.upper.key}]${getElementStatus(mutual.upper.element, season)} `;
      elementsMap[mutual.lower.element] = (elementsMap[mutual.lower.element] || '') + `[互下${mutual.lower.symbol}${mutual.lower.key}]${getElementStatus(mutual.lower.element, season)} `;
      elementsMap[changedUse.element] = (elementsMap[changedUse.element] || '') + `[用變${changedUse.symbol}${changedUse.key}]${getElementStatus(changedUse.element, season)} `;

      // 填文字
      for (let el in elementsMap) {
        const p = elPositions[el];
        ctx.fillStyle = "#000000";
        ctx.font = "12px Arial";
        ctx.textAlign = "center";
        ctx.fillText(elementsMap[el], p.x, p.y + circleRadius + 15);
      }

      // 畫箭頭
      const appeared = Object.keys(elementsMap);
      appeared.forEach(from => {
        const toGen = ELEMENTS[from].generates;
        const toOvc = ELEMENTS[from].overcomes;
        if (appeared.includes(toGen)) {
          drawArrowToEdge(ctx, elPositions[from], elPositions[toGen], circleRadius, getLineThickness(getElementStatus(from, season)), 'green');
        }
        if (appeared.includes(toOvc)) {
          drawArrowToEdge(ctx, elPositions[from], elPositions[toOvc], circleRadius, getLineThickness(getElementStatus(from, season)), 'red');
        }
      });
    }

    function drawArrowToEdge(ctx, from, to, r, thickness, color) {
      const dx = to.x - from.x;
      const dy = to.y - from.y;
      const dist = Math.sqrt(dx * dx + dy * dy);
      const unitX = dx / dist;
      const unitY = dy / dist;
      const startX = from.x + unitX * r;
      const startY = from.y + unitY * r;
      const endX = to.x - unitX * r;
      const endY = to.y - unitY * r;
      ctx.beginPath();
      ctx.moveTo(startX, startY);
      ctx.lineTo(endX, endY);
      ctx.strokeStyle = color;
      ctx.lineWidth = thickness;
      ctx.stroke();
      // 箭頭
      const angle = Math.atan2(dy, dx);
      ctx.beginPath();
      ctx.moveTo(endX, endY);
      ctx.lineTo(endX - 10 * Math.cos(angle - Math.PI / 6), endY - 10 * Math.sin(angle - Math.PI / 6));
      ctx.moveTo(endX, endY);
      ctx.lineTo(endX - 10 * Math.cos(angle + Math.PI / 6), endY - 10 * Math.sin(angle + Math.PI / 6));
      ctx.stroke();
    }

    function renderHexagramLines(lines, elem) {
      let text = '';
      for (let i = 5; i >= 0; i--) {
        text += lines[i] ? '─────' : '── ──' + '\n';
      }
      elem.textContent = text;
    }

    function renderSummary(base, mutual, changed, movingLine, season) {
      const isLowerMoving = movingLine <= 3;
      const baseUse = isLowerMoving ? base.lower : base.upper;
      const baseBody = isLowerMoving ? base.upper : base.lower;
      const baseRel = relation(baseUse.element, baseBody.element);
      const baseAus = getRelationAuspicious(baseRel);
      const mutualRel = relation(mutual.upper.element, mutual.lower.element);
      const mutualAus = getRelationAuspicious(mutualRel);
      const changedUse = changed.lower;
      const changedBody = changed.upper;
      const changedRel = relation(changedUse.element, changedBody.element);
      const changedAus = getRelationAuspicious(changedRel);

      $('#baseName').textContent = `卦名：${base.name}`;
      $('#baseSymbol').textContent = base.symbol;
      renderHexagramLines(base.lines, $('#baseHexagram'));
      $('#baseDictum').textContent = `卦辭：${base.dictum}`;
      $('#baseLower').textContent = `下：${base.lower.key}（${base.lower.symbol}／${base.lower.element}）`;
      $('#baseUpper').textContent = `上：${base.upper.key}（${base.upper.symbol}／${base.upper.element}）`;
      $('#baseRelation').innerHTML = `生克：${prettyRelation(baseUse.element, baseBody.element)} （${baseAus.desc}：${baseAus.detail}）`;
      $('#movingDictum').textContent = `變爻辭：${base.yaos[movingLine - 1] || '無'}`;

      $('#mutualName').textContent = `卦名：${mutual.name}`;
      $('#mutualSymbol').textContent = mutual.symbol;
      renderHexagramLines(mutual.lines, $('#mutualHexagram'));
      $('#mutualDictum').textContent = `卦辭：${mutual.dictum}`;
      $('#mutualLower').textContent = `下：${mutual.lower.key}（${mutual.lower.symbol}／${mutual.lower.element}）`;
      $('#mutualUpper').textContent = `上：${mutual.upper.key}（${mutual.upper.symbol}／${mutual.upper.element}）`;
      $('#mutualRelation').innerHTML = `生克：${prettyRelation(mutual.upper.element, mutual.lower.element)} （${mutualAus.desc}：${mutualAus.detail}）`;

      $('#changedName').textContent = `卦名：${changed.name}`;
      $('#changedSymbol').textContent = changed.symbol;
      renderHexagramLines(changed.lines, $('#changedHexagram'));
      $('#changedDictum').textContent = `卦辭：${changed.dictum}`;
      $('#changedLower').textContent = `下：${changed.lower.key}（${changed.lower.symbol}／${changed.lower.element}）`;
      $('#eachangedUpper').textContent = `上：${changed.upper.key}（${changed.upper.symbol}／${changed.upper.element}）`;
      $('#changedRelation').innerHTML = `生克：${prettyRelation(changedUse.element, changedBody.element)} （${changedAus.desc}：${changedAus.detail}）`;

      // 五行狀態
      let statusText = '';
      ['木', '火', '土', '金', '水'].forEach(el => {
        statusText += `${el}：${getElementStatus(el, season)}<br>`;
      });
      $('#elementsStatus').innerHTML = statusText;

      // 應期
      let periodText = '應期估計：';
      const status = getElementStatus(baseUse.element, season);
      const periodDays = movingLine * 10;
      periodText += `動爻位於${movingLine}，估計${periodDays}日內應驗。`;
      if (status === '旺' || status === '相') periodText += '五行旺相，應期較快。';
      else if (status === '死' || status === '囚') periodText += '五行休囚死，應期較遲。';
      else periodText += '五行休，應期適中。';
      $('#responsePeriod').textContent = periodText;
    }

    function renderTabContent(tabName, base, mutual, changed, movingLine) {
      const isLowerMoving = movingLine <= 3;
      const baseUse = isLowerMoving ? base.lower : base.upper;
      const baseBody = isLowerMoving ? base.upper : base.lower;
      const mutualUse = mutual.upper;
      const mutualBody = mutual.lower;
      const changedUse = changed.lower;
      const changedBody = changed.upper;

      const content = [];
      content.push(`<h3 class="font-medium">「${tabName === 'human' ? '人' : tabName === 'event' ? '事' : tabName === 'time' ? '時' : tabName === 'place' ? '地' : '物'}」的判讀</h3>`);
      content.push(`<p>點擊卦象查看詳細解釋：</p>`);
      content.push(`<ul class="list-disc pl-5 space-y-1">`);
      [baseBody, baseUse, mutualBody, mutualUse, changedBody, changedUse].forEach(trigram => {
        const interp = INTERPRETATIONS[tabName][trigram.key] || { desc: "", impact: "", auspicious: "", inauspicious: "" };
        content.push(`<li><button class="explain-btn" data-key="${trigram.key}">${trigram.key}（${trigram.symbol}）</button></li>`);
      });
      content.push(`</ul>`);
      content.push(`<div class="explanation mt-4"></div>`);

      const tabElem = $('#tab-' + tabName);
      tabElem.innerHTML = content.join('');

      $$('.explain-btn', tabElem).forEach(btn => {
        btn.addEventListener('click', () => {
          const key = btn.dataset.key;
          const interp = INTERPRETATIONS[tabName][key];
          const exp = $('.explanation', tabElem);
          exp.innerHTML = `<p><b>描述：</b>${interp.desc}</p><p><b>影響：</b>${interp.impact}</p><p><b>吉：</b>${interp.auspicious}</p><p><b>凶：</b>${interp.inauspicious}</p>`;
          exp.classList.add('active');
        });
      });
    }

    function toggleInputs() {
      const method = $('#methodSelect').value;
      $('#manualInput').classList.toggle('hidden', method !== 'manual');
      $('#numberInput').classList.toggle('hidden', method !== 'number');
      $('#timeInput').classList.toggle('hidden', method !== 'time');
    }

    function bindEvents() {
      $('#methodSelect').addEventListener('change', () => { toggleInputs(); computeAndRender(); });
      $('#lowerSelect').addEventListener('change', computeAndRender);
      $('#upperSelect').addEventListener('change', computeAndRender);
      $('#movingInput').addEventListener('input', computeAndRender);
      $('#numberValue').addEventListener('input', computeAndRender);
      $('#datetimeValue').addEventListener('input', computeAndRender);
      $('#resetBtn').addEventListener('click', () => {
        $('#methodSelect').value = 'manual';
        toggleInputs();
        $('#lowerSelect').value = '離';
        $('#upperSelect').value = '兌';
        $('#movingInput').value = 1;
        $('#numberValue').value = '';
        $('#datetimeValue').value = '';
        activateTab('human');
        computeAndRender();
      });

      $$('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => activateTab(btn.dataset.tab));
      });
    }

    function activateTab(name) {
      $$('.tab-btn').forEach(b => b.classList.toggle('tab-active', b.dataset.tab === name));
      $$('.tab-pane').forEach(p => p.classList.toggle('hidden', p.id !== 'tab-' + name));
    }

    function computeAndRender() {
      const { lowerKey, upperKey, movingLine } = getInputData();
      const base = buildHexagram(lowerKey, upperKey);
      const changed = hexFromLines(flipAt(base.lines, movingLine));
      const mutual = mutualHexagram(base.lines);
      const dt = new Date($('#datetimeValue').value || new Date());
      const season = getSeasonFromDate(dt);

      renderSummary(base, mutual, changed, movingLine, season);

      const ctx = $('#fiveElementsChart').getContext('2d');
      drawFiveElementsChart(ctx, base, mutual, changed, movingLine, season);

      ['human', 'event', 'time', 'place', 'object'].forEach(tab => {
        renderTabContent(tab, base, mutual, changed, movingLine);
      });
    }

    // init
    document.addEventListener('DOMContentLoaded', () => {
      initSelectors();
      toggleInputs();
      bindEvents();
      activateTab('human');
      computeAndRender();
      $('#year').textContent = new Date().getFullYear();
    });
  </script>
</body>
</html>
