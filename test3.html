<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<title>ç§€èœœè€å¸«å­¸ç”Ÿåˆ†çµ„ç³»çµ±</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
<style>
body { font-family: "Microsoft JhengHei", Arial; margin: 20px; background: linear-gradient(135deg,#eef2f3,#dfe9f3); }
h2 { text-align: center; color: #333; margin-bottom: 20px; }
.toolbar { text-align: center; margin-bottom: 10px; }
button { margin: 5px; padding: 10px 15px; border: none; border-radius: 6px; background: #4a90e2; color: white; cursor: pointer; font-size: 14px; transition: 0.2s; }
button:hover { background: #357ABD; }
#leadersList { text-align:center; margin: 10px 0 20px 0; }
#leadersList span { display: inline-block; margin: 5px 15px; font-weight: bold; color: #333; font-size:16px; }
.container { display: flex; flex-wrap: wrap; gap: 20px; justify-content: center; }
.group { border-radius: 12px; padding: 15px; width: 240px; min-height: 180px; background: white; box-shadow: 0 4px 8px rgba(0,0,0,0.1); position: relative; transition: 0.3s; }
.group:hover { transform: scale(1.03); }
.group h4 { text-align: center; margin: 0 0 10px 0; color: #444; }
.students-container { min-height: 60px; display: flex; flex-wrap: wrap; gap:6px; justify-content: center; }
.student { border: 1px solid #ccc; border-radius: 6px; padding: 6px 8px; background: #f9f9f9; cursor: pointer; transition: 0.2s; font-size: 16px; position: relative; user-select: none; text-align:center; min-width: 80px; }
#unassigned-students { display: flex; flex-wrap: wrap; gap: 8px; min-height: 60px; justify-content: center; }
.student.leader { background: #fff18d; font-weight: bold; }
.student.leader::after { content: "â­"; margin-left: 4px; }
#unassigned { border: 2px dashed #aaa; background: #f4f4f4; padding: 10px; border-radius: 12px; width: 95%; margin: 20px auto 0 auto; }
#unassigned h4 { text-align: center; color: #666; font-size: 18px; }
#fileList { text-align:center; margin:10px; font-size:16px; }
#fileList a { display:block; margin:5px; color:#0066cc; text-decoration:none; }
#fileList a:hover { text-decoration:underline; }
@media print {
  button, #fileInput, .toolbar, #leadersList, #fileList { display: none; }
  #unassigned { display: none; } /* âœ… åˆ—å°æ™‚éš±è—æœªåˆ†çµ„å€ */
  body { background: white; }
}
</style>
</head>
<body>
<h2 id="title">ç§€èœœè€å¸«å­¸ç”Ÿåˆ†çµ„ç³»çµ±</h2>

<!-- åˆ†çµ„æ“ä½œæŒ‰éˆ• -->
<div class="toolbar">
  <input type="file" id="fileInput" />
  <button onclick="assistGrouping()">å”åŠ©åˆ†çµ„</button>
  <button onclick="randomAssign()">éš¨æ©Ÿåˆ†çµ„</button>
  <button onclick="autoAssignLeader()">éš¨æ©ŸæŒ‡å®šçµ„é•·</button>
  <button onclick="exportExcel()">åŒ¯å‡º Excel</button>
  <button onclick="window.print()">ğŸ–¨ï¸ åˆ—å°</button>
  <button onclick="loadFileList()">ğŸ“‚ æª”æ¡ˆæ¸…å–®</button>
</div>

<!-- æª”æ¡ˆæ¸…å–®å€ -->
<div id="fileList"></div>

<!-- çµ„é•·æ¸…å–® -->
<div id="leadersList"></div>

<!-- åˆ†çµ„å€ -->
<h3 style="text-align:center;">åˆ†çµ„å€</h3>
<div id="groups" class="container"></div>

<!-- æœªåˆ†çµ„å­¸ç”Ÿå€ -->
<div id="unassigned" class="group" data-group-name="æœªåˆ†çµ„">
  <h4>æœªåˆ†çµ„å­¸ç”Ÿ</h4>
  <div id="unassigned-students"></div>
</div>

<script>
let students = [];
let groups = {};
const colors=["#d6eaff","#d6ffd6","#ffe6e6","#f0d6ff","#fff5cc","#ffd6f5"];

// Excel æª”æ¡ˆè¼‰å…¥
document.getElementById('fileInput').addEventListener('change', handleFile,false);

function handleFile(e){
  const file=e.target.files[0];
  const reader=new FileReader();
  reader.onload=(event)=>{
    const data=new Uint8Array(event.target.result);
    const workbook=XLSX.read(data,{type:'array'});
    const sheet=workbook.Sheets[workbook.SheetNames[0]];
    const rows=XLSX.utils.sheet_to_json(sheet);

    const fieldMap = {
      "ç­ç´š": ["ç­ç´š","ç­åˆ¥"],
      "ç§‘ç›®": ["ç§‘ç›®","èª²ç¨‹"],
      "åº§è™Ÿ": ["åº§è™Ÿ","å­¸è™Ÿ","è™Ÿç¢¼"],
      "å§“å": ["å§“å","åå­—","å­¸ç”Ÿå§“å"],
      "çµ„åˆ¥": ["çµ„åˆ¥","åˆ†çµ„","å°çµ„"]
    };

    function findField(obj, keys){
      for(let k of keys){
        if(obj[k] !== undefined) return obj[k];
      }
      return "";
    }

    students=rows.map(s=>({
      ç­ç´š: findField(s, fieldMap["ç­ç´š"]),
      ç§‘ç›®: findField(s, fieldMap["ç§‘ç›®"]),
      åº§è™Ÿ: parseInt(findField(s, fieldMap["åº§è™Ÿ"])) || 0,
      å§“å: findField(s, fieldMap["å§“å"]),
      çµ„åˆ¥: findField(s, fieldMap["çµ„åˆ¥"]),
      isLeader:false
    }));

    groups={};

    if(students.length>0){
      document.getElementById('title').innerText=students[0].ç­ç´š+" - "+students[0].ç§‘ç›®+" å­¸ç”Ÿåˆ†çµ„";
    }

    students.forEach(s=>{
      const gName = s.çµ„åˆ¥ && s.çµ„åˆ¥!="" ? s.çµ„åˆ¥ : "æœªåˆ†çµ„";
      if(!groups[gName]) groups[gName]=[];
      groups[gName].push(s);
    });

    renderGroups(true);
  };
  reader.readAsArrayBuffer(file);
}

// å»ºç«‹å­¸ç”Ÿæ–¹å¡Š
function createStudentDiv(stu){
  const div=document.createElement("div");
  div.className="student";
  div.dataset.id=stu.åº§è™Ÿ;
  div.innerText = stu.åº§è™Ÿ+" "+stu.å§“å;
  if(stu.isLeader) div.classList.add("leader");

  div.addEventListener("click", ()=>{
    let groupName = Object.keys(groups).find(g=>groups[g].some(s=>s.åº§è™Ÿ==stu.åº§è™Ÿ));
    if(stu.isLeader){
      stu.isLeader=false;
      div.classList.remove("leader");
    } else {
      groups[groupName].forEach(s=>s.isLeader=false);
      stu.isLeader=true;
      document.querySelectorAll("#group-"+groupName+" .student").forEach(d=>{
        d.classList.remove("leader");
        if(d.dataset.id==stu.åº§è™Ÿ) d.classList.add("leader");
      });
    }
    renderLeaders();
  });
  return div;
}

// æ¸²æŸ“åˆ†çµ„
function renderGroups(first=false){
  const groupsDiv=document.getElementById("groups");
  if(first){
    groupsDiv.innerHTML="";
    Object.keys(groups).forEach((groupName,idx)=>{
      if(groupName==="æœªåˆ†çµ„") return;
      const groupDiv=document.createElement("div");
      groupDiv.className="group";
      groupDiv.id="group-"+groupName;
      groupDiv.dataset.groupName=groupName;
      groupDiv.style.background=colors[idx%colors.length];

      const title=document.createElement("h4");
      title.innerText=groupName;
      groupDiv.appendChild(title);

      const studentsContainer=document.createElement("div");
      studentsContainer.className="students-container";
      groupDiv.appendChild(studentsContainer);

      new Sortable(studentsContainer,{ group:'shared', animation:150, onAdd: handleDrop });
      groupsDiv.appendChild(groupDiv);
    });

    new Sortable(document.getElementById("unassigned-students"),{ group:'shared', animation:150, onAdd: handleDrop });
  }

  Object.keys(groups).forEach((groupName)=>{
    const container = groupName==="æœªåˆ†çµ„"?document.getElementById("unassigned-students"):document.querySelector("#group-"+groupName+" .students-container");
    if(container){
      container.innerHTML="";
      groups[groupName].forEach(stu=>{ container.appendChild(createStudentDiv(stu)); });
    }
  });

  renderLeaders();
}

function handleDrop(evt){
  const stuId=evt.item.dataset.id;
  const stu=students.find(s=>s.åº§è™Ÿ==stuId);
  Object.keys(groups).forEach(g=>groups[g]=groups[g].filter(s=>s.åº§è™Ÿ!=stuId));
  let newGroupName=evt.to.closest(".group")?.dataset.groupName || "æœªåˆ†çµ„";
  if(!groups[newGroupName]) groups[newGroupName]=[];
  groups[newGroupName].push(stu);
  renderGroups();
}

// çµ„é•·æ¸…å–®
function renderLeaders(){
  const div=document.getElementById("leadersList");
  div.innerHTML="";
  Object.keys(groups).forEach(g=>{
    if(g==="æœªåˆ†çµ„") return;
    const leader=groups[g].find(s=>s.isLeader);
    const span=document.createElement("span");
    span.innerText=leader?`${g}: ${leader.å§“å}`:`${g}: ç„¡çµ„é•·`;
    div.appendChild(span);
  });
}

// å”åŠ©åˆ†çµ„
function assistGrouping(){
  const numGroups = parseInt(prompt("è¦åˆ†å¹¾çµ„ï¼Ÿ","4"));
  if(!numGroups || numGroups<=0) return;

  let allStudents = [...students].map(s=>({...s,isLeader:false}));

  const method = prompt("åˆ†çµ„æ–¹å¼ï¼šè¼¸å…¥ 1 éš¨æ©Ÿåˆ†çµ„ / 2 ç…§åº§è™Ÿåˆ†çµ„","1");
  if(method==="1"){ allStudents.sort(()=>Math.random()-0.5);}
  else if(method==="2"){ allStudents.sort((a,b)=>a.åº§è™Ÿ - b.åº§è™Ÿ);}
  else { alert("è¼¸å…¥éŒ¯èª¤ï¼Œä½¿ç”¨éš¨æ©Ÿåˆ†çµ„"); allStudents.sort(()=>Math.random()-0.5); }

  groups={};
  for(let i=1;i<=numGroups;i++){ groups["ç¬¬"+i+"çµ„"]=[]; }
  allStudents.forEach((stu,index)=>{ groups["ç¬¬"+((index % numGroups)+1)+"çµ„"].push(stu); });

  renderGroups(true);
}

// éš¨æ©Ÿåˆ†çµ„ï¼ˆç¶­æŒåŸæœ‰çµ„æ•¸ï¼‰
function randomAssign(){
  const groupNames = Object.keys(groups).filter(g=>g!=="æœªåˆ†çµ„");
  if(groupNames.length === 0) { alert("å…ˆå»ºç«‹çµ„åˆ¥"); return; }

  let allStudents = [];
  Object.keys(groups).forEach(g=>{
    allStudents = allStudents.concat(groups[g]);
    if(g!=="æœªåˆ†çµ„") groups[g] = [];
  });

  allStudents.sort(()=>Math.random()-0.5);
  allStudents.forEach((stu,index)=>{ groups[groupNames[index % groupNames.length]].push(stu); stu.isLeader=false; });

  renderGroups();
}

// è‡ªå‹•æŒ‡å®šçµ„é•·
function autoAssignLeader(){
  Object.keys(groups).forEach(groupName=>{
    if(groupName==="æœªåˆ†çµ„") return;
    if(groups[groupName].length>0){
      groups[groupName].forEach(s=>s.isLeader=false);
      let randomIndex=Math.floor(Math.random()*groups[groupName].length);
      groups[groupName][randomIndex].isLeader=true;
    }
  });
  renderGroups();
}

// åŒ¯å‡º Excel
function exportExcel(){
  let exportData=[];
  Object.keys(groups).forEach(g=>{
    groups[g].forEach(stu=>{
      exportData.push({
        ç­ç´š:stu.ç­ç´š,
        ç§‘ç›®:stu.ç§‘ç›®,
        åº§è™Ÿ:stu.åº§è™Ÿ,
        å§“å:stu.å§“å,
        çµ„åˆ¥:g==="æœªåˆ†çµ„"?"":g,
        æ˜¯å¦çµ„é•·:stu.isLeader?"Y":""
      });
    });
  });
  const ws=XLSX.utils.json_to_sheet(exportData);
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,"åˆ†çµ„çµæœ");
  XLSX.writeFile(wb,"åˆ†çµ„çµæœ.xlsx");
}

// ğŸ“‚ è¼‰å…¥æª”æ¡ˆæ¸…å–®
function loadFileList(){
  fetch("files.json")
    .then(res => res.json())
    .then(files => {
      const listDiv = document.getElementById("fileList");
      listDiv.innerHTML = "<h3>å¯ä¸‹è¼‰æª”æ¡ˆï¼š</h3>";
      files.forEach(f=>{
        const a = document.createElement("a");
        a.href = f.path;
        a.innerText = f.name;
        a.download = f.name;
        listDiv.appendChild(a);
      });
    })
    .catch(err=>{
      alert("ç„¡æ³•è¼‰å…¥ files.jsonï¼Œè«‹ç¢ºèªæª”æ¡ˆå­˜åœ¨");
      console.error(err);
    });
}

// æé†’æœªå„²å­˜
window.addEventListener("beforeunload", function (e) {
    if (students.length > 0) {
        e.preventDefault();
        e.returnValue = "æ‚¨å°šæœªåŒ¯å‡ºåˆ†çµ„çµæœï¼Œç¢ºå®šè¦é›¢é–‹å—ï¼Ÿ";
        return "æ‚¨å°šæœªåŒ¯å‡ºåˆ†çµ„çµæœï¼Œç¢ºå®šè¦é›¢é–‹å—ï¼Ÿ";
    }
});
</script>
</body>
</html>
