<!DOCTYPE html><html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>張老師易經卜卦（外部JSON版）</title>
  <style>
    body { font-family: 'Noto Sans TC', sans-serif; background:#f7f7f7; padding:20px; }
    .container { max-width:900px; margin:0 auto; background:#fff; padding:20px; border-radius:12px; box-shadow:0 3px 12px rgba(0,0,0,.15); }
    h1,h2,h3{ color:#333; }
    .tab-buttons{ display:flex; gap:8px; margin-bottom:10px; }
    .tab-button{ padding:8px 16px; border:0; border-radius:6px; cursor:pointer; background:#eee; }
    .tab-button.active{ background:#333; color:#fff; }
    .tab-content{ display:none; }
    .tab-content.active{ display:block; }
    .gua-box{ border:1px solid #ddd; border-radius:8px; padding:12px; margin-bottom:10px; }
    .moving-line{ color:#c00; font-weight:bold; }
    .hidden{ display:none; }
    button.primary{ padding:10px 20px; background:#333; color:#fff; border:0; border-radius:6px; cursor:pointer; }
    #line-explanation{ margin-top:20px; }
    #judgeBox{ margin-top:20px; border:2px solid #666; padding:12px; border-radius:10px; }
    .score-card { display:flex; justify-content:space-between; align-items:center; margin-bottom:6px; }
    .score-bar-wrap{ flex:1; margin:0 10px; height:10px; background:#eee; border-radius:6px; overflow:hidden; }
    .score-bar{ height:100%; background:linear-gradient(90deg,#f44336,#ff9800,#4caf50); width:0; transition:width .4s; }
    .score-val{ font-weight:bold; }
  </style>
</head>
<body>
  <div class="container">
    <h1>張老師易經卜卦</h1><div class="tab-buttons">
  <button class="tab-button active" onclick="showTab('manual-upper-first')">數字取卦</button>
  <button class="tab-button" onclick="showTab('manual-dropdown')">手動取卦</button>
</div>

<div id="manual-upper-first" class="tab-content active">
  <h2>數字取卦</h2>
  <input type="number" id="num4" placeholder="上卦數字"> 
  <input type="number" id="num5" placeholder="下卦數字"> 
  <input type="number" id="num6" placeholder="動爻數字"> 
  <button id="manualUpperBtn" class="primary">生成卦象</button>
</div>

<div id="manual-dropdown" class="tab-content">
  <h2>手動取卦</h2>
  <select id="upperGuaSelect">
    <option value="1">乾</option>
    <option value="2">兌</option>
    <option value="3">離</option>
    <option value="4">震</option>
    <option value="5">巽</option>
    <option value="6">坎</option>
    <option value="7">艮</option>
    <option value="8">坤</option>
  </select>
  <select id="lowerGuaSelect">
    <option value="1">乾</option>
    <option value="2">兌</option>
    <option value="3">離</option>
    <option value="4">震</option>
    <option value="5">巽</option>
    <option value="6">坎</option>
    <option value="7">艮</option>
    <option value="8">坤</option>
  </select>
  <input type="text" id="movingLinesInput" placeholder="變爻 (例:1,3)">
  <button id="manualDropdownBtn" class="primary">生成卦象</button>
</div>

<div id="result" class="hidden">
  <h2>卦象結果</h2>
  <div class="gua-box">
    <h3>本卦</h3>
    <h2 id="guaName"></h2>
    <div id="guaImage"></div>
  </div>
  <div class="gua-box">
    <h3>變卦</h3>
    <h2 id="changeGuaName"></h2>
    <div id="changeGuaImage"></div>
  </div>
  <div class="gua-box">
    <h3>互卦</h3>
    <h2 id="huGuaName"></h2>
    <div id="huGuaImage"></div>
  </div>
  <div id="line-explanation" class="gua-box hidden">
    <h3>動爻解釋</h3>
    <h3 id="line-text-display"></h3>
    <p id="line-meaning-display"></p>
  </div>
  <div id="judgeBox" class="hidden">
    <h3>綜合判斷</h3>
    <div id="scoreWrap"></div>
  </div>
  <button id="judgeBtn" class="primary">綜合判斷</button>
</div>

  </div>  <script>
    const guaTable={1:[1,1,1],2:[0,1,1],3:[1,0,1],4:[0,0,1],5:[1,1,0],6:[0,1,0],7:[1,0,0],8:[0,0,0]};
    const all64Gua=[{id:1,name:'乾為天',lines:[1,1,1,1,1,1]},{id:2,name:'坤為地',lines:[0,0,0,0,0,0]}];
    let hexagramsData={};
    fetch('hexagrams.json').then(r=>r.json()).then(j=>hexagramsData=j);

    let currentResult={};

    const resultDiv=document.getElementById('result');
    const guaNameH2=document.getElementById('guaName');
    const changeGuaNameH2=document.getElementById('changeGuaName');
    const huGuaNameH2=document.getElementById('huGuaName');
    const guaImageDiv=document.getElementById('guaImage');
    const changeGuaImageDiv=document.getElementById('changeGuaImage');
    const huGuaImageDiv=document.getElementById('huGuaImage');
    const lineExplanationDiv=document.getElementById('line-explanation');
    const lineTextDisplay=document.getElementById('line-text-display');
    const lineMeaningDisplay=document.getElementById('line-meaning-display');

    function showTab(id){
      document.querySelectorAll('.tab-button').forEach(b=>b.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));
      document.querySelector(`.tab-button[onclick="showTab('${id}')"]`).classList.add('active');
      document.getElementById(id).classList.add('active');
    }

    function findGuaInfo(lines){
      const s=JSON.stringify(lines);
      return all64Gua.find(g=>JSON.stringify(g.lines)===s)||null;
    }

    function getGuaHtml(lines,moving=[]){
      let h='';
      [...lines].reverse().forEach((l,i)=>{
        const n=6-i;
        const lineHtml=l===1?'———————':'———   ———';
        if(moving.includes(n)) h+=`<div class='moving-line'>${lineHtml} (變爻)</div>`; else h+=`<div>${lineHtml}</div>`;
      });
      return h;
    }

    function generateGua(u,l,moving){
      const upper=guaTable[u], lower=guaTable[l];
      const lines=[...lower,...upper];
      const gua=findGuaInfo(lines);
      if(!gua){alert('無卦資料');return;}
      const change=[...lines];
      moving.forEach(n=>{const i=n-1;if(i>=0&&i<6) change[i]=1-change[i];});
      const changeGua=findGuaInfo(change);
      const hu=[lines[1],lines[2],lines[3],lines[2],lines[3],lines[4]];
      const huGua=findGuaInfo(hu);

      guaNameH2.textContent=gua.name;
      guaImageDiv.innerHTML=getGuaHtml(lines,moving);
      changeGuaNameH2.textContent=changeGua?changeGua.name:'';
      changeGuaImageDiv.innerHTML=changeGua?getGuaHtml(change):'';
      huGuaNameH2.textContent=huGua?huGua.name:'';
      huGuaImageDiv.innerHTML=huGua?getGuaHtml(hu):'';

      if(moving.length===1 && hexagramsData[gua.name]){
        const ld=hexagramsData[gua.name].lines.find(lx=>lx.index===moving[0]);
        if(ld){
          lineTextDisplay.textContent=ld.text;
          lineMeaningDisplay.textContent=ld.meaning;
          lineExplanationDiv.classList.remove('hidden');
        }
      }else lineExplanationDiv.classList.add('hidden');

      currentResult={main:gua,change:changeGua,hu:huGua,moving,mName:gua.name,cName:changeGua&&changeGua.name,hName:huGua&&huGua.name};
      resultDiv.classList.remove('hidden');
      document.getElementById('judgeBox').classList.add('hidden');
    }

    document.getElementById('manualUpperBtn').addEventListener('click',()=>{
      let u=+document.getElementById('num4').value||1;
      let l=+document.getElementById('num5').value||1;
      let m=(+document.getElementById('num6').value||1)%6||6;
      generateGua(u,l,[m]);
    });
    document.getElementById('manualDropdownBtn').addEventListener('click',()=>{
      let u=+document.getElementById('upperGuaSelect').value;
      let l=+document.getElementById('lowerGuaSelect').value;
      let ms=document.getElementById('movingLinesInput').value.split(',').map(s=>parseInt(s.trim())).filter(x=>!isNaN(x));
      generateGua(u,l,ms);
    });

    // 綜合判斷計算
    const WEIGHTS={moving:0.4,main:0.25,change:0.2,hu:0.15};
    const ASPECTS=[{k:'people',n:'人'},{k:'affairs',n:'事'},{k:'time',n:'時'},{k:'place',n:'地'},{k:'object',n:'物'}];

    function clamp(x){return Math.max(0,Math.min(10,x));}
    function getAspect(entry){
      if(!entry||!hexagramsData[entry.name]) return {people:5,affairs:5,time:5,place:5,object:5};
      const j=hexagramsData[entry.name].judgment||{};
      return {
        people:clamp(j.people??j.overall??5),
        affairs:clamp(j.affairs??j.overall??5),
        time:clamp(j.time??j.overall??5),
        place:clamp(j.place??j.overall??5),
        object:clamp(j.object??j.overall??5)
      };
    }
    function movingImpact(entry,moving){
      if(!entry||!hexagramsData[entry.name]) return {people:5,affairs:5,time:5,place:5,object:5};
      const lines=hexagramsData[entry.name].lines||[];
      if(!moving||moving.length===0) return {people:5,affairs:5,time:5,place:5,object:5};
      let sum={people:0,affairs:0,time:0,place:0,object:0},c=0;
      moving.forEach(i=>{
        const ln=lines.find(l=>l.index===i);
        let s=ln&&ln.score?ln.score:5;
        let a=ln&&ln.aspect?ln.aspect:null;
        if(a){
          sum.people+=clamp(a.people??s);
          sum.affairs+=clamp(a.affairs??s);
          sum.time+=clamp(a.time??s);
          sum.place+=clamp(a.place??s);
          sum.object+=clamp(a.object??s);
        } else {
          sum.people+=s;sum.affairs+=s;sum.time+=s;sum.place+=s;sum.object+=s;
        }
        c++;
      });
      return {people:sum.people/c,affairs:sum.affairs/c,time:sum.time/c,place:sum.place/c,object:sum.object/c};
    }
    function computeScores(res){
      const main=getAspect(res.main);
      const change=getAspect(res.change);
      const hu=getAspect(res.hu);
      const mv=movingImpact(res.main,res.moving);
      let out={};
      ASPECTS.forEach(a=>{
        out[a.k]=WEIGHTS.moving*mv[a.k]+WEIGHTS.main*main[a.k]+WEIGHTS.change*change[a.k]+WEIGHTS.hu*hu[a.k];
      });
      return out;
    }
    function renderScores(scores){
      const wrap=document.getElementById('scoreWrap');
      wrap.innerHTML='';
      ASPECTS.forEach(a=>{
        const v=clamp(scores[a.k]);
        const card=document.createElement('div');card.className='score-card';
        const name=document.createElement('div');name.textContent=`【${a.n}】`;
        const barW=document.createElement('div');barW.className='score-bar-wrap';
        const bar=document.createElement('div');bar.className='score-bar';bar.style.width=(v*10)+'%';
        barW.appendChild(bar);
        const val=document.createElement('div');val.className='score-val';val.textContent=v.toFixed(1);
        card.appendChild(name);card.appendChild(barW);card.appendChild(val);
        wrap.appendChild(card);
      });
    }

    document.getElementById('judgeBtn').addEventListener('click',()=>{
      const sc=computeScores(currentResult);
      renderScores(sc);
      document.getElementById('judgeBox').classList.remove('hidden');
    });
  </script></body>
</html>
