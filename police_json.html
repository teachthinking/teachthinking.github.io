<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>易經資料編輯器</title>
    <style>
        body { font-family: '微軟正黑體', 'Microsoft JhengHei', sans-serif; background-color: #f4f4f9; color: #333; padding: 20px; }
        .container { max-width: 800px; margin: auto; background-color: #fff; padding: 30px; border-radius: 10px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); }
        h1 { text-align: center; color: #2c3e50; }
        .controls { text-align: center; margin-bottom: 20px; }
        button { padding: 10px 20px; margin: 5px; border: none; border-radius: 5px; background-color: #3498db; color: white; font-size: 1em; cursor: pointer; transition: background-color 0.3s; }
        button:hover { background-color: #2980b9; }
        .section { margin-bottom: 20px; border-bottom: 2px solid #ecf0f1; padding-bottom: 15px; }
        .section h2 { color: #34495e; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .section h2:hover { color: #2c3e50; }
        .section-content { display: none; padding-left: 20px; border-left: 2px solid #bdc3c7; }
        .open { display: block; }
        .hexagram-item { margin-bottom: 10px; padding: 10px; border: 1px solid #ddd; border-radius: 5px; background-color: #f9f9f9; }
        .hexagram-item h3 { margin: 0; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .hexagram-item textarea { width: 100%; height: 80px; margin-top: 10px; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; resize: vertical; }
        .case-type-item { margin-bottom: 10px; padding: 10px; border: 1px solid #ddd; border-radius: 5px; background-color: #f9f9f9; }
        .case-type-item h3 { margin: 0; }
        .case-type-item p { margin: 5px 0; }
        .case-related-item { margin: 5px 0; padding: 8px; background-color: #e8f4f8; border: 1px solid #d4eaf0; border-radius: 4px; }
        .file-upload-section { margin-top: 15px; border-top: 1px dashed #ccc; padding-top: 15px; text-align: left; }
    </style>
</head>
<body>

<div class="container">
    <h1>易經資料編輯器</h1>
    <div class="controls">
        <button id="downloadBtn">下載 JSON 檔案</button>
        <button id="refreshBtn">刷新介面</button>
    </div>

    <div class="file-upload-section">
        <label for="jsonFile">或手動上傳 JSON 資料檔：</label>
        <input type="file" id="jsonFile" accept=".json">
    </div>

    <div id="editor">
        <p style="text-align:center; color:#7f8c8d;">請上傳 JSON 檔案或等待預設檔案載入。</p>
    </div>
</div>

<script>
    let jsonData = {};

    window.onload = async () => {
        const fileInput = document.getElementById('jsonFile');
        fileInput.addEventListener('change', handleFileUpload);
        await loadDefaultData();
    };

    async function loadDefaultData() {
        try {
            const response = await fetch('hexagram_data.json');
            if (!response.ok) {
                throw new Error('無法載入預設 JSON 檔案。');
            }
            jsonData = await response.json();
            console.log('預設卦象資料載入成功！');
            renderEditor();
        } catch (error) {
            console.error('載入預設資料失敗:', error);
            document.getElementById('editor').innerHTML = '<p style="text-align:center; color:#e74c3c;">無法自動載入預設資料，請手動上傳檔案。</p>';
        }
    }

    function handleFileUpload(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                jsonData = JSON.parse(e.target.result);
                console.log('使用者上傳的資料載入成功！');
                alert('已成功載入新的 JSON 檔案。');
                renderEditor();
            } catch (error) {
                console.error('解析 JSON 檔案失敗:', error);
                alert('無效的 JSON 檔案，請檢查格式。');
            }
        };
        reader.readAsText(file);
    }

    function renderEditor() {
        const editorDiv = document.getElementById('editor');
        editorDiv.innerHTML = '';

        const hexagramsSection = document.createElement('div');
        hexagramsSection.className = 'section';
        hexagramsSection.innerHTML = `<h2>六十四卦卦象解釋<span style="font-size:0.8em; color:#999; margin-left:10px;">點擊展開/收合</span></h2><div class="section-content"></div>`;
        const hexagramsContent = hexagramsSection.querySelector('.section-content');
        
        for (const key in jsonData.hexagrams) {
            const hexagram = jsonData.hexagrams[key];
            const itemDiv = document.createElement('div');
            itemDiv.className = 'hexagram-item';
            itemDiv.innerHTML = `
                <h3>${key} - ${hexagram.name} <span style="font-size:0.8em; color:#999; margin-left:10px;">點擊編輯</span></h3>
                <div class="editor-content" style="display:none;">
                    <textarea data-key="${key}">${hexagram.summary}</textarea>
                </div>
            `;
            itemDiv.querySelector('h3').onclick = () => {
                const editorContent = itemDiv.querySelector('.editor-content');
                editorContent.style.display = editorContent.style.display === 'none' ? 'block' : 'none';
            };
            hexagramsContent.appendChild(itemDiv);
        }
        editorDiv.appendChild(hexagramsSection);

        const caseAnalysisSection = document.createElement('div');
        caseAnalysisSection.className = 'section';
        caseAnalysisSection.innerHTML = `<h2>案件類型分析<span style="font-size:0.8em; color:#999; margin-left:10px;">點擊展開/收合</span></h2><div class="section-content"></div>`;
        const caseAnalysisContent = caseAnalysisSection.querySelector('.section-content');
        
        for (const key in jsonData.case_analysis) {
            const caseType = jsonData.case_analysis[key];
            const itemDiv = document.createElement('div');
            itemDiv.className = 'case-type-item';
            itemDiv.innerHTML = `
                <h3>${caseType.name}</h3>
                <p>${caseType.summary}</p>
                <h4>相關卦象</h4>
                <div class="case-related-list"></div>
            `;
            const relatedList = itemDiv.querySelector('.case-related-list');
            for (const relatedKey in caseType.related_hexagrams) {
                const relatedItem = document.createElement('div');
                relatedItem.className = 'case-related-item';
                relatedItem.textContent = `${jsonData.hexagrams[relatedKey]?.name}：${caseType.related_hexagrams[relatedKey]}`;
                relatedList.appendChild(relatedItem);
            }
            caseAnalysisContent.appendChild(itemDiv);
        }
        editorDiv.appendChild(caseAnalysisSection);

        editorDiv.querySelectorAll('textarea').forEach(textarea => {
            textarea.addEventListener('input', (e) => {
                const key = e.target.dataset.key;
                jsonData.hexagrams[key].summary = e.target.value;
            });
        });

        editorDiv.querySelectorAll('.section h2').forEach(h2 => {
            h2.addEventListener('click', () => {
                h2.nextElementSibling.classList.toggle('open');
            });
        });
    }

    document.getElementById('downloadBtn').addEventListener('click', () => {
        const dataStr = JSON.stringify(jsonData, null, 2);
        const blob = new Blob([dataStr], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'hexagram_data.json';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    });

    document.getElementById('refreshBtn').addEventListener('click', () => {
        if (confirm('確定要刷新介面嗎？所有未下載的修改都將遺失！')) {
            window.location.reload();
        }
    });
</script>

</body>
</html>
