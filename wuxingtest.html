<script>
    // 八卦對應數字和爻象（從下到上）
    const trigrams = {
        1: {"name": "乾", "element": "金", "yao": [1, 1, 1]},
        2: {"name": "兌", "element": "金", "yao": [0, 1, 1]},
        3: {"name": "離", "element": "火", "yao": [1, 0, 1]},
        4: {"name": "震", "element": "木", "yao": [0, 0, 1]},
        5: {"name": "巽", "element": "木", "yao": [1, 1, 0]},
        6: {"name": "坎", "element": "水", "yao": [0, 1, 0]},
        7: {"name": "艮", "element": "土", "yao": [1, 0, 0]},
        8: {"name": "坤", "element": "土", "yao": [0, 0, 0]}
    };

    // 五行生克關係
    const elementRelations = {
        "金": { "克": "木", "生": "水", "被克": "火", "被生": "土" },
        "木": { "克": "土", "生": "火", "被克": "金", "被生": "水" },
        "水": { "克": "火", "生": "木", "被克": "土", "被生": "金" },
        "火": { "克": "金", "生": "土", "被克": "水", "被生": "木" },
        "土": { "克": "水", "生": "金", "被克": "木", "被生": "火" }
    };

    // 根據三爻查找對應的卦
    function findTrigramByYao(yaoArray) {
        for (const [key, value] of Object.entries(trigrams)) {
            if (JSON.stringify(value.yao) === JSON.stringify(yaoArray)) {
                return parseInt(key);
            }
        }
        return 1; // 默認返回乾卦
    }

    // 計算互卦（正確算法）
    function calculateHuGua(benGua) {
        // 獲取本卦的六爻（下卦三爻 + 上卦三爻）
        const xiaYao = trigrams[benGua.xia].yao; // 下卦三爻
        const shangYao = trigrams[benGua.shang].yao; // 上卦三爻
        const sixYao = [...xiaYao, ...shangYao]; // 六爻（從初爻到上爻）
        
        // 互卦的下卦：本卦的二、三、四爻
        const huXiaYao = [sixYao[1], sixYao[2], sixYao[3]];
        // 互卦的上卦：本卦的三、四、五爻
        const huShangYao = [sixYao[2], sixYao[3], sixYao[4]];
        
        return {
            shang: findTrigramByYao(huShangYao),
            xia: findTrigramByYao(huXiaYao)
        };
    }

    // 計算變卦（正確算法）
    function calculateBianGua(benGua, movingYao) {
        // 獲取本卦的六爻
        const xiaYao = [...trigrams[benGua.xia].yao]; // 下卦三爻（複製）
        const shangYao = [...trigrams[benGua.shang].yao]; // 上卦三爻（複製）
        const sixYao = [...xiaYao, ...shangYao]; // 六爻（從初爻到上爻）
        
        // 變爻（從1開始計數，對應數組索引要減1）
        const yaoIndex = movingYao - 1;
        // 陰陽互變
        sixYao[yaoIndex] = sixYao[yaoIndex] === 1 ? 0 : 1;
        
        // 分為下卦和上卦
        const bianXiaYao = sixYao.slice(0, 3);
        const bianShangYao = sixYao.slice(3, 6);
        
        return {
            shang: findTrigramByYao(bianShangYao),
            xia: findTrigramByYao(bianXiaYao)
        };
    }

    // 計算五行生克關係
    function calculateRelation(gua) {
        const shangElement = trigrams[gua.shang].element;
        const xiaElement = trigrams[gua.xia].element;
        
        if (shangElement === xiaElement) {
            return "BH"; // 比和
        } else if (elementRelations[shangElement]["生"] === xiaElement) {
            return "SS"; // 上卦生下卦（體生用）
        } else if (elementRelations[shangElement]["克"] === xiaElement) {
            return "SK"; // 上卦克下卦（體克用）
        } else if (elementRelations[xiaElement]["生"] === shangElement) {
            return "WS"; // 下卦生上卦（用生體）
        } else if (elementRelations[xiaElement]["克"] === shangElement) {
            return "WK"; // 下卦克上卦（用克體）
        }
        
        return "BH"; // 默認比和
    }
</script>
