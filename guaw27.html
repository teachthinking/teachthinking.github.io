<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>張老師易經卜卦</title>
  <style>
    :root {
      --primary-color: #2c3e50;
      --secondary-color: #3498db;
      --background-color: #f4f7f9;
      --card-bg: #ffffff;
      --border-color: #e0e6ed;
      --text-color: #333333;
      --sub-text-color: #7f8c8d;
      --shadow-light: 0 4px 12px rgba(0, 0, 0, 0.05);
      --border-radius: 12px;
      --font-family: 'Noto Sans TC', sans-serif;
    }

    body {
      font-family: var(--font-family);
      background: var(--background-color);
      color: var(--text-color);
      padding: 20px;
      line-height: 1.6;
    }

    .container {
      max-width: 1000px;
      margin: 0 auto;
      background: var(--card-bg);
      padding: 25px;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow-light);
    }

    h1 {
      margin: 0 0 8px 0;
      font-size: 28px;
      color: var(--primary-color);
    }

    h2.subtitle {
      margin: 0 0 20px 0;
      color: var(--sub-text-color);
      font-weight: 400;
      font-size: 16px;
      border-bottom: 1px solid var(--border-color);
      padding-bottom: 15px;
    }

    .tab-buttons {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }

    .tab-button {
      padding: 10px 18px;
      border-radius: var(--border-radius);
      border: 1px solid var(--border-color);
      background: transparent;
      cursor: pointer;
      color: var(--sub-text-color);
      transition: all 0.3s ease;
      font-size: 15px;
    }

    .tab-button.active {
      background: var(--primary-color);
      color: #fff;
      border-color: var(--primary-color);
    }

    .tab-content {
      display: none;
      padding-top: 10px;
    }

    .tab-content.active {
      display: block;
    }

    .row {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
      margin: 12px 0;
    }

    .hint {
      font-size: 13px;
      color: var(--sub-text-color);
      line-height: 1.5;
    }

    .gua-box {
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius);
      padding: 20px;
      background: var(--background-color);
      margin-bottom: 20px;
    }

    .hidden {
      display: none;
    }

    button.primary, .pill {
      padding: 10px 18px;
      background: var(--primary-color);
      color: #fff;
      border-radius: var(--border-radius);
      border: 0;
      cursor: pointer;
      font-size: 15px;
      transition: background-color 0.3s ease;
    }

    button.primary:hover {
      background: var(--secondary-color);
    }

    input, select, textarea {
      padding: 10px;
      border-radius: 8px;
      border: 1px solid var(--border-color);
      font-size: 14px;
      width: 100%;
      box-sizing: border-box;
    }
    
    label {
      font-size: 14px;
      color: var(--text-color);
    }

    .pill {
      display: inline-block;
      padding: 6px 12px;
      border-radius: 999px;
      background: var(--border-color);
      font-size: 12px;
      color: var(--sub-text-color);
      cursor: pointer;
      transition: background-color 0.3s ease;
      white-space: nowrap;
    }
    .pill:hover { background: #dcdfe4; }

    #line-explanation > div {
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px dashed var(--border-color);
    }
    
    /* 卦象視覺優化 */
    .gua-display-container {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
    }
    .gua-display-item {
        flex: 1 1 300px;
        min-width: 0;
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius);
        padding: 20px;
        background: var(--background-color);
        box-shadow: var(--shadow-light);
    }
    .gua-display-item h3 {
        margin-top: 0;
        font-size: 20px;
        color: var(--primary-color);
    }
    .gua-line {
      font-family: 'Courier New', monospace;
      font-size: 22px;
      line-height: 1.3;
      margin-top: 15px;
      padding: 0 10px;
    }
    .gua-line div {
      padding: 3px 0;
    }
    .gua-yang, .gua-yin, .gua-moving {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 1.3em;
        position: relative;
    }
    .gua-yang::before {
      content: '';
      width: 100%;
      height: 6px;
      background: var(--primary-color);
    }
    .gua-yin::before,
    .gua-yin::after {
      content: '';
      width: 45%;
      height: 6px;
      background: var(--primary-color);
    }
    .gua-moving {
        font-weight: bold;
        color: #e74c3c;
    }
    .gua-moving.yang::before {
      content: '';
      width: 100%;
      height: 6px;
      background: #e74c3c;
    }
    .gua-moving.yang::after {
      content: '◎';
      margin-left: 10px;
      font-size: 0.8em;
    }
    .gua-moving.yin::before,
    .gua-moving.yin::after {
        content: '×';
        margin: 0;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 0.8em;
    }
    .gua-moving.yin::before { content: ''; width: 45%; height: 6px; background: #e74c3c; left: 0; transform: translateY(-50%); }
    .gua-moving.yin::after { content: ''; width: 45%; height: 6px; background: #e74c3c; right: 0; left: auto; transform: translateY(-50%); }
    .gua-moving.yin span { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #e74c3c; }

    /* 五行分析區 */
    .wuxing-analysis { margin-top: 25px; border-top: 2px solid var(--border-color); padding-top: 20px; }
    .wuxing-box { padding: 15px 20px; background: var(--background-color); border-radius: var(--border-radius); margin-bottom: 15px; }
    .wuxing-result { font-weight: bold; }
    .wuxing-desc { font-size: 14px; margin-top: 8px; color: var(--sub-text-color); }
    .wuxing-status { font-weight: bold; }
    .wuxing-status.大吉 { color: #2ecc71; }
    .wuxing-status.吉 { color: #27ae60; }
    .wuxing-status.平 { color: #3498db; }
    .wuxing-status.凶 { color: #e67e22; }
    .wuxing-status.大凶 { color: #e74c3c; }

    /* 解卦區 */
    .question-analysis { margin-top: 25px; border-top: 2px solid var(--primary-color); padding-top: 20px; }
    .analysis-item { margin-bottom: 25px; background: var(--background-color); padding: 20px; border-radius: var(--border-radius); border-left: 4px solid var(--secondary-color); }
    .analysis-item h4 { margin-top: 0; color: var(--primary-color); font-size: 18px; border-bottom: 1px dashed var(--border-color); padding-bottom: 8px; }
    .analysis-item p { margin-top: 10px; line-height: 1.6; }
    .analysis-status { font-weight: bold; }
    .analysis-status.吉 { color: #27ae60; }
    .analysis-status.凶 { color: #e67e22; }
    .analysis-status.平 { color: #3498db; }
    .analysis-status.大凶 { color: #e74c3c; }
    .analysis-status.大吉 { color: #2ecc71; }
    .analysis-item .suggestion { background: #ecf9f0; border-left-color: #2ecc71; }
    .analysis-item .suggestion h5 { margin: 0 0 8px 0; font-size: 16px; color: #2ecc71; }
    .analysis-item .suggestion ul, .analysis-item .suggestion p { margin: 0; padding-left: 20px; }
    .analysis-item .suggestion li { margin-bottom: 5px; }
    .trigram-details { font-size: 14px; background: #ecf0f1; padding: 15px; border-radius: 8px; border-left: 3px solid #bdc3c7; margin-top: 15px; }

    .detailed-analysis { margin-top: 25px; border-top: 2px solid var(--primary-color); padding-top: 20px; }
    .detailed-section { margin-bottom: 25px; background: var(--background-color); padding: 20px; border-radius: var(--border-radius); border-left: 4px solid var(--secondary-color); }
    .detailed-section h5 { margin-top: 0; margin-bottom: 10px; font-size: 16px; color: var(--primary-color); }
    .analysis-message { padding: 15px; background: #fff3e0; border-left: 4px solid #f39c12; border-radius: var(--border-radius); font-size: 15px; line-height: 1.5; color: #333; }

    /* 新增：評分條樣式 */
    .score-container { margin-top: 10px; }
    .score-card {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 8px;
    }
    .score-label { flex-shrink: 0; min-width: 60px; font-weight: 500; }
    .score-bar-wrap {
        flex-grow: 1;
        height: 12px;
        background: #e9eef2;
        border-radius: 6px;
        overflow: hidden;
    }
    .score-bar {
        height: 100%;
        width: 0;
        transition: width 0.6s ease-out;
        background: linear-gradient(to right, #e74c3c, #f39c12, #2ecc71);
    }
    .score-val {
        flex-shrink: 0;
        min-width: 40px;
        text-align: right;
        font-weight: 600;
        color: var(--secondary-color);
    }
    
    /* 人事時地物象徵區塊 */
    .symbolism-section {
        margin-top: 15px;
        padding-top: 15px;
        border-top: 1px dashed var(--border-color);
    }
    .symbolism-section h6 {
        margin: 0 0 10px 0;
        font-size: 15px;
        color: var(--primary-color);
    }
    .symbolism-section ul {
        margin: 0;
        padding-left: 20px;
        list-style: none;
    }
    .symbolism-section ul li {
        margin-bottom: 6px;
        font-size: 14px;
    }
    .symbolism-section ul li strong {
        color: var(--secondary-color);
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>張老師易經卜卦</h1>
    <h2 id="subtitle" class="subtitle">載入中…（若無 quotes.json 顯示預設句）</h2>

    <div class="tab-buttons">
      <button class="tab-button active" data-target="tab-number">數字取卦</button>
      <button class="tab-button" data-target="tab-time">時間取卦</button>
      <button class="tab-button" data-target="tab-image">以象取卦</button>
      <button class="tab-button" data-target="tab-manual">手動取卦</button>
    </div>

    <div id="tab-number" class="tab-content active">
      <h3>數字取卦</h3>
      <div class="row">
        <input id="numUpper" type="number" placeholder="上卦數字 (100-999)" min="100" max="999" />
        <input id="numLower" type="number" placeholder="下卦數字 (100-999)" min="100" max="999" />
        <input id="numMoving" type="number" placeholder="動爻數字 (100-999)" min="100" max="999" />
        <button id="btnNumber" class="primary">生成卦象</button>
      </div>
      <div class="row"><span class="hint">提示：輸入 100–999。上/下卦 = 數字 % 8（0 視為 8），動爻 = 數字 % 6（0 視為 6）。頁面載入會隨機預設三個數字。</span></div>
    </div>

    <div id="tab-manual" class="tab-content">
      <h3>手動取卦</h3>
      <div class="row">
        <select id="selUpper">
          <option value="1">1.乾☰</option>
          <option value="2">2.兌☱</option>
          <option value="3">3.離☲</option>
          <option value="4">4.震☳</option>
          <option value="5">5.巽☴</option>
          <option value="6">6.坎☵</option>
          <option value="7">7.艮☶</option>
          <option value="8">8.坤☷</option>
        </select>
        <select id="selLower">
          <option value="1">1.乾☰</option>
          <option value="2">2.兌☱</option>
          <option value="3">3.離☲</option>
          <option value="4">4.震☳</option>
          <option value="5">5.巽☴</option>
          <option value="6">6.坎☵</option>
          <option value="7">7.艮☶</option>
          <option value="8">8.坤☷</option>
        </select>
        <input id="inputMoving" type="text" placeholder="變爻 (例: 1,3 或 2)" />
        <button id="btnManual" class="primary">生成卦象</button>
      </div>
    </div>

    <div id="tab-time" class="tab-content">
      <h3>時間取卦</h3>
      <div class="row" style="align-items: center; gap: 15px;">
        <label>
          <input type="radio" name="time-method" value="modern" checked> 現代時間
        </label>
        <label>
          <input type="radio" name="time-method" value="traditional"> 傳統時辰
        </label>
      </div>

      <div id="time-modern" class="time-input-group">
        <div class="row">
          <input id="dtInput" type="datetime-local" />
          <span id="nowQuick" class="pill">使用現在時間</span>
        </div>
      </div>
      
      <div id="time-traditional" class="time-input-group hidden">
        <div class="row">
          <input id="dateInput" type="date" />
          <select id="shichenInput">
            <option value="1">子時 (23-1)</option>
            <option value="2">丑時 (1-3)</option>
            <option value="3">寅時 (3-5)</option>
            <option value="4">卯時 (5-7)</option>
            <option value="5">辰時 (7-9)</option>
            <option value="6">巳時 (9-11)</option>
            <option value="7">午時 (11-13)</option>
            <option value="8">未時 (13-15)</option>
            <option value="9">申時 (15-17)</option>
            <option value="10">酉時 (17-19)</option>
            <option value="11">戌時 (19-21)</option>
            <option value="12">亥時 (21-23)</option>
          </select>
          <input id="minuteInput" type="number" placeholder="分 (0-59)" min="0" max="59" value="0" style="width: 100px;"/>
        </div>
      </div>

      <div class="row">
        <button id="btnTime" class="primary">生成卦象</button>
      </div>
      <div id="timeHint" class="row"><span class="hint">算法：上卦 = (年+月+日) % 8；下卦 = (年+月+日+時) % 8；動爻 = (年+月+日+時+分) % 6；餘數為 0 則視為 8 或 6。</span></div>
    </div>

    <div id="tab-image" class="tab-content">
      <h3>以象取卦</h3>
      <div class="row">
        <label>上卦：不拘泥於象，以卦德取之，從生活中的各種現象、聲音、文字，或人的行為舉止中，尋找與卦象的聯繫，離如聽到敲門3下可取離卦。</label>
        <select id="upperImageSelect" style="min-width:260px">
          <option value="1">乾1（金）—天、健、頭、父親</option>
          <option value="2">兌2（金）—澤、悅、口、少女</option>
          <option value="3">離3（火）—火、麗、目、中女</option>
          <option value="4">震4（木）—雷、動、足、長男</option>
          <option value="5">巽5（木）—風、入、股、長女</option>
          <option value="6">坎6（水）—水、陷、耳、中男</option>
          <option value="7">艮7（土）—山、止、手、少男</option>
          <option value="8">坤8（土）—地、順、腹、母親</option>
        </select>
      </div>
      <div class="row">
        <label>下卦：[後天方位，面(前)南]亦可取象數，例如聽到連續敲門第二次4下取震。</label>
        <select id="lowerDirectionSelect">
          <option value="6">北_後面（坎6）</option><option value="3">南_前面（離3）</option><option value="4">東_左邊（震4）</option><option value="2">西_右邊（兌2）</option>
          <option value="7">東北_左後（艮7）</option><option value="1">西北_右後（乾1）</option><option value="5">東南_左前（巽5）</option><option value="8">西南_右前（坤8）</option>
        </select>
      </div>
      <div class="row">
        <input id="imageMovingInput" type="number" placeholder="動爻 1~6" min="1" max="6" style="width:110px" />
        <label><input id="imageUseMinute" type="checkbox" /> 用當前分鐘取動爻</label>
      </div>
      <div class="row">
        <button id="btnImage" class="primary">生成卦象</button>
      </div>
    </div>

    <div id="result" class="hidden">
      <h2>卦象結果</h2>
      <div class="gua-display-container">
          <div class="gua-display-item">
            <h3 id="guaName"></h3>
            <div id="guaImage" class="gua-line"></div>
            <div id="guaNote" class="hint" style="margin-top:15px"></div>
          </div>
          <div class="gua-display-item">
            <h3 id="changeGuaName"></h3>
            <div id="changeGuaImage" class="gua-line"></div>
          </div>
          <div class="gua-display-item">
            <h3 id="huGuaName"></h3>
            <div id="huGuaImage" class="gua-line"></div>
          </div>
      </div>

      <div id="line-explanation" class="gua-box hidden">
        <h3>動爻解釋（多變爻逐條列出）</h3>
        <div id="lineTextDisplay"></div>
      </div>

      <div id="judgeBox" class="gua-box hidden">
        <div class="row">
            <select id="questionSelector" style="flex-grow:1;">
                <option value="1">請選擇問事類別：</option>
                <option value="love">1. 感情問題</option>
                <option value="career">2. 工作/學業</option>
                <option value="wealth">3. 財運問題</option>
                <option value="health">4. 健康問題</option>
                <option value="relationship">5. 人際關係</option>
                <option value="life">6. 生活/運勢</option>
                <option value="guidance">7. 尋找指引</option>
            </select>
            <button id="analyzeBtn" class="primary">分析</button>
        </div>

        <div id="questionAnalysisResult" class="question-analysis hidden"></div>

        <div id="wuxingAnalysis" class="wuxing-analysis hidden">
          <h4>梅花心易五行解卦（整體判斷）</h4>
          <div id="wuxingContent"></div>
        </div>
        
        <div id="detailedAnalysis" class="detailed-analysis hidden">
            <h4>詳細象徵分析（僅適用於單一動爻）</h4>
            <div id="detailedContent"></div>
        </div>
      </div>

      <div style="margin-top:8px"><button id="judgeBtn" class="primary">顯示綜合判斷</button></div>
    </div>
  </div>

  <script>
  /* ===========================
     資料：三爻（1..8）對應與工具
     =========================== */
  const guaTable = {
    // 數字 : [初爻, 二爻, 三爻, 五行]
    1:[1,1,1,'金'], 2:[1,1,0,'金'], 3:[1,0,1,'火'], 4:[1,0,0,'木'],
    5:[0,1,1,'木'], 6:[0,1,0,'水'], 7:[0,0,1,'土'], 8:[0,0,0,'土']
  };
  const trigramName = {1:'乾',2:'兌',3:'離',4:'震',5:'巽',6:'坎',7:'艮',8:'坤'};
  const triIndexByLines = new Map(Object.entries(guaTable).map(([i,arr])=>[JSON.stringify(arr.slice(0,3)), +i]));
  
  let hexList = {};
  const hexByLines = new Map();
  const hexNameByCombinedName = new Map();
  let wuxingExplanations = {};
  let trigramExplanations = {};
  let dataReady = false;
  
  // 輔助函數：根據五行關係判斷吉凶
  function getWuxingOutcome(tiWuxing, yongWuxing) {
      const relations = {
          '金': { '生': '水', '剋': '木', '被生': '土', '被剋': '火', '比和': '金' },
          '木': { '生': '火', '剋': '土', '被生': '水', '被剋': '金', '比和': '木' },
          '水': { '生': '木', '剋': '火', '被生': '金', '被剋': '土', '比和': '水' },
          '火': { '生': '土', '剋': '金', '被生': '木', '被剋': '水', '比和': '火' },
          '土': { '生': '金', '剋': '水', '被生': '火', '被剋': '木', '比和': '土' }
      };
      if (!tiWuxing || !yongWuxing) return { relation: '未知', status: '平', explanation: '五行資料不完整。' };

      let relationType, status;
      if (relations[yongWuxing]['生'] === tiWuxing) {
          relationType = '用生體';
          status = '大吉';
      } else if (relations[tiWuxing]['剋'] === yongWuxing) {
          relationType = '體克用';
          status = '吉';
      } else if (tiWuxing === yongWuxing) {
          relationType = '比和';
          status = '平';
      } else if (relations[tiWuxing]['生'] === yongWuxing) {
          relationType = '體生用';
          status = '凶';
      } else if (relations[yongWuxing]['剋'] === tiWuxing) {
          relationType = '用克體';
          status = '大凶';
      } else {
          relationType = '未知';
          status = '平';
      }

      return { relation: relationType, status: status };
  }
  
  // 異步載入所有 JSON 資料
  Promise.allSettled([
    fetch('hexagrams.json').then(r => r.ok ? r.json() : Promise.reject('無法載入 hexagrams.json')),
    fetch('quotes.json').then(r => r.ok ? r.json() : Promise.reject('無法載入 quotes.json')),
    fetch('wuxing_explanations.json').then(r => r.ok ? r.json() : Promise.reject('無法載入 wuxing_explanations.json')),
    fetch('trigram_explanations.json').then(r => r.ok ? r.json() : Promise.reject('無法載入 trigram_explanations.json'))
  ]).then(results => {
    results.forEach(res => {
      if (res.status === 'fulfilled') {
        if (res.value && typeof res.value === 'object' && res.value['乾為天'] && !Array.isArray(res.value)) {
            hexList = res.value;
            for (const hexName in hexList) {
                const entry = hexList[hexName];
                const entryWithNames = { ...entry, name: hexName, title: entry.title || hexName };
                const linesBinary = entryWithNames.lines.map(line => {
                    const text = line.text;
                    if (text.includes('九') || text.includes('七')) return 1;
                    if (text.includes('六') || text.includes('八')) return 0;
                    return null;
                });
                if (linesBinary.every(val => val !== null)) {
                    hexByLines.set(JSON.stringify(linesBinary), entryWithNames);
                    const uIdx = triIndexByLines.get(JSON.stringify(linesBinary.slice(3, 6)));
                    const lIdx = triIndexByLines.get(JSON.stringify(linesBinary.slice(0, 3)));
                    if (uIdx && lIdx) {
                        const combinedName = `${trigramName[uIdx]}為${trigramName[lIdx]}`;
                        hexNameByCombinedName.set(combinedName, hexName);
                    }
                }
            }
        } else if (res.value && Array.isArray(res.value) && typeof res.value[0] === 'string') {
          document.getElementById('subtitle').textContent = res.value[Math.floor(Math.random() * res.value.length)] ||
          '易有太極，是生兩儀，兩儀生四象，四象生八卦。';
        } else if (res.value && typeof res.value === 'object' && res.value['體克用']) {
          wuxingExplanations = res.value;
        } else if (res.value && typeof res.value === 'object' && res.value['乾']) {
          trigramExplanations = res.value;
        } else {
          console.warn('無法識別的 JSON 資料格式:', res.value);
        }
      } else {
        console.error(`檔案載入失敗：${res.reason}`);
      }
    });
    dataReady = true;
    console.log("所有資料載入完成！");
  }).catch(error => {
    console.error('檔案載入失敗，可能原因：檔案路徑錯誤或網路問題。', error);
    document.getElementById('subtitle').textContent = '資料載入失敗。請檢查檔案路徑。';
  });

  /* --------------------------- 工具函數 --------------------------- */

  function showTabById(id){
    document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
    document.querySelectorAll(`[data-target="${id}"]`).forEach(b => b.classList.add('active'));
    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
    document.getElementById(id)?.classList.add('active');
  }
  document.querySelectorAll('.tab-button').forEach(btn => btn.addEventListener('click', () => showTabById(btn.dataset.target)));

  function formatGuaNameByLines(lines){
    if (!lines || lines.length !== 6) return '卦象錯誤';
    const uIdx = triIndexByLines.get(JSON.stringify(lines.slice(3, 6)));
    const lIdx = triIndexByLines.get(JSON.stringify(lines.slice(0, 3)));
    const combinedName = `${trigramName[uIdx]}為${trigramName[lIdx]}`;
    return hexNameByCombinedName.get(combinedName) || combinedName;
  }

  function findHexEntryByLines(lines){
    return hexByLines.get(JSON.stringify(lines));
  }

  function getGuaHtml(lines, moving=[]){
    let html = '';
    for (let i = 5; i >= 0; i--) {
      const val = lines[i];
      const yaoNo = i + 1;
      const isMoving = (moving || []).includes(yaoNo);
      if (isMoving) {
        html += `<div class="gua-moving ${val === 1 ? 'yang' : 'yin'}"><span>${val === 1 ? '◎' : '×'}</span></div>`;
      } else {
        html += `<div class="${val === 1 ? 'gua-yang' : 'gua-yin'}"></div>`;
      }
    }
    return html;
  }

  function getLineEntryFor(hexEntry, yaoIndex){
    return hexEntry?.lines.find(line => line && line.index === yaoIndex) || null;
  }

  function escapeHtml(s){
    if (s === null || s === undefined) return '';
    return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;');
  }
  function getTrigramInfo(guaIdx) {
    const name = trigramName[guaIdx];
    return { id: guaIdx, name: name, wuxing: guaTable[guaIdx][3], explanations: trigramExplanations[name] || {} };
  }
  function getTiYong(result) {
    if (result.moving.length !== 1) return { tiGua: null, yongGua: null };
    const uGua = getTrigramInfo(result.uIdx);
    const lGua = getTrigramInfo(result.lIdx);
    const movingYao = result.moving[0];
    if (movingYao >= 4 && movingYao <= 6) {
        return { tiGua: lGua, yongGua: uGua };
    } else {
        return { tiGua: uGua, yongGua: lGua };
    }
  }

  /* --------------------------- 生成並顯示卦象（主流程） --------------------------- */
  let currentResult = null;

  function makeFromUpperLower(uIdx, lIdx){
    const upper = guaTable[uIdx] || guaTable[1];
    const lower = guaTable[lIdx] || guaTable[1];
    return [...lower.slice(0,3), ...upper.slice(0,3)];
  }

  function generateGua(uIdx, lIdx, movingArr){
    const moving = Array.isArray(movingArr) ?
      movingArr.filter(x=>Number.isFinite(x) && x>=1 && x<=6) : [];

    const lines = makeFromUpperLower(uIdx, lIdx);
    const hexMain = findHexEntryByLines(lines);
    const mainName = hexMain ? hexMain.name : formatGuaNameByLines(lines);

    const changeLines = lines.slice();
    moving.forEach(n => {
        const idx = n - 1;
        if (idx>=0 && idx<6) changeLines[idx] = 1 - changeLines[idx];
    });

    const hexChange = findHexEntryByLines(changeLines);
    const changeName = hexChange ? hexChange.name : formatGuaNameByLines(changeLines);

    const huLinesBase = [ lines[1], lines[2], lines[3] ];
    const huLinesTop = [ lines[2], lines[3], lines[4] ];
    const huLines = [...huLinesBase, ...huLinesTop];
    const hexHu = findHexEntryByLines(huLines);
    const huName = hexHu ? hexHu.name : formatGuaNameByLines(huLines);

    document.getElementById('guaName').textContent = mainName;
    document.getElementById('guaImage').innerHTML = getGuaHtml(lines, moving);
    document.getElementById('guaNote').textContent = hexMain ? hexMain.symbolism.overall : '此卦象資料未提供。';

    document.getElementById('changeGuaName').textContent = changeName;
    document.getElementById('changeGuaImage').innerHTML = getGuaHtml(changeLines);

    document.getElementById('huGuaName').textContent = huName;
    document.getElementById('huGuaImage').innerHTML = getGuaHtml(huLines);
    
    document.getElementById('result').classList.remove('hidden');

    const result = {
        uIdx, lIdx, moving,
        mainHex: hexMain,
        changeHex: hexChange,
        huHex: hexHu
    };
    currentResult = result;
    
    renderLineExplanation(result);
    document.getElementById('judgeBox').classList.add('hidden');
    document.getElementById('questionAnalysisResult').classList.add('hidden');
    document.getElementById('wuxingAnalysis').classList.add('hidden');
    document.getElementById('detailedAnalysis').classList.add('hidden');
    document.getElementById('questionSelector').value = '1';
  }

  // 數字取卦
  function getRandomNumber(min, max) { return Math.floor(Math.random() * (max - min + 1)) + min; }
  function normalizeResult(num, mod) { const result = num % mod; return result === 0 ? mod : result; }
  
  const numUpperEl = document.getElementById('numUpper');
  const numLowerEl = document.getElementById('numLower');
  const numMovingEl = document.getElementById('numMoving');
  
  numUpperEl.value = getRandomNumber(100, 999);
  numLowerEl.value = getRandomNumber(100, 999);
  numMovingEl.value = getRandomNumber(100, 999);

  document.getElementById('btnNumber').addEventListener('click', ()=>{
      if (!dataReady) { alert('資料仍在載入中，請稍候再試。'); return; }
      const u = normalizeResult(parseInt(numUpperEl.value), 8);
      const l = normalizeResult(parseInt(numLowerEl.value), 8);
      const m = normalizeResult(parseInt(numMovingEl.value), 6);
      generateGua(u, l, [m]);
  });
  
  // 手動取卦
  document.getElementById('btnManual').addEventListener('click', ()=>{
      if (!dataReady) { alert('資料仍在載入中，請稍候再試。'); return; }
      const u = parseInt(document.getElementById('selUpper').value);
      const l = parseInt(document.getElementById('selLower').value);
      const movingStr = document.getElementById('inputMoving').value;
      const m = movingStr.split(',').map(s=>parseInt(s.trim())).filter(n => !isNaN(n) && n >= 1 && n <= 6);
      generateGua(u, l, m);
  });
  
  // 時間取卦
  document.getElementById('nowQuick').addEventListener('click', ()=>{
      const now = new Date();
      document.getElementById('dtInput').value = now.toISOString().substring(0, 16);
  });
  
  document.getElementById('btnTime').addEventListener('click', ()=>{
      if (!dataReady) { alert('資料仍在載入中，請稍候再試。'); return; }
      const method = document.querySelector('input[name="time-method"]:checked').value;
      let u, l, m;
      if (method === 'modern') {
          const dtStr = document.getElementById('dtInput').value;
          const dt = new Date(dtStr);
          const year = dt.getFullYear();
          const month = dt.getMonth() + 1;
          const day = dt.getDate();
          const hour = dt.getHours();
          const minute = dt.getMinutes();
          u = normalizeResult(year + month + day, 8);
          l = normalizeResult(year + month + day + hour, 8);
          m = normalizeResult(year + month + day + hour + minute, 6);
      } else {
          const dateStr = document.getElementById('dateInput').value;
          const date = new Date(dateStr);
          const year = date.getFullYear();
          const month = date.getMonth() + 1;
          const day = date.getDate();
          const shichen = parseInt(document.getElementById('shichenInput').value);
          const minute = parseInt(document.getElementById('minuteInput').value);
          u = normalizeResult(year + month + day, 8);
          l = normalizeResult(year + month + day + shichen, 8);
          m = normalizeResult(year + month + day + shichen + minute, 6);
      }
      generateGua(u, l, [m]);
  });
  
  // 以象取卦
  document.getElementById('btnImage').addEventListener('click', ()=>{
      if (!dataReady) { alert('資料仍在載入中，請稍候再試。'); return; }
      const u = parseInt(document.getElementById('upperImageSelect').value);
      const l = parseInt(document.getElementById('lowerDirectionSelect').value);
      let m;
      const useMinute = document.getElementById('imageUseMinute').checked;
      if (useMinute) {
          const now = new Date();
          m = normalizeResult(now.getMinutes(), 6);
      } else {
          m = parseInt(document.getElementById('imageMovingInput').value);
      }
      generateGua(u, l, [m]);
  });
  
  document.querySelectorAll('input[name="time-method"]').forEach(radio => {
    radio.addEventListener('change', (e) => {
      document.getElementById('time-modern').classList.toggle('hidden', e.target.value !== 'modern');
      document.getElementById('time-traditional').classList.toggle('hidden', e.target.value !== 'traditional');
    });
  });

  // 顯示動爻解釋
  function renderLineExplanation(result) {
    const lineExplanationDiv = document.getElementById('line-explanation');
    const lineTextDisplayDiv = document.getElementById('lineTextDisplay');
    lineTextDisplayDiv.innerHTML = '';
    
    if (result.moving.length === 0) {
        lineExplanationDiv.classList.add('hidden');
        return;
    }
    lineExplanationDiv.classList.remove('hidden');

    const lines = result.mainHex?.lines || [];
    for (const yaoIndex of result.moving) {
        const lineEntry = getLineEntryFor(result.mainHex, yaoIndex);
        if (!lineEntry) continue;
        
        let lineHtml = `
            <div>
                <h4>${lineEntry.text} (${yaoScores[lineEntry.index] || '無'})</h4>
                <p><strong>卦辭：</strong>${escapeHtml(lineEntry.meaning)}</p>
                <div class="score-container">
                  <div class="score-card">
                    <div class="score-label">分數</div>
                    <div class="score-bar-wrap">
                      <div class="score-bar" style="width: ${lineEntry.score * 10}%;"></div>
                    </div>
                    <div class="score-val">${lineEntry.score} / 10</div>
                  </div>
                </div>
                <div class="symbolism-section">
                    <h6>象徵分析</h6>
                    <ul>
                        <li><strong>人事：</strong>${escapeHtml(lineEntry.symbolism.people)}</li>
                        <li><strong>事務：</strong>${escapeHtml(lineEntry.symbolism.affairs)}</li>
                        <li><strong>時間：</strong>${escapeHtml(lineEntry.symbolism.time)}</li>
                        <li><strong>地點：</strong>${escapeHtml(lineEntry.symbolism.place)}</li>
                        <li><strong>物品：</strong>${escapeHtml(lineEntry.symbolism.object)}</li>
                    </ul>
                </div>
            </div>
        `;
        lineTextDisplayDiv.innerHTML += lineHtml;
    }
  }

  // 綜合判斷區塊
  const yaoScores = {
    1: '初爻', 2: '二爻', 3: '三爻', 4: '四爻', 5: '五爻', 6: '上爻'
  };
  function renderWuxingAnalysis(result) {
      const wuxingDiv = document.getElementById('wuxingAnalysis');
      const wuxingContentDiv = document.getElementById('wuxingContent');
      wuxingContentDiv.innerHTML = '';
      if (result.moving.length > 1) {
          wuxingDiv.classList.add('hidden');
          return;
      }
      wuxingDiv.classList.remove('hidden');

      const { tiGua, yongGua } = getTiYong(result);
      if (!tiGua || !yongGua) {
          wuxingContentDiv.innerHTML = `<div class="analysis-message">無法進行五行分析，請檢查卦象資料。</div>`;
          return;
      }

      const outcome = getWuxingOutcome(tiGua.wuxing, yongGua.wuxing);
      const explanation = wuxingExplanations[outcome.relation] || {};
      const statusClass = outcome.status;

      let wuxingHtml = `
          <div class="wuxing-box">
              <div class="wuxing-result">
                  本卦：${result.mainHex?.name || ''}（體卦：${tiGua.name} ${tiGua.wuxing}）
              </div>
              <div class="wuxing-result">
                  變卦：${result.changeHex?.name || ''}（用卦：${yongGua.name} ${yongGua.wuxing}）
              </div>
              <p class="wuxing-desc">${explanation.overall || '無相關解釋'}</p>
              <p><strong>五行關係：</strong>${outcome.relation}，<strong>吉凶：</strong><span class="wuxing-status ${statusClass}">${outcome.status}</span></p>
          </div>
      `;
      wuxingContentDiv.innerHTML = wuxingHtml;
  }
  
  function renderDetailedAnalysis(result) {
    const analysisDiv = document.getElementById('detailedAnalysis');
    const analysisContentDiv = document.getElementById('detailedContent');
    analysisContentDiv.innerHTML = '';

    if (result.moving.length !== 1) {
        analysisDiv.classList.add('hidden');
        return;
    }
    analysisDiv.classList.remove('hidden');

    const movingLineIndex = result.moving[0];
    const originalLineEntry = getLineEntryFor(result.mainHex, movingLineIndex);
    const changedLineEntry = getLineEntryFor(result.changeHex, movingLineIndex);

    let analysisHtml = '';
    if (originalLineEntry) {
      analysisHtml += `
        <div class="detailed-section">
            <h5>動爻（本卦）分析</h5>
            <p><strong>動爻卦辭：</strong> ${escapeHtml(originalLineEntry.meaning)}</p>
            <div class="symbolism-section">
                <h6>象徵分析</h6>
                <ul>
                    <li><strong>人事：</strong>${escapeHtml(originalLineEntry.symbolism.people)}</li>
                    <li><strong>事務：</strong>${escapeHtml(originalLineEntry.symbolism.affairs)}</li>
                    <li><strong>時間：</strong>${escapeHtml(originalLineEntry.symbolism.time)}</li>
                    <li><strong>地點：</strong>${escapeHtml(originalLineEntry.symbolism.place)}</li>
                    <li><strong>物品：</strong>${escapeHtml(originalLineEntry.symbolism.object)}</li>
                </ul>
            </div>
        </div>
      `;
    }
    
    if (changedLineEntry) {
        analysisHtml += `
          <div class="detailed-section">
              <h5>動爻（變卦）分析</h5>
              <p><strong>動爻卦辭：</strong> ${escapeHtml(changedLineEntry.meaning)}</p>
              <div class="symbolism-section">
                  <h6>象徵分析</h6>
                  <ul>
                      <li><strong>人事：</strong>${escapeHtml(changedLineEntry.symbolism.people)}</li>
                      <li><strong>事務：</strong>${escapeHtml(changedLineEntry.symbolism.affairs)}</li>
                      <li><strong>時間：</strong>${escapeHtml(changedLineEntry.symbolism.time)}</li>
                      <li><strong>地點：</strong>${escapeHtml(changedLineEntry.symbolism.place)}</li>
                      <li><strong>物品：</strong>${escapeHtml(changedLineEntry.symbolism.object)}</li>
                  </ul>
              </div>
          </div>
        `;
    }
    
    analysisContentDiv.innerHTML = analysisHtml;
  }
  
  function renderQuestionAnalysis(result) {
    const analysisDiv = document.getElementById('questionAnalysisResult');
    analysisDiv.innerHTML = '';
    analysisDiv.classList.add('hidden');
    
    const questionType = document.getElementById('questionSelector').value;
    if (questionType === '1') return;

    analysisDiv.classList.remove('hidden');

    const hexMain = result.mainHex;
    const hexChange = result.changeHex;
    const hexHu = result.huHex;
    const movingLineEntry = result.moving.length === 1 ? getLineEntryFor(hexMain, result.moving[0]) : null;

    let analysisHtml = '';
    
    const wuxingAnalysis = result.moving.length === 1 ? getWuxingOutcome(getTiYong(result).tiGua.wuxing, getTiYong(result).yongGua.wuxing) : null;
    const wuxingExplanation = wuxingAnalysis ? wuxingExplanations[wuxingAnalysis.relation] || {} : null;

    if (wuxingExplanation && wuxingExplanation[questionType]) {
        analysisHtml += `
            <div class="analysis-item">
                <h4>五行綜合判斷</h4>
                <p><strong>結論：</strong>${wuxingExplanation[questionType].overall || '無'}</p>
                <div class="analysis-status ${wuxingAnalysis.status}">${wuxingAnalysis.status}</div>
                <p><strong>卦象解讀：</strong></p>
                <ul>
                    <li><strong>本卦：</strong>${wuxingExplanation[questionType].本卦 || '無'}</li>
                    <li><strong>互卦：</strong>${wuxingExplanation[questionType].互卦 || '無'}</li>
                    <li><strong>變卦：</strong>${wuxingExplanation[questionType].變卦 || '無'}</li>
                </ul>
            </div>
        `;
    }

    if (hexMain && hexMain.judgment && hexMain.judgment[questionType]) {
        analysisHtml += `
            <div class="analysis-item">
                <h4>主卦（${hexMain.name}）</h4>
                <p>${hexMain.symbolism[questionType] || '無相關象徵'}</p>
            </div>
        `;
    }

    if (movingLineEntry && movingLineEntry.symbolism[questionType]) {
        analysisHtml += `
            <div class="analysis-item">
                <h4>動爻（${movingLineEntry.text}）</h4>
                <p><strong>卦辭：</strong>${escapeHtml(movingLineEntry.meaning)}</p>
                <p><strong>解讀：</strong>${escapeHtml(movingLineEntry.symbolism[questionType])}</p>
            </div>
        `;
    }
    
    if (trigramExplanations) {
        const uGua = getTrigramInfo(result.uIdx);
        const lGua = getTrigramInfo(result.lIdx);
        
        let trigramHtml = `
            <div class="analysis-item">
                <h4>八卦象徵分析</h4>
                <p>根據上下卦的特性，對問題進行補充解讀。</p>
                <div class="trigram-details">
                    <strong>上卦</strong>（${uGua.name}）：${uGua.explanations[questionType] || '無'}
                </div>
                <div class="trigram-details" style="margin-top:10px;">
                    <strong>下卦</strong>（${lGua.name}）：${lGua.explanations[questionType] || '無'}
                </div>
            </div>
        `;
        
        const cUGua = getTrigramInfo(triIndexByLines.get(result.changeHex?.lines.slice(3, 6).reverse()));
        const cLGua = getTrigramInfo(triIndexByLines.get(result.changeHex?.lines.slice(0, 3).reverse()));
        
        trigramHtml += `
          <div class="analysis-item">
            <h4>變卦象徵分析</h4>
            <p>變卦代表事情的未來發展與最終結果。</p>
            <div class="trigram-details">
                <strong>上變卦</strong>（${cUGua.name}）：${cUGua.explanations[questionType] || '無'}
            </div>
            <div class="trigram-details" style="margin-top:10px;">
                <strong>下變卦</strong>（${cLGua.name}）：${cLGua.explanations[questionType] || '無'}
            </div>
          </div>
        `;
        analysisHtml += trigramHtml;
    }

    analysisDiv.innerHTML += analysisHtml;

    if (!hexMain || !result.moving.length) {
      analysisDiv.innerHTML = `<div class="analysis-message">無法載入卦象資料或沒有動爻，請檢查 hexagrams.json 檔案。</div>`;
    }
  }


  document.getElementById('judgeBtn').addEventListener('click', ()=>{
    if (!currentResult) { alert('請先生成卦象'); return; }
    document.getElementById('judgeBox').classList.remove('hidden');
    renderWuxingAnalysis(currentResult);
    renderDetailedAnalysis(currentResult);
  });
  
  document.getElementById('analyzeBtn').addEventListener('click', ()=>{
      if (!dataReady) {
          alert('資料仍在載入中，請稍候再試。');
          return;
      }
      const questionType = document.getElementById('questionSelector').value;
      if (questionType === '1') {
          alert('請先選擇一個問事類別！');
          return;
      }

      renderQuestionAnalysis(currentResult);
      renderDetailedAnalysis(currentResult);
  });
  </script>
</body>
</html>
