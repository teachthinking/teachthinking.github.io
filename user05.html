<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>è¥¿å‹¢åœ‹å°æ™ºæ…§å›æ”¶ç®±ç®¡ç†ç³»çµ±</title>
  
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background-color: #f4f7f9; color: #333; }
    .container { max-width: 1200px; margin: auto; background: white; padding: 25px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    h2, h3 { color: #2c3e50; }
    button { padding: 10px 15px; margin: 5px; border: none; border-radius: 4px; color: white; cursor: pointer; transition: background-color 0.3s; }
    #status { font-weight: bold; }
    .status-box { padding: 10px; background: #f0f2f5; border-radius: 4px; text-align: center; font-weight: bold; color: white; transition: background-color 0.3s; }
    #status-overview { display: flex; justify-content: space-around; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; }
    
    .location-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 15px;
      margin-top: 20px;
    }
    .location-card {
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      text-align: center;
      transition: background-color 0.3s;
    }
    .location-card a {
      text-decoration: none;
      color: #333;
      display: block;
    }
    
    /* æŒ‰éˆ•é¡è‰² */
    #connect-btn { background-color: #007bff; }
    .action-btn { background-color: #f44336; }
    button:hover { filter: brightness(1.1); }
  </style>
</head>
<body>
  <div class="container">
    <h2>è¥¿å‹¢åœ‹å°æ™ºæ…§å›æ”¶ç®±ç®¡ç†ç³»çµ±</h2>
    
    <div>
      <label>Broker URL:</label>
      <input id="brokerUrl" value="wss://broker.mqttgo.io:8084/mqtt" size="45">
      <button id="connect-btn" onclick="connect()">é€£ç·š</button>
      <span style="margin-left: 20px;"><strong>é€£ç·šç‹€æ…‹:</strong> <span id="status" style="color:red;">ğŸ”´ æœªé€£ç·š</span></span>
    </div>
    
    <hr style="margin: 20px 0;">

    <h3>å›æ”¶ç®±ç‹€æ…‹ç¸½è¦½</h3>
    <div id="status-overview">
      <div id="status-0" class="status-box">ç©ºç®± (0): <span id="count-0">0</span></div>
      <div id="status-1" class="status-box">ä¸‰åˆ†æ»¿ (1): <span id="count-1">0</span></div>
      <div id="status-2" class="status-box">ä¸ƒåˆ†æ»¿ (2): <span id="count-2">0</span></div>
      <div id="status-3" class="status-box">æ»¿ç®± (3): <span id="count-3">0</span></div>
      <div id="status-4" class="status-box">ç•°å¸¸ (4): <span id="count-4">0</span></div>
    </div>
    
    <hr style="margin: 20px 0;">

    <h3>å›æ”¶ç®±ä½ç½®è³‡è¨Šèˆ‡åœ°åœ–é€£çµ</h3>
    <div class="location-grid" id="locationGrid">
    </div>
    <div style="text-align: center; margin-top: 20px;">
      <button class="action-btn" onclick="openAllLocations()">ã€”å…¨éƒ¨ä½ç½®æ¨™ç¤ºã€•</button>
    </div>
  </div>

  <script>
    let client;
    
    const colors = ["#4CAF50", "#FFC107", "#FF9800", "#F44336", "#9C27B0"];
    const statusNames = ["ç©ºç®±", "ä¸‰åˆ†æ»¿", "ä¸ƒåˆ†æ»¿", "æ»¿ç®±", "ç•°å¸¸"];
    
    const topicCount = 15;
    const boxLabels = Array.from({ length: topicCount }, (_, i) => `å›æ”¶ç®± ${i + 1}`);
    const topics = Array.from({ length: topicCount }, (_, i) => `SSSES/BOX${i + 1}/S`);
    
    const chartData = {
      bar: {
        labels: boxLabels,
        datasets: [{
          label: 'æ»¿ç®±ç‹€æ…‹',
          data: Array(topicCount).fill(0),
          backgroundColor: Array(topicCount).fill(colors[0])
        }]
      }
    };
    
    const boxLocations = [
      { name: 'æ²¿æµ·è·¯å››æ®µ 559 è™Ÿï¼ˆå…¨å®¶å—ç’°åº—æ—ï¼‰', lat: 24.0507, lng: 120.4195 },
      { name: 'æ²¿æµ·è·¯äº”æ®µ 363 è™Ÿï¼ˆå…¨è¯æ²¿æµ·åº—æ—ï¼‰', lat: 24.0495, lng: 120.4090 },
      { name: 'å½°é¹¿è·¯ä¸ƒæ®µ 245 è™Ÿï¼ˆç¦èˆˆåˆ†é§æ‰€æ—ï¼‰', lat: 24.0565, lng: 120.4415 },
      { name: 'å½°é¹¿è·¯ä¸ƒæ®µ 255 è™Ÿï¼ˆå¯¶æˆæ—ï¼‰', lat: 24.0569, lng: 120.4423 },
      { name: 'å½°é¹¿è·¯ä¸ƒæ®µ 16 è™Ÿï¼ˆç· å¯¶å‚¢å…·æ—ï¼‰', lat: 24.0505, lng: 120.4342 },
      { name: 'å½°é¹¿è·¯å…­æ®µ 506 è™Ÿï¼ˆå˜‰é‡Œå¤§æ¦®æ—ï¼‰', lat: 24.0458, lng: 120.4268 },
      { name: 'å½°é¹¿è·¯å…­æ®µ 392 è™Ÿï¼ˆè‹±ç™¼ä¼æ¥­æ—ï¼‰', lat: 24.0475, lng: 120.4300 },
      { name: 'ç•ªèŠ±è·¯ä¸€æ®µ 853 è™Ÿï¼ˆå¤–ä¸­æ´¾å‡ºæ‰€å‰ï¼‰', lat: 24.0715, lng: 120.4158 },
      { name: 'ç•ªèŠ±è·¯äºŒæ®µ 867 è™Ÿï¼ˆèŠçˆ¾å¯Œç¦æ˜Ÿåº—å‰ï¼‰', lat: 24.0780, lng: 120.4085 },
      { name: 'å“¡é¹¿è·¯ä¸€æ®µ 266 è™Ÿï¼ˆç¦å®‰å®®æ–œå°é¢ï¼‰', lat: 24.0585, lng: 120.4505 },
      { name: 'å“¡é¹¿è·¯äºŒæ®µ 88 è™Ÿï¼ˆå…¨è¯å“¡é¹¿åº—æ—ï¼‰', lat: 24.0622, lng: 120.4550 },
      { name: 'å“¡é¹¿è·¯äºŒæ®µ 184 è™Ÿï¼ˆç¦èˆˆéƒµå±€å°é¢ï¼‰', lat: 24.0640, lng: 120.4580 },
      { name: 'å½°æ°´è·¯ 22 è™Ÿï¼ˆå¿«é€Ÿé“è·¯æ—ï¼‰', lat: 24.0415, lng: 120.4225 },
      { name: 'å½°æ°´è·¯äºŒæ®µ 1 è™Ÿï¼ˆç¦æ‡‹åŠ æ²¹ç«™å—é‚Šï¼‰', lat: 24.0375, lng: 120.4205 },
      { name: 'å—ç’°è·¯/ç¦ä¸‰è·¯ä¸‰æ®µè·¯å£ï¼ˆ7-11 ç¦èˆˆæ—ºç¦é–€å¸‚ï¼‰', lat: 24.0525, lng: 120.4160 }
    ];

    function setStatus(text, color) {
      const el = document.getElementById("status");
      el.textContent = text;
      el.style.color = color;
    }

    function generateLocationGrid() {
      const grid = document.getElementById("locationGrid");
      grid.innerHTML = '';
      boxLocations.forEach((location, index) => {
        const mapsUrl = `https://maps.google.com/?cid=861827955758315132&g_mp=Cidnb29nbGUubWFwcy5wbGFjZXMudjEuUGxhY2VzLlNlYXJjaFRleHQ$${location.lat},${location.lng}`;
        const card = document.createElement('div');
        card.className = 'location-card';
        card.style.backgroundColor = colors[chartData.bar.datasets[0].data[index]];
        card.innerHTML = `
          <a href="${mapsUrl}" target="_blank">
            <p style="font-weight: bold; margin-bottom: 5px; color: white;">å›æ”¶ç®± ${index + 1}</p>
            <p style="font-size: 0.9em; line-height: 1.4; color: white;">${location.name}</p>
          </a>
        `;
        grid.appendChild(card);
      });
    }

    function openAllLocations() {
        const url = 'https://maps.app.goo.gl/otJ4dphrjJwzrpaQ8';
        window.open(url, '_blank');
    }

    function connect() {
      if (client && client.connected) { alert("âš ï¸ å·²é€£ç·šï¼Œè«‹å‹¿é‡è¤‡é€£ç·šã€‚"); return; }
      const url = document.getElementById("brokerUrl").value.trim();
      if (!url) { alert("è«‹è¼¸å…¥ Broker URL"); return; }
      setStatus("ğŸŸ¡ é€£ç·šä¸­...", "orange");
      const clientId = `web-client-${Math.random().toString(16).substr(2, 8)}`;
      client = mqtt.connect(url, { clientId: clientId });

      client.on("connect", () => {
        setStatus("ğŸŸ¢ å·²é€£ç·š", "green");
        topics.forEach(topic => { client.subscribe(topic, (err) => { if (!err) { console.log(`ğŸ“¡ å·²è¨‚é–±ä¸»é¡Œ: ${topic}`); } }); });
      });

      client.on("close", () => setStatus("ğŸ”´ å·²æ–·ç·š", "red"));
      client.on("error", (err) => {
        setStatus("ğŸ”´ éŒ¯èª¤", "red");
        console.log("âŒ é€£ç·šéŒ¯èª¤: " + err.message);
        client.end();
      });

      client.on("message", (topic, message) => {
        const msg = message.toString();
        updateData(topic, msg);
      });
    }

    function updateData(topic, msg) {
      const value = parseInt(msg);
      if (isNaN(value) || value < 0 || value > 4) { console.log(`âš  ç„¡æ•ˆçš„æ•¸å€¼: ${msg}ï¼Œå¿½ç•¥æ›´æ–°ã€‚`); return; }
      
      const index = topics.indexOf(topic);
      if (index > -1) {
        chartData.bar.datasets[0].data[index] = value;
        chartData.bar.datasets[0].backgroundColor[index] = colors[value];
        generateLocationGrid();
        updateStatusOverview();
      }
    }

    function updateStatusOverview() {
        const counts = { 0: 0, 1: 0, 2: 0, 3: 0, 4: 0 };
        chartData.bar.datasets[0].data.forEach(value => {
            counts[value]++;
        });

        document.getElementById("count-0").textContent = counts[0];
        document.getElementById("count-1").textContent = counts[1];
        document.getElementById("count-2").textContent = counts[2];
        document.getElementById("count-3").textContent = counts[3];
        document.getElementById("count-4").textContent = counts[4];

        document.getElementById("status-0").style.backgroundColor = colors[0];
        document.getElementById("status-1").style.backgroundColor = colors[1];
        document.getElementById("status-2").style.backgroundColor = colors[2];
        document.getElementById("status-3").style.backgroundColor = colors[3];
        document.getElementById("status-4").style.backgroundColor = colors[4];
    }

    window.onload = function() {
        generateLocationGrid();
        updateStatusOverview();
    };
  </script>
</body>
</html>
