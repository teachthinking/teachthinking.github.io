<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>卜卦系統</title>
  <style>
    body { font-family: "微軟正黑體", sans-serif; padding: 20px; }
    .result { margin-top: 20px; padding: 10px; border: 1px solid #ccc; border-radius: 8px; }
    h2 { margin-bottom: 5px; }
    .section { margin-bottom: 10px; }
    .yao { margin-left: 15px; }
  </style>
</head>
<body>
  <h1>卜卦系統</h1>
  <button onclick="generateHexagram()">生成卦象</button>

  <div id="hexagramResult" class="result"></div>
  <div id="mutualResult" class="result"></div>
  <div id="changeResult" class="result"></div>

  <script>
    let hexagramData = {}; // 存放 hexagrams_data.json

    // 64卦五行對應
    const hexagramWuxing = {
      "乾為天": "金","坤為地": "土","水雷屯": "木","山水蒙": "水","水天需": "金","天水訟": "水",
      "地水師": "水","水地比": "土","風天小畜": "金","天澤履": "金","地天泰": "金","天地否": "土",
      "天火同人": "火","火天大有": "金","地山謙": "土","雷地豫": "土","澤雷隨": "木","山風蠱": "木",
      "地澤臨": "金","風地觀": "土","火雷噬嗑": "木","山火賁": "火","山地剝": "土","地雷復": "木",
      "天雷无妄": "木","山天大畜": "金","山雷頤": "木","澤風大過": "木","坎為水": "水","離為火": "火",
      "澤山咸": "土","雷風恒": "木","天山遯": "土","雷天大壯": "金","火地晉": "土","地火明夷": "火",
      "風火家人": "火","火澤睽": "金","水山蹇": "土","雷水解": "水","山澤損": "金","風雷益": "木",
      "澤天夬": "金","天風姤": "木","澤地萃": "土","地風升": "木","澤水困": "水","水風井": "木",
      "澤火革": "火","火風鼎": "木","震為雷": "木","艮為山": "土","風山漸": "土","雷澤歸妹": "金",
      "雷火豐": "火","火山旅": "土","巽為風": "木","兌為澤": "金","風水渙": "水","水澤節": "金",
      "風澤中孚": "金","雷山小過": "土","水火既濟": "火","火水未濟": "水"
    };

    // 卦畫（陽=1 陰=0）
    const hexagramLines = {
      "乾為天":[1,1,1,1,1,1],"坤為地":[0,0,0,0,0,0],"水雷屯":[0,1,0,1,0,0],
      "山水蒙":[0,0,1,0,1,0],"水天需":[0,1,0,1,1,1],"天水訟":[1,1,1,0,1,0],
      "地水師":[0,0,0,0,1,0],"水地比":[0,1,0,0,0,0],"風天小畜":[0,1,1,1,1,1],
      "天澤履":[1,1,1,1,1,0],"地天泰":[0,0,0,1,1,1],"天地否":[1,1,1,0,0,0],
      "天火同人":[1,1,1,1,0,1],"火天大有":[1,0,1,1,1,1],"地山謙":[0,0,0,1,1,0],
      "雷地豫":[1,0,0,0,0,0],"澤雷隨":[0,1,1,0,0,1],"山風蠱":[0,0,1,1,0,0],
      "地澤臨":[0,0,0,1,1,0],"風地觀":[0,0,1,0,0,0],"火雷噬嗑":[1,0,1,1,0,0],
      "山火賁":[0,0,1,1,0,1],"山地剝":[0,0,1,0,0,0],"地雷復":[0,0,0,1,0,0],
      "天雷无妄":[1,1,1,1,0,0],"山天大畜":[0,0,1,1,1,1],"山雷頤":[0,0,1,1,0,0],
      "澤風大過":[0,1,1,1,0,1],"坎為水":[0,1,0,0,1,0],"離為火":[1,0,1,1,0,1],
      "澤山咸":[0,1,1,0,0,1],"雷風恒":[1,0,0,1,0,0],"天山遯":[1,1,1,0,0,1],
      "雷天大壯":[1,0,0,1,1,1],"火地晉":[1,0,1,0,0,0],"地火明夷":[0,0,0,1,0,1],
      "風火家人":[0,1,1,1,0,1],"火澤睽":[1,0,1,0,1,1],"水山蹇":[0,1,0,0,0,1],
      "雷水解":[1,0,0,0,1,0],"山澤損":[0,0,1,1,1,0],"風雷益":[0,1,1,1,0,0],
      "澤天夬":[0,1,1,1,1,1],"天風姤":[1,1,1,0,1,1],"澤地萃":[0,1,1,0,0,0],
      "地風升":[0,0,0,0,1,1],"澤水困":[0,1,1,0,1,0],"水風井":[0,1,0,0,1,1],
      "澤火革":[0,1,1,1,0,1],"火風鼎":[1,0,1,0,1,1],"震為雷":[1,0,0,1,0,0],
      "艮為山":[0,0,1,0,0,1],"風山漸":[0,1,1,0,0,1],"雷澤歸妹":[1,0,0,1,1,0],
      "雷火豐":[1,0,0,1,0,1],"火山旅":[1,0,1,0,0,1],"巽為風":[0,1,1,0,1,1],
      "兌為澤":[0,1,1,1,1,0],"風水渙":[0,1,1,0,1,0],"水澤節":[0,1,0,1,1,0],
      "風澤中孚":[0,1,1,1,0,0],"雷山小過":[1,0,0,0,0,1],"水火既濟":[0,1,0,1,0,1],
      "火水未濟":[1,0,1,0,1,0]
    };

    function linesToHexagram(lines) {
      for (const [name, arr] of Object.entries(hexagramLines)) {
        if (arr.join("") === lines.join("")) return name;
      }
      return null;
    }

    function getMutualHexagram(mainHex) {
      const lines = hexagramLines[mainHex];
      if (!lines) return null;
      const middle4 = lines.slice(1, 5);
      const lower = middle4.slice(0, 3);
      const upper = middle4.slice(1, 4);
      const newLines = upper.concat(lower);
      return linesToHexagram(newLines);
    }

    const wuxing = ["木", "火", "土", "金", "水"];
    function relation(a, b) {
      if (a === b) return "比和";
      const aIndex = wuxing.indexOf(a), bIndex = wuxing.indexOf(b);
      if ((aIndex + 1) % 5 === bIndex) return "相生";
      if ((aIndex + 2) % 5 === bIndex) return "相剋";
      if ((bIndex + 1) % 5 === aIndex) return "被生";
      if ((bIndex + 2) % 5 === aIndex) return "被剋";
      return "無關";
    }

    function interpretWuxing(main, change) {
      const rel = relation(main, change);
      const interpretations = {
        "相生": { "事業":"事業有貴人扶持，進展順利。","財運":"財運漸旺，有外來助力。","感情":"感情和諧，互相支持。","健康":"身心逐漸康復，宜保養。","家庭":"家運興旺，氛圍和諧。","學業":"學業進步，適合深造。","整體":"大吉之象，凡事可成。" },
        "相剋": { "事業":"事業遇阻，競爭壓力大。","財運":"財運受損，容易破財。","感情":"感情多爭執，難以融合。","健康":"健康受損，需防病痛。","家庭":"家中不和，口角爭執多。","學業":"學業受阻，難有進展。","整體":"小凶之象，宜守不宜攻。" },
        "比和": { "事業":"事業平穩，需靠自己努力。","財運":"財運平平，收入支出均衡。","感情":"感情穩定，互相理解。","健康":"健康無大礙，需維持生活規律。","家庭":"家庭安定，和樂無事。","學業":"學業普通，成績平穩。","整體":"中平之象，平穩發展。" },
        "被剋": { "事業":"事業受壓制，難以伸展。","財運":"財運不佳，易被奪財。","感情":"感情受阻，缺乏理解。","健康":"健康欠佳，容易受外界影響。","家庭":"家運受壓，矛盾暗藏。","學業":"學業受挫，需要外力幫助。","整體":"凶象，需低調應對。" },
        "被生": { "事業":"事業雖受幫助，但自身被消耗。","財運":"財來財去，收支難平。","感情":"感情有依賴，需平衡付出。","健康":"精力消耗大，注意休息。","家庭":"家庭雖和，但責任加重。","學業":"學業進步但辛苦，需要耐力。","整體":"中吉，雖有助力，但自身負擔加重。" }
      };
      return interpretations[rel];
    }

    async function loadHexagramData() {
      const response = await fetch("hexagrams_data.json");
      hexagramData = await response.json();
    }

    async function generateHexagram() {
      if (Object.keys(hexagramData).length === 0) await loadHexagramData();

      const hexagrams = Object.keys(hexagramWuxing);
      const mainHex = hexagrams[Math.floor(Math.random() * hexagrams.length)];
      const changeHex = hexagrams[Math.floor(Math.random() * hexagrams.length)];
      const mutualHex = getMutualHexagram(mainHex);

      const mainWuxing = hexagramWuxing[mainHex];
      const changeWuxing = hexagramWuxing[changeHex];
      const mutualWuxing = mutualHex ? hexagramWuxing[mutualHex] : "未知";

      // 本卦
      let mainHtml = `<h2>本卦：${mainHex} (${mainWuxing})</h2>`;
      if (hexagramData[mainHex]) {
        hexagramData[mainHex].forEach(yao => {
          mainHtml += `<div class="yao"><b>${yao.text}</b> - ${yao.meaning}</div>`;
        });
      }
      document.getElementById("hexagramResult").innerHTML = mainHtml;

      // 互卦
      let mutualHtml = `<h2>互卦：${mutualHex} (${mutualWuxing})</h2>`;
      const mutualInterp = interpretWuxing(mainWuxing, mutualWuxing);
      for (const k in mutualInterp) {
        mutualHtml += `<div class="section"><b>${k}：</b>${mutualInterp[k]}</div>`;
      }
      document.getElementById("mutualResult").innerHTML = mutualHtml;

      // 變卦
      let changeHtml = `<h2>變卦：${changeHex} (${changeWuxing})</h2>`;
      const changeInterp = interpretWuxing(mainWuxing, changeWuxing);
      for (const k in changeInterp) {
        changeHtml += `<div class="section"><b>${k}：</b>${changeInterp[k]}</div>`;
      }
      document.getElementById("changeResult").innerHTML = changeHtml;
    }
  </script>
</body>
</html>
