<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>張老師易經卜卦</title>
  <style>
    body{font-family:"Noto Sans TC",sans-serif;background:#f7f7f7;color:#222;padding:20px}
    .container{max-width:980px;margin:0 auto;background:#fff;padding:22px;border-radius:12px;box-shadow:0 6px 24px rgba(0,0,0,.06)}
    h1{margin:0 0 6px 0;font-size:26px}
    h2.subtitle{margin:0 0 16px 0;color:#666;font-weight:400;font-size:15px}
    .tab-buttons{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:14px}
    .tab-button{padding:8px 14px;border-radius:8px;border:0;background:#efefef;cursor:pointer}
    .tab-button.active{background:#222;color:#fff}
    .tab-content{display:none;padding-top:8px}
    .tab-content.active{display:block}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin:8px 0}
    .hint{font-size:13px;color:#666}
    .gua-box{border:1px solid #e6e6e6;border-radius:10px;padding:12px;background:#fafafa;margin-bottom:12px}
    .hidden{display:none}
    button.primary{padding:9px 16px;background:#222;color:#fff;border-radius:8px;border:0;cursor:pointer}
    input,select,textarea{padding:8px;border-radius:8px;border:1px solid #d0d0d0;font-size:14px}
    .pill{display:inline-block;padding:4px 8px;border-radius:999px;background:#f0f0f0;font-size:12px}
    #line-explanation > div{margin-bottom:10px;padding-bottom:8px;border-bottom:1px dashed #eee}
    .score-card{display:flex;align-items:center;gap:10px;margin-bottom:8px}
    .score-bar-wrap{flex:1;height:10px;background:#eee;border-radius:6px;overflow:hidden}
    .score-bar{height:100%;width:0;transition:width .4s;background:linear-gradient(90deg,#f44336,#ff9800,#4caf50)}
    .score-val{min-width:36px;text-align:right;font-weight:600}
    pre{background:#fafafa;padding:8px;border-radius:6px;overflow:auto}
    
    /* 卦象視覺優化 */
    .gua-line { font-family: 'Courier New', monospace; font-size: 20px; line-height: 1.2; }
    .gua-line div { padding: 2px 0; }
    .gua-yang { display: flex; align-items: center; justify-content: center; height: 1.2em; }
    .gua-yang::before { content: ''; width: 100%; height: 6px; background: #222; }
    .gua-yin { display: flex; align-items: center; justify-content: space-between; height: 1.2em; }
    .gua-yin::before, .gua-yin::after { content: ''; width: 45%; height: 6px; background: #222; }
    .gua-moving { font-weight: bold; color: #b71c1c; display: flex; align-items: center; justify-content: center; height: 1.2em; }
    .gua-moving.yang::before { content: ''; width: 100%; height: 6px; background: #b71c1c; }
    .gua-moving.yang::after { content: '◎'; margin-left: 8px; font-size: 0.8em; }
    .gua-moving.yin::before, .gua-moving.yin::after { content: ''; width: 45%; height: 6px; background: #b71c1c; }
    .gua-moving.yin::before { content: ''; width: 45%; height: 6px; background: #b71c1c; }
    .gua-moving.yin::after { content: '×'; margin-left: 8px; font-size: 0.8em; }

    /* 蛛網圖 CSS */
    .radar-chart-container { position: relative; width: 280px; height: 280px; margin: 20px auto; }
    .radar-chart { position: absolute; top: 0; left: 0; right: 0; bottom: 0; }
    .radar-chart-axis { position: absolute; transform-origin: center; width: 1px; height: 50%; background: #ccc; bottom: 50%; left: 50%; }
    .radar-chart-point { position: absolute; width: 10px; height: 10px; border-radius: 50%; background: #222; z-index: 10; }
    .radar-chart-label { position: absolute; font-size: 13px; font-weight: bold; transform-origin: top left; }
    .radar-chart-polygon { fill: rgba(76, 175, 80, 0.5); stroke: #4caf50; stroke-width: 2px; transition: all 0.5s ease-in-out; }
  </style>
</head>
<body>
  <div class="container">
    <h1>張老師易經卜卦</h1>
    <h2 id="subtitle" class="subtitle">載入中…（若無 quotes.json 顯示預設句）</h2>

    <div class="tab-buttons">
      <button class="tab-button active" data-target="tab-number">數字取卦</button>
      <button class="tab-button" data-target="tab-manual">手動取卦</button>
      <button class="tab-button" data-target="tab-time">時間取卦</button>
      <button class="tab-button" data-target="tab-image">以象取卦</button>
    </div>

    <div id="tab-number" class="tab-content active">
      <h3>數字取卦</h3>
      <div class="row">
        <input id="numUpper" type="number" placeholder="上卦數字 (100-999)" min="100" max="999" />
        <input id="numLower" type="number" placeholder="下卦數字 (100-999)" min="100" max="999" />
        <input id="numMoving" type="number" placeholder="動爻數字 (100-999)" min="100" max="999" />
        <button id="btnNumber" class="primary">生成卦象</button>
      </div>
      <div class="row"><span class="hint">提示：輸入 100–999。上/下卦 = 數字 % 8（0 視為 8），動爻 = 數字 % 6（0 視為 6）。頁面載入會隨機預設三個數字。</span></div>
    </div>

    <div id="tab-manual" class="tab-content">
      <h3>手動取卦</h3>
      <div class="row">
        <select id="selUpper">
          <option value="1">乾</option><option value="2">兌</option><option value="3">離</option><option value="4">震</option>
          <option value="5">巽</option><option value="6">坎</option><option value="7">艮</option><option value="8">坤</option>
        </select>
        <select id="selLower">
          <option value="1">乾</option><option value="2">兌</option><option value="3">離</option><option value="4">震</option>
          <option value="5">巽</option><option value="6">坎</option><option value="7">艮</option><option value="8">坤</option>
        </select>
        <input id="inputMoving" type="text" placeholder="變爻 (例: 1,3 或 2)" />
        <button id="btnManual" class="primary">生成卦象</button>
      </div>
    </div>

    <div id="tab-time" class="tab-content">
      <h3>時間取卦</h3>
      <div class="row">
        <input id="dtInput" type="datetime-local" />
        <button id="btnTime" class="primary">以時間生成卦象</button>
        <span id="nowQuick" class="pill">使用現在時間</span>
      </div>
      <div class="row"><span class="hint">算法：上卦 = (年+月+日) % 8；下卦 = (年+月+日+時) % 8；動爻 = (年+月+日+時+分) % 6；餘數為 0 則視為 8 或 6。</span></div>
    </div>

    <div id="tab-image" class="tab-content">
      <h3>以象取卦</h3>
      <div class="row">
        <label>上卦：以直覺取其象或數，如落下3片葉子，直覺在數就取3，在象就取色或形，開花動態取震，顯眼取離，可依卦德類推，若前後落下可取前後卦，以當時情境與直覺為準，所謂：「近取諸身，遠取諸物，仍當以心求，不可以迹求，不可拘泥物圓為天卦，物方為地卦。」</label>
        <select id="upperImageSelect" style="min-width:260px">
          <option value="1">乾（金）—天、健、頭、金、圓形、腦、父親</option>
          <option value="2">兌（金）—澤、悅、口、白、曲線、肺、少女</option>
          <option value="3">離（火）—火、麗、眼、紅、三角、心、中女</option>
          <option value="4">震（木）—雷、動、足、綠、長方、肝、長男</option>
          <option value="5">巽（木）—風、入、腿、藍、斜線、膽、長女</option>
          <option value="6">坎（水）—水、陷、耳、黑、波浪、腎、中男</option>
          <option value="7">艮（土）—山、止、手、黃、峰形、胃、少男</option>
          <option value="8">坤（土）—地、順、腹、棕、方形、脾、母親</option>
        </select>
      </div>
      <div class="row">
        <label>下卦（後天方位，面南取卦）：</label>
        <select id="lowerDirectionSelect">
          <option value="6">北（坎）後面</option><option value="3">南（離）前面</option><option value="4">東（震）左邊</option><option value="2">西（兌）右邊</option>
          <option value="7">東北（艮）左後</option><option value="1">西北（乾）右後</option><option value="5">東南（巽）左前</option><option value="8">西南（坤）右前</option>
        </select>
      </div>
      <div class="row">
        <input id="imageMovingInput" type="number" placeholder="動爻 1~6" min="1" max="6" style="width:110px" />
        <label><input id="imageUseMinute" type="checkbox" /> 用當前分鐘取動爻</label>
      </div>
      <div class="row">
        <button id="btnImage" class="primary">生成卦象</button>
      </div>
    </div>

    <div id="result" class="hidden">
      <h2>卦象結果</h2>

      <div class="gua-box">
        <h3 id="guaName"></h3>
        <div id="guaImage" class="gua-line"></div>
        <div id="guaNote" class="hint" style="margin-top:8px"></div>
      </div>

      <div class="gua-box">
        <h3 id="changeGuaName"></h3>
        <div id="changeGuaImage" class="gua-line"></div>
      </div>

      <div class="gua-box">
        <h3 id="huGuaName"></h3>
        <div id="huGuaImage" class="gua-line"></div>
      </div>

      <div id="line-explanation" class="gua-box hidden">
        <h3>動爻解釋（多變爻逐條列出）</h3>
        <div id="lineTextDisplay"></div>
      </div>

      <div id="judgeBox" class="gua-box hidden">
        <h3>綜合判斷</h3>
        <div id="scoreWrap"></div>
        <div id="radarChart" class="radar-chart-container"></div>
      </div>

      <div style="margin-top:8px"><button id="judgeBtn" class="primary">綜合判斷</button></div>
    </div>
  </div>

  <script>
  /* ===========================
     資料：三爻（1..8）對應與工具
     lines 的約定：陣列為 bottom->top（index0 = 下爻 = 爻1，index5 = 上爻 = 爻6）
     =========================== */
  const guaTable = {
    // 數字 : [初爻, 二爻, 三爻]
    // 乾: 111, 兌: 110, 離: 101, 震: 100
    // 巽: 011, 坎: 010, 艮: 001, 坤: 000
    1:[1,1,1], 2:[1,1,0], 3:[1,0,1], 4:[1,0,0],
    5:[0,1,1], 6:[0,1,0], 7:[0,0,1], 8:[0,0,0]
  };
  const trigramName = {1:'乾',2:'兌',3:'離',4:'震',5:'巽',6:'坎',7:'艮',8:'坤'};
  const triIndexByLines = new Map(Object.entries(guaTable).map(([i,arr])=>[JSON.stringify(arr), +i]));

  let hexList = [];
  const hexByLines = new Map();
  const hexByCombinedName = new Map();

  fetch('hexagrams.json')
    .then(r => r.ok ? r.json() : Promise.reject('Network response was not ok'))
    .then(data => {
      let processedHexList = Array.isArray(data) ? data : Object.values(data).map((entry, name) => ({ ...entry, name: Object.keys(data)[name] }));
      hexList = processedHexList.filter(entry => entry && Array.isArray(entry.lines) && entry.lines.length === 6);
      
      hexList.forEach(entry => {
        const linesBinary = entry.lines.map(line => line.text.includes('九') ? 1 : line.text.includes('六') ? 0 : null);
        if (linesBinary.every(val => val !== null) && linesBinary.length === 6) {
          hexByLines.set(JSON.stringify(linesBinary), entry);
          const uIdx = triIndexByLines.get(JSON.stringify(linesBinary.slice(3, 6)));
          const lIdx = triIndexByLines.get(JSON.stringify(linesBinary.slice(0, 3)));
          if (uIdx && lIdx) {
            hexByCombinedName.set(`${trigramName[uIdx]}為${trigramName[lIdx]}`, entry);
          }
        }
      });
    })
    .catch(() => { /* 允許沒有 hexagrams.json */ });

  fetch('quotes.json')
    .then(r => r.ok ? r.json() : Promise.reject('Network response was not ok'))
    .then(list => {
      document.getElementById('subtitle').textContent = (Array.isArray(list) && list.length > 0) ? list[Math.floor(Math.random()*list.length)] : '易有太極，是生兩儀，兩儀生四象，四象生八卦。';
    })
    .catch(() => {
      document.getElementById('subtitle').textContent = '易有太極，是生兩儀，兩儀生四象，四象生八卦。';
    });

  /* ---------------------------
     工具函數
     --------------------------- */
  function showTabById(id){
    document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
    document.querySelectorAll(`[data-target="${id}"]`).forEach(b => b.classList.add('active'));
    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
    document.getElementById(id)?.classList.add('active');
  }
  document.querySelectorAll('.tab-button').forEach(btn => btn.addEventListener('click', () => showTabById(btn.dataset.target)));

  function formatGuaNameByLines(lines){
    if (!lines || lines.length !== 6) return '卦象錯誤';
    const uIdx = triIndexByLines.get(JSON.stringify(lines.slice(3, 6)));
    const lIdx = triIndexByLines.get(JSON.stringify(lines.slice(0, 3)));
    const combinedName = `${trigramName[uIdx]}為${trigramName[lIdx]}`;
    return hexByCombinedName.get(combinedName)?.name || combinedName;
  }

  function findHexEntryByLines(lines){
    return hexByLines.get(JSON.stringify(lines));
  }
  
  function getGuaHtml(lines, moving=[]){
    let html = '';
    for (let i = 5; i >= 0; i--) {
      const val = lines[i];
      const yaoNo = i + 1;
      const isMoving = (moving || []).includes(yaoNo);
      
      if (isMoving) {
          html += `<div class="gua-moving ${val === 1 ? 'yang' : 'yin'}"></div>`;
      } else {
          html += `<div class="${val === 1 ? 'gua-yang' : 'gua-yin'}"></div>`;
      }
    }
    return html;
  }

  function getLineEntryFor(hexEntry, yaoIndex){
    return hexEntry?.lines.find(line => line && line.index === yaoIndex) || null;
  }

  function escapeHtml(s){
    if (s === null || s === undefined) return '';
    return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;');
  }

  /* ---------------------------
     生成並顯示卦象（主流程）
     --------------------------- */
  let currentResult = null;

  function makeFromUpperLower(uIdx, lIdx){
    const upper = guaTable[uIdx] || guaTable[1];
    const lower = guaTable[lIdx] || guaTable[1];
    return [...lower, ...upper];
  }

  function generateGua(uIdx, lIdx, movingArr){
    const moving = Array.isArray(movingArr) ? movingArr.filter(x=>Number.isFinite(x) && x>=1 && x<=6) : [];
    const lines = makeFromUpperLower(uIdx, lIdx);
    
    const hexMain = findHexEntryByLines(lines);
    const mainName = hexMain ? (hexMain.name || hexMain.title) : formatGuaNameByLines(lines);
    
    const changeLines = lines.slice();
    moving.forEach(n => { const idx = n - 1; if (idx>=0 && idx<6) changeLines[idx] = 1 - changeLines[idx]; });
    const hexChange = findHexEntryByLines(changeLines);
    const changeName = hexChange ? (hexChange.name || hexChange.title) : formatGuaNameByLines(changeLines);

    const huLinesBase = [ lines[1], lines[2], lines[3] ];
    const huLinesTop = [ lines[2], lines[3], lines[4] ];
    const huLines = [...huLinesBase, ...huLinesTop];
    const hexHu = findHexEntryByLines(huLines);
    const huName = hexHu ? (hexHu.name || hexHu.title) : formatGuaNameByLines(huLines);

    document.getElementById('guaName').textContent = mainName;
    document.getElementById('guaImage').innerHTML = getGuaHtml(lines, moving);
    document.getElementById('guaNote').textContent = (hexMain && hexMain.judgment && hexMain.judgment.overall) ? hexMain.judgment.overall : '（未找到綜合判斷）';

    document.getElementById('changeGuaName').textContent = `變卦：${changeName}`;
    document.getElementById('changeGuaImage').innerHTML = getGuaHtml(changeLines, []);

    document.getElementById('huGuaName').textContent = `互卦：${huName}`;
    document.getElementById('huGuaImage').innerHTML = getGuaHtml(huLines, []);

    const lineBox = document.getElementById('lineTextDisplay');
    lineBox.innerHTML = '';
    if (moving.length > 0) {
      if (hexMain && Array.isArray(hexMain.lines)) {
        moving.forEach(mv => {
          const le = getLineEntryFor(hexMain, mv);
          const text = escapeHtml(le?.text || '');
          const meaning = escapeHtml(le?.meaning || '');
          lineBox.innerHTML += `<div><strong>第 ${mv} 爻：</strong>${text}<div class="hint">${meaning}</div></div>`;
        });
      } else {
        moving.forEach(mv => {
          lineBox.innerHTML += `<div><strong>第 ${mv} 爻：</strong><em>（未載入或找不到 hexagrams.json，無法顯示爻辭）</em></div>`;
        });
      }
      document.getElementById('line-explanation').classList.remove('hidden');
    } else {
      document.getElementById('line-explanation').classList.add('hidden');
    }

    document.getElementById('result').classList.remove('hidden');
    document.getElementById('judgeBox').classList.add('hidden');

    currentResult = { uIdx, lIdx, lines, hexMain, changeLines, hexChange, huLines, hexHu, moving };
  }

  /* ---------------------------
     綁定：數字取卦（含隨機預設）
     --------------------------- */
  function rand100to999(){ return Math.floor(Math.random()*900) + 100; }
  document.getElementById('numUpper').value = rand100to999();
  document.getElementById('numLower').value = rand100to999();
  document.getElementById('numMoving').value = rand100to999();
  document.getElementById('btnNumber').addEventListener('click', ()=>{
    const a = Number(document.getElementById('numUpper').value);
    const b = Number(document.getElementById('numLower').value);
    const c = Number(document.getElementById('numMoving').value);
    if (![a,b,c].every(x => Number.isInteger(x) && x >= 100 && x <= 999)) {
      alert('請輸入 100 到 999 的整數（或重新整理頁面取得隨機值）。');
      return;
    }
    const u = (a % 8) || 8;
    const l = (b % 8) || 8;
    const m = (c % 6) || 6;
    generateGua(u, l, [m]);
  });

  /* ---------------------------
     綁定：手動取卦
     --------------------------- */
  document.getElementById('btnManual').addEventListener('click', ()=>{
    const u = Number(document.getElementById('selUpper').value);
    const l = Number(document.getElementById('selLower').value);
    const raw = (document.getElementById('inputMoving').value || '').trim();
    const ms = raw === '' ? [] : raw.split(',').map(s => parseInt(s.trim(),10)).filter(x => Number.isInteger(x) && x>=1 && x<=6);
    generateGua(u, l, ms);
  });

  /* ---------------------------
     綁定：時間取卦 初始化與處理
     --------------------------- */
  function pad(n){ return String(n).padStart(2,'0'); }
  function localDatetimeForInput(d){ return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`; }
  document.getElementById('dtInput').value = localDatetimeForInput(new Date());
  document.getElementById('nowQuick').addEventListener('click', () => document.getElementById('dtInput').value = localDatetimeForInput(new Date()));
  document.getElementById('btnTime').addEventListener('click', ()=>{
    const val = document.getElementById('dtInput').value;
    if (!val) { alert('請先選擇日期時間'); return; }
    const d = new Date(val);
    const y = d.getFullYear(), mo = d.getMonth()+1, da = d.getDate(), h = d.getHours(), mi = d.getMinutes();
    const ymd = y + mo + da;
    const u = (ymd % 8) || 8;
    const l = ((ymd + h) % 8) || 8;
    const m = ((ymd + h + mi) % 6) || 6;
    generateGua(u, l, [m]);
  });

  /* ---------------------------
     綁定：以象取卦
     --------------------------- */
  document.getElementById('btnImage').addEventListener('click', ()=>{
    const u = Number(document.getElementById('upperImageSelect').value);
    const l = Number(document.getElementById('lowerDirectionSelect').value);
    let m;
    if (document.getElementById('imageUseMinute').checked) {
      const d = new Date();
      const ymd = d.getFullYear() + (d.getMonth()+1) + d.getDate();
      m = ((ymd + d.getHours() + d.getMinutes()) % 6) || 6;
    } else {
      const raw = Number(document.getElementById('imageMovingInput').value) || 1;
      m = (raw % 6) || 6;
    }
    generateGua(u, l, [m]);
  });

  /* ---------------------------
     綜合判斷（含蛛網圖）
     --------------------------- */
  const ASPECTS = [{k:'people',label:'人'},{k:'affairs',label:'事'},{k:'time',label:'時'},{k:'place',label:'地'},{k:'object',label:'物'}];
  function clamp(x){ return Math.max(0, Math.min(10, Number(x) || 0)); }

  function getAspectScoresFor(entry){
    if (!entry || !entry.judgment) return {overall:5,people:5,affairs:5,time:5,place:5,object:5};
    const j = entry.judgment;
    return {
      people: clamp(j.people ?? j.overall ?? 5),
      affairs: clamp(j.affairs ?? j.overall ?? 5),
      time: clamp(j.time ?? j.overall ?? 5),
      place: clamp(j.place ?? j.overall ?? 5),
      object: clamp(j.object ?? j.overall ?? 5)
    };
  }

  function computeScores(result){
    const mainScores = getAspectScoresFor(result.hexMain);
    const changeScores = result.hexChange ? getAspectScoresFor(result.hexChange) : {people:5,affairs:5,time:5,place:5,object:5};
    const huScores = result.hexHu ? getAspectScoresFor(result.hexHu) : {people:5,affairs:5,time:5,place:5,object:5};
    let movingScores = {people:5,affairs:5,time:5,place:5,object:5};
    if (result.moving && result.moving.length>0 && result.hexMain && Array.isArray(result.hexMain.lines)){
      let sum = {people:0,affairs:0,time:0,place:0,object:0}; let c=0;
      result.moving.forEach(mv => {
        const le = getLineEntryFor(result.hexMain, mv);
        const s = Number(le?.score ?? 5);
        sum.people += clamp(s);
        sum.affairs += clamp(s);
        sum.time += clamp(s);
        sum.place += clamp(s);
        sum.object += clamp(s);
        c++;
      });
      if (c>0) {
        movingScores = {
          people: sum.people/c, 
          affairs: sum.affairs/c, 
          time: sum.time/c, 
          place: sum.place/c, 
          object: sum.object/c
        };
      }
    }

    const WEIGHTS = {moving:0.5, main:0.2, change:0.2, hu:0.1};
    const out = {};
    ASPECTS.forEach(a => {
      out[a.k] = (WEIGHTS.moving * movingScores[a.k] + WEIGHTS.main * mainScores[a.k] + WEIGHTS.change * changeScores[a.k] + WEIGHTS.hu * huScores[a.k]) || 0;
    });
    return out;
  }

  function renderScores(scores){
    const wrap = document.getElementById('scoreWrap');
    wrap.innerHTML = '';
    ASPECTS.forEach(a => {
      const v = clamp(scores[a.k]);
      const card = document.createElement('div'); card.className = 'score-card';
      const lbl = document.createElement('div'); lbl.textContent = `【${a.label}】`;
      const barWrap = document.createElement('div'); barWrap.className = 'score-bar-wrap';
      const bar = document.createElement('div'); bar.className = 'score-bar'; bar.style.width = (v*10) + '%';
      barWrap.appendChild(bar);
      const val = document.createElement('div'); val.className = 'score-val'; val.textContent = v.toFixed(1);
      card.appendChild(lbl); card.appendChild(barWrap); card.appendChild(val);
      wrap.appendChild(card);
    });
  }
  
  function renderRadarChart(scores) {
    const container = document.getElementById('radarChart');
    container.innerHTML = '';
    
    const center = 140;
    const maxRadius = 120;
    const numPoints = ASPECTS.length;
    
    // SVG 容器
    const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
    svg.setAttribute('viewBox', `0 0 ${center*2} ${center*2}`);
    svg.setAttribute('class', 'radar-chart');
    container.appendChild(svg);
    
    // 繪製多邊形背景
    for (let i = 1; i <= 3; i++) {
        const points = ASPECTS.map((_, index) => {
            const angle = (Math.PI * 2 / numPoints) * index;
            const radius = (maxRadius / 3) * i;
            const x = center + radius * Math.sin(angle);
            const y = center - radius * Math.cos(angle);
            return `${x},${y}`;
        }).join(' ');
        const polygon = document.createElementNS("http://www.w3.org/2000/svg", "polygon");
        polygon.setAttribute('points', points);
        polygon.setAttribute('fill', `rgba(204, 204, 204, ${i * 0.1})`);
        polygon.setAttribute('stroke', '#ccc');
        polygon.setAttribute('stroke-width', '1');
        svg.appendChild(polygon);
    }

    // 繪製中心點到邊緣的軸線
    ASPECTS.forEach((_, index) => {
      const angle = (Math.PI * 2 / numPoints) * index;
      const x = center + maxRadius * Math.sin(angle);
      const y = center - maxRadius * Math.cos(angle);
      const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
      line.setAttribute('x1', center);
      line.setAttribute('y1', center);
      line.setAttribute('x2', x);
      line.setAttribute('y2', y);
      line.setAttribute('stroke', '#ccc');
      svg.appendChild(line);
    });

    // 繪製數據多邊形
    const dataPoints = ASPECTS.map((aspect, index) => {
        const score = scores[aspect.k];
        const angle = (Math.PI * 2 / numPoints) * index;
        const radius = (score / 10) * maxRadius;
        const x = center + radius * Math.sin(angle);
        const y = center - radius * Math.cos(angle);
        return `${x},${y}`;
    }).join(' ');
    
    const dataPolygon = document.createElementNS("http://www.w3.org/2000/svg", "polygon");
    dataPolygon.setAttribute('points', dataPoints);
    dataPolygon.setAttribute('class', 'radar-chart-polygon');
    svg.appendChild(dataPolygon);
    
    // 繪製分數標籤和文字
    ASPECTS.forEach((aspect, index) => {
        const angle = (Math.PI * 2 / numPoints) * index;
        const score = scores[aspect.k];
        const radius = (score / 10) * maxRadius;
        const x = center + radius * Math.sin(angle);
        const y = center - radius * Math.cos(angle);

        // 數值
        const textValue = document.createElementNS("http://www.w3.org/2000/svg", "text");
        textValue.setAttribute('x', x);
        textValue.setAttribute('y', y);
        textValue.setAttribute('text-anchor', 'middle');
        textValue.setAttribute('alignment-baseline', 'middle');
        textValue.setAttribute('fill', '#4caf50');
        textValue.setAttribute('font-size', '12px');
        textValue.textContent = score.toFixed(1);
        svg.appendChild(textValue);
        
        // 標籤
        const labelX = center + (maxRadius + 20) * Math.sin(angle);
        const labelY = center - (maxRadius + 20) * Math.cos(angle);
        const textLabel = document.createElementNS("http://www.w3.org/2000/svg", "text");
        textLabel.setAttribute('x', labelX);
        textLabel.setAttribute('y', labelY);
        textLabel.setAttribute('text-anchor', 'middle');
        textLabel.setAttribute('alignment-baseline', 'middle');
        textLabel.setAttribute('fill', '#222');
        textLabel.setAttribute('font-weight', 'bold');
        textLabel.textContent = aspect.label;
        svg.appendChild(textLabel);
    });
  }

  document.getElementById('judgeBtn').addEventListener('click', ()=>{
    if (!currentResult) { alert('請先生成卦象'); return; }
    const scores = computeScores(currentResult);
    renderScores(scores);
    renderRadarChart(scores);
    document.getElementById('judgeBox').classList.remove('hidden');
  });

  </script>
</body>
</html>
